<!DOCTYPE html>
<html>
<head>
	<title>上传</title>
	<script src="http://cdn.bootcss.com/blueimp-md5/1.1.0/js/md5.min.js"></script>  
</head>
<body>
	<input type="file" id="file" name="">
	<button type="button" id="upstart">开始上传</button>
	<button type="button" id="stop">停止上传</button>
	<button type="button" id="restart">重新上传</button>
	<div id="rate"></div>
	<div id="divlog"></div>

<script type="text/javascript">
	var fileForm = document.getElementById("file");
  var upstartBtn = document.getElementById('upstart');
  var stopBtn = document.getElementById('stop');
  var startBtn = document.getElementById('restart');
  var rate = document.getElementById('rate');
  var divlog = document.getElementById('divlog');
  //---------------------------
  const LENGTH = 1024 * 1024 * 1;
  var start = 0;
  var end = start + LENGTH;
  var blob;
  var blob_num = 1;
  var is_stop = 0
  var file = null;  
  var md5filename = '';
  
  //-----------------------------
  var upload_instance = new Upload();
   
  fileForm.onchange = function()
  {
  	console.log(fileForm.files[0])
  	md5filename = md5(fileForm.files[0].name)
  	divlog.innerHTML = '文件md5为：' + md5filename;
  	return;
    browserMD5File(fileForm.files[0], function (err, md5) { //如果文件大，md5值生成较慢  md5值生成后才能上传处理，自己优化下吧
        md5filename = md5;                                  //如果需要刷新后也能断点，可利用cookie记录，自行完善   
        divlog.innerHTML = '文件md5为：' + md5filename;
    });

  } 
  upstartBtn.onclick = function(){
    upload_instance.addFileAndSend(fileForm);
  
  }
 
  stopBtn.onclick = function(){
    upload_instance.stop();
  }
  
  startBtn.onclick = function(){
    upload_instance.start();
  }
 
  function Upload(){
    var xhr = new XMLHttpRequest();
    var form_data = new FormData();
    
 
    //对外方法，传入文件对象
    this.addFileAndSend = function(that){
      file = that.files[0];
      blob = cutFile(file);
      console.log(11111111111111111)
      console.log(blob)
       console.log(file)
       console.log(2222222222)
      sendFile(blob,file);
      blob_num += 1;
    }
    //停止文件上传
    this.stop = function(){
      xhr.abort();
      is_stop = 1;
    }
    
    this.start = function(){
      sendFile(blob,file);  
      is_stop = 0;
    }
    
    //切割文件
    function cutFile(file){
      var file_blob = file.slice(start,end);
      start = end;
      end = start + LENGTH;
      return file_blob;
    };
    //发送文件
    function sendFile(blob,file){
      var total_blob_num = Math.ceil(file.size / LENGTH);
      form_data.append('file',blob);
      form_data.append('blob_num',blob_num);
      form_data.append('total_blob_num',total_blob_num);
      form_data.append('md5_file_name',md5filename);
      form_data.append('file_name',file.name);
 
      xhr.open('POST','./index.php',false);
      
      xhr.onreadystatechange = function () {
        
        var progress;
        var progressObj = document.getElementById('finish');
        if(total_blob_num == 1){
          progress = '100%';
        }else{
          progress = (Math.min(100,(blob_num/total_blob_num)* 100 )).toFixed(2) +'%';
        }
        console.log('progress-----'+progress);
        progressObj.style.width = progress;
        rate.innerHTML = progress;
        
        var t = setTimeout(function(){
          if(start < file.size && is_stop === 0){
            blob = cutFile(file);
            sendFile(blob,file);
            blob_num += 1;
          }else{
            
            //setTimeout(t);
          }
        },1000);
      }
 
      xhr.send(form_data);
    }
  }

</script>
</body>
</html>