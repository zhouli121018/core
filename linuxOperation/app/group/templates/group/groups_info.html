{% extends 'base_site.html' %}
{% load i18n %}
{% load static %}
{% load bootstrap %}
{% block title %} {% trans "组配置" %} {% endblock %}
{% block breadcrumb %}<li> <a href="#">{% trans "组配置" %}</a> </li><li class="active">{% trans "组配置信息" %}</li>{% endblock %}

{% block page-content %}
    <div class="row">
        <div class="col-lg-12"><h1 class="page-header">{% trans "组配置信息" %}</h1></div>
    </div>
    <form role="form" action="" method="post" class="form-horizontal">
        <div class="row">
            <div class="col-sm-12 ">
                <div class="panel panel-default" style="margin-bottom: 0px!important;">
                    <div class="panel-heading">{% trans "组配置信息" %}</div>
                    <div class="panel-body">
                        {% csrf_token %}
                        <div style="margin-bottom: 10px;">
                            <span>添加配置项：</span>
                            <select  id="add_tab">
                                <option value="basic">常规设置</option>
                                <option value="login">登陆方式限制</option>
                                <option value="password">密码规则</option>
                                <option value="spam">反垃圾/反病毒</option>
                                <option value="frequency">发信频率设置</option>
                                <option value="oab">企业通讯录设置</option>
                                <option value="space">邮箱空间设置</option>
                            </select>
                            <button class="btn btn-success btn-sm" type="button" id="add_btn">添加</button>
                        </div>
                        <div id="edit_email_tabs" style="margin-bottom: 13px">
                            <ul>
                                <li class="basic">
                                    <a href="#basic">{% trans '常规设置' %}</a>
                                </li>
                                <li class="login">
                                    <a href="#login">{% trans '登录方式限制' %}</a>
                                </li>
                                <li class="password">
                                    <a href="#password">{% trans '密码规则' %}</a>
                                </li>
                                <li class="spam">
                                    <a href="#spam">{% trans '反垃圾/反病毒' %}</a>
                                </li>
                                <li class="frequency">
                                    <a href="#frequency">{% trans '发信频率设置' %}</a>
                                </li>
                                <li class="oab">
                                    <a href="#oab">{% trans '企业通讯录设置' %}</a>
                                </li>
                                <li>
                                    <a href="#space">{% trans '邮箱空间清理设置' %}</a>
                                </li>
                            </ul>

                            <div id="basic">

                                <div>
                                    <table class="table table-bordered table-striped">
                                        <tr>
                                            <td class="text-right" style="width:300px;">
                                                    <span class="red bold">*</span> 邮箱空间：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <div class="input-group">
                                                        <input type="number" name="mail_space" required class="form-control">
                                                        <span class="input-group-addon">MB</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">
                                                    <span class="red bold">*</span> 网络硬盘空间：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <div class="input-group">
                                                        <input type="number" name="net_space" required class="form-control">
                                                        <span class="input-group-addon">MB</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">
                                                    <span class="red bold">*</span> 允许发送邮件大小：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <div class="input-group">
                                                        <input type="number" name="allow_out_size" required class="form-control">
                                                        <span class="input-group-addon">MB</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">发信权限：</td>
                                            <td class="">
                                                <div class="col-sm-4 no-padding">
                                                    <select name="send_limit" class=" form-control limit_send_select" id="id_limit_send">
                                                        <option value="-1">不限制邮件发送</option>
                                                        <option value="1">禁止发送所有邮件</option>
                                                        <option value="2">只发送本地域邮件</option>
                                                        <option value="3">可发送指定外域邮件</option>
                                                        <option value="4">可发送本地所有域邮件</option>
                                                    </select>
                                                    <button type="button" class="btn btn-xs btn-info show_send_btn"  style="display:none;">设置允许名单</button>
                                                </div>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">收信权限：</td>
                                            <td class="">
                                                <div class="col-sm-4 no-padding">
                                                    <select name="recv_limit" class=" form-control limit_send_select" id="id_limit_recv">
                                                        <option value="-1">不限制邮件接收</option>
                                                        <option value="1">禁止接收所有邮件</option>
                                                        <option value="2">只接收本地域邮件</option>
                                                        <option value="3">可接收指定外域邮件</option>
                                                        <option value="4">可接收本地所有域邮件</option>
                                                    </select>
                                                    <button type="button" class="btn btn-xs btn-info show_recv_btn" style="display:none;">设置允许名单</button>
                                                </div>

                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary btn-sm edit_btn">确认提交</button>
                                    <!-- <button class="btn btn-sm" type="reset">{% trans "重置" %}</button> -->
                                    <button type="button" class="btn btn-danger btn-sm del_btn">删除配置</button>
                                </div>
                            </div>

                            <div id="login">
                                <div>
                                    <table class="table table-bordered table-striped">
                                        <tr>
                                            <td class="text-right" style="width:300px;">POP/POPS邮箱收取功能：</td>
                                            <td>
                                                <label class="inline" >
                                                    <input name="is_pop" checked  type="checkbox" class="ace ace-switch ace-switch-5 open">
                                                    <span class="lbl"></span>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">SMTP/SMTPS客户端邮件发送功能：</td>
                                            <td>
                                                <label class="inline" >
                                                    <input name="is_smtp" checked  type="checkbox" class="ace ace-switch ace-switch-5 open">
                                                    <span class="lbl"></span>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">IMAP/IMAPS客户端邮件收发功能：</td>
                                            <td>
                                                <label class="inline" >
                                                    <input name="is_imap" checked  type="checkbox" class="ace ace-switch ace-switch-5 open">
                                                    <span class="lbl"></span>
                                                </label>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary btn-sm edit_btn">确认提交</button>
                                    <!-- <button class="btn btn-sm" type="reset">{% trans "重置" %}</button> -->
                                    <button type="button" class="btn btn-danger btn-sm del_btn">删除配置</button>
                                </div>
                            </div>

                            <div id="password">
                                <div>
                                    <table class="table table-bordered table-striped">
                                        <tr>
                                            <td class="text-right" style="width:300px;">定期密码修改设置：</td>
                                            <td>
                                                <label class="inline" >
                                                    <input name="is_passwd" checked  type="checkbox" class="ace ace-switch ace-switch-5">
                                                    <span class="lbl"></span>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr class="nable_set">
                                            <td class="text-right" style="width:120px;"><span class="red bold">*</span> 密码有效期：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <div class="input-group">
                                                        <input type="number" name="passwd_day" value="365" required class="form-control" placeholder="密码有效期">
                                                        <span class="input-group-addon">天</span>
                                                    </div>
                                                </div>
                                                <div class="col-sm-8 ">
                                                    <p class="help-block green">0代表永远有效，大于0代表多少天密码过期后会强制用户修改密码</p>

                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">密码组成字符种类：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <select class="form-control" name="passwd_type">
                                                        <option value="2">必须包含两种字符</option>
                                                        <option value="3">必须包含三种字符</option>
                                                        <option value="4">必须包含四种字符</option>
                                                    </select>
                                                </div>
                                                <div class="col-sm-8">
                                                    <p class="grey">密码组成字符包括四种：数字、大写字母、小写字母、特殊字符</p>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">其他密码规则设置：</td>
                                            <td class="">
                                                <div class="control-group">
                                                    <!-- #section:custom/checkbox -->
                                                    <div class="checkbox">
                                                        <label>
                                                            <input name="passwd_other_bak" value="passwd_size" type="checkbox" checked class="ace">
                                                            <span class="lbl">
                                                                    <span class="">密码长度为</span>
                                                                    <select class="" name="passwd_size">
                                                                        <option value="8" selected>8</option>
                                                                        <option value="9">9</option>
                                                                        <option value="10">10</option>
                                                                        <option value="11">11</option>
                                                                        <option value="12">12</option>
                                                                        <option value="13">13</option>
                                                                        <option value="14">14</option>
                                                                        <option value="15">15</option>
                                                                        <option value="16">16</option>
                                                                    </select>
                                                                    <span class="">至16位</span>

                                                            </span>
                                                        </label>
                                                    </div>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input name="passwd_other_bak" value="passwd_name" type="checkbox" checked class="ace">
                                                            <span class="lbl"> 密码不能包含账号 </span>
                                                        </label>
                                                    </div>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input name="passwd_other_bak" value="passwd_digital" type="checkbox" checked class="ace">
                                                            <span class="lbl"> 连续3位及以上数字不能连号（例如：123、654） </span>
                                                        </label>
                                                    </div>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input name="passwd_other_bak" value="passwd_letter" type="checkbox" class="ace">
                                                            <span class="lbl"> 连续3位及以上字母不能连号（例如：abc、cba） </span>
                                                        </label>
                                                    </div>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input name="passwd_other_bak" value="passwd_letter2" type="checkbox" class="ace">
                                                            <span class="lbl"> 密码不能包含连续3个及以上相同字符（例如：aaa、rrr） </span>
                                                        </label>
                                                    </div>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input name="passwd_other_bak" value="passwd_name2" type="checkbox" class="ace">
                                                            <span class="lbl"> 密码不能包含用户姓名大小写全拼 </span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">用户不满足密码强度时：
                                            </td>
                                            <td>
                                                <div class="checkbox">
                                                    <label style="margin-right:20px;">
                                                        <input name="passwd_forbid_bak" value="forbid_send" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 禁止外发邮件 </span>
                                                    </label>
                                                    <label>
                                                        <input name="passwd_forbid_bak" value="force_change" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 登录后强制修改密码 </span>
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">用户处于弱密码库中时：
                                            </td>
                                            <td>
                                                <div class="checkbox">
                                                    <label style="margin-right:20px;">
                                                        <input name="passwd_forbid_bak" value="forbid_send_in_weak" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 禁止外发邮件 </span>
                                                    </label>
                                                    <label>
                                                        <input name="passwd_forbid_bak" value="force_change_in_weak" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 登录后强制修改密码 </span>
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>

                                <div>
                                    <button type="button" class="btn btn-primary btn-sm edit_btn">确认提交</button>
                                    <!-- <button class="btn btn-sm" type="reset">{% trans "重置" %}</button> -->
                                    <button type="button" class="btn btn-danger btn-sm del_btn">删除配置</button>
                                </div>
                            </div>

                            <div id="spam">

                                <div>
                                    <table class="table table-bordered table-striped">
                                        <tbody>
                                        <tr>
                                            <td class="text-right" style="width:200px;">反病毒功能：</td>
                                            <td>
                                                <label class="inline" >
                                                    <input name="is_virus" checked type="checkbox" class="ace ace-switch ace-switch-5">
                                                    <span class="lbl"></span>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">反垃圾功能：</td>
                                            <td>
                                                <label class="inline" >
                                                        <!-- sw_antivirus -->
                                                    <input name="is_spam" checked type="checkbox" class="ace ace-switch ace-switch-5">
                                                    <span class="lbl"></span>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">检查附件：
                                            </td>
                                            <td>
                                                <div class="checkbox">
                                                    <label style="margin-right:20px;">
                                                        <input name="check_attach_bak" value="low" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 小危附件 </span>
                                                    </label>
                                                    <label>
                                                        <input name="check_attach_bak" value="high" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 高危附件 </span>
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">匹配黑名单：
                                            </td>
                                            <td>
                                                <div class="checkbox">
                                                    <label style="margin-right:20px;">
                                                        <input name="match_black_bak" value="sender" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 发件人黑名单 </span>
                                                    </label>
                                                    <label>
                                                        <input name="match_black_bak" value="subject" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 主题黑名单 </span>
                                                    </label>
                                                    <label>
                                                        <input name="match_black_bak" value="content" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 内容黑名单 </span>
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">反垃圾引擎：
                                            </td>
                                            <td>
                                                <div class="checkbox">
                                                    <label style="margin-right:20px;">
                                                        <input name="check_spam_bak" value="dspam" type="checkbox" checked class="ace">
                                                        <span class="lbl"> Dspam </span>
                                                    </label>
                                                    <label>
                                                        <input name="check_spam_bak" value="spamassassion" type="checkbox" checked class="ace">
                                                        <span class="lbl"> Spamassassion </span>
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right"> 检查发件人格式：
                                            </td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <label class="inline" >
                                                        <input name="is_formt" checked  type="checkbox" class="ace ace-switch ace-switch-5">
                                                        <span class="lbl"></span>
                                                    </label>
                                                </div>
                                                <div class="col-sm-8 no-padding">
                                                    <span class="middle text-success "><strong style="color: red">注：</strong> 此选项不会作用于“本域进站邮件” </span>

                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right"> 垃圾邮件投递位置：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <select class="form-control" name="spam_folder" style="max-width:200px;">
                                                        <option value="spam"> 垃圾箱 </option>
                                                        <option value="sequester"> 隔离队列 </option>
                                                        <option value="inbox" selected> 收件箱 </option>
                                                    </select>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right" >
                                                垃圾邮件主题标识：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <input type="text" name="spam_subject_flag" placeholder="[***SPAM***]" class="form-control" style="max-width:200px;">
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right"><span class="red bold">*</span> 隔离邮件保存天数：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <input type="number" name="isolate_day" value="15" style="max-width:200px;" class="form-control">
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">发送隔离报告：</td>
                                            <td>
                                                <label class="inline" >
                                                    <input name="is_send_isolate" checked type="checkbox" class="ace ace-switch ace-switch-5">
                                                    <span class="lbl"></span>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">隔离报告发件人：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <input type="text" name="send_isolate_name" style="max-width:200px;" value="spamreporter" class="form-control">
                                                </div>

                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">隔离报告链接地址：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <input type="text" name="isolate_url" value="http://mail.test.com" class="form-control" style="max-width:200px;">

                                                </div>
                                                <div class="col-sm-8">
                                                    <div style="clear: both">
                                                        <span class="middle text-success "><strong style="color: red">注：</strong> “链接地址”必须为类似“mail.example.com“或“114.114.114.114“这种可以通过外网点击访问的地址。如果是“127.0.0.1“,“192.168.xx.xx“这种地址，会导致外网登录的用户无法通过链接操作隔离邮件。 </span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">检测对象：
                                            </td>
                                            <td>
                                                <div class="checkbox">
                                                    <label style="margin-right:20px;">
                                                        <input name="check_object_bak" value="local" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 本域进站邮件 </span>
                                                    </label>
                                                    <label>
                                                        <input name="check_object_bak" value="outside" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 外域进站邮件 </span>
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">本域进站邮件：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <div class="checkbox">
                                                        <label style="margin-right:20px;">
                                                            <input name="check_local_bak" value="spam" type="checkbox" checked class="ace">
                                                            <span class="lbl"> 开启反垃圾 </span>
                                                        </label>
                                                        <label>
                                                            <input name="check_local_bak" value="virus" type="checkbox" checked class="ace">
                                                            <span class="lbl"> 开启反病毒 </span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-sm-8">
                                                    <span class="middle text-success "><strong style="color: red">注：</strong> “反垃圾功能”和“反病毒功能”开启后，这里对应的勾选框才会生效 </span>

                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sw_antivirus">
                                            <td class="text-right">外域进站邮件：</td>
                                            <td class="row">
                                                <div class="col-sm-4 no-padding">
                                                    <div class="checkbox">
                                                        <label style="margin-right:20px;">
                                                            <input name="check_outside_bak" value="spam" type="checkbox" checked class="ace">
                                                            <span class="lbl"> 开启反垃圾 </span>
                                                        </label>
                                                        <label>
                                                            <input name="check_outside_bak" value="virus" type="checkbox" checked class="ace">
                                                            <span class="lbl"> 开启反病毒 </span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-sm-8">
                                                    <span class="middle text-success "><strong style="color: red">注：</strong> “反垃圾功能”和“反病毒功能”开启后，这里对应的勾选框才会生效 </span>

                                                </div>
                                            </td>
                                        </tr>

                                        </tbody>
                                    </table>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary btn-sm edit_btn">确认提交</button>
                                    <!-- <button class="btn btn-sm" type="reset">{% trans "重置" %}</button> -->
                                    <button type="button" class="btn btn-danger btn-sm del_btn">删除配置</button>
                                </div>
                            </div>

                            <div id="frequency">
                                <div>
                                    <table class="table table-bordered table-striped">
                                        <tbody>
                                        <tr>
                                            <td class="text-right">开启发信频率限制：
                                                </td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <label class="inline" >
                                                        <input name="is_frequency" checked type="checkbox" class="ace ace-switch ace-switch-5">
                                                        <span class="lbl"></span>
                                                    </label>
                                                </div>
                                                <div class="col-sm-8">
                                                    <div style="clear: both">
                                                        <span class="middle text-success "><strong style="color: red">注：</strong> 关闭此功能后用户向外域发送邮件时将不受限制 </span>
                                                    </div>
                                                </div>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">速率：</td>
                                            <td class="row">
                                                <div class="col-sm-12">
                                                    每
                                                    <input type="number" name="frequency_minute"  value="5" style="max-width:50px;">
                                                    分钟发信数量
                                                    <input type="number" name="frequency_minute_count"  value="200">
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"> <span class="red bold">*</span>   每小时发信数量：</td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <input type="number" name="frequency_hour_count" value="0" class=" form-control max-width-200">
                                                </div>
                                                <div class="col-sm-8">
                                                    <div style="clear: both">
                                                        <span class="middle text-success "><strong style="color: red">注：</strong> 输入&lt;=0的值代表不限制 </span>
                                                    </div>
                                                </div>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"><span class="red bold">*</span> 每天发信数量：</td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <input type="number" name="frequency_day_count"  value="0" class="form-control max-width-200">

                                                </div>
                                                <div class="col-sm-8">
                                                    <div style="clear: both">
                                                        <span class="middle text-success "><strong style="color: red">注：</strong> 输入&lt;=0的值代表不限制 </span>
                                                    </div>
                                                </div>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">发信频率超限操作：</td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <select name="frequency_operate" class=" form-control  max-width-200">

                                                        <option value="block" >只可发送本地邮件</option>

                                                    </select>
                                                </div>

                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div>
                                    <button type="button" class="btn btn-primary btn-sm edit_btn">确认提交</button>
                                    <!-- <button class="btn btn-sm" type="reset">{% trans "重置" %}</button> -->
                                    <button type="button" class="btn btn-danger btn-sm del_btn">删除配置</button>
                                </div>
                            </div>

                            <div id="oab">

                                <div>
                                    <table class="table table-bordered table-striped">
                                        <tr>
                                            <td class="text-right">界面显示控制：</td>
                                            <td>
                                                <label class="radio radio-inline padding-top-0 margin-top-0 form-inline">
                                                    <label>
                                                        <input type="radio" name="oab_show_mod" value="1" ><span>所有部门 </span>
                                                    </label>
                                                    <label>
                                                        <input type="radio" name="oab_show_mod" value="2"><span>仅本部门 </span>
                                                    </label>
                                                    <label>
                                                        <input type="radio" name="oab_show_mod" value="3"><span>本部门和子部门 </span>
                                                    </label>
                                                    <label>
                                                        <input type="radio" name="oab_show_mod" value="4"><span>指定部门及其子部门 </span>
                                                    </label>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">通讯录导出按钮：
                                            </td>
                                            <td>
                                                <div class="checkbox">
                                                    <label style="margin-right:20px;">
                                                        <input name="oab_show_export" type="checkbox" checked class="ace">
                                                        <span class="lbl"> 显示 </span>
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right">显示指定部门：
                                            </td>
                                            <td>
                                                <div class=" dept_list  active">
                                                    <div style="max-height:400px;overflow: auto;max-width:500px;">
                                                            <table id="deptNames" class="table table-bordered table-hover">
                                                            </table>
                                                    </div>
                                                </div>

                                            </td>
                                        </tr>
                                        <tr >
                                            <td class="text-right">
                                            </td>
                                            <td>
                                                <div class="dept_list active">
                                                    <div style="position:relative;padding-left:0">
                                                        <div id="input_box" class="input-group" style="max-width:300px;">
                                                            <input type="text" value="" readonly placeholder="点击选择部门" class="form-control department_choice">
                                                            <input type="hidden" class="id_dept_id" value="" name="target_dept">
                                                            <span class="input-group-addon clear_dept" style="cursor:pointer;background:#a0a0a0;color:#fff;">清空</span><span class="input-group-addon submit_dept_permit_btn" style="cursor:pointer;background:#1b6aaa;color:#fff;">添加部门</span>
                                                        </div>
                                                        <div class="widget-box widget-color-blue2 email_box_tree" id="tree_box" style="position:absolute;top:32px;z-index:10;min-width:60%;max-width:100%;left:0;">
                                                            <button type="button" class="btn btn-danger btn-sm pull-right close_btn" >&times;</button>
                                                            <div class="widget-body" style="padding-right:20px;">
                                                                <div style="padding:20px  6px 0;">
                                                                    <input type="text" class="search_input form-control" placeholder="输入关键字搜索...">
                                                                </div>
                                                                <div class="widget-main padding-8" style="height:auto;max-height:360px;">
                                                                    <ul id="tree"></ul>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary btn-sm edit_btn">确认提交</button>
                                    <!-- <button class="btn btn-sm" type="reset">{% trans "重置" %}</button> -->
                                    <button type="button" class="btn btn-danger btn-sm del_btn">删除配置</button>
                                </div>
                            </div>

                            <div id="space">
                                <div>
                                    <table class="table table-bordered table-striped">
                                        <tbody>
                                        <tr>
                                            <td class="text-right"> 邮箱空间定时清理：</td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <select name="is_space_clean" class=" form-control  max-width-200">
                                                        <option value="-1">关闭</option>

                                                        <option value="0" selected="">与域名配置相同</option>

                                                        <option value="1">开启</option>

                                                    </select>
                                                </div>
                                                <div class="col-sm-8">
                                                    <div style="clear: both">
                                                        <span class="middle text-success "><strong style="color: red">注：</strong> 设置用户各类邮件的保留时间，超过设置时间的邮件会被自动删除；设置为“0”时会永久保留用户邮件；系统会在每天凌晨  03:50 分自动进行清理</span>
                                                    </div>
                                                </div>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"> <span class="red bold">*</span>  普通邮件保留天数：</td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <input type="number" name="space_clean_normal" value="0" class=" form-control max-width-200">
                                                </div>
                                                <div class="col-sm-8">

                                                </div>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"> <span class="red bold">*</span>  发件箱邮件保留天数：</td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <input type="number" name="space_clean_sent" value="0" class=" form-control max-width-200">
                                                </div>
                                                <div class="col-sm-8">

                                                </div>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"> <span class="red bold">*</span>  垃圾箱邮件保留天数：</td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <input type="number" name="space_clean_spam" value="0" class=" form-control max-width-200">
                                                </div>
                                                <div class="col-sm-8">

                                                </div>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"> <span class="red bold">*</span>  废件箱邮件保留天数：</td>
                                            <td class="row">
                                                <div class="col-sm-4">
                                                    <input type="number" name="space_clean_trash" value="0" class=" form-control max-width-200">
                                                </div>
                                                <div class="col-sm-8">

                                                </div>

                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary btn-sm edit_btn">确认提交</button>
                                    <!-- <button class="btn btn-sm" type="reset">{% trans "重置" %}</button> -->
                                    <button type="button" class="btn btn-danger btn-sm del_btn">删除配置</button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

<div class="modal fade" id="allow_send_email_dress" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">设置发送的外域邮件地址</h4>
            </div>
            <div class="modal-body">
                <div class="table-header">例外地址</div>
                <div>
                        {% csrf_token %}
                        <div style="max-height: 300px;overflow: auto;border-bottom: 1px solid #ddd; margin-bottom: 20px;">
                            <table class="table table-bordered table-center">
                                <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>邮件地址</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody id="send_tbody">
                                    <tr >
                                        <td> </td>
                                        <td> </td>
                                        <td>
                                            <button class="btn btn-xs btn-danger" type="button" onclick="clickLimitSendDelete()">删除</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row">
                            <div class="col-sm-10 col-sm-offset-1">
                                <div class="input-group margin-bottom-8">
                                    <span class="input-group-addon">邮件地址：</span>
                                    <input type="text" name="new_mailbox" class="form-control">
                                </div>
                                <div class="margin-bottom-8">
                                    <textarea class="form-control" name="new_mailbox_list" rows="5" placeholder="批量例外邮箱地址，格式 @126.com|@sina.com|@qq.com"></textarea>
                                </div>
                                <p class="alert alert-warning"><b class="red">注：</b>当对象为邮箱时请在“地址”里填写邮件地址，对象为域时请在“地址”中填写“@域名”，如“@test.com”。</p>
                            </div>
                        </div>
                        <div class="center" style="background:#fafafa;">
                            <button class="btn btn-primary submit_send_permit_btn" type="button">确定</button>
                            <button class="btn btn-warning" type="reset">重置</button>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="allow_recv_email_dress" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">设置接收的外域邮件地址</h4>
            </div>
            <div class="modal-body">
                <div class="table-header">例外地址</div>
                <div>
                    
                        {% csrf_token %}
                        <div style="max-height: 300px;overflow: auto;border-bottom: 1px solid #ddd; margin-bottom: 20px;">
                            <table class="table table-bordered table-center">
                                <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>邮件地址</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody id="recv_tbody">
                                    <tr>
                                        <td> </td>
                                        <td>  </td>
                                    <td>
                                        <button class="btn btn-xs btn-danger" type="button" onclick="clickLimitSendDelete('recv', '{{ num }}')">删除</button>
                                    </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row">
                            <div class="col-sm-10 col-sm-offset-1">
                                <div class="input-group margin-bottom-8">
                                    <span class="input-group-addon">邮件地址：</span>
                                    <input type="text" name="new_mailbox" class="form-control">
                                </div>
                                <div class="margin-bottom-8">
                                    <textarea class="form-control" name="new_mailbox_list" rows="5" placeholder="批量例外邮箱地址，格式 @126.com|@sina.com|@qq.com"></textarea>
                                </div>
                                <p class="alert alert-warning"><b class="red">注：</b>当对象为邮箱时请在“地址”里填写邮件地址，对象为域时请在“地址”中填写“@域名”，如“@test.com”。</p>
                            </div>
                        </div>
                        <div class=" ">
                        </div>
                        <div class="center" style="background:#fafafa;">
                            <button class="btn btn-primary submit_recv_permit_btn" type="button">确定</button>
                            <button class="btn btn-warning" type="reset">重置</button>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block css_block %}
    <link href="{% static "components/datetimepiker/bootstrap-datetimepicker.min.css" %}" rel="stylesheet">
    <style>
    .email_box_tree{display:none;}
    .email_box_tree.active{display:block;}
    #deptNames{
        border:1px solid #eaeaea;
    }
    #deptNames>div{
        margin:2px 0;
    }
    #deptNames>div:hover .bgblue{
        background:#2aabd2;
    }
    .dept_list{
        display:none;
    }
    .dept_list.active{
        display:block;
    }
    </style>
{% endblock %}
{% block my_jsblock %}
    <script src="{% static 'assets/js/fuelux/fuelux.tree.js' %}" ></script>
    <script src="{% static 'assets/js/jquery-ui.custom.js' %}" ></script>
    <script src="{% static 'assets/js/jquery.ui.touch-punch.js' %}" ></script>
    <script src="{% static 'assets/js/jquery-ui.js' %}" ></script>
    <script src="{% static "components/datetimepiker/bootstrap-datetimepicker.min.js" %}"></script>
    <script src="{% static "components/datetimepiker/bootstrap-datetimepicker.zh-CN.js" %}"></script>

    <script>
        var alsendList = [];
        var hashSend = [];
        var alrecvList = [];
        var hashRecv = [];
        function freshHtmlSend(){
            var setting_id = $('#basic>div>button').attr('data_id');
            $.ajax({
                url:"{% url 'ajax_group_setting_white' %}",
                type:'GET',
                async: false,
                data:{setting_id:setting_id},
                success:function(data){
                    data = JSON.parse(data)
                    var sendList = data.send||[];
                    alsendList = data.send||[];
                    hashSend = [];
                    for(var i=0,html='';i<sendList.length;i++){
                        hashSend[sendList[i]] = true;
                        html += '<tr><td>'+(i+1)+'</td><td>'+sendList[i]+'</td> <td> <button class="btn btn-xs btn-danger delete_send_btn" data_email="'+sendList[i]+'" type="button">删除</button></td></tr>'
                    }
                    $('#send_tbody').html(html);
                    $('#allow_send_email_dress').modal('show');
                }
            })
        }
        function freshHtmlRecv(){
            var setting_id = $('#basic>div>button').attr('data_id');
            $.ajax({
                url:"{% url 'ajax_group_setting_white' %}",
                type:'GET',
                async: false,
                data:{setting_id:setting_id},
                success:function(data){
                    data = JSON.parse(data)
                    var recvList = data.recv||[];
                    alrecvList = data.recv||[];
                    hashRecv = [];
                    for(var i=0,html='';i<recvList.length;i++){
                        hashSend[recvList[i]] = true;
                        html += '<tr><td>'+(i+1)+'</td><td>'+recvList[i]+'</td> <td> <button class="btn btn-xs btn-danger delete_recv_btn" data_email="'+recvList[i]+'" type="button">删除</button></td></tr>'
                    }
                    $('#recv_tbody').html(html);
                    $('#allow_recv_email_dress').modal('show');
                }
            })
        }
        $('.show_send_btn').click(function(){
            freshHtmlSend()
        })
        $('.show_recv_btn').click(function(){
            freshHtmlRecv()
        })
        var limit_whitelist = {}
        function get_limit_whitelist(){
            var setting_id = $('#basic>div>button').attr('data_id');
            $.ajax({
                url:"{% url 'ajax_group_setting_white' %}",
                type:'GET',
                async: false,
                data:{setting_id:setting_id},
                success:function(data){
                    limit_whitelist = data;
                }
            })
        }
        $('.limit_send_select').change(function(){
            if($(this).val()=='3'){
                $(this).next().show();
            }else{
                $(this).next().hide();
            }
        })
        $('.submit_send_permit_btn').click(function(){
            var addval = $("#allow_send_email_dress [name='new_mailbox']").val();
            var addStr = $("#allow_send_email_dress [name='new_mailbox_list']").val()
            if(!addval&&!addStr){
                layer.msg('请输入内容~');
                return;
            }
            if(hashSend[addval]){
                layer.msg('已经添加过了~');
                return;
            }
            var sendList = alsendList;
            if(addval!=''&&addval!=undefined){
                sendList.push(addval);
            }
            if(addStr!=''&&addStr!=undefined){
                var addList = addStr.split('|')
                sendList = sendList.concat(addList)
            }
            updateSend(sendList)
            $("#allow_send_email_dress [name='new_mailbox']").val('')
            $("#allow_send_email_dress [name='new_mailbox_list']").val('')
        })
        $('#send_tbody').on('click',' .delete_send_btn',function(){
            var a = $(this).attr('data_email');
            for(var i=0;i<alsendList.length;i++){
                if(alsendList[i]==a){
                    hashSend[a] = false;
                    alsendList.splice(i,1);
                    updateSend(alsendList);
                    break;
                }
            }
        })
        function updateSend(sendList){
            var str = {
                value : sendList,
                type: 'send',
                setting_id: $('#basic>div>button').attr('data_id')
            }
            str = JSON.stringify(str)
            $.ajax({
                // url:"{% url 'group_limit_whitelist_ajax' %}",
                url:"{% url 'ajax_group_setting_white_mdf' %}",
                type:"POST",
                data:str,
                success:function(data){
                    if(data.status=='OK'){
                        layer.msg("操作成功！");
                        freshHtmlSend()
                        // $('#allow_send_email_dress').modal('hide');
                    }else{
                        layer.msg("操作失败：  "+data.message);
                    }
                }
            })
        }
        $('.submit_recv_permit_btn').click(function(){
            var addval = $("#allow_recv_email_dress [name='new_mailbox']").val();
            var addStr = $("#allow_recv_email_dress [name='new_mailbox_list']").val()
            if(!addval&&!addStr){
                layer.msg('请输入内容~');
                return;
            }
            if(hashSend[addval]){
                layer.msg('已经添加过了~');
                return;
            }
            var sendList = alrecvList;
            if(addval!=''&&addval!=undefined){
                sendList.push(addval);
            }
            if(addStr!=''&&addStr!=undefined){
                var addList = addStr.split('|')
                sendList = sendList.concat(addList)
            }
            updateRecv(sendList)
            $("#allow_recv_email_dress [name='new_mailbox']").val('')
            $("#allow_recv_email_dress [name='new_mailbox_list']").val('')
        })
        $('#recv_tbody').on('click',' .delete_recv_btn',function(){
            var a = $(this).attr('data_email');
            for(var i=0;i<alrecvList.length;i++){
                if(alsendList[i]==a){
                    hashRecv[a] = false;
                    alrecvList.splice(i,1);
                    updateRecv(alrecvList);
                    break;
                }
            }
        })
        
        function updateRecv(sendList){
            var str = {
                value : sendList,
                type: 'recv',
                setting_id: $('#basic>div>button').attr('data_id')
            }
            str = JSON.stringify(str)
            $.ajax({
                // url:"{% url 'group_limit_whitelist_ajax' %}",
                url:"{% url 'ajax_group_setting_white_mdf' %}",
                type:"POST",
                data:str,
                success:function(data){
                    if(data.status=='OK'){
                        layer.msg("操作成功！");
                        freshHtmlRecv()
                        // $('#allow_send_email_dress').modal('hide');
                    }else{
                        layer.msg("操作失败：  "+data.message);
                    }
                }
            })
        }


        function clickLimitSendDelete(type, num){
            var entry = "id_" + type + "_row_" + num;
            var entry_val = "id_" + type + "_delete_" + num;
            $("#"+entry_val).val("1");
            $("#"+entry).addClass("display-none");
        }
    </script>

    <script>
        $(function(){
            var path = "{% url 'core_group_list' %}";
            $('#sidebar').find('[href="'+path+'"]').parent().first().addClass('active');
        });
    </script>

    <script>
        $('#edit_email_tabs').tabs();
    </script>

    <script>
    $('[name="oab_show_mod"]').click(function(){
        if($(this).val()==4){
            $('.dept_list').addClass('active')
        }else{
            $('.dept_list').removeClass('active')
        }
    })
        function demoinitdept(treeid,treeparentid,inputparentid,deptArr){
        var treeEle;
        $(treeid).removeData("fu.tree");
        $(treeid).unbind('click.fu.tree');
        function initdepttree(deptArr){
            var sampleData = initiateDemoData(deptArr);
            treeEle = $(treeid).ace_tree({
                dataSource: sampleData['dataSource1'],
                multiSelect: false,
                loadingHTML: '<div class="tree-loading"><i class="ace-icon fa fa-refresh fa-spin blue"></i></div>',
                'open-icon' : 'ace-icon tree-minus hide',
                'close-icon' : 'ace-icon tree-plus hide',
                'selectable' : true,
                'selected-icon' : 'ace-icon fa fa-check',
                'unselected-icon' : 'ace-icon fa fa-times',
                'cacheItems': true,
                'folderSelect': true,
                'folder-open-icon' : 'ace-icon tree-plus',
                'folder-close-icon' : 'ace-icon tree-minus'
            });

            $(treeid).tree('discloseAll');
            $(treeid).tree('closeAll');

            //默认选中节点
            function test(ele){
                if(ele.parent().parent().hasClass('tree-branch')){
                    ele.parent().parent().find('>i').click();
                    test(ele.parent().parent())
                }
            }

            $(treeid).find('.tree-branch,.tree-item').each(function(i,dom){
                //        if($(this).data().id == ccid){
                //            $(this).addClass('active-header');
                //            $(this).find('>i').click()
                //            test($(this));
                //        }
            })
        }
        initdepttree(deptArr);
        $(treeparentid+' .search_input').keyup(function(){
            var keywords = $(this).val();
            $(treeid).removeData("fu.tree");
            $(treeid).unbind('click.fu.tree');
            if(keywords.length>0){
                var initArr = deptArr;
                var reg = new RegExp(keywords, 'i');
                var arr = [];
                var textname = '';
                function getp(id){
                    for(var i=0;i<initArr.length;i++){
                        var a = initArr[i]['id'];
                        var pp = initArr[i]['parent'];
                        var n = initArr[i]['name'];
                        if(a == id){
                            textname += " -- " + n;
                            if(pp>0){
                                getp(pp);
                            }
                        }
                    }
                }
                for(var key in initArr){
                    if(initArr[key]['name'].match(reg)){
                        if(initArr[key]['parent']>0){
                            textname += initArr[key]['name'];
                            getp(initArr[key]['parent']);
                            var obj = {child:0,parent:0,name:textname,id:initArr[key]['id']};
                            textname = '';
                        }else{
                            var obj = {child:0,parent:0,name:initArr[key]['name'],id:initArr[key]['id']};
                        }
                        arr.push(obj);
                    }
                }
                initdepttree(arr)
            }else{
                initdepttree(deptArr);
            }
        })

        function initiateDemoData(deptArr){
            var tree_data = {};
            for(var i=0;i<deptArr.length;i++){
                if(deptArr[i].parent<=0){
                    if(deptArr[i].child&&deptArr[i].child>0){
                        tree_data[deptArr[i].name] = {text:deptArr[i].name,type:"folder",id:deptArr[i].id};
                        tree_data[deptArr[i].name]['additionalParameters']={"children":getSubDate(deptArr[i].id)};
                    }else{
                        tree_data[deptArr[i].name] = {text:deptArr[i].name,type:"item",id:deptArr[i].id};
                    }
                }
            }

            function getSubDate(pid){
                var obj = {};
                for(var i=0;i<deptArr.length;i++){
                    if(deptArr[i]['parent'] == pid){
                        if(deptArr[i].child&&deptArr[i].child>0){
                            obj[deptArr[i].name] = {text:deptArr[i].name,type:"folder",id:deptArr[i].id,child:deptArr[i].child}
                        }else{
                            obj[deptArr[i].name] = {text:deptArr[i].name,type:"item",id:deptArr[i].id,child:deptArr[i].child}
                        }

                    }
                }
                return obj;
            }
            function getAdditionalParameters(arr){
                for(var key in arr){
                    if(arr[key]['type']=="folder"){
                        arr[key]['additionalParameters']={"children":getSubDate(arr[key]['id'])};
                        if(arr[key]['additionalParameters']["children"]){
                            getAdditionalParameters(arr[key]['additionalParameters']["children"])
                        }
                    }
                }
            }
            getAdditionalParameters(tree_data);
            var dataSource1 = function(options, callback){
                var $data = null
                if(!("text" in options) && !("type" in options)){
                    $data = tree_data;//the root tree
                    callback({ data: $data });
                    return;
                }
                else if("type" in options && options.type == "folder") {
                    if("additionalParameters" in options && "children" in options.additionalParameters)
                        $data = options.additionalParameters.children || {};
                    else $data = {}//no data
                }
                if($data != null)//this setTimeout is only for mimicking some random delay
                    callback({ data: $data });
            }
            return {'dataSource1': dataSource1}
        }

        $(treeid).on('click','.tree-item,.tree-branch-header',function(){
            $(treeid+' .tree-selected').removeClass('tree-selected');
            if($(this).hasClass('tree-branch-header')){
                $(this).parent().addClass('tree-selected');
            }else{
                $(this).addClass('tree-selected');
            }
            $(treeparentid).removeClass('active');
            var o = treeEle.tree('selectedItems')[0];
            $(treeparentid).parent().find('.department_choice').val(o.text);
            $(treeparentid).parent().find('.id_dept_id').val(o.id);
        })
        $(treeparentid+' .close_btn').click(function(){
             $(treeparentid).removeClass('active');
        })
        $('body').click(function(e){
            var $parents = $(e.target).parents(treeparentid);
            if(!$(e.target).hasClass('department_choice') && $parents.length<1){
                $(treeparentid).removeClass('active');
            }
        })
        $(inputparentid + ' .department_choice').click(function(){
            $(treeparentid).addClass('active');
        })
        $(inputparentid + ' .clear_dept').click(function(){
            $(inputparentid + ' .department_choice').val('');
            $(inputparentid + ' .id_dept_id').val('');
        })
    }
        // deptArr 为初始化获得的部门数据
        var deptArr = [
            {id:1,parent:0,name:"部门1",child:2},
            {id:2,parent:1,name:"部门2",child:1},
            {id:3,parent:2,name:"部门3",child:0},
            {id:4,parent:1,name:"部门4",child:0},
            {id:5,parent:2,name:"部门5",child:0},
            {id:6,parent:0,name:"部门6",child:0}
        ];
        $.ajax({
            url:"{% url 'choose_mailbox_list' %}",
            type:"POST",
            data:{action:"dept_list"},
            success:function(data){
                console.log(data);
                deptArr = data.dept;
                demoinitdept("#tree","#tree_box","#input_box",deptArr);
            }
        })

        var alreadyDeptList = '';
        var idArr = [];
        var hashId = [];
        var alreadyDeptArr = [];
        function formatStr(arr){
            for(var i=0,html='';i<arr.length;i++){
                var o = arr[i]
                html += '<tr><td>'+o["name"]+'</td><td class="text-center"><button type="button" class="btn btn-warning btn-xs dept_delete_btn" data_id="'+o["id"]+'">删除</button></td></tr>'
            }
            $('#deptNames').html(html);
        }

         //获取已添加的部门列表 新的
        function get_groups_new(){
            $.ajax({
                url:" {% url 'ajax_group_setting_dept' %}",
                type:"GET",
                data:{setting_id:$('#oab>div>button').attr('data_id')},
                success:function(data){
                    data = JSON.parse(data)
                    console.log(data)
                    alreadyDeptArr = [];
                    idArr = [];
                    hashId = [];
                    for(var key in data){
                        let obj = {};
                        obj.id = key
                        obj.name = data[key];
                        alreadyDeptArr.push(obj)
                        idArr.push(key)
                        hashId[key] = true;
                    }
                    formatStr(alreadyDeptArr)
                }
            })
         }

        //更新某个组配置的“指定部门及其子部门”    {% url 'ajax_group_setting_dept_mdf' %}    请求方式：   POST
        function updateDept(arr){
            $.ajax({
                url:"{% url 'ajax_group_setting_dept_mdf' %}",
                type:'POST',
                data:{
                    setting_id:$('#oab>div>button').attr('data_id'),
                    value:JSON.stringify(arr)
                    },
                success:function(data){
                    if(data.status == 'OK'){
                        layer.msg('操作成功！')
                    }else{
                        layer.msg('操作失败！')
                    }
                    get_groups_new()
                }
            })
        }

        $('.submit_dept_permit_btn').click(function(){
            var addval = $('#oab .id_dept_id').val();
            if(!addval){
                layer.msg('请选择部门~')
            }
            if(addval){
                idArr.push(addval)
                updateDept(idArr)
            }
        })
        $('#oab').on('click',' .dept_delete_btn',function(){
            var a = $(this).attr('data_id')
            for(var i=0;i<idArr.length;i++){
                if(idArr[i] == a){
                    idArr.splice(i,1);
                    updateDept(idArr);
                }
            }
        })
        
        $("#spam [name='is_spam']").on('click', function(){
            if($(this).prop('checked')){
                $('.sw_antivirus').show();
            }else{
                $('.sw_antivirus').hide();
            }
        });
        var limit_whitelist = {};
        function init(isInit){
            if(isInit=='1'){
                console.log('init')
                $('#edit_email_tabs>ul>li').addClass('display-none');
                $('#edit_email_tabs>div').hide();
            }
            $.ajax({
                url:"{% url 'ajax_group_setting_list' %}",
                method:'GET',
                data:{group_id:"{{ group_id }}"},
                success:function(data){
                    var res = data.data;
                    var hashArr = [];
                    var arr = [['basic','常规设置'],['login','登录方式限制'],['password','密码规则'],['spam','反垃圾/反病毒'],['frequency','发信频率设置'],['oab','企业通讯录设置'],['space','邮箱空间清理设置']];
                    for(var key in res){
                        var type = res[key].type;
                        var id = res[key].id;
                        $('#edit_email_tabs [href="#'+type+'"]').parent().removeClass('display-none');
                        if(isInit=='1'){
                            let ctype = $('#edit_email_tabs>ul>li:not(".display-none"):eq(0)').find('>a').attr('href').slice(1)
                            $('#edit_email_tabs>ul>li:not(".display-none"):eq(0)').find('>a').click();
                            // $('#edit_email_tabs [href="#'+ctype+'"]').parent().addClass('ui-tabs-active');
                            $('#edit_email_tabs>div#'+ctype).show();
                        }
                        $('#'+type+'>div>button').attr('data_type',type);
                        $('#'+type+'>div>button').attr('data_id',id);
                        $('#edit_email_tabs [href="#'+type+'"]').attr('data_id',id)
                        hashArr[type] = true;
                    }
                    for(var i=0,html='';i<arr.length;i++){
                        if(!hashArr[arr[i][0]]){
                            html += '<option value="'+arr[i][0]+'">'+arr[i][1]+'</option>'
                        }
                    }
                    if(html == ''){
                        $('#add_tab').parent().hide();
                    }else{
                        $('#add_tab').html(html);
                        $('#add_tab').parent().show();
                    }

                }
            })

        }
        init(1);

        function getList(){
           init(0);
        }

        //修改/添加某个组配置 {% url 'ajax_group_setting_mdf' %}
        // (u"basic", u"常规设置"),
        //                 (u"login", u"登陆方式限制"),
        //                 (u"password", u"密码规则"),
        //                 (u"spam", u"反垃圾/反病毒"),
        //                 (u"frequency", u"发信频率设置"),
        //                 (u"oab", u"企业通讯录设置"),
        //                 (u"space", u"邮箱空间设置"),
        function addTab(type,setting_id,val){
            var value = '';
            if(setting_id == 0 ){
                type = $('#add_tab').val();
                if(type == 'basic'){
                    value = {
                        mail_space:0,
                        net_space:0,
                        allow_out_size:0,
                        send_limit:-1,
                        recv_limit:-1,
                        limit_whitelist:{},
                    }
                }else if(type == 'login'){
                    value = {
                        "is_pop": 1,
                        "is_smtp": 1,
                        "is_imap": 1
                    }
                }else if(type == 'password'){
                    value = {
                        "is_passwd": 1,
                        "passwd_day": 0,
                        "passwd_size": 8,
                        "passwd_type": 2,
                        "passwd_other":  {
                            "passwd_digital": 1,
                            "passwd_name2": 1,
                            "passwd_name": 1,
                            "passwd_letter": 1,
                            "passwd_letter2": 1
                            },
                        "passwd_forbid": {
                            "forbid_send": 1,
                            "force_change": 1,
                            "force_change_in_weak": 1,
                            "forbid_send_in_weak": 1
                            }
                    }
                }else if(type == 'spam'){
                    value = {
                        "is_virus": 1,
                        "is_spam": 1,
                        "check_attach": {"high": 1, "low": 0},
                        "match_black": {"content": 1, "sender": 1, "subject": 1},
                        "check_spam": {"spamassassion": 1, "dspam": 1},
                        "is_formt": 1,
                        "spam_folder": "spam",
                        "spam_subject_flag": "",
                        "isolate_day": 15,
                        "is_send_isolate": 0,
                        "send_isolate_name": "",
                        "isolate_url": "",
                        "check_object": {"outside": 1, "local": 1},
                        "check_local": {"virus": 1, "spam": 1},
                        "check_outside": {"virus": 1, "spam": 1}
                    }
                }else if(type == 'frequency'){
                    value = {
                        "is_frequency": 0,
                        "frequency_minute": 0,
                        "frequency_minute_count": 0,
                        "frequency_hour_count": 0,
                        "frequency_day_count": 0,
                        "frequency_operate": "block",
                    }
                }else if(type == 'oab'){
                    value = {
                        "oab_show_mod": 1,
                        "oab_show_export": 0,
                        "oab_dept_list": ""
                    }

                }else if(type == 'space'){
                    value = {
                        "is_space_clean": 0,
                        "space_clean_normal": 0,
                        "space_clean_sent": 0,
                        "space_clean_spam": 0,
                        "space_clean_trash": 0
                    }
                }
            }else{
                value = val;
            }
            console.log(typeof JSON.stringify(value))
            $.ajax({
                url:"{% url 'ajax_group_setting_mdf' %}",
                method:'POST',
                data:{
                    group_id: "{{group_id}}",
                    setting_id  : setting_id,
                    type: type,
                    value : JSON.stringify(value)
                },
                success:function(data){
                    let str = '修改配置成功！';
                    if(setting_id ==0){
                        str = '添加配置成功！';
                        $('#edit_email_tabs>ul>li').removeClass('ui-tabs-active')
                        $('#edit_email_tabs>div').hide();
                        $('#edit_email_tabs [href="#'+type+'"]').parent().removeClass('display-none');
                        $('#edit_email_tabs [href="#'+type+'"]').click();
                        $('#edit_email_tabs>div#'+type).show();
                    }
                    layer.msg(str);
                    // alert(str)
                    getList();
                },
                error:function(err){
                    let str = '修改配置失败！';
                    if(setting_id == 0){
                        str = '添加配置失败！'
                    }
                    console.log(str,err);
                    layer.msg(str);
                }
            })
        }

        $('#add_btn').click(function(){
            addTab(1,0);
        })

        //获取某个具体的组配置参数 {% url 'ajax_group_setting_info' %}
        $('#edit_email_tabs>ul>li>a').click(function(){
            console.log(this);
            var type = $(this).attr('href').slice(1);
            get_groups_new();
            $.ajax({
                url:"{% url 'ajax_group_setting_info' %}",
                type:'GET',
                data:{setting_id:$(this).attr('data_id')},
                success:function(data){
                    console.log(data)
                    var res = data.data;
                    for(var key in res){
                        if(type == 'basic'){
                            $('#basic [name="mail_space"]').val(res['mail_space']);
                            $('#basic [name="net_space"]').val(res['net_space'])
                            $('#basic [name="allow_out_size"]').val(res['allow_out_size'])
                            $('#basic [name="send_limit"]').val(res['send_limit'])
                            $('#basic [name="recv_limit"]').val(res['recv_limit'])
                            if(res['send_limit'] == 3){
                                $('#basic [name="send_limit"]').next().show()
                            }else{
                                $('#basic [name="send_limit"]').next().hide()
                            }
                            if(res['recv_limit'] == 3){
                                $('#basic [name="recv_limit"]').next().show()
                            }else{
                                $('#basic [name="recv_limit"]').next().hide()
                            }
                        }else if(type == 'login'){
                            $('#login [name="is_pop"]').prop('checked',res['is_pop']);
                            $('#login [name="is_smtp"]').prop('checked',res['is_smtp']);
                            $('#login [name="is_imap"]').prop('checked',res['is_imap']);
                        }else if(type == 'password'){
                            $('#password [name="is_passwd"]').prop('checked',res['is_passwd'])
                            $('#password [name="passwd_day"]').val(res['passwd_day'])
                            $('#password [name="passwd_size"]').val(res['passwd_size'])
                            $('#password [name="passwd_type"]').val(res['passwd_type'])
                            if(res['passwd_other']){
                                $('#password [name="passwd_other_bak"][value="passwd_digital"]').prop('checked',res['passwd_other']['passwd_digital'])
                                $('#password [name="passwd_other_bak"][value="passwd_name2"]').prop('checked',res['passwd_other']['passwd_name2'])
                                $('#password [name="passwd_other_bak"][value="passwd_name"]').prop('checked',res['passwd_other']['passwd_name'])
                                $('#password [name="passwd_other_bak"][value="passwd_letter"]').prop('checked',res['passwd_other']['passwd_letter'])
                                $('#password [name="passwd_other_bak"][value="passwd_letter2"]').prop('checked',res['passwd_other']['passwd_letter2'])
                            }
                            if(res['passwd_forbid']){
                                $('#password [name="passwd_forbid_bak"][value="forbid_send"]').prop('checked',res['passwd_forbid']['forbid_send'])
                                $('#password [name="passwd_forbid_bak"][value="force_change"]').prop('checked',res['passwd_forbid']['force_change'])
                                $('#password [name="passwd_forbid_bak"][value="force_change_in_weak"]').prop('checked',res['passwd_forbid']['force_change_in_weak'])
                                $('#password [name="passwd_forbid_bak"][value="forbid_send_in_weak"]').prop('checked',res['passwd_forbid']['forbid_send_in_weak'])
                            }

                        }else if(type == 'spam'){
                            $('#spam [name="is_virus"]').prop('checked',res['is_virus'])
                            $('#spam [name="is_spam"]').prop('checked',res['is_spam'])
                            if(res['is_spam'] == 1){
                                $('.sw_antivirus').show();
                            }else{
                                $('.sw_antivirus').hide();
                            }
                            if(res['check_attach']){
                                $('#spam [name="check_attach_bak"][value="high"]').prop('checked',res['check_attach']['high'])
                                $('#spam [name="check_attach_bak"][value="low"]').prop('checked',res['check_attach']['low'])
                            }
                            if(res['match_black']){
                                $('#spam [name="match_black_bak"][value="content"]').prop('checked',res['match_black']['content'])
                                $('#spam [name="match_black_bak"][value="sender"]').prop('checked',res['match_black']['sender'])
                                $('#spam [name="match_black_bak"][value="subject"]').prop('checked',res['match_black']['subject'])
                            }
                            if(res['check_spam']){
                                $('#spam [name="check_spam_bak"][value="spamassassion"]').prop('checked',res['check_spam']['spamassassion'])
                                $('#spam [name="check_spam_bak"][value="dspam"]').prop('checked',res['check_spam']['dspam'])
                            }
                            $('#spam [name="is_formt"]').prop('checked',res['is_formt'])
                            $('#spam [name="spam_folder"]').val(res['spam_folder'])
                            $('#spam [name="spam_subject_flag"]').val(res['spam_subject_flag'])
                            $('#spam [name="isolate_day"]').val(res['isolate_day'])
                            $('#spam [name="is_send_isolate"]').prop('checked',res['is_send_isolate'])
                            $('#spam [name="send_isolate_name"]').val(res['send_isolate_name'])
                            $('#spam [name="isolate_url"]').val(res['isolate_url'])
                            if(res['check_object']){
                                $('#spam [name="check_object_bak"][value="outside"]').prop('checked',res['check_object']['outside'])
                                $('#spam [name="check_object_bak"][value="local"]').prop('checked',res['check_object']['local'])
                            }
                            if(res['check_local']){
                                $('#spam [name="check_local_bak"][value="virus"]').prop('checked',res['check_local']['virus'])
                                $('#spam [name="check_local_bak"][value="spam"]').prop('checked',res['check_local']['spam'])
                            }
                            if(res['check_outside']){
                                $('#spam [name="check_outside_bak"][value="virus"]').prop('checked',res['check_outside']['virus'])
                                $('#spam [name="check_outside_bak"][value="spam"]').prop('checked',res['check_outside']['spam'])
                            }
                        }else if(type == 'frequency'){
                            $('#frequency [name="is_frequency"]').prop('checked',res['is_frequency'])
                            $('#frequency [name="frequency_minute"]').val(res['frequency_minute'])
                            $('#frequency [name="frequency_minute_count"]').val(res['frequency_minute_count'])
                            $('#frequency [name="frequency_hour_count"]').val(res['frequency_hour_count'])
                            $('#frequency [name="frequency_day_count"]').val(res['frequency_day_count'])
                            $('#frequency [name="frequency_operate"]').val(res['frequency_operate'])

                        }else if(type == 'oab'){
                            $('#oab [name="oab_show_mod"]').prop('checked',false);
                            $('#oab [name="oab_show_mod"][value="'+res['oab_show_mod']+'"]').prop('checked',true)
                            $('#oab [name="oab_show_export"]').prop('checked',res['oab_show_export'])

                            if(res['oab_show_mod'] == 4){
                                $('.dept_list').addClass('active')
                            }else{
                                $('.dept_list').removeClass('active')
                            }


                        }else if(type == 'space'){
                            $('#space [name="is_space_clean"]').val(res['is_space_clean'])
                            $('#space [name="space_clean_normal"]').val(res['space_clean_normal'])
                            $('#space [name="space_clean_sent"]').val(res['space_clean_sent'])
                            $('#space [name="space_clean_spam"]').val(res['space_clean_spam'])
                            $('#space [name="space_clean_trash"]').val(res['space_clean_trash'])

                        }


                    }
                }
            })
        })


        //修改某个组配置
        $('#edit_email_tabs .edit_btn').click(function(){
            let type = $(this).attr('data_type')
            let value = ''
            if(type == 'basic'){
                get_limit_whitelist();
                value = {
                    mail_space: $('#basic [name="mail_space"]').val(),
                    net_space: $('#basic [name="net_space"]').val(),
                    allow_out_size: $('#basic [name="allow_out_size"]').val(),
                    send_limit: $('#basic [name="send_limit"]').val(),
                    recv_limit: $('#basic [name="recv_limit"]').val(),
                    limit_whitelist: limit_whitelist,
                }
            }else if(type == 'login'){
                value = {
                    "is_pop": $('[name="is_pop"]').prop('checked')?1:0,
                    "is_smtp": $('[name="is_smtp"]').prop('checked')?1:0,
                    "is_imap": $('[name="is_imap"]').prop('checked')?1:0
                }
            }else if(type == 'password'){
                value = {
                    "is_passwd": $('#password [name="is_passwd"]').prop('checked')?1:0,
                    "passwd_day": $('#password [name="passwd_day"]').val(),
                    "passwd_size": $('#password [name="passwd_size"]').val(),
                    "passwd_type": $('#password [name="passwd_type"]').val(),
                    "passwd_other": {
                        "passwd_digital": $('#password [name="passwd_other_bak"][value="passwd_digital"]').prop('checked')?1:0,
                        "passwd_name2": $('#password [name="passwd_other_bak"][value="passwd_name2"]').prop('checked')?1:0,
                        "passwd_name": $('#password [name="passwd_other_bak"][value="passwd_name"]').prop('checked')?1:0,
                        "passwd_letter": $('#password [name="passwd_other_bak"][value="passwd_letter"]').prop('checked')?1:0,
                        "passwd_letter2": $('#password [name="passwd_other_bak"][value="passwd_letter2"]').prop('checked')?1:0
                        },
                    "passwd_forbid":  {
                        "forbid_send": $('#password [name="passwd_forbid_bak"][value="forbid_send"]').prop('checked')?1:0,
                        "force_change": $('#password [name="passwd_forbid_bak"][value="force_change"]').prop('checked')?1:0,
                        "force_change_in_weak": $('#password [name="passwd_forbid_bak"][value="force_change_in_weak"]').prop('checked')?1:0,
                        "forbid_send_in_weak": $('#password [name="passwd_forbid_bak"][value="forbid_send_in_weak"]').prop('checked')?1:0
                        }
                }
            }else if(type == 'spam'){
                value = {
                    "is_virus": $('#spam [name="is_virus"]').prop('checked')?1:0,
                    "is_spam": $('#spam [name="is_spam"]').prop('checked')?1:0,
                    "check_attach": {
                        "high": $('#spam [name="check_attach_bak"][value="high"]').prop('checked')?1:0,
                        "low": $('#spam [name="check_attach_bak"][value="low"]').prop('checked')?1:0,
                        },
                    "match_black": {
                        "content": $('#spam [name="match_black_bak"][value="content"]').prop('checked')?1:0,
                        "sender": $('#spam [name="match_black_bak"][value="sender"]').prop('checked')?1:0,
                        "subject": $('#spam [name="match_black_bak"][value="subject"]').prop('checked')?1:0
                        },
                    "check_spam": {
                        "spamassassion": $('#spam [name="check_spam_bak"][value="spamassassion"]').prop('checked')?1:0,
                        "dspam": $('#spam [name="check_spam_bak"][value="dspam"]').prop('checked')?1:0
                        },
                    "is_formt": $('#spam [name="is_formt"]').prop('checked')?1:0,
                    "spam_folder": $('#spam [name="is_formt"]').val(),
                    "spam_subject_flag": $('#spam [name="spam_subject_flag"]').val(),
                    "isolate_day": $('#spam [name="isolate_day"]').val(),
                    "is_send_isolate": $('#spam [name="is_send_isolate"]').prop('checked')?1:0,
                    "send_isolate_name": $('#spam [name="send_isolate_name"]').val(),
                    "isolate_url": $('#spam [name="isolate_url"]').val(),
                    "check_object": {
                        "outside":  $('#spam [name="check_object_bak"][value="outside"]').prop('checked')?1:0,
                        "local":  $('#spam [name="check_object_bak"][value="local"]').prop('checked')?1:0
                        },
                    "check_local": {
                        "virus": $('#spam [name="check_local_bak"][value="virus"]').prop('checked')?1:0,
                        "spam": $('#spam [name="check_local_bak"][value="spam"]').prop('checked')?1:0,
                        },
                    "check_outside": {
                        "virus": $('#spam [name="check_outside_bak"][value="virus"]').prop('checked')?1:0,
                        "spam": $('#spam [name="check_outside_bak"][value="spam"]').prop('checked')?1:0,
                        }
                }
            }else if(type == 'frequency'){
                value = {
                    "is_frequency": $('#frequency [name="is_frequency"]').prop('checked')?1:0,
                    "frequency_minute": $('#frequency [name="frequency_minute"]').val(),
                    "frequency_minute_count": $('#frequency [name="frequency_minute_count"]').val(),
                    "frequency_hour_count":$('#frequency [name="frequency_hour_count"]').val(),
                    "frequency_day_count": $('#frequency [name="frequency_day_count"]').val(),
                    "frequency_operate": $('#frequency [name="frequency_operate"]').val()
                }
            }else if(type == 'oab'){
                value = {
                    "oab_show_mod":  $('#oab [name="oab_show_mod"]:checked').val(),
                    "oab_show_export": $('#oab [name="oab_show_export"]').prop('checked')?1:0,
                    "oab_dept_list": ""
                }

            }else if(type == 'space'){
                value = {
                    "is_space_clean": $('#space [name="is_space_clean"]').val(),
                    "space_clean_normal": $('#space [name="space_clean_normal"]').val(),
                    "space_clean_sent": $('#space [name="space_clean_sent"]').val(),
                    "space_clean_spam": $('#space [name="space_clean_spam"]').val(),
                    "space_clean_trash": $('#space [name="space_clean_trash"]').val()
                }
            }
            addTab($(this).attr('data_type'),$(this).attr('data_id'),value)
        })

        //删除某个组配置   {% url 'ajax_group_setting_del' %}
        $('#edit_email_tabs .del_btn').click(function(){
            $.ajax({
                url:"{% url 'ajax_group_setting_del' %}",
                type:'POST',
                data:{setting_id:$(this).attr('data_id')},
                success:function(data){
                    console.log(data)
                    layer.msg('删除配置成功！')
                    init(1);
                }
            })
        })

        //获取某个组配置的“指定外域收发权限白名单”    {% url 'ajax_group_setting_white' %}    请求方式：   GET
        function get_limit_whitelist(){
            var setting_id = $('#basic>div>button').attr('data_id');
            $.ajax({
                url:"{% url 'ajax_group_setting_white' %}",
                type:'GET',
                async: false,
                data:{setting_id:setting_id},
                success:function(data){
                    limit_whitelist = data;
                }
            })
        }

        //更新某个组配置的“指定外域收发权限白名单”    {% url 'ajax_group_setting_white_mdf' %}    请求方式：   POST

    </script>

{% endblock %}

