{% extends 'base_site.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% if form.instance %} {% trans "修改审核规则" %}  {% else %} {% trans "添加审核规则" %} {% endif %}{% endblock %}

{% block breadcrumb %}
<li> <a href="#">{% trans "审核规则" %}</a> </li>
<li class="active">{% if form.instance %} {% trans "修改审核规则" %}  {% else %} {% trans "添加审核规则" %} {% endif %}</li>
{% endblock %}

{% block page-content %}
<div class="row">
    <div class="space-6"></div>
    <div class="col-xs-12">
        <div class="page-header">
            <h1>{% if form.instance %} {% trans "修改审核规则" %}  {% else %} {% trans "添加审核规则" %} {% endif %}
                <small>
                    <i class="ace-icon fa fa-angle-double-right"></i>
                    {{ form.name.value }}
                </small>
            </h1>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xs-12">
        <form class="form-horizontal" role="form" action="" method="POST" id="id_Form">
            {% csrf_token %}

            <div class="form-group {% if form.name.error %} has-error {% endif %}">
                <label class="col-sm-3 control-label no-padding-right" for="id_name"> {% trans "规则名称 " %}</label>
                <div class="col-sm-9">
                    <input type="text" name="name" id="id_name" value="{{ form.name.value }}" maxlength="250" class="col-xs-10 col-sm-5" required/>
                    {% if form.name.error %}
                    <div style="clear: both">
                        <p class="errornote txt-color-red">{{ form.name.error }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group {% if form.review_id.error %} has-error {% endif %}">
                <label class="col-sm-3 control-label no-padding-right" for="id_review_id"> {% trans "审核人 " %}</label>
                <div class="col-sm-9">
                    <input type="hidden" value="{{ form.review_id.value }}" id="id_review_id" name="review_id">
                    <div class="input-group col-xs-10 col-sm-5">
                        <input type="text" name="review_name" id="id_review_name" value="{{ form.review_id.extra }}" readonly="readonly" class="col-xs-10 col-sm-4 form-control" onclick="Javascript: onclickReview()"/>
                            <span class="input-group-btn">
                                <a data-toggle="modal" data-target="#MyReviwModal" data-whatever=""
                                   href="#" class="btn btn-sm btn-default" type="button" title="选择审核人" id="id_review_model">
                                    <i class="ace-icon fa fa-users bigger-110 green"></i>{% trans "选择" %}
                                </a>
                                <a class="btn btn-sm btn-grey" type="button" title="{% trans "清空审核人" %} href="Javascript: clearReview()">{% trans "清空" %}</a>
                            </span>
                    </div>
                    {% if form.review_id.error %}
                    <div style="clear: both">
                        <p class="errornote txt-color-red">{{ form.review_id.error }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="id_workmode"> {% trans "审核类型 " %}</label>
                <div class="col-sm-9">
                    <select class="col-xs-10 col-sm-5" id="id_workmode" name="workmode">
                        {% for k, v in form.reviewrule_workmodes %}
                        <option value="{{ k }}" {% if form.workmode.value == k %} selected {% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="id_pre_action"> {% trans "审核预设 " %}</label>
                <div class="col-sm-9">
                    <select class="col-xs-10 col-sm-5" id="id_pre_action" name="pre_action">
                        {% for k, v in form.reviewrule_preactions %}
                        <option value="{{ k }}" {% if form.pre_action.value == k %} selected {% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            {% if form.target_dept.extra %}
                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" for="id_target_dept"> {% trans "发信人部门 " %}</label>
                    <div class="col-sm-9">
                        <div class="col-xs-10 col-sm-5 no-padding">
                            <div id="input_box" class="input-group">
                                <input type="text" value="{{ form.target_dept.extra }}" readonly placeholder="{% trans "点击选择部门" %}" class="form-control department_choice">
                                <input type="hidden" class="id_dept_id" value="{{form.target_dept.value}}" name="target_dept">
                                <span class="input-group-addon clear_dept" style="cursor:pointer;background:#a0a0a0;color:#fff;">{% trans "清空" %}</span>
                            </div>
                            <div class="widget-box widget-color-blue2 email_box_tree" id="tree_box" style="position:absolute;top:32px;z-index:10;min-width:60%;max-width:100%;left:0;">
                                <button type="button" class="btn btn-danger btn-sm pull-right close_btn" style="">&times;</button>
                                <div class="widget-body" style="padding-right:20px;">
                                    <div style="padding:20px  6px 0;">
                                        <input type="text" class="search_input form-control" placeholder="{% trans "输入关键字搜索..." %}">
                                    </div>
                                    <div class="widget-main padding-8" style="height:auto;max-height:360px;">
                                        <ul id="tree"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            <div class="widget-box widget-color-blue2 email_box_tree" id="tree_box" style="position:absolute;top:32px;z-index:10;min-width:60%;max-width:100%;left:0;">
                                <button type="button" class="btn btn-danger btn-sm pull-right close_btn" style="">&times;</button>
                                <div class="widget-body" style="padding-right:20px;">
                                    <div style="padding:20px  6px 0;">
                                        <input type="text" class="search_input form-control" placeholder="{% trans "输入关键字搜索..." %}">
                                    </div>
                                    <div class="widget-main padding-8" style="height:auto;max-height:360px;">
                                        <ul id="tree"></ul>
                                    </div>
                                </div>
                            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="id_sequence"> {% trans "权重 " %}</label>
                <div class="col-sm-9">
                    <input type="number" id="id_sequence" name="sequence" value="{{ form.sequence.value }}" class="col-xs-10 col-sm-5" required/>
                </div>
                <div class="">
                    <label class="col-sm-3 control-label no-padding-right"></label>
                        <span class="help-inline col-xs-9 col-sm-7">
                            <span class="middle text-success">{% trans "数值越小优先级越高，数值相等时主键越小优先级越高" %}</span>
                        </span>
                </div>
            </div>


            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="id_disabled"> {% trans "状态 " %}</label>
                <div class="col-sm-9">
                    <select class="col-xs-10 col-sm-5" id="id_disabled" name="disabled">
                        {% for k, v in form.reviewrule_disableds %}
                        <option value="{{ k }}" {% if form.disabled.value == k %}selected{% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-sm-3 no-padding-right">{% trans "审核条件" %}</label>
                <div class="col-sm-9">
                    <div id="id_options" class="tab-pane fade active in col-xs-10 col-sm-7 no-padding">
                        <!--<h4 class="blue">-->
                            <!--<i class="green ace-icon fa fa-user bigger-110"></i>-->
                            <!--{% trans "条件--" %}>
                        <!--</h4>-->
                        <!--<div class="space-8"></div>-->
                        <div >
                            <span>{% trans "父条件间关系：" %}</span>
                            <div class="radio inline">
                                <label>
                                    <input name="logic_parent" type="radio" checked class="ace" value="all">
                                    <span class="lbl">{% trans "满足所有条件" %}</span>
                                </label>
                            </div>
                            <div class="radio inline">
                                <label>
                                    <input name="logic_parent" type="radio" class="ace" value="one">
                                    <span class="lbl middle"> {% trans "满足一条即可" %}</span>
                                </label>
                            </div>
                            <input id="id_option_id" name="option_ids[]" value="{{ d.id }}--{{ d.parent_id }}" type="hidden">
                            <button type="button" class="btn btn-sm btn-success add_condition" style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>{% trans "新增条件" %}</button>
                        </div>
                        <div class="hr"></div>
                        <div id="faq-list-3" class="panel-group accordion-style1 accordion-style2 condition_box">

                            <div class="panel panel-default" id="id_option0">
                                <div class="panel-heading" style="position:relative;">
                                    <a href="#faq-0" data-toggle="collapse" class="accordion-toggle">
                                        <i class="smaller-80 ace-icon fa fa-chevron-down" data-icon-hide="ace-icon fa fa-chevron-down align-top" data-icon-show="ace-icon fa fa-chevron-right"></i>&nbsp;
                                        <b>{% trans "条件" %}</b>
                                    </a>
                                </div>

                                <div class="panel-collapse collapse in" id="faq-0">
                                    <div class="panel-body">
                                        <div >
                                            <span>{% trans "子条件间关系：" %}</span>
                                            <div class="radio inline">
                                                <label>
                                                    <input name="con_logic0" type="radio" checked class="ace con_logic" value="all">
                                                    <span class="lbl"> {% trans "满足所有" %}</span>
                                                </label>
                                            </div>
                                            <div class="radio inline">
                                                <label>
                                                    <input name="con_logic0" type="radio" class="ace con_logic" value="one">
                                                    <span class="lbl middle"> {% trans "满足任意" %}</span>
                                                </label>
                                            </div>
                                            <button type="button" class="btn btn-xs btn-info add_sub_condition" style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>{% trans "新增子条件" %}</button>
                                        </div>
                                        <ul>
                                            <li class="condition_item">
                                                <div class="hr"></div>
                                                <div class="row">
                                                    <div class="col-sm-2 control-label">
                                                        {% trans "子条件：" %}
                                                    </div>
                                                    <div class="col-sm-10">
                                                        <div class="row">
                                                            <div class="col-sm-2 no-padding">
                                                            <select class="form-control"  id="id_ruletype0" name="ruletype" style="height: 34px;">
                                                                    <option value="subject">{% trans "主题" %}</option>
                                                                    <option value="date" >{% trans "邮件时间" %}</option>
                                                                    <option value="recipient">{% trans "收件人" %}</option>
                                                                    <option value="sender">{% trans "发件人" %}</option>
                                                                    <option value="content">{% trans "邮件内容" %}</option>
                                                                    <option value="mail_size">{% trans "邮件大小" %}</option>
                                                                    <option value="attachment">{% trans "附件名" %}</option>
                                                                    <option value="has_attach">{% trans "拥有附件" %}</option>
                                                                    <option value="all_mail">{% trans "所有邮件" %}</option>
                                                                    <option value="sender_dept">{% trans "发信人部门" %}</option>
                                                                    <option value="rcpt_dept">{% trans "收信人部门" %}</option>
                                                                    <option value="sender_ip">{% trans "发信人IP" %}</option>
                                                                    <option value="header_received">{% trans "邮件头Received" %}</option>
                                                                    <option value="is_proxy_out">{% trans "设置了外发代理" %}</option>
                                                                    <option value="is_proxy_in">{% trans "设置了接收代理" %}</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-sm-10 no-padding">
                                                            <div class="col-sm-2 no-padding actions">
                                                                <select class="form-control"   id="id_rule_action_contain0" name="rule_action_contain" style="height: 34px;">
                                                                    <option value="contains">{% trans "包含" %}</option>
                                                                    <option value="not_contains">{% trans "不包含" %}</option>
                                                                    <option value="==">{% trans "等于" %}</option>
                                                                </select>
                                                                <select class="form-control display-none"
                                                                        id="id_rule_action_eq0" name="rule_action_eq" style="height: 34px;">
                                                                    <option value="==">{% trans "等于" %}</option>
                                                                    <option value=">=">{% trans "大于等于" %}</option>
                                                                    <option value="<=">{% trans "小于等于" %}</option>
                                                                </select>
                                                                <select class="form-control display-none"  id="id_rule_action_belong0" name="rule_action_belong" style="height: 34px;">
                                                                    <option value="in">{% trans "属于" %}</option>
                                                                    <option value="not_in">{% trans "不属于" %}</option>
                                                                </select>
                                                            </div>
                                                                <div class="col-sm-8 no-padding values">
                                                                    <input type="text" name="rule_value_common" id="id_rule_value_common0" value="" maxlength="300"
                                                                          style="width: 100%;"/>
                                                                    <input type="number" name="rule_value_size" id="id_rule_value_size0" value=""
                                                                           class="display-none"  style="width: 100%;"/>
                                                                    <input type="text" name="rule_value_date" id="id_rule_value_date0" value="" readonly="" size="16" data-date-format="yyyy-mm-dd hh:ii:00"
                                                                           class="dateinput display-none"  style="width: 100%;"/>

                                                                    <div id="id_rule_value_dpt0" class="col-xs-12 col-sm-12 no-padding  display-none ">
                                                                        <div class="input-group">
                                                                            <div id="input_box0">
                                                                                <input type="text" value="" readonly placeholder="{% trans "点击选择部门" %}" class="form-control department_choice">
                                                                                <input type="hidden" class="id_dept_id" value="" name="option_value_dpt0">
                                                                            </div>
                                                                            <div class="input-group-btn">
                                                                                <input type="hidden" name="option_value_dpt_sub" value="1">
                                                                                <button type="button" style="border: 1px solid #abbac3" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                                                                                    <b class="select_c" data_val="1">{% trans "包含子部门" %}</b>
                                                                                    <span class="caret"></span></button>
                                                                                <ul class="dropdown-menu">
                                                                                    <li><a href="1">{% trans "包含子部门" %}</a></li>
                                                                                    <li><a href="-1">{% trans "仅当前部门" %}</a></li>
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                        </div>
                                                    </div>

                                                </div>

                                            </li>
                                        </ul>
                                    </div>
                                    </div>
                                </div>

                        </div>

                    </div>
                </div>
            </div>


            <div class="clearfix form-actions">
                <div class="col-md-offset-3 col-md-9">
                    <button type="button" class="btn btn-info" id="id_save_button">
                        <i class="ace-icon fa fa-check bigger-110"></i>{% trans "保存" %}
                    </button>
                    <button class="btn" type="reset">
                        <i class="ace-icon fa fa-undo bigger-110"></i>{% trans "重置" %}
                    </button>

                    <a type="button" class="btn btn-link" href="{% url 'reviewrule_list' %}">{% trans "取消" %}</a>
                </div>
            </div>
        </form>


    </div><!-- /.span -->
</div><!-- /.row -->


<div class="modal fade " id="MyReviwModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="margin:120px auto; width: 1000px;">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">{% trans "加载中" %}</h4>
            </div>
            <div class="modal-body">
                {% trans "页面加载中" %}
            </div>
            <div class="modal-footer">
                <button type="button" id="modal_close" class="btn btn-default hidden" data-dismiss="modal">{% trans "关闭" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block css_block %}
<link rel="stylesheet" href="{% static 'otreetable1.0/otreetable.css' %}" />
<link href="{% static "components/datetimepiker/bootstrap-datetimepicker.min.css" %}" rel="stylesheet">
<style>
    #id_options select{
        padding-left:2px;
        padding-right:2px;
    }
    .email_box_tree{display:none;}
    .email_box_tree.active{display:block;}
    #id_options>div:not(:first-child)>div>.input-group.col-xs-3.col-sm-3{
        width:268px;
    }
    #id_options>div{
        margin-bottom:10px;
    }
</style>
{% endblock %}

{% block my_jsblock %}
<script type="text/javascript" src="{% static 'otreetable1.0/otreetable.js' %}"></script>

<script src="{% static "components/datetimepiker/bootstrap-datetimepicker.min.js" %}"></script>
{% if request.COOKIES.webvue_language == 'zh-hans'  %}
    <script src="{% static "components/datetimepiker/bootstrap-datetimepicker.zh-CN.js" %}"></script>
{% endif %}
<script src="{% static 'assets/js/fuelux/fuelux.tree.js' %}" ></script>
<script>


    function saveButtonAdd(){$("#id_save_button").attr("disabled", "disabled").addClass('disabled');}
    function saveButtonRemove(){$("#id_save_button").removeAttr("disabled").removeClass('disabled');}

    $(function () {

        // 防止重复提交
        saveButtonRemove();
        $("#id_save_button").click(function(){
            {#saveButtonAdd();#}
            {#$("#id_Form").submit();#}
            var ruleData = {};
            ruleData.id = {{ rule_id }};
            ruleData.name = $('#id_name').val();
            ruleData.review_id = $('#id_review_id').val();
            ruleData.workmode = $('#id_workmode').val();
            ruleData.pre_action = $('#id_pre_action').val();
            ruleData.target_dept = $('[name="target_dept"]').val();
            ruleData.sequence = $('#id_sequence').val();
            ruleData.disabled = $('#id_disabled').val();
            ruleData.cond_logic = $('[name="logic_parent"]:checked').val();

            var data=[];
            $('#faq-list-3>.panel').each(function(k,dom){
                var obj={};
                obj.logic=$(this).find('.con_logic:checked').val();
                var condition1 = $(this).find('.condition_item')[0];
                obj.option=$(condition1).find('[name="ruletype"]').val();
                $(condition1).find('.actions select').each(function(i,dom){
                    if(!$(this).hasClass('display-none')){
                        obj.action = $(this).val();
                    }
                })
                $(condition1).find('.values>input').each(function(i,dom){
                    if(!$(this).hasClass('display-none')){
                            obj.value = $(this).val();
                            obj.value_desc = $(this).val();
                    }
                })
                if(!$(condition1).find('.values>div').hasClass('display-none')){
                    obj.value_desc = $(condition1).find('.values>div .department_choice').val();
                    obj.value = {"id": $(condition1).find('.values>div .id_dept_id').val(),"sub": $(condition1).find('.values>div [name="option_value_dpt_sub"]').val()};
                }
                var objSub=[];
                var that = this;
                $(this).find('.condition_item').each(function(j){
                    if(j>0){
                        var sub = {};
                        var condition2 = $(that).find('.condition_item')[j];
                        sub.option=$(condition2).find('[name="ruletype"]').val();
                        $(condition2).find('.actions select').each(function(i,dom){
                            if(!$(this).hasClass('display-none')){
                                sub.action = $(this).val();
                            }
                        })
                        $(condition2).find('.values>input').each(function(i,dom){
                            if(!$(this).hasClass('display-none')){
                                sub.value = $(this).val();
                                sub.value_desc = $(this).val();
                            }
                        })
                        if(!$(condition2).find('.values>div').hasClass('display-none')){
                            sub.value_desc = $(condition2).find('.values>div .department_choice').val();
                            sub.value = {"id": $(condition2).find('.values>div .id_dept_id').val(),"sub": $(condition2).find('.values>div [name="option_value_dpt_sub"]').val()};
                        }
                        objSub.push(sub);
                    }
                })
                obj.sub=objSub;

                data.push(obj);
            })
            ruleData.condition = data;
            ruleData = JSON.stringify(ruleData);
            console.log(ruleData)
            $.ajax({
            url:"{% url 'ajax_reviewrule_cond_add' %}",
            type:"POST",
            data:"&data="+ruleData,
            success:function(data){
                if(data.result==1){
                    alert('{% trans "规则更新成功" %}');
                    window.location.href="{% url 'reviewrule_list' %}"
                } else {
                    alert('{% trans "规则更新失败:" %}'+data.failure);
                }
                }
            })
        });

        /** 模型弹出框 **/
        $('#MyReviwModal').on('show.bs.modal', function (event) {
            $(this).removeData('bs.modal');
        })

        $("#id_review_model").click(function(){
            var review_id = $("#id_review_id").val();
            $("#id_review_model").attr('href', '{% url 'choose_review_list' %}?model_review_id=' + review_id);
        });

        $("#id_department_model").click(function(){
            var department_id = $("#id_target_dept").val();
            $("#id_department_model").attr('href', '{% url 'choose_department_list' %}?model_department_id=' + department_id);
        });

        $('.dateinput').datetimepicker({
            format: 'yyyy-mm-dd hh:ii:00',
            language: 'zh-CN',
            weekStart: 1,
            todayBtn: 1,
            autoclose: 1,
            // minView: 2,
            pickerPosition: "top-right",
        });

        $('.select2').select2();

        {% for d in form.option.value %}
            $('.dateinput{{ d.id }}').datetimepicker({
                format: 'yyyy-mm-dd hh:ii:00',
                language: 'zh-CN',
                weekStart: 1,
                todayBtn: 1,
                autoclose: 1,
                // minView: 2,
                pickerPosition: "top-right",
            });
        {% endfor %}

    });

    function onclickReview() {
        $("#id_review_model").click();
    }

    function clearReview(){
        $("#id_review_id").val(0);
        $("#id_review_name").val("");
    }

    $('body').on('change','[name="ruletype"]',function(){
        var v = $(this).val()
        $(this).parent().next().find('.actions>select').addClass('display-none');
        $(this).parent().next().find('.values>input').addClass('display-none');
        $(this).parent().next().find('.values>div').addClass('display-none');
        if(v=='subject'|| v=='recipient'||v=='sender'||v=='content'||v=='attachment'||v=='sender_ip'||v=='header_received'){
            $(this).parent().next().find('.actions>select[name="rule_action_contain"]').removeClass('display-none');
            $(this).parent().next().find('.values>input[name="rule_value_common"]').removeClass('display-none');
        }else if(v=='date'){
            $(this).parent().next().find('.actions>select[name="rule_action_eq"]').removeClass('display-none');
            $(this).parent().next().find('.values>input[name="rule_value_date"]').removeClass('display-none');
        }else if(v=='mail_size'){
            $(this).parent().next().find('.actions>select[name="rule_action_eq"]').removeClass('display-none');
            $(this).parent().next().find('.values>input[name="rule_value_size"]').removeClass('display-none');
        }else if(v=='sender_dept'||v=='rcpt_dept'){
            $(this).parent().next().find('.actions>select[name="rule_action_belong"]').removeClass('display-none');
            $(this).parent().next().find('.values>div').removeClass('display-none');
        }
    })

    function S4(){ return (((1+Math.random())*0x10000)|0).toString(16).substring(1); }
    function GenerateGuid(){ return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()); }


    function demoinitdept(treeid,treeparentid,inputparentid,deptArr){
        var treeEle;
        $(treeid).removeData("fu.tree");
        $(treeid).unbind('click.fu.tree');
        function initdepttree(deptArr){
            var sampleData = initiateDemoData(deptArr);
            treeEle = $(treeid).ace_tree({
                dataSource: sampleData['dataSource1'],
                multiSelect: false,
                loadingHTML: '<div class="tree-loading"><i class="ace-icon fa fa-refresh fa-spin blue"></i></div>',
                'open-icon' : 'ace-icon tree-minus hide',
                'close-icon' : 'ace-icon tree-plus hide',
                'selectable' : true,
                'selected-icon' : 'ace-icon fa fa-check',
                'unselected-icon' : 'ace-icon fa fa-times',
                'cacheItems': true,
                'folderSelect': true,
                'folder-open-icon' : 'ace-icon tree-plus',
                'folder-close-icon' : 'ace-icon tree-minus'
            });

            $(treeid).tree('discloseAll');
            $(treeid).tree('closeAll');

            //默认选中节点
            function test(ele){
                if(ele.parent().parent().hasClass('tree-branch')){
                    ele.parent().parent().find('>i').click();
                    test(ele.parent().parent())
                }
            }

            $(treeid).find('.tree-branch,.tree-item').each(function(i,dom){
                //        if($(this).data().id == ccid){
                //            $(this).addClass('active-header');
                //            $(this).find('>i').click()
                //            test($(this));
                //        }
            })
        }
        initdepttree(deptArr);
        $(treeparentid+' .search_input').keyup(function(){
            var keywords = $(this).val();
            $(treeid).removeData("fu.tree");
            $(treeid).unbind('click.fu.tree');
            if(keywords.length>0){
                var initArr = deptArr;
                var reg = new RegExp(keywords, 'i');
                var arr = [];
                var textname = '';
                function getp(id){
                    for(var i=0;i<initArr.length;i++){
                        var a = initArr[i]['id'];
                        var pp = initArr[i]['parent'];
                        var n = initArr[i]['name'];
                        if(a == id){
                            textname += " -- " + n;
                            if(pp>0){
                                getp(pp);
                            }
                        }
                    }
                }
                for(var key in initArr){
                    if(initArr[key]['name'].match(reg)){
                        if(initArr[key]['parent']>0){
                            textname += initArr[key]['name'];
                            getp(initArr[key]['parent']);
                            var obj = {child:0,parent:0,name:textname,id:initArr[key]['id']};
                            textname = '';
                        }else{
                            var obj = {child:0,parent:0,name:initArr[key]['name'],id:initArr[key]['id']};
                        }
                        arr.push(obj);
                    }
                }
                initdepttree(arr)
            }else{
                initdepttree(deptArr);
            }
        })

        function initiateDemoData(deptArr){
            var tree_data = {};
            for(var i=0;i<deptArr.length;i++){
                if(deptArr[i].parent<=0){
                    if(deptArr[i].child&&deptArr[i].child>0){
                        tree_data[deptArr[i].name] = {text:deptArr[i].name,type:"folder",id:deptArr[i].id};
                        tree_data[deptArr[i].name]['additionalParameters']={"children":getSubDate(deptArr[i].id)};
                    }else{
                        tree_data[deptArr[i].name] = {text:deptArr[i].name,type:"item",id:deptArr[i].id};
                    }
                }
            }

            function getSubDate(pid){
                var obj = {};
                for(var i=0;i<deptArr.length;i++){
                    if(deptArr[i]['parent'] == pid){
                        if(deptArr[i].child&&deptArr[i].child>0){
                            obj[deptArr[i].name] = {text:deptArr[i].name,type:"folder",id:deptArr[i].id,child:deptArr[i].child}
                        }else{
                            obj[deptArr[i].name] = {text:deptArr[i].name,type:"item",id:deptArr[i].id,child:deptArr[i].child}
                        }

                    }
                }
                return obj;
            }
            function getAdditionalParameters(arr){
                for(var key in arr){
                    if(arr[key]['type']=="folder"){
                        arr[key]['additionalParameters']={"children":getSubDate(arr[key]['id'])};
                        if(arr[key]['additionalParameters']["children"]){
                            getAdditionalParameters(arr[key]['additionalParameters']["children"])
                        }
                    }
                }
            }
            getAdditionalParameters(tree_data);
            var dataSource1 = function(options, callback){
                var $data = null
                if(!("text" in options) && !("type" in options)){
                    $data = tree_data;//the root tree
                    callback({ data: $data });
                    return;
                }
                else if("type" in options && options.type == "folder") {
                    if("additionalParameters" in options && "children" in options.additionalParameters)
                        $data = options.additionalParameters.children || {};
                    else $data = {}//no data
                }
                if($data != null)//this setTimeout is only for mimicking some random delay
                    callback({ data: $data });
            }
            return {'dataSource1': dataSource1}
        }

        $(treeid).on('click','.tree-item,.tree-branch-header',function(){
            $(treeid+' .tree-selected').removeClass('tree-selected');
            if($(this).hasClass('tree-branch-header')){
                $(this).parent().addClass('tree-selected');
            }else{
                $(this).addClass('tree-selected');
            }
            $(treeparentid).removeClass('active');
            var o = treeEle.tree('selectedItems')[0];
            $(treeparentid).parent().find('.department_choice').val(o.text);
            $(treeparentid).parent().find('.id_dept_id').val(o.id);
        })
        var showb = false;
        $('body').click(function(e){
            var $parents = $(e.target).parents(treeparentid);
            if(!$(e.target).hasClass('department_choice') && $parents.length<1){
                $(treeparentid).removeClass('active');
            }
        })
        $(inputparentid + ' .clear_dept').click(function(){
            $(inputparentid + ' .department_choice').val('');
            $(inputparentid + ' .id_dept_id').val('');
        })
    }
    // deptArr 为初始化获得的部门数据
    var deptArr = [
        {id:1,parent:0,name:"部门1",child:2},
        {id:2,parent:1,name:"部门2",child:1},
        {id:3,parent:2,name:"部门3",child:0},
        {id:4,parent:1,name:"部门4",child:0},
        {id:5,parent:2,name:"部门5",child:0},
        {id:6,parent:0,name:"部门6",child:0}
    ];

    //选择包含子部门或仅当前部门
    $('#id_options').on('click','ul.dropdown-menu a',function(e){
        e.preventDefault();
        var val = $(this).attr('href');
        var text = $(this).html();
        $(this).parents('ul').prev().find('b').html(text).attr('data_val',val);
        $(this).parents('ul').prev().prev().val(val);
        if($(this).parents('ul').prev().hasClass('and_or')){
            $(this).parents('.con_parent').find('.and_or').find('b').html(text).attr('data_val',val);
        }
    })
    function initD(){
        $.ajax({
            url:"{% url 'choose_mailbox_list' %}",
            type:"POST",
            data:{action:"dept_list"},
            success:function(data){
                console.log(data);
                deptArr = data.dept;
                demoinitdept("#tree","#tree_box","#input_box",deptArr);
                demoinitdept("#tree0","#tree_box0","#input_box0",deptArr);
                for(var i=0;i<deptinitarr.length;i++){
                    demoinitdept("#tree"+deptinitarr[i],"#tree_box"+deptinitarr[i],"#input_box"+deptinitarr[i],deptArr);
                }
                deptinitarr = [];
            }
        })
        $('.dateinput').datetimepicker({
            format: 'yyyy-mm-dd hh:ii:00',
            language: 'zh-CN',
            weekStart: 1,
            todayBtn: 1,
            autoclose: 1,
            // minView: 2,
            pickerPosition: "top-right",
        });
    }

    //增加父条件

    $('body').on('click','.delete_sub_condition',function(){
        $(this).parents('.condition_item').remove();
    })
    $('body').on('click','.delete_condition',function(){
        $(this).parents('.panel.panel-default').remove();

    })

</script>
<script>
var data = [
{
    action:"in",logic:"all",option:"sender_dept",rule_id:16,value:{"id": "732", "sub": "-1"},value_desc:"已删除部门_732",
    sub:[
        {action:"not_in",option:"rcpt_dept",value:{"id": "727", "sub": "-1"},value_desc:"已删除部门_727"}
        ]
},
{
    action:"contains",logic:"one",option:"subject",rule_id:16,value:"审核测试",value_desc:"审核测试",
    sub:[
        {action: ">=", value_desc: "2018-08-07 05:10:00", option: "date", value: "2018-08-07 05:10:00"},
        {action: "==", value_desc: "1", option: "has_attach", value: "1"},
        {action: ">=", value_desc: "10086", option: "mail_size", value: "10086"},
        {action: "contains", value_desc: "test.com", option: "sender", value: "test.com"},
        {action: "contains", value_desc: "test.com", option: "recipient", value: "test.com"}
    ]
}
]

var deptinitarr = [];
$.ajax({
    url:"{% url 'ajax_reviewrule_cond_list' %}",
    type:"GET",
    data:"rule_id="+"{{ rule_id }}",
    success:function(data) {
        console.log("获取数据");
        console.log(data);
        if (data.length > 0) {
            var htmls = '';

            function getsubHtml(rule_id, obj) {
                var html = '<li class="condition_item"><div class="hr"></div><div class="row"> <div class="col-sm-2 control-label">{% trans "子条件： " %}</div><div class="col-sm-10"><div class="row"> <div class="col-sm-2 no-padding"> <select class="form-control" id="id_ruletype' + rule_id + '"  name="ruletype" style="height: 34px;"><option value="subject" '
                if (obj.option == 'subject') {
                    html += 'selected'
                }
                html += '>{% trans "主题" %}</option><option value="date" '
                if (obj.option == 'date') {
                    html += 'selected'
                }
                html += '>{% trans "邮件时间" %}</option><option value="recipient" '
                if (obj.option == 'recipient') {
                    html += 'selected'
                }
                html += '>{% trans "收件人" %}</option><option value="sender" '
                if (obj.option == 'sender') {
                    html += 'selected'
                }
                html += '>{% trans "发件人" %}</option><option value="content" '
                if (obj.option == 'content') {
                    html += 'selected'
                }
                html += '>{% trans "邮件内容" %}</option> <option value="mail_size" '
                if (obj.option == 'mail_size') {
                    html += 'selected'
                }
                html += '>{% trans "邮件大小" %}</option> <option value="attachment" '
                if (obj.option == 'attachment') {
                    html += 'selected'
                }
                html += '>{% trans "附件名" %}</option> <option value="has_attach" '
                if (obj.option == 'has_attach') {
                    html += 'selected'
                }
                html += '>{% trans "拥有附件" %}</option><option value="all_mail" '
                if (obj.option == 'all_mail') {
                    html += 'selected'
                }
                html += '>{% trans "所有邮件" %}</option><option value="sender_dept" '
                if (obj.option == 'sender_dept') {
                    html += 'selected'
                }
                html += '>{% trans "发信人部门" %}</option> <option value="rcpt_dept" '
                if (obj.option == 'rcpt_dept') {
                    html += 'selected'
                }
                html += '>{% trans "收信人部门" %}</option><option value="sender_ip" '
                if (obj.option == 'sender_ip') {
                    html += 'selected'
                }
                html += '>{% trans "发信人IP" %}</option><option value="header_received" '
                if (obj.option == 'header_received') {
                    html += 'selected'
                }
                html += '>{% trans "邮件头Received" %}</option><option value="is_proxy_out" '
                if (obj.option == 'is_proxy_out') {
                    html += 'selected'
                }
                html += '>{% trans "设置了外发代理" %}</option><option value="is_proxy_in" '
                if (obj.option == 'is_proxy_in') {
                    html += 'selected'
                }
                html += '>{% trans "设置了接收代理" %}</option></select></div><div class="col-sm-10 no-padding"><div class="col-sm-2 no-padding actions"><select class="form-control  '
                if (obj.option == 'subject' || obj.option == 'recipient' || obj.option == 'sender' || obj.option == 'content' || obj.option == 'attachment' || obj.option == 'sender_ip' || obj.option == 'header_received') {
                } else {
                    html += 'display-none'
                }
                html += ' "   id="id_rule_action_contain' + rule_id + '" name="rule_action_contain" style="height: 34px;"><option value="contains" '
                if (obj.action == 'contains') {
                    html += 'selected'
                }
                html += '>{% trans "包含" %}</option><option value="==" '
                if (obj.action == '==') {
                    html += 'selected'
                }
                html += '>{% trans "等于" %}</option><option value="not_contains" '
                if (obj.action == 'not_contains') {
                    html += 'selected'
                }
                html += '>{% trans "不包含" %}</option> </select><select class="form-control  '
                if (obj.option != 'date' && obj.option != 'mail_size') {
                    html += 'display-none'
                }
                html += '" id="id_rule_action_eq' + rule_id + '" name="rule_action_eq" style="height: 34px;"><option value="==" '
                if (obj.action == '==') {
                    html += 'selected'
                }
                html += '>{% trans "等于" %}</option><option value=">=" '
                if (obj.action == '>=') {
                    html += 'selected'
                }
                html += '>{% trans "大于等于" %}</option><option value="<=" '
                if (obj.action == '<=') {
                    html += 'selected'
                }
                html += '>{% trans "小于等于" %}</option></select><select class="form-control '
                if (obj.option != 'sender_dept' && obj.option != 'rcpt_dept') {
                    html += 'display-none'
                }
                html += '"  id="id_rule_action_belong' + rule_id + '" name="rule_action_belong" style="height: 34px;"><option value="in" '
                if (obj.action == 'in') {
                    html += 'selected'
                }
                html += '>{% trans "属于" %}</option> <option value="not_in" '
                if (obj.action == 'not_in') {
                    html += 'selected'
                }
                html += '>{% trans "不属于" %}</option></select> </div><div class="col-sm-8 no-padding values"> <input type="text" name="rule_value_common" id="id_rule_value_common' + rule_id + '" class="'
                if (obj.option == 'attach_size' || obj.option == 'mail_size' || obj.option == 'date' || obj.option == 'has_attach' || obj.option == 'all_mail' || obj.option == 'sender_dept' || obj.option == 'rcpt_dept' || obj.option == 'is_proxy_out' || obj.option == 'is_proxy_in') {
                    html += 'display-none'
                }
                html += '" value="'
                if (obj.option != 'sender_dept' && obj.option != 'rcpt_dept') {
                    html += obj.value
                }
                html += '" maxlength="300"   style="width: 100%;"/> <input type="number" name="rule_value_size" id="id_rule_value_size' + rule_id + '" value="' + obj.value + '" class="'
                if (obj.option != 'attach_size' && obj.option != 'mail_size') {
                    html += 'display-none'
                }
                html += '"  style="width: 100%;"/> <input type="text" name="rule_value_date" id="id_rule_value_date' + rule_id + '" class="dateinput '
                if (obj.option != 'date') {
                    html += 'display-none'
                }
                html += '" value="'
                if (obj.option == 'date') {
                    html += obj.value
                }
                html += '" readonly="" size="16" data-date-format="yyyy-mm-dd hh:ii:00"  style="width:100%"> <div id="id_rule_value_dpt' + rule_id + '" class="col-xs-12 col-sm-12 no-padding  '
                if (obj.option != 'sender_dept' && obj.option != 'rcpt_dept') {
                    html += 'display-none'
                }
                html += '"><div class="input-group"><div id="input_box' + rule_id + '"> <input type="text" value="'
                if (obj.value.id) {
                    html += obj.value_desc
                }
                html += '" readonly placeholder='+'{% trans "点击选择部门" %}'+' class="form-control department_choice">  <input type="hidden" class="id_dept_id" value="'
                if (obj.value.id) {
                    html += obj.value.id
                }
                html += '" name="option_value_dpt"></div> <div class="input-group-btn"> <input type="hidden" name="option_value_dpt_sub" value="'
                if (obj.value.sub == '-1') {
                    html += '-1'
                } else {
                    html += '1'
                }
                html += '"><button type="button" style="border: 1px solid #abbac3" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <b class="select_c" data_val="'
                if (obj.value.sub == '-1') {
                    html += '-1'
                } else {
                    html += '1'
                }
                html += '">'
                if (obj.value.sub == '-1') {
                    html += '{% trans "仅当前部门" %}'
                } else {
                    html += '{% trans "包含子部门" %}'
                }
                html += '</b><span class="caret"></span></button> <ul class="dropdown-menu"><li><a href="1">{% trans "包含子部门" %}</a></li><li><a href="-1">{% trans "仅当前部门" %}</a></li> </ul> </div> </div> </div> </div> <div class="col-sm-1"> <button type="button" class="delete_sub_condition btn btn-xs btn-warning" title="删除此子条件"><i class="glyphicon glyphicon-trash"></i></button>  </div> </div></div> </div> </div> </li>'
                return html;
            }

            for (var i = 0; i < data.length; i++) {
                var obj = data[i];
                console.log(obj.logic)
                var rule_id = GenerateGuid();
                deptinitarr.push(rule_id);

                htmls += '<div class="panel panel-default"><div class="panel-heading" style="position:relative;"><a href="#faq-id_option' + rule_id + '" data-toggle="collapse" class="accordion-toggle"><i class="smaller-80 ace-icon fa fa-chevron-down" data-icon-hide="ace-icon fa fa-chevron-down align-top" data-icon-show="ace-icon fa fa-chevron-right"></i>&nbsp;<b>{% trans "条件" %}</b></a>'
                if (i > 0) {
                    htmls += '<button type="button" class="delete_condition btn btn-sm btn-danger pull-right" data-id="id_option' + rule_id + '" style="position:absolute;top:-0;right:0;">{% trans "删除条件" %}</button>'
                }
                htmls += '</div><div class="panel-collapse collapse in" id="faq-id_option' + rule_id + '"><div class="panel-body"><div ><span>{% trans "子条件间关系：" %}</span> <div class="radio inline"><label> <input name="cond_logic' + rule_id + '"  type="radio"  '
                if (obj.logic == 'all') {
                    htmls += 'checked'
                }
                htmls += '  class="ace con_logic" value="all"> <span class="lbl"> {% trans "满足所有" %}</span></label> </div><div class="radio inline"><label><input name="cond_logic' + rule_id + '" '
                if (obj.logic == 'one') {
                    htmls += 'checked'
                }
                htmls += '  type="radio" class="ace con_logic" value="one"><span class="lbl middle"> {% trans "满足任意" %}</span></label></div><button type="button" class="btn btn-xs btn-info add_sub_condition" style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>{% trans "新增子条件" %}</button></div><ul><li class="condition_item"> <div class="hr"></div><div class="row"><div class="col-sm-2 control-label"> {% trans "子条件：" %}</div><div class="col-sm-10"><div class="row"> <div class="col-sm-2 no-padding"><select class="form-control"  id="id_ruletype' + rule_id + '" name="ruletype" style="height: 34px;"><option value="subject" '
                if (obj.option == 'subject') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "主题" %}</option> <option value="date" '
                if (obj.option == 'date') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "邮件时间" %}</option> <option value="recipient" '
                if (obj.option == 'recipient') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "收件人" %}</option> <option value="sender" '
                if (obj.option == 'sender') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "发件人" %}</option><option value="content" '
                if (obj.option == 'content') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "邮件内容" %}</option> <option value="mail_size" '
                if (obj.option == 'mail_size') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "邮件大小" %}</option> <option value="attachment" '
                if (obj.option == 'attachment') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "附件名" %}</option> <option value="has_attach" '
                if (obj.option == 'has_attach') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "拥有附件" %}</option>  <option value="all_mail" '
                if (obj.option == 'all_mail') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "所有邮件" %}</option><option value="sender_dept" '
                if (obj.option == 'sender_dept') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "发信人部门" %}</option><option value="rcpt_dept" '
                if (obj.option == 'rcpt_dept') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "收信人部门" %}</option><option value="sender_ip" '
                if (obj.option == 'sender_ip') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "发信人IP" %}</option><option value="header_received" '
                if (obj.option == 'header_received') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "邮件头Received" %}</option> <option value="is_proxy_out" '
                if (obj.option == 'is_proxy_out') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "设置了外发代理" %}</option><option value="is_proxy_in" '
                if (obj.option == 'is_proxy_in') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "设置了接收代理" %}</option></select></div><div class="col-sm-10 no-padding"><div class="col-sm-2 no-padding actions"><select class="form-control  '
                if (obj.option == 'subject' || obj.option == 'recipient' || obj.option == 'sender' || obj.option == 'content' || obj.option == 'attachment' || obj.option == 'sender_ip' || obj.option == 'header_received') {
                } else {
                    htmls += 'display-none'
                }
                htmls += ' " id="id_rule_action_contain' + rule_id + '" name="rule_action_contain" style="height: 34px;"> <option value="contains" '
                if (obj.action == 'contains') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "包含" %}</option><option value="==" '
                if (obj.action == '==') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "等于" %}</option><option value="not_contains" '
                if (obj.action == 'not_contains') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "不包含" %}</option></select><select class="form-control  '
                if (obj.option == 'date' || obj.option == 'mail_size') {
                } else {
                    htmls += 'display-none'
                }
                htmls += '" id="id_rule_action_eq' + rule_id + '" name="rule_action_eq" style="height: 34px;"><option value="==" '
                if (obj.action == '==') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "等于" %}</option><option value=">=" '
                if (obj.action == '>=') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "大于等于" %}</option><option value="<=" '
                if (obj.action == '<=') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "小于等于" %}</option></select> <select class="form-control '
                if (obj.option != 'sender_dept' && obj.option != 'rcpt_dept') {
                    htmls += 'display-none'
                }
                htmls += '"  id="id_rule_action_belong' + rule_id + '" name="rule_action_belong" style="height: 34px;"><option value="in" '
                if (obj.action == 'in') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "属于" %}</option><option value="not_in" '
                if (obj.action == 'not_in') {
                    htmls += 'selected'
                }
                htmls += '>{% trans "不属于" %}</option>  </select> </div><div class="col-sm-8 no-padding values"> <input class="'
                if (obj.option == 'attach_size' || obj.option == 'mail_size' || obj.option == 'date' || obj.option == 'has_attach' || obj.option == 'all_mail' || obj.option == 'sender_dept' || obj.option == 'rcpt_dept' || obj.option == 'is_proxy_out' || obj.option == 'is_proxy_in') {
                    htmls += 'display-none'
                }
                htmls += '" type="text" name="rule_value_common" id="id_rule_value_common' + rule_id + '" value="'
                if (obj.option != 'sender_dept' && obj.option != 'rcpt_dept') {
                    htmls += obj.value;
                }
                htmls += '" maxlength="300"  style="width: 100%;"/><input type="number" name="rule_value_size" id="id_rule_value_size' + rule_id + '" value="'
                if (obj.option == 'attach_size' || obj.option == 'mail_size') {
                    htmls += obj.value;
                }
                htmls += '"  class="'
                if (obj.option != 'attach_size' && obj.option != 'mail_size') {
                    htmls += 'display-none'
                }
                htmls += '"  style="width: 100%;"/> <input type="text" name="rule_value_date" id="id_rule_value_date' + rule_id + '" value="'
                if (obj.option == 'date') {
                    htmls += obj.value;
                }
                htmls += '" readonly="" size="16" data-date-format="yyyy-mm-dd hh:ii:00"  class="dateinput '
                if (obj.option != 'date') { htmls += 'display-none' }
                htmls += '"  style="width: 100%;"/> <div id="id_rule_value_dpt' + rule_id + '" class="col-xs-12 col-sm-12 no-padding '
                if (obj.option != 'sender_dept' && obj.option != 'rcpt_dept') {
                    htmls += 'display-none'
                }
                htmls += '"> <div class="input-group"> <div id="input_box' + rule_id + '"><input type="text" value="'
                if (obj.value.id) {
                    htmls += obj.value_desc
                }
                htmls += '" readonly placeholder='+'{% trans "点击选择部门" %}'+'class="form-control department_choice"><input type="hidden" class="id_dept_id" value="'
                if (obj.value.id) {
                    htmls += obj.value.id
                }
                htmls += '" name="option_value_dpt"> </div><div class="input-group-btn"><input type="hidden" name="option_value_dpt_sub" value="'
                if (obj.value.sub == '-1') {
                    htmls += '-1'
                } else {
                    htmls += '1'
                }
                htmls += '"><button type="button" style="border: 1px solid #abbac3" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><b class="select_c" data_val="'
                if (obj.value.sub == '-1') {
                    htmls += '-1'
                } else {
                    htmls += '1'
                }
                htmls += '">'
                if (obj.value.sub == '-1') {
                    htmls += '{% trans "仅当前部门" %}'
                } else {
                    htmls += '{% trans "包含子部门" %}'
                }
                htmls += '</b><span class="caret"></span></button> <ul class="dropdown-menu"> <li><a href="1">{% trans "包含子部门" %}</a></li><li><a href="-1">{% trans "仅当前部门" %}</a></li></ul> </div></div></div></div></div></div> </div></div></li>'
                for (var k = 0; k < data[i].sub.length; k++) {
                    var sub_rule_id = GenerateGuid();
                    htmls += getsubHtml(sub_rule_id, data[i].sub[k]);
                    deptinitarr.push(sub_rule_id);
                }


                htmls += '</ul></div></div></div>';

            }
            $('#faq-list-3').html(htmls)

        }
        initD();

    }
})

function getConditionNew(rule_id){
        var con =  '<div class="panel panel-default" id="id_option'+rule_id+'"><div class="panel-heading" style="position:relative;"><a href="#faq-'+rule_id+'" data-toggle="collapse" class="accordion-toggle"><i class="smaller-80 ace-icon fa fa-chevron-down" data-icon-hide="ace-icon fa fa-chevron-down align-top" data-icon-show="ace-icon fa fa-chevron-right"></i>&nbsp;<b>'+'{% trans "条件" %}'+'</b></a><button type="button" class="delete_condition btn btn-sm btn-danger pull-right" data-id="id_option'+rule_id+'" style="position:absolute;top:-0;right:0;">'+'{% trans "删除条件" %}'+'</button></div><div class="panel-collapse collapse in" id="faq-'+rule_id+'"><div class="panel-body"><div ><span>'+'{% trans "子条件间关系：" %}'+'</span><div class="radio inline"><label><input name="con_logic'+rule_id+'" type="radio" checked class="ace con_logic" value="all"><span class="lbl"> '+'{% trans "满足所有" %}'+'</span></label></div><div class="radio inline"><label><input name="con_logic'+rule_id+'" type="radio" class="ace con_logic" value="one"><span class="lbl middle"> '+'{% trans "满足任意" %}'+'</span></label></div><button type="button" class="btn btn-xs btn-info add_sub_condition" style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>'+'{% trans "新增子条件" %}'+'</button></div><ul><li class="condition_item"><div class="hr"></div><div class="row"><div class="col-sm-2 control-label">'+'{% trans "子条件：" %}'+'</div><div class="col-sm-10"><div class="row"><div class="col-sm-2 no-padding"><select class="form-control"  id="id_ruletype'+rule_id+'" name="ruletype"  style="height: 34px;"><option value="subject">'+'{% trans "主题" %}'+'</option> <option value="date" >'+'{% trans "邮件时间" %}'+'</option><option value="recipient">'+'{% trans "收件人" %}'+'</option> <option value="sender">'+'{% trans "发件人" %}'+'</option><option value="content">'+'{% trans "邮件内容" %}'+'</option>  <option value="mail_size">'+'{% trans "邮件大小" %}'+'</option> <option value="attachment">'+'{% trans "附件名" %}'+'</option> <option value="has_attach">'+'{% trans "拥有附件" %}'+'</option><option value="all_mail">'+'{% trans "所有邮件" %}'+'</option><option value="sender_dept">'+'{% trans "发信人部门" %}'+'</option> <option value="rcpt_dept">'+'{% trans "收信人部门" %}'+'</option> <option value="sender_ip">'+'{% trans "发信人IP" %}'+'</option><option value="header_received">'+'{% trans "邮件头Received" %}'+'</option><option value="is_proxy_out">'+'{% trans "设置了外发代理" %}'+'</option><option value="is_proxy_in">'+'{% trans "设置了接收代理" %}'+'</option> </select></div> <div class="col-sm-10 no-padding"><div class="col-sm-2 no-padding actions"> <select class="form-control"   id="id_rule_action_contain'+rule_id+'" name="rule_action_contain" style="height: 34px;"><option value="contains">'+'{% trans "包含" %}'+'</option><option value="not_contains">'+'{% trans "不包含" %}'+'</option><option value="==">'+'{% trans "等于" %}'+'</option></select><select class="form-control display-none" id="id_rule_action_eq'+rule_id+'" name="rule_action_eq" style="height: 34px;"><option value="==">'+'{% trans "等于" %}'+'</option> <option value=">=">'+'{% trans "大于等于" %}'+'</option> <option value="<=">'+'{% trans "小于等于" %}'+'</option> </select><select class="form-control display-none"  id="id_rule_action_belong'+rule_id+'" name="rule_action_belong" style="height: 34px;"><option value="in">'+'{% trans "属于" %}'+'</option> <option value="not_in">'+'{% trans "不属于" %}'+'</option> </select> </div><div class="col-sm-8 no-padding values"><input type="text" name="rule_value_common" id="id_rule_value_common'+rule_id+'" value="" maxlength="300"  style="width: 100%;"/><input type="number" name="rule_value_size" id="id_rule_value_size'+rule_id+'" value="" class="display-none"  style="width: 100%;"/> <input type="text" name="rule_value_date" id="id_rule_value_date'+rule_id+'" value="" readonly="" size="16" data-date-format="yyyy-mm-dd hh:ii:00" class="dateinput display-none"  style="width: 100%;"/><div id="id_rule_value_dpt'+rule_id+'" class="col-xs-12 col-sm-12 no-padding  display-none "><div class="input-group"> <div id="input_box'+rule_id+'"><input type="text" value="" readonly placeholder="'+'{% trans "点击选择部门" %}'+'" class="form-control department_choice"> <input type="hidden" class="id_dept_id" value="" name="option_value_dpt'+rule_id+'"></div><div class="input-group-btn"><input type="hidden" name="option_value_dpt_sub" value="1"> <button type="button" style="border: 1px solid #abbac3" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><b class="select_c" data_val="1">'+'{% trans "包含子部门" %}'+'</b> <span class="caret"></span></button>  <ul class="dropdown-menu"><li><a href="1">'+'{% trans "包含子部门" %}'+'</a></li><li><a href="-1">'+'{% trans "仅当前部门" %}'+'</a></li> </ul> </div></div> </div></div></div></div> </div></div></li> </ul> </div></div></div>';
                            return con;
    }
function getsubHtmlAdd(rule_id){
    var html = '<li class="condition_item"><div class="hr"></div><div class="row"><div class="col-sm-2 control-label"> '+'{% trans "子条件：" %}'+'</div><div class="col-sm-10"><div class="row"><div class="col-sm-2 no-padding"><select class="form-control" id="id_ruletype'+rule_id+'"  name="ruletype" style="height: 34px;"><option value="subject">'+'{% trans "主题" %}'+'</option><option value="date">'+'{% trans "邮件时间" %}'+'</option> <option value="recipient">'+'{% trans "收件人" %}'+'</option><option value="sender">'+'{% trans "发件人" %}'+'</option><option value="content">'+'{% trans "邮件内容" %}'+'</option><option value="mail_size">'+'{% trans "邮件大小" %}'+'</option><option value="attachment">'+'{% trans "附件名" %}'+'</option><option value="has_attach">'+'{% trans "拥有附件" %}'+'</option><option value="all_mail">'+'{% trans "所有邮件" %}'+'</option><option value="sender_dept">'+'{% trans "发信人部门" %}'+'</option><option value="rcpt_dept">'+'{% trans "收信人部门" %}'+'</option><option value="sender_ip">'+'{% trans "发信人IP" %}'+'</option> <option value="header_received">'+'{% trans "邮件头Received" %}'+'</option><option value="is_proxy_out">'+'{% trans "设置了外发代理" %}'+'</option> <option value="is_proxy_in">'+'{% trans "设置了接收代理" %}'+'</option></select></div> <div class="col-sm-10 no-padding"><div class="col-sm-2 no-padding actions"><select class="form-control"   id="id_rule_action_contain'+rule_id+'" name="rule_action_contain" style="height: 34px;"><option value="contains">'+'{% trans "包含" %}'+'</option><option value="not_contains">'+'{% trans "不包含" %}'+'</option><option value="==">'+'{% trans "等于" %}'+'</option></select><select class="form-control display-none"  id="id_rule_action_eq'+rule_id+'" name="rule_action_eq" style="height: 34px;"><option value="==">'+'{% trans "等于" %}'+'</option><option value=">=">'+'{% trans "大于等于" %}'+'</option><option value="<=">'+'{% trans "小于等于" %}'+'</option></select><select class="form-control display-none"  id="id_rule_action_belong'+rule_id+'" name="rule_action_belong" style="height: 34px;"><option value="in">'+'{% trans "属于" %}'+'</option><option value="not_in">'+'{% trans "不属于" %}'+'</option></select> </div> <div class="col-sm-8 no-padding values"><input type="text" name="rule_value_common" id="id_rule_value_common'+rule_id+'"  maxlength="300" style="width: 100%;"/><input type="number" name="rule_value_size" id="id_rule_value_size'+rule_id+'" value="" class="display-none"  style="width: 100%;"/><input type="text" name="rule_value_date" id="id_rule_value_date'+rule_id+'" class="display-none" value="" readonly="" size="16" data-date-format="yyyy-mm-dd hh:ii:00" class="dateinput display-none"  style="width: 100%;"/><div id="id_rule_value_dpt'+rule_id+'" class="col-xs-12 col-sm-12 no-padding  display-none"><div class="input-group"> <div id="input_box'+rule_id+'"><input type="text" value="" readonly placeholder="'+'{% trans "点击选择部门" %}'+'" value="" class="form-control department_choice"><input type="hidden" class="id_dept_id" name="option_value_dpt"> </div><div class="input-group-btn"> <input type="hidden" name="option_value_dpt_sub" value="1"><button type="button" style="border: 1px solid #abbac3" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">  <b class="select_c" data_val="1">'+'{% trans "包含子部门" %}'+'</b> <span class="caret"></span></button><ul class="dropdown-menu"> <li><a href="1">'+'{% trans "包含子部门" %}'+'</a></li><li><a href="-1">'+'{% trans "仅当前部门" %}'+'</a></li> </ul></div></div> </div> </div><div class="col-sm-1"><button type="button" class="delete_sub_condition btn btn-xs btn-warning" title="'+'{% trans "删除此子条件" %}'+'"><i class="glyphicon glyphicon-trash"></i></button></div></div></div> </div> </div></li>'
    return html;
}

$('.add_condition').click(function(){
        var rule_id = GenerateGuid();
        $(".condition_box").append(getConditionNew(rule_id));
        $('#id_rule_value_date'+rule_id).datetimepicker({
            format: 'yyyy-mm-dd hh:ii:00',
            language: 'zh-CN',
            weekStart: 1,
            todayBtn: 1,
            autoclose: 1,
            // minView: 2,
            pickerPosition: "top-right",
        });
    })

$('body').on('click','.add_sub_condition',function(){
        var rule_id = GenerateGuid();
        var index = $(this).attr('data-parent-id');
        $(this).parent().next().append(getsubHtmlAdd(rule_id));
        $('#id_rule_value_date'+rule_id).datetimepicker({
            format: 'yyyy-mm-dd hh:ii:00',
            language: 'zh-CN',
            weekStart: 1,
            todayBtn: 1,
            autoclose: 1,
            // minView: 2,
            pickerPosition: "top-right",
        });

    })

{#$('body').on('click','#')#}
$('body').on('click','.department_choice',function(){
    $(this).parent().append($('#tree_box'));
    $('#tree_box').addClass('active')
})
$('body').on('click','.close_btn',function(e){
    e.preventDefault();
    $('#tree_box').removeClass('active')
    {#$(this).parent().hide()#}
})

</script>

{% endblock %}
