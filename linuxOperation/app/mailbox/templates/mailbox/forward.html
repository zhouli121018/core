
{% load tags %}
{% load i18n %}
<div class="modal-content">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">自动转发设置 -> {{ mailbox_obj.username }}</h4>
    </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-lg-4">
                <span>用户可否设置：</span>
                <input name="forward_visible" value="1" onclick="change_forward({{mailbox_obj.id}}, this,'forward_visible');" {% if forward_visible == '1' %}checked{% endif %} type="radio"> 是
                <input name="forward_visible" value="-1" onclick="change_forward({{mailbox_obj.id}}, this,'forward_visible');" {% if forward_visible == '-1' %}checked{% endif %} type="radio"> 否
            </div>
            <div class="col-lg-4">
                <span>仅转发本地邮箱：</span>
                <input name="forward_local" value="1" onclick="change_forward({{mailbox_obj.id}}, this,'forward_local');" {% if forward_local == '1' %}checked{% endif %} type="radio"> 是
                <input name="forward_local" value="-1" onclick="change_forward({{mailbox_obj.id}}, this,'forward_local');" {% if forward_local == '-1' %}checked{% endif %} type="radio"> 否
            </div>
        </div>
        <div>
            <div class="forward_box forward_list">
                <div>
                    <button class="btn btn-success pull-right btn-sm box_show_btn" style="margin-bottom:6px;" >新增</button>
                </div>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>排序</th>
                            <th>条件关系</th>
                            <th>条件</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="forward_tbody">
    
                    </tbody>
                </table>
    
                <div class="well" style="background:#fff;margin-top:12px;">
                    <p>通过本功能您可以根据您设置的条件规则来进行自动转发</p>
                    <p>操作方法:</p>
                    <ul>
                        <li>根据您的需要选择规则条件，可以对邮件（原始）发件人、（原始）收件人/抄送人、邮件主题、和邮件大小进行设定。</li>
                        <li>已经设置完毕的规则会显示在自动转发列表中，也可以对该自动转发规则进行删除/修改操作。</li>
                        <li>单击增加规则页【确定】完成单条规则设置。</li>
                    </ul>
                    <p>注意事项:</p>
                    <ul>
                        <li>自动转发规则的执行顺序：规则列表由上而下的顺序；支持手动进行规则排序。</li>
                        <li>如要对所有收到的邮件进行自动转发，则可设置条件为：发件人包含@。</li>
                    </ul>
                </div>
            </div>
            <div class="forward_box display-none">
                <table class="table table-bordered">
                    <tr>
                        <td>是否启用</td>
                        <td>
                            <label class="inline" >
                                <input name="disabled" checked id="status_checkbox_forward" type="checkbox" class="ace ace-switch ace-switch-5">
                                <span class="lbl"></span>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:110px;">自动回复条件：</td>
                        <td id="forward_condition_box">
                            
                            
                        </td>
                    </tr>
                    <tr>
                        <td>转发到：</td>
                        <td>
                            <textarea class="form-control" rows="2" name="forward_body" id="forward_body"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>同时将信件保存在本邮箱内：</td>
                        <td>
                            <label class="inline" >
                                <input  checked id="is_save_forward" type="checkbox" class="ace ace-switch ace-switch-5">
                                <span class="lbl"></span>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="center">
                            
    
                            <button type="button" onclick="" class="btn btn-sm btn-primary add_btn" type_id="0">保存</button>
                            <button type="button" class="btn btn-sm btn-danger hide_box_btn" >返回</button>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="tree_div_box">
                <div class="display-none">
                    <div id="input_box_forward" class="input-group">
                        <input type="text" value="" readonly placeholder="点击选择部门" class="form-control department_choice">
                        <input type="hidden" class="id_dept_id" value="" name="target_dept">
                        <span class="input-group-addon clear_dept" style="cursor:pointer;background:#a0a0a0;color:#fff;">清空</span>
                    </div>
                    <div class="widget-box widget-color-blue2 email_box_tree" id="tree_box_forward" style="position:absolute;top:32px;z-index:10;min-width:60%;max-width:100%;left:0;">
                        <button type="button" class="btn btn-danger btn-sm pull-right close_btn" style="">&times;</button>
                        <div class="widget-body" style="padding-right:20px;">
                            <div style="padding:20px  6px 0;">
                                <input type="text" class="search_input form-control" placeholder="输入关键字搜索...">
                            </div>
                            <div class="widget-main padding-8" style="height:auto;max-height:360px;">
                                <ul id="tree_forward"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                    
            </div>
            

            
        </div>
    </div>
</div>
<style>
    .email_box_tree{display:none;}
    .email_box_tree.active{display:block;}
</style>
<script>
    var dataHash = [];
    function getInitHtml(){
        var initHtml = '<div class="logic_con">'+
            '<span>父条件间关系：</span>'+
            '<div class="radio inline">'+
                '<label>'+
                    '<input name="logic" type="radio" checked class="ace" value="all">'+
                    '<span class="lbl">满足所有条件</span>'+
                '</label>'+
            '</div>'+
            '<div class="radio inline">'+
                '<label>'+
                    '<input name="logic" type="radio" class="ace" value="one">'+
                    '<span class="lbl middle"> 满足一条即可</span>'+
                '</label>'+
            '</div>'+
            '<button type="button" class="btn btn-sm btn-success add_condition" style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>新增条件</button>'+
        '</div>'+
        '<div class="list_item">'+
            '<div id="faq-list-3" class="panel-group accordion-style1 accordion-style2 condition_box">'+
                '<div class="panel panel-default" id="id_option_0">'+
                    '<div class="panel-heading" style="position:relative;">'+
                        '<a href="#faq_0" data-toggle="collapse" class="accordion-toggle">'+
                            '<i class="smaller-80 ace-icon fa fa-chevron-down" data-icon-hide="ace-icon fa fa-chevron-down align-top" data-icon-show="ace-icon fa fa-chevron-right"></i>&nbsp;'+
                            '<b>条件</b>'+
                        '</a>'+
                    '</div>'+
                    '<div class="panel-collapse collapse in" id="faq_0">'+
                        '<div class="panel-body">'+
                            '<div >'+
                                '<span>子条件间关系：</span>'+
                                '<div class="radio inline">'+
                                    '<label>'+
                                        '<input name="logic_0" type="radio" checked class="ace con_logic" value="all">'+
                                        '<span class="lbl"> 满足所有</span>'+
                                    '</label>'+
                                '</div>'+
                                '<div class="radio inline">'+
                                    '<label>'+
                                        '<input name="logic_0" type="radio" class="ace con_logic" value="one">'+
                                        '<span class="lbl middle"> 满足任意</span>'+
                                    '</label>'+
                                '</div>'+
                                '<button type="button" class="btn btn-xs btn-info add_sub_condition" dataindex="0" dataparentindex="0" style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>新增子条件</button>'+
                            '</div>'+
                            '<ul>'+
                                '<li class="condition_item">'+
                                    '<div class="hr"></div>'+
                                    '<div class="row">'+
                                        '<div class="col-sm-2 control-label">'+
                                            '子条件：'+
                                        '</div>'+
                                        '<div class="col-sm-10">'+
                                            '<div class="row">'+
                                                '<div class="col-sm-2 no-padding">'+
                                                '<select class="form-control" name="suboption" style="height: 34px;">'+
                                                    '<option value="all_mail">所有邮件</option>'+
                                                    '<option value="has_attach">有附件</option>'+
                                                    '<option value="attachments">附件名</option>'+
                                                    '<option value="sender">发信人</option>'+
                                                    '<option value="cc">抄送人</option>'+
                                                    '<option value="recipient">收信人</option>'+
                                                    '<option value="sender_dept">发信人部门</option>'+
                                                    '<option value="cc_dept">抄送人部门</option>'+
                                                    '<option value="rcpt_dept">收信人部门</option>'+
                                                    '<option value="subject">主题</option>'+
                                                    '<option value="body">邮件内容</option>'+
                                                    '<option value="mail_size">邮件大小(MB)</option>'+
                                                    '<option value="mail_size2">邮件大小(Byte)</option>'+
                                                    '<option value="content_size">邮件正文大小(Byte)</option>'+
                                                    '<option value="exec_date">执行时间</option>'+
                                                '</select>'+
                                            '</div>'+
                                            '<div class="col-sm-10 no-padding">'+
                                                '<div class="col-sm-2 no-padding actions">'+
                                                    '<select class="form-control display-none"  name="action_contain" style="height: 34px;">'+
                                                        '<option value="contains">包含</option>'+
                                                        '<option value="not_contains">不包含</option>'+
                                                        '<option value="==">等于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control display-none" name="action_eq" style="height: 34px;">'+
                                                        '<option value=">=">大于等于</option>'+
                                                        '<option value="<=">小于等于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control display-none" name="action_belong" style="height: 34px;">'+
                                                        '<option value="in">属于</option>'+
                                                        '<option value="not_in">不属于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control display-none" name="action_date" style="height: 34px;">'+
                                                        '<option value="week">星期</option>'+
                                                        '<option value="date">天</option>'+
                                                    '</select>'+
                                                '</div>'+
                                                    '<div class="col-sm-8 no-padding values">'+
                                                        '<input type="text" name="rule_value_common" value="" class="display-none" maxlength="300" style="width: 100%;"/>'+
                                                        '<input type="number" name="rule_value_size" value="" class="display-none"  style="width: 100%;"/>'+
                                                        '<div id="id_rule_value_dpt0" class="col-xs-12 col-sm-12 no-padding  display-none dept_box">'+
                                                            '<div class="input-group">'+
                                                                '<div id="input_box0">'+
                                                                    '<input type="text" value="" readonly placeholder="点击选择部门" class="form-control department_choice">'+
                                                                    '<input type="hidden" class="id_dept_id" value="" name="option_value_dpt0">'+
                                                                '</div>'+
                                                            '</div>'+
                                                        '</div>'+
                                                        '<div class="col-xs-12 col-sm-12 no-padding  display-none date_box clear">'+
                                                            '<input type="datetime" class="datetime start_time"> --'+
                                                            '<input type="datetime" class="datetime end_time">'+
                                                        '</div>'+
                                                        '<div class="col-xs-12 col-sm-12 no-padding  display-none week_box clear">'+
                                                            '<div style="float:left;">'+
                                                                '<select name="day_start">'+
                                                                    '<option value="1" selected>星期一</option>'+
                                                                    '<option value="2">星期二</option>'+
                                                                    '<option value="3">星期三</option>'+
                                                                    '<option value="4">星期四</option>'+
                                                                    '<option value="5">星期五</option>'+
                                                                    '<option value="6">星期六</option>'+
                                                                    '<option value="7">星期日</option>'+
                                                                '</select> --'+
                                                                '<select name="day_end"  style="margin-right:20px;" >'+
                                                                    '<option value="1">星期一</option>'+
                                                                    '<option value="2">星期二</option>'+
                                                                    '<option value="3">星期三</option>'+
                                                                    '<option value="4">星期四</option>'+
                                                                    '<option value="5">星期五</option>'+
                                                                    '<option value="6">星期六</option>'+
                                                                    '<option value="7" selected>星期日</option>'+
                                                                '</select>'+
                                                            '</div>'+
                                                            '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                                '<input name="start" type="text" class="form-control" value="00:00:00" />'+
                                                                '<span class="input-group-addon">'+
                                                                    '<i class="fa fa-clock-o bigger-110"></i>'+
                                                                '</span>'+
                                                            '</div>'+
                                                            '<div style="float:left;line-height:34px;padding:0 4px;"> -- </div>'+
                                                            '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                                '<input name="end" type="text" class="form-control" value="23:59:59" />'+
                                                                '<span class="input-group-addon">'+
                                                                    '<i class="fa fa-clock-o bigger-110"></i>'+
                                                                '</span>'+
                                                            '</div>'+
                                                        '</div>'+
                                                        
                                                    '</div>'+
                                                '</div>'+

                                            '</div>'+
                                        '</div>'+

                                    '</div>'+

                                '</li>'+
                            '</ul>'+
                        '</div>'+
                        '</div>'+
                '</div>'+

            '</div>'+
        '</div>'
        return initHtml;
    }
    function initAddHtml(){
        $('#status_checkbox_forward').prop('checked',true)
        $('#forward_body').val('')
        $('.add_btn').attr('type_id',0)
        $('#forward_condition_box').html(getInitHtml);
        dateInit();
        add_condition_init()
        addsub();
    }
    $(function(){
        
        initAddHtml();
    })
    function init_tree_box(){
        var treehtml = '<div class="display-none">'+
                '<div id="input_box_forward" class="input-group">'+
                    '<input type="text" value="" readonly placeholder="点击选择部门" class="form-control department_choice">'+
                    '<input type="hidden" class="id_dept_id" value="" name="target_dept">'+
                    '<span class="input-group-addon clear_dept" style="cursor:pointer;background:#a0a0a0;color:#fff;">清空</span>'+
                '</div>'+
                '<div class="widget-box widget-color-blue2 email_box_tree" id="tree_box_forward" style="position:absolute;top:32px;z-index:10;min-width:60%;max-width:100%;left:0;">'+
                    '<button type="button" class="btn btn-danger btn-sm pull-right close_btn" style="">&times;</button>'+
                    '<div class="widget-body" style="padding-right:20px;">'+
                        '<div style="padding:20px  6px 0;">'+
                            '<input type="text" class="search_input form-control" placeholder="输入关键字搜索...">'+
                        '</div>'+
                        '<div class="widget-main padding-8" style="height:auto;max-height:360px;">'+
                            '<ul id="tree_forward"></ul>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</div>'
        $('.tree_div_box').html(treehtml);
        demoinitdept("#tree_forward","#tree_box_forward","#input_box_forward",deptArr);
    }
    function getInitEditHtml(rule_data){
        var logic_all = rule_data.logic == 'all'?true:false ;
        var logic_one = rule_data.logic == 'one'?true:false ;
        var action_value = rule_data.action[0].value.value;
        console.log(action_value)
        $('#forward_body').val(action_value);
        var disabled_status = rule_data.disabled =='-1'?true:false;
        $('#status_checkbox_forward').prop('checked',disabled_status)
        var initHtml = '<div class="logic_con">'+
            '<span>父条件间关系：</span>'+
            '<div class="radio inline">'+
                '<label>'+
                    '<input name="logic" type="radio" '
                    if(logic_all){
                        initHtml += 'checked'
                    }
                    initHtml += ' class="ace" value="all">'+
                    '<span class="lbl">满足所有条件</span>'+
                '</label>'+
            '</div>'+
            '<div class="radio inline">'+
                '<label>'+
                    '<input name="logic" type="radio" '
                    if(logic_one){
                        initHtml += 'checked'
                    }
                    initHtml += ' class="ace" value="one">'+
                    '<span class="lbl middle"> 满足一条即可</span>'+
                '</label>'+
            '</div>'+
            '<button type="button" class="btn btn-sm btn-success add_condition" style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>新增条件</button>'+
        '</div>'+
        '<div class="list_item">'+
            '<div id="faq-list-3" class="panel-group accordion-style1 accordion-style2 condition_box">'
            
            for(var i=0;i<rule_data.condition.length;i++){
                var logic_all_sub = rule_data.condition[i].logic == 'all'?true:false ;
                var logic_one_sub = rule_data.condition[i].logic == 'one'?true:false ;
                initHtml += '<div class="panel panel-default" id="id_option_'+i+'">'+
                    '<div class="panel-heading" style="position:relative;">'+
                        '<a href="#faq_'+i+'" data-toggle="collapse" class="accordion-toggle">'+
                            '<i class="smaller-80 ace-icon fa fa-chevron-down" data-icon-hide="ace-icon fa fa-chevron-down align-top" data-icon-show="ace-icon fa fa-chevron-right"></i>&nbsp;'+
                            '<b>条件</b>'
                            if(i>0){
                                initHtml += '<button type="button" class="delete_condition btn btn-sm btn-danger pull-right" data-id="id_option_'+i+'" style="position:absolute;top:-0;right:0;">删除条件</button>'
                            }
                        initHtml += '</a>'+
                    '</div>'+
                    '<div class="panel-collapse collapse in" id="faq_'+i+'">'+
                        '<div class="panel-body">'+
                            '<div >'+
                                '<span>子条件间关系：</span>'+
                                '<div class="radio inline">'+
                                    '<label>'+
                                        '<input name="logic_'+i+'" type="radio" '
                                        if(logic_all_sub){
                                            initHtml += ' checked'
                                        }
                                        initHtml += ' class="ace con_logic" value="all">'+
                                        '<span class="lbl"> 满足所有</span>'+
                                    '</label>'+
                                '</div>'+
                                '<div class="radio inline">'+
                                    '<label>'+
                                        '<input name="logic_'+i+'" type="radio"'
                                        if(logic_one_sub){
                                            initHtml += ' checked'
                                        }
                                        initHtml +=' class="ace con_logic" value="one">'+
                                        '<span class="lbl middle"> 满足任意</span>'+
                                    '</label>'+
                                '</div>'+
                                '<button type="button" class="btn btn-xs btn-info add_sub_condition" dataindex="0" dataparentindex="0" style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>新增子条件</button>'+
                            '</div>'+
                            '<ul>'+
                                '<li class="condition_item">'+
                                    '<div class="hr"></div>'+
                                    '<div class="row">'+
                                        '<div class="col-sm-2 control-label">'+
                                            '子条件：'+
                                        '</div>'+
                                        '<div class="col-sm-10">'+
                                            '<div class="row">'+
                                                '<div class="col-sm-2 no-padding">'+
                                                '<select class="form-control" name="suboption" style="height: 34px;">'+
                                                    '<option value="all_mail" ' 
                                                    var subo = rule_data.condition[i].suboption;
                                                    if(subo == "all_mail"){ initHtml += ' selected '}
                                                      initHtml +='>所有邮件</option>'+
                                                    '<option value="has_attach" '
                                                    if(subo == "has_attach"){ initHtml += ' selected '}
                                                      initHtml +='>有附件</option>'+
                                                    '<option value="attachments"'
                                                    if(subo == "attachments"){ initHtml += ' selected '}
                                                      initHtml +='>附件名</option>'+
                                                    '<option value="sender"'
                                                    if(subo == "sender"){ initHtml += ' selected '}
                                                      initHtml +='>发信人</option>'+
                                                    '<option value="cc"'
                                                    if(subo == "cc"){ initHtml += ' selected '}
                                                      initHtml +='>抄送人</option>'+
                                                    '<option value="recipient"'
                                                    if(subo == "recipient"){ initHtml += ' selected '}
                                                      initHtml +='>收信人</option>'+
                                                    '<option value="sender_dept"'
                                                    if(subo == "sender_dept"){ initHtml += ' selected '}
                                                      initHtml +='>发信人部门</option>'+
                                                    '<option value="cc_dept"'
                                                    if(subo == "cc_dept"){ initHtml += ' selected '}
                                                      initHtml +='>抄送人部门</option>'+
                                                    '<option value="rcpt_dept"'
                                                    if(subo == "rcpt_dept"){ initHtml += ' selected '}
                                                      initHtml +='>收信人部门</option>'+
                                                    '<option value="subject"'
                                                    if(subo == "subject"){ initHtml += ' selected '}
                                                      initHtml +='>主题</option>'+
                                                    '<option value="body"'
                                                    if(subo == "body"){ initHtml += ' selected '}
                                                      initHtml +='>邮件内容</option>'+
                                                    '<option value="mail_size"'
                                                    if(subo == "mail_size"){ initHtml += ' selected '}
                                                      initHtml +='>邮件大小(MB)</option>'+
                                                    '<option value="mail_size2"'
                                                    if(subo == "mail_size2"){ initHtml += ' selected '}
                                                      initHtml +='>邮件大小(Byte)</option>'+
                                                    '<option value="content_size"'
                                                    if(subo == "content_size"){ initHtml += ' selected '}
                                                      initHtml +='>邮件正文大小(Byte)</option>'+
                                                    '<option value="exec_date"'
                                                    if(subo == "exec_date"){ initHtml += ' selected '}
                                                      initHtml +='>执行时间</option>'+
                                                '</select>'+
                                            '</div>'+
                                            '<div class="col-sm-10 no-padding">'+
                                                '<div class="col-sm-2 no-padding actions">'+
                                                    '<select class="form-control '
                                                    var v = subo;
                                                    var action = rule_data.condition[i].action;
                                                    if(v=='attachments'|| v=='sender'||v=='cc'||v=='recipient'||v=='subject'||v=='body'){

                                                    }else{
                                                        initHtml += ' display-none'
                                                    }
                                                    initHtml += '"  name="action_contain" style="height: 34px;">'+
                                                        '<option value="contains" ' 
                                                        if(action == "contains"){initHtml += ' selected'}
                                                        initHtml += '>包含</option>'+
                                                        '<option value="not_contains" ' 
                                                        if(action == "not_contains"){initHtml += ' selected'}
                                                        initHtml += '>不包含</option>'+
                                                        '<option value="==" ' 
                                                        if(action == "=="){initHtml += ' selected'}
                                                        initHtml += '>等于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control '
                                                    if(v=='mail_size'||v=='mail_size2'||v=='content_size'){

                                                    }else{
                                                        initHtml += ' display-none'
                                                    }
                                                    initHtml += '" name="action_eq" style="height: 34px;">'+
                                                        '<option value=">=" ' 
                                                        if(action == ">="){initHtml += ' selected'}
                                                        initHtml += '>大于等于</option>'+
                                                        '<option value="<=" ' 
                                                        if(action == "<=>"){initHtml += ' selected'}
                                                        initHtml += '>小于等于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control  '
                                                    if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){

                                                    }else{
                                                        initHtml += ' display-none'
                                                    }
                                                    initHtml += '" name="action_belong" style="height: 34px;">'+
                                                        '<option value="in" ' 
                                                        if(action == "in"){initHtml += ' selected'}
                                                        initHtml += '>属于</option>'+
                                                        '<option value="not_in" ' 
                                                        if(action == "not_in"){initHtml += ' selected'}
                                                        initHtml += '>不属于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control '
                                                    if(v != 'exec_date'){
                                                        initHtml += 'display-none'
                                                    }
                                                    initHtml += '" name="action_date" style="height: 34px;">'+
                                                        '<option value="week" '
                                                        if(action == 'week'){
                                                            initHtml += 'selected'
                                                        }
                                                        initHtml += '>星期</option>'+
                                                        '<option value="date" '
                                                        if(action == 'date'){
                                                            initHtml += 'selected'
                                                        }
                                                        initHtml += '>天</option>'+
                                                    '</select>'+
                                                '</div>'+
                                                    '<div class="col-sm-8 no-padding values">'+
                                                        '<input type="text" name="rule_value_common" '
                                                        if(v=='attachments'|| v=='sender'||v=='cc'||v=='recipient'||v=='subject'||v=='body'){
                                                            initHtml += ' value="'+rule_data.condition[i].value+'"'
                                                        }else{
                                                            initHtml += ' class="display-none" ';
                                                        }
                                                        initHtml += '  maxlength="300" style="width: 100%;"/>'+
                                                        '<input type="number" name="rule_value_size"'
                                                        if(v=='mail_size'||v=='mail_size2'||v=='content_size'){
                                                            initHtml += ' value="'+rule_data.condition[i].value+'"'
                                                        }else{
                                                            initHtml += ' class="display-none" ';
                                                        }
                                                        initHtml += '   style="width: 100%;"/>'+
                                                        '<div id="id_rule_value_dpt0" class="col-xs-12 col-sm-12 no-padding dept_box '
                                                        if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){
                                                            
                                                        }else{
                                                            initHtml += ' display-none" ';
                                                        }
                                                        initHtml += ' ">'+
                                                            '<div class="input-group">'+
                                                                '<div id="input_box0">'+
                                                                    '<input type="text" value="'
                                                                    if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){
                                                                        initHtml += hashdept['dept_'+rule_data.condition[i].value]
                                                                    }
                                                                    initHtml += '" readonly placeholder="点击选择部门" class="form-control department_choice">'+
                                                                    '<input type="hidden" class="id_dept_id" '
                                                                    if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){
                                                                        initHtml += ' value="'+rule_data.condition[i].value+'"'
                                                                    }
                                                                    initHtml += ' name="option_value_dpt0">'+
                                                                '</div>'+
                                                            '</div>'+
                                                        '</div>'+

                                                        '<div class="col-xs-12 col-sm-12 no-padding '
                                                        if(v=='exec_date' && action == 'date'){

                                                        }else{
                                                            initHtml += 'display-none'
                                                        }
                                                        initHtml += ' date_box clear">'+
                                                            '<input type="datetime" class="datetime start_time" '
                                                            var vv = rule_data.condition[i].value;
                                                            if(vv.start){
                                                                initHtml += 'value="'+vv.start+'"'
                                                            }
                                                            initHtml += '> --'+
                                                            '<input type="datetime" class="datetime end_time" '
                                                            if(vv.end){
                                                                initHtml += 'value="'+vv.end+'"'
                                                            }
                                                            initHtml += '>'+
                                                        '</div>'+
                                                        '<div class="col-xs-12 col-sm-12 no-padding '  
                                                        if(v=='exec_date' && action == 'week'){

                                                        }else{
                                                            initHtml += 'display-none'
                                                        }
                                                        initHtml += ' week_box clear">'+
                                                            '<div style="float:left;">'+
                                                                '<select name="day_start">'+
                                                                    '<option value="1" '
                                                                    
                                                                    if(vv.day_start && vv.day_start == '1'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期一</option>'+
                                                                    '<option value="2" '
                                                                    if(vv.day_start && vv.day_start == '2'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期二</option>'+
                                                                    '<option value="3" '
                                                                    if(vv.day_start && vv.day_start == '3'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期三</option>'+
                                                                    '<option value="4" '
                                                                    if(vv.day_start && vv.day_start == '4'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期四</option>'+
                                                                    '<option value="5" '
                                                                    if(vv.day_start && vv.day_start == '5'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期五</option>'+
                                                                    '<option value="6" '
                                                                    if(vv.day_start && vv.day_start == '5'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期六</option>'+
                                                                    '<option value="7" '
                                                                    if(vv.day_start && vv.day_start == '7'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期日</option>'+
                                                                '</select> --'+
                                                                '<select name="day_end"  style="margin-right:20px;" >'+
                                                                    '<option value="1" '
                                                                    if(vv.day_end && vv.day_end == '1'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期一</option>'+
                                                                    '<option value="2" '
                                                                    if(vv.day_end && vv.day_end == '2'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期二</option>'+
                                                                    '<option value="3" '
                                                                    if(vv.day_end && vv.day_end == '3'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期三</option>'+
                                                                    '<option value="4" '
                                                                    if(vv.day_end && vv.day_end == '4'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期四</option>'+
                                                                    '<option value="5" '
                                                                    if(vv.day_end && vv.day_end == '5'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期五</option>'+
                                                                    '<option value="6" '
                                                                    if(vv.day_end && vv.day_end == '5'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期六</option>'+
                                                                    '<option value="7" '
                                                                    if(vv.day_end && vv.day_end == '7'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期日</option>'+
                                                                '</select>'+
                                                            '</div>'+
                                                            '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                                '<input name="start" type="text" class="form-control" value="'
                                                                if(vv.start){
                                                                    initHtml += vv.start
                                                                }
                                                                initHtml += '" />'+
                                                                '<span class="input-group-addon">'+
                                                                    '<i class="fa fa-clock-o bigger-110"></i>'+
                                                                '</span>'+
                                                            '</div>'+
                                                            '<div style="float:left;line-height:34px;padding:0 4px;"> -- </div>'+
                                                            '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                                '<input name="end" type="text" class="form-control" value="'
                                                                if(vv.end){
                                                                    initHtml += vv.end
                                                                }
                                                                initHtml += '" />'+
                                                                '<span class="input-group-addon">'+
                                                                    '<i class="fa fa-clock-o bigger-110"></i>'+
                                                                '</span>'+
                                                            '</div>'+
                                                        '</div>'+


                                                    '</div>'+
                                                '</div>'+

                                            '</div>'+
                                        '</div>'+

                                    '</div>'+

                                '</li>'

                                for(var j=0;j<rule_data.condition[i].subs.length;j++){
                                    initHtml += '<li class="condition_item">'+
                                    '<div class="hr"></div>'+
                                    '<div class="row">'+
                                        '<div class="col-sm-2 control-label">'+
                                            '子条件：'+
                                        '</div>'+
                                        '<div class="col-sm-10">'+
                                            '<div class="row">'+
                                                '<div class="col-sm-2 no-padding">'+
                                                '<select class="form-control" name="suboption" style="height: 34px;">'+
                                                    '<option value="all_mail"' 
                                                    var subo_sub = rule_data.condition[i].subs[j].suboption;
                                                    if(subo_sub == "all_mail"){ initHtml += ' selected '}
                                                      initHtml +='>所有邮件</option>'+
                                                    '<option value="has_attach"'
                                                    if(subo_sub == "has_attach"){ initHtml += ' selected '}
                                                      initHtml +='>有附件</option>'+
                                                    '<option value="attachments"'
                                                    if(subo_sub == "attachments"){ initHtml += ' selected '}
                                                      initHtml +='>附件名</option>'+
                                                    '<option value="sender"'
                                                    if(subo_sub == "sender"){ initHtml += ' selected '}
                                                      initHtml +='>发信人</option>'+
                                                    '<option value="cc"'
                                                    if(subo_sub == "cc"){ initHtml += ' selected '}
                                                      initHtml +='>抄送人</option>'+
                                                    '<option value="recipient"'
                                                    if(subo_sub == "recipient"){ initHtml += ' selected '}
                                                      initHtml +='>收信人</option>'+
                                                    '<option value="sender_dept"'
                                                    if(subo_sub == "sender_dept"){ initHtml += ' selected '}
                                                      initHtml +='>发信人部门</option>'+
                                                    '<option value="cc_dept"'
                                                    if(subo_sub == "cc_dept"){ initHtml += ' selected '}
                                                      initHtml +='>抄送人部门</option>'+
                                                    '<option value="rcpt_dept"'
                                                    if(subo_sub == "rcpt_dept"){ initHtml += ' selected '}
                                                      initHtml +='>收信人部门</option>'+
                                                    '<option value="subject"'
                                                    if(subo_sub == "subject"){ initHtml += ' selected '}
                                                      initHtml +='>主题</option>'+
                                                    '<option value="body"'
                                                    if(subo_sub == "body"){ initHtml += ' selected '}
                                                      initHtml +='>邮件内容</option>'+
                                                    '<option value="mail_size"'
                                                    if(subo_sub == "mail_size"){ initHtml += ' selected '}
                                                      initHtml +='>邮件大小(MB)</option>'+
                                                    '<option value="mail_size2"'
                                                    if(subo_sub == "mail_size2"){ initHtml += ' selected '}
                                                      initHtml +='>邮件大小(Byte)</option>'+
                                                    '<option value="content_size"'
                                                    if(subo_sub == "content_size"){ initHtml += ' selected '}
                                                      initHtml +='>邮件正文大小(Byte)</option>'+
                                                    '<option value="exec_date"'
                                                    if(subo_sub == "exec_date"){ initHtml += ' selected '}
                                                      initHtml +='>执行时间</option>'+
                                                '</select>'+
                                            '</div>'+
                                            '<div class="col-sm-10 no-padding">'+
                                                '<div class="col-sm-2 no-padding actions">'+
                                                        '<select class="form-control '
                                                    var v = subo_sub;
                                                    var action = rule_data.condition[i].subs[j].action;
                                                    if(v=='attachments'|| v=='sender'||v=='cc'||v=='recipient'||v=='subject'||v=='body'){

                                                    }else{
                                                        initHtml += ' display-none'
                                                    }
                                                    initHtml += '"  name="action_contain" style="height: 34px;">'+
                                                        '<option value="contains" ' 
                                                        if(action == "contains"){initHtml += ' selected'}
                                                        initHtml += '>包含</option>'+
                                                        '<option value="not_contains" ' 
                                                        if(action == "not_contains"){initHtml += ' selected'}
                                                        initHtml += '>不包含</option>'+
                                                        '<option value="==" ' 
                                                        if(action == "=="){initHtml += ' selected'}
                                                        initHtml += '>等于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control '
                                                    if(v=='mail_size'||v=='mail_size2'||v=='content_size'){

                                                    }else{
                                                        initHtml += ' display-none'
                                                    }
                                                    initHtml += '" name="action_eq" style="height: 34px;">'+
                                                        '<option value=">=" ' 
                                                        if(action == ">="){initHtml += ' selected'}
                                                        initHtml += '>大于等于</option>'+
                                                        '<option value="<=" ' 
                                                        if(action == "<=>"){initHtml += ' selected'}
                                                        initHtml += '>小于等于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control  '
                                                    if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){

                                                    }else{
                                                        initHtml += ' display-none'
                                                    }
                                                    initHtml += '" name="action_belong" style="height: 34px;">'+
                                                        '<option value="in" ' 
                                                        if(action == "in"){initHtml += ' selected'}
                                                        initHtml += '>属于</option>'+
                                                        '<option value="not_in" ' 
                                                        if(action == "not_in"){initHtml += ' selected'}
                                                        initHtml += '>不属于</option>'+
                                                    '</select>'+
                                                    '<select class="form-control '
                                                    if(v != 'exec_date'){
                                                        initHtml += 'display-none'
                                                    }
                                                    initHtml += '" name="action_date" style="height: 34px;">'+
                                                        '<option value="week" '
                                                        if(action == 'week'){
                                                            initHtml += 'selected'
                                                        }
                                                        initHtml += '>星期</option>'+
                                                        '<option value="date" '
                                                        if(action == 'date'){
                                                            initHtml += 'selected'
                                                        }
                                                        initHtml += '>天</option>'+
                                                    '</select>'+
                                                '</div>'+
                                                    '<div class="col-sm-8 no-padding values">'+
                                                            '<input type="text" name="rule_value_common" '
                                                        if(v=='attachments'|| v=='sender'||v=='cc'||v=='recipient'||v=='subject'||v=='body'){
                                                            initHtml += ' value="'+rule_data.condition[i].subs[j].value+'"'
                                                        }else{
                                                            initHtml += ' class="display-none" ';
                                                        }
                                                        initHtml += '  maxlength="300" style="width: 100%;"/>'+
                                                        '<input type="number" name="rule_value_size"'
                                                        if(v=='mail_size'||v=='mail_size2'||v=='content_size'){
                                                            initHtml += ' value="'+rule_data.condition[i].subs[j].value+'"'
                                                        }else{
                                                            initHtml += ' class="display-none" ';
                                                        }
                                                        initHtml += '   style="width: 100%;"/>'+
                                                        '<div id="id_rule_value_dpt0" class="col-xs-12 col-sm-12 no-padding dept_box '
                                                        if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){
                                                            
                                                        }else{
                                                            initHtml += ' display-none" ';
                                                        }
                                                        initHtml += ' ">'+
                                                            '<div class="input-group">'+
                                                                '<div id="input_box0">'+
                                                                    '<input type="text" value="'
                                                                    if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){
                                                                        initHtml += hashdept['dept_'+rule_data.condition[i].subs[j].value]
                                                                    }
                                                                    initHtml += '" readonly placeholder="点击选择部门" class="form-control department_choice">'+
                                                                    '<input type="hidden" class="id_dept_id" '
                                                                    if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){
                                                                        initHtml += ' value="'+rule_data.condition[i].subs[j].value+'"'
                                                                    }
                                                                    initHtml += ' name="option_value_dpt0">'+
                                                                '</div>'+
                                                            '</div>'+
                                                        '</div>'+

                                                        '<div class="col-xs-12 col-sm-12 no-padding '
                                                        if(v=='exec_date' && action == 'date'){

                                                        }else{
                                                            initHtml += 'display-none'
                                                        }
                                                        initHtml += ' date_box clear">'+
                                                            '<input type="datetime" class="datetime start_time" value="'
                                                            var vv = rule_data.condition[i].subs[j].value;
                                                            if(vv.start){
                                                                initHtml += vv.start
                                                            }
                                                            initHtml += '"> --'+
                                                            '<input type="datetime" class="datetime end_time" value="'
                                                            if(vv.end){
                                                                initHtml += vv.end
                                                            }
                                                            initHtml += '">'+
                                                        '</div>'+
                                                        '<div class="col-xs-12 col-sm-12 no-padding '  
                                                        if(v=='exec_date' && action == 'week'){

                                                        }else{
                                                            initHtml += 'display-none'
                                                        }
                                                        initHtml += ' week_box clear">'+
                                                            '<div style="float:left;">'+
                                                                '<select name="day_start">'+
                                                                    '<option value="1" '
                                                                    
                                                                    if(vv.day_start && vv.day_start == '1'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期一</option>'+
                                                                    '<option value="2" '
                                                                    if(vv.day_start && vv.day_start == '2'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期二</option>'+
                                                                    '<option value="3" '
                                                                    if(vv.day_start && vv.day_start == '3'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期三</option>'+
                                                                    '<option value="4" '
                                                                    if(vv.day_start && vv.day_start == '4'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期四</option>'+
                                                                    '<option value="5" '
                                                                    if(vv.day_start && vv.day_start == '5'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期五</option>'+
                                                                    '<option value="6" '
                                                                    if(vv.day_start && vv.day_start == '5'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期六</option>'+
                                                                    '<option value="7" '
                                                                    if(vv.day_start && vv.day_start == '7'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期日</option>'+
                                                                '</select> --'+
                                                                '<select name="day_end"  style="margin-right:20px;" >'+
                                                                    '<option value="1" '
                                                                    if(vv.day_end && vv.day_end == '1'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期一</option>'+
                                                                    '<option value="2" '
                                                                    if(vv.day_end && vv.day_end == '2'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期二</option>'+
                                                                    '<option value="3" '
                                                                    if(vv.day_end && vv.day_end == '3'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期三</option>'+
                                                                    '<option value="4" '
                                                                    if(vv.day_end && vv.day_end == '4'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期四</option>'+
                                                                    '<option value="5" '
                                                                    if(vv.day_end && vv.day_end == '5'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期五</option>'+
                                                                    '<option value="6" '
                                                                    if(vv.day_end && vv.day_end == '5'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期六</option>'+
                                                                    '<option value="7" '
                                                                    if(vv.day_end && vv.day_end == '7'){
                                                                        initHtml += 'selected'
                                                                    }
                                                                    initHtml += '>星期日</option>'+
                                                                '</select>'+
                                                            '</div>'+
                                                            '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                                '<input name="start" type="text" class="form-control" value="'
                                                                if(vv.start){
                                                                    initHtml += vv.start
                                                                }
                                                                initHtml += '" />'+
                                                                '<span class="input-group-addon">'+
                                                                    '<i class="fa fa-clock-o bigger-110"></i>'+
                                                                '</span>'+
                                                            '</div>'+
                                                            '<div style="float:left;line-height:34px;padding:0 4px;"> -- </div>'+
                                                            '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                                '<input name="end" type="text" class="form-control" value="'
                                                                if(vv.end){
                                                                    initHtml += vv.end
                                                                }
                                                                initHtml += '" />'+
                                                                '<span class="input-group-addon">'+
                                                                    '<i class="fa fa-clock-o bigger-110"></i>'+
                                                                '</span>'+
                                                            '</div>'+
                                                        '</div>'+




                                                    '</div>'+
                                                    '<div class="col-sm-1"><button type="button" class="delete_sub_condition btn btn-xs btn-warning" title="删除此子条件"><i class="glyphicon glyphicon-trash"></i></button></div>'+
                                                '</div>'+

                                            '</div>'+
                                        '</div>'+

                                    '</div>'+

                                '</li>'
                                }

                initHtml += '</ul>'+
                        '</div>'+
                        '</div>'+
                '</div>'
            }

        initHtml +='</div>'+
        '</div>'
        $('#forward_condition_box').html(initHtml);
        $('.add_btn').attr('type_id',rule_data.id)
        dateInit();
        addsub();
    }
    
    function dateInit(){
        $('[name="start"]').timepicker({
            minuteStep: 1,
            showSeconds: true,
            showMeridian: false,
            disableFocus: true
        }).on('focus', function() {
            $(this).timepicker('showWidget');
        }).next().on(ace.click_event, function(){
            $(this).prev().focus();
        });
        $('[name="end"]').timepicker({
            minuteStep: 1,
            showSeconds: true,
            showMeridian: false,
            disableFocus: true
        }).on('focus', function() {
            $(this).timepicker('showWidget');
        }).next().on(ace.click_event, function(){
            $(this).prev().focus();
        });
        $('.datetime').datetimepicker({
            format: 'yyyy-mm-dd hh:ii:00',
            language: 'zh-CN',
            weekStart: 1,
            todayBtn: 1,
            autoclose: 1,
            // minView: 2,
            pickerPosition: "bottom-right",
        });
    }
    

    function demoinitdept(treeid,treeparentid,inputparentid,deptArr){
        var treeEle;
        $(treeid).removeData("fu.tree");
        $(treeid).unbind('click.fu.tree');
        function initdepttree(deptArr){
            var sampleData = initiateDemoData(deptArr);
            treeEle = $(treeid).ace_tree({
                dataSource: sampleData['dataSource1'],
                multiSelect: false,
                loadingHTML: '<div class="tree-loading"><i class="ace-icon fa fa-refresh fa-spin blue"></i></div>',
                'open-icon' : 'ace-icon tree-minus hide',
                'close-icon' : 'ace-icon tree-plus hide',
                'selectable' : true,
                'selected-icon' : 'ace-icon fa fa-check',
                'unselected-icon' : 'ace-icon fa fa-times',
                'cacheItems': true,
                'folderSelect': true,
                'folder-open-icon' : 'ace-icon tree-plus',
                'folder-close-icon' : 'ace-icon tree-minus'
            });

            $(treeid).tree('discloseAll');
            $(treeid).tree('closeAll');

            //默认选中节点
            function test(ele){
                if(ele.parent().parent().hasClass('tree-branch')){
                    ele.parent().parent().find('>i').click();
                    test(ele.parent().parent())
                }
            }

            $(treeid).find('.tree-branch,.tree-item').each(function(i,dom){
                //        if($(this).data().id == ccid){
                //            $(this).addClass('active-header');
                //            $(this).find('>i').click()
                //            test($(this));
                //        }
            })
        }
        initdepttree(deptArr);
        $(treeparentid+' .search_input').keyup(function(){
            var keywords = $(this).val();
            $(treeid).removeData("fu.tree");
            $(treeid).unbind('click.fu.tree');
            if(keywords.length>0){
                var initArr = deptArr;
                var reg = new RegExp(keywords, 'i');
                var arr = [];
                var textname = '';
                function getp(id){
                    for(var i=0;i<initArr.length;i++){
                        var a = initArr[i]['id'];
                        var pp = initArr[i]['parent'];
                        var n = initArr[i]['name'];
                        if(a == id){
                            textname += " -- " + n;
                            if(pp>0){
                                getp(pp);
                            }
                        }
                    }
                }
                for(var key in initArr){
                    if(initArr[key]['name'].match(reg)){
                        if(initArr[key]['parent']>0){
                            textname += initArr[key]['name'];
                            getp(initArr[key]['parent']);
                            var obj = {child:0,parent:0,name:textname,id:initArr[key]['id']};
                            textname = '';
                        }else{
                            var obj = {child:0,parent:0,name:initArr[key]['name'],id:initArr[key]['id']};
                        }
                        arr.push(obj);
                    }
                }
                initdepttree(arr)
            }else{
                initdepttree(deptArr);
            }
        })

        function initiateDemoData(deptArr){
            var tree_data = {};
            for(var i=0;i<deptArr.length;i++){
                if(deptArr[i].parent<=0){
                    if(deptArr[i].child&&deptArr[i].child>0){
                        tree_data[deptArr[i].name] = {text:deptArr[i].name,type:"folder",id:deptArr[i].id};
                        tree_data[deptArr[i].name]['additionalParameters']={"children":getSubDate(deptArr[i].id)};
                    }else{
                        tree_data[deptArr[i].name] = {text:deptArr[i].name,type:"item",id:deptArr[i].id};
                    }
                }
            }

            function getSubDate(pid){
                var obj = {};
                for(var i=0;i<deptArr.length;i++){
                    if(deptArr[i]['parent'] == pid){
                        if(deptArr[i].child&&deptArr[i].child>0){
                            obj[deptArr[i].name] = {text:deptArr[i].name,type:"folder",id:deptArr[i].id,child:deptArr[i].child}
                        }else{
                            obj[deptArr[i].name] = {text:deptArr[i].name,type:"item",id:deptArr[i].id,child:deptArr[i].child}
                        }

                    }
                }
                return obj;
            }
            function getAdditionalParameters(arr){
                for(var key in arr){
                    if(arr[key]['type']=="folder"){
                        arr[key]['additionalParameters']={"children":getSubDate(arr[key]['id'])};
                        if(arr[key]['additionalParameters']["children"]){
                            getAdditionalParameters(arr[key]['additionalParameters']["children"])
                        }
                    }
                }
            }
            getAdditionalParameters(tree_data);
            var dataSource1 = function(options, callback){
                var $data = null
                if(!("text" in options) && !("type" in options)){
                    $data = tree_data;//the root tree
                    callback({ data: $data });
                    return;
                }
                else if("type" in options && options.type == "folder") {
                    if("additionalParameters" in options && "children" in options.additionalParameters)
                        $data = options.additionalParameters.children || {};
                    else $data = {}//no data
                }
                if($data != null)//this setTimeout is only for mimicking some random delay
                    callback({ data: $data });
            }
            return {'dataSource1': dataSource1}
        }

        $(treeid).on('click','.tree-item,.tree-branch-header',function(){
            $(treeid+' .tree-selected').removeClass('tree-selected');
            if($(this).hasClass('tree-branch-header')){
                $(this).parent().addClass('tree-selected');
            }else{
                $(this).addClass('tree-selected');
            }
            $(treeparentid).removeClass('active');
            var o = treeEle.tree('selectedItems')[0];
            $(treeparentid).parent().find('.department_choice').val(o.text);
            $(treeparentid).parent().find('.id_dept_id').val(o.id);
        })
        var showb = false;
        $('body').click(function(e){
            var $parents = $(e.target).parents(treeparentid);
            if(!$(e.target).hasClass('department_choice') && $parents.length<1){
                $(treeparentid).removeClass('active');
            }
        })
        $(inputparentid + ' .clear_dept').click(function(){
            $(inputparentid + ' .department_choice').val('');
            $(inputparentid + ' .id_dept_id').val('');
        })
    }
    // deptArr 为初始化获得的部门数据
    var deptArr = [
        // {id:1,parent:0,name:"部门1",child:2},
        // {id:2,parent:1,name:"部门2",child:1},
        // {id:3,parent:2,name:"部门3",child:0},
        // {id:4,parent:1,name:"部门4",child:0},
        // {id:5,parent:2,name:"部门5",child:0},
        // {id:6,parent:0,name:"部门6",child:0}
    ];
    demoinitdept("#tree_forward","#tree_box_forward","#input_box_forward",deptArr);
    var hashdept = [];
    function initdept(){
        $.ajax({
            url:"{% url 'choose_mailbox_list' %}",
            type:"POST",
            data:{action:"dept_list"},
            success:function(data){
                console.log(data);
                deptArr = data.dept;
                hashdept = []
                for(var i=0;i<deptArr.length;i++){
                    hashdept['dept_'+deptArr[i].id] = deptArr[i].name;
                }
            }
        })
    }
    function inittree_new(){
        $.ajax({
            url:"{% url 'choose_mailbox_list' %}",
            type:"POST",
            data:{action:"dept_list"},
            success:function(data){
                deptArr = data.dept;
                demoinitdept("#tree_forward","#tree_box_forward","#input_box_forward",deptArr);
            }
        })
    }
    inittree_new();

    $('.box_show_btn').click(function(){
        $('.add_btn').attr('type_id',0)
        initAddHtml();
        $(this).parent().parent().addClass('display-none').siblings().removeClass('display-none')
    })
    $('.hide_box_btn').click(function(){
        $(this).parents('.forward_box').addClass('display-none').siblings().removeClass('display-none')
    })
    
    function getList(){
        initdept();
        $.ajax({
            url:" {% url 'user_cfilter_list' %}",
            type:'GET',
            data:{
                mailbox_id:"{{ mailbox_id }}",
                extype:'fw'
            },
            success:function(data){
                var data = data.data;
                console.log(data);
                dataHash = [];
                for(var i=0,html='';i<data.length;i++){
                    var logicstr = '',statusstr = '',constr = '';
                    logicstr = data[i].logic=='all'?'满足所有':'满足任一';
                    statusstr = data[i].disabled==1?'禁用':'启用';
                    dataHash['rule_'+data[i].id] = data[i]
                    for(var k=0;k<data[i].condition.length;k++){
                        var c = data[i].condition[k];
                        var optionstr = c.suboption=="all_mail"?'所有邮件':c.suboption=="has_attach"?'有附件':c.suboption=="attachments"?'附件名':c.suboption=="sender"?'发信人':c.suboption=="cc"?'抄送人':c.suboption=="recipient"?'收信人':c.suboption=="sender_dept"?'发信人部门':c.suboption=="cc_dept"?'抄送人部门':c.suboption=="rcpt_dept"?'收信人部门':c.suboption=="subject"?'主题':c.suboption=="body"?'邮件内容':c.suboption=="mail_size"?'邮件大小(MB)':c.suboption=="mail_size2"?'邮件大小(Byte)':c.suboption=="exec_date"?'执行时间':'邮件正文大小(Byte)'
                        var actionstr = c.action=='contains'?'包含':c.action=='not_contains'?'不包含':c.action=='=='?'等于':c.action=='>='?'大于等于':c.action=='<='?'小于等于':c.action=='in'?'属于':c.action=='not_in'?'不属于':c.action=='week'?'':c.action=='date'?'':''
                        if(k>0){constr += '<br/>'}
                        constr += '<span>'+(k+1)+'、</span><span>【'+ optionstr + '】</span><span>'+actionstr+'</span>'
                        if(c.action!='date'&&c.action!='week'&&(c.value2||c.value)){
                            var vv = c.value2||c.value
                            if(c.suboption=="sender_dept" || c.suboption=="cc_dept" || c.suboption=="rcpt_dept"){
                                vv = hashdept['dept_'+vv]
                            }
                            constr += '<span> “ '+ vv +' ” </span> '
                        }
                        if(c.action=="date"){
                            var vv = c.value
                            constr += '<span> '+ vv.start +' 到 '+ vv.end +'  </span> '
                        }
                        if(c.action=="week"){
                            var vv = c.value2||c.value
                            var start_str = vv.day_start=='1'?'星期一':vv.day_start=='2'?'星期二':vv.day_start=='3'?'星期三':vv.day_start=='4'?'星期四':vv.day_start=='5'?'星期五':vv.day_start=='6'?'星期六':'星期日'
                            var end_str = vv.day_end=='1'?'星期一':vv.day_end=='2'?'星期二':vv.day_end=='3'?'星期三':vv.day_end=='4'?'星期四':vv.day_end=='5'?'星期五':vv.day_end=='6'?'星期六':'星期日'
                            constr += '<span> '+ start_str + ' ' + vv.start +' 到 '+ end_str + ' '+ vv.end + '  </span> ' 
                        }
                        for(var j=0;j<c.subs.length;j++){
                            var logiccc = c.logic=='all'?'并':'或';
                            var cc = c.subs[j];
                            var suboptionstr = cc.suboption=="all_mail"?'所有邮件':cc.suboption=="has_attach"?'有附件':cc.suboption=="attachments"?'附件名':cc.suboption=="sender"?'发信人':cc.suboption=="cc"?'抄送人':cc.suboption=="recipient"?'收信人':cc.suboption=="sender_dept"?'发信人部门':cc.suboption=="cc_dept"?'抄送人部门':cc.suboption=="rcpt_dept"?'收信人部门':cc.suboption=="subject"?'主题':cc.suboption=="body"?'邮件内容':cc.suboption=="mail_size"?'邮件大小(MB)':cc.suboption=="mail_size2"?'邮件大小(Byte)':cc.suboption=="exec_date"?'执行时间':'邮件正文大小(Byte)'
                            var subactionstr = cc.action=='contains'?'包含':cc.action=='not_contains'?'不包含':cc.action=='=='?'等于':cc.action=='>='?'大于等于':cc.action=='<='?'小于等于':cc.action=='in'?'属于':cc.action=='not_in'?'不属于':cc.action=='week'?'':cc.action=='date'?'':''
                            constr += '<button type="button" class="btn btn-xs btn-success">'+logiccc+'</button><span>【'+suboptionstr+'】</span><span>'+subactionstr+'</span>'

                            if(cc.action!='date'&&cc.action!='week'&&(cc.value2||cc.value)){
                                var subvv = cc.value2||cc.value
                                if(cc.suboption=="sender_dept" || cc.suboption=="cc_dept" || cc.suboption=="rcpt_dept"){
                                    subvv = hashdept['dept_'+subvv]
                                }
                                constr += '<span> “ '+ subvv +' ” </span>'
                            }
                            if(cc.action=="date"){
                                var subvv = cc.value2||cc.value
                                constr += '<span> '+ subvv.start +' 到 '+ subvv.end +'  </span> '
                            }
                            if(cc.action=="week"){
                                var subvv = cc.value2||cc.value
                                var start_str = subvv.day_start=='1'?'星期一':subvv.day_start=='2'?'星期二':subvv.day_start=='3'?'星期三':subvv.day_start=='4'?'星期四':subvv.day_start=='5'?'星期五':subvv.day_start=='6'?'星期六':'星期日'
                                var end_str = subvv.day_end=='1'?'星期一':subvv.day_end=='2'?'星期二':subvv.day_end=='3'?'星期三':subvv.day_end=='4'?'星期四':subvv.day_end=='5'?'星期五':subvv.day_end=='6'?'星期六':'星期日'
                                constr += '<span> '+ start_str +' '+ subvv.start +' 到 '+ end_str  + ' '+ subvv.end + '  </span> ' 
                            }
                        }
                    }
                    html+='<tr><td>'+(i+1)+'</td><td>'+logicstr+'</td><td>'+constr+'</td><td>'+statusstr+'</td><td>'+
                    '<button type="button" class="btn btn-xs btn-primary edit_con_btn" data_id="'+data[i].id+'" style="margin-right:10px;">修改</button>'+
                    '<button type="button" class="btn btn-xs btn-danger delete_con_btn" data_id="'+data[i].id+'">删除</button>'+
                    '</td></tr>'
                }
                $('#forward_tbody').html(html)

                $('.edit_con_btn').click(function(){
                    getInitEditHtml(dataHash['rule_'+$(this).attr('data_id')]);
                    $('.forward_list').addClass('display-none').siblings().removeClass('display-none')
                    add_condition_init();
                })
                
            }
        })
    }
    getList();

    //新增规则 更新规则
    $('.add_btn').click(function(){
        var rule_id = $(this).attr('type_id');
        if(!$('#forward_body').val() || $('#forward_body').val() == ''){
            layer.msg('请填写回复内容~')
            return;
        }
        var arr = [];
        for(var i=0;i<$('.forward_box .list_item .panel.panel-default').length;i++){
            var $list_item = $('.forward_box .list_item .panel.panel-default:eq('+i+')');

            for(var j=0;j<$list_item.find('.condition_item').length;j++){
                for(var g=0;g<$list_item.find('.condition_item:eq('+j+') .values>input').length;g++){
                    if($list_item.find('.condition_item:eq('+j+') .values>input:eq('+g+')') && !$list_item.find('.condition_item:eq('+j+') .values>input:eq('+g+')').hasClass('display-none')){
                        if(!$list_item.find('.condition_item:eq('+j+') .values>input:eq('+g+')').val() || $list_item.find('.condition_item:eq('+j+') .values>input:eq('+g+')').val()==''){
                            layer.msg('请填写条件内容~')
                            return;
                        }
                    }
                }
                if($list_item.find('.condition_item:eq('+j+') .values>.dept_box') && !$list_item.find('.condition_item:eq('+j+') .values>.dept_box').hasClass('display-none')){
                    if(!$list_item.find('.condition_item:eq('+j+') .values>.dept_box .id_dept_id').val() || $list_item.find('.condition_item:eq('+j+') .values>.dept_box .id_dept_id').val()==''){
                        layer.msg('请选择部门~')
                        return;
                    }
                }
                if($list_item.find('.condition_item:eq('+j+') .values>.week_box') && !$list_item.find('.condition_item:eq('+j+') .values>.week_box').hasClass('display-none')){
                    if(!$list_item.find('.condition_item:eq('+j+') .values>.week_box [name="start"]').val() || $list_item.find('.condition_item:eq('+j+') .values>.week_box [name="start"]').val()==''){
                        layer.msg('请选择执行开始时间~')
                        return;
                    }
                    if(!$list_item.find('.condition_item:eq('+j+') .values>.week_box [name="end"]').val() || $list_item.find('.condition_item:eq('+j+') .values>.week_box [name="end"]').val()==''){
                        layer.msg('请选择执行截止时间~')
                        return;
                    }
                    if($list_item.find('.condition_item:eq('+j+') .values>.week_box [name="day_start"]').val() > $list_item.find('.condition_item:eq('+j+') .values>.week_box [name="day_end"]').val() ){
                        layer.msg('开始星期不能大于结束星期~')
                        return;
                    }
                    if($list_item.find('.condition_item:eq('+j+') .values>.week_box [name="day_start"]').val() == $list_item.find('.condition_item:eq('+j+') .values>.week_box [name="day_end"]').val() ){
                        if($list_item.find('.condition_item:eq('+j+') .values>.week_box [name="start"]').val() >= $list_item.find('.condition_item:eq('+j+') .values>.week_box [name="end"]').val() ){
                            layer.msg('开始时间不能大于等于结束时间~')
                            return;
                        }
                        
                    }
                }
                if($list_item.find('.condition_item:eq('+j+') .values>.date_box') && !$list_item.find('.condition_item:eq('+j+') .values>.date_box').hasClass('display-none')){
                    if(!$list_item.find('.condition_item:eq('+j+') .values>.date_box .start_time').val() || $list_item.find('.condition_item:eq('+j+') .values>.date_box .start_time').val()==''){
                        layer.msg('请选择执行开始时间~')
                        return;
                    }
                    if(!$list_item.find('.condition_item:eq('+j+') .values>.date_box .end_time').val() || $list_item.find('.condition_item:eq('+j+') .values>.date_box .end_time').val()==''){
                        layer.msg('请选择执行截止时间~')
                        return;
                    }
                    if($list_item.find('.condition_item:eq('+j+') .values>.date_box .start_time').val() >= $list_item.find('.condition_item:eq('+j+') .values>.date_box .end_time').val() ){
                        layer.msg('开始时间不能大于等于结束时间~')
                        return;
                    }
                }
            }

            var obj = {};
            obj.logic = $list_item.find('.con_logic:checked').val();
            obj.suboption = $list_item.find('.condition_item:eq(0) [name="suboption"]').val();
            for(var k=0;k<$list_item.find('.condition_item:eq(0) .actions>select').length;k++){
                if($list_item.find('.condition_item:eq(0) .actions>select:eq('+k+')') && !$list_item.find('.condition_item:eq(0) .actions>select:eq('+k+')').hasClass('display-none')){
                    obj.action = $list_item.find('.condition_item:eq(0) .actions>select:eq('+k+')').val();
                }
            }
            for(var k=0;k<$list_item.find('.condition_item:eq(0) .values>input').length;k++){
                if($list_item.find('.condition_item:eq(0) .values>input:eq('+k+')') && !$list_item.find('.condition_item:eq(0) .values>input:eq('+k+')').hasClass('display-none')){
                    obj.value = $list_item.find('.condition_item:eq(0) .values>input:eq('+k+')').val();
                }
            }
            if(!$list_item.find('.condition_item:eq(0) .values>.dept_box').hasClass('display-none')){
                obj.value = $list_item.find('.condition_item:eq(0) .values>.dept_box .id_dept_id').val();
            }
            if(!$list_item.find('.condition_item:eq(0) .values>.week_box').hasClass('display-none')){
                obj.value = {}
                obj.value.day_start = $list_item.find('.condition_item:eq(0) .values>.week_box [name="day_start"]').val();
                obj.value.day_end = $list_item.find('.condition_item:eq(0) .values>.week_box [name="day_end"]').val();
                obj.value.start = $list_item.find('.condition_item:eq(0) .values>.week_box [name="start"]').val();
                obj.value.end = $list_item.find('.condition_item:eq(0) .values>.week_box [name="end"]').val();
            }
            if(!$list_item.find('.condition_item:eq(0) .values>.date_box').hasClass('display-none')){
                obj.value = {}
                obj.value.start = $list_item.find('.condition_item:eq(0) .values>.date_box .start_time').val();
                obj.value.end = $list_item.find('.condition_item:eq(0) .values>.date_box .end_time').val();
            }
            obj.subs = [];
            for(var j=1;j<$list_item.find('.condition_item').length;j++){
                var sub_obj = {}
                sub_obj.suboption = $list_item.find('.condition_item:eq('+j+') [name="suboption"]').val();
                for(var g=0;g<$list_item.find('.condition_item:eq('+j+') .actions>select').length;g++){
                    if($list_item.find('.condition_item:eq('+j+') .actions>select:eq('+g+')') && !$list_item.find('.condition_item:eq('+j+') .actions>select:eq('+g+')').hasClass('display-none')){
                        sub_obj.action = $list_item.find('.condition_item:eq('+j+') .actions>select:eq('+g+')').val();
                    }
                }
                for(var g=0;g<$list_item.find('.condition_item:eq('+j+') .values>input').length;g++){
                    if($list_item.find('.condition_item:eq('+j+') .values>input:eq('+g+')') && !$list_item.find('.condition_item:eq('+j+') .values>input:eq('+g+')').hasClass('display-none')){
                        sub_obj.value = $list_item.find('.condition_item:eq('+j+') .values>input:eq('+g+')').val();
                    }
                }
                if(!$list_item.find('.condition_item:eq('+j+') .values>.dept_box').hasClass('display-none')){
                    sub_obj.value = $list_item.find('.condition_item:eq('+j+') .values>.dept_box .id_dept_id').val();
                }
                if(!$list_item.find('.condition_item:eq('+j+') .values>.week_box').hasClass('display-none')){
                    sub_obj.value = {}
                    sub_obj.value.day_start = $list_item.find('.condition_item:eq('+j+') .values>.dept_box [name="day_start"]').val();
                    sub_obj.value.day_end = $list_item.find('.condition_item:eq('+j+') .values>.week_box [name="day_end"]').val();
                    sub_obj.value.start = $list_item.find('.condition_item:eq('+j+') .values>.week_box [name="start"]').val();
                    sub_obj.value.end = $list_item.find('.condition_item:eq('+j+') .values>.week_box [name="end"]').val();
                }
                if(!$list_item.find('.condition_item:eq('+j+') .values>.date_box').hasClass('display-none')){
                    sub_obj.value = {}
                    sub_obj.value.start = $list_item.find('.condition_item:eq('+j+') .values>.date_box .start_time').val();
                    sub_obj.value.end = $list_item.find('.condition_item:eq('+j+') .values>.date_box .end_time').val();
                }
                obj.subs.push(sub_obj);
            }
            arr.push(obj);
        }
        var is_forward_result = $('#is_save_forward').prop('checked')?true:false;
        var obj={
            action:[{
                value:{value:$('#forward_body').val()},
                action:'forward',
                is_forward:is_forward_result
            }],
            disabled:$('#status_checkbox_forward').prop('checked')==true?'-1':'1',
            logic:$('.logic_con [name="logic"]:checked').val(),
            condition: arr
        }
            
        $.ajax({
            url:" {% url 'user_cfilter_mdf' %}",
            type:'POST',
            data:{
                rule_id:rule_id,
                mailbox_id:"{{ mailbox_id }}",
                extype:'fw',
                value:JSON.stringify(obj)
            },
            success:function(data){
                console.log(data);
                if(data.status == 'OK'){
                    layer.msg(data.message)
                    getList();
                    $('.forward_list').removeClass('display-none').siblings().addClass('display-none');
                    initAddHtml()
                    $('#forward_body').val('')
                    add_condition_init();
    
                }else{
                    layer.msg(data.message || '')
                }
                
            }
        })
    })
    
    //删除规则
    $('body').on('click','.delete_con_btn',function(){
        $.ajax({
            url:"{% url 'user_cfilter_del' %}",
            type:'POST',
            data:{
                rule_id :$(this).attr('data_id')
            },
            success:function(data){
                layer.msg(data.message || '')
                getList();
            }
        })
    })
    
    var deptArr = [
        {id:1,parent:0,name:"部门1",child:2},
        {id:2,parent:1,name:"部门2",child:1},
        {id:3,parent:2,name:"部门3",child:0},
        {id:4,parent:1,name:"部门4",child:0},
        {id:5,parent:2,name:"部门5",child:0},
        {id:6,parent:0,name:"部门6",child:0}
    ];

    $('body').on('change','[name="suboption"]',function(){
        var v = $(this).val()
        $(this).parent().next().find('.actions>select').addClass('display-none');
        $(this).parent().next().find('.values>input').addClass('display-none');
        $(this).parent().next().find('.values>div').addClass('display-none');
        if(v=='attachments'|| v=='sender'||v=='cc'||v=='recipient'||v=='subject'||v=='body'){
            $(this).parent().next().find('.actions>select[name="action_contain"]').removeClass('display-none');
            $(this).parent().next().find('.values>input[name="rule_value_common"]').removeClass('display-none');
        }else if(v=='mail_size'||v=='mail_size2'||v=='content_size'){
            $(this).parent().next().find('.actions>select[name="action_eq"]').removeClass('display-none');
            $(this).parent().next().find('.values>input[name="rule_value_size"]').removeClass('display-none');
        }else if(v=='sender_dept'||v=='cc_dept'||v=='rcpt_dept'){
            $(this).parent().next().find('.actions>select[name="action_belong"]').removeClass('display-none');
            $(this).parent().next().find('.values>div.dept_box').removeClass('display-none');
        }else if(v=='exec_date'){
            $(this).parent().next().find('.actions>select[name="action_date"]').removeClass('display-none');
            $(this).parent().next().find('.values>div.week_box').removeClass('display-none');
        }
    })
    $('body').on('change','[name="action_date"]',function(){
        var v = $(this).val();
        console.log(v)
        $(this).parent().next().find('>div').addClass('display-none');
        if(v == 'week'){
            $(this).parent().next().find('>div.week_box').removeClass('display-none');
        }else if(v == 'date'){
            $(this).parent().next().find('>div.date_box').removeClass('display-none');
        }
    })

    var index = 1;
    function getConditionNew(index){
        var con =  '<div class="panel panel-default" id="id_option_'+index+'">'+
                                    '<div class="panel-heading" style="position:relative;">'+
                                        '<a href="#faq_'+index+'" data-toggle="collapse" class="accordion-toggle">'+
                                            '<i class="smaller-80 ace-icon fa fa-chevron-down" data-icon-hide="ace-icon fa fa-chevron-down align-top" data-icon-show="ace-icon fa fa-chevron-right"></i>&nbsp;'+
                                            '<b>条件</b>'+
                                            '<button type="button" class="delete_condition btn btn-sm btn-danger pull-right" data-id="id_option_'+index+'" style="position:absolute;top:-0;right:0;">删除条件</button>'+
                                        '</a>'+
                                    '</div>'+
                                    '<div class="panel-collapse collapse in" id="faq_'+index+'">'+
                                        '<div class="panel-body">'+
                                            '<div >'+
                                                '<span>子条件间关系：</span>'+
                                                '<div class="radio inline">'+
                                                    '<label>'+
                                                        '<input name="logic_'+index+'" type="radio" checked class="ace con_logic" value="all">'+
                                                        '<span class="lbl"> 满足所有</span>'+
                                                    '</label>'+
                                                '</div>'+
                                                '<div class="radio inline">'+
                                                    '<label>'+
                                                        '<input name="logic_'+index+'" type="radio" class="ace con_logic" value="one">'+
                                                        '<span class="lbl middle"> 满足任意</span>'+
                                                    '</label>'+
                                                '</div>'+
                                                '<button type="button" class="btn btn-xs btn-info add_sub_condition" dataindex="0" dataparentindex="'+index+'"  style="margin-left:20px;"><i class="glyphicon glyphicon-plus"></i>新增子条件</button>'+
                                            '</div>'+
                                            '<ul>'+
                                                '<li class="condition_item">'+
                                                    '<div class="hr"></div>'+
                                                    '<div class="row">'+
                                                        '<div class="col-sm-2 control-label">'+
                                                            '子条件：'+
                                                        '</div>'+
                                                        '<div class="col-sm-10">'+
                                                            '<div class="row">'+
                                                                '<div class="col-sm-2 no-padding">'+
                                                                '<select class="form-control" name="suboption" style="height: 34px;">'+
                                                                    '<option value="all_mail">所有邮件</option>'+
                                                                    '<option value="has_attach">有附件</option>'+
                                                                    '<option value="attachments">附件名</option>'+
                                                                    '<option value="sender">发信人</option>'+
                                                                    '<option value="cc">抄送人</option>'+
                                                                    '<option value="recipient">收信人</option>'+
                                                                    '<option value="sender_dept">发信人部门</option>'+
                                                                    '<option value="cc_dept">抄送人部门</option>'+
                                                                    '<option value="rcpt_dept">收信人部门</option>'+
                                                                    '<option value="subject">主题</option>'+
                                                                    '<option value="body">邮件内容</option>'+
                                                                    '<option value="mail_size">邮件大小(MB)</option>'+
                                                                    '<option value="mail_size2">邮件大小(Byte)</option>'+
                                                                    '<option value="content_size">邮件正文大小(Byte)</option>'+
                                                                    '<option value="exec_date">执行时间</option>'+
                                                                '</select>'+
                                                            '</div>'+
                                                            '<div class="col-sm-10 no-padding">'+
                                                                '<div class="col-sm-2 no-padding actions">'+
                                                                    '<select class="form-control display-none"  name="action_contain" style="height: 34px;">'+
                                                                        '<option value="contains">包含</option>'+
                                                                        '<option value="not_contains">不包含</option>'+
                                                                        '<option value="==">等于</option>'+
                                                                    '</select>'+
                                                                    '<select class="form-control display-none" name="action_eq" style="height: 34px;">'+
                                                                        '<option value=">=">大于等于</option>'+
                                                                        '<option value="<=">小于等于</option>'+
                                                                    '</select>'+
                                                                    '<select class="form-control display-none" name="action_belong" style="height: 34px;">'+
                                                                        '<option value="in">属于</option>'+
                                                                        '<option value="not_in">不属于</option>'+
                                                                    '</select>'+
                                                                    '<select class="form-control display-none" name="action_date" style="height: 34px;">'+
                                                                        '<option value="week">星期</option>'+
                                                                        '<option value="date">天</option>'+
                                                                    '</select>'+
                                                                '</div>'+
                                                                    '<div class="col-sm-8 no-padding values">'+
                                                                        '<input type="text" name="rule_value_common" value="" class="display-none" maxlength="300" style="width: 100%;"/>'+
                                                                        '<input type="number" name="rule_value_size" value="" class="display-none"  style="width: 100%;"/>'+
                                                                        '<div  class="col-xs-12 col-sm-12 no-padding  display-none dept_box">'+
                                                                            '<div class="input-group">'+
                                                                                '<div id="input_box_'+index+'">'+
                                                                                    '<input type="text" value="" readonly placeholder="点击选择部门" class="form-control department_choice">'+
                                                                                    '<input type="hidden" class="id_dept_id" value="" name="option_value_dpt0">'+
                                                                                '</div>'+
                                                                            '</div>'+
                                                                        '</div>'+

                                                                        '<div class="col-xs-12 col-sm-12 no-padding  display-none date_box clear">'+
                                                                            '<input type="datetime" class="datetime start_time"> --'+
                                                                            '<input type="datetime" class="datetime end_time">'+
                                                                        '</div>'+
                                                                        '<div class="col-xs-12 col-sm-12 no-padding  display-none week_box clear">'+
                                                                            '<div style="float:left;">'+
                                                                                '<select name="day_start">'+
                                                                                    '<option value="1" selected>星期一</option>'+
                                                                                    '<option value="2">星期二</option>'+
                                                                                    '<option value="3">星期三</option>'+
                                                                                    '<option value="4">星期四</option>'+
                                                                                    '<option value="5">星期五</option>'+
                                                                                    '<option value="6">星期六</option>'+
                                                                                    '<option value="7">星期日</option>'+
                                                                                '</select> --'+
                                                                                '<select name="day_end"  style="margin-right:20px;" >'+
                                                                                    '<option value="1">星期一</option>'+
                                                                                    '<option value="2">星期二</option>'+
                                                                                    '<option value="3">星期三</option>'+
                                                                                    '<option value="4">星期四</option>'+
                                                                                    '<option value="5">星期五</option>'+
                                                                                    '<option value="6">星期六</option>'+
                                                                                    '<option value="7" selected>星期日</option>'+
                                                                                '</select>'+
                                                                            '</div>'+
                                                                            '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                                                '<input name="start" type="text" class="form-control" value="00:00:00" />'+
                                                                                '<span class="input-group-addon">'+
                                                                                    '<i class="fa fa-clock-o bigger-110"></i>'+
                                                                                '</span>'+
                                                                            '</div>'+
                                                                            '<div style="float:left;line-height:34px;padding:0 4px;"> -- </div>'+
                                                                            '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                                                '<input name="end" type="text" class="form-control" value="23:59:59" />'+
                                                                                '<span class="input-group-addon">'+
                                                                                    '<i class="fa fa-clock-o bigger-110"></i>'+
                                                                                '</span>'+
                                                                            '</div>'+
                                                                        '</div>'+

                                                                    '</div>'+
                                                                '</div>'+
    
                                                            '</div>'+
                                                        '</div>'+
    
                                                    '</div>'+
    
                                                '</li>'+
                                            '</ul>'+
                                        '</div>'+
                                        '</div>'+
                                '</div>'
            return con;
    }
    function getsubHtmlAdd(parent_index,index){
            var html = '<li class="condition_item">'+
                            '<div class="hr"></div>'+
                            '<div class="row">'+
                                '<div class="col-sm-2 control-label">'+
                                    '子条件：'+
                                '</div>'+
                                '<div class="col-sm-10">'+
                                    '<div class="row">'+
                                        '<div class="col-sm-2 no-padding">'+
                                        '<select class="form-control" name="suboption" style="height: 34px;">'+
                                            '<option value="all_mail">所有邮件</option>'+
                                            '<option value="has_attach">有附件</option>'+
                                            '<option value="attachments">附件名</option>'+
                                            '<option value="sender">发信人</option>'+
                                            '<option value="cc">抄送人</option>'+
                                            '<option value="recipient">收信人</option>'+
                                            '<option value="sender_dept">发信人部门</option>'+
                                            '<option value="cc_dept">抄送人部门</option>'+
                                            '<option value="rcpt_dept">收信人部门</option>'+
                                            '<option value="subject">主题</option>'+
                                            '<option value="body">邮件内容</option>'+
                                            '<option value="mail_size">邮件大小(MB)</option>'+
                                            '<option value="mail_size2">邮件大小(Byte)</option>'+
                                            '<option value="content_size">邮件正文大小(Byte)</option>'+
                                            '<option value="exec_date">执行时间</option>'+
                                        '</select>'+
                                    '</div>'+
                                    '<div class="col-sm-10 no-padding">'+
                                        '<div class="col-sm-2 no-padding actions">'+
                                            '<select class="form-control display-none"  name="action_contain" style="height: 34px;">'+
                                                '<option value="contains">包含</option>'+
                                                '<option value="not_contains">不包含</option>'+
                                                '<option value="==">等于</option>'+
                                            '</select>'+
                                            '<select class="form-control display-none" name="action_eq" style="height: 34px;">'+
                                                '<option value=">=">大于等于</option>'+
                                                '<option value="<=">小于等于</option>'+
                                            '</select>'+
                                            '<select class="form-control display-none" name="action_belong" style="height: 34px;">'+
                                                '<option value="in">属于</option>'+
                                                '<option value="not_in">不属于</option>'+
                                            '</select>'+
                                            '<select class="form-control display-none" name="action_date" style="height: 34px;">'+
                                                '<option value="week">星期</option>'+
                                                '<option value="date">天</option>'+
                                            '</select>'+
                                        '</div>'+
                                            '<div class="col-sm-8 no-padding values">'+
                                                '<input type="text" name="rule_value_common" value="" class="display-none" maxlength="300" style="width: 100%;"/>'+
                                                '<input type="number" name="rule_value_size" value="" class="display-none"  style="width: 100%;"/>'+
                                                '<div class="col-xs-12 col-sm-12 no-padding  display-none dept_box">'+
                                                    '<div class="input-group">'+
                                                        '<div id="input_box_'+parent_index+'_'+index+'">'+
                                                            '<input type="text" value="" readonly placeholder="点击选择部门" class="form-control department_choice">'+
                                                            '<input type="hidden" class="id_dept_id" value="" name="option_value_dpt0">'+
                                                        '</div>'+
                                                    '</div>'+
                                                '</div>'+
                                                '<div class="display-none date_box">'+
                                                    '<input type="datetime" class="datetime start_time"> --'+
                                                    '<input type="datetime" class="datetime end_time">'+
                                                '</div>'+
                                                '<div class="display-none week_box">'+
                                                    '<div style="float:left;">'+
                                                        '<select name="day_start">'+
                                                            '<option value="1" selected>星期一</option>'+
                                                            '<option value="2">星期二</option>'+
                                                            '<option value="3">星期三</option>'+
                                                            '<option value="4">星期四</option>'+
                                                            '<option value="5">星期五</option>'+
                                                            '<option value="6">星期六</option>'+
                                                            '<option value="7">星期日</option>'+
                                                        '</select> --'+
                                                        '<select name="day_end"  style="margin-right:20px;" >'+
                                                            '<option value="1">星期一</option>'+
                                                            '<option value="2">星期二</option>'+
                                                            '<option value="3">星期三</option>'+
                                                            '<option value="4">星期四</option>'+
                                                            '<option value="5">星期五</option>'+
                                                            '<option value="6">星期六</option>'+
                                                            '<option value="7" selected>星期日</option>'+
                                                        '</select>'+
                                                    '</div>'+
                                                    '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                        '<input name="start" type="text" class="form-control" value="00:00:00" />'+
                                                        '<span class="input-group-addon">'+
                                                            '<i class="fa fa-clock-o bigger-110"></i>'+
                                                        '</span>'+
                                                    '</div>'+
                                                    '<div style="float:left;line-height:34px;padding:0 4px;"> -- </div>'+
                                                    '<div class="input-group bootstrap-timepicker" style="width: 120px;float:left">'+
                                                        '<input name="end" type="text" class="form-control" value="23:59:59" />'+
                                                        '<span class="input-group-addon">'+
                                                            '<i class="fa fa-clock-o bigger-110"></i>'+
                                                        '</span>'+
                                                    '</div>'+
                                                '</div>'+


                                            '</div>'+
                                            '<div class="col-sm-1"><button type="button" class="delete_sub_condition btn btn-xs btn-warning" title="删除此子条件"><i class="glyphicon glyphicon-trash"></i></button></div>'+
                                        '</div>'+
    
                                    '</div>'+
                                '</div>'+
    
                            '</div>'+
    
                        '</li>'
            return html;
        }
    
    function add_condition_init(){
        $('.add_condition').click(function(){
            $(".condition_box").append(getConditionNew(index));
            index++;
            dateInit();
            addsub();
        })
    }
    add_condition_init();
    $('body').on('click','.delete_condition',function(){
        $(this).parents('.panel.panel-default').remove();
    })
    
    function addsub(){
        $(".add_sub_condition").unbind();
        $('.add_sub_condition').click(function(){
            var dataindex = $(this).attr('dataindex');
            var parent_index = $(this).attr('dataparentindex')
            $(this).parent().next().append(getsubHtmlAdd(parent_index,dataindex));
            dataindex++;
            dateInit();
            $(this).attr('dataindex',dataindex)
        })
    }
    addsub();
    
    $('body').on('click','.delete_sub_condition',function(){
        $(this).parents('.condition_item').remove();
    })

    $('body').on('click','.department_choice',function(){
        if($('#tree_box_forward').length == 0){
            init_tree_box();
        }
        $(this).parent().append($('#tree_box_forward'));
        $('#tree_box_forward').addClass('active')
    })
    $('body').on('click','.close_btn',function(){
        $(this).parent().removeClass('active');
    })
</script>
