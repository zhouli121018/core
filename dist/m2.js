define("m2",function(){}),define("component/contactac",["require","jquery","cui/ui/autocomplete/autocomplete","module/contact/service","util/index"],function(e){var t=e("jquery"),n=e("cui/ui/autocomplete/autocomplete"),i=e("module/contact/service"),a=e("util/index"),r=n.extend({attrs:{selectFirst:!0,submitOnEnter:!1,html:"{{{label}}}",className:"u-contactac",style:{minWidth:320,maxWidth:640},container:null,enableSecurityLevel:!1,uniqueContacts:!1,dataSource:function(e,n){var r=this,s=r.get("uniqueContacts");i.searchContacts({keyword:e,uniqueContacts:s}).then(function(e){var i=[],s=r.get("enableSecurityLevel");t.each(e,function(e,t){var n=t.matchText,r=t.name;s&&(r=a.securityLevel.formatTrueName(r,t.securityLevel,"security_level",t.isOab),t.isOab&&(n=a.securityLevel.i18n(t.securityLevel,"security_level",!0,!0)+n));var o=new a.Email(r,t.emailaddr).toString(s);t.location&&(n+=" "+t.location),i.push({label:n,value:t.matchText,target:o,original:t})}),n(i)},function(){n([])})},filter:function(e){return e},delay:500}});return t.fn.contactac=function(e){return this.each(function(){e=t.extend({trigger:this},t.fn.contactac.defaults,e);var n,i,a=new r(e).render();e.container&&a.before("show",function(){n=t(e.container).outerWidth(!0),i=t(e.trigger).position(),n-i.left<300?a.set("align",{selfXY:["100%",0],baseXY:["100%","100%"]}):a.set("align",{baseXY:[0,"100%"]})}),t(this).on("remove",function(){a.destroy()}),a.on("itemSelected",function(n,i){"function"===t.type(e.select)&&e.select(n,i)}),this.contactacInstance=a})},t.fn.contactac.defaults={select:null},r}),define("components/requirejs-text/text!component/../../template/component/contactdg.tpl.html",[],function(){return'<div class="u-contactdg">\r\n    <table class="j-contactdg-table">\r\n        <thead class="u-contactdg-head">\r\n        <tr>\r\n            <th>{{i18n \'contact/contact\'}}</th>\r\n            <th class="list j-list-head">\r\n                <div class="group-info"></div>\r\n                <div class="group-page"></div>\r\n            </th>\r\n            <th class="select j-select-head">\r\n                <div class="f-fl j-select-added"><span class="j-select-title">{{i18n \'mail/mail_to_address\'}}</span> <span class="small"></span></div>\r\n                <div class="f-fr"><a href="javascript:void(0);" class="link">{{i18n \'compose/lbt_delete_all\'}}</a></div>\r\n            </th>\r\n        </tr>\r\n        </thead>\r\n        <tbody>\r\n        <tr>\r\n            <td class="td-tree">\r\n                <div class="u-contactdg-tree">\r\n                    <div class="tree-header">\r\n                        <div class="u-input-control">\r\n                            <input type="text" class="u-input u-input-round j-search">\r\n                            <span class="iconfont iconsreachm"></span>\r\n                            <span class="iconfont iconenter" data-action="startSearch"></span>\r\n                        </div>\r\n                    </div>\r\n                    <div class="tree-body j-tree-body">\r\n                        <ul class="ztree" id="contactdg-tree"></ul>\r\n                    </div>\r\n                </div>\r\n            </td>\r\n            <td class="td-list">\r\n                <div class="u-contactdg-list j-contact-list">\r\n                    <div class="list">\r\n                        <table class="u-table u-table-row j-contact-table">\r\n                            <thead></thead>\r\n                            <tbody></tbody>\r\n                        </table>\r\n                    </div>\r\n                    <div class="tgl j-select-tgl">\r\n                        <span class="iconfont iconright"></span>\r\n                    </div>\r\n                </div>\r\n            </td>\r\n            <td class="td-select j-select-body">\r\n                <div class="u-contactdg-select j-contact-select"></div>\r\n            </td>\r\n        </tr>\r\n        </tbody>\r\n    </table>\r\n\r\n    {{#raw}}\r\n    <script id="selectboxtpl" type="text/x-handlebars-template">\r\n        <div class="u-box u-box-[[type]] j-select-[[type]] [[#if follow]]u-box-follow[[/if]]" data-type="[[type]]">\r\n            <div class="u-box-head"><h3 class="u-box-head-title">[[name]]</h3></div>\r\n            <div class="u-box-container">\r\n                <ul class="u-list j-list"></ul>\r\n            </div>\r\n        </div>\r\n    </script>\r\n\r\n    <script id="pabheadtpl" type="text/x-handlebars-template">\r\n        <h5 class="h5">[[name]] <span class="small">[[i18n \'prop:contact/msg_pabSummary\' 0=total]]</span></h5>\r\n    </script>\r\n\r\n    <script id="ouheadtpl" type="text/x-handlebars-template">\r\n        <h5 class="h5">[[name]] <span class="small">[[i18n \'prop:contact/msg_ouSummary\' 0=total 1=depts 2=addrs]]</span></h5>\r\n    </script>\r\n\r\n    <script id="ousearchheadtpl" type="text/x-handlebars-template">\r\n        <h5 class="h5">[[name]] <span class="small">[[i18n \'prop:contact/msg_ouSearchSummary\' 0=total]]</span></h5>\r\n    </script>\r\n\r\n    <script id="pabcontactheadtpl" type="text/x-handlebars-template">\r\n        <tr>\r\n            <th class="chk"><input type="checkbox"/></th>\r\n            <th class="gender"></th>\r\n            [[#each fields]]\r\n            <th data-sort="[[id]]">[[#if label]][[label]][[^]][[id]][[/if]]</th>\r\n            [[/each]]\r\n        </tr>\r\n    </script>\r\n\r\n    <script id="pabcontacttpl" type="text/x-handlebars-template">\r\n        <tr email="[[addr]]" name="[[name]]" data-user="true" uid="[[uid]]" data-isoab="false" class="[[#if isUser]][[^]]j-group[[/if]]">\r\n            <td><input type="checkbox"/></td>\r\n            <td><i class="iconfont [[icon]]"></i></td>\r\n            [[#each fields]]\r\n            <td title="[[value]]">[[formatted value]]</td>\r\n            [[/each]]\r\n        </tr>\r\n    </script>\r\n\r\n    <script id="oabcontactheadtpl" type="text/x-handlebars-template">\r\n        <tr>\r\n            <th class="chk"><input type="checkbox"/></th>\r\n            <th class="gender"></th>\r\n            [[#each fields]]\r\n            <th data-sort="[[name]]">[[label]]</th>\r\n            [[/each]]\r\n        </tr>\r\n    </script>\r\n\r\n    <script id="oabcontacttpl" type="text/x-handlebars-template">\r\n        <tr email="[[addr]]" name="[[name]]" data-user="[[isUser]]" uid="[[uid]]" data-isoab="true" securitylevel="[[securityLevel]]">\r\n            <td>[[#if addr]]<input type="checkbox"/>[[/if]]</td>\r\n            <td><i class="iconfont [[icon]]"></i></td>\r\n            [[#each fields]]\r\n              [[#or ../isUser ../isList]]\r\n                <td title="[[formatted value]]">[[formatted value]]</td>\r\n              [[^]]\r\n                [[#compare id \'==\' \'true_name\']]\r\n                  <td colspan="[[../../../colspan]]" title="[[formatted value]]">[[formatted value]]</td>\r\n                [[/compare]]\r\n              [[/or]]\r\n            [[/each]]\r\n        </tr>\r\n    </script>\r\n\r\n    <script id="nocontacttpl" type="text/x-handlebars-template">\r\n        <tr class="z-disabled">\r\n            <td colspan="[[colspan]]">[[i18n \'mail/msg_nouser\']]</td>\r\n        </tr>\r\n    </script>\r\n\r\n    <script id="selectcontacttpl" type="text/x-handlebars-template">\r\n        <li email="[[addr]]" name="[[name]]">\r\n            <span>[[value]]</span>\r\n            <a href="javascript:void(0);" class="link">[[i18n \'mail/op_remove\']]</a>\r\n        </li>\r\n    </script>\r\n    {{/raw}}\r\n</div>'}),define("component/contactdg",["require","i18n!contact,compose,mail,common","jquery.ztree","jquery.scrollTo","../widget/pagination/pagination","text!../../template/component/contactdg.tpl.html","jquery","moment","../util/index","cui/ui/dialog/confirmbox","../module/common/globalService","module/contact/service"],function(e){function t(){var e=s.Deferred(),t=[];return u.getAllPabGroups().then(function(n){n.push({id:"OTHER",name:l.i18n.t("contact/gp_other")}),t.push({id:"__pab__",name:l.i18n.t("contact/tab_pab"),isPab:!0,children:i(n,"groups","",{isPab:!0})}),e.resolve(t)},function(){e.resolve([])}),e.promise()}function n(){var e=s.Deferred();return u.getOabDirectories().then(function(t){e.resolve(i(t,"ou","",{isOab:!0}))},function(){e.resolve([])}),e.promise()}function i(e,t,n,a){var r=[];return a=a||{},s.each(e,function(e,o){o[t]&&o[t].length>0&&(o.children=i(o[t],t,n||o.id,a)),n&&(o.id=n+"/"+o.id),r.push(s.extend(o,a))}),r}function a(e,t){var n=e.getNodeByParam("id",t);return null==n?null:(e.selectNode(n),n.isParent&&e.expandNode(n,!0),n)}e("i18n!contact,compose,mail,common"),e("jquery.ztree"),e("jquery.scrollTo"),e("../widget/pagination/pagination");var r=e("text!../../template/component/contactdg.tpl.html"),s=e("jquery"),o=e("moment"),l=e("../util/index"),c=e("cui/ui/dialog/confirmbox"),d=e("../module/common/globalService"),u=e("module/contact/service"),p=c.extend({attrs:{width:"auto",title:l.i18n.t("mail/op_add_to"),confirmTpl:l.i18n.t("common/confirm"),cancelTpl:l.i18n.t("common/cancel"),message:"",dnd:!0,selectTitle:"",selectType:[],activeType:"",isDisplayOab:d.getConfig("user.supportoab"),isDisplayPab:d.getConfig("user.supportpab")},widgets:{contactTree:null},_params:{groups:[],oabReturnAttrs:d.getConfig("contact.oab.composereturnattrs"),oabNormalListAttrs:d.getConfig("contact.oab.composenormallistattrs"),oabSearchListAttrs:d.getConfig("contact.oab.searchlistattrs"),pabSearchListAttrs:d.getConfig("contact.pab.composesearchlistattrs").split(" "),pabListAttrs:d.getConfig("contact.pab.composelistattrs").split(" "),pabSchema:d.getConfig("contact.pab.schema"),pabGrpListAttrs:["group_name"],enableScroll:d.getConfig("mail.enableaddrsearchscroll"),enableSecurityLevel:d.getConfig("user.enablesecuritylevel")},events:{"keydown .j-search":"_handleSearch","click .j-select-tgl":"_handleToggleSelect","click [data-action=startSearch]":"_handleSearchTrigger"},setup:function(){var e=this;this.set("message",this.compile(r)),p.superclass.setup.call(this),this.on("confirm",function(){e.hide(),e.trigger("select",e.selectedContacts())}),this.after("hide",function(){setTimeout(function(){e.trigger("close")},20)})},render:function(){var e=this;p.superclass.render.call(this),s.when(e.get("isDisplayPab")?t():s.noop(),e.get("isDisplayOab")?n():s.noop()).then(function(t,n){t&&(e._params.groups=t[0].children),e._initContactTree(t,n),e._initContactList(),e._initContactSelect(),e.renderFinish=!0,e.trigger("render:finish")}),e._initModuleEvent()},destroy:function(){this.widgets.contactTree&&this.widgets.contactTree.destroy(),p.superclass.destroy.call(this)},_initModuleEvent:function(){var e=this;s(".j-search").on("input propertychange",function(){e._handleSearchChange(this)})},selectedContacts:function(){var e=this.$(".j-contact-select"),t={};return e.find(".u-box").each(function(){var e=s(this).attr("data-type"),n=s(this).find(".j-list");t[e]=n.data("contacts")||[]}),t},setSelected:function(e,t){e=e||"to",t=t||{};var n=this,i=this.$(".j-contact-select"),a=this.$(".j-contact-table"),r=a.data("contacts");s.each(t,function(e,t){n.trigger("box:select",t,r,e,!0)}),i.find('[data-type="'+e+'"]').click()},_initContactTree:function(e,t){var n,i,r=this;n={view:{showLine:!1,showIcon:!1,selectedMulti:!1,addDiyDom:function(e,t){var n=5,i=r.$("#"+t.tId+"_a"),a=r.$("#"+t.tId+"_switch"),s=i.find("#"+t.tId+"_ico"),o=i.find("#"+t.tId+"_span");if(a.remove(),s.before(a),o.attr("dn",t.id),t.level>0){var l="<span style='display: inline-block;width:"+n*t.level+"px'></span>";a.before(l)}t.isParent||a.append('<i class="iconfont icongroup"></i>').css({lineHeight:"14px",marginTop:"-1px"})}},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"pId",rootPId:""}},callback:{beforeClick:function(e,t){var n=s.fn.zTree.getZTreeObj("contactdg-tree"),i=r.$(".j-list-head").data("params")||{};return t.isParent&&n.expandNode(t,!0),i.id!==t.id&&r._updateContactList({id:t.id,name:t.name,resetPagination:!0,contactType:t.isOab?"oab":"pab"}),!0},onNodeCreated:function(e,t,n){s("#"+n.tId+"_a").attr("title",n.name)}}};var o=[];r.get("isDisplayPab")&&(o=o.concat(e)),r.get("isDisplayOab")&&(o=o.concat(t)),r.widgets.contactTree=s.fn.zTree.init(r.$("#contactdg-tree"),n,o),i=a(r.widgets.contactTree,r.get("isDisplayOab")?d.getConfig("user.ou"):"__pab__"),null!=i&&this.$(".j-tree-body").scrollTo(this.$("#"+i.tId),300)},_initContactList:function(){var e=this.get("isDisplayOab")?d.getConfig("user.ou"):"__pab__",t=this.widgets.contactTree.getNodeByParam("id",e);null!=t&&this._updateContactList({id:e,name:t.name,resetPagination:!0,contactType:t.isOab?"oab":"pab"}),this._initContactListHandler(),this._initContactListEvent()},_initContactListHandler:function(){var e=this,t=this.$(".j-contact-table"),n=t.find("thead"),i=t.find("tbody"),a="checkbox-checked";t.on("click","tbody tr,.checkbox",function(r){r.stopPropagation();var o=s(this),l=t.data("contacts"),c=!1,d=[],u=!0,p=!1,m=[];if(o.hasClass("checkbox"))o.closest("th").length>0?(c=!o.data("selectAll"),o.data("selectAll",c),u=!1,c?i.find(".checkbox").each(function(){s(this).hasClass(a)||(s(this).prev("input[type=checkbox]").prop("checked",!0),s(this).addClass(a).closest("tr").addClass("z-selected"))}):i.find(".checkbox").each(function(){s(this).hasClass(a)&&(s(this).prev("input[type=checkbox]").prop("checked",!1),s(this).removeClass(a).closest("tr").removeClass("z-selected"))})):o.hasClass(a)?o.closest("tr").addClass("z-selected"):o.closest("tr").removeClass("z-selected");else{if(o.hasClass("z-disabled"))return!1;if(o.hasClass("z-selected"))o.find("input[type=checkbox]").prop("checked",!1),o.find(".checkbox").removeClass(a),o.removeClass("z-selected");else{if(!s(this).attr("email")&&!o.hasClass("j-group"))return!1;o.find("input[type=checkbox]").prop("checked",!0),o.find(".checkbox").addClass(a),o.addClass("z-selected")}}if(i.find("tr.z-selected").each(function(){s(this).hasClass("j-group")?(m.push(s(this).attr("uid")),p=!0):d.push({id:s(this).attr("uid"),name:s(this).attr("name"),addr:s(this).attr("email"),isOab:s(this).data("isoab"),isUser:s(this).data("user"),securityLevel:parseInt(s(this).attr("securitylevel"))})}),u&&(i.find("tr.z-selected").length===l.length?(n.find("input[type=checkbox]").prop("checked",!0),n.find(".checkbox").addClass(a).data("selectAll",!0)):(n.find("input[type=checkbox]").prop("checked",!1),n.find(".checkbox").removeClass(a).data("selectAll",!1))),p||0!==i.find("tr.j-group").length){var h=t.data("newContacts")||[];0===m.length?e.trigger("box:select",[],h):e._getPabContacts({id:m}).then(function(n){var i=[];s.each(n,function(e,t){i.push(t)}),e.trigger("box:select",n,h),t.data("newContacts",i)})}else e.trigger("box:select",d,l)})},_initContactListEvent:function(){var e=this.$(".j-contact-table"),t=e.find("thead"),n=e.find("tbody"),i="checkbox-checked";this.on("list:select",function(e){var a=!0;n.find("tr").each(function(){s.inArray(s(this).attr("email"),e)>-1?(s(this).addClass("z-selected"),s(this).find("input[type=checkbox]").prop("checked",!0),s(this).find(".checkbox").addClass(i)):(a=!1,s(this).hasClass("j-group")||(s(this).removeClass("z-selected"),s(this).find("input[type=checkbox]").prop("checked",!1),s(this).find(".checkbox").removeClass(i)))}),a?(t.find("input[type=checkbox]").prop("checked",!0),t.find(".checkbox").addClass(i).data("selectAll",!0)):(t.find("input[type=checkbox]").prop("checked",!1),t.find(".checkbox").removeClass(i).data("selectAll",!1))}),this.on("list:unselect",function(e,a){a="boolean"===s.type(a)?a:!1,n.find("tr").each(function(){(s.inArray(s(this).attr("email"),e)>-1||a&&s(this).hasClass("j-group"))&&(s(this).removeClass("z-selected"),s(this).find("input[type=checkbox]").prop("checked",!1),s(this).find(".checkbox").removeClass(i))}),e.length>0&&(t.find("input[type=checkbox]").prop("checked",!1),t.find(".checkbox").removeClass(i).data("selectAll",!1))})},_initContactSelect:function(){var e=this,t=this.get("selectTitle"),n=this.get("selectType"),i=this.get("activeType"),a=this.$(".j-contact-select"),r="z-active",o=this.$("#selectboxtpl").html(),c="",d=!1;t=t||l.i18n.t("mail/mail_to_address"),this.$(".j-select-title").html(t),n&&0!==n.length||(n=[{name:l.i18n.t("mail/mail_to"),type:"to"},{name:l.i18n.t("mail/mail_cc"),type:"cc"},{name:l.i18n.t("mail/mail_bcc"),type:"bcc"}]),s.each(n,function(t,n){var a=!!c;c+=e.compile(o,s.extend(n,{follow:a})),n.type===i&&(d=!0)}),a.html(c),d?a.find(".j-select-"+i).addClass(r):a.find(".j-select-"+n[0].type).addClass(r),this._initContactSelectHandler(),this._initContactSelectEvent()},_initContactSelectHandler:function(){var e=this,t=this.$(".j-contact-select"),n=this.$(".j-select-head"),i="z-active";t.on("click",".u-box",function(){var n=[];t.find(".u-box").removeClass(i),s(this).addClass(i),s(this).find("li").each(function(){n.push(s(this).attr("email"))}),e.trigger("list:select",n)}),t.on("click","a",function(){var t=s(this).closest(".j-list"),n=s(this).closest("li"),i=t.data("contacts"),a=n.attr("email");s.each(i,function(e,t){return a===t.addr?(i.splice(e,1),!1):void 0}),n.remove(),e.trigger("list:unselect",[a]),e.trigger("box:selected")}),n.on("click","a",function(){var n=[];t.find(".j-list").each(function(){var e=s(this).data("contacts")||[];s.each(e,function(e,t){-1===s.inArray(t.addr,n)&&n.push(t.addr)}),s(this).data("contacts",[]).empty()}),e.trigger("list:unselect",n,!0),e.trigger("box:selected")})},_initContactSelectEvent:function(){var e=this,t=this.$(".j-contact-select"),n=this.$(".j-select-head"),i="z-active";this.on("box:select:init",function(){var n=t.find("."+i).find(".j-list"),a=[];n.find("li").each(function(){a.push(s(this).attr("email"))}),e.trigger("list:select",a)}),this.on("box:select",function(n,a,r,o){var c,d,u,p=e.$("#selectcontacttpl").html(),m="",h=[],f=!1,v=!1;for(o=o||!1,r=r?'[data-type="'+r+'"]':"."+i,d=t.find(r).find(".j-list"),c=d.data("contacts")||[],u=c.length-1;u>=0;u--)f=!1,v=!1,s.each(a,function(e,t){return t.addr===c[u].addr?(f=!0,!1):void 0}),s.each(n,function(e,t){return t.addr===c[u].addr?(n.splice(e,1),v=!0,!1):void 0}),!f&&!o||v||(h=h.concat(c.splice(u,1)));c=c.concat(n),d.data("contacts",c),d.find("li").each(function(){var e=s(this).attr("email"),t=!1;s.each(h,function(n,i){return i.addr===e?(t=!0,!1):void 0}),t&&s(this).remove()}),s.each(n,function(t,n){var i={name:n.name,addr:n.addr,value:n.name||n.addr};e._params.enableSecurityLevel&&n.isOab&&(i.value=l.securityLevel.i18n(n.securityLevel,"security_level",!0)+i.value),m+=e.compile(p,i)}),d.append(m),e.trigger("box:selected")}),this.on("box:selected",function(){var e=n.find(".j-select-added"),i=t.find("li").length;e.find(".small").html(l.i18n.t("mail/msg_added").replace("{0}",i))})},_handleToggleSelect:function(e,t){var n=this.$(".j-contactdg-table");n.hasClass("z-select-hide")?(n.removeClass("z-select-hide"),s(t).find(".iconfont").removeClass("iconleft").addClass("iconright")):(n.addClass("z-select-hide"),s(t).find(".iconfont").removeClass("iconright").addClass("iconleft"))},_handleSearch:function(e,t){var n,i,a=this;t?(i=s.trim(s(t).val()),13===e.keyCode&&i.length>0&&a._getSearch(i)):(n=e||{},"pab"===n.contactType?this._handleSearchPab({start:n.start,limit:n.limit,resetPagination:!1}):"oab"===n.contactType&&this._handleSearchOab({dn:n.dn,start:n.start,limit:n.limit,resetPagination:!1}))},_handleSearchTrigger:function(e,t){var n=this,i=s.trim(s(t).siblings(".j-search").val());i.length>0&&n._getSearch(i)},_getSearch:function(e){var t,n,i=this;t=i.widgets.contactTree.getSelectedNodes()[0],t.isPab?this._handleSearchPab({keyword:e,start:0,limit:20}):t.isOab&&(n={dn:l.siteNode.getOrg(t.id),recursive:!0,start:0,limit:20},-1===e.indexOf("@")?(n.general=e,n.action="quickSearch"):(n.email=e,n.action="advanceSearch"),this._handleSearchOab(n))},_handleSearchChange:function(e){var t=s.trim(s(e).val());t.length>0&&s(e).parent().addClass("f-have-content")},_handleSearchPab:function(e){var t=this;t.$(".j-contact-list").mask(),u.searchPabContacts(e).then(function(n,i){t.$(".j-contact-list").mask("hide"),s.extend(e,{total:i,name:l.i18n.t("contact/tab_pab"),isSearch:!0,contactType:"pab"}),n=u.filterPabContacts(n),s.each(n,function(e,t){t.isUser=!0}),e.resetPagination!==!1&&t._renderContactListHead(e),t._renderContactList(n,e),t.trigger("box:select:init")}).always(function(){t.$(".j-search").focus()})},_handleSearchOab:function(e){var t=this;t.$(".j-contact-list").mask(),u.advanceSearchOabContacts(e).then(function(n,i){t.$(".j-contact-list").mask("hide"),s.extend(e,{total:i,name:l.i18n.t("contact/tab_oab"),isSearch:!0,contactType:"oab"}),n=u.filterOabContacts(n),e.resetPagination!==!1&&t._renderContactListHead(e),t._renderContactList(n,e),t.trigger("box:select:init")}).always(function(){t.$(".j-search").focus()})},_updateContactList:function(e){if(e=e||{},e.start=e.start||0,e.limit=e.limit||d.getConfig("mail.composeitemperpage")||20,!e.id)return!1;var t=this;if("oab"===e.contactType){t.$(".j-contact-list").mask();var n=s.inArray("@ou",t._params.oabReturnAttrs),i=s.inArray("@location",t._params.oabReturnAttrs);-1!==n&&-1!==i?t._params.oabReturnAttrs.splice(n,1):-1!==n&&-1===i&&(t._params.oabReturnAttrs[n]="@location"),u.getOabOuUserList(e.id,e.start,e.limit,void 0,t._params.oabReturnAttrs).then(function(n,i,a){t.$(".j-contact-list").mask("hide"),e.resetPagination&&t._renderContactListHead(s.extend({list:n,total:i,depts:a},e)),t._renderContactList(n,e),t.trigger("box:select:init")})}else t.$(".j-contact-list").mask(),t._getPabContacts(e).then(function(n,i){t.$(".j-contact-list").mask("hide"),e.resetPagination&&t._renderContactListHead(s.extend({list:n,total:i},e)),t._renderContactList(n,e),t.trigger("box:select:init")})},_getPabContacts:function(e){var t,n,i,a,r,l,c=this,d=s.Deferred(),p="string"===s.type(e.id),m=c._getCacheItem(p?e.id:"__combinedGroup__",p?""+e.start:e.id.join(","));if("__pab__"===e.id){for(t=c._params.groups.length,n=[],i=e.start||0,a=e.limit||t,r=i,l=0;t>r&&a>l;r++,l++)n.push(c._params.groups[r]);d.resolve(n,t)}else if(m&&m.timeout>=o().valueOf())n=[],s.each(m.list,function(e,t){n.push(t)}),d.resolve(n,m.total);else if(p)u.searchPabContacts({groupid:e.id,start:e.start,limit:e.limit}).then(function(t,n){t=u.filterPabContacts(t);var i=[];s.each(t,function(e,t){t.addr=t.emailaddr,t.isUser=!0,t.isOab=!1,i.push(t)}),c._setCacheItem(e.id,i,""+e.start,n),d.resolve(t,n)});else{var h=-1!==s.inArray("OTHER",e.id);u.getAllPabContacts({groups:h?[]:e.id}).then(function(t){t=u.filterPabContacts(t),n=[];var i=[];h?(s.each(t,function(t,a){var r=!1;0===a.groups.length?r=!0:s.each(e.id,function(e,t){return-1!==s.inArray(t,a.groups)?(r=!0,!1):void 0}),r&&(a.addr=a.emailaddr,a.isUser=!0,a.isOab=!1,n.push(a),i.push(a))}),t=n):s.each(t,function(e,t){t.addr=t.emailaddr,t.isUser=!0,t.isOab=!1,i.push(t)}),c._setCacheItem("__combinedGroup__",i,e.id.join(","),i.length),d.resolve(t)})}return d.promise()},_getCacheItem:function(e,t){var n=l.cache.getItem("cm_contactdg")||{},i=null,a=n[e];return a&&s.each(a.pageData,function(e,n){return n.key===t?(i=s.extend(n,{total:a.total}),!1):void 0}),i},_setCacheItem:function(e,t,n,i){var a=l.cache.getItem("cm_contactdg")||{},r=a[e];r||(r={pageData:[]}),r.total=i,r.pageData.unshift({key:n,list:t,timeout:o().valueOf()+6e5}),r.pageData.length>5&&r.pageData.pop(),a[e]=r,l.cache.setItem("cm_contactdg",a)},_renderContactListHead:function(e){var t=this,n=this.$(".j-list-head"),i=this.$("#ouheadtpl").html(),a=this.$("#pabheadtpl").html(),r=this.$("#ousearchheadtpl").html();n.data("params",e),"oab"===e.contactType?e.isSearch?n.find(".group-info").html(this.compile(r,{name:e.name,total:e.total})):n.find(".group-info").html(this.compile(i,{name:e.name,total:e.total,depts:e.depts,addrs:e.total-e.depts})):n.find(".group-info").html(this.compile(a,{name:e.name,total:e.total})),n.find(".group-page").pagination({total:e.total,limit:e.limit,round:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(n,i){e.isSearch?t._handleSearch(s.extend(e,{start:n*e.limit,resetPagination:!1})):t._updateContactList(s.extend(e,{start:n*e.limit,resetPagination:!1}))}})},_renderContactList:function(e,t){var n=this,i=this.$(".j-contactdg-table"),a=this.$(".j-contact-table"),r=this.$("#pabcontactheadtpl").html(),o=this.$("#pabcontacttpl").html(),c=this.$("#oabcontactheadtpl").html(),d=this.$("#oabcontacttpl").html(),u=this.$("#nocontacttpl").html(),p="",m=[],h=null;if("oab"===t.contactType){h=t.isSearch?n._params.oabSearchListAttrs:n._params.oabNormalListAttrs;var f=[];s.each(h,function(e,t){f.push(t)}),a.find("thead").html(this.compile(c,{fields:f})),e&&0!==e.length?s.each(e,function(e,t){var i,a="U"===t["@type"]||"X"===t["@type"],r="L"===t["@type"];i={icon:a?void 0==t.gender||0==t.gender?"iconman":"iconwomen":"icongroup",name:a||r?t.true_name:t.name,addr:t.email,uid:a||r?t["@id"]:"",isUser:a,isList:r};var o=[];s.each(h,function(e,n){var s;a||r||"true_name"!==n.id?"@ou"===n.id?s=t["@location"]:"security_level"===n.id||"user_security_role"===n.id||"sender_security_level"===n.id?(s=l.securityLevel.i18n(t[n.id],n.id),"security_level"===n.id&&(i.securityLevel=t[n.id]||-1)):s=t[n.id]:s=t.name,o.push({id:n.id,value:s})}),a||r||(i.colspan=h.length),i.fields=o,p+=n.compile(d,i),m.push(i)}):p=this.compile(u,{colspan:a.find("th").length})}else{h=t.isSearch?n._params.pabSearchListAttrs:"__pab__"===t.id?n._params.pabGrpListAttrs:n._params.pabListAttrs;var v=[];s.each(h,function(e,t){"group_name"===t?v.push({label:l.i18n.t("contact/lbl_groupName")}):v.push({id:t,label:n._params.pabSchema[t]})}),a.find("thead").html(this.compile(r,{fields:v})),e&&0!==e.length?s.each(e,function(e,t){var i;i={icon:t.isUser?void 0===t.gender||0===t.gender?"iconman":"iconwomen":"icongroup",name:t.name,addr:t.emailaddr,uid:t.id,isUser:t.isUser};var a=[];s.each(h,function(e,n){"group_name"===n?a.push({value:t.name}):a.push({id:n,value:t[n]})}),i.fields=a,p+=n.compile(o,i),m.push(i)}):p=this.compile(u,{colspan:a.find("th").length})}n._params.enableScroll&&i.addClass("fixedTableLayout"),a.data("contacts",m),a.find("tbody").html(p),a.customRadioCheckbox()},templateHelpers:{formatted:function(e){return"array"===s.type(e)&&(e=e.join(",")),e||l.i18n.t("common/none")}}});return s.fn.contactdg=function(e,t,n){return this.each(function(){var i,a=this,r=s.extend({trigger:a},s.fn.contactdg.defaults,e);a.contactdgInstance&&"string"==typeof e&&("show"===e?(a.contactdgInstance.get("visible")?s.noop():a.contactdgInstance.show(),a.contactdgInstance.renderFinish?a.contactdgInstance.setSelected(t,n):a.contactdgInstance.on("render:finish",function(){setTimeout(function(){a.contactdgInstance.setSelected(t,n)},200)})):"hide"===e?a.contactdgInstance.get("visible")?a.contactdgInstance.hide():s.noop():"destroy"===e&&a.contactdgInstance.destroy()),a.contactdgInstance||(i=new p(r),a.contactdgInstance=i,s(a).on("remove.contactdg",function(){i.destroy()}))})},s.fn.contactdg.defaults={parentNode:document.body,title:l.i18n.t("mail/op_add_to"),selectTitle:"",selectType:[],activeType:"",onSelect:s.noop,onClose:s.noop},p}),function(e){"function"==typeof define&&define.amd?define("jquery.ui/sortable",["jquery","./core","./mouse","./widget"],e):e(jQuery)}(function(e){return e.widget("ui.sortable",e.ui.mouse,{version:"1.11.1",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(e,t,n){return e>=t&&t+n>e},_isFloating:function(e){return/left|right/.test(e.css("float"))||/inline|table-cell/.test(e.css("display"))},_create:function(){var e=this.options;this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.floating=this.items.length?"x"===e.axis||this._isFloating(this.items[0].item):!1,this.offset=this.element.offset(),this._mouseInit(),this._setHandleClassName(),this.ready=!0},_setOption:function(e,t){this._super(e,t),"handle"===e&&this._setHandleClassName()},_setHandleClassName:function(){this.element.find(".ui-sortable-handle").removeClass("ui-sortable-handle"),e.each(this.items,function(){(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item).addClass("ui-sortable-handle")})},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").find(".ui-sortable-handle").removeClass("ui-sortable-handle"),this._mouseDestroy();for(var e=this.items.length-1;e>=0;e--)this.items[e].item.removeData(this.widgetName+"-item");return this},_mouseCapture:function(t,n){var i=null,a=!1,r=this;return this.reverting?!1:this.options.disabled||"static"===this.options.type?!1:(this._refreshItems(t),e(t.target).parents().each(function(){return e.data(this,r.widgetName+"-item")===r?(i=e(this),!1):void 0}),e.data(t.target,r.widgetName+"-item")===r&&(i=e(t.target)),i&&(!this.options.handle||n||(e(this.options.handle,i).find("*").addBack().each(function(){this===t.target&&(a=!0)}),a))?(this.currentItem=i,this._removeCurrentsFromItems(),!0):!1)},_mouseStart:function(t,n,i){var a,r,s=this.options;if(this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(t),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,s.cursorAt&&this._adjustOffsetFromHelper(s.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!==this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),s.containment&&this._setContainment(),s.cursor&&"auto"!==s.cursor&&(r=this.document.find("body"),this.storedCursor=r.css("cursor"),r.css("cursor",s.cursor),this.storedStylesheet=e("<style>*{ cursor: "+s.cursor+" !important; }</style>").appendTo(r)),s.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",s.opacity)),s.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",s.zIndex)),this.scrollParent[0]!==document&&"HTML"!==this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",t,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!i)for(a=this.containers.length-1;a>=0;a--)this.containers[a]._trigger("activate",t,this._uiHash(this));return e.ui.ddmanager&&(e.ui.ddmanager.current=this),e.ui.ddmanager&&!s.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(t),!0},_mouseDrag:function(t){var n,i,a,r,s=this.options,o=!1;for(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==document&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<s.scrollSensitivity?this.scrollParent[0].scrollTop=o=this.scrollParent[0].scrollTop+s.scrollSpeed:t.pageY-this.overflowOffset.top<s.scrollSensitivity&&(this.scrollParent[0].scrollTop=o=this.scrollParent[0].scrollTop-s.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<s.scrollSensitivity?this.scrollParent[0].scrollLeft=o=this.scrollParent[0].scrollLeft+s.scrollSpeed:t.pageX-this.overflowOffset.left<s.scrollSensitivity&&(this.scrollParent[0].scrollLeft=o=this.scrollParent[0].scrollLeft-s.scrollSpeed)):(t.pageY-e(document).scrollTop()<s.scrollSensitivity?o=e(document).scrollTop(e(document).scrollTop()-s.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<s.scrollSensitivity&&(o=e(document).scrollTop(e(document).scrollTop()+s.scrollSpeed)),
t.pageX-e(document).scrollLeft()<s.scrollSensitivity?o=e(document).scrollLeft(e(document).scrollLeft()-s.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<s.scrollSensitivity&&(o=e(document).scrollLeft(e(document).scrollLeft()+s.scrollSpeed))),o!==!1&&e.ui.ddmanager&&!s.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),n=this.items.length-1;n>=0;n--)if(i=this.items[n],a=i.item[0],r=this._intersectsWithPointer(i),r&&i.instance===this.currentContainer&&a!==this.currentItem[0]&&this.placeholder[1===r?"next":"prev"]()[0]!==a&&!e.contains(this.placeholder[0],a)&&("semi-dynamic"===this.options.type?!e.contains(this.element[0],a):!0)){if(this.direction=1===r?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(i))break;this._rearrange(t,i),this._trigger("change",t,this._uiHash());break}return this._contactContainers(t),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t,n){if(t){if(e.ui.ddmanager&&!this.options.dropBehaviour&&e.ui.ddmanager.drop(this,t),this.options.revert){var i=this,a=this.placeholder.offset(),r=this.options.axis,s={};r&&"x"!==r||(s.left=a.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===document.body?0:this.offsetParent[0].scrollLeft)),r&&"y"!==r||(s.top=a.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===document.body?0:this.offsetParent[0].scrollTop)),this.reverting=!0,e(this.helper).animate(s,parseInt(this.options.revert,10)||500,function(){i._clear(t)})}else this._clear(t,n);return!1}},cancel:function(){if(this.dragging){this._mouseUp({target:null}),"original"===this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var t=this.containers.length-1;t>=0;t--)this.containers[t]._trigger("deactivate",null,this._uiHash(this)),this.containers[t].containerCache.over&&(this.containers[t]._trigger("out",null,this._uiHash(this)),this.containers[t].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!==this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),e.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?e(this.domPosition.prev).after(this.currentItem):e(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(t){var n=this._getItemsAsjQuery(t&&t.connected),i=[];return t=t||{},e(n).each(function(){var n=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[\-=_](.+)/);n&&i.push((t.key||n[1]+"[]")+"="+(t.key&&t.expression?n[1]:n[2]))}),!i.length&&t.key&&i.push(t.key+"="),i.join("&")},toArray:function(t){var n=this._getItemsAsjQuery(t&&t.connected),i=[];return t=t||{},n.each(function(){i.push(e(t.item||this).attr(t.attribute||"id")||"")}),i},_intersectsWith:function(e){var t=this.positionAbs.left,n=t+this.helperProportions.width,i=this.positionAbs.top,a=i+this.helperProportions.height,r=e.left,s=r+e.width,o=e.top,l=o+e.height,c=this.offset.click.top,d=this.offset.click.left,u="x"===this.options.axis||i+c>o&&l>i+c,p="y"===this.options.axis||t+d>r&&s>t+d,m=u&&p;return"pointer"===this.options.tolerance||this.options.forcePointerForContainers||"pointer"!==this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>e[this.floating?"width":"height"]?m:r<t+this.helperProportions.width/2&&n-this.helperProportions.width/2<s&&o<i+this.helperProportions.height/2&&a-this.helperProportions.height/2<l},_intersectsWithPointer:function(e){var t="x"===this.options.axis||this._isOverAxis(this.positionAbs.top+this.offset.click.top,e.top,e.height),n="y"===this.options.axis||this._isOverAxis(this.positionAbs.left+this.offset.click.left,e.left,e.width),i=t&&n,a=this._getDragVerticalDirection(),r=this._getDragHorizontalDirection();return i?this.floating?r&&"right"===r||"down"===a?2:1:a&&("down"===a?2:1):!1},_intersectsWithSides:function(e){var t=this._isOverAxis(this.positionAbs.top+this.offset.click.top,e.top+e.height/2,e.height),n=this._isOverAxis(this.positionAbs.left+this.offset.click.left,e.left+e.width/2,e.width),i=this._getDragVerticalDirection(),a=this._getDragHorizontalDirection();return this.floating&&a?"right"===a&&n||"left"===a&&!n:i&&("down"===i&&t||"up"===i&&!t)},_getDragVerticalDirection:function(){var e=this.positionAbs.top-this.lastPositionAbs.top;return 0!==e&&(e>0?"down":"up")},_getDragHorizontalDirection:function(){var e=this.positionAbs.left-this.lastPositionAbs.left;return 0!==e&&(e>0?"right":"left")},refresh:function(e){return this._refreshItems(e),this._setHandleClassName(),this.refreshPositions(),this},_connectWith:function(){var e=this.options;return e.connectWith.constructor===String?[e.connectWith]:e.connectWith},_getItemsAsjQuery:function(t){function n(){o.push(this)}var i,a,r,s,o=[],l=[],c=this._connectWith();if(c&&t)for(i=c.length-1;i>=0;i--)for(r=e(c[i]),a=r.length-1;a>=0;a--)s=e.data(r[a],this.widgetFullName),s&&s!==this&&!s.options.disabled&&l.push([e.isFunction(s.options.items)?s.options.items.call(s.element):e(s.options.items,s.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),s]);for(l.push([e.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):e(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]),i=l.length-1;i>=0;i--)l[i][0].each(n);return e(o)},_removeCurrentsFromItems:function(){var t=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=e.grep(this.items,function(e){for(var n=0;n<t.length;n++)if(t[n]===e.item[0])return!1;return!0})},_refreshItems:function(t){this.items=[],this.containers=[this];var n,i,a,r,s,o,l,c,d=this.items,u=[[e.isFunction(this.options.items)?this.options.items.call(this.element[0],t,{item:this.currentItem}):e(this.options.items,this.element),this]],p=this._connectWith();if(p&&this.ready)for(n=p.length-1;n>=0;n--)for(a=e(p[n]),i=a.length-1;i>=0;i--)r=e.data(a[i],this.widgetFullName),r&&r!==this&&!r.options.disabled&&(u.push([e.isFunction(r.options.items)?r.options.items.call(r.element[0],t,{item:this.currentItem}):e(r.options.items,r.element),r]),this.containers.push(r));for(n=u.length-1;n>=0;n--)for(s=u[n][1],o=u[n][0],i=0,c=o.length;c>i;i++)l=e(o[i]),l.data(this.widgetName+"-item",s),d.push({item:l,instance:s,width:0,height:0,left:0,top:0})},refreshPositions:function(t){this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());var n,i,a,r;for(n=this.items.length-1;n>=0;n--)i=this.items[n],i.instance!==this.currentContainer&&this.currentContainer&&i.item[0]!==this.currentItem[0]||(a=this.options.toleranceElement?e(this.options.toleranceElement,i.item):i.item,t||(i.width=a.outerWidth(),i.height=a.outerHeight()),r=a.offset(),i.left=r.left,i.top=r.top);if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(n=this.containers.length-1;n>=0;n--)r=this.containers[n].element.offset(),this.containers[n].containerCache.left=r.left,this.containers[n].containerCache.top=r.top,this.containers[n].containerCache.width=this.containers[n].element.outerWidth(),this.containers[n].containerCache.height=this.containers[n].element.outerHeight();return this},_createPlaceholder:function(t){t=t||this;var n,i=t.options;i.placeholder&&i.placeholder.constructor!==String||(n=i.placeholder,i.placeholder={element:function(){var i=t.currentItem[0].nodeName.toLowerCase(),a=e("<"+i+">",t.document[0]).addClass(n||t.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");return"tr"===i?t.currentItem.children().each(function(){e("<td>&#160;</td>",t.document[0]).attr("colspan",e(this).attr("colspan")||1).appendTo(a)}):"img"===i&&a.attr("src",t.currentItem.attr("src")),n||a.css("visibility","hidden"),a},update:function(e,a){(!n||i.forcePlaceholderSize)&&(a.height()||a.height(t.currentItem.innerHeight()-parseInt(t.currentItem.css("paddingTop")||0,10)-parseInt(t.currentItem.css("paddingBottom")||0,10)),a.width()||a.width(t.currentItem.innerWidth()-parseInt(t.currentItem.css("paddingLeft")||0,10)-parseInt(t.currentItem.css("paddingRight")||0,10)))}}),t.placeholder=e(i.placeholder.element.call(t.element,t.currentItem)),t.currentItem.after(t.placeholder),i.placeholder.update(t,t.placeholder)},_contactContainers:function(t){var n,i,a,r,s,o,l,c,d,u,p=null,m=null;for(n=this.containers.length-1;n>=0;n--)if(!e.contains(this.currentItem[0],this.containers[n].element[0]))if(this._intersectsWith(this.containers[n].containerCache)){if(p&&e.contains(this.containers[n].element[0],p.element[0]))continue;p=this.containers[n],m=n}else this.containers[n].containerCache.over&&(this.containers[n]._trigger("out",t,this._uiHash(this)),this.containers[n].containerCache.over=0);if(p)if(1===this.containers.length)this.containers[m].containerCache.over||(this.containers[m]._trigger("over",t,this._uiHash(this)),this.containers[m].containerCache.over=1);else{for(a=1e4,r=null,d=p.floating||this._isFloating(this.currentItem),s=d?"left":"top",o=d?"width":"height",u=d?"clientX":"clientY",i=this.items.length-1;i>=0;i--)e.contains(this.containers[m].element[0],this.items[i].item[0])&&this.items[i].item[0]!==this.currentItem[0]&&(l=this.items[i].item.offset()[s],c=!1,t[u]-l>this.items[i][o]/2&&(c=!0),Math.abs(t[u]-l)<a&&(a=Math.abs(t[u]-l),r=this.items[i],this.direction=c?"up":"down"));if(!r&&!this.options.dropOnEmpty)return;if(this.currentContainer===this.containers[m])return;r?this._rearrange(t,r,null,!0):this._rearrange(t,null,this.containers[m].element,!0),this._trigger("change",t,this._uiHash()),this.containers[m]._trigger("change",t,this._uiHash(this)),this.currentContainer=this.containers[m],this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[m]._trigger("over",t,this._uiHash(this)),this.containers[m].containerCache.over=1}},_createHelper:function(t){var n=this.options,i=e.isFunction(n.helper)?e(n.helper.apply(this.element[0],[t,this.currentItem])):"clone"===n.helper?this.currentItem.clone():this.currentItem;return i.parents("body").length||e("parent"!==n.appendTo?n.appendTo:this.currentItem[0].parentNode)[0].appendChild(i[0]),i[0]===this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(!i[0].style.width||n.forceHelperSize)&&i.width(this.currentItem.width()),(!i[0].style.height||n.forceHelperSize)&&i.height(this.currentItem.height()),i},_adjustOffsetFromHelper:function(t){"string"==typeof t&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left"in t&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==document&&e.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===document.body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&e.ui.ie)&&(t={top:0,left:0}),{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var e=this.currentItem.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t,n,i,a=this.options;"parent"===a.containment&&(a.containment=this.helper[0].parentNode),("document"===a.containment||"window"===a.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,e("document"===a.containment?document:window).width()-this.helperProportions.width-this.margins.left,(e("document"===a.containment?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(a.containment)||(t=e(a.containment)[0],n=e(a.containment).offset(),i="hidden"!==e(t).css("overflow"),this.containment=[n.left+(parseInt(e(t).css("borderLeftWidth"),10)||0)+(parseInt(e(t).css("paddingLeft"),10)||0)-this.margins.left,n.top+(parseInt(e(t).css("borderTopWidth"),10)||0)+(parseInt(e(t).css("paddingTop"),10)||0)-this.margins.top,n.left+(i?Math.max(t.scrollWidth,t.offsetWidth):t.offsetWidth)-(parseInt(e(t).css("borderLeftWidth"),10)||0)-(parseInt(e(t).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,n.top+(i?Math.max(t.scrollHeight,t.offsetHeight):t.offsetHeight)-(parseInt(e(t).css("borderTopWidth"),10)||0)-(parseInt(e(t).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top])},_convertPositionTo:function(t,n){n||(n=this.position);var i="absolute"===t?1:-1,a="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,r=/(html|body)/i.test(a[0].tagName);return{top:n.top+this.offset.relative.top*i+this.offset.parent.top*i-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():r?0:a.scrollTop())*i,left:n.left+this.offset.relative.left*i+this.offset.parent.left*i-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():r?0:a.scrollLeft())*i}},_generatePosition:function(t){var n,i,a=this.options,r=t.pageX,s=t.pageY,o="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,l=/(html|body)/i.test(o[0].tagName);return"relative"!==this.cssPosition||this.scrollParent[0]!==document&&this.scrollParent[0]!==this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset()),this.originalPosition&&(this.containment&&(t.pageX-this.offset.click.left<this.containment[0]&&(r=this.containment[0]+this.offset.click.left),t.pageY-this.offset.click.top<this.containment[1]&&(s=this.containment[1]+this.offset.click.top),t.pageX-this.offset.click.left>this.containment[2]&&(r=this.containment[2]+this.offset.click.left),t.pageY-this.offset.click.top>this.containment[3]&&(s=this.containment[3]+this.offset.click.top)),a.grid&&(n=this.originalPageY+Math.round((s-this.originalPageY)/a.grid[1])*a.grid[1],s=this.containment?n-this.offset.click.top>=this.containment[1]&&n-this.offset.click.top<=this.containment[3]?n:n-this.offset.click.top>=this.containment[1]?n-a.grid[1]:n+a.grid[1]:n,i=this.originalPageX+Math.round((r-this.originalPageX)/a.grid[0])*a.grid[0],r=this.containment?i-this.offset.click.left>=this.containment[0]&&i-this.offset.click.left<=this.containment[2]?i:i-this.offset.click.left>=this.containment[0]?i-a.grid[0]:i+a.grid[0]:i)),{top:s-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():l?0:o.scrollTop()),left:r-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():l?0:o.scrollLeft())}},_rearrange:function(e,t,n,i){n?n[0].appendChild(this.placeholder[0]):t.item[0].parentNode.insertBefore(this.placeholder[0],"down"===this.direction?t.item[0]:t.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var a=this.counter;this._delay(function(){a===this.counter&&this.refreshPositions(!i)})},_clear:function(e,t){function n(e,t,n){return function(i){n._trigger(e,i,t._uiHash(t))}}this.reverting=!1;var i,a=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]===this.currentItem[0]){for(i in this._storedCSS)("auto"===this._storedCSS[i]||"static"===this._storedCSS[i])&&(this._storedCSS[i]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();for(this.fromOutside&&!t&&a.push(function(e){this._trigger("receive",e,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev===this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent===this.currentItem.parent()[0]||t||a.push(function(e){this._trigger("update",e,this._uiHash())}),this!==this.currentContainer&&(t||(a.push(function(e){this._trigger("remove",e,this._uiHash())}),a.push(function(e){return function(t){e._trigger("receive",t,this._uiHash(this))}}.call(this,this.currentContainer)),a.push(function(e){return function(t){e._trigger("update",t,this._uiHash(this))}}.call(this,this.currentContainer)))),i=this.containers.length-1;i>=0;i--)t||a.push(n("deactivate",this,this.containers[i])),this.containers[i].containerCache.over&&(a.push(n("out",this,this.containers[i])),this.containers[i].containerCache.over=0);if(this.storedCursor&&(this.document.find("body").css("cursor",this.storedCursor),this.storedStylesheet.remove()),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"===this._storedZIndex?"":this._storedZIndex),this.dragging=!1,this.cancelHelperRemoval){if(!t){for(this._trigger("beforeStop",e,this._uiHash()),i=0;i<a.length;i++)a[i].call(this,e);this._trigger("stop",e,this._uiHash())}return this.fromOutside=!1,!1}if(t||this._trigger("beforeStop",e,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.helper[0]!==this.currentItem[0]&&this.helper.remove(),this.helper=null,!t){for(i=0;i<a.length;i++)a[i].call(this,e);this._trigger("stop",e,this._uiHash())}return this.fromOutside=!1,!0},_trigger:function(){e.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(t){var n=t||this;return{helper:n.helper,placeholder:n.placeholder||e([]),position:n.position,originalPosition:n.originalPosition,offset:n.positionAbs,item:n.currentItem,sender:t?t.element:null}}})}),define("widget/tageditor/input",["require","jquery"],function(e){var t=e("jquery");t.fn.tagEditorInput=function(){var e=" ",n=t(this),i=parseInt(n.css("fontSize")),a=t("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:n.css("fontSize"),fontFamily:n.css("fontFamily"),fontWeight:n.css("fontWeight"),letterSpacing:n.css("letterSpacing"),whiteSpace:"nowrap"}),r=function(e){return e>=32&&127>=e||e>=65377&&65439>=e},s=function(){var t=n.val();if(e!==(e=t)){a.html(e.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var s=a.width()+i*(r(t[t.length-1])?1:2);10>s&&(s=10),s!=n.width()&&n.width(s)}};return a.insertAfter(n),n.bind("keyup keydown focus",s),n}}),function(e){var t=document.createElement("input"),n={setSelectionRange:"setSelectionRange"in t||"selectionStart"in t,createTextRange:"createTextRange"in t||"selection"in document},i=/\r\n/g,a=/\r/g,r=function(t){return"undefined"!=typeof t.value?t.value:e(t).text()},s=function(t,n){"undefined"!=typeof t.value?t.value=n:e(t).text(n)},o=function(e,t){var n=r(e).replace(a,""),i=n.length;return"undefined"==typeof t&&(t=i),t=Math.floor(t),0>t&&(t=i+t),0>t&&(t=0),t>i&&(t=i),t},l=function(e,t){return e.hasAttribute?e.hasAttribute(t):"undefined"!=typeof e[t]},c=function(e,t,n,i){this.start=e||0,this.end=t||0,this.length=n||0,this.text=i||""};c.prototype.toString=function(){return JSON.stringify(this,null,"    ")};var d=function(e){return e.selectionStart},u=function(e){var t,n,a,s,o,l;return e.focus(),e.focus(),n=document.selection.createRange(),n&&n.parentElement()===e?(s=r(e),o=s.length,a=e.createTextRange(),a.moveToBookmark(n.getBookmark()),l=e.createTextRange(),l.collapse(!1),t=a.compareEndPoints("StartToEnd",l)>-1?s.replace(i,"\n").length:-a.moveStart("character",-o)):0},p=function(e){return e?n.setSelectionRange?d(e):n.createTextRange?u(e):void 0:void 0},m=function(e,t){e.setSelectionRange(t,t)},h=function(e,t){var n=e.createTextRange();n.move("character",t),n.select()},f=function(e,t){e.focus(),t=o(e,t),n.setSelectionRange?m(e,t):n.createTextRange&&h(e,t)},v=function(e,t){var n=p(e),i=r(e).replace(a,""),o=+(n+t.length+(i.length-n)),c=+e.getAttribute("maxlength");if(l(e,"maxlength")&&o>c){var d=t.length-(o-c);t=t.substr(0,d)}s(e,i.substr(0,n)+t+i.substr(n)),f(e,n+t.length)},g=function(e){var t=new c;t.start=e.selectionStart,t.end=e.selectionEnd;var n=Math.min(t.start,t.end),i=Math.max(t.start,t.end);return t.length=i-n,t.text=r(e).substring(n,i),t},b=function(e){var t=new c;e.focus();var n=document.selection.createRange();if(n&&n.parentElement()===e){var i,a,s,o,l=0,d=0,u=r(e);i=u.length,a=u.replace(/\r\n/g,"\n"),s=e.createTextRange(),s.moveToBookmark(n.getBookmark()),o=e.createTextRange(),o.collapse(!1),s.compareEndPoints("StartToEnd",o)>-1?l=d=i:(l=-s.moveStart("character",-i),l+=a.slice(0,l).split("\n").length-1,s.compareEndPoints("EndToEnd",o)>-1?d=i:(d=-s.moveEnd("character",-i),d+=a.slice(0,d).split("\n").length-1)),l-=u.substring(0,l).split("\r\n").length-1,d-=u.substring(0,d).split("\r\n").length-1,t.start=l,t.end=d,t.length=t.end-t.start,t.text=a.substr(t.start,t.length)}return t},_=function(e){return e?n.setSelectionRange?g(e):n.createTextRange?b(e):void 0:void 0},y=function(e,t,n){e.setSelectionRange(t,n)},w=function(e,t,n){var i=e.createTextRange();i.moveEnd("textedit",-1),i.moveStart("character",t),i.moveEnd("character",n-t),i.select()},x=function(e,t,i){t=o(e,t),i=o(e,i),n.setSelectionRange?y(e,t,i):n.createTextRange&&w(e,t,i)},C=function(t,n){var i=e(t),a=i.val(),r=_(t),s=+(r.start+n.length+(a.length-r.end)),o=+i.attr("maxlength");if(i.is("[maxlength]")&&s>o){var l=n.length-(s-o);n=n.substr(0,l)}var c=a.substr(0,r.start),d=a.substr(r.end);i.val(c+n+d);var u=r.start,p=u+n.length;x(t,r.length?u:p,p)},k=function(e){var t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)},S=function(e){var t=document.body.createTextRange();t.moveToElementText(e),t.select()},T=function(t){var i=e(t);return i.is("input, textarea")||t.select?void i.select():void(n.setSelectionRange?k(t):n.createTextRange&&S(t))},j=function(){document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()};e.extend(e.fn,{caret:function(){var e=this.filter("input, textarea");if(0===arguments.length){var t=e.get(0);return p(t)}if("number"==typeof arguments[0]){var n=arguments[0];e.each(function(e,t){f(t,n)})}else{var i=arguments[0];e.each(function(e,t){v(t,i)})}return this},range:function(){var e=this.filter("input, textarea");if(0===arguments.length){var t=e.get(0);return _(t)}if("number"==typeof arguments[0]){var n=arguments[0],i=arguments[1];e.each(function(e,t){x(t,n,i)})}else{var a=arguments[0];e.each(function(e,t){C(t,a)})}return this},selectAll:function(){return this.each(function(e,t){T(t)})}}),e.extend(e,{deselectAll:function(){return j(),this}})}(window.jQuery||window.$),define("widget/caret/jquery.caret",function(){}),define("widget/tageditor/contextMenu",["require","exports","module","jquery"],function(e,t,n){function i(e){return r=e.$menu=m.createList(e),s=e.$layer=m.createLayer(e),!0}function a(){return r.remove(),s.remove(),r=s=null,!0}var r,s,o=e("jquery"),l=o(window),c=".contextmenu",d=!1,u={selector:null,items:{},appendTo:document.body,context:document,zIndex:99,classNames:{list:"context-menu-list",item:"context-menu-item",itemhint:"context-menu-item-hint",layer:"context-menu-layer",disabled:"context-menu-disabled",separator:"context-menu-separator"},callback:o.noop},p={abort:function(e){e.preventDefault(),e.stopImmediatePropagation()},contextMenu:function(e){var t=e.data;t.$trigger=o(e.target),t.excludeSubSelector&&t.$trigger.closest(t.excludeSubSelector).length>0||(p.abort(e),m.show(t,e.clientX,e.clientY))},select:function(e){var t=e.data,n=o(e.currentTarget);return n.hasClass(t.classNames.disabled)?!1:void(t.callback.call(t.$trigger,n.data("key"),t)!==!1&&m.hide(t))},close:function(e){m.hide(e.data)}},m={createList:function(e){var t=o("<ul>").addClass(e.classNames.list);return o.each(e.items,function(n,i){"string"==typeof i&&i.indexOf("---")>-1?o("<li>").addClass(e.classNames.separator).appendTo(t):o("<li>").addClass(e.classNames.item+(i.disabled&&" "+e.classNames.disabled||"")).data("key",n).append(o("<span>").text(i.text),o("<span>").addClass(e.classNames.itemhint).text(i.hint)).appendTo(t)}),t.appendTo(e.appendTo).offset({top:-999}).hide()},createLayer:function(e){var t=o("<div>").addClass(e.classNames.layer).css({position:"fixed",zIndex:e.zIndex-1,top:"0px",left:"0px",opacity:"0",height:l.height(),width:l.width(),display:"none",backgroundColor:"rgb(0, 0, 0)"});return t.appendTo(e.appendTo)},show:function(e,t,n){e.$layer.show(),e.$menu.show().css({top:n,left:t,zIndex:e.zIndex})},hide:function(e){e.$layer.hide(),e.$menu.hide()}};o.contextMenu=function(e,t){"string"!=typeof e&&(t=e,e="create");var n=o.extend(!0,{},u,t||{}),r=o(n.context).first(),s="."+n.classNames.item;switch(n.ns=c,e){case"create":if(!n.selector)throw new Error("No selector specified");if(!n.items||o.isEmptyObject(n.items))throw new Error("No Items specified");d||(d=i(n),r.on("contextmenu"+n.ns,n.selector,n,p.contextMenu),n.$menu.on("click"+n.ns,s,n,p.select),n.$menu.on("contextmenu"+n.ns,s,n,p.abort),n.$layer.on("click"+n.ns,n,p.close),n.$layer.on("contextmenu"+n.ns,n,p.abort));break;case"destroy":r.off(n.ns),d=a(n)}},n.exports=function(e,t,n,i){o.contextMenu({selector:e,callback:function(e,t){this.trigger(n,[e,t])},items:t,excludeSubSelector:i})}}),define("widget/tageditor/tageditor",["require","jquery.ui/sortable","./input","jquery.caret","jquery","./contextMenu","util/index"],function(e){e("jquery.ui/sortable"),e("./input"),e("jquery.caret");var t=e("jquery"),n=e("./contextMenu"),i=e("util/index");t.fn.tagEditor=function(e,n,a){function r(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/&lt;(.+?)&gt;/gi,"<span>&lt;$1&gt;</span>")}function s(e){return e.replace(/&amp;/gi,"&").replace(/(&quot;|&#034;|&#34;)/gi,'"').replace(/(&#039;|&#39;)/gi,"'").replace(/&nbsp;/gi," ").replace(/<span>(.+?)<\/span>/gi,"$1").replace(/&lt;/gi,"<").replace(/&gt;/gi,">")}function o(e,n,a){var o,l,d=e.data("tags")||[],p=t("<div>");if(!a||!a.length)return!1;for(a="array"===t.type(a)?a:[a],l=0;l<a.length;l++)o=t.trim(a[l].replace(/ +/," ")),o&&(b.forceLowercase&&(o=o.toLowerCase()),~t.inArray(o,d)&&t(".tag-editor-tag",e).each(function(){s(t(this).html())==o&&t(this).closest("li").remove()}),t(u).toggleClass("error",b.checkEmail&&!i.Email.test(i.Email.parseAddress(o))).find(".tag-editor-tag").html(r(o)).end().appendTo(p));e.append(p.html()),p=null,c(e,n)}function l(e,n,i){return i&&0!==i.length?(t.each(i,function(n,i){t(".tag-editor-tag",e).each(function(){s(t(this).html())==i&&t(this).closest("li").remove()})}),void c(e,n)):!1}function c(e,n){var i=t(".tag-editor-tag:not(.deleted)",e).map(function(e,n){var i=t.trim(t(this).hasClass("active")?t(this).find(g).val():t(n).text());return i?i:void 0}).get();e.data("tags",i),n.val(i.join(b.delimiter[0]))}function d(e){if(8==e.which||46==e.which||e.ctrlKey&&88==e.which){try{var n=getSelection(),i=t(n.getRangeAt(0).commonAncestorContainer)}catch(e){i=0}if(i&&i.hasClass("tag-editor")){for(var a=[],r=n.toString().split(i.prev().data("options").dregex),s=0;s<r.length;s++){var o=t.trim(r[s]);o&&a.push(o)}t(".tag-editor-tag",i).each(function(){~t.inArray(t(this).html(),a)&&t(this).closest("li").find(".tag-editor-delete").click()})}}}var u,p,m,h,f,v,g,b=t.extend({},t.fn.tagEditor.defaults,e),_=this,y={};return b.dregex=new RegExp("["+b.delimiter.replace("-","-")+"]","g"),u='<li class="tag-editor-li"><div class="tag-editor-tag" unselectable="on"></div><div class="tag-editor-delete"> '+(b.eventTrigger.editorDeleteClick?"<i></i>":"&nbsp;")+'</div><div class="tag-editor-spacer">&nbsp;'+b.delimiter[0]+"</div></li>",p='<textarea style="width: 10px" maxlength="'+b.maxLength+'" ></textarea>',g="textarea","string"==typeof e?(m=[],_.each(function(){var i=t(this),r=i.next(".tag-editor");switch(e){case"getTags":m.push({field:i[0],editor:r,tags:r.data("tags")});break;case"addTags":o(r,i,n),a?t(".placeholder",r).remove():r.click();break;case"removeTags":l(r,i,n),a||r.click();break;case"updateTags":var s=r.data("tags")||[],d=[];t.each(s,function(e,i){-1===t.inArray(i,n)&&d.push(i)}),l(r,i,d),o(r,i,n),c(r,i),a||r.click();break;case"destroy":i.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}}),"getTags"===e?m:this):(window.getSelection&&t(document).off("keydown.tag-editor").on("keydown.tag-editor",d),_.each(function(){function e(e){var n=function(e,t){return e.hasClass("hover")||e.offset().left<t.clientX&&t.clientX<e.offset().left+e.outerWidth()},i=function(e,t){return Math.abs(e-t)<14},a=function(e){var t=22,n=y.clientY;if(Math.abs(e.clientY-n)>t/2){if(e.clientY>y.offsetTop)return!0}else if(e.clientX>y.offsetLeft)return!0;return!1},r=t(".tag-editor-li",w),s=a(e)?r:t(r.get().reverse()),o=!1,l=!1,c=-1,d=-1,u=-1;return s.each(function(a){if(o){if(i(e.clientY,t(this).offset().top+14)){if(n(t(this),e))return d=a,l=!0,!1;u=a}}else if(t(this).hasClass("active"))return c=a+1,o=!0,!0}),l||(i(e.clientY,y.clientY)?-1===d&&-1===u&&(d=c-1):d=i(y.clientY,v.clientY)?u:c-1),s.slice(c,d+1)}function n(){!b.placeholder||k.length||t(".deleted, .placeholder, input, textarea",w).length||w.append('<li class="placeholder tag-editor-li"><div>'+b.placeholder+"</div></li>")}function a(e){var i=k.toString();k=t(".tag-editor-tag:not(.deleted)",w).map(function(e,n){var i=t.trim(t(this).hasClass("active")?t(this).find(g).val():t(n).text());return i?i:void 0}).get(),w.data("tags",k),C.val(k.join(b.delimiter[0])),e||i!=k.toString()&&b.onChange(C,w,k),n()}function o(e){var n,o,c,d,p=e.closest("li"),m=l(e.val().replace(/ +/," ")),h=e.data("oldTag"),f=k.slice(0);if(1!=m.length||!b.checkEmail||i.Email.test(i.Email.parseAddress(m[0]))){for(n=0;n<m.length;n++)o=t.trim(m[n]).slice(0,b.maxLength),o&&(b.forceLowercase&&(o=o.toLowerCase()),o=b.beforeTagSave(C,w,f,h,o)||o,d=i.Email.parseAddress(o),~t.inArray(o,f)&&t(".tag-editor-tag",w).each(function(){i.Email.parseAddress(s(t(this).html()))==d&&t(this).closest("li").remove()}),f.push(o),c=t(u).find(".tag-editor-tag").html(r(o)).end(),b.checkEmail&&!i.Email.test(i.Email.parseAddress(o))?p.before(c.addClass("error")):p.before(c));e.attr("maxlength",b.maxLength).removeData("oldTag").val("").focus(),p.removeClass("error"),a()}}function l(e){b.enableSecurityLevel&&(e=i.securityLevel.formatContactList(e));var n=i.Email.parse(e),a=[];return t.each(n,function(e,t){a.push(t.toString(b.enableSecurityLevel))}),a}function c(){x.focus().select()}function d(){w.find("li.tag-editor-li").addClass("selected"),c(null)}function m(e){return e.length>0?(e.each(function(){t(this).find(".tag-editor-delete").click()}),!0):void 0}var w,x,C=t(this),k=[];w=t("<ul "+(b.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(C),
C.addClass("tag-editor-hidden-src").data("options",b).on("focus.tag-editor",function(){w.click()}),w.append('<li style="width:1px;" class="f-usn tag-editor-li-ph" unselectable="on">&nbsp;</li>'),x=t('<div id="tag-editor-texthelper"><textarea tabindex="-1"></textarea></div>').css({position:"absolute",left:"-9999px",top:"-9999px"}).insertAfter(w).find("textarea"),w.on("mousemove",function(n){if(b.eventTrigger.mousemove){var i,a=""!==w.find(g).val();1===n.which&&f&&!a&&(w.find("li.selected").removeClass("selected"),i=e(n),i.length>0&&(w.focus(),t.each(i,function(){t(this).addClass("selected")})))}}),w.on("mouseup",function(){b.eventTrigger.mouseup&&(f=!1,w.find(".tag-editor-li.selected .tag-editor-tag:not(.active)").length>0&&c())}),w.on("mousemove",".tag-editor-spacer",function(e){b.eventTrigger.editorSpacerMousemove&&e.stopPropagation()}),w.on("mousedown",function(e,n,i){if(b.eventTrigger.mousedown){var a,r,s=99999;b.onClick(C,w),f=!0,/tag-editor-spacer|ui-sortable/g.test(e.target.className)&&(_.next(".tag-editor").find(".selected").removeClass("selected"),t(".placeholder",w).remove(),n=n&&t(n),n&&n.length?i=i||"after":t(".tag-editor-tag",w).each(function(){var r=t(this),o=r.offset(),l=o.left,c=o.top;e.pageY>=c&&e.pageY<=c+r.height()&&(e.pageX<l?(i="before",a=l-e.pageX):(i="after",a=e.pageX-l-r.width()),s>a&&(s=a,n=r))}),"before"===i?t(u).insertBefore(n.closest("li")).find(".tag-editor-tag").dblclick():"after"===i?t(u).insertAfter(n.closest("li")).find(".tag-editor-tag").dblclick():t(u).appendTo(w).find(".tag-editor-tag").dblclick(),r=t(w).find(".tag-editor-li.active"),v={clientX:e.clientX,clientY:e.clientY},y={clientX:r.offset().left+r.outerWidth()/2,clientY:r.offset().top+r.outerHeight()/2,offsetTop:r.offset().top,offsetLeft:r.offset().left})}}),w.on("click",".tag-editor-delete",function(){if(b.eventTrigger.editorDeleteClick){if(t(this).prev().hasClass("active"))return t(this).closest("li").find(g).caret(-1),!1;var e=t(this).closest("li"),i=e.find(".tag-editor-tag");return b.beforeTagDelete(C,w,k,i.html())===!1?!1:(i.addClass("deleted").animate({width:0},100,function(){e.remove(),n()}),a(),!1)}}),b.clickDelete&&w.on("mousedown",".tag-editor-tag",function(e){if(e.which>1){var i=t(this).closest("li"),r=i.find(".tag-editor-tag");return b.beforeTagDelete(C,w,k,r.html())===!1?!1:(r.addClass("deleted").animate({width:0},100,function(){i.remove(),n()}),a(),!1)}}),w.on("click",".tag-editor-tag",function(e){return b.clickDelete&&e.which>1?!1:(e.ctrlKey||e.metaKey?t(this).closest("li").toggleClass("selected"):(_.not(C).next(".tag-editor").find(".selected").removeClass("selected"),t(this).hasClass("active")||w.click(),t(this).closest("li").addClass("selected").siblings().removeClass("selected")),!t(this).hasClass("active")&&c(null),!1)}),w.on("dblclick",".tag-editor-tag",function(e){if(b.eventTrigger.tagDblclick){if(!t(this).hasClass("active")){var n=t(this).html(),a="";if(b.enableSecurityLevel){var r=i.securityLevel.departSLFromAddress(n);a=r.securityLevel,n=r.address}var o=Math.abs((t(this).offset().left-e.pageX)/t(this).width()),l=parseInt(n.length*o),c=t(this).html(p).addClass("active").find(g).val(s(n));if(t(this).closest("li").addClass("active"),setTimeout(function(){c.data({oldTag:n,securityLevel:a}).tagEditorInput().focus().caret(l)},0),b.autocomplete){var d=t.extend({},b.autocomplete),u="select"in d?b.autocomplete.select:"";d.select=function(){u&&u(),setTimeout(function(){t(".active",w).find(g).focus()},20)},c.autocomplete(d)}if(b.contactac){var m=t.extend({enableSecurityLevel:b.enableSecurityLevel},b.contactac),h="select"in m?b.contactac.select:"";m.select=function(e){h&&h(),setTimeout(function(){var n=t(".tag-editor-tag",w).filter(function(){return s(t(this).html())==e.target});n.length&&i.Email.test(e.target)&&n.closest("li").removeClass("error"),w.trigger("mousedown",n)},20)},w.contactacInstance=c.contactac(m)[0].contactacInstance}}return!1}}),w.on("mouseenter",".tag-editor-tag",function(){t(this).closest("li").addClass("hover"),b.onMouseEnter(C,w,k,t(this).html())}),w.on("mouseleave",".tag-editor-tag",function(){t(this).closest("li").removeClass("hover"),b.onMouseLeave(C,w,k,t(this).html())}),w.on(b.ctxClickEvent,function(e,t){var n=i.detector.isClipboardSupport(),a="oldie"===n;switch(t){case"all":d();break;case"delete":m(w.find(".tag-editor-li.selected"));break;case"cut":c(),a?(window.clipboardData.setData("Text",x.val()),x.trigger("cut")):n&&document.execCommand("cut");break;case"copy":c(),a?(window.clipboardData.setData("Text",x.val()),x.trigger("copy")):n&&document.execCommand("copy");break;case"paste":var r=a?window.clipboardData.getData("Text"):window.prompt(i.i18n.t("mail/clipboard_paste_safe_hint"),"");w.trigger("mousedown"),w.find(".tag-editor-tag.active "+g).val(r).trigger("paste")}}),w.on("blur",g,function(){var e,l=t(this),c=l.data("oldTag"),d=t.trim(l.val().replace(/ +/," ").replace(b.dregex,b.delimiter[0]).replace(//g,".")),u="",p=null,m="";if(b.enableSecurityLevel&&(u=l.data("securityLevel"),p=i.securityLevel.departSLFromAddress(d,1,s(c||"")),m=p.securityLevel,d=p.address),b.onBlur(C,w),d){if(d.indexOf(b.delimiter[0])>=0)return void o(l);d!=c&&(b.forceLowercase&&(d=d.toLowerCase()),d=b.beforeTagSave(C,w,k,c,d)||d,e=i.Email.parseAddress(d),t(".tag-editor-tag:not(.active)",w).each(function(){i.Email.parseAddress(s(t(this).html()))==e&&t(this).closest("li").remove()}),d=e===i.Email.parseAddress(s(c))?u+d:m+d)}else{if(c&&b.beforeTagDelete(C,w,k,c)===!1)return l.val(c).focus(),h=!1,void a();try{l.closest("li").remove()}catch(f){}c&&a()}var v=l.parent().html(r(d)).removeClass("active").closest("li");v.removeClass("active"),b.checkEmail&&!i.Email.test(d)?v.addClass("error"):v.removeClass("error"),d!=c&&a(),n()});var S;w.on("paste",g,function(){t(this).removeAttr("maxlength"),S=t(this),setTimeout(function(){var e,n;e=S.val().split(/\u0009|\u000A/g),e=t.grep(e,function(e){return e.length>0}),n=e.join(b.delimiter[0]),S.val(n),o(S)},20)});var T;w.on("keypress",g,function(e){b.delimiter.indexOf(String.fromCharCode(e.which))>=0&&(T=t(this),setTimeout(function(){o(T)},20))}),w.on("keydown",g,function(e){var n,i,a,r=t(this);if(e.ctrlKey||e.metaKey){if((window.getSelection&&getSelection().toString()||document.selection&&document.selection.createRange().text)&&!x.val())return!0;if(r.val())return!0;if(65==e.which)return d(),!0}if(!(37!=e.which&&(b.autocomplete||b.contactac||38!=e.which)||r.caret()))return n=r.closest("li").prev("li").find(".tag-editor-tag"),n.length&&t(u).insertBefore(n.closest("li")).find(".tag-editor-tag").dblclick(),!1;if((39==e.which||!b.autocomplete&&!b.contactac&&40==e.which)&&r.caret()==r.val().length)return i=r.closest("li").next("li").find(".tag-editor-tag"),i.length?t(u).insertAfter(i.closest("li")).find(".tag-editor-tag").dblclick():w.click(),!1;if(9==e.which)return e.shiftKey?(n=r.closest("li").prev("li").find(".tag-editor-tag"),n.length?(t(u).insertBefore(n.closest("li")).find(".tag-editor-tag").dblclick(),!1):(C.attr("disabled","disabled"),void setTimeout(function(){C.removeAttr("disabled")},30))):(i=r.closest("li").next("li").find(".tag-editor-tag"),i.length?t(u).insertAfter(i.closest("li")).find(".tag-editor-tag").dblclick():r.val()?w.click():_.each(function(e,n){return n==C[0]?(t(_[e+1]).next(".tag-editor").is(":visible")?t(_[e+1]).next(".tag-editor").mousedown():C.closest("form").find('input[name="subject"]').focus(),!1):void 0}),!1);if(46==e.which||8==e.which&&!r.val())return a=r.closest("li").siblings("li.tag-editor-li.selected"),a.length>0?(a.each(function(){t(this).find(".tag-editor-delete").click()}),!1):(n=r.closest("li").prev("li").find(".tag-editor-tag"),n.length&&n.closest("li").find(".tag-editor-delete").click(),!1);if(13==e.which)setTimeout(function(){o(r)},20),w.contactacInstance&&w.contactacInstance.hide(),e.preventDefault();else if(36!=e.which||r.caret()){if(35==e.which&&r.caret()==r.val().length)w.find(".tag-editor-tag").last().dblclick();else if(27==e.which)return!1}else w.find(".tag-editor-tag").first().dblclick()}),x.on("keydown",function(e){if(e.ctrlKey||e.metaKey){if((window.getSelection&&getSelection().toString()||document.selection&&document.selection.createRange().text)&&!x.val())return!1;if(65==e.which)return d(),!0;if(67==e.which||88==e.which)return!0}return 46==e.which||8==e.which?(m(w.find(".tag-editor-li.selected")),!0):!1}),x.on("cut",function(){setTimeout(function(){w.find(".tag-editor-li.selected").remove(),a(),x.val("")},20)}),x.on("focus",function(){var e=w.find(".tag-editor-li.selected"),n=e.map(function(e,n){var i=t(n).find(".tag-editor-tag").html();return i?s(i):void 0}).get().join();n&&x.val(n)});var j,I,A=b.initialTags.length?b.initialTags:l(C.val()),E=t("<div />");for(I=0;I<A.length;I++)j=t.trim(A[I].replace(/ +/," ")),j&&(b.forceLowercase&&(j=j.toLowerCase()),k.push(j),t(u).toggleClass("error",b.checkEmail&&!i.Email.test(i.Email.parseAddress(j))).find(".tag-editor-tag").html(r(j)).end().appendTo(E));A.length>0&&w.append(E.html()),E=null,a(!0),b.sortable&&t.fn.sortable&&w.sortable(t.extend({delay:150,distance:5,cancel:".tag-editor-spacer, input, textarea, .active",revert:50,cursorAt:{left:5},appendTo:document.body,containment:document.body,connectWith:".tag-editor",update:function(){setTimeout(function(){a()},300)},receive:function(){var e,n=[];t(".tag-editor-tag",w).each(function(){e=s(t(this).text()),~t.inArray(e,n)?t(this).closest("li").remove():n.push(e)}),w.data("tags",n),C.val(n.join(b.delimiter[0]))},helper:function(e,n){var i,a,r,s,o,l;return n.hasClass("selected")||n.addClass("selected").siblings().removeClass("selected"),i=n.parent().children(".selected").clone(),a=n.siblings(".selected").hide(),n.data("multidrag",i).data("siblings",a),r=t("<li />").addClass("tag-sortable-helper"),i.length>1&&b.i18n&&b.i18n.dragMsg?(s=t("<li />").append(t("<div />",{"class":"tag-editor-tag",html:b.i18n.dragMsg.replace("{0}",i.length)})),o=s.clone(),l=o.appendTo("body").css({position:"absolute",left:"-9999px",top:"-9999px"}).width(),o.remove(),r.append(s).addClass("multiple").css("width",l+10)):r.append(i),r},stop:function(e,t){try{var n=t.item.data("multidrag").removeClass("selected");t.item.data("siblings").remove(),t.item.after(n).remove()}catch(e){}}},"object"===t.type(b.sortable)?b.sortable:{}))}))},t.fn.tagEditor.defaults={initialTags:[],maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,clickDelete:!1,sortable:!0,autocomplete:null,contactac:null,checkEmail:!0,i18n:{dragMsg:"{0}"},eventTrigger:{mousemove:!0,mouseup:!0,mousedown:!0,editorSpacerMousemove:!0,editorDeleteClick:!0,tagDblclick:!0},ctxSelector:"ul.tag-editor",ctxExcludeSelector:".tag-editor-li.active",ctxClickEvent:"contextclick",enableSecurityLevel:!1,onClick:function(){},onBlur:function(){},onChange:function(){},onMouseEnter:function(){},onMouseLeave:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}},n(t.fn.tagEditor.defaults.ctxSelector,{copy:{text:i.i18n.t("mail/clipboard_copy"),hint:"Ctrl+C",disabled:!i.detector.isClipboardSupport()},cut:{text:i.i18n.t("mail/clipboard_cut"),hint:"Ctrl+X",disabled:!i.detector.isClipboardSupport()},paste:{text:i.i18n.t("mail/clipboard_paste"),hint:"Ctrl+V"},"delete":{text:i.i18n.t("mail/clipboard_delete"),hint:"Delete"},separator:"-------------",all:{text:i.i18n.t("mail/clipboard_select_all"),hint:"Ctrl+A"}},t.fn.tagEditor.defaults.ctxClickEvent,t.fn.tagEditor.defaults.ctxExcludeSelector)}),function(e){"use strict";"function"==typeof define&&define.amd?define("components/jquery-file-upload/js/jquery.iframe-transport",["jquery"],e):e("object"==typeof exports?require("jquery"):window.jQuery)}(function(e){"use strict";var t=0;e.ajaxTransport("iframe",function(n){if(n.async){var i,a,r,s=n.initialIframeSrc||"javascript:false;";return{send:function(o,l){i=e('<form style="display:none;"></form>'),i.attr("accept-charset",n.formAcceptCharset),r=/\?/.test(n.url)?"&":"?","DELETE"===n.type?(n.url=n.url+r+"_method=DELETE",n.type="POST"):"PUT"===n.type?(n.url=n.url+r+"_method=PUT",n.type="POST"):"PATCH"===n.type&&(n.url=n.url+r+"_method=PATCH",n.type="POST"),t+=1,a=e('<iframe src="'+s+'" name="iframe-transport-'+t+'"></iframe>').bind("load",function(){var t,r=e.isArray(n.paramName)?n.paramName:[n.paramName];a.unbind("load").bind("load",function(){var t;try{if(t=a.contents(),!t.length||!t[0].firstChild)throw new Error}catch(n){t=void 0}l(200,"success",{iframe:t}),e('<iframe src="'+s+'"></iframe>').appendTo(i),window.setTimeout(function(){i.remove()},0)}),i.prop("target",a.prop("name")).prop("action",n.url).prop("method",n.type),n.formData&&e.each(n.formData,function(t,n){e('<input type="hidden"/>').prop("name",n.name).val(n.value).appendTo(i)}),n.fileInput&&n.fileInput.length&&"POST"===n.type&&(t=n.fileInput.clone(),n.fileInput.after(function(e){return t[e]}),n.paramName&&n.fileInput.each(function(t){e(this).prop("name",r[t]||n.paramName)}),i.append(n.fileInput).prop("enctype","multipart/form-data").prop("encoding","multipart/form-data"),n.fileInput.removeAttr("form")),i.submit(),t&&t.length&&n.fileInput.each(function(n,i){var a=e(t[n]);e(i).prop("name",a.prop("name")).attr("form",a.attr("form")),a.replaceWith(i)})}),i.append(a).appendTo(document.body)},abort:function(){a&&a.unbind("load").prop("src",s),i&&i.remove()}}}}),e.ajaxSetup({converters:{"iframe text":function(t){return t&&e(t[0].body).text()},"iframe json":function(t){return t&&e.parseJSON(e(t[0].body).text())},"iframe html":function(t){return t&&e(t[0].body).html()},"iframe xml":function(t){var n=t&&t[0];return n&&e.isXMLDoc(n)?n:e.parseXML(n.XMLDocument&&n.XMLDocument.xml||e(n.body).html())},"iframe script":function(t){return t&&e.globalEval(e(t[0].body).text())}}})}),function(e){"use strict";"function"==typeof define&&define.amd?define("components/jquery-file-upload/js/jquery.fileupload",["jquery","jquery.ui.widget"],e):"object"==typeof exports?e(require("jquery"),require("./vendor/jquery.ui.widget")):e(window.jQuery)}(function(e){"use strict";function t(t){var n="dragover"===t;return function(i){i.dataTransfer=i.originalEvent&&i.originalEvent.dataTransfer;var a=i.dataTransfer;a&&-1!==e.inArray("Files",a.types)&&this._trigger(t,e.Event(t,{delegatedEvent:i}))!==!1&&(i.preventDefault(),n&&(a.dropEffect="copy"))}}e.support.fileInput=!(new RegExp("(Android (1\\.[0156]|2\\.[01]))|(Windows Phone (OS 7|8\\.0))|(XBLWP)|(ZuneWP)|(WPDesktop)|(w(eb)?OSBrowser)|(webOS)|(Kindle/(1\\.0|2\\.[05]|3\\.0))").test(window.navigator.userAgent)||e('<input type="file">').prop("disabled")),e.support.xhrFileUpload=!(!window.ProgressEvent||!window.FileReader),e.support.xhrFormDataFileUpload=!!window.FormData,e.support.blobSlice=window.Blob&&(Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice),e.widget("blueimp.fileupload",{options:{dropZone:e(document),pasteZone:void 0,fileInput:void 0,replaceFileInput:!0,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,limitMultiFileUploadSize:void 0,limitMultiFileUploadSizeOverhead:512,sequentialUploads:!1,limitConcurrentUploads:void 0,forceIframeTransport:!1,redirect:void 0,redirectParamName:void 0,postMessage:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,autoUpload:!0,messages:{uploadedBytes:"Uploaded bytes exceed file size"},i18n:function(t,n){return t=this.messages[t]||t.toString(),n&&e.each(n,function(e,n){t=t.replace("{"+e+"}",n)}),t},formData:function(e){return e.serializeArray()},add:function(t,n){return t.isDefaultPrevented()?!1:void((n.autoUpload||n.autoUpload!==!1&&e(this).fileupload("option","autoUpload"))&&n.process().done(function(){n.submit()}))},processData:!1,contentType:!1,cache:!1},_specialOptions:["fileInput","dropZone","pasteZone","multipart","forceIframeTransport"],_blobSlice:e.support.blobSlice&&function(){var e=this.slice||this.webkitSlice||this.mozSlice;return e.apply(this,arguments)},_BitrateTimer:function(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.loaded=0,this.bitrate=0,this.getBitrate=function(e,t,n){var i=e-this.timestamp;return(!this.bitrate||!n||i>n)&&(this.bitrate=(t-this.loaded)*(1e3/i)*8,this.loaded=t,this.timestamp=e),this.bitrate}},_isXHRUpload:function(t){return!t.forceIframeTransport&&(!t.multipart&&e.support.xhrFileUpload||e.support.xhrFormDataFileUpload)},_getFormData:function(t){var n;return"function"===e.type(t.formData)?t.formData(t.form):e.isArray(t.formData)?t.formData:"object"===e.type(t.formData)?(n=[],e.each(t.formData,function(e,t){n.push({name:e,value:t})}),n):[]},_getTotal:function(t){var n=0;return e.each(t,function(e,t){n+=t.size||1}),n},_initProgressObject:function(t){var n={loaded:0,total:0,bitrate:0};t._progress?e.extend(t._progress,n):t._progress=n},_initResponseObject:function(e){var t;if(e._response)for(t in e._response)e._response.hasOwnProperty(t)&&delete e._response[t];else e._response={}},_onProgress:function(t,n){if(t.lengthComputable){var i,a=Date.now?Date.now():(new Date).getTime();if(n._time&&n.progressInterval&&a-n._time<n.progressInterval&&t.loaded!==t.total)return;n._time=a,i=Math.floor(t.loaded/t.total*(n.chunkSize||n._progress.total))+(n.uploadedBytes||0),this._progress.loaded+=i-n._progress.loaded,this._progress.bitrate=this._bitrateTimer.getBitrate(a,this._progress.loaded,n.bitrateInterval),n._progress.loaded=n.loaded=i,n._progress.bitrate=n.bitrate=n._bitrateTimer.getBitrate(a,i,n.bitrateInterval),this._trigger("progress",e.Event("progress",{delegatedEvent:t}),n),this._trigger("progressall",e.Event("progressall",{delegatedEvent:t}),this._progress)}},_initProgressListener:function(t){var n=this,i=t.xhr?t.xhr():e.ajaxSettings.xhr();i.upload&&(e(i.upload).bind("progress",function(e){var i=e.originalEvent;e.lengthComputable=i.lengthComputable,e.loaded=i.loaded,e.total=i.total,n._onProgress(e,t)}),t.xhr=function(){return i})},_isInstanceOf:function(e,t){return Object.prototype.toString.call(t)==="[object "+e+"]"},_initXHRData:function(t){var n,i=this,a=t.files[0],r=t.multipart||!e.support.xhrFileUpload,s="array"===e.type(t.paramName)?t.paramName[0]:t.paramName;t.headers=e.extend({},t.headers),t.contentRange&&(t.headers["Content-Range"]=t.contentRange),r&&!t.blob&&this._isInstanceOf("File",a)||(t.headers["Content-Disposition"]='attachment; filename="'+encodeURI(a.name)+'"'),r?e.support.xhrFormDataFileUpload&&(t.postMessage?(n=this._getFormData(t),t.blob?n.push({name:s,value:t.blob}):e.each(t.files,function(i,a){n.push({name:"array"===e.type(t.paramName)&&t.paramName[i]||s,value:a})})):(i._isInstanceOf("FormData",t.formData)?n=t.formData:(n=new FormData,e.each(this._getFormData(t),function(e,t){n.append(t.name,t.value)})),t.blob?n.append(s,t.blob,a.name):e.each(t.files,function(a,r){(i._isInstanceOf("File",r)||i._isInstanceOf("Blob",r))&&n.append("array"===e.type(t.paramName)&&t.paramName[a]||s,r,r.uploadName||r.name)})),t.data=n):(t.contentType=a.type||"application/octet-stream",t.data=t.blob||a),t.blob=null},_initIframeSettings:function(t){var n=e("<a></a>").prop("href",t.url).prop("host");t.dataType="iframe "+(t.dataType||""),t.formData=this._getFormData(t),t.redirect&&n&&n!==location.host&&t.formData.push({name:t.redirectParamName||"redirect",value:t.redirect})},_initDataSettings:function(e){this._isXHRUpload(e)?(this._chunkedUpload(e,!0)||(e.data||this._initXHRData(e),this._initProgressListener(e)),e.postMessage&&(e.dataType="postmessage "+(e.dataType||""))):this._initIframeSettings(e)},_getParamName:function(t){var n=e(t.fileInput),i=t.paramName;return i?e.isArray(i)||(i=[i]):(i=[],n.each(function(){for(var t=e(this),n=t.prop("name")||"files[]",a=(t.prop("files")||[1]).length;a;)i.push(n),a-=1}),i.length||(i=[n.prop("name")||"files[]"])),i},_initFormSettings:function(t){t.form&&t.form.length||(t.form=e(t.fileInput.prop("form")),t.form.length||(t.form=e(this.options.fileInput.prop("form")))),t.paramName=this._getParamName(t),t.url||(t.url=t.form.prop("action")||location.href),t.type=(t.type||"string"===e.type(t.form.prop("method"))&&t.form.prop("method")||"").toUpperCase(),"POST"!==t.type&&"PUT"!==t.type&&"PATCH"!==t.type&&(t.type="POST"),t.formAcceptCharset||(t.formAcceptCharset=t.form.attr("accept-charset"))},_getAJAXSettings:function(t){var n=e.extend({},this.options,t);return this._initFormSettings(n),this._initDataSettings(n),n},_getDeferredState:function(e){return e.state?e.state():e.isResolved()?"resolved":e.isRejected()?"rejected":"pending"},_enhancePromise:function(e){return e.success=e.done,e.error=e.fail,e.complete=e.always,e},_getXHRPromise:function(t,n,i){var a=e.Deferred(),r=a.promise();return n=n||this.options.context||r,t===!0?a.resolveWith(n,i):t===!1&&a.rejectWith(n,i),r.abort=a.promise,this._enhancePromise(r)},_addConvenienceMethods:function(t,n){var i=this,a=function(t){return e.Deferred().resolveWith(i,t).promise()};n.process=function(t,r){return(t||r)&&(n._processQueue=this._processQueue=(this._processQueue||a([this])).pipe(function(){return n.errorThrown?e.Deferred().rejectWith(i,[n]).promise():a(arguments)}).pipe(t,r)),this._processQueue||a([this])},n.submit=function(){return"pending"!==this.state()&&(n.jqXHR=this.jqXHR=i._trigger("submit",e.Event("submit",{delegatedEvent:t}),this)!==!1&&i._onSend(t,this)),this.jqXHR||i._getXHRPromise()},n.abort=function(){return this.jqXHR?this.jqXHR.abort():(this.errorThrown="abort",i._trigger("fail",null,this),i._getXHRPromise(!1))},n.state=function(){return this.jqXHR?i._getDeferredState(this.jqXHR):this._processQueue?i._getDeferredState(this._processQueue):void 0},n.processing=function(){return!this.jqXHR&&this._processQueue&&"pending"===i._getDeferredState(this._processQueue)},n.progress=function(){return this._progress},n.response=function(){return this._response}},_getUploadedBytes:function(e){var t=e.getResponseHeader("Range"),n=t&&t.split("-"),i=n&&n.length>1&&parseInt(n[1],10);return i&&i+1},_chunkedUpload:function(t,n){t.uploadedBytes=t.uploadedBytes||0;var i,a,r=this,s=t.files[0],o=s.size,l=t.uploadedBytes,c=t.maxChunkSize||o,d=this._blobSlice,u=e.Deferred(),p=u.promise();return this._isXHRUpload(t)&&d&&(l||o>c)&&!t.data?n?!0:l>=o?(s.error=t.i18n("uploadedBytes"),this._getXHRPromise(!1,t.context,[null,"error",s.error])):(a=function(){var n=e.extend({},t),p=n._progress.loaded;n.blob=d.call(s,l,l+c,s.type),n.chunkSize=n.blob.size,n.contentRange="bytes "+l+"-"+(l+n.chunkSize-1)+"/"+o,r._initXHRData(n),r._initProgressListener(n),i=(r._trigger("chunksend",null,n)!==!1&&e.ajax(n)||r._getXHRPromise(!1,n.context)).done(function(i,s,c){l=r._getUploadedBytes(c)||l+n.chunkSize,p+n.chunkSize-n._progress.loaded&&r._onProgress(e.Event("progress",{lengthComputable:!0,loaded:l-n.uploadedBytes,total:l-n.uploadedBytes}),n),t.uploadedBytes=n.uploadedBytes=l,n.result=i,n.textStatus=s,n.jqXHR=c,r._trigger("chunkdone",null,n),r._trigger("chunkalways",null,n),o>l?a():u.resolveWith(n.context,[i,s,c])}).fail(function(e,t,i){n.jqXHR=e,n.textStatus=t,n.errorThrown=i,r._trigger("chunkfail",null,n),r._trigger("chunkalways",null,n),u.rejectWith(n.context,[e,t,i])})},this._enhancePromise(p),p.abort=function(){return i.abort()},a(),p):!1},_beforeSend:function(e,t){0===this._active&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer,this._progress.loaded=this._progress.total=0,this._progress.bitrate=0),this._initResponseObject(t),this._initProgressObject(t),t._progress.loaded=t.loaded=t.uploadedBytes||0,t._progress.total=t.total=this._getTotal(t.files)||1,t._progress.bitrate=t.bitrate=0,this._active+=1,this._progress.loaded+=t.loaded,this._progress.total+=t.total},_onDone:function(t,n,i,a){var r=a._progress.total,s=a._response;a._progress.loaded<r&&this._onProgress(e.Event("progress",{lengthComputable:!0,loaded:r,total:r}),a),s.result=a.result=t,s.textStatus=a.textStatus=n,s.jqXHR=a.jqXHR=i,this._trigger("done",null,a)},_onFail:function(e,t,n,i){var a=i._response;i.recalculateProgress&&(this._progress.loaded-=i._progress.loaded,this._progress.total-=i._progress.total),a.jqXHR=i.jqXHR=e,a.textStatus=i.textStatus=t,a.errorThrown=i.errorThrown=n,this._trigger("fail",null,i)},_onAlways:function(e,t,n,i){this._trigger("always",null,i)},_onSend:function(t,n){n.submit||this._addConvenienceMethods(t,n);var i,a,r,s,o=this,l=o._getAJAXSettings(n),c=function(){return o._sending+=1,l._bitrateTimer=new o._BitrateTimer,i=i||((a||o._trigger("send",e.Event("send",{delegatedEvent:t}),l)===!1)&&o._getXHRPromise(!1,l.context,a)||o._chunkedUpload(l)||e.ajax(l)).done(function(e,t,n){o._onDone(e,t,n,l)}).fail(function(e,t,n){o._onFail(e,t,n,l)}).always(function(e,t,n){if(o._onAlways(e,t,n,l),o._sending-=1,o._active-=1,l.limitConcurrentUploads&&l.limitConcurrentUploads>o._sending)for(var i=o._slots.shift();i;){if("pending"===o._getDeferredState(i)){i.resolve();break}i=o._slots.shift()}0===o._active&&o._trigger("stop")})};return this._beforeSend(t,l),this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending?(this.options.limitConcurrentUploads>1?(r=e.Deferred(),this._slots.push(r),s=r.pipe(c)):(this._sequence=this._sequence.pipe(c,c),s=this._sequence),s.abort=function(){return a=[void 0,"abort","abort"],i?i.abort():(r&&r.rejectWith(l.context,a),c())},this._enhancePromise(s)):c()},_onAdd:function(t,n){var i,a,r,s,o=this,l=!0,c=e.extend({},this.options,n),d=n.files,u=d.length,p=c.limitMultiFileUploads,m=c.limitMultiFileUploadSize,h=c.limitMultiFileUploadSizeOverhead,f=0,v=this._getParamName(c),g=0;if(!m||u&&void 0!==d[0].size||(m=void 0),(c.singleFileUploads||p||m)&&this._isXHRUpload(c))if(c.singleFileUploads||m||!p)if(!c.singleFileUploads&&m)for(r=[],i=[],s=0;u>s;s+=1)f+=d[s].size+h,(s+1===u||f+d[s+1].size+h>m||p&&s+1-g>=p)&&(r.push(d.slice(g,s+1)),a=v.slice(g,s+1),a.length||(a=v),i.push(a),g=s+1,f=0);else i=v;else for(r=[],i=[],s=0;u>s;s+=p)r.push(d.slice(s,s+p)),a=v.slice(s,s+p),a.length||(a=v),i.push(a);else r=[d],i=[v];return n.originalFiles=d,e.each(r||d,function(a,s){var c=e.extend({},n);return c.files=r?s:[s],c.paramName=i[a],o._initResponseObject(c),o._initProgressObject(c),o._addConvenienceMethods(t,c),l=o._trigger("add",e.Event("add",{delegatedEvent:t}),c)}),l},_replaceFileInput:function(t){var n=t.fileInput,i=n.clone(!0);t.fileInputClone=i,e("<form></form>").append(i)[0].reset(),n.after(i).detach(),e.cleanData(n.unbind("remove")),this.options.fileInput=this.options.fileInput.map(function(e,t){return t===n[0]?i[0]:t}),n[0]===this.element[0]&&(this.element=i)},_handleFileTreeEntry:function(t,n){var i,a=this,r=e.Deferred(),s=function(e){e&&!e.entry&&(e.entry=t),r.resolve([e])},o=function(e){a._handleFileTreeEntries(e,n+t.name+"/").done(function(e){r.resolve(e)}).fail(s)},l=function(){i.readEntries(function(e){e.length?(c=c.concat(e),l()):o(c)},s)},c=[];return n=n||"",t.isFile?t._file?(t._file.relativePath=n,r.resolve(t._file)):t.file(function(e){e.relativePath=n,r.resolve(e)},s):t.isDirectory?(i=t.createReader(),l()):r.resolve([]),r.promise()},_handleFileTreeEntries:function(t,n){var i=this;return e.when.apply(e,e.map(t,function(e){return i._handleFileTreeEntry(e,n)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(t){t=t||{};var n=t.items;return n&&n.length&&(n[0].webkitGetAsEntry||n[0].getAsEntry)?this._handleFileTreeEntries(e.map(n,function(e){var t;return e.webkitGetAsEntry?(t=e.webkitGetAsEntry(),t&&(t._file=e.getAsFile()),t):e.getAsEntry()})):e.Deferred().resolve(e.makeArray(t.files)).promise()},_getSingleFileInputFiles:function(t){t=e(t);var n,i,a=t.prop("webkitEntries")||t.prop("entries");if(a&&a.length)return this._handleFileTreeEntries(a);if(n=e.makeArray(t.prop("files")),n.length)void 0===n[0].name&&n[0].fileName&&e.each(n,function(e,t){t.name=t.fileName,t.size=t.fileSize});else{if(i=t.prop("value"),!i)return e.Deferred().resolve([]).promise();n=[{name:i.replace(/^.*\\/,"")}]}return e.Deferred().resolve(n).promise()},_getFileInputFiles:function(t){return t instanceof e&&1!==t.length?e.when.apply(e,e.map(t,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],arguments)}):this._getSingleFileInputFiles(t)},_onChange:function(t){var n=this,i={fileInput:e(t.target),form:e(t.target.form)};this._getFileInputFiles(i.fileInput).always(function(a){i.files=a,n.options.replaceFileInput&&n._replaceFileInput(i),n._trigger("change",e.Event("change",{delegatedEvent:t}),i)!==!1&&n._onAdd(t,i)})},_onPaste:function(t){var n=t.originalEvent&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items,i={files:[]};n&&n.length&&(e.each(n,function(e,t){var n=t.getAsFile&&t.getAsFile();n&&i.files.push(n)}),this._trigger("paste",e.Event("paste",{delegatedEvent:t}),i)!==!1&&this._onAdd(t,i))},_onDrop:function(t){t.dataTransfer=t.originalEvent&&t.originalEvent.dataTransfer;var n=this,i=t.dataTransfer,a={};i&&i.files&&i.files.length&&(t.preventDefault(),this._getDroppedFiles(i).always(function(i){a.files=i,n._trigger("drop",e.Event("drop",{delegatedEvent:t}),a)!==!1&&n._onAdd(t,a)}))},_onDragOver:t("dragover"),_onDragEnter:t("dragenter"),_onDragLeave:t("dragleave"),_initEventHandlers:function(){this._isXHRUpload(this.options)&&(this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop,dragenter:this._onDragEnter,dragleave:this._onDragLeave}),this._on(this.options.pasteZone,{paste:this._onPaste})),e.support.fileInput&&this._on(this.options.fileInput,{change:this._onChange})},_destroyEventHandlers:function(){this._off(this.options.dropZone,"dragenter dragleave dragover drop"),this._off(this.options.pasteZone,"paste"),this._off(this.options.fileInput,"change")},_setOption:function(t,n){var i=-1!==e.inArray(t,this._specialOptions);i&&this._destroyEventHandlers(),this._super(t,n),i&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var t=this.options;void 0===t.fileInput?t.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]'):t.fileInput instanceof e||(t.fileInput=e(t.fileInput)),t.dropZone instanceof e||(t.dropZone=e(t.dropZone)),t.pasteZone instanceof e||(t.pasteZone=e(t.pasteZone))},_getRegExp:function(e){var t=e.split("/"),n=t.pop();return t.shift(),new RegExp(t.join("/"),n)},_isRegExpOption:function(t,n){return"url"!==t&&"string"===e.type(n)&&/^\/.*\/[igm]{0,3}$/.test(n)},_initDataAttributes:function(){var t=this,n=this.options,i=this.element.data();e.each(this.element[0].attributes,function(e,a){var r,s=a.name.toLowerCase();/^data-/.test(s)&&(s=s.slice(5).replace(/-[a-z]/g,function(e){return e.charAt(1).toUpperCase()}),r=i[s],t._isRegExpOption(s,r)&&(r=t._getRegExp(r)),n[s]=r)})},_create:function(){this._initDataAttributes(),this._initSpecialOptions(),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=0,this._initProgressObject(this),this._initEventHandlers()},active:function(){return this._active},progress:function(){return this._progress},add:function(t){var n=this;t&&!this.options.disabled&&(t.fileInput&&!t.files?this._getFileInputFiles(t.fileInput).always(function(e){t.files=e,n._onAdd(null,t)}):(t.files=e.makeArray(t.files),this._onAdd(null,t)))},send:function(t){if(t&&!this.options.disabled){if(t.fileInput&&!t.files){var n,i,a=this,r=e.Deferred(),s=r.promise();return s.abort=function(){return i=!0,n?n.abort():(r.reject(null,"abort","abort"),s)},this._getFileInputFiles(t.fileInput).always(function(e){if(!i){if(!e.length)return void r.reject();t.files=e,n=a._onSend(null,t),n.then(function(e,t,n){r.resolve(e,t,n)},function(e,t,n){r.reject(e,t,n)})}}),this._enhancePromise(s)}if(t.files=e.makeArray(t.files),t.files.length)return this._onSend(null,t)}return this._getXHRPromise(!1,t&&t.context)}})}),function(e){"use strict";"function"==typeof define&&define.amd?define("components/jquery-file-upload/js/jquery.fileupload-process",["jquery","./jquery.fileupload"],e):e("object"==typeof exports?require("jquery"):window.jQuery)}(function(e){"use strict";var t=e.blueimp.fileupload.prototype.options.add;e.widget("blueimp.fileupload",e.blueimp.fileupload,{
options:{processQueue:[],add:function(n,i){var a=e(this);i.process(function(){return a.fileupload("process",i)}),t.call(this,n,i)}},processActions:{},_processFile:function(t,n){var i=this,a=e.Deferred().resolveWith(i,[t]),r=a.promise();return this._trigger("process",null,t),e.each(t.processQueue,function(t,a){var s=function(t){return n.errorThrown?e.Deferred().rejectWith(i,[n]).promise():i.processActions[a.action].call(i,t,a)};r=r.pipe(s,a.always&&s)}),r.done(function(){i._trigger("processdone",null,t),i._trigger("processalways",null,t)}).fail(function(){i._trigger("processfail",null,t),i._trigger("processalways",null,t)}),r},_transformProcessQueue:function(t){var n=[];e.each(t.processQueue,function(){var i={},a=this.action,r=this.prefix===!0?a:this.prefix;e.each(this,function(n,a){"string"===e.type(a)&&"@"===a.charAt(0)?i[n]=t[a.slice(1)||(r?r+n.charAt(0).toUpperCase()+n.slice(1):n)]:i[n]=a}),n.push(i)}),t.processQueue=n},processing:function(){return this._processing},process:function(t){var n=this,i=e.extend({},this.options,t);return i.processQueue&&i.processQueue.length&&(this._transformProcessQueue(i),0===this._processing&&this._trigger("processstart"),e.each(t.files,function(a){var r=a?e.extend({},i):i,s=function(){return t.errorThrown?e.Deferred().rejectWith(n,[t]).promise():n._processFile(r,t)};r.index=a,n._processing+=1,n._processingQueue=n._processingQueue.pipe(s,s).always(function(){n._processing-=1,0===n._processing&&n._trigger("processstop")})})),this._processingQueue},_create:function(){this._super(),this._processing=0,this._processingQueue=e.Deferred().resolveWith(this).promise()}})}),function(){define("component/fileupload/fileupload-base",["require","components/jquery-file-upload/js/jquery.iframe-transport","components/jquery-file-upload/js/jquery.fileupload-process","jquery","module/common/globalService"],function(e){e("components/jquery-file-upload/js/jquery.iframe-transport"),e("components/jquery-file-upload/js/jquery.fileupload-process");var t=e("jquery"),n=e("module/common/globalService");t.widget("cm.fileupload",t.blueimp.fileupload,{options:{enableAutoToTrs:n.getConfig("user.supportautonormal2trs"),enableDnd:!0,uploadType:"trs"},uploadTypes:{compose:"compose",netfolder:"netfolder",trs:"trs"},fileTypes:{upload:"upload",inlined:"inlined",netfolder:"netfolder",trs:"trs",internal:"internal"},enableTrsUpload:function(){return n.getConfig("file.ispermittrs")},enableAutoComposeToTrs:function(){return this.enableTrsUpload()&&this.options.enableAutoToTrs},_checkComposeAutoToTrs:function(e){return e.uploadType===this.uploadTypes.compose&&this.enableAutoComposeToTrs()},formatFile:function(){},getFileType:function(e,t){var n,i=this.uploadTypes,a=e.uploadType,r=this.fileTypes;if(t.inlined)return r.inlined;switch(a){case i.compose:n=r.upload;break;case i.netfolder:n=r.netfolder;break;case i.trs:default:n=r.trs}return n},_initUploadMeta:function(e,t){var n=this.uploadTypes,i=t||e.uploadType||this.options.uploadType;switch(i){case n.compose:e.uploadType=i,e.composeId=this.options.composeId;break;case n.netfolder:e.uploadType=i,e.fid=this.options.fid,e.composeId="c:nf:"+e.fid;break;case n.trs:default:e.uploadType=n.trs,e.fid=this.options.trsFid,e.composeId="c:nf:"+e.fid}}})})}(),define("component/fileupload/fileupload-validate",["require","i18n!common","./fileupload-base","jquery","../../util/index","../../module/common/globalService"],function(e){function t(e){var t=n.Deferred();return i.xhr.simpleCall({query:{func:"upload:prepare",sid:a.getSid()},data:e,preprocess:!1,onlyVar:!1},function(e){"S_OK"!==e.code?t.reject(e):t.resolve(e["var"])},function(){t.reject()}),t.promise()}e("i18n!common"),e("./fileupload-base");var n=e("jquery"),i=e("../../util/index"),a=e("../../module/common/globalService");n.widget("cm.fileupload",n.cm.fileupload,{}),n.cm.fileupload.prototype.options.processQueue.push({action:"validate",always:!0,acceptFileTypes:"@",rejectFileTypes:"@",maxFileSize:"@",minFileSize:"@",maxNumberOfFiles:"@",disabled:"@disableValidation"},{action:"prepare",always:!1,disabled:"@disablePrepare"}),n.widget("cm.fileupload",n.cm.fileupload,{options:{getNumberOfFiles:n.noop,messages:{maxNumberOfFiles:"Maximum number of files exceeded",acceptFileTypes:i.i18n.t("common/upload_notallow_fileType"),maxFileSize:"File is too large",minFileSize:"File is too small",composeNotFound:i.i18n.t("mail/FA_ID_NOT_FOUND"),overflow:i.i18n.t("common/upload_overflow_size"),prepareFail:i.i18n.t("commin/upload_prepare_fail")},errorCode:{fileType:"filetype",composeNotFound:"composeIdNotFound",overflow:"overflow",prepareFail:"prepareFail"}},processActions:{validate:function(e,t){var i=a.getConfig("user.riskysuffixes");if(i.length>0&&(t.rejectFileTypes=new RegExp(".+("+i.join("|")+")$","g")),t.disabled)return e;var r,s=n.Deferred(),o=this.options,l=e.files[e.index];return l.skipProcess?e:((t.minFileSize||t.maxFileSize)&&(r=l.size),"number"===n.type(t.maxNumberOfFiles)&&(o.getNumberOfFiles()||0)+e.files.length>t.maxNumberOfFiles?(l.error=o.i18n("maxNumberOfFiles"),s.rejectWith(this,[e])):t.acceptFileTypes&&!t.acceptFileTypes.test(l.type)&&!t.acceptFileTypes.test(l.name)||t.rejectFileTypes&&(t.rejectFileTypes.test(l.type)||t.rejectFileTypes.test(l.name))?(e.error=l.error=o.i18n("acceptFileTypes"),e.errorThrown=l.errorThrown=o.errorCode.fileType,s.rejectWith(this,[e]).promise()):r>t.maxFileSize?(l.error=o.i18n("maxFileSize"),s.rejectWith(this,[e]).promise()):"number"===n.type(r)&&r<t.minFileSize?(l.error=o.i18n("minFileSize"),s.rejectWith(this,[e]).promise()):(delete l.error,delete l.errorThrown,s.resolveWith(this,[e]).promise()))},prepare:function(e,i){if(i.disabled||e.disablePrepare||e.skipPrepareProcess)return e;var a=n.Deferred(),r=this,s=this.options,o=e.files[e.index],l=n.extend({},{composeId:e.composeId||s.composeId,attachmentId:0,fileName:o.name,contentType:o.contentType||o.type,size:o.size});return o.skipProcess?e:!n.support.xhrFileUpload||i.forceIframeTransport?a.resolveWith(r,[e]):t(l).then(function(t){o.cmMeta.setId(t.attachmentId),a.resolveWith(r,[e])},function(t){t?"FA_OVERFLOW"===t.code?(e.error=o.error=s.i18n("overflow"),e.errorThrown=o.errorThrown=s.errorCode.overflow):"FA_COMPOSE_NOT_FOUND"===t.code&&(e.error=o.error=s.i18n("composeNotFound"),e.errorThrown=o.errorThrown=s.errorCode.composeNotFound):(e.error=o.error=s.i18n("prepareFail"),e.errorThrown=o.errorThrown=s.errorCode.prepareFail),a.rejectWith(r,[e])})}}})}),function(){define("component/fileupload/FileClass",["require","exports","module"],function(e,t,n){function i(e,t){var n,i,a,r={};if("string"==typeof t&&(t=[t]),!$.isArray(t))return r;for(var s=0;s<t.length;++s)n=t[s],"string"==typeof n?i=a=n:(i=n[0],a=n[1]||i),e.hasOwnProperty(i)&&(r[a]=e[i]);return r}function a(e){e.dname=(e.name||"").split(/[\/\\]/).pop(),e.dsize="string"==typeof e.size?parseInt(e.size,10):e.size}function r(e){this.type=p.upload,this.name=e.name||"",this.size=e.size||0,this.contentType=e.contentType||"",this.securityLevel=e.securityLevel||0,this.setId(e.id),this.setDeleted(e.deleted),a(this)}function s(e){var t=new r(e);return t.type=p.inlined,t}function o(e){this.type=p.internal,this.composeId=e.composeId||"",this.mid=e.mid||e._mid,this.part=e.part,this.name=e.name||"",this.size=e.size||e.actualSize||0,this.contentType=e.contentType||"",this.setId(e.id),this.setDeleted(e.deleted),a(this)}function l(e){this.type=p.trs,this.name=e.name||"",this.size=e.size||e.actualSize||0,this.contentType=e.contentType||"",this.securityLevel=e.securityLevel||!1,this.setId(e.id),this.setMid(e.mid||e._mid),this.setDeleted(e.deleted),a(this)}function c(e){this.type=p.netfolder,this.name=e.name||"",this.size=e.size||e.actualSize||0,this.deleted=e.deleted===!0,this.contentType=e.contentType||"",this.enfUid=e.enfUid||e._enfUid||!1,this.securityLevel=e.securityLevel||!1,this.setId(e.id),this.setMid(e.mid||e._mid),this.setDeleted(e.deleted),a(this)}function d(e,t){var n;switch(e){case p.upload:n=r;break;case p.inlined:n=s;break;case p.internal:n=o;break;case p.trs:n=l;break;case p.netfolder:n=c}return n?new n(t):null}function u(e){return e===p.inlined||e===p.upload}var p={upload:"upload",inlined:"inlined",netfolder:"netfolder",trs:"trs",internal:"internal"};r.prototype={setId:function(e){null==e?e=null:(e=parseInt(e,10),isNaN(e)&&(e=null)),this.id=e},setDeleted:function(e){this.deleted=e===!0},exportToCompose:function(){return i(this,["id","type","name",["dname","displayName"],"size","deleted"])},exportToComposeDelete:function(){var e=i(this,["id","type"]);return e.deleted=!0,e},exportDownloadParam:function(){return{attachId:this.id}},exportPreviewParam:function(){return{attachId:this.id}}},o.prototype={setId:function(e){null==e?e=null:(e=parseInt(e,10),isNaN(e)&&(e=null)),this.id=e},setDeleted:function(e){this.deleted=e===!0},exportToCompose:function(){return this.composeId?i(this,["id","type","name",["dname","displayName"],"size","deleted"]):i(this,["id","type","name",["dname","displayName"],"size","deleted",["mid","_mid"],["part","_part"]])},exportToComposeDelete:function(){var e;return e=this.composeId?i(this,["id","type"]):i(this,["id","type",["mid","_mid"],["part","_part"]]),e.deleted=!0,e},exportDownloadParam:function(){return this.composeId?{composeId:this.composeId,attachId:this.id}:{mid:this.mid,part:this.part}},exportPreviewParam:function(){return this.mid&&this.part?{mid:this.mid,part:this.part}:!1}},l.prototype={setId:function(e){null==e?e=null:(e=parseInt(e,10),isNaN(e)&&(e=null)),this.id=e},setDeleted:function(e){this.deleted=e===!0},setMid:function(e){"string"==typeof e&&(this.mid=e)},exportToCompose:function(){return i(this,["id","type","name",["dname","displayName"],"size","deleted",["mid","_mid"]])},exportToComposeDelete:function(){var e=i(this,["id","type",["mid","_mid"]]);return e.deleted=!0,e},exportDownloadParam:function(){return{uid:this.enfUid||"",mid:this.mid}},exportPreviewParam:function(){return{fileId:this.mid}}},l.migrateInstance=function(e,t){var n=$.extend(!0,i(e,["name","size","contentType"]),{mid:t,deleted:!1});return new l(n)},c.prototype={setId:function(e){null==e?e=null:(e=parseInt(e,10),isNaN(e)&&(e=null)),this.id=e},setDeleted:function(e){this.deleted=e===!0},setMid:function(e){"string"==typeof e&&(this.mid=e)},exportToCompose:function(){var e=i(this,["id","type","name",["dname","displayName"],"size","deleted",["mid","_mid"],["part","_part"]]);return this.enfUid&&(e._enfUid=this.enfUid),e},exportToComposeDelete:function(){var e=i(this,["id","type",["dname","fileName"]]);return e.deleted=!0,e},exportDownloadParam:function(){return{uid:this.enfUid||"",mid:this.mid}},exportPreviewParam:function(){return{fileId:this.mid}}},n.exports={UploadFile:r,InlinedFile:s,InternalFile:o,TrsFile:l,NetfolderFile:c,fileTypes:p,initFileInstance:d,isUploadOrInlinedType:u}})}(),define("component/fileupload/fileupload-plugin",["require","i18n!common","./fileupload-validate","jquery","../../util/index","../../module/common/globalService","./FileClass"],function(e){e("i18n!common"),e("./fileupload-validate");var t=e("jquery"),n=e("../../util/index"),i=e("../../module/common/globalService"),a=e("./FileClass");t.cmpluginMeta={downloadUrl:"/cab/cmplugin_setup.exe"},t.fn.cmplugin=function(e){var n,i=t("body").find("div[role=cmplugin]").find("object")[0];switch(e){case"valid":n="undefined"!=typeof i&&i.valid;break;case"capture":n=i&&i.valid&&i.screenCapture();break;case"downloadUrl":n=t.cmpluginMeta.downloadUrl;break;case"version":n=i&&i.valid&&i.version;break;case"pluginUpload":n=i&&i.valid&&i.upload();break;case"voice":n=i&&i.valid&&i.soundRecord();break;case"video":n=i&&i.valid&&i.videoRecord();break;case"plugin":n=i||""}return n},t.widget("cm.fileupload",t.cm.fileupload,{}),t.cm.fileupload.prototype._specialOptions.push("pluginContainer"),t.widget("cm.fileupload",t.cm.fileupload,{options:{forcePlugin:!1,queryUrl:n.xhr.getFullRequestURL({url:"comupload.jsp"}),pluginUploadUrl:n.xhr.getFullRequestURL({query:{func:"upload:directData"},json:!1}),pluginTrsUploadUrl:n.xhr.getFullRequestURL({query:{func:"upload:directDataNF"},json:!1}),pluginPreviewUrl:n.xhr.getRequestURL({query:{func:"mbox:getComposeData"},json:!1}),pluginContainer:document.body,pluginBrowsing:!1,messages:{plugin_error0:n.i18n.t("common/upload_plugin_error0"),plugin_error1:n.i18n.t("common/upload_plugin_error1"),plugin_error2:n.i18n.t("common/upload_plugin_error2"),plugin_error3:n.i18n.t("common/upload_plugin_error3"),plugin_error4:n.i18n.t("common/upload_plugin_error4"),plugin_error5:n.i18n.t("common/upload_plugin_error5"),plugin_error6:n.i18n.t("common/upload_plugin_error6"),plugin_error7:n.i18n.t("common/upload_plugin_error7"),plugin_error8:n.i18n.t("common/upload_plugin_error8"),plugin_error9:n.i18n.t("common/upload_plugin_error9")}},_valid:function(){return this.plugin&&this.plugin.valid},_onPluginDone:function(e,n){this._trigger("plugindone",t.Event("plugindone",{delegatedEvent:e}),n)},_onPluginFail:function(e,n){this._trigger("pluginfail",t.Event("pluginfail",{delegatedEvent:e}),n)},_onPluginProgress:function(e,n){1===n.uploadedState||2===n.uploadedState?this._trigger("pluginprepare",t.Event("pluginprepare",{delegatedEvent:e}),n):3===n.uploadedState?this._trigger("pluginprogress",t.Event("pluginprogress",{delegatedEvent:e}),n):4===n.uploadedState||5===n.uploadedState?n.dfd.resolve():6===n.uploadedState&&(!this._checkComposeAutoToTrs(n)||7!==n.lastErrorNum&&8!==n.lastErrorNum?2===n.lastErrorNum?(n.files[0].error="abort",n.dfd.reject()):(n.files[0].error=n.i18n("plugin_error"+n.lastErrorNum),n.dfd.reject()):n.composeToTrsAdd())},_onPluginSend:function(e,n){var i,a=this;return a._pluginActive++,i=function(){return n.dfd=t.Deferred(),n.dfd.done(function(){a._onPluginDone(e,n)}).fail(function(){a._onPluginFail(e,n)}).always(function(){a._pluginActive--,0===a._pluginActive&&a._trigger("stop")}),n.aborted||a._trigger("pluginsend",t.Event("pluginsend",{delegateEvent:e},n))===!1?n.dfd.rejectWith(a,[n]):a.plugin.upload().item(n.index).start(),n.dfd},n.sequentialUploads?(this._pluginSequence=this._pluginSequence.then(i,i),this._pluginSequence):i()},_onPluginAdd:function(e,n){var i=this,a=!0;return n.originalFiles=n.files,n._widgetName=this.widgetFullName||this.widgetName,t.each(n.files,function(r,s){var o=t.extend({},i.options,n);return o.files=[s],o.index=s.index,o.skipPrepareProcess=!0,i._addPluginConvenienceMethods(e,o),a=i._trigger("add",t.Event("add",{delegatedEvent:e}),o)}),a},_onPluginChange:function(e,n,i){for(var a,r,s={files:[],usePlugin:!0},o=0;o<n.length;o++)a=this.plugin.upload().item(n[o]),r="unknown"==typeof a.size?parseInt(a.size_str):parseInt(a.size),s.files.push(t.extend({index:n[o],name:a.name,size:r},i));this._onPluginAdd(e,s)},_onPluginDropIn:null,_onPluginDropMove:null,_onPluginDropOut:null,_onPluginDropFiles:null,_addPluginConvenienceMethods:function(e,r){var s=this,o=function(e){return t.Deferred().resolveWith(s,e).promise()};r.process=function(e,n){return(e||n)&&(r._processQueue=this._processQueue=(this._processQueue||o([this])).pipe(function(){return r.errorThrown?t.Deferred().rejectWith(s,[r]).promise():o(arguments)}).pipe(e,n)),this._processQueue||o([this])},r.submit=function(){"pending"!==this.state()&&s._trigger("pluginSubmit",t.Event("pluginSubmit",{delegatedEvent:e}),this)!==!1&&(r.initSubmitUrl(),r.init(),s._onPluginSend(e,r))},r.state=function(){return this.dfd?this.dfd.state():this._processQueue?this._processQueue.state():void 0},r.init=function(){s.plugin.upload().item(r.index).init({netfolder:r.uploadType!==s.uploadTypes.compose,blocksize:r.maxChunkSize,query:r.queryUrl,upload:r.uploadUrl,notify:function(t,n,i){var a=s.plugin.upload().item(i);r.uploadedPercent=n,r.uploadedState=t,r.lastErrorNum=a.lastErrorNum,t>=3&&(r.uploadType===s.uploadTypes.compose?r.files[0].cmMeta.setId(a.attachmentId):r.files[0].cmMeta.setMid(a.attachmentId)),s._onPluginProgress(e,r)}})},r.abort=function(){r.errorThrown="abort",r.dfd?(s.plugin.upload().item(r.index).stop(),r.dfd.reject()):(r.aborted=!0,s._onPluginFail(e,r))},r.carryon=function(){r.aborted=!1,r.dfd?s._onPluginSend(e,r):r.submit()},r.initSubmitUrl=function(){var e,t,a,o=s.options.queryUrl;r.uploadType===s.uploadTypes.compose?(e={sid:i.getSid(),composeId:r.composeId},t={sid:i.getSid(),composeId:r.composeId},a=s.options.pluginUploadUrl):(e={sid:i.getSid(),fid:r.fid,trs:!0},t={sid:i.getSid()},r.uid&&(e.uid=r.uid,t.uid=r.uid),a=s.options.pluginTrsUploadUrl),r.files[0].inlined&&(e.inlined=!0,t.inlined=!0),r.queryUrl=n.url.addUrlParams(o,e),r.uploadUrl=n.url.addUrlParams(a,t)},r.composeToTrsAdd=function(){var e=r.files[0];s._trigger("viewUpdate",null,[s.viewMsgTypes.uploadToTrs,r]),s._initUploadMeta(r,s.uploadTypes.trs),e.cmMeta=a.TrsFile.migrateInstance(e.cmMeta),e.composeToTrs=!0,e.inlined=!1,delete e.cmMeta.part,r.initSubmitUrl(),r.init(),s.plugin.upload().item(r.index).start()}},_initEventHandlers:function(){var e=this;this._super(),this._valid()&&(this.options.fileInput.css({position:"absolute",left:"-9999px",top:"-9999px"}),this.element.on("click",function(t,n){e._customForceComposeToTrs=n&&n.forceToTrs===!0;var i=e.options.enableDnd;e.options.enableDnd=!1,e.options.pluginBrowsing=!0;var a=e.plugin.upload().browser();e.options.enableDnd=i,e._onPluginChange(t,a),setTimeout(function(){e.options.pluginBrowsing=!1},10)}),this._isXHRUpload(this.options)||(this.plugin.EnableDropFiles=!0,this.plugin.supportDropFiles&&(this._onPluginDropIn=function(){e._trigger("plugindragenter",t.Event({type:"dragenter"}))},this._onPluginDropMove=function(n,i){e._trigger("plugindropmove",t.Event({type:"dragmove"}),{x:n,y:i})},this._onPluginDropOut=function(){e._trigger("plugindragleave",t.Event({type:"dragleave"}))},this._onPluginDropFiles=function(n){var i=t.Event("drop");e._trigger("plugindrop",i,n)!==!1&&e._onPluginChange(i,n)},this.plugin.attachEvent("onDropIn",this._onPluginDropIn),this.plugin.attachEvent("onDropMove",this._onPluginDropMove),this.plugin.attachEvent("onDropOut",this._onPluginDropOut),this.plugin.attachEvent("onDropFiles",this._onPluginDropFiles))))},_destroyEventHandlers:function(){var e=this.plugin,t=this._onPluginDropIn,n=this._onPluginDropMove,i=this._onPluginDropOut,a=this._onPluginDropFiles;this._super(),this._valid()&&(this.element.off("click"),!!t&&e.detachEvent("onDropIn",t),!!n&&e.detachEvent("onDropMove",n),!!i&&e.detachEvent("onDropOut",i),!!a&&e.detachEvent("onDropFiles",a))},_initSpecialOptions:function(){this._super();var e=this.options;return t(e.pluginContainer).length<=0&&t.error("fileupload: pluginContainer can not be empty"),n.detector.isSupportNPAPI()?(this.pluginNode=t(this.options.pluginContainer).find("div[role=cmplugin]"),this.plugin=this.pluginNode.find("object")[0],void(this.pluginNode.length<=0&&(this.pluginNode=t("<div />").append('<object type="application/x-cmplugin" width="0" height="0"><param name="onload" value="pluginLoaded" /></object>').appendTo(e.pluginContainer).attr({role:"cmplugin"}),this.plugin=this.pluginNode.find("object")[0]))):void console.log("fileupload: plugin init failed! browser can't support NPAPI")},_create:function(){this._super(),this._pluginActive=0,this._pluginSequence=this._getXHRPromise(!0)},_destroy:function(){this._destroyEventHandlers(),this._super()},isPluginValid:function(){return!!this._valid()},isPluginDnd:function(){return this.isPluginValid()&&!this._isXHRUpload(this.options)},pluginActive:function(){return this._pluginActive},pluginAdd:function(e,n){e&&this._onPluginChange(t.Event("pluginAdd"),e,n)},compareVersion:function(e,t){for(var n=(e||"").split(".",4),i=(t||"").split(".",4),a=0;a<n.length;a++){var r=parseInt(n[a])||n[a]||0,s=parseInt(i[a])||i[a]||0;if(s>r)return-1;if(r>s)return 1}return 0},detectOS:function(){var e={Windows:/(Windows)/i,Macintosh:/(Mac OS X|Mac_PowerPC|Macintosh)/i,Android:/(Android)/i,iPhone:/(iPhone)/i,iPad:/(iPad)/i},t=navigator.userAgent;for(var n in e)if(e.hasOwnProperty(n)&&t.match(e[n]))return n;return"Unknown"},supportEmbeddedFile:function(){return!!this.plugin&&this.compareVersion(this.plugin.version,"4.0.3.0")>=0&&n.detector.isSupportNPAPI()},getPathFileClipboard:function(){return this.plugin.getPathFileClipboard()},getHTMLClipboard:function(){if(this._valid()){var e=this.plugin.getHTMLClipboard();if(e){var t=e.indexOf("<body"),n=e.indexOf("</body>");return e=e.substring(t,n+"</body>".length),e=e.replace(/body/g,"div"),e.trim()}}return""},getScreenClipboard:function(){var e=this.plugin.screenCapture();if(e.supportClipboard){var t=e.clipboard();if(t)return e.upload()}return null}})}),function(){define("component/fileupload/fileupload-extend",["require","./fileupload-plugin","jquery","../../util/index","module/common/globalService","./FileClass"],function(e){function t(e){var t=n.Deferred();return e?t.resolve(e):(i.xhr.simpleCall({query:{func:"mbox:compose",sid:a.getSid()}},function(e){t.resolve(e)},function(){t.reject()}),t.promise())}e("./fileupload-plugin");var n=e("jquery"),i=e("../../util/index"),a=e("module/common/globalService"),r=e("./FileClass");n.widget("cm.fileupload",n.cm.fileupload,{options:{maxChunkSize:2097152,forceIframeTransport:!1,singleFileUploads:!0,sequentialUploads:!0,dataType:"json",formData:{},deletedStatus:!0,composeId:void 0,trsFid:a.getConfig("file.trsfid"),trsComposeId:"c:nf:"+a.getConfig("file.trsfid"),uploadUrl:i.xhr.getFullRequestURL({url:"XT5/jsp/upload.jsp",query:{func:"directData"}}),downloadUrl:i.xhr.getFullRequestURL({query:{func:"mbox:getComposeData"},json:!1}),accDownloadUrl:i.xhr.getFullRequestURL({query:{func:"mbox:getMessageData"},json:!1}),trsDownloadUrl:i.xhr.getFullRequestURL({query:{func:"nf:getFileData"},json:!1}),removeUrl:i.xhr.getRequestURL({query:{func:"upload:deleteTasks"}}),netfolderRemoveUrl:i.xhr.getRequestURL({query:{func:"nf:deleteFiles"}}),messages:{unknownError:i.i18n.t("common/upload_unknown"),prepare:i.i18n.t("common/upload_prepare"),uploading:i.i18n.t("common/upload_uploading"),composeIdNotFound:i.i18n.t("mail/FA_ID_NOT_FOUND"),uploadedBytes:i.i18n.t("mail/compose_attach_error_exceed_file_size"),moveToNFError:i.i18n.t("mail/compose_attach_error_movetonf")},errorCode:{withoutPlugin:"withoutPlugin",moveToNFError:"moveToNFError",abort:"abort"},add:function(e,i){function a(e,t){var n=d._fileAddedCount||[0,0];return n[0]+=e,t===!0&&(n[1]+=e),n[0]>=i.originalFiles.length?(n[1]<=0&&c._trigger("stop"),d._fileAddedCount=[0,0],!1):!0}function s(){var t,s=i.files;if(c._initUploadMeta(i,c._customForceComposeToTrs?c.uploadTypes.trs:!1),c._trigger("addstart",null,i)===!1)return!1;var o;switch(i.uploadType){case c.uploadTypes.compose:o=r.fileTypes.upload;break;case c.uploadTypes.trs:o=r.fileTypes.trs;break;case c.uploadTypes.netfolder:o=r.fileTypes.netfolder}return n.each(s,function(e,t){t.cmMeta=r.initFileInstance(o,t)}),t=c._filterFiles(s),t.restore&&t.restore.length>0&&c._trigger("viewUpdate",e,[c.viewMsgTypes.fileRestore,i]),a(t.repeated.length)&&a(t.restore.length)&&a(t.add.length,!0),n.each(t.add,function(e,t){"undefined"==typeof t.size&&(t.dsize=t.size=t.cmMeta.dsize=t.cmMeta.size=i.fileInput.val()),c._trigger("viewUpdate",null,[c.viewMsgTypes.fileNew,i])}),t.add.length>0}function o(){i.process(function(){return c.process(i)}).done(function(){c._trigger("viewUpdate",e,[c.viewMsgTypes.uploadProgress,i,{loaded:0,total:1}]),c._trigger("added",e,i)!==!1&&(d.autoUpload||i.autoUpload)&&i.autoUpload!==!1&&i.submit()}).fail(function(){}).always(function(){c._addUploadFiles(u)})}if(e&&e.isDefaultPrevented())return!1;var l=n(this),c=l.data(i._widgetName),d=c.options,u=i.files;return u&&u.length&&s(i)?void t(d.composeId).then(function(e){d.composeId=e,i.disablePrepare=i.usePlugin===!0,o()}):!1},process:function(e,t){var i=n(this),a=i.data(t._widgetName);a._trigger("viewUpdate",e,[a.viewMsgTypes.uploadProcessing,t])},processfail:function(e,t){var i=n(this),a=i.data(t._widgetName),r=t.files[t.index],s=r.error,o=r.errorThrown;return s&&o===a.options.errorCode.overflow&&a._checkComposeAutoToTrs(t)&&n.isFunction(t.composeToTrsAdd)?t.composeToTrsAdd():(r.processFail=!0,void a._trigger("viewUpdate",e,[a.viewMsgTypes.uploadFail,t]))},processdone:function(e,t){t.files[t.index].processFail=!1},processalways:function(e,t){function i(e,n){var i=s._fileProcessedCount||[0,0];return i[0]+=e,n!==!0&&(i[1]+=e),i[0]>=t.originalFiles.lenth?(i[1]<=0&&r._trigger("stop"),s._fileProcessedCount=[0,0],!1):!0}var a=n(this),r=a.data(t._widgetName),s=r.options;r._trigger("viewUpdate",e,[r.viewMsgTypes.uploadProcessed,t]);var o=t.files[0];i(1,o.processFail)},submit:function(e,t){var i=n(this).data(t._widgetName),a=i.options;a.uploadUrl||n.error("fileupload: uploadUrl can not be empty"),t.initSubmitUrl()},send:function(e,t){if(e.isDefaultPrevented())return!1;var i=n(this).data(t._widgetName);return t.context&&t.dataType&&"iframe"===t.dataType.substr(0,6)&&i._trigger("viewUpdate",e,[i.viewMsgTypes.uploadIframe,t]),i._trigger("sent",e,t)},progress:function(e,t){if(e.isDefaultPrevented())return!1;var i=n(this).data(t._widgetName),a=t.context&&t.context.data("data");a&&(a.uploadedBytes=t.loaded),i._trigger("viewUpdate",e,[i.viewMsgTypes.uploadProgress,t])},chunksend:function(e,t){t.url=i.url.addUrlParams(t.url,{offset:t.uploadedBytes||0})},done:function(e,t){if(e.isDefaultPrevented())return!1;var i=n(this).data(t._widgetName);i._generatePreviewUrl(t),t.files[0].completed=!0,t.files[0].failed=!1,i._trigger("viewUpdate",e,[i.viewMsgTypes.uploadDone,t]),i._trigger("completed",e,t),i._trigger("finished",e,t)},fail:function(e,t){if(e.isDefaultPrevented())return!1;var i,a=n(this).data(t._widgetName),r=a.options;t.errorThrown!==r.errorCode.abort?(i=t.files[0],a.isPluginValid()||r.forceIframeTransport||a._isXHRUpload(r)?i.error=i.error||t.errorThrown||r.i18n("unknownError"):(i.error=i.error||t.errorThrown||r.i18n("unknownError"),i.errorThrown=r.errorCode.withoutPlugin),a._trigger("viewUpdate",e,[a.viewMsgTypes.uploadFail,t])):(i=t.files[0],i.error="abort"),t.files[0].completed=!1,t.files[0].failed=!0,a._trigger("failed",e,t),a._trigger("finished",e,t)},beforedestroyed:function(e,t){var i=n(this).data(t._widgetName);t.files[0].cmMeta.setDeleted(!0),i._trigger("viewUpdate",e,[i.viewMsgTypes.fileDestroy,t])},pluginSubmit:function(e,t){var i=n(this).data(t._widgetName);i.options.pluginUploadUrl||n.error("fileupload: uploadUrl can not be empty"),t.initSubmitUrl()},pluginprogress:function(e,t){var i=n(this),a=i.data(t._widgetName),r=t.files[0].size,s=Math.floor(r*t.uploadedPercent/100);a._trigger("viewUpdate",e,[a.viewMsgTypes.uploadProgress,t,{loaded:s,total:r}])},plugindone:function(e,t){var i=n(this).data(t._widgetName);i._generatePreviewUrl(t),i._trigger("done",e,t)},pluginfail:function(e,t){var i=n(this).data(t._widgetName);i._trigger("fail",e,t)},destroy:function(e,t){function s(){p._trigger("beforedestroyed",e,t),p._trigger("destroyed",e,t)}function o(){p._trigger("destroyfailed",e,t)}function l(){return t.usePlugin?4===t.uploadedState||5===t.uploadedState:t.uploadedBytes>=h.cmMeta.size}function c(){var e,r,s=n.Deferred();return f||!t.usePlugin?(e=i.url.addUrlParams(m.removeUrl,{sid:a.getSid()}),r={composeId:t.composeId||m.composeId,items:[h.cmMeta.name]}):(e=i.url.addUrlParams(m.netfolderRemoveUrl,{sid:a.getSid()}),r={ids:[h.cmMeta.mid]}),i.xhr.simpleCall({url:e,data:r},function(e){s.resolve(e)},function(e,t,n){s.reject(n)}),s.promise()}function d(e){var r,s=n.Deferred();return f||null!=h.cmMeta.id?(r=h.cmMeta.exportToComposeDelete(),i.xhr.simpleCall({query:{func:"mbox:compose",sid:a.getSid()},data:{id:e||t.composeId||m.composeId,action:"continue",attrs:{id:e||t.composeId||m.composeId,attachments:[r]}}},function(e){s.resolve(e)},function(e,t,n){s.reject(n)}),s.promise()):s.resolve()}function u(){h.cmMeta.deleted=!0,p._deleteUploadFiles(t.files),s()}if(e.isDefaultPrevented())return!1;var p=n(this).data(t._widgetName),m=p.options,h=t.files[0],f=r.isUploadOrInlinedType(h.cmMeta.type);return t.error?(p._deleteUploadFiles(t.files),void s()):m.deleteStatus?void u():f?void d().then(function(){p._deleteUploadFiles(t.files),s()},function(){o()}):l()?m.uploadType!==p.uploadTypes.compose?void c().then(function(){p._deleteUploadFiles(t.files),s()},function(){o()}):void(null!=h.cmMeta.id?d(m.composeId).then(function(){p._deleteUploadFiles(t.files),s()},function(){o()}):u()):void(t.usePlugin?c().then(function(){p._deleteUploadFiles(t.files),s()},function(){o()}):d().then(function(){return p._deleteUploadFiles(t.files),c()}).then(function(){s()}).fail(function(){o()}))}},viewMsgTypes:{fileNew:"file_new",fileRestore:"file_restore",fileDestroy:"file_destroy",uploadIframe:"upload_iframe",uploadProcessing:"upload_processing",uploadProcessed:"upload_processed",uploadProgress:"upload_progress",uploadToTrs:"upload_totrs",uploadDone:"upload_done",uploadFail:"upload_fail"},startUpload:function(e,t){var n=t.files[0];delete n.errorThown,delete n.error,t.carryon()},cancelUpload:function(e,t){t.abort()},deleteUpload:function(e,t){t.error?(this._deleteUploadFiles(t.files),this._trigger("destroyed",e,t)):this._trigger("destroy",e,n.extend({type:"POST"},t))},_addConvenienceMethods:function(e,t){var s=this,o=this.options;this._super(e,t),t.composeToTrsAdd=function(){var n=t.files[0];delete t.error,delete t.errorThrown,delete n.error,delete n.errorThrown,delete n.skipProcess,s._trigger("viewUpdate",null,[s.viewMsgTypes.uploadToTrs,t]),s._initUploadMeta(t,s.uploadTypes.trs),n.cmMeta=r.TrsFile.migrateInstance(n.cmMeta),n.composeToTrs=!0,t.process(!1,function(){return s.process(t)}).done(function(){s._trigger("viewUpdate",e,[s.viewMsgTypes.uploadProgress,t,{loaded:0,total:1}]),t.submit()})},t.netfolderUploadDone=function(){var e=this._progress.total;this.uploadType!==s.uploadTypes.compose?(this._progress.loaded<e&&s._onProgress(n.Event("progress",{lengthComputable:!0,loaded:e,total:e}),this),this.moveToNetFolder()):s._trigger("done",null,this)},t.moveToNetFolder=function(){var e=t.files[0];i.xhr.simpleCall({query:{func:"upload:moveToNetFolder",sid:a.getSid()},data:n.extend({},{composeId:t.composeId||o.trsComposeId,attachmentId:e.attachmentId}),preprocess:!1,onlyVar:!1},function(e,n,i){t.moveToNetFolderDone(e,n,i)},function(e,n,i){t.moveToNetFolderFail(i,e,n)})},t.moveToNetFolderDone=function(e,n,i){var a=t.files[0],r=e.code;return"S_OK"!==r?this.moveToNetFolderFail(e,n,i):(a.inlined=!1,delete a.partId,a.cmMeta.setId(null),a.cmMeta.setMid(e["var"].fileId),t.setResponse.apply(t,arguments),void s._trigger("done",null,t))},t.moveToNetFolderFail=function(e,n,i){var a=t.files[0];a.error=t.i18n("moveToNFError"),a.errorThrown=o.errorCode.moveToNFError,t.setResponse.apply(t,arguments),s._trigger("fail",null,this)},t.initSubmitUrl=function(){t.url=i.url.addUrlParams(s.options.uploadUrl,{sid:a.getSid(),composeId:t.composeId||s.options.composeId,attachmentId:t.files[0].cmMeta.id||-1}),n.support.xhrFileUpload&&!o.forceIframeTransport&&(t.url=i.url.addUrlParams(t.url,{offset:t.uploadedBytes||0}))},t.carryon=function(){var e=t.files[0];this.uploadedBytes&&this.uploadedBytes>=e.cmMeta.size?s._trigger("done",null,this):this.submit&&this.submit()},t.setResponse=function(e,n,i){var a=t._response;a.result=t.result=e,a.textStatus=t.textStatus=i,a.jqXHR=t.jqXHR=n}},_create:function(){this._super(),this._resetUploadFiles()},_onAdd:function(e,t){t._widgetName=this.widgetFullName||this.widgetName,this._super(e,t)},_onDone:function(e,t,i,a){var s,o=a._response,l="undefined"==typeof e,c=l?{}:e["var"];if(s=a.files[0],!this.isPluginValid()&&!this._isXHRUpload(a)&&l&&"success"===t)return a.error=s.error=a.i18n("unknownError"),a.errorThrown=s.errorThrown=this.options.errorCode.withoutPlugin,void this._trigger("fail",null,a);if(l||"S_OK"!==e.code){switch(o.result=a.result=e,o.textStatus=a.textStatus=t,o.jqXHR=a.jqXHR=i,e.code){case"FA_UPLOAD_SIZE_EXCEEDED":a.error=s.error=a.i18n("overflow"),a.errorThrown=s.errorThrown=a.errorCode.overflow}this._trigger("fail",null,a)}else{if(n.extend(s,c),this._isXHRUpload(a)||(s.cmMeta=r.initFileInstance(a.uploadType===this.uploadTypes.compose?r.fileTypes.upload:a.uploadType,s),
s.cmMeta.setId(c.attachmentId)),a.uploadType!==this.uploadTypes.compose)return a.setResponse(c,t,i),a.netfolderUploadDone();this._super(c,t,i,a)}},_resetUploadFiles:function(){this._uploadFiles=[]},_addUploadFiles:function(e){"array"===n.type(e)?this._uploadFiles=this._uploadFiles.concat(e):this._uploadFiles.push(e)},_deleteUploadFiles:function(e,t){var i=this._uploadFiles;e="array"===n.type(e)?e:[e],t="boolean"===n.type(t)?t:!1,n.each(e,function(e,n){for(var a=i.length-1;a>=0;a--)i[a].cmMeta.dname===n.cmMeta.dname&&i[a].cmMeta.dsize===n.cmMeta.dsize&&(t?i[a].deleted=!0:i.splice(a,1))})},doneFiles:function(){var e=[];return n.each(this._uploadFiles,function(t,i){i.completed!==!0||i.hasOwnProperty("error")||e.push(n.extend({},i))}),e},failFiles:function(){var e=[];return n.each(this._uploadFiles,function(t,i){(i.failed===!0||i.hasOwnProperty("error"))&&e.push(n.extend({},i))}),e},abortFiles:function(){var e=[];return n.each(this._uploadFiles,function(t,i){"abort"===i.errorThrown&&e.push(n.extend({},i))}),e},notDeletedFiles:function(){var e=[];return n.each(this._uploadFiles,function(t,i){i.cmMeta.deleted||e.push(n.extend({},i))}),e},notInlinedFiles:function(){var e=[];return n.each(this._uploadFiles,function(t,i){i.hasOwnProperty("error")||i.inlined||e.push(n.extend({},i))}),e},activeFiles:function(){var e=this.element.cmplugin("valid")?this.pluginActive():0,t=this.active();return e+t},updateComposeAttachmentId:function(e){var t=this._uploadFiles,i=r.fileTypes;e=n.isArray(e)?e:[e],n.each(e,function(e,n){var a;if(n.type!==i.upload&&n.type!==i.inlined)for(var r=t.length-1;r>=0;r--)a=t[r],a.cmMeta.mid===n._mid&&a.cmMeta.setId(n.id)})},getUploadFileByName:function(e,t){t="boolean"===n.type(t)?t:!0;for(var i=this._uploadFiles,a=i.length-1;a>=0;a--)if(t&&i[a].cmMeta.name===e||!t&&i[a].cmMeta.dname===e)return i[a];return null},removeUploadFileByName:function(e){for(var t=this._uploadFiles,n=t.length-1;n>=0;n--)if(t[n].cmMeta.name===e)return t.splice(n,1),!0;return!1},updateMailSecurityLevel:function(e){this.options.curMailSecurityLevel=e},_generateDownloadUrl:function(e){var t,n=this.options,s=e.files[0],o=r.fileTypes,l=s.cmMeta;switch(l.type){case o.upload:t=s.downloadUrl=i.url.addUrlParams(n.downloadUrl,{sid:a.getSid(),composeId:n.composeId,mode:"download"},l.exportDownloadParam());break;case o.internal:t=s.downloadUrl=i.url.addUrlParams(l.composeId?n.downloadUrl:n.accDownloadUrl,{sid:a.getSid(),mode:"download"},l.exportDownloadParam());break;case o.trs:case o.netfolder:t=s.downloadUrl=i.url.addUrlParams(n.trsDownloadUrl,{sid:a.getSid(),mode:"download"},l.exportDownloadParam())}return t},_generatePreviewUrl:function(e){var t,s,o=this.options,l=e.files[0],c={sid:a.getSid()},d=r.fileTypes,u=l.cmMeta;if(e.usePlugin&&l.inlined)return t=l.previewUrl=i.url.addUrlParams(o.pluginPreviewUrl,{sid:a.getSid(),composeId:o.composeId,rd:+new Date},l.cmMeta.exportPreviewParam());if(t=CC.path("common/preview/preview.jsp"),!(s=u.exportPreviewParam()))return!1;switch(u.type){case d.trs:case d.netfolder:n.extend(c,s);break;case d.internal:n.extend(c,s,{mboxa:""});break;case d.upload:n.extend(c,s,{composeId:o.composeId})}return t=l.previewUrl=i.url.addUrlParams(t,c)},_filterFiles:function(e){var t={repeated:[],add:[],restore:[]},n=this._uploadFiles;if(!n.length)return t.add=e,t;for(var i,a,r={current:0,max:e.length,next:function(){return++this.current<=this.max},getIndex:function(){return this.current-1-(this.max-e.length)}},s={current:0,max:n.length,next:function(){return++this.current<=this.max},getIndex:function(){return this.current-1-(this.max-n.length)}};r.next();)for(i=e[r.getIndex()];s.next();)if(a=n[s.getIndex()],i.cmMeta.dname===a.cmMeta.dname&&i.cmMeta.dsize===a.cmMeta.dsize){a.error?(this._trigger("viewUpdate",null,[this.viewMsgTypes.fileDestroy,null,{file:a}]),n.splice(s.getIndex(),1)):a.cmMeta.deleted?(a.cmMeta.deleted=!1,i.cmMeta.deleted=!1,i.skipProcess=!0,t.restore.push(e.splice(r.getIndex(),1))):t.repeated.push(e.splice(r.getIndex(),1));break}return t.repeated.length>0&&this._trigger("addRepeat"),t.add=t.add.concat(e),t}})})}(),function(){define("component/fileupload/attachupload-ui",["require","i18n!common","./fileupload-extend","jquery","handlebars","../../util/index","../../module/common/previewCtrl","module/common/globalService","./FileClass"],function(e){function t(e,t){return s.checkFilePermit(e,t)}function n(e,t){var n=i.Deferred();return r.xhr.simpleCall({query:{func:"nf:copyFileToTrs",sid:o.getSid(),uid:t||""},data:{id:e}},function(e){n.resolve(e)},function(){n.reject()}),n.promise()}e("i18n!common"),e("./fileupload-extend");var i=e("jquery"),a=e("handlebars"),r=e("../../util/index"),s=e("../../module/common/previewCtrl"),o=e("module/common/globalService"),l=e("./FileClass");i.cm.fileupload.prototype._specialOptions.push("filesContainer"),i.widget("cm.attachupload",i.cm.fileupload,{options:{enableDnd:!0,uploadType:"compose",uploadTemplate:'<div class="u-fileupload"><div class="icon j-icon"><i class="iconfont {{icon}}"></i></div><div class="name j-name" oname="{{oname}}">{{name}}</div><div class="info j-info">{{info}}</div><div class="size j-size">{{#if size}}{{loaded}} / {{total}}{{/if}}</div><div class="trs-expire j-trs-expire f-dn"></div><div class="btns j-btns"></div></div>',progressTemplate:'<div class="pgr j-pgr"><div class="u-progress"><div class="u-progress-bar" style="width: 0%;">{{percentage}}</div></div></div>',infoTemplate:'<div class="info j-info">{{{info}}}</div>',buttonTemplate:'<a href="{{href}}" class="link {{type}}" target="{{target}}">{{name}}</a>',filesContainer:void 0,prependFiles:!0,messages:{start:r.i18n.t("common/start"),cancel:r.i18n.t("common/pause"),carryon:r.i18n.t("common/continue"),remove:r.i18n.t("common/delete"),unremove:r.i18n.t("common/undelete"),download:r.i18n.t("common/download"),preview:r.i18n.t("common/op_preview"),editSecurityLevel:r.i18n.t("common/op_editSecurityLevel")},enableSecurityLevel:!1,curMailSecurityLevel:-1,maxAttachmentSize:o.getConfig("user.maxattachmentsize"),viewUpdate:function(e,t,n,a){var r=i(this).data(n._widgetName),s=r.viewMsgTypes,o=i.noop;if(!t)return!1;switch(t){case s.fileNew:o=r._uiFileNewHandle;break;case s.fileRestore:o=r._uiFileRestoreHandle;break;case s.fileDestroy:o=r._uiFileDestroyHandle;break;case s.uploadIframe:o=r._uiUploadIframe;break;case s.uploadProcessing:o=r._uiUploadProcessing;break;case s.uploadProcessed:o=r._uiUploadProcessed;break;case s.uploadProgress:o=r._uiUploadProgress;break;case s.uploadToTrs:o=r._uiUploadToTrs;break;case s.uploadDone:o=r._uiUploadDone;break;case s.uploadFail:o=r._uiUploadFail}return o.call(r,n,a)}},buttonTypes:{CANCEL:"cancel",DELETE:"delete",CONTINUE:"continue",PREVIEW:"preview",DOWNLOAD:"download",EDITSECURITYLEVEL:"editSecurityLevel"},_startHandler:function(e){e.preventDefault();var t=i(e.currentTarget).closest(".j-fileupload").data("data");t.context.find(".j-btns").empty().append(this._renderButton(this.buttonTypes.CANCEL)),this.startUpload(e,t)},_cancelHandler:function(e){e.preventDefault();var t=i(e.currentTarget).closest(".j-fileupload").data("data");t.context.find(".j-btns").empty().append(this._renderButton(this.buttonTypes.CONTINUE)).append(this._renderButton(this.buttonTypes.DELETE)),this.cancelUpload(e,t)},_deleteHandler:function(e){e.preventDefault();var t=i(e.currentTarget).closest(".j-fileupload").data("data");this.deleteUpload(e,t)},_clickFileInputHandler:function(e,t){this._customForceComposeToTrs=t&&t.forceToTrs===!0},_initEventHandlers:function(){var e=this.options;this._super(),this._on(e.filesContainer,{"click .j-start":this._startHandler,"click .j-cancel":this._cancelHandler,"click .j-delete":this._deleteHandler}),i.support.fileInput&&this._on(this.options.fileInput,{click:this._clickFileInputHandler})},_destroyEventHandlers:function(){var e=this.options;this._super(),e.filesContainer.off("click",".j-start",this._startHandler).off("click",".j-cancel",this._cancelHandler).off("click",".j-delete",this._deleteHandler),this._off(this.options.fileInput,"click",this._clickFileInputHandler)},_initTemplates:function(){var e=this.options;e.uploadTemplate&&e.buttonTemplate||i.error("fileupload: uploadTemplate or buttonTemplate can not be empty")},_initFilesContainer:function(){var e=this.options;e.filesContainer?e.filesContainer instanceof i||(e.filesContainer=i(e.filesContainer)):i.error("fileupload: filesContainer can not be empty")},_initSpecialOptions:function(){this._initFilesContainer(),this._initTemplates(),this._super()},_create:function(){this._super(),this._merging=0,this._mergingQueue=i.Deferred().resolveWith(this).promise()},_renderError:function(e,t){this._renderPercentage(e,1,1,t),e.addClass("u-fileupload-error").find(".j-pgr").addClass("u-progress-error").find(".u-progress-bar").end().end().find(".j-btns").empty().append(this._renderButton("delete"))},_renderPercentage:function(e,t,n,r){var s=this.options,o=Math.floor(t/n*100),l=e.find(".j-pgr .u-progress-bar");l.length>0?l.css("width",o+"%").html(r||o+"%"):(l=a.compile(s.progressTemplate)({percentage:r||o+"%"}),l=i(l).find(".u-progress-bar").css("width",o+"%").end(),e.find(".j-info").replaceWith(l))},_renderInfo:function(e,t){var n=this.options,i=e.find(".j-info");t=t||'<i class="iconfont iconchoose"></i>',e.addClass("u-fileupload-success"),i.length>0?i.html(t):(i=a.compile(n.infoTemplate)({info:t}),e.find(".j-pgr").replaceWith(i))},_renderSize:function(e,t,n){var i=e.find(".j-size"),a="";return void 0==t||void 0==n?!1:(a=t>=n?r.size.bytesToSize(t,2):r.size.bytesToSize(t,2)+" / "+r.size.bytesToSize(n,2),void i.text(a).show())},_renderTemplate:function(e){var t,n,s,o=this.options,l=!this.isPluginValid()&&!this._isXHRUpload(o),c=e[0],d=c.cmMeta,u=d.dname;return o.enableSecurityLevel?(s=r.securityLevel.departSLFromFilename(u),s?(d.securityLevel=d.securityLevel||r.securityLevel.getSLValueByName(s),n=u):(d.securityLevel=d.securityLevel||o.curMailSecurityLevel,n=r.securityLevel.i18n(d.securityLevel,"sender_security_level",!0)+u)):n=u,t=a.compile(o.uploadTemplate)({icon:"iconacc",oname:u,name:n,info:o.messages.prepare,size:l?!1:d.dsize,loaded:l?!1:0,total:l?!1:r.size.bytesToSize(d.dsize||0,2)}),i(t)},_renderNewFileDom:function(e){var t=this.options;e.context=this._renderTemplate(e.files).data("data",e).addClass("j-fileupload"),e.context.find(".j-btns").append(this._renderButton(this.buttonTypes.CANCEL)),t.filesContainer[t.prependFiles?"prepend":"append"](e.context)},_renderPreviewButton:function(e){var n,i=e.files[0];return t(i.cmMeta.dname,i.cmMeta.size)&&(n=this._generatePreviewUrl(e))?this._renderButton("preview",n):""},_renderSecLevelButton:function(e){var t=r.securityLevel.getMatchExpression("sender_security_level");return this.options.enableSecurityLevel?t&&e.files[0].cmMeta.dname.match(t)?"":this._renderButton(this.buttonTypes.EDITSECURITYLEVEL):""},_renderButton:function(e,t){var n,i=this.options,r=this.buttonTypes,s="";switch(e){case r.CANCEL:e="j-cancel",n=i.i18n("cancel");break;case r.DELETE:e="j-delete",n=i.i18n("remove");break;case r.CONTINUE:e="j-start",n=i.i18n("carryon");break;case r.PREVIEW:s="_blank",e="j-preview",n=i.i18n("preview");break;case r.DOWNLOAD:e="j-download",n=i.i18n("download");break;case r.EDITSECURITYLEVEL:e="j-editSecurityLevel",n=i.i18n("editSecurityLevel")}return a.compile(i.buttonTemplate)({type:e,target:s,name:n,href:t||"javascript:void(0);"})},_uiFileNewHandle:function(e){this._renderNewFileDom(e);var t=e.files[0].cmMeta.type;t===l.fileTypes.trs&&this._uiUploadToTrs(e)},_uiFileRestoreHandle:function(e){this._generateDownloadUrl(e),this._renderNewFileDom(e),e.context.find(".j-btns").append(this._renderButton(this.buttonTypes.DELETE)).append(this._renderButton(this.buttonTypes.DOWNLOAD,e.files[0].downloadUrl)).append(this._renderPreviewButton(e)).append(this._renderSecLevelButton(e)),this._renderSize(e.context,e.files[0].size,e.files[0].size),this._renderInfo(e.context)},_uiFileDestroyHandle:function(e,t){null!=e?e.context.remove():t&&t.file&&this.options.filesContainer.find(".j-fileupload").each(function(){var e=i(this).data("data");return e.files[0].cmMeta.dname===t.file.cmMeta.dname?(i(this).remove(),!1):void 0})},_uiUploadIframe:function(e){this._renderPercentage(e.context,1,1,e.i18n("uploading"))},_uiUploadProcessing:function(e){e.context.addClass("processing")},_uiUploadProcessed:function(e){e.context.removeClass("processing")},_uiUploadProgress:function(e,t){t=i.isPlainObject(t)?t:{};var n=null==t.loaded?e.loaded:t.loaded,a=null==t.total?e.total:t.total;this._renderPercentage(e.context,n,a),this._renderSize(e.context,n,a)},_uiUploadToTrs:function(e){var t=e.context,n=t.find(".j-trs-expire");t.addClass("u-fileupload-trs"),n.removeClass("f-dn").text(" ("+r.i18n.t("file/msg_trs_file_alive",{count:o.getConfig("file.trsfileexpiry")})+")")},_uiUploadDone:function(e){var t=e.files[0];this._renderInfo(e.context),this._renderSize(e.context,t.cmMeta.size,t.cmMeta.size),this._generateDownloadUrl(e),e.context.find(".j-btns").find(".j-cancel").remove().end().append(this._renderButton(this.buttonTypes.DELETE)).append(this._renderButton(this.buttonTypes.DOWNLOAD,e.files[0].downloadUrl)).append(this._renderPreviewButton(e)).append(this._renderSecLevelButton(e))},_uiUploadFail:function(e){this._renderError(e.context,e.files[0].error)},mergeFiles:function(e){function t(e){var t=i.Deferred(),a=e.cmMeta=l.initFileInstance(e.type,e);return a.type!==l.fileTypes.netfolder?t.resolve(e):(a.size+r.calUploadedAttachmentSize()>r.options.maxAttachmentSize?n(a.mid,a.enfUid).then(function(n){var i={name:a.name,size:a.size,contentType:a.contentType,type:l.fileTypes.trs};i.composeToTrs=!0,a.setDeleted(!0),i.cmMeta=l.TrsFile.migrateInstance(a,n[a.mid]),t.resolve([e,i])},function(){t.resolve(e)}):t.resolve(e),t.promise())}function a(e){i.isArray(e)||(e=[e]);var t=r._filterFiles(e);return t.add.length?(r._addUploadFiles(t.add),void i.each(t.add,function(e,t){var n={};t.inlined||t.cmMeta.deleted||(t.cmMeta.type===l.fileTypes.trs?r._initUploadMeta(n,r.uploadTypes.trs):r._initUploadMeta(n,r.uploadTypes.compose),n._widgetName=r.widgetFullName||r.widgetName,n.files=[t],r._trigger("viewUpdate",null,[r.viewMsgTypes.fileNew,n]),r._trigger("done",null,n))})):!1}var r=this;i.isArray(e)||(e=[e]),0===this._merging&&this._trigger("mergestart"),i.each(e,function(e,n){var s=function(){var e=i.Deferred();return i.when(t(n)).always(function(t){a(t),e.resolve()}),e.promise()};r._merging+=1,r._mergingQueue=r._mergingQueue.then(s,s).always(function(){r._merging-=1,0===r._merging&&r._trigger("mergestop")})})},allFiles:function(){return this._uploadFiles.slice()},forceUploadToTrs:function(){var e=this.options;if(!this.enableTrsUpload())return!1;var t={forceToTrs:!0};this.isPluginValid()?this.element.trigger("click",t):e.fileInput.focus().trigger("click",t)},detectUploadedAttachSizeExceed:function(){var e=this.options.maxAttachmentSize;return e=parseInt(e,10),isNaN(e)?!1:this.calUploadedAttachmentSize()>e},calUploadedAttachmentSize:function(){var e=0,t=l.fileTypes;return i.each(this._uploadFiles,function(n,i){var a,r;i.hasOwnProperty("error")||i.inlined||(a=i.cmMeta,r=a.type,a.deleted||(r===t.upload||r===t.netfolder||r===t.internal)&&(e+=a.size))}),e}})})}(),define("component/securityleveldg",["require","jquery","util/index","cui/ui/dialog/confirmbox"],function(e){var t=e("jquery"),n=e("util/index"),i=e("cui/ui/dialog/confirmbox"),a='<div class="u-securityLevelPanel"><div class="wrapper"><label class="label">{{name}}</label><div class="j-filename f-ellipsis"></div></div><div class="wrapper"><label class="label">{{level}}</label><div class="u-btns j-levels">{{#each schema}}<span role="securityLevel" class="u-btn u-btn-default f-ellipsis" lname="{{this}}" lvalue="{{@key}}">{{this}}</span>{{/each}}</div></div></div>',r=i.extend({events:{'click [role="securityLevel"]':"_setCurrentSecurityLevel"},attrs:{title:n.i18n.t("common/lbl_sec_panel_title"),message:a,onSelect:t.noop()},_params:{schema:n.securityLevel.getSchema(!0,!0)},setup:function(){var e=this;e.set("message",e.compile(a,{schema:e._params.schema,name:n.i18n.t("common/lbl_attach_name"),level:n.i18n.t("common/lbl_attach_level")})),r.superclass.setup.call(e),e.on("confirm",function(){e.hide(),e.trigger("select",e._getCurrentSecurityLevel(),e.$(".j-filename").html())})},render:function(){r.superclass.render.call(this),this.renderFinish=!0,this.trigger("render:finish")},_setCurrentSecurityLevel:function(e,n){var i=this;i.$(".j-levels span").removeClass("z-current"),t(n).addClass("z-current")},_getCurrentSecurityLevel:function(){var e=this.$(".j-levels span.z-current");return{name:e.attr("lname"),value:parseInt(e.attr("lvalue"))}},setSecurityLevel:function(e,i,a){if(!e){var r=n.securityLevel.departSLFromFilename(i);r&&(e=n.securityLevel.getSLValueByName(r))}e||(e=a),this.$(".j-filename").html(n.html.encode(i)),this.$(".j-levels span").removeClass("z-current").each(function(){var n=t(this).attr("lvalue");return n==e?(t(this).addClass("z-current"),!1):void 0})}});return t.fn.securityleveldg=function(e,n,i){return this.each(function(){var a=this;if("string"===t.type(e))switch(e){case"show":this.securityleveldgInstance.get("visible")||this.securityleveldgInstance.show(),this.securityleveldgInstance.renderFinish?this.securityleveldgInstance.setSecurityLevel(n,i):this.securityleveldgInstance.on("render:finish",function(){setTimeout(function(){a.securityleveldgInstance.setSecurityLevel(n,i)},200)});break;default:throw new Error("method"+e+"not exist.")}else this.securityleveldgInstance=new r(e)})},r}),function(window,undefined){function _isArray(e){return e?"[object Array]"===Object.prototype.toString.call(e):!1}function _isFunction(e){return e?"[object Function]"===Object.prototype.toString.call(e):!1}function _inArray(e,t){for(var n=0,i=t.length;i>n;n++)if(e===t[n])return n;return-1}function _each(e,t){if(_isArray(e))for(var n=0,i=e.length;i>n&&t.call(e[n],n,e[n])!==!1;n++);else for(var a in e)if(e.hasOwnProperty(a)&&t.call(e[a],a,e[a])===!1)break}function _trim(e){return e.replace(/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"")}function _inString(e,t,n){return n=n===undefined?",":n,(n+t+n).indexOf(n+e+n)>=0}function _addUnit(e,t){return t=t||"px",e&&/^\d+$/.test(e)?e+t:e}function _removeUnit(e){var t;return e&&(t=/(\d+)/.exec(e))?parseInt(t[1],10):0}function _escape(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function _unescape(e){return e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")}function _toCamel(e){var t=e.split("-");return e="",_each(t,function(t,n){e+=t>0?n.charAt(0).toUpperCase()+n.substr(1):n}),e}function _toHex(e){function t(e){var t=parseInt(e,10).toString(16).toUpperCase();return t.length>1?t:"0"+t}return e.replace(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/gi,function(e,n,i,a){return"#"+t(n)+t(i)+t(a)})}function _toMap(e,t){t=t===undefined?",":t;var n,i={},a=_isArray(e)?e:e.split(t);return _each(a,function(e,t){if(n=/^(\d+)\.\.(\d+)$/.exec(t))for(var a=parseInt(n[1],10);a<=parseInt(n[2],10);a++)i[a.toString()]=!0;else i[t]=!0}),i}function _toArray(e,t){return Array.prototype.slice.call(e,t||0)}function _undef(e,t){return e===undefined?t:e}function _invalidUrl(e){return!e||/[<>"]/.test(e)}function _addParam(e,t){return e.indexOf("?")>=0?e+"&"+t:e+"?"+t}function _extend(e,t,n){n||(n=t,t=null);var i;if(t){var a=function(){};a.prototype=t.prototype,i=new a,_each(n,function(e,t){i[e]=t})}else i=n;i.constructor=e,e.prototype=i,e.parent=t?t.prototype:null}function _json(text){var match;(match=/\{[\s\S]*\}|\[[\s\S]*\]/.exec(text))&&(text=match[0]);var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return eval("("+text+")");throw"JSON parse error"}function _getBasePath(){for(var e,t=document.getElementsByTagName("script"),n=0,i=t.length;i>n;n++)if(e=t[n].src||"",/kindeditor[\w\-\.]*\.js/.test(e))return e.substring(0,e.lastIndexOf("/")+1);return""}function _bindEvent(e,t,n){e.addEventListener?e.addEventListener(t,n,_useCapture):e.attachEvent&&e.attachEvent("on"+t,n)}function _unbindEvent(e,t,n){e.removeEventListener?e.removeEventListener(t,n,_useCapture):e.detachEvent&&e.detachEvent("on"+t,n)}function KEvent(e,t){this.init(e,t)}function _getId(e){return e[_eventExpendo]||null}function _setId(e){return e[_eventExpendo]=++_eventId,_eventId}function _removeId(e){try{delete e[_eventExpendo]}catch(t){e.removeAttribute&&e.removeAttribute(_eventExpendo)}}function _bind(e,t,n){if(t.indexOf(",")>=0)return void _each(t.split(","),function(){_bind(e,this,n)});var i=_getId(e);i||(i=_setId(e)),_eventData[i]===undefined&&(_eventData[i]={});var a=_eventData[i][t];a&&a.length>0?_unbindEvent(e,t,a[0]):(_eventData[i][t]=[],_eventData[i].el=e),a=_eventData[i][t],0===a.length&&(a[0]=function(t){var n=t?new KEvent(e,t):undefined;_each(a,function(t,i){t>0&&i&&i.call(e,n)})}),_inArray(n,a)<0&&a.push(n),_bindEvent(e,t,a[0])}function _unbind(e,t,n){if(t&&t.indexOf(",")>=0)return void _each(t.split(","),function(){_unbind(e,this,n)});var i=_getId(e);if(i){if(t===undefined)return void(i in _eventData&&(_each(_eventData[i],function(t,n){"el"!=t&&n.length>0&&_unbindEvent(e,t,n[0])}),delete _eventData[i],_removeId(e)));if(_eventData[i]){var a=_eventData[i][t];if(a&&a.length>0){n===undefined?(_unbindEvent(e,t,a[0]),delete _eventData[i][t]):(_each(a,function(e,t){e>0&&t===n&&a.splice(e,1)}),1==a.length&&(_unbindEvent(e,t,a[0]),delete _eventData[i][t]));var r=0;_each(_eventData[i],function(){r++}),2>r&&(delete _eventData[i],_removeId(e))}}}}function _fire(e,t){if(t.indexOf(",")>=0)return void _each(t.split(","),function(){_fire(e,this)});var n=_getId(e);if(n){var i=_eventData[n][t];_eventData[n]&&i&&i.length>0&&i[0]()}}function _ctrl(e,t,n){t=/^\d{2,}$/.test(t)?t:t.toUpperCase().charCodeAt(0),_bind(e,"keydown",function(i){!i.ctrlKey||i.which!=t||i.shiftKey||i.altKey||(n.call(e),i.stop())})}function _ready(e){function t(){a||(a=!0,e(KindEditor),_readyFinished=!0)}function n(){if(!a){try{document.documentElement.doScroll("left")}catch(e){return void setTimeout(n,100)}t()}}function i(){"complete"===document.readyState&&t()}if(_readyFinished)return void e(KindEditor);var a=!1;if(document.addEventListener)_bind(document,"DOMContentLoaded",t);else if(document.attachEvent){_bind(document,"readystatechange",i);var r=!1;try{r=null==window.frameElement}catch(s){}document.documentElement.doScroll&&r&&n()}_bind(window,"load",t)}function _getCssList(e){for(var t,n={},i=/\s*([\w\-]+)\s*:([^;]*)(;|$)/g;t=i.exec(e);){var a=_trim(t[1].toLowerCase()),r=_trim(_toHex(t[2]));n[a]=r}return n}function _getAttrList(e){for(var t,n={},i=/\s+(?:([\w\-:]+)|(?:([\w\-:]+)=([^\s"'<>]+))|(?:([\w\-:"]+)="([^"]*)")|(?:([\w\-:"]+)='([^']*)'))(?=(?:\s|\/|>)+)/g;t=i.exec(e);){var a=(t[1]||t[2]||t[4]||t[6]).toLowerCase(),r=(t[2]?t[3]:t[4]?t[5]:t[7])||"";n[a]=r}return n}function _addClassToTag(e,t){return e=/\s+class\s*=/.test(e)?e.replace(/(\s+class=["']?)([^"']*)(["']?[\s>])/,function(e,n,i,a){return(" "+i+" ").indexOf(" "+t+" ")<0?""===i?n+t+a:n+i+" "+t+a:e}):e.substr(0,e.length-1)+' class="'+t+'">'}function _formatCss(e){var t="";return _each(_getCssList(e),function(e,n){t+=e+":"+n+";"}),t}function _formatUrl(e,t,n,i){function a(e){for(var t=e.split("/"),n=[],i=0,a=t.length;a>i;i++){var r=t[i];".."==r?n.length>0&&n.pop():""!==r&&"."!=r&&n.push(r)}return"/"+n.join("/")}function r(t,n){if(e.substr(0,t.length)===t){for(var a=[],s=0;n>s;s++)a.push("..");var l=".";return a.length>0&&(l+="/"+a.join("/")),"/"==i&&(l+="/"),l+e.substr(t.length)}return(o=/^(.*)\//.exec(t))?r(o[1],++n):void 0}if(t=_undef(t,"").toLowerCase(),"data:"!=e.substr(0,5)&&(e=e.replace(/([^:])\/\//g,"$1/")),_inArray(t,["absolute","relative","domain"])<0)return e;if(n=n||location.protocol+"//"+location.host,i===undefined){var s=location.pathname.match(/^(\/.*)\//);i=s?s[1]:""}var o;if(o=/^(\w+:\/\/[^\/]*)/.exec(e)){if(o[1]!==n)return e}else if(/^\w+:/.test(e))return e;return/^\//.test(e)?e=n+a(e.substr(1)):/^\w+:\/\//.test(e)||(e=n+a(i+"/"+e)),"relative"===t?e=r(n+i,0).substr(2):"absolute"===t&&e.substr(0,n.length)===n&&(e=e.substr(n.length)),e}function _formatHtml(e,t,n,i,a){null==e&&(e=""),n=n||"",i=_undef(i,!1),a=_undef(a,"	");var r="xx-small,x-small,small,medium,large,x-large,xx-large".split(",");e=e.replace(/(<(?:pre|pre\s[^>]*)>)([\s\S]*?)(<\/pre>)/gi,function(e,t,n,i){return t+n.replace(/<(?:br|br\s[^>]*)>/gi,"\n")+i}),e=e.replace(/<(?:br|br\s[^>]*)\s*\/?>\s*<\/p>/gi,"</p>"),e=e.replace(/(<(?:p|p\s[^>]*)>)\s*(<\/p>)/gi,"$1<br />$2"),e=e.replace(/\u200B/g,""),e=e.replace(/\u00A9/g,"&copy;"),e=e.replace(/\u00AE/g,"&reg;"),e=e.replace(/<[^>]+/g,function(e){return e.replace(/\s+/g," ")});var s={};t&&(_each(t,function(e,t){for(var n=e.split(","),i=0,a=n.length;a>i;i++)s[n[i]]=_toMap(t)}),s.script||(e=e.replace(/(<(?:script|script\s[^>]*)>)([\s\S]*?)(<\/script>)/gi,"")),s.style||(e=e.replace(/(<(?:style|style\s[^>]*)>)([\s\S]*?)(<\/style>)/gi,"")));var o=/(\s*)<(\/)?([\w\-:]+)((?:\s+|(?:\s+[\w\-:]+)|(?:\s+[\w\-:]+=[^\s"'<>]+)|(?:\s+[\w\-:"]+="[^"]*")|(?:\s+[\w\-:"]+='[^']*'))*)(\/)?>(\s*)/g,l=[];return e=e.replace(o,function(e,o,c,d,u,p,m){var h=e,f=o||"",v=c||"",g=d.toLowerCase(),b=u||"",_=p?" "+p:"",y=m||"";if(t&&!s[g])return"";if(""===_&&_SINGLE_TAG_MAP[g]&&(_=" /"),_INLINE_TAG_MAP[g]&&(f&&(f=" "),y&&(y=" ")),_PRE_TAG_MAP[g]&&(v?y="\n":f="\n"),i&&"br"==g&&(y="\n"),_BLOCK_TAG_MAP[g]&&!_PRE_TAG_MAP[g])if(i){v&&l.length>0&&l[l.length-1]===g?l.pop():l.push(g),f="\n",y="\n";for(var w=0,x=v?l.length:l.length-1;x>w;w++)f+=a,v||(y+=a);_?l.pop():v||(y+=a)}else f=y="";if(""!==b){var C=_getAttrList(h);if("font"===g){var k={},S="";_each(C,function(e,t){"color"===e&&(k.color=t,delete C[e]),"size"===e&&(k["font-size"]=r[parseInt(t,10)-1]||"",delete C[e]),"face"===e&&(k["font-family"]=t,delete C[e]),"style"===e&&(S=t)}),S&&!/;$/.test(S)&&(S+=";"),_each(k,function(e,t){""!==t&&(/\s/.test(t)&&(t="'"+t+"'"),S+=e+":"+t+";")}),C.style=S}_each(C,function(e,i){if(_FILL_ATTR_MAP[e]&&(C[e]=e),_inArray(e,["src","href"])>=0&&(C[e]=_formatUrl(i,n)),(t&&"style"!==e&&!s[g]["*"]&&!s[g][e]||"body"===g&&"contenteditable"===e||/^kindeditor_\d+$/.test(e))&&delete C[e],"style"===e&&""!==i){var a=_getCssList(i);_each(a,function(e,n){!t||s[g].style||s[g]["."+e]||delete a[e]});var r="";_each(a,function(e,t){r+=e+":"+t+";"}),C.style=r}}),b="",_each(C,function(e,t){("style"!==e||""!==t)&&(t=t.replace(/"/g,"&quot;"),b+=" "+e+'="'+t+'"')})}return"font"===g&&(g="span"),f+"<"+v+g+b+_+">"+y}),e=e.replace(/(<(?:pre|pre\s[^>]*)>)([\s\S]*?)(<\/pre>)/gi,function(e,t,n,i){return t+n.replace(/\n/g,'<span id="__kindeditor_pre_newline__">\n')+i}),e=e.replace(/\n\s*\n/g,"\n"),e=e.replace(/<span id="__kindeditor_pre_newline__">\n/g,"\n"),_trim(e)}function _clearMsWord(e,t){return e=e.replace(/<meta[\s\S]*?>/gi,"").replace(/<![\s\S]*?>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<w:[^>]+>[\s\S]*?<\/w:[^>]+>/gi,"").replace(/<o:[^>]+>[\s\S]*?<\/o:[^>]+>/gi,"").replace(/<xml>[\s\S]*?<\/xml>/gi,"").replace(/<(?:table|td)[^>]*>/gi,function(e){return e.replace(/border-bottom:([#\w\s]+)/gi,"border:$1")}),_formatHtml(e,t)}function _mediaType(e){return/\.(rm|rmvb)(\?|$)/i.test(e)?"audio/x-pn-realaudio-plugin":/\.(swf|flv)(\?|$)/i.test(e)?"application/x-shockwave-flash":"video/x-ms-asf-plugin"}function _mediaClass(e){return/realaudio/i.test(e)?"ke-rm":/flash/i.test(e)?"ke-flash":"ke-media"}function _mediaAttrs(e){return _getAttrList(unescape(e))}function _mediaEmbed(e){var t="<embed ";return _each(e,function(e,n){t+=e+'="'+n+'" '}),t+="/>"}function _mediaImg(e,t){var n=t.width,i=t.height,a=t.type||_mediaType(t.src),r=_mediaEmbed(t),s="";/\D/.test(n)?s+="width:"+n+";":n>0&&(s+="width:"+n+"px;"),/\D/.test(i)?s+="height:"+i+";":i>0&&(s+="height:"+i+"px;");var o='<img class="'+_mediaClass(a)+'" src="'+e+'" ';return""!==s&&(o+='style="'+s+'" '),o+='data-ke-tag="'+escape(r)+'" alt="" />'}function _tmpl(e,t){var n=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return t?n(t):n}function _contains(e,t){if(9==e.nodeType&&9!=t.nodeType)return!0;for(;t=t.parentNode;)if(t==e)return!0;return!1}function _getAttr(e,t){t=t.toLowerCase();var n=null;if(_GET_SET_ATTRIBUTE||"script"==e.nodeName.toLowerCase())try{n=e.getAttribute(t,2)}catch(i){n=e.getAttribute(t,1)}else{var a=e.ownerDocument.createElement("div");a.appendChild(e.cloneNode(!1));var r=_getAttrList(_unescape(a.innerHTML));t in r&&(n=r[t])}return"style"===t&&null!==n&&(n=_formatCss(n)),n}function _queryAll(e,t){function n(e){return"string"!=typeof e?e:e.replace(/([^\w\-])/g,"\\$1")}function i(e){return e.replace(/\\/g,"")}function a(e,t){return"*"===e||e.toLowerCase()===n(t.toLowerCase())}function r(e,t,n){var r=[],s=n.ownerDocument||n,o=s.getElementById(i(e));return o&&a(t,o.nodeName)&&_contains(n,o)&&r.push(o),r}function s(e,t,n){var r,s,o,l,c=n.ownerDocument||n,d=[];if(n.getElementsByClassName)for(r=n.getElementsByClassName(i(e)),s=0,o=r.length;o>s;s++)l=r[s],a(t,l.nodeName)&&d.push(l);else if(c.querySelectorAll)for(r=c.querySelectorAll(("#document"!==n.nodeName?n.nodeName+" ":"")+t+"."+e),s=0,o=r.length;o>s;s++)l=r[s],_contains(n,l)&&d.push(l);else for(r=n.getElementsByTagName(t),e=" "+e+" ",s=0,o=r.length;o>s;s++)if(l=r[s],1==l.nodeType){var u=l.className;u&&(" "+u+" ").indexOf(e)>-1&&d.push(l)}return d}function o(e,t,n){for(var r,s=[],o=n.ownerDocument||n,l=o.getElementsByName(i(e)),c=0,d=l.length;d>c;c++)r=l[c],a(t,r.nodeName)&&_contains(n,r)&&null!==r.getAttribute("name")&&s.push(r);return s}function l(e,t,i,a){for(var r,s=[],o=a.getElementsByTagName(i),l=0,c=o.length;c>l;l++)r=o[l],1==r.nodeType&&(null===t?null!==_getAttr(r,e)&&s.push(r):t===n(_getAttr(r,e))&&s.push(r));return s}function c(e,t){var n,i=[];n=/^((?:\\.|[^.#\s\[<>])+)/.exec(e);var a=n?n[1]:"*";if(n=/#((?:[\w\-]|\\.)+)$/.exec(e))i=r(n[1],a,t);else if(n=/\.((?:[\w\-]|\\.)+)$/.exec(e))i=s(n[1],a,t);else if(n=/\[((?:[\w\-]|\\.)+)\]/.exec(e))i=l(n[1].toLowerCase(),null,a,t);else if(n=/\[((?:[\w\-]|\\.)+)\s*=\s*['"]?((?:\\.|[^'"]+)+)['"]?\]/.exec(e)){var c=n[1].toLowerCase(),d=n[2];i="id"===c?r(d,a,t):"class"===c?s(d,a,t):"name"===c?o(d,a,t):l(c,d,a,t)}else for(var u,p=t.getElementsByTagName(a),m=0,h=p.length;h>m;m++)u=p[m],1==u.nodeType&&i.push(u);return i}var d=e.split(",");if(d.length>1){var u=[];return _each(d,function(){_each(_queryAll(this,t),function(){_inArray(this,u)<0&&u.push(this)})}),u}t=t||document;for(var p,m=[],h=/((?:\\.|[^\s>])+|[\s>])/g;p=h.exec(e);)" "!==p[1]&&m.push(p[1]);var f=[];if(1==m.length)return c(m[0],t);var v,g,b,_,y,w,x,C,k,S,T=!1;for(w=0,lenth=m.length;w<lenth;w++)if(v=m[w],">"!==v){if(w>0){for(g=[],x=0,k=f.length;k>x;x++)for(_=f[x],b=c(v,_),C=0,S=b.length;S>C;C++)y=b[C],T?_===y.parentNode&&g.push(y):g.push(y);f=g}else f=c(v,t);if(0===f.length)return[]}else T=!0;return f}function _query(e,t){var n=_queryAll(e,t);return n.length>0?n[0]:null}function _get(e){return K(e)[0]}function _getDoc(e){return e?e.ownerDocument||e.document||e:document}function _getWin(e){if(!e)return window;var t=_getDoc(e);return t.parentWindow||t.defaultView}function _setHtml(e,t){if(1==e.nodeType){var n=_getDoc(e);try{e.innerHTML='<img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" />'+t;var i=n.getElementById("__kindeditor_temp_tag__");i.parentNode.removeChild(i)}catch(a){K(e).empty(),K("@"+t,n).each(function(){
e.appendChild(this)})}}}function _hasClass(e,t){return _inString(t,e.className," ")}function _setAttr(e,t,n){_IE&&8>_V&&"class"==t.toLowerCase()&&(t="className"),e.setAttribute(t,""+n)}function _removeAttr(e,t){_IE&&8>_V&&"class"==t.toLowerCase()&&(t="className"),_setAttr(e,t,""),e.removeAttribute(t)}function _getNodeName(e){return e&&e.nodeName?e.nodeName.toLowerCase():""}function _computedCss(e,t){var n=_getWin(e),i=_toCamel(t),a="";if(n.getComputedStyle){var r=n.getComputedStyle(e,null);a=r[i]||r.getPropertyValue(t)||e.style[i]}else e.currentStyle&&(a=e.currentStyle[i]||e.style[i]);return a}function _hasVal(e){return!!_VALUE_TAG_MAP[_getNodeName(e)]}function _docElement(e){return e=e||document,_QUIRKS?e.body:e.documentElement}function _docHeight(e){var t=_docElement(e);return Math.max(t.scrollHeight,t.clientHeight)}function _docWidth(e){var t=_docElement(e);return Math.max(t.scrollWidth,t.clientWidth)}function _getScrollPos(e){e=e||document;var t,n;return _IE||_NEWIE||_OPERA?(t=_docElement(e).scrollLeft,n=_docElement(e).scrollTop):(t=_getWin(e).scrollX,n=_getWin(e).scrollY),{x:t,y:n}}function KNode(e){this.init(e)}function _updateCollapsed(e){return e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e}function _copyAndDelete(e,t,n){function i(i,a,r){var s,l=i.nodeValue.length;if(t){var c=i.cloneNode(!0);s=a>0?c.splitText(a):c,l>r&&s.splitText(r-a)}if(n){var d=i;if(a>0&&(d=i.splitText(a),e.setStart(i,a)),l>r){var u=d.splitText(r-a);e.setEnd(u,0)}o.push(d)}return s}function a(){n&&e.up().collapse(!0);for(var t=0,i=o.length;i>t;t++){var a=o[t];a.parentNode&&a.parentNode.removeChild(a)}}function r(a,m){for(var h,f=a.firstChild;f;){var v=new KRange(s).selectNode(f);if(c=v.compareBoundaryPoints(_START_TO_END,e),c>=0&&0>=d&&(d=v.compareBoundaryPoints(_START_TO_START,e)),d>=0&&0>=u&&(u=v.compareBoundaryPoints(_END_TO_END,e)),u>=0&&0>=p&&(p=v.compareBoundaryPoints(_END_TO_START,e)),p>=0)return!1;if(h=f.nextSibling,c>0)if(1==f.nodeType)if(d>=0&&0>=u)t&&m.appendChild(f.cloneNode(!0)),n&&o.push(f);else{var g;if(t&&(g=f.cloneNode(!1),m.appendChild(g)),r(f,g)===!1)return!1}else if(3==f.nodeType){var b;if(b=f==l.startContainer?i(f,l.startOffset,f.nodeValue.length):f==l.endContainer?i(f,0,l.endOffset):i(f,0,f.nodeValue.length),t)try{m.appendChild(b)}catch(_){}}f=h}}var s=e.doc,o=[],l=e.cloneRange().down(),c=-1,d=-1,u=-1,p=-1,m=e.commonAncestor(),h=s.createDocumentFragment();if(3==m.nodeType){var f=i(m,e.startOffset,e.endOffset);return t&&h.appendChild(f),a(),t?h:e}r(m,h),n&&e.up().collapse(!0);for(var v=0,g=o.length;g>v;v++){var b=o[v];b.parentNode&&b.parentNode.removeChild(b)}return t?h:e}function _moveToElementText(e,t){for(var n=t;n;){var i=K(n);if("marquee"==i.name||"select"==i.name)return;n=n.parentNode}try{e.moveToElementText(t)}catch(a){}}function _getStartEnd(e,t){var n=e.parentElement().ownerDocument,i=e.duplicate();i.collapse(t);var a=i.parentElement(),r=a.childNodes;if(0===r.length)return{node:a.parentNode,offset:K(a).index()};var s=n,o=0,l=-1,c=e.duplicate();_moveToElementText(c,a);for(var d=0,u=r.length;u>d;d++){var p=r[d];if(l=c.compareEndPoints("StartToStart",i),0===l)return{node:p.parentNode,offset:d};if(1==p.nodeType){var m,h=e.duplicate(),f=K(p),v=p;f.isControl()&&(m=n.createElement("span"),f.after(m),v=m,o+=f.text().replace(/\r\n|\n|\r/g,"").length),_moveToElementText(h,v),c.setEndPoint("StartToEnd",h),l>0?o+=h.text.replace(/\r\n|\n|\r/g,"").length:o=0,m&&K(m).remove()}else 3==p.nodeType&&(c.moveStart("character",p.nodeValue.length),o+=p.nodeValue.length);0>l&&(s=p)}if(0>l&&1==s.nodeType)return{node:a,offset:K(a.lastChild).index()+1};if(l>0)for(;s.nextSibling&&1==s.nodeType;)s=s.nextSibling;if(c=e.duplicate(),_moveToElementText(c,a),c.setEndPoint("StartToEnd",i),o-=c.text.replace(/\r\n|\n|\r/g,"").length,l>0&&3==s.nodeType)for(var g=s.previousSibling;g&&3==g.nodeType;)o-=g.nodeValue.length,g=g.previousSibling;return{node:s,offset:o}}function _getEndRange(e,t){var n=e.ownerDocument||e,i=n.body.createTextRange();if(n==e)return i.collapse(!0),i;if(1==e.nodeType&&e.childNodes.length>0){var a,r,s=e.childNodes;if(0===t?(r=s[0],a=!0):(r=s[t-1],a=!1),!r)return i;if("head"===K(r).name)return 1===t&&(a=!0),2===t&&(a=!1),i.collapse(a),i;if(1==r.nodeType){var o,l=K(r);return l.isControl()&&(o=n.createElement("span"),a?l.before(o):l.after(o),r=o),_moveToElementText(i,r),i.collapse(a),o&&K(o).remove(),i}e=r,t=a?0:r.nodeValue.length}var c=n.createElement("span");return K(e).before(c),_moveToElementText(i,c),i.moveStart("character",t),K(c).remove(),i}function _toRange(e){function t(e){"tr"==K(e.node).name&&(e.node=e.node.cells[e.offset],e.offset=0)}var n,i;if(_IERANGE){if(e.item)return n=_getDoc(e.item(0)),i=new KRange(n),i.selectNode(e.item(0)),i;n=e.parentElement().ownerDocument;var a=_getStartEnd(e,!0),r=_getStartEnd(e,!1);return t(a),t(r),i=new KRange(n),i.setStart(a.node,a.offset),i.setEnd(r.node,r.offset),i}var s=e.startContainer;return n=s.ownerDocument||s,i=new KRange(n),i.setStart(s,e.startOffset),i.setEnd(e.endContainer,e.endOffset),i}function KRange(e){this.init(e)}function _range(e){return e.nodeName?new KRange(e):e.constructor===KRange?e:_toRange(e)}function _nativeCommand(e,t,n){try{e.execCommand(t,!1,n)}catch(i){}}function _nativeCommandValue(e,t){var n="";try{n=e.queryCommandValue(t)}catch(i){}return"string"!=typeof n&&(n=""),n}function _getSel(e){var t=_getWin(e);return _IERANGE?e.selection:t.getSelection()}function _getRng(e){var t,n=_getSel(e);try{t=n.rangeCount>0?n.getRangeAt(0):n.createRange()}catch(i){}return!_IERANGE||t&&(t.item||t.parentElement().ownerDocument===e)?t:null}function _singleKeyMap(e){var t,n,i={};return _each(e,function(e,a){t=e.split(",");for(var r=0,s=t.length;s>r;r++)n=t[r],i[n]=a}),i}function _hasAttrOrCss(e,t){return _hasAttrOrCssByKey(e,t,"*")||_hasAttrOrCssByKey(e,t)}function _hasAttrOrCssByKey(e,t,n){if(n=n||e.name,1!==e.type)return!1;var i=_singleKeyMap(t);if(!i[n])return!1;for(var a=i[n].split(","),r=0,s=a.length;s>r;r++){var o=a[r];if("*"===o)return!0;var l=/^(\.?)([^=]+)(?:=([^=]*))?$/.exec(o),c=l[1]?"css":"attr";o=l[2];var d=l[3]||"";if(""===d&&""!==e[c](o))return!0;if(""!==d&&e[c](o)===d)return!0}return!1}function _removeAttrOrCss(e,t){1==e.type&&(_removeAttrOrCssByKey(e,t,"*"),_removeAttrOrCssByKey(e,t))}function _removeAttrOrCssByKey(e,t,n){if(n=n||e.name,1===e.type){var i=_singleKeyMap(t);if(i[n]){for(var a=i[n].split(","),r=!1,s=0,o=a.length;o>s;s++){var l=a[s];if("*"===l){r=!0;break}var c=/^(\.?)([^=]+)(?:=([^=]*))?$/.exec(l);l=c[2],c[1]?(l=_toCamel(l),e[0].style[l]&&(e[0].style[l]="")):e.removeAttr(l)}r&&e.remove(!0)}}}function _getInnerNode(e){for(var t=e;t.first();)t=t.first();return t}function _isEmptyNode(e){return 1!=e.type||e.isSingle()?!1:""===e.html().replace(/<[^>]+>/g,"")}function _mergeWrapper(e,t){e=e.clone(!0);for(var n=_getInnerNode(e),i=e,a=!1;t;){for(;i;)i.name===t.name&&(_mergeAttrs(i,t.attr(),t.css()),a=!0),i=i.first();a||n.append(t.clone(!1)),a=!1,t=t.first()}return e}function _wrapNode(e,t){if(t=t.clone(!0),3==e.type)return _getInnerNode(t).append(e.clone(!1)),e.replaceWith(t),t;for(var n,i=e;(n=e.first())&&1==n.children().length;)e=n;n=e.first();for(var a=e.doc.createDocumentFragment();n;)a.appendChild(n[0]),n=n.next();return t=_mergeWrapper(i,t),a.firstChild&&_getInnerNode(t).append(a),i.replaceWith(t),t}function _mergeAttrs(e,t,n){_each(t,function(t,n){"style"!==t&&e.attr(t,n)}),_each(n,function(t,n){e.css(t,n)})}function _inPreElement(e){for(;e&&"body"!=e.name;){if(_PRE_TAG_MAP[e.name]||"div"==e.name&&e.hasClass("ke-script"))return!0;e=e.parent()}return!1}function KCmd(e){this.init(e)}function _cmd(e){if(e.nodeName){var t=_getDoc(e);e=_range(t).selectNodeContents(t.body).collapse(!1)}return new KCmd(e)}function _drag(e){var t=e.moveEl,n=e.moveFn,i=e.clickEl||t,a=e.beforeDrag,r=e.iframeFix===undefined?!0:e.iframeFix,s=[document];r&&K("iframe").each(function(){var e=_formatUrl(this.src||"","absolute");if(!/^https?:\/\//.test(e)){var t;try{t=_iframeDoc(this)}catch(n){}if(t){var i=K(this).pos();K(t).data("pos-x",i.x),K(t).data("pos-y",i.y),s.push(t)}}}),i.mousedown(function(e){function r(e){e.preventDefault();var t=K(_getDoc(e.target)),a=_round((t.data("pos-x")||0)+e.pageX-h),r=_round((t.data("pos-y")||0)+e.pageY-f);n.call(i,d,u,p,m,a,r)}function o(e){e.preventDefault()}function l(e){e.preventDefault(),K(s).unbind("mousemove",r).unbind("mouseup",l).unbind("selectstart",o),c.releaseCapture&&c.releaseCapture()}e.stopPropagation();var c=i.get(),d=_removeUnit(t.css("left")),u=_removeUnit(t.css("top")),p=t.width(),m=t.height(),h=e.pageX,f=e.pageY;a&&a(),K(s).mousemove(r).mouseup(l).bind("selectstart",o),c.setCapture&&c.setCapture()})}function KWidget(e){this.init(e)}function _widget(e){return new KWidget(e)}function _iframeDoc(e){return e=_get(e),e.contentDocument||e.contentWindow.document}function _getInitHtml(e,t,n,i){var a=[""===_direction?"<html>":'<html dir="'+_direction+'">','<head><meta charset="utf-8" /><title></title>',"<style>","html {margin:0;padding:0;}","body {margin:0;padding:5px;}",'body, td {font:12px/1.5 "sans serif",tahoma,verdana,helvetica;}',"body, p, div {word-wrap: break-word;}","p {margin:5px 0;}","table {border-collapse:collapse;}","img {border:0;}","noscript {display:none;}","table.ke-zeroborder td {border:1px dotted #AAA;}","img.ke-flash {","	border:1px solid #AAA;","	background-image:url("+e+"common/flash.gif);","	background-position:center center;","	background-repeat:no-repeat;","	width:100px;","	height:100px;","}","img.ke-rm {","	border:1px solid #AAA;","	background-image:url("+e+"common/rm.gif);","	background-position:center center;","	background-repeat:no-repeat;","	width:100px;","	height:100px;","}","img.ke-media {","	border:1px solid #AAA;","	background-image:url("+e+"common/media.gif);","	background-position:center center;","	background-repeat:no-repeat;","	width:100px;","	height:100px;","}","img.ke-anchor {","	border:1px dashed #666;","	width:16px;","	height:16px;","}",".ke-script, .ke-noscript, .ke-display-none {","	display:none;","	font-size:0;","	width:0;","	height:0;","}",".ke-pagebreak {","	border:1px dotted #AAA;","	font-size:0;","	height:2px;","}","</style>"];return _isArray(n)||(n=[n]),_each(n,function(e,t){t&&a.push('<link href="'+t+'" rel="stylesheet" />')}),i&&a.push("<style>"+i+"</style>"),a.push("</head><body "+(t?'class="'+t+'"':"")+"></body></html>"),a.join("\n")}function _elementVal(e,t){if(e.hasVal()){if(t===undefined){var n=e.val();return n=n.replace(/(<(?:p|p\s[^>]*)>) *(<\/p>)/gi,"")}return e.val(t)}return e.html(t)}function KEdit(e){this.init(e)}function _edit(e){return new KEdit(e)}function _selectToolbar(e,t){var n=this,i=n.get(e);if(i){if(i.hasClass("ke-disabled"))return;t(i)}}function KToolbar(e){this.init(e)}function _toolbar(e){return new KToolbar(e)}function KMenu(e){this.init(e)}function _menu(e){return new KMenu(e)}function KColorPicker(e){this.init(e)}function _colorpicker(e){return new KColorPicker(e)}function KUploadButton(e){this.init(e)}function _uploadbutton(e){return new KUploadButton(e)}function _createButton(e){e=e||{};var t=e.name||"",n=K('<span class="ke-button-common ke-button-outer" title="'+t+'"></span>'),i=K('<input class="ke-button-common ke-button" type="button" value="'+t+'" />');return e.click&&i.click(e.click),n.append(i),n}function KDialog(e){this.init(e)}function _dialog(e){return new KDialog(e)}function _tabs(e){var t=_widget(e),n=t.remove,i=e.afterSelect,a=t.div,r=[];a.addClass("ke-tabs").bind("contextmenu,mousedown,mousemove",function(e){e.preventDefault()});var s=K('<ul class="ke-tabs-ul ke-clearfix"></ul>');return a.append(s),t.add=function(e){var t=K('<li class="ke-tabs-li">'+e.title+"</li>");t.data("tab",e),r.push(t),s.append(t)},t.selectedIndex=0,t.select=function(e){t.selectedIndex=e,_each(r,function(n,i){i.unbind(),n===e?(i.addClass("ke-tabs-li-selected"),K(i.data("tab").panel).show("")):(i.removeClass("ke-tabs-li-selected").removeClass("ke-tabs-li-on").mouseover(function(){K(this).addClass("ke-tabs-li-on")}).mouseout(function(){K(this).removeClass("ke-tabs-li-on")}).click(function(){t.select(n)}),K(i.data("tab").panel).hide())}),i&&i.call(t,e)},t.remove=function(){_each(r,function(){this.remove()}),s.remove(),n.call(t)},t}function _loadScript(e,t){var n=document.getElementsByTagName("head")[0]||(_QUIRKS?document.body:document.documentElement),i=document.createElement("script");n.appendChild(i),i.src=e,i.charset="utf-8",i.onload=i.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState||(t&&t(),i.onload=i.onreadystatechange=null,n.removeChild(i))}}function _chopQuery(e){var t=e.indexOf("?");return t>0?e.substr(0,t):e}function _loadStyle(e){for(var t=document.getElementsByTagName("head")[0]||(_QUIRKS?document.body:document.documentElement),n=document.createElement("link"),i=_chopQuery(_formatUrl(e,"absolute")),a=K('link[rel="stylesheet"]',t),r=0,s=a.length;s>r;r++)if(_chopQuery(_formatUrl(a[r].href,"absolute"))===i)return;t.appendChild(n),n.href=e,n.rel="stylesheet"}function _ajax(e,t,n,i,a){n=n||"GET",a=a||"json";var r=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");if(r.open(n,e,!0),r.onreadystatechange=function(){if(4==r.readyState&&200==r.status&&t){var e=_trim(r.responseText);"json"==a&&(e=_json(e)),t(e)}},"POST"==n){var s=[];_each(i,function(e,t){s.push(encodeURIComponent(e)+"="+encodeURIComponent(t))});try{r.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}catch(o){}r.send(s.join("&"))}else r.send(null)}function _plugin(e,t){return e===undefined?_plugins:t?void(_plugins[e]=t):_plugins[e]}function _parseLangKey(e){var t,n="core";return(t=/^(\w+)\.(\w+)$/.exec(e))&&(n=t[1],e=t[2]),{ns:n,key:e}}function _lang(e,t){if(t=t===undefined?K.options.langType:t,"string"==typeof e){if(!_language[t])return"no language";var n=e.length-1;if("."===e.substr(n))return _language[t][e.substr(0,n)];var i=_parseLangKey(e);return _language[t][i.ns][i.key]}_each(e,function(e,n){var i=_parseLangKey(e);_language[t]||(_language[t]={}),_language[t][i.ns]||(_language[t][i.ns]={}),_language[t][i.ns][i.key]=n})}function _getImageFromRange(e,t){if(!e.collapsed){e=e.cloneRange().up();var n=e.startContainer,i=e.startOffset;if(_WEBKIT||e.isControl()){var a=K(n.childNodes[i]);if(a&&"img"==a.name)return t(a)?a:void 0}}}function _bindContextmenuEvent(){var e=this,t=e.edit.doc;K(t).contextmenu(function(t){if(e.menu&&e.hideMenu(),!e.useContextmenu)return void t.preventDefault();if(0!==e._contextmenus.length){var n=0,i=[];for(_each(e._contextmenus,function(){return"-"==this.title?void i.push(this):void(this.cond&&this.cond()&&(i.push(this),this.width&&this.width>n&&(n=this.width)))});i.length>0&&"-"==i[0].title;)i.shift();for(;i.length>0&&"-"==i[i.length-1].title;)i.pop();var a=null;if(_each(i,function(e){"-"==this.title&&"-"==a.title&&delete i[e],a=this}),i.length>0){t.preventDefault();var r=K(e.edit.iframe).pos(),s=_menu({x:r.x+t.clientX,y:r.y+t.clientY,width:n,css:{visibility:"hidden"},shadowMode:e.shadowMode});_each(i,function(){this.title&&s.addItem(this)});var o=_docElement(s.doc),l=s.div.height();t.clientY+l>=o.clientHeight-100&&s.pos(s.x,_removeUnit(s.y)-l),s.div.css("visibility","visible"),e.menu=s}}})}function _bindNewlineEvent(){function e(e){for(var t=K(e.commonAncestor());t&&(1!=t.type||t.isStyle());)t=t.parent();return t.name}var t=this,n=t.edit.doc,i=t.newlineTag;if(!(_IE&&"br"!==i||_GECKO&&3>_V&&"p"!==i||_OPERA&&9>_V)){var a=_toMap("h1,h2,h3,h4,h5,h6,pre,li"),r=_toMap("p,h1,h2,h3,h4,h5,h6,pre,li,blockquote");K(n).keydown(function(s){if(!(13!=s.which||s.shiftKey||s.ctrlKey||s.altKey)){t.cmd.selection();var o=e(t.cmd.range);if("marquee"!=o&&"select"!=o)return"br"!==i||a[o]?void(r[o]||_nativeCommand(n,"formatblock","<p>")):(s.preventDefault(),void t.insertHtml("<br />"+(_IE&&9>_V?"":"")))}}),K(n).keyup(function(a){if(!(13!=a.which||a.shiftKey||a.ctrlKey||a.altKey)&&"br"!=i){if(_GECKO){var s=t.cmd.commonAncestor("p"),o=t.cmd.commonAncestor("a");return void(o&&""==o.text()&&(o.remove(!0),t.cmd.range.selectNodeContents(s[0]).collapse(!0),t.cmd.select()))}t.cmd.selection();var l=e(t.cmd.range);if("marquee"!=l&&"select"!=l){r[l]||_nativeCommand(n,"formatblock","<p>");var c=t.cmd.commonAncestor("div");if(c){for(var d=K("<p></p>"),u=c[0].firstChild;u;){var p=u.nextSibling;d.append(u),u=p}c.before(d),c.remove(),t.cmd.range.selectNodeContents(d[0]),t.cmd.select()}}}})}}function _bindTabEvent(){var e=this,t=e.edit.doc;K(t).keydown(function(n){if(9==n.which){if(n.preventDefault(),e.afterTab)return void e.afterTab.call(e,n);var i=e.cmd,a=i.range;a.shrink(),a.collapsed&&1==a.startContainer.nodeType&&(a.insertNode(K("@&nbsp;",t)[0]),i.select()),e.insertHtml("&nbsp;&nbsp;&nbsp;&nbsp;")}})}function _bindFocusEvent(){var e=this;K(e.edit.textarea[0],e.edit.win).focus(function(t){e.afterFocus&&e.afterFocus.call(e,t)}).blur(function(t){e.afterBlur&&e.afterBlur.call(e,t)})}function _removeBookmarkTag(e){return _trim(e.replace(/<span [^>]*id="?__kindeditor_bookmark_\w+_\d+__"?[^>]*><\/span>/gi,""))}function _removeTempTag(e){return e.replace(/<div[^>]+class="?__kindeditor_paste__"?[^>]*>[\s\S]*?<\/div>/gi,"")}function _addBookmarkToStack(e,t){if(0===e.length)return void e.push(t);var n=e[e.length-1];_removeBookmarkTag(t.html)!==_removeBookmarkTag(n.html)&&e.push(t)}function _undoToRedo(e,t){var n,i,a=this,r=a.edit,s=r.doc.body;if(0===e.length)return a;r.designMode?(n=a.cmd.range,i=n.createBookmark(!0),i.html=s.innerHTML):i={html:s.innerHTML},_addBookmarkToStack(t,i);var o=e.pop();return _removeBookmarkTag(i.html)===_removeBookmarkTag(o.html)&&e.length>0&&(o=e.pop()),r.designMode?(r.html(o.html),o.start&&(n.moveToBookmark(o),a.select())):K(s).html(_removeBookmarkTag(o.html)),a}function KEditor(e){function t(e,t){KEditor.prototype[e]===undefined&&(n[e]=t),n.options[e]=t}var n=this;n.options={},_each(e,function(n,i){t(n,e[n])}),_each(K.options,function(e,i){n[e]===undefined&&t(e,i)});var i=K(n.srcElement||"<textarea/>");n.width||(n.width=i[0].style.width||i.width()),n.height||(n.height=i[0].style.height||i.height()),t("width",_undef(n.width,n.minWidth)),t("height",_undef(n.height,n.minHeight)),t("width",_addUnit(n.width)),t("height",_addUnit(n.height)),_MOBILE&&(!_IOS||534>_V)&&(n.designMode=!1),n.srcElement=i,n.initContent="",n.plugin={},n.isCreated=!1,n._handlers={},n._contextmenus=[],n._undoStack=[],n._redoStack=[],n._firstAddBookmark=!0,n.menu=n.contextmenu=null,n.dialogs=[]}function _editor(e){return new KEditor(e)}function _create(e,t){function n(e){return _each(_plugins,function(t,n){_isFunction(n)&&n.call(e,KindEditor)}),e.create()}if(t=t||{},t.basePath=_undef(t.basePath,K.basePath),t.themesPath=_undef(t.themesPath,t.basePath+"themes/"),t.langPath=_undef(t.langPath,t.basePath+"lang/"),t.pluginsPath=_undef(t.pluginsPath,t.basePath+"plugins/"),_undef(t.loadStyleMode,K.options.loadStyleMode)){var i=_undef(t.themeType,K.options.themeType);_loadStyle(t.themesPath+"default/default.css"),_loadStyle(t.themesPath+i+"/"+i+".css")}var a=K(e);if(a&&0!==a.length){if(a.length>1)return a.each(function(){_create(this,t)}),_instances[0];t.srcElement=a[0];var r=new KEditor(t);return _instances.push(r),_language[r.langType]?n(r):(_loadScript(r.langPath+r.langType+".js?ver="+encodeURIComponent(K.DEBUG?_TIME:_VERSION),function(){n(r)}),r)}}function _eachEditor(e,t){K(e).each(function(e,n){K.each(_instances,function(e,i){return i&&i.srcElement[0]==n?(t.call(i,e),!1):void 0})})}if(!window.KindEditor){var undefined;window.console||(window.console={}),console.log||(console.log=function(){});var _VERSION="${VERSION}",_ua=navigator.userAgent.toLowerCase(),_IE=_ua.indexOf("msie")>-1&&-1==_ua.indexOf("opera"),_NEWIE=-1==_ua.indexOf("msie")&&_ua.indexOf("trident")>-1,_GECKO=_ua.indexOf("gecko")>-1&&-1==_ua.indexOf("khtml"),_WEBKIT=_ua.indexOf("applewebkit")>-1,_OPERA=_ua.indexOf("opera")>-1,_MOBILE=_ua.indexOf("mobile")>-1,_IOS=/ipad|iphone|ipod/.test(_ua),_QUIRKS="CSS1Compat"!=document.compatMode,_IERANGE=!window.getSelection,_matches=/(?:msie|firefox|webkit|opera)[\/:\s](\d+)/.exec(_ua),_V=_matches?_matches[1]:"0",_TIME=(new Date).getTime(),_round=Math.round,K={DEBUG:!1,VERSION:_VERSION,IE:_IE,GECKO:_GECKO,WEBKIT:_WEBKIT,OPERA:_OPERA,V:_V,TIME:_TIME,each:_each,isArray:_isArray,isFunction:_isFunction,inArray:_inArray,inString:_inString,trim:_trim,addUnit:_addUnit,removeUnit:_removeUnit,escape:_escape,unescape:_unescape,toCamel:_toCamel,toHex:_toHex,toMap:_toMap,toArray:_toArray,undef:_undef,invalidUrl:_invalidUrl,addParam:_addParam,extend:_extend,json:_json},_INLINE_TAG_MAP=_toMap("a,abbr,acronym,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,img,input,ins,kbd,label,map,q,s,samp,select,small,span,strike,strong,sub,sup,textarea,tt,u,var"),_BLOCK_TAG_MAP=_toMap("address,applet,blockquote,body,center,dd,dir,div,dl,dt,fieldset,form,frameset,h1,h2,h3,h4,h5,h6,head,hr,html,iframe,ins,isindex,li,map,menu,meta,noframes,noscript,object,ol,p,pre,script,style,table,tbody,td,tfoot,th,thead,title,tr,ul"),_SINGLE_TAG_MAP=_toMap("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed"),_STYLE_TAG_MAP=_toMap("b,basefont,big,del,em,font,i,s,small,span,strike,strong,sub,sup,u"),_CONTROL_TAG_MAP=_toMap("img,table,input,textarea,button"),_PRE_TAG_MAP=_toMap("pre,style,script"),_NOSPLIT_TAG_MAP=_toMap("html,head,body,td,tr,table,ol,ul,li"),_AUTOCLOSE_TAG_MAP=_toMap("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr"),_FILL_ATTR_MAP=_toMap("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected"),_VALUE_TAG_MAP=_toMap("input,button,textarea,select");K.basePath=_getBasePath(),K.options={designMode:!0,fullscreenMode:!1,filterMode:!0,wellFormatMode:!0,shadowMode:!0,loadStyleMode:!0,basePath:K.basePath,themesPath:K.basePath+"themes/",langPath:K.basePath+"lang/",pluginsPath:K.basePath+"plugins/",themeType:"default",langType:"zh_CN",urlType:"",newlineTag:"p",resizeType:2,syncType:"form",pasteType:2,dialogAlignType:"page",useContextmenu:!0,fullscreenShortcut:!1,bodyClass:"ke-content",indentChar:"	",cssPath:"",cssData:"",minWidth:650,minHeight:100,minChangeSize:50,zIndex:811213,items:["source","|","undo","redo","|","preview","print","template","code","cut","copy","paste","plainpaste","wordpaste","|","justifyleft","justifycenter","justifyright","justifyfull","insertorderedlist","insertunorderedlist","indent","outdent","subscript","superscript","clearhtml","quickformat","selectall","|","fullscreen","/","formatblock","fontname","fontsize","|","forecolor","hilitecolor","bold","italic","underline","strikethrough","lineheight","removeformat","|","image","multiimage","flash","media","insertfile","table","hr","emoticons","baidumap","pagebreak","anchor","link","unlink","|","about"],noDisableItems:["source","fullscreen"],colorTable:[["#E53333","#E56600","#FF9900","#64451D","#DFC5A4","#FFE500"],["#009900","#006600","#99BB00","#B8D100","#60D978","#00D5FF"],["#337FE5","#003399","#4C33E5","#9933E5","#CC33E5","#EE33EE"],["#FFFFFF","#CCCCCC","#999999","#666666","#333333","#000000"]],fontSizeTable:["9px","10px","12px","14px","16px","18px","24px","32px"],htmlTags:{font:["id","class","color","size","face",".background-color"],span:["id","class",".color",".background-color",".font-size",".font-family",".background",".font-weight",".font-style",".text-decoration",".vertical-align",".line-height"],div:["id","class","align",".border",".margin",".padding",".text-align",".color",".background-color",".font-size",".font-family",".font-weight",".background",".font-style",".text-decoration",".vertical-align",".margin-left"],table:["id","class","border","cellspacing","cellpadding","width","height","align","bordercolor",".padding",".margin",".border","bgcolor",".text-align",".color",".background-color",".font-size",".font-family",".font-weight",".font-style",".text-decoration",".background",".width",".height",".border-collapse"],"td,th":["id","class","align","valign","width","height","colspan","rowspan","bgcolor",".text-align",".color",".background-color",".font-size",".font-family",".font-weight",".font-style",".text-decoration",".vertical-align",".background",".border"],a:["id","class","href","target","name"],embed:["id","class","src","width","height","type","loop","autostart","quality",".width",".height","align","allowscriptaccess"],img:["id","class","src","width","height","border","alt","title","align",".width",".height",".border"],"p,ol,ul,li,blockquote,h1,h2,h3,h4,h5,h6":["id","class","align",".text-align",".color",".background-color",".font-size",".font-family",".background",".font-weight",".font-style",".text-decoration",".vertical-align",".text-indent",".margin-left"],pre:["id","class"],hr:["id","class",".page-break-after"],"br,tbody,tr,strong,b,sub,sup,em,i,u,strike,s,del":["id","class"],iframe:["id","class","src","frameborder","width","height",".width",".height"]},layout:'<div class="container"><div class="toolbar"></div><div class="edit"></div><div class="statusbar"></div></div>'};var _useCapture=!1,_INPUT_KEY_MAP=_toMap("8,9,13,32,46,48..57,59,61,65..90,106,109..111,188,190..192,219..222"),_CURSORMOVE_KEY_MAP=_toMap("33..40"),_CHANGE_KEY_MAP={};_each(_INPUT_KEY_MAP,function(e,t){_CHANGE_KEY_MAP[e]=t}),_each(_CURSORMOVE_KEY_MAP,function(e,t){_CHANGE_KEY_MAP[e]=t});var _EVENT_PROPS="altKey,attrChange,attrName,bubbles,button,cancelable,charCode,clientX,clientY,ctrlKey,currentTarget,data,detail,eventPhase,fromElement,handler,keyCode,metaKey,newValue,offsetX,offsetY,originalTarget,pageX,pageY,prevValue,relatedNode,relatedTarget,screenX,screenY,shiftKey,srcElement,target,toElement,view,wheelDelta,which".split(",");_extend(KEvent,{init:function(e,t){var n=this,i=e.ownerDocument||e.document||e;if(n.event=t,_each(_EVENT_PROPS,function(e,i){n[i]=t[i]}),n.target||(n.target=n.srcElement||i),3===n.target.nodeType&&(n.target=n.target.parentNode),!n.relatedTarget&&n.fromElement&&(n.relatedTarget=n.fromElement===n.target?n.toElement:n.fromElement),null==n.pageX&&null!=n.clientX){var a=i.documentElement,r=i.body;n.pageX=n.clientX+(a&&a.scrollLeft||r&&r.scrollLeft||0)-(a&&a.clientLeft||r&&r.clientLeft||0),n.pageY=n.clientY+(a&&a.scrollTop||r&&r.scrollTop||0)-(a&&a.clientTop||r&&r.clientTop||0)}switch(!n.which&&(n.charCode||0===n.charCode?n.charCode:n.keyCode)&&(n.which=n.charCode||n.keyCode),!n.metaKey&&n.ctrlKey&&(n.metaKey=n.ctrlKey),n.which||n.button===undefined||(n.which=1&n.button?1:2&n.button?3:4&n.button?2:0),n.which){case 186:n.which=59;break;case 187:case 107:case 43:n.which=61;break;case 189:case 45:n.which=109;break;case 42:n.which=106;break;case 47:n.which=111;break;case 78:n.which=110}n.which>=96&&n.which<=105&&(n.which-=48)},preventDefault:function(){var e=this.event;e.preventDefault?e.preventDefault():e.returnValue=!1},stopPropagation:function(){var e=this.event;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},stop:function(){this.preventDefault(),this.stopPropagation()}});var _eventExpendo="kindeditor_"+_TIME,_eventId=0,_eventData={},_readyFinished=!1;_IE&&window.attachEvent("onunload",function(){_each(_eventData,function(e,t){t.el&&_unbind(t.el)})}),K.ctrl=_ctrl,K.ready=_ready,K.formatUrl=_formatUrl,K.formatHtml=_formatHtml,K.getCssList=_getCssList,K.getAttrList=_getAttrList,K.mediaType=_mediaType,K.mediaAttrs=_mediaAttrs,K.mediaEmbed=_mediaEmbed,K.mediaImg=_mediaImg,K.clearMsWord=_clearMsWord,K.tmpl=_tmpl;var _getSetAttrDiv=document.createElement("div");_getSetAttrDiv.setAttribute("className","t");var _GET_SET_ATTRIBUTE="t"!==_getSetAttrDiv.className;K.query=_query,K.queryAll=_queryAll,_extend(KNode,{init:function(e){var t=this;e=_isArray(e)?e:[e];for(var n=0,i=0,a=e.length;a>i;i++)e[i]&&(t[i]=e[i].constructor===KNode?e[i][0]:e[i],n++);t.length=n,t.doc=_getDoc(t[0]),t.name=_getNodeName(t[0]),t.type=t.length>0?t[0].nodeType:null,t.win=_getWin(t[0])},each:function(e){for(var t=this,n=0;n<t.length;n++)if(e.call(t[n],n,t[n])===!1)return t;return t},bind:function(e,t){return this.each(function(){_bind(this,e,t)}),this},unbind:function(e,t){return this.each(function(){_unbind(this,e,t)}),this},fire:function(e){return this.length<1?this:(_fire(this[0],e),this)},hasAttr:function(e){return this.length<1?!1:!!_getAttr(this[0],e)},attr:function(e,t){var n=this;return e===undefined?_getAttrList(n.outer()):"object"==typeof e?(_each(e,function(e,t){n.attr(e,t)}),n):t===undefined?(t=n.length<1?null:_getAttr(n[0],e),null===t?"":t):(n.each(function(){_setAttr(this,e,t)}),n)},removeAttr:function(e){return this.each(function(){_removeAttr(this,e)}),this},get:function(e){return this.length<1?null:this[e||0]},eq:function(e){return this.length<1?null:this[e]?new KNode(this[e]):null},hasClass:function(e){return this.length<1?!1:_hasClass(this[0],e)},addClass:function(e){return this.each(function(){_hasClass(this,e)||(this.className=_trim(this.className+" "+e))}),this},removeClass:function(e){return this.each(function(){_hasClass(this,e)&&(this.className=_trim(this.className.replace(new RegExp("(^|\\s)"+e+"(\\s|$)")," ")))}),this},html:function(e){var t=this;return e===undefined?t.length<1||1!=t.type?"":_formatHtml(t[0].innerHTML):(t.each(function(){_setHtml(this,e)}),t)},text:function(){var e=this;return e.length<1?"":_IE?e[0].innerText:e[0].textContent},hasVal:function(){return this.length<1?!1:_hasVal(this[0])},val:function(e){var t=this;return e===undefined?t.length<1?"":t.hasVal()?t[0].value:t.attr("value"):(t.each(function(){_hasVal(this)?this.value=e:_setAttr(this,"value",e)}),t)},css:function(e,t){var n=this;return e===undefined?_getCssList(n.attr("style")):"object"==typeof e?(_each(e,function(e,t){n.css(e,t)}),n):t===undefined?n.length<1?"":n[0].style[_toCamel(e)]||_computedCss(n[0],e)||"":(n.each(function(){this.style[_toCamel(e)]=t}),n)},width:function(e){var t=this;return e===undefined?t.length<1?0:t[0].offsetWidth:t.css("width",_addUnit(e))},height:function(e){var t=this;return e===undefined?t.length<1?0:t[0].offsetHeight:t.css("height",_addUnit(e))},opacity:function(e){return this.each(function(){this.style.opacity===undefined?this.style.filter=1==e?"":"alpha(opacity="+100*e+")":this.style.opacity=1==e?"":e}),this},data:function(e,t){var n=this;return e="kindeditor_data_"+e,t===undefined?n.length<1?null:n[0][e]:(this.each(function(){this[e]=t}),n)},pos:function(){var e=this,t=e[0],n=0,i=0;if(t)if(t.getBoundingClientRect){var a=t.getBoundingClientRect(),r=_getScrollPos(e.doc);n=a.left+r.x,i=a.top+r.y}else for(;t;)n+=t.offsetLeft,i+=t.offsetTop,t=t.offsetParent;return{x:_round(n),y:_round(i)}},clone:function(e){return new KNode(this.length<1?[]:this[0].cloneNode(e))},append:function(e){return this.each(function(){this.appendChild&&this.appendChild(_get(e))}),this},appendTo:function(e){return this.each(function(){_get(e).appendChild(this)}),this},before:function(e){return this.each(function(){this.parentNode.insertBefore(_get(e),this)}),this},after:function(e){return this.each(function(){this.nextSibling?this.parentNode.insertBefore(_get(e),this.nextSibling):this.parentNode.appendChild(_get(e))}),this},replaceWith:function(e){var t=[];return this.each(function(n,i){_unbind(i);var a=_get(e);i.parentNode.replaceChild(a,i),t.push(a)}),K(t)},empty:function(){var e=this;return e.each(function(e,t){for(var n=t.firstChild;n;){if(!t.parentNode)return;var i=n.nextSibling;n.parentNode.removeChild(n),n=i}}),e},remove:function(e){var t=this;return t.each(function(n,i){if(i.parentNode){if(_unbind(i),e)for(var a=i.firstChild;a;){var r=a.nextSibling;i.parentNode.insertBefore(a,i),a=r}i.parentNode.removeChild(i),delete t[n]}}),t.length=0,t},show:function(e){var t=this;return e===undefined&&(e=t._originDisplay||""),"none"!=t.css("display")?t:t.css("display",e)},hide:function(){var e=this;return e.length<1?e:(e._originDisplay=e[0].style.display,e.css("display","none"))},outer:function(){var e=this;if(e.length<1)return"";var t,n=e.doc.createElement("div");return n.appendChild(e[0].cloneNode(!0)),t=_formatHtml(n.innerHTML),n=null,t},isSingle:function(){return!!_SINGLE_TAG_MAP[this.name];
},isInline:function(){return!!_INLINE_TAG_MAP[this.name]},isBlock:function(){return!!_BLOCK_TAG_MAP[this.name]},isStyle:function(){return!!_STYLE_TAG_MAP[this.name]},isControl:function(){return!!_CONTROL_TAG_MAP[this.name]},contains:function(e){return this.length<1?!1:_contains(this[0],_get(e))},parent:function(){if(this.length<1)return null;var e=this[0].parentNode;return e?new KNode(e):null},children:function(){if(this.length<1)return new KNode([]);for(var e=[],t=this[0].firstChild;t;)(3!=t.nodeType||""!==_trim(t.nodeValue))&&e.push(t),t=t.nextSibling;return new KNode(e)},first:function(){var e=this.children();return e.length>0?e.eq(0):null},last:function(){var e=this.children();return e.length>0?e.eq(e.length-1):null},index:function(){if(this.length<1)return-1;for(var e=-1,t=this[0];t;)e++,t=t.previousSibling;return e},prev:function(){if(this.length<1)return null;var e=this[0].previousSibling;return e?new KNode(e):null},next:function(){if(this.length<1)return null;var e=this[0].nextSibling;return e?new KNode(e):null},scan:function(e,t){function n(i){for(var a=t?i.firstChild:i.lastChild;a;){var r=t?a.nextSibling:a.previousSibling;if(e(a)===!1)return!1;if(n(a)===!1)return!1;a=r}}if(!(this.length<1))return t=t===undefined?!0:t,n(this[0]),this}}),_each("blur,focus,focusin,focusout,load,resize,scroll,unload,click,dblclick,mousedown,mouseup,mousemove,mouseover,mouseout,mouseenter,mouseleave,change,select,submit,keydown,keypress,keyup,error,contextmenu".split(","),function(e,t){KNode.prototype[t]=function(e){return e?this.bind(t,e):this.fire(t)}});var _K=K;K=function(e,t){function n(e){return e[0]||(e=[]),new KNode(e)}if(e!==undefined&&null!==e){if("string"==typeof e){t&&(t=_get(t));var i=e.length;if("@"===e.charAt(0)&&(e=e.substr(1)),e.length!==i||/<.+>/.test(e)){var a=t?t.ownerDocument||t:document,r=a.createElement("div"),s=[];r.innerHTML='<img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" />'+e;for(var o=0,l=r.childNodes.length;l>o;o++){var c=r.childNodes[o];"__kindeditor_temp_tag__"!=c.id&&s.push(c)}return n(s)}return n(_queryAll(e,t))}return e&&e.constructor===KNode?e:(e.toArray&&(e=e.toArray()),n(_isArray(e)?e:_toArray(arguments)))}},_each(_K,function(e,t){K[e]=t}),K.NodeClass=KNode,window.KindEditor=K;var _START_TO_START=0,_START_TO_END=1,_END_TO_END=2,_END_TO_START=3,_BOOKMARK_ID=0;_extend(KRange,{init:function(e){var t=this;t.startContainer=e,t.startOffset=0,t.endContainer=e,t.endOffset=0,t.collapsed=!0,t.doc=e},commonAncestor:function(){function e(e){for(var t=[];e;)t.push(e),e=e.parentNode;return t}for(var t,n,i=e(this.startContainer),a=e(this.endContainer),r=0,s=i.length,o=a.length;++r&&(t=i[s-r],n=a[o-r],t&&n&&t===n););return i[s-r+1]},setStart:function(e,t){var n=this,i=n.doc;return n.startContainer=e,n.startOffset=t,n.endContainer===i&&(n.endContainer=e,n.endOffset=t),_updateCollapsed(this)},setEnd:function(e,t){var n=this,i=n.doc;return n.endContainer=e,n.endOffset=t,n.startContainer===i&&(n.startContainer=e,n.startOffset=t),_updateCollapsed(this)},setStartBefore:function(e){return this.setStart(e.parentNode||this.doc,K(e).index())},setStartAfter:function(e){return this.setStart(e.parentNode||this.doc,K(e).index()+1)},setEndBefore:function(e){return this.setEnd(e.parentNode||this.doc,K(e).index())},setEndAfter:function(e){return this.setEnd(e.parentNode||this.doc,K(e).index()+1)},selectNode:function(e){return this.setStartBefore(e).setEndAfter(e)},selectNodeContents:function(e){var t=K(e);if(3==t.type||t.isSingle())return this.selectNode(e);var n=t.children();return n.length>0?this.setStartBefore(n[0]).setEndAfter(n[n.length-1]):this.setStart(e,0).setEnd(e,0)},collapse:function(e){return e?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},compareBoundaryPoints:function(e,t){var n=this.get(),i=t.get();if(!_IERANGE)return n.compareBoundaryPoints(e,i);var a={};a[_START_TO_START]="StartToStart",a[_START_TO_END]="EndToStart",a[_END_TO_END]="EndToEnd",a[_END_TO_START]="StartToEnd";var r=n.compareEndPoints(a[e],i);if(0!==r)return r;var s,o,l,c,d;if((e===_START_TO_START||e===_END_TO_START)&&(s=this.startContainer,c=this.startOffset),(e===_START_TO_END||e===_END_TO_END)&&(s=this.endContainer,c=this.endOffset),(e===_START_TO_START||e===_START_TO_END)&&(o=t.startContainer,d=t.startOffset),(e===_END_TO_END||e===_END_TO_START)&&(o=t.endContainer,d=t.endOffset),s===o){var u=c-d;return u>0?1:0>u?-1:0}for(l=o;l&&l.parentNode!==s;)l=l.parentNode;if(l)return K(l).index()>=c?-1:1;for(l=s;l&&l.parentNode!==o;)l=l.parentNode;return l?K(l).index()>=d?1:-1:(l=K(o).next(),l&&l.contains(s)?1:(l=K(s).next(),l&&l.contains(o)?-1:void 0))},cloneRange:function(){return new KRange(this.doc).setStart(this.startContainer,this.startOffset).setEnd(this.endContainer,this.endOffset)},toString:function(){var e=this.get(),t=_IERANGE?e.text:e.toString();return t.replace(/\r\n|\n|\r/g,"")},cloneContents:function(){return _copyAndDelete(this,!0,!1)},deleteContents:function(){return _copyAndDelete(this,!1,!0)},extractContents:function(){return _copyAndDelete(this,!0,!0)},insertNode:function(e){var t,n,i,a=this,r=a.startContainer,s=a.startOffset,o=a.endContainer,l=a.endOffset,c=1;return"#document-fragment"===e.nodeName.toLowerCase()&&(t=e.firstChild,n=e.lastChild,c=e.childNodes.length),1==r.nodeType?(i=r.childNodes[s],i?(r.insertBefore(e,i),r===o&&(l+=c)):r.appendChild(e)):3==r.nodeType&&(0===s?(r.parentNode.insertBefore(e,r),r.parentNode===o&&(l+=c)):s>=r.nodeValue.length?r.nextSibling?r.parentNode.insertBefore(e,r.nextSibling):r.parentNode.appendChild(e):(i=s>0?r.splitText(s):r,r.parentNode.insertBefore(e,i),r===o&&(o=i,l-=s))),t?a.setStartBefore(t).setEndAfter(n):a.selectNode(e),a.compareBoundaryPoints(_END_TO_END,a.cloneRange().setEnd(o,l))>=1?a:a.setEnd(o,l)},surroundContents:function(e){return e.appendChild(this.extractContents()),this.insertNode(e).selectNode(e)},isControl:function(){var e=this,t=e.startContainer,n=e.startOffset,i=e.endContainer,a=e.endOffset;return 1==t.nodeType&&t===i&&n+1===a&&K(t.childNodes[n]).isControl()},get:function(e){var t,n=this,i=n.doc;if(!_IERANGE){t=i.createRange();try{t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}catch(a){}return t}if(e&&n.isControl())return t=i.body.createControlRange(),t.addElement(n.startContainer.childNodes[n.startOffset]),t;var r=n.cloneRange().down();return t=i.body.createTextRange(),t.setEndPoint("StartToStart",_getEndRange(r.startContainer,r.startOffset)),t.setEndPoint("EndToStart",_getEndRange(r.endContainer,r.endOffset)),t},html:function(){return K(this.cloneContents()).outer()},down:function(){function e(e,n,i){if(1==e.nodeType){var a=K(e).children();if(0!==a.length){var r,s,o,l;n>0&&(r=a.eq(n-1)),n<a.length&&(s=a.eq(n)),r&&3==r.type&&(o=r[0],l=o.nodeValue.length),s&&3==s.type&&(o=s[0],l=0),o&&(i?t.setStart(o,l):t.setEnd(o,l))}}}var t=this;return e(t.startContainer,t.startOffset,!0),e(t.endContainer,t.endOffset,!1),t},up:function(){function e(e,n,i){3==e.nodeType&&(0===n?i?t.setStartBefore(e):t.setEndBefore(e):n==e.nodeValue.length&&(i?t.setStartAfter(e):t.setEndAfter(e)))}var t=this;return e(t.startContainer,t.startOffset,!0),e(t.endContainer,t.endOffset,!1),t},enlarge:function(e){function t(t,i,a){var r,s=K(t);if(!(3==s.type||_NOSPLIT_TAG_MAP[s.name]||!e&&s.isBlock()))if(0===i){for(;!s.prev()&&(r=s.parent(),r&&!_NOSPLIT_TAG_MAP[r.name]&&(e||!r.isBlock()));)s=r;a?n.setStartBefore(s[0]):n.setEndBefore(s[0])}else if(i==s.children().length){for(;!s.next()&&(r=s.parent(),r&&!_NOSPLIT_TAG_MAP[r.name]&&(e||!r.isBlock()));)s=r;a?n.setStartAfter(s[0]):n.setEndAfter(s[0])}}var n=this;return n.up(),t(n.startContainer,n.startOffset,!0),t(n.endContainer,n.endOffset,!1),n},shrink:function(){for(var e,t=this,n=t.collapsed;1==t.startContainer.nodeType&&(e=t.startContainer.childNodes[t.startOffset])&&1==e.nodeType&&!K(e).isSingle();)t.setStart(e,0);if(n)return t.collapse(n);for(;1==t.endContainer.nodeType&&t.endOffset>0&&(e=t.endContainer.childNodes[t.endOffset-1])&&1==e.nodeType&&!K(e).isSingle();)t.setEnd(e,e.childNodes.length);return t},createBookmark:function(e){var t,n=this,i=n.doc,a=K('<span style="display:none;"></span>',i)[0];return a.id="__kindeditor_bookmark_start_"+_BOOKMARK_ID++ +"__",n.collapsed||(t=a.cloneNode(!0),t.id="__kindeditor_bookmark_end_"+_BOOKMARK_ID++ +"__"),t&&n.cloneRange().collapse(!1).insertNode(t).setEndBefore(t),n.insertNode(a).setStartAfter(a),{start:e?"#"+a.id:a,end:t?e?"#"+t.id:t:null}},moveToBookmark:function(e){var t=this,n=t.doc,i=K(e.start,n),a=e.end?K(e.end,n):null;return!i||i.length<1?t:(t.setStartBefore(i[0]),i.remove(),a&&a.length>0?(t.setEndBefore(a[0]),a.remove()):t.collapse(!0),t)},dump:function(){console.log("--------------------"),console.log(3==this.startContainer.nodeType?this.startContainer.nodeValue:this.startContainer,this.startOffset),console.log(3==this.endContainer.nodeType?this.endContainer.nodeValue:this.endContainer,this.endOffset)}}),K.RangeClass=KRange,K.range=_range,K.START_TO_START=_START_TO_START,K.START_TO_END=_START_TO_END,K.END_TO_END=_END_TO_END,K.END_TO_START=_END_TO_START,_extend(KCmd,{init:function(e){var t=this,n=e.doc;t.doc=n,t.win=_getWin(n),t.sel=_getSel(n),t.range=e},selection:function(e){var t=this,n=t.doc,i=_getRng(n);return t.sel=_getSel(n),i?(t.range=_range(i),"html"==K(t.range.startContainer).name&&t.range.selectNodeContents(n.body).collapse(!1),t):(e&&t.range.selectNodeContents(n.body).collapse(!1),t)},select:function(e){e=_undef(e,!0);var t,n=this,i=n.sel,a=n.range.cloneRange().shrink(),r=a.startContainer,s=a.startOffset,o=(a.endContainer,a.endOffset,_getDoc(r)),l=n.win,c=!1;if(e&&1==r.nodeType&&a.collapsed){if(_IERANGE){var d=K("<span>&nbsp;</span>",o);a.insertNode(d[0]),t=o.body.createTextRange();try{t.moveToElementText(d[0])}catch(u){}return t.collapse(!1),t.select(),d.remove(),l.focus(),n}if(_WEBKIT){var p=r.childNodes;(K(r).isInline()||s>0&&K(p[s-1]).isInline()||p[s]&&K(p[s]).isInline())&&(a.insertNode(o.createTextNode("")),c=!0)}}if(_IERANGE)try{t=a.get(!0),t.select()}catch(m){}else if(c&&a.collapse(!1),t=a.get(!0),i.removeAllRanges(),i.addRange(t),o!==document){var h=K(t.endContainer).pos();l.scrollTo(h.x,h.y)}return l.focus(),n},wrap:function(e){var t,n=this,i=n.doc,a=n.range;if(t=K(e,i),a.collapsed)return a.shrink(),a.insertNode(t[0]).selectNodeContents(t[0]),n;if(t.isBlock()){for(var r=t.clone(!0),s=r;s.first();)s=s.first();return s.append(a.extractContents()),a.insertNode(r[0]).selectNode(r[0]),n}a.enlarge();var o=a.createBookmark(),l=a.commonAncestor(),c=!1;return K(l).scan(function(e){if(!c&&e==o.start)return void(c=!0);if(c){if(e==o.end)return!1;var n=K(e);if(_inPreElement(n))return;if(3==n.type&&_trim(e.nodeValue).length>0){for(var i;(i=n.parent())&&i.isStyle()&&1==i.children().length;)n=i;_wrapNode(n,t)}}}),a.moveToBookmark(o),n},split:function(e,t){for(var n,i=this.range,a=i.doc,r=i.cloneRange().collapse(e),s=r.startContainer,o=r.startOffset,l=3==s.nodeType?s.parentNode:s,c=!1;l&&l.parentNode;){if(n=K(l),t){if(!n.isStyle())break;if(!_hasAttrOrCss(n,t))break}else if(_NOSPLIT_TAG_MAP[n.name])break;c=!0,l=l.parentNode}if(c){var d=a.createElement("span");i.cloneRange().collapse(!e).insertNode(d),e?r.setStartBefore(l.firstChild).setEnd(s,o):r.setStart(s,o).setEndAfter(l.lastChild);var u=r.extractContents(),p=u.firstChild,m=u.lastChild;e?(r.insertNode(u),i.setStartAfter(m).setEndBefore(d)):(l.appendChild(u),i.setStartBefore(d).setEndBefore(p));var h=d.parentNode;if(h==i.endContainer){var f=K(d).prev(),v=K(d).next();f&&v&&3==f.type&&3==v.type?i.setEnd(f[0],f[0].nodeValue.length):e||i.setEnd(i.endContainer,i.endOffset-1)}h.removeChild(d)}return this},remove:function(e){var t=this,n=t.doc,i=t.range;if(i.enlarge(),0===i.startOffset){for(var a,r=K(i.startContainer);(a=r.parent())&&a.isStyle()&&1==a.children().length;)r=a;i.setStart(r[0],0),r=K(i.startContainer),r.isBlock()&&_removeAttrOrCss(r,e);var s=r.parent();s&&s.isBlock()&&_removeAttrOrCss(s,e)}var o,l;if(i.collapsed){if(t.split(!0,e),o=i.startContainer,l=i.startOffset,l>0){var c=K(o.childNodes[l-1]);c&&_isEmptyNode(c)&&(c.remove(),i.setStart(o,l-1))}var d=K(o.childNodes[l]);return d&&_isEmptyNode(d)&&d.remove(),_isEmptyNode(o)&&(i.startBefore(o),o.remove()),i.collapse(!0),t}t.split(!0,e),t.split(!1,e);var u=n.createElement("span"),p=n.createElement("span");i.cloneRange().collapse(!1).insertNode(p),i.cloneRange().collapse(!0).insertNode(u);var m=[],h=!1;K(i.commonAncestor()).scan(function(e){return h||e!=u?e==p?!1:void(h&&m.push(e)):void(h=!0)}),K(u).remove(),K(p).remove(),o=i.startContainer,l=i.startOffset;var f=i.endContainer,v=i.endOffset;if(l>0){var g=K(o.childNodes[l-1]);g&&_isEmptyNode(g)&&(g.remove(),i.setStart(o,l-1),o==f&&i.setEnd(f,v-1));var b=K(o.childNodes[l]);b&&_isEmptyNode(b)&&(b.remove(),o==f&&i.setEnd(f,v-1))}var _=K(f.childNodes[i.endOffset]);_&&_isEmptyNode(_)&&_.remove();var y=i.createBookmark(!0);return _each(m,function(t,n){_removeAttrOrCss(K(n),e)}),i.moveToBookmark(y),t},commonNode:function(e){function t(t){for(var n=t,i=t;i;){if(_hasAttrOrCss(K(i),e))return K(i);i=i.parentNode}for(;n&&(n=n.lastChild);)if(_hasAttrOrCss(K(n),e))return K(n);return null}var n=this.range,i=n.endContainer,a=n.endOffset,r=3==i.nodeType||0===a?i:i.childNodes[a-1],s=t(r);if(s)return s;if(1==r.nodeType||3==i.nodeType&&0===a){var o=K(r).prev();if(o)return t(o)}return null},commonAncestor:function(e){function t(t){for(;t;){if(1==t.nodeType&&t.tagName.toLowerCase()===e)return t;t=t.parentNode}return null}var n=this.range,i=n.startContainer,a=n.startOffset,r=n.endContainer,s=n.endOffset,o=3==i.nodeType||0===a?i:i.childNodes[a-1],l=3==r.nodeType||0===s?r:r.childNodes[s-1],c=t(o),d=t(l);return c&&d&&c===d?K(c):null},state:function(e){var t=this,n=t.doc,i=!1;try{i=n.queryCommandState(e)}catch(a){}return i},val:function(e){function t(e){return e.toLowerCase()}var n=this,i=n.doc;n.range;e=t(e);var a,r="";return"fontfamily"===e||"fontname"===e?(r=_nativeCommandValue(i,"fontname"),r=r.replace(/['"]/g,""),t(r)):"formatblock"===e?(r=_nativeCommandValue(i,e),""===r&&(a=n.commonNode({"h1,h2,h3,h4,h5,h6,p,div,pre,address":"*"}),a&&(r=a.name)),"Normal"===r&&(r="p"),t(r)):"fontsize"===e?(a=n.commonNode({"*":".font-size"}),a&&(r=a.css("font-size")),t(r)):"forecolor"===e?(a=n.commonNode({"*":".color"}),a&&(r=a.css("color")),r=_toHex(r),""===r&&(r="default"),t(r)):"hilitecolor"===e?(a=n.commonNode({"*":".background-color"}),a&&(r=a.css("background-color")),r=_toHex(r),""===r&&(r="default"),t(r)):r},toggle:function(e,t){var n=this;return n.commonNode(t)?n.remove(t):n.wrap(e),n.select()},bold:function(){return this.toggle("<strong></strong>",{span:".font-weight=bold",strong:"*",b:"*"})},italic:function(){return this.toggle("<em></em>",{span:".font-style=italic",em:"*",i:"*"})},underline:function(){return this.toggle("<u></u>",{span:".text-decoration=underline",u:"*"})},strikethrough:function(){return this.toggle("<s></s>",{span:".text-decoration=line-through",s:"*"})},forecolor:function(e){return this.wrap('<span style="color:'+e+';"></span>').select()},hilitecolor:function(e){return this.wrap('<span style="background-color:'+e+';"></span>').select()},fontsize:function(e){return this.wrap('<span style="font-size:'+e+';"></span>').select()},fontname:function(e){return this.fontfamily(e)},fontfamily:function(e){return this.wrap('<span style="font-family:'+e+';"></span>').select()},removeformat:function(){var e={"*":".font-weight,.font-style,.text-decoration,.color,.background-color,.font-size,.font-family,.text-indent"},t=_STYLE_TAG_MAP;return _each(t,function(t,n){e[t]="*"}),this.remove(e),this.select()},inserthtml:function(e,t){function n(e,t){t='<img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" />'+t;var n=e.get();n.item?n.item(0).outerHTML=t:n.pasteHTML(t);var i=e.doc.getElementById("__kindeditor_temp_tag__");i.parentNode.removeChild(i);var r=_toRange(n);e.setEnd(r.endContainer,r.endOffset),e.collapse(!1),a.select(!1)}function i(e,t){var n=e.doc,i=n.createDocumentFragment();K("@"+t,n).each(function(){i.appendChild(this)}),e.deleteContents(),e.insertNode(i),e.collapse(!1),a.select(!1)}var a=this,r=a.range;if(""===e)return a;if(_IERANGE&&t){try{n(r,e)}catch(s){i(r,e)}return a}return i(r,e),a},hr:function(){return this.inserthtml("<hr />")},print:function(){return this.win.print(),this},insertimage:function(e,t,n,i,a,r){t=_undef(t,""),a=_undef(a,0);var s='<img src="'+_escape(e)+'" data-ke-src="'+_escape(e)+'" ';return n&&(s+='width="'+_escape(n)+'" '),i&&(s+='height="'+_escape(i)+'" '),t&&(s+='title="'+_escape(t)+'" '),r&&(s+='align="'+_escape(r)+'" '),s+='alt="'+_escape(t)+'" ',s+="/>",this.inserthtml(s)},createlink:function(e,t,n){function i(e,t,n,i,a){K(e).attr("href",t).attr("data-ke-src",t).attr("title",_escape(t)),a&&K(e).html(_escape(i)),n?K(e).attr("target",n):K(e).removeAttr("target")}var a=this,r=a.doc,s=a.range;a.select();var o=a.commonNode({a:"*"});o&&!s.isControl()&&(s.selectNode(o.get()),a.select());var l='<a href="'+_escape(t)+'" data-ke-src="'+_escape(t)+'"title="'+_escape(t)+'"';if(n&&(l+=' target="'+_escape(n)+'"'),s.collapsed)return l+=">"+_escape(e)+"</a>",a.inserthtml(l);if(s.isControl()){var c=K(s.startContainer.childNodes[s.startOffset]);return l+="></a>",c.after(K(l,r)),c.next().append(c),s.selectNode(c[0]),a.select()}var d=s.startContainer,u=s.startOffset,p=s.endContainer,m=s.endOffset;if(1==d.nodeType&&d===p&&u+1===m){var h=d.childNodes[u];if("a"==h.nodeName.toLowerCase())return i(h,t,n,e,!0),a}return _nativeCommand(r,"createlink","__kindeditor_temp_url__"),K('a[href="__kindeditor_temp_url__"]',r).each(function(){i(this,t,n,e,!1)}),a},unlink:function(){var e=this,t=e.doc,n=e.range;if(e.select(),n.collapsed){var i=e.commonNode({a:"*"});if(i&&(n.selectNode(i.get()),e.select()),_nativeCommand(t,"unlink",null),_WEBKIT&&"img"===K(n.startContainer).name){var a=K(n.startContainer).parent();"a"===a.name&&a.remove(!0)}}else _nativeCommand(t,"unlink",null);return e}}),_each("formatblock,selectall,justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,insertunorderedlist,indent,outdent,subscript,superscript".split(","),function(e,t){KCmd.prototype[t]=function(e){var n=this;return n.select(),_nativeCommand(n.doc,t,e),_IERANGE&&_inArray(t,"justifyleft,justifycenter,justifyright,justifyfull".split(","))>=0&&n.selection(),(!_IERANGE||_inArray(t,"formatblock,selectall,insertorderedlist,insertunorderedlist".split(","))>=0)&&n.selection(),n}}),_each("cut,copy,paste".split(","),function(e,t){KCmd.prototype[t]=function(){var e=this;if(!e.doc.queryCommandSupported(t))throw"not supported";return e.select(),_nativeCommand(e.doc,t,null),e}}),K.CmdClass=KCmd,K.cmd=_cmd,_extend(KWidget,{init:function(e){var t=this;if(t.name=e.name||"",t.doc=e.doc||document,t.win=_getWin(t.doc),t.x=_addUnit(e.x),t.y=_addUnit(e.y),t.z=e.z,t.width=_addUnit(e.width),t.height=_addUnit(e.height),t.div=K('<div style="display:block;"></div>'),t.options=e,t._alignEl=e.alignEl,t.width&&t.div.css("width",t.width),t.height&&t.div.css("height",t.height),t.z&&t.div.css({position:"absolute",left:t.x,top:t.y,"z-index":t.z}),!t.z||t.x!==undefined&&t.y!==undefined||t.autoPos(t.width,t.height),e.cls&&t.div.addClass(e.cls),e.shadowMode&&t.div.addClass("ke-shadow"),e.css&&t.div.css(e.css),e.src?K(e.src).replaceWith(t.div):K(t.doc.body).append(t.div),e.html&&t.div.html(e.html),e.autoScroll)if(_IE&&7>_V||_QUIRKS){var n=_getScrollPos();K(t.win).bind("scroll",function(e){var i=_getScrollPos(),a=i.x-n.x,r=i.y-n.y;t.pos(_removeUnit(t.x)+a,_removeUnit(t.y)+r,!1)})}else t.div.css("position","fixed")},pos:function(e,t,n){var i=this;return n=_undef(n,!0),null!==e&&(e=0>e?0:_addUnit(e),i.div.css("left",e),n&&(i.x=e)),null!==t&&(t=0>t?0:_addUnit(t),i.div.css("top",t),n&&(i.y=t)),i},autoPos:function(e,t){var n=this,i=_removeUnit(e)||0,a=_removeUnit(t)||0,r=_getScrollPos();if(n._alignEl){var s=K(n._alignEl),o=s.pos(),l=_round(s[0].clientWidth/2-i/2),c=_round(s[0].clientHeight/2-a/2);x=0>l?o.x:o.x+l,y=0>c?o.y:o.y+c}else{var d=_docElement(n.doc);x=_round(r.x+(d.clientWidth-i)/2),y=_round(r.y+(d.clientHeight-a)/2)}return _IE&&7>_V||_QUIRKS||(x-=r.x,y-=r.y),n.pos(x,y)},remove:function(){var e=this;return(_IE&&7>_V||_QUIRKS)&&K(e.win).unbind("scroll"),e.div.remove(),_each(e,function(t){e[t]=null}),this},show:function(){return this.div.show(),this},hide:function(){return this.div.hide(),this},draggable:function(e){var t=this;return e=e||{},e.moveEl=t.div,e.moveFn=function(e,n,i,a,r,s){(e+=r)<0&&(e=0),(n+=s)<0&&(n=0),t.pos(e,n)},_drag(e),t}}),K.WidgetClass=KWidget,K.widget=_widget;var html,_direction="";(html=document.getElementsByTagName("html"))&&(_direction=html[0].dir),_extend(KEdit,KWidget,{init:function(e){function t(){var t=_iframeDoc(n.iframe);t.open(),o&&(t.domain=document.domain),t.write(_getInitHtml(i,a,r,s)),t.close(),n.win=n.iframe[0].contentWindow,n.doc=t;var l=_cmd(t);n.afterChange(function(e){l.selection()}),_WEBKIT&&K(t).click(function(e){"img"===K(e.target).name&&(l.selection(!0),l.range.selectNode(e.target),l.select())}),_IE&&(n._mousedownHandler=function(){var e=l.range.cloneRange();e.shrink(),e.isControl()&&n.blur()},K(document).mousedown(n._mousedownHandler),K(t).keydown(function(e){if(8==e.which){l.selection();var t=l.range;t.isControl()&&(t.collapse(!0),K(t.startContainer.childNodes[t.startOffset]).remove(),e.preventDefault())}})),n.cmd=l,n.html(_elementVal(n.srcElement)),_IE?(t.body.disabled=!0,t.body.contentEditable=!0,t.body.removeAttribute("disabled")):t.designMode="on",e.afterCreate&&e.afterCreate.call(n)}var n=this;KEdit.parent.init.call(n,e),n.srcElement=K(e.srcElement),n.div.addClass("ke-edit"),n.designMode=_undef(e.designMode,!0),n.beforeGetHtml=e.beforeGetHtml,n.beforeSetHtml=e.beforeSetHtml,n.afterSetHtml=e.afterSetHtml;var i=_undef(e.themesPath,""),a=e.bodyClass,r=e.cssPath,s=e.cssData,o="res:"!=location.protocol&&location.host.replace(/:\d+/,"")!==document.domain,l="document.open();"+(o?'document.domain="'+document.domain+'";':"")+"document.close();",c=_IE?' src="javascript:void(function(){'+encodeURIComponent(l)+'}())"':'src="about:blank"';n.iframe=K('<iframe class="ke-edit-iframe" allowtransparency="true" hidefocus="true" frameborder="0"'+c+"></iframe>").css("width","100%"),n.textarea=K('<textarea class="ke-edit-textarea" hidefocus="true"></textarea>').css("width","100%"),n.tabIndex=isNaN(parseInt(e.tabIndex,10))?n.srcElement.attr("tabindex"):parseInt(e.tabIndex,10),n.iframe.attr("tabindex",n.tabIndex),n.textarea.attr("tabindex",n.tabIndex),n.width&&n.setWidth(n.width),n.height&&n.setHeight(n.height),n.designMode?n.textarea.hide():n.iframe.hide(),o&&n.iframe.bind("load",function(e){n.iframe.unbind("load"),_IE?t():setTimeout(t,0)}),n.div.append(n.iframe),n.div.append(n.textarea),n.srcElement.hide(),!o&&t()},setWidth:function(e){var t=this;return e=_addUnit(e),t.width=e,t.div.css("width",e),t},setHeight:function(e){var t=this;return e=_addUnit(e),t.height=e,t.div.css("height",e),t.iframe.css("height",e),(_IE&&8>_V||_QUIRKS)&&(e=_addUnit(_removeUnit(e)-2)),t.textarea.css("height",e),t},remove:function(){var e=this,t=e.doc;K(t.body).unbind(),K(t).unbind(),K(e.win).unbind(),e._mousedownHandler&&K(document).unbind("mousedown",e._mousedownHandler),_elementVal(e.srcElement,e.html()),e.srcElement.show(),t.write(""),e.iframe.unbind(),e.textarea.unbind(),KEdit.parent.remove.call(e)},html:function(e,t){var n=this,i=n.doc;if(n.designMode){var a=i.body;return e===undefined?(e=t?"<!doctype html><html>"+a.parentNode.innerHTML+"</html>":a.innerHTML,n.beforeGetHtml&&(e=n.beforeGetHtml(e)),_GECKO&&"<br />"==e&&(e=""),e):(n.beforeSetHtml&&(e=n.beforeSetHtml(e)),_IE&&_V>=9&&(e=e.replace(/(<.*?checked=")checked(".*>)/gi,"$1$2")),K(a).html(e),n.afterSetHtml&&n.afterSetHtml(),n)}return e===undefined?n.textarea.val():(n.textarea.val(e),n)},design:function(e){var t,n=this;return(e===undefined?!n.designMode:e)?n.designMode||(t=n.html(),n.designMode=!0,n.html(t),n.textarea.hide(),n.iframe.show()):n.designMode&&(t=n.html(),n.designMode=!1,n.html(t),n.iframe.hide(),n.textarea.show()),n.focus()},focus:function(){var e=this;return e.designMode?e.win.focus():e.textarea[0].focus(),e},blur:function(){var e=this;if(_IE){var t=K('<input type="text" style="float:left;width:0;height:0;padding:0;margin:0;border:0;" value="" />',e.div);e.div.append(t),t[0].focus(),t.remove()}else e.designMode?e.win.blur():e.textarea[0].blur();return e},afterChange:function(e){function t(t){setTimeout(function(){e(t)},1)}var n=this,i=n.doc,a=i.body;return K(i).keyup(function(t){t.ctrlKey||t.altKey||!_CHANGE_KEY_MAP[t.which]||e(t)}),K(i).mouseup(e).contextmenu(e),K(n.win).blur(e),K(a).bind("paste",t),K(a).bind("cut",t),n}}),K.EditClass=KEdit,K.edit=_edit,K.iframeDoc=_iframeDoc,_extend(KToolbar,KWidget,{init:function(e){function t(e){var t=K(e);return t.hasClass("ke-outline")?t:t.hasClass("ke-toolbar-icon")?t.parent():void 0}function n(e,n){var i=t(e.target);if(i){if(i.hasClass("ke-disabled"))return;if(i.hasClass("ke-selected"))return;i[n]("ke-on")}}var i=this;KToolbar.parent.init.call(i,e),i.disableMode=_undef(e.disableMode,!1),i.noDisableItemMap=_toMap(_undef(e.noDisableItems,[])),i._itemMap={},i.div.addClass("ke-toolbar").bind("contextmenu,mousedown,mousemove",function(e){e.preventDefault()}).attr("unselectable","on"),i.div.mouseover(function(e){n(e,"addClass")}).mouseout(function(e){n(e,"removeClass")}).click(function(e){var n=t(e.target);if(n){if(n.hasClass("ke-disabled"))return;i.options.click.call(this,e,n.attr("data-name"))}})},get:function(e){return this._itemMap[e]?this._itemMap[e]:this._itemMap[e]=K("span.ke-icon-"+e,this.div).parent()},select:function(e){return _selectToolbar.call(this,e,function(e){e.addClass("ke-selected")}),self},unselect:function(e){return _selectToolbar.call(this,e,function(e){e.removeClass("ke-selected").removeClass("ke-on")}),self},enable:function(e){var t=this,n=e.get?e:t.get(e);return n&&(n.removeClass("ke-disabled"),n.opacity(1)),t},disable:function(e){var t=this,n=e.get?e:t.get(e);return n&&(n.removeClass("ke-selected").addClass("ke-disabled"),n.opacity(.5)),t},disableAll:function(e,t){var n=this,i=n.noDisableItemMap;return t&&(i=_toMap(t)),(e===undefined?!n.disableMode:e)?(K("span.ke-outline",n.div).each(function(){var e=K(this),t=e[0].getAttribute("data-name",2);i[t]||n.disable(e)}),n.disableMode=!0):(K("span.ke-outline",n.div).each(function(){var e=K(this),t=e[0].getAttribute("data-name",2);i[t]||n.enable(e)}),n.disableMode=!1),n}}),K.ToolbarClass=KToolbar,K.toolbar=_toolbar,_extend(KMenu,KWidget,{init:function(e){var t=this;e.z=e.z||811213,KMenu.parent.init.call(t,e),t.centerLineMode=_undef(e.centerLineMode,!0),t.div.addClass("ke-menu").bind("click,mousedown",function(e){e.stopPropagation()}).attr("unselectable","on")},addItem:function(e){var t=this;if("-"===e.title)return void t.div.append(K('<div class="ke-menu-separator"></div>'));var n=K('<div class="ke-menu-item" unselectable="on"></div>'),i=K('<div class="ke-inline-block ke-menu-item-left"></div>'),a=K('<div class="ke-inline-block ke-menu-item-right"></div>'),r=_addUnit(e.height),s=_undef(e.iconClass,"");t.div.append(n),r&&(n.css("height",r),a.css("line-height",r));var o;return t.centerLineMode&&(o=K('<div class="ke-inline-block ke-menu-item-center"></div>'),r&&o.css("height",r)),n.mouseover(function(e){K(this).addClass("ke-menu-item-on"),o&&o.addClass("ke-menu-item-center-on")}).mouseout(function(e){K(this).removeClass("ke-menu-item-on"),o&&o.removeClass("ke-menu-item-center-on")}).click(function(t){e.click.call(K(this)),t.stopPropagation()}).append(i),o&&n.append(o),n.append(a),e.checked&&(s="ke-icon-checked"),""!==s&&i.html('<span class="ke-inline-block ke-toolbar-icon ke-toolbar-icon-url '+s+'"></span>'),a.html(e.title),t},remove:function(){var e=this;return e.options.beforeRemove&&e.options.beforeRemove.call(e),K(".ke-menu-item",e.div[0]).unbind(),KMenu.parent.remove.call(e),e}}),K.MenuClass=KMenu,K.menu=_menu,_extend(KColorPicker,KWidget,{init:function(e){var t=this;e.z=e.z||811213,KColorPicker.parent.init.call(t,e);var n=e.colors||[["#E53333","#E56600","#FF9900","#64451D","#DFC5A4","#FFE500"],["#009900","#006600","#99BB00","#B8D100","#60D978","#00D5FF"],["#337FE5","#003399","#4C33E5","#9933E5","#CC33E5","#EE33EE"],["#FFFFFF","#CCCCCC","#999999","#666666","#333333","#000000"]];t.selectedColor=(e.selectedColor||"").toLowerCase(),t._cells=[],t.div.addClass("ke-colorpicker").bind("click,mousedown",function(e){e.stopPropagation()}).attr("unselectable","on");var i=t.doc.createElement("table");t.div.append(i),i.className="ke-colorpicker-table",i.cellPadding=0,i.cellSpacing=0,i.border=0;var a=i.insertRow(0),r=a.insertCell(0);r.colSpan=n[0].length,t._addAttr(r,"","ke-colorpicker-cell-top");for(var s=0;s<n.length;s++){a=i.insertRow(s+1);for(var o=0;o<n[s].length;o++)r=a.insertCell(o),t._addAttr(r,n[s][o],"ke-colorpicker-cell")}},_addAttr:function(e,t,n){var i=this;e=K(e).addClass(n),i.selectedColor===t.toLowerCase()&&e.addClass("ke-colorpicker-cell-selected"),e.attr("title",t||i.options.noColor),e.mouseover(function(e){K(this).addClass("ke-colorpicker-cell-on")}),e.mouseout(function(e){K(this).removeClass("ke-colorpicker-cell-on")}),e.click(function(e){e.stop(),i.options.click.call(K(this),t)}),t?e.append(K('<div class="ke-colorpicker-cell-color" unselectable="on"></div>').css("background-color",t)):e.html(i.options.noColor),K(e).attr("unselectable","on"),i._cells.push(e)},remove:function(){var e=this;return _each(e._cells,function(){this.unbind()}),KColorPicker.parent.remove.call(e),e}}),K.ColorPickerClass=KColorPicker,K.colorpicker=_colorpicker,_extend(KUploadButton,{init:function(e){var t=this,n=K(e.button),i=e.fieldName||"file",a=e.url||"",r=n.val(),s=e.extraParams||{},o=n[0].className||"",l=e.target||"kindeditor_upload_iframe_"+(new Date).getTime();e.afterError=e.afterError||function(e){alert(e)};var c=[];for(var d in s)c.push('<input type="hidden" name="'+d+'" value="'+s[d]+'" />');var u=['<div class="ke-inline-block '+o+'">',e.target?"":'<iframe name="'+l+'" style="display:none;"></iframe>',e.form?'<div class="ke-upload-area">':'<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+l+'" action="'+a+'">','<span class="ke-button-common">',c.join(""),'<input type="button" class="ke-button-common ke-button" value="'+r+'" />',"</span>",'<input type="file" class="ke-upload-file" name="'+i+'" tabindex="-1" />',e.form?"</div>":"</form>","</div>"].join(""),p=K(u,n.doc);n.hide(),n.before(p),t.div=p,t.button=n,t.iframe=e.target?K('iframe[name="'+l+'"]'):K("iframe",p),t.form=e.form?K(e.form):K("form",p),t.fileBox=K(".ke-upload-file",p);var m=e.width||K(".ke-button-common",p).width();K(".ke-upload-area",p).width(m),t.options=e},submit:function(){var e=this,t=e.iframe;return t.bind("load",function(){t.unbind();var n=document.createElement("form");e.fileBox.before(n),K(n).append(e.fileBox),n.reset(),K(n).remove(!0);var i,a=K.iframeDoc(t),r=a.getElementsByTagName("pre")[0],s="";s=r?r.innerHTML:a.body.innerHTML,s=_unescape(s),t[0].src="javascript:false";try{i=K.json(s)}catch(o){e.options.afterError.call(e,"<!doctype html><html>"+a.body.parentNode.innerHTML+"</html>")}i&&e.options.afterUpload.call(e,i)}),e.form[0].submit(),e},remove:function(){var e=this;return e.fileBox&&e.fileBox.unbind(),e.iframe.remove(),e.div.remove(),e.button.show(),e}}),K.UploadButtonClass=KUploadButton,K.uploadbutton=_uploadbutton,_extend(KDialog,KWidget,{init:function(e){var t=this,n=_undef(e.shadowMode,!0);e.z=e.z||811213,e.shadowMode=!1,e.autoScroll=_undef(e.autoScroll,!0),KDialog.parent.init.call(t,e);var i=e.title,a=K(e.body,t.doc),r=e.previewBtn,s=e.yesBtn,o=e.noBtn,l=e.closeBtn,c=_undef(e.showMask,!0);t.div.addClass("ke-dialog").bind("click,mousedown",function(e){e.stopPropagation()});var d=K('<div class="ke-dialog-content"></div>').appendTo(t.div);_IE&&7>_V?t.iframeMask=K('<iframe src="about:blank" class="ke-dialog-shadow"></iframe>').appendTo(t.div):n&&K('<div class="ke-dialog-shadow"></div>').appendTo(t.div);
var u=K('<div class="ke-dialog-header"></div>');d.append(u),u.html(i),t.closeIcon=K('<span class="ke-dialog-icon-close" title="'+l.name+'"></span>').click(l.click),u.append(t.closeIcon),t.draggable({clickEl:u,beforeDrag:e.beforeDrag});var p=K('<div class="ke-dialog-body"></div>');d.append(p),p.append(a);var m=K('<div class="ke-dialog-footer"></div>');if((r||s||o)&&d.append(m),_each([{btn:r,name:"preview"},{btn:s,name:"yes"},{btn:o,name:"no"}],function(){if(this.btn){var e=_createButton(this.btn);e.addClass("ke-dialog-"+this.name),m.append(e)}}),t.height&&p.height(_removeUnit(t.height)-u.height()-m.height()),t.div.width(t.div.width()),t.div.height(t.div.height()),t.mask=null,c){var h=_docElement(t.doc),f=Math.max(h.scrollWidth,h.clientWidth),v=Math.max(h.scrollHeight,h.clientHeight);t.mask=_widget({x:0,y:0,z:t.z-1,cls:"ke-dialog-mask",width:f,height:v})}t.autoPos(t.div.width(),t.div.height()),t.footerDiv=m,t.bodyDiv=p,t.headerDiv=u,t.isLoading=!1},setMaskIndex:function(e){var t=this;t.mask.div.css("z-index",e)},showLoading:function(e){e=_undef(e,"");var t=this,n=t.bodyDiv;return t.loading=K('<div class="ke-dialog-loading"><div class="ke-inline-block ke-dialog-loading-content" style="margin-top:'+Math.round(n.height()/3)+'px;">'+e+"</div></div>").width(n.width()).height(n.height()).css("top",t.headerDiv.height()+"px"),n.css("visibility","hidden").after(t.loading),t.isLoading=!0,t},hideLoading:function(){return this.loading&&this.loading.remove(),this.bodyDiv.css("visibility","visible"),this.isLoading=!1,this},remove:function(){var e=this;return e.options.beforeRemove&&e.options.beforeRemove.call(e),e.mask&&e.mask.remove(),e.iframeMask&&e.iframeMask.remove(),e.closeIcon.unbind(),K("input",e.div).unbind(),K("button",e.div).unbind(),e.footerDiv.unbind(),e.bodyDiv.unbind(),e.headerDiv.unbind(),K("iframe",e.div).each(function(){K(this).remove()}),KDialog.parent.remove.call(e),e}}),K.DialogClass=KDialog,K.dialog=_dialog,K.tabs=_tabs,K.loadScript=_loadScript,K.loadStyle=_loadStyle,K.ajax=_ajax;var _plugins={},_language={};KEditor.prototype={lang:function(e){return _lang(e,this.langType)},loadPlugin:function(e,t){var n=this;return _plugins[e]?_isFunction(_plugins[e])?(_plugins[e].call(n,KindEditor),t&&t.call(n),n):(setTimeout(function(){n.loadPlugin(e,t)},100),n):(_plugins[e]="loading",_loadScript(n.pluginsPath+e+"/"+e+".js?ver="+encodeURIComponent(K.DEBUG?_TIME:_VERSION),function(){setTimeout(function(){_plugins[e]&&n.loadPlugin(e,t)},0)}),n)},handler:function(e,t){var n=this;return n._handlers[e]||(n._handlers[e]=[]),_isFunction(t)?(n._handlers[e].push(t),n):(_each(n._handlers[e],function(){t=this.call(n,t)}),t)},clickToolbar:function(e,t){var n=this,i="clickToolbar"+e;return t===undefined?n._handlers[i]?n.handler(i):(n.loadPlugin(e,function(){n.handler(i)}),n):n.handler(i,t)},updateState:function(){var e=this;return _each("justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,insertunorderedlist,subscript,superscript,bold,italic,underline,strikethrough".split(","),function(t,n){e.cmd.state(n)?e.toolbar.select(n):e.toolbar.unselect(n)}),e},addContextmenu:function(e){return this._contextmenus.push(e),this},afterCreate:function(e){return this.handler("afterCreate",e)},beforeRemove:function(e){return this.handler("beforeRemove",e)},beforeGetHtml:function(e){return this.handler("beforeGetHtml",e)},beforeSetHtml:function(e){return this.handler("beforeSetHtml",e)},afterSetHtml:function(e){return this.handler("afterSetHtml",e)},create:function(){function e(){return 0===l.height()?void setTimeout(e,100):void t.resize(i,a,!1)}var t=this,n=t.fullscreenMode;if(t.isCreated)return t;if(t.srcElement.data("kindeditor"))return t;t.srcElement.data("kindeditor","true"),n?_docElement().style.overflow="hidden":_docElement().style.overflow="";var i=n?_docElement().clientWidth+"px":t.width,a=n?_docElement().clientHeight+"px":t.height;(_IE&&8>_V||_QUIRKS)&&(a=_addUnit(_removeUnit(a)+2));var r=t.container=K(t.layout);n?K(document.body).append(r):t.srcElement.before(r);var s=K(".toolbar",r),o=K(".edit",r),l=t.statusbar=K(".statusbar",r);r.removeClass("container").addClass("ke-container ke-container-"+t.themeType).css("width",i),n?(r.css({position:"absolute",left:0,top:0,"z-index":811211}),_GECKO||(t._scrollPos=_getScrollPos()),window.scrollTo(0,0),K(document.body).css({height:"1px",overflow:"hidden"}),K(document.body.parentNode).css("overflow","hidden"),t._fullscreenExecuted=!0):(t._fullscreenExecuted&&(K(document.body).css({height:"",overflow:""}),K(document.body.parentNode).css("overflow","")),t._scrollPos&&window.scrollTo(t._scrollPos.x,t._scrollPos.y));var c=[];K.each(t.items,function(e,n){"|"==n?c.push('<span class="ke-inline-block ke-separator"></span>'):"/"==n?c.push('<div class="ke-hr"></div>'):(c.push('<span class="ke-outline" data-name="'+n+'" title="'+t.lang(n)+'" unselectable="on">'),c.push('<span class="ke-toolbar-icon ke-toolbar-icon-url ke-icon-'+n+'" unselectable="on"></span></span>'))});var d=t.toolbar=_toolbar({src:s,html:c.join(""),noDisableItems:t.noDisableItems,click:function(e,n){if(e.stop(),t.menu){var i=t.menu.name;if(t.hideMenu(),i===n)return}t.clickToolbar(n)}}),u=_removeUnit(a)-d.div.height(),p=t.edit=_edit({height:u>0&&_removeUnit(a)>t.minHeight?u:t.minHeight,src:o,srcElement:t.srcElement,designMode:t.designMode,themesPath:t.themesPath,bodyClass:t.bodyClass,cssPath:t.cssPath,cssData:t.cssData,beforeGetHtml:function(e){return e=t.beforeGetHtml(e),e=_removeBookmarkTag(_removeTempTag(e)),_formatHtml(e,t.filterMode?t.htmlTags:null,t.urlType,t.wellFormatMode,t.indentChar)},beforeSetHtml:function(e){return e=_formatHtml(e,t.filterMode?t.htmlTags:null,"",!1),t.beforeSetHtml(e)},afterSetHtml:function(){t.edit=p=this,t.afterSetHtml()},afterCreate:function(){if(t.edit=p=this,t.cmd=p.cmd,t._docMousedownFn=function(e){t.menu&&t.hideMenu()},K(p.doc,document).mousedown(t._docMousedownFn),_bindContextmenuEvent.call(t),_bindNewlineEvent.call(t),_bindTabEvent.call(t),_bindFocusEvent.call(t),p.afterChange(function(e){p.designMode&&(t.updateState(),t.addBookmark(),t.options.afterChange&&t.options.afterChange.call(t))}),p.textarea.keyup(function(e){e.ctrlKey||e.altKey||!_INPUT_KEY_MAP[e.which]||t.options.afterChange&&t.options.afterChange.call(t)}),t.readonlyMode&&t.readonly(),t.isCreated=!0,""===t.initContent&&(t.initContent=t.html()),t._undoStack.length>0){var e=t._undoStack.pop();e.start&&(t.html(e.html),p.cmd.range.moveToBookmark(e),t.select())}t.afterCreate(),t.options.afterCreate&&t.options.afterCreate.call(t)}});return l.removeClass("statusbar").addClass("ke-statusbar").append('<span class="ke-inline-block ke-statusbar-center-icon"></span>').append('<span class="ke-inline-block ke-statusbar-right-icon"></span>'),t._fullscreenResizeHandler&&(K(window).unbind("resize",t._fullscreenResizeHandler),t._fullscreenResizeHandler=null),e(),n?(t._fullscreenResizeHandler=function(e){t.isCreated&&t.resize(_docElement().clientWidth,_docElement().clientHeight,!1)},K(window).bind("resize",t._fullscreenResizeHandler),d.select("fullscreen"),l.first().css("visibility","hidden"),l.last().css("visibility","hidden")):(_GECKO&&K(window).bind("scroll",function(e){t._scrollPos=_getScrollPos()}),t.resizeType>0?_drag({moveEl:r,clickEl:l,moveFn:function(e,n,i,a,r,s){a+=s,t.resize(null,a)}}):l.first().css("visibility","hidden"),2===t.resizeType?_drag({moveEl:r,clickEl:l.last(),moveFn:function(e,n,i,a,r,s){i+=r,a+=s,t.resize(i,a)}}):l.last().css("visibility","hidden")),t},remove:function(){var e=this;return e.isCreated?(e.beforeRemove(),e.srcElement.data("kindeditor",""),e.menu&&e.hideMenu(),_each(e.dialogs,function(){e.hideDialog()}),K(document).unbind("mousedown",e._docMousedownFn),e.toolbar.remove(),e.edit.remove(),e.statusbar.last().unbind(),e.statusbar.unbind(),e.container.remove(),e.container=e.toolbar=e.edit=e.menu=null,e.dialogs=[],e.isCreated=!1,e):e},resize:function(e,t,n){var i=this;return n=_undef(n,!0),e&&(/%/.test(e)||(e=_removeUnit(e),e=e<i.minWidth?i.minWidth:e),i.container.css("width",_addUnit(e)),n&&(i.width=_addUnit(e))),t&&(t=_removeUnit(t),editHeight=_removeUnit(t)-i.toolbar.div.height()-i.statusbar.height(),editHeight=editHeight<i.minHeight?i.minHeight:editHeight,i.edit.setHeight(editHeight),n&&(i.height=_addUnit(t))),i},select:function(){return this.isCreated&&this.cmd.select(),this},html:function(e){var t=this;return e===undefined?t.isCreated?t.edit.html():_elementVal(t.srcElement):(t.isCreated?t.edit.html(e):_elementVal(t.srcElement,e),t.isCreated&&t.cmd.selection(),t)},fullHtml:function(){return this.isCreated?this.edit.html(undefined,!0):""},text:function(e){var t=this;return e===undefined?_trim(t.html().replace(/<(?!img|embed).*?>/gi,"").replace(/&nbsp;/gi," ")):t.html(_escape(e))},isEmpty:function(){return""===_trim(this.text().replace(/\r\n|\n|\r/,""))},isDirty:function(){return _trim(this.initContent.replace(/\r\n|\n|\r|t/g,""))!==_trim(this.html().replace(/\r\n|\n|\r|t/g,""))},selectedHtml:function(){var e=this.isCreated?this.cmd.range.html():"";return e=_removeBookmarkTag(_removeTempTag(e))},count:function(e){var t=this;return e=(e||"html").toLowerCase(),"html"===e?t.html().length:"text"===e?t.text().replace(/<(?:img|embed).*?>/gi,"K").replace(/\r\n|\n|\r/g,"").length:0},exec:function(e){e=e.toLowerCase();var t=this,n=t.cmd,i=_inArray(e,"selectall,copy,paste,print".split(","))<0;return i&&t.addBookmark(!1),n[e].apply(n,_toArray(arguments,1)),i&&(t.updateState(),t.addBookmark(!1),t.options.afterChange&&t.options.afterChange.call(t)),t},insertHtml:function(e,t){return this.isCreated?(e=this.beforeSetHtml(e),this.exec("inserthtml",e,t),this):this},appendHtml:function(e){if(this.html(this.html()+e),this.isCreated){var t=this.cmd;t.range.selectNodeContents(t.doc.body).collapse(!1),t.select()}return this},sync:function(){return _elementVal(this.srcElement,this.html()),this},focus:function(){return this.isCreated?this.edit.focus():this.srcElement[0].focus(),this},blur:function(){return this.isCreated?this.edit.blur():this.srcElement[0].blur(),this},addBookmark:function(e){e=_undef(e,!0);var t,n=this,i=n.edit,a=i.doc.body,r=_removeTempTag(a.innerHTML);if(e&&n._undoStack.length>0){var s=n._undoStack[n._undoStack.length-1];if(Math.abs(r.length-_removeBookmarkTag(s.html).length)<n.minChangeSize)return n}if(i.designMode&&!n._firstAddBookmark){var o=n.cmd.range;t=o.createBookmark(!0),t.html=_removeTempTag(a.innerHTML),o.moveToBookmark(t)}else t={html:r};return n._firstAddBookmark=!1,_addBookmarkToStack(n._undoStack,t),n},undo:function(){return _undoToRedo.call(this,this._undoStack,this._redoStack)},redo:function(){return _undoToRedo.call(this,this._redoStack,this._undoStack)},fullscreen:function(e){return this.fullscreenMode=e===undefined?!this.fullscreenMode:e,this.addBookmark(!1),this.remove().create()},readonly:function(e){e=_undef(e,!0);var t=this,n=t.edit,i=n.doc;t.designMode?t.toolbar.disableAll(e,[]):_each(t.noDisableItems,function(){t.toolbar[e?"disable":"enable"](this)}),_IE?i.body.contentEditable=!e:i.designMode=e?"off":"on",n.textarea[0].disabled=e},createMenu:function(e){var t=this,n=e.name,i=t.toolbar.get(n),a=i.pos();return e.x=a.x,e.y=a.y+i.height(),e.z=t.options.zIndex,e.shadowMode=_undef(e.shadowMode,t.shadowMode),e.selectedColor!==undefined?(e.cls="ke-colorpicker-"+t.themeType,e.noColor=t.lang("noColor"),t.menu=_colorpicker(e)):(e.cls="ke-menu-"+t.themeType,e.centerLineMode=!1,t.menu=_menu(e)),t.menu},hideMenu:function(){return this.menu.remove(),this.menu=null,this},hideContextmenu:function(){return this.contextmenu.remove(),this.contextmenu=null,this},createDialog:function(e){var t=this;e.name;if(e.z=t.options.zIndex,e.shadowMode=_undef(e.shadowMode,t.shadowMode),e.closeBtn=_undef(e.closeBtn,{name:t.lang("close"),click:function(e){t.hideDialog(),_IE&&t.cmd&&t.cmd.select()}}),e.noBtn=_undef(e.noBtn,{name:t.lang(e.yesBtn?"no":"close"),click:function(e){t.hideDialog(),_IE&&t.cmd&&t.cmd.select()}}),"page"!=t.dialogAlignType&&(e.alignEl=t.container),e.cls="ke-dialog-"+t.themeType,t.dialogs.length>0){var n=t.dialogs[0],i=t.dialogs[t.dialogs.length-1];n.setMaskIndex(i.z+2),e.z=i.z+3,e.showMask=!1}var a=_dialog(e);return t.dialogs.push(a),a},hideDialog:function(){var e=this;if(e.dialogs.length>0&&e.dialogs.pop().remove(),e.dialogs.length>0){var t=e.dialogs[0],n=e.dialogs[e.dialogs.length-1];t.setMaskIndex(n.z-1)}return e},errorDialog:function(e){var t=this,n=t.createDialog({width:750,title:t.lang("uploadError"),body:'<div style="padding:10px 20px;"><iframe frameborder="0" style="width:708px;height:400px;"></iframe></div>'}),i=K("iframe",n.div),a=K.iframeDoc(i);return a.open(),a.write(e),a.close(),K(a.body).css("background-color","#FFF"),i[0].contentWindow.focus(),t}},_instances=[],K.remove=function(e){_eachEditor(e,function(e){this.remove(),_instances.splice(e,1)})},K.sync=function(e){_eachEditor(e,function(){this.sync()})},K.html=function(e,t){_eachEditor(e,function(){this.html(t)})},K.insertHtml=function(e,t){_eachEditor(e,function(){this.insertHtml(t)})},K.appendHtml=function(e,t){_eachEditor(e,function(){this.appendHtml(t)})},_IE&&7>_V&&_nativeCommand(document,"BackgroundImageCache",!0),K.EditorClass=KEditor,K.editor=_editor,K.create=_create,K.instances=_instances,K.plugin=_plugin,K.lang=_lang,_plugin("core",function(e){var t=this,n={undo:"Z",redo:"Y",bold:"B",italic:"I",underline:"U",print:"P",selectall:"A"};if(t.afterSetHtml(function(){t.options.afterChange&&t.options.afterChange.call(t)}),t.afterCreate(function(){if("form"==t.syncType){for(var n=e(t.srcElement),i=!1;n=n.parent();)if("form"==n.name){i=!0;break}if(i){n.bind("submit",function(n){t.sync(),e(window).bind("unload",function(){t.edit.textarea.remove()})});var a=e('[type="reset"]',n);a.click(function(){t.html(t.initContent),t.cmd.selection()}),t.beforeRemove(function(){n.unbind(),a.unbind()})}}}),t.clickToolbar("source",function(){t.edit.designMode?(t.toolbar.disableAll(!0),t.edit.design(!1),t.toolbar.select("source")):(t.toolbar.disableAll(!1),t.edit.design(!0),t.toolbar.unselect("source"),_GECKO?setTimeout(function(){t.cmd.selection()},0):t.cmd.selection()),t.designMode=t.edit.designMode}),t.afterCreate(function(){t.designMode||t.toolbar.disableAll(!0).select("source")}),t.clickToolbar("fullscreen",function(){t.fullscreen()}),t.fullscreenShortcut){var i=!1;t.afterCreate(function(){if(e(t.edit.doc,t.edit.textarea).keyup(function(e){27==e.which&&setTimeout(function(){t.fullscreen()},0)}),i){if(_IE&&!t.designMode)return;t.focus()}i||(i=!0)})}_each("undo,redo".split(","),function(e,i){n[i]&&t.afterCreate(function(){_ctrl(this.edit.doc,n[i],function(){t.clickToolbar(i)})}),t.clickToolbar(i,function(){t[i]()})}),t.clickToolbar("formatblock",function(){var e=t.lang("formatblock.formatBlock"),n={h1:28,h2:24,h3:18,H4:14,p:12},i=t.cmd.val("formatblock"),a=t.createMenu({name:"formatblock",width:"en"==t.langType?200:150});_each(e,function(e,r){var s="font-size:"+n[e]+"px;";"h"===e.charAt(0)&&(s+="font-weight:bold;"),a.addItem({title:'<span style="'+s+'" unselectable="on">'+r+"</span>",height:n[e]+12,checked:i===e||i===r,click:function(){t.select().exec("formatblock","<"+e+">").hideMenu()}})})}),t.clickToolbar("fontname",function(){var e=t.cmd.val("fontname"),n=t.createMenu({name:"fontname",width:150});_each(t.lang("fontname.fontName"),function(i,a){n.addItem({title:'<span style="font-family: '+i+';" unselectable="on">'+a+"</span>",checked:e===i.toLowerCase()||e===a.toLowerCase(),click:function(){t.exec("fontname",i).hideMenu()}})})}),t.clickToolbar("fontsize",function(){var e=t.cmd.val("fontsize"),n=t.createMenu({name:"fontsize",width:150});_each(t.fontSizeTable,function(i,a){n.addItem({title:'<span style="font-size:'+a+';" unselectable="on">'+a+"</span>",height:_removeUnit(a)+12,checked:e===a,click:function(){t.exec("fontsize",a).hideMenu()}})})}),_each("forecolor,hilitecolor".split(","),function(e,n){t.clickToolbar(n,function(){t.createMenu({name:n,selectedColor:t.cmd.val(n)||"default",colors:t.colorTable,click:function(e){t.exec(n,e).hideMenu()}})})}),_each("cut,copy,paste".split(","),function(e,n){t.clickToolbar(n,function(){t.focus();try{t.exec(n,null)}catch(e){alert(t.lang(n+"Error"))}})}),t.clickToolbar("about",function(){var e='<div style="margin:20px;"><div>KindEditor '+_VERSION+'</div><div>Copyright &copy; <a href="http://www.kindsoft.net/" target="_blank">kindsoft.net</a> All rights reserved.</div></div>';t.createDialog({name:"about",width:350,title:t.lang("about"),body:e})}),t.plugin.getSelectedLink=function(){return t.cmd.commonAncestor("a")},t.plugin.getSelectedImage=function(){return _getImageFromRange(t.edit.cmd.range,function(e){return!/^ke-\w+$/i.test(e[0].className)})},t.plugin.getSelectedFlash=function(){return _getImageFromRange(t.edit.cmd.range,function(e){return"ke-flash"==e[0].className})},t.plugin.getSelectedMedia=function(){return _getImageFromRange(t.edit.cmd.range,function(e){return"ke-media"==e[0].className||"ke-rm"==e[0].className})},t.plugin.getSelectedAnchor=function(){return _getImageFromRange(t.edit.cmd.range,function(e){return"ke-anchor"==e[0].className})},_each("link,image,flash,media,anchor".split(","),function(e,n){var i=n.charAt(0).toUpperCase()+n.substr(1);_each("edit,delete".split(","),function(e,a){t.addContextmenu({title:t.lang(a+i),click:function(){t.loadPlugin(n,function(){t.plugin[n][a](),t.hideMenu()})},cond:t.plugin["getSelected"+i],width:150,iconClass:"edit"==a?"ke-icon-"+n:undefined})}),t.addContextmenu({title:"-"})}),t.plugin.getSelectedTable=function(){return t.cmd.commonAncestor("table")},t.plugin.getSelectedRow=function(){return t.cmd.commonAncestor("tr")},t.plugin.getSelectedCell=function(){return t.cmd.commonAncestor("td")},_each("prop,cellprop,colinsertleft,colinsertright,rowinsertabove,rowinsertbelow,rowmerge,colmerge,rowsplit,colsplit,coldelete,rowdelete,insert,delete".split(","),function(e,n){var i=_inArray(n,["prop","delete"])<0?t.plugin.getSelectedCell:t.plugin.getSelectedTable;t.addContextmenu({title:t.lang("table"+n),click:function(){t.loadPlugin("table",function(){t.plugin.table[n](),t.hideMenu()})},cond:i,width:170,iconClass:"ke-icon-table"+n})}),t.addContextmenu({title:"-"}),_each("selectall,justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,insertunorderedlist,indent,outdent,subscript,superscript,hr,print,bold,italic,underline,strikethrough,removeformat,unlink".split(","),function(e,i){n[i]&&t.afterCreate(function(){_ctrl(this.edit.doc,n[i],function(){t.cmd.selection(),t.clickToolbar(i)})}),t.clickToolbar(i,function(){t.focus().exec(i,null)})}),t.afterCreate(function(){function n(){i.range.moveToBookmark(a),i.select(),_WEBKIT&&(e("div."+o,r).each(function(){e(this).after("<br />").remove(!0)}),e("span.Apple-style-span",r).remove(!0),e("span.Apple-tab-span",r).remove(!0),e("span[style]",r).each(function(){"nowrap"==e(this).css("white-space")&&e(this).remove(!0)}),e("meta",r).remove());var n=r[0].innerHTML;r.remove(),""!==n&&(_WEBKIT&&(n=n.replace(/(<br>)\1/gi,"$1")),2===t.pasteType&&(n=n.replace(/(<(?:p|p\s[^>]*)>) *(<\/p>)/gi,""),/schemas-microsoft-com|worddocument|mso-\w+/i.test(n)?n=_clearMsWord(n,t.filterMode?t.htmlTags:e.options.htmlTags):(n=_formatHtml(n,t.filterMode?t.htmlTags:null),n=t.beforeSetHtml(n))),1===t.pasteType&&(n=n.replace(/&nbsp;/gi," "),n=n.replace(/\n\s*\n/g,"\n"),n=n.replace(/<br[^>]*>/gi,"\n"),n=n.replace(/<\/p><p[^>]*>/gi,"\n"),n=n.replace(/<[^>]+>/g,""),n=n.replace(/ {2}/g," &nbsp;"),"p"==t.newlineTag?/\n/.test(n)&&(n=n.replace(/^/,"<p>").replace(/$/,"<br /></p>").replace(/\n/g,"<br /></p><p>")):n=n.replace(/\n/g,"<br />$&")),t.insertHtml(n,!0))}var i,a,r,s=t.edit.doc,o="__kindeditor_paste__",l=!1;e(s.body).bind("paste",function(c){if(0===t.pasteType)return void c.stop();if(!l){if(l=!0,e("div."+o,s).remove(),i=t.cmd.selection(),a=i.range.createBookmark(),r=e('<div class="'+o+'"></div>',s).css({position:"absolute",width:"1px",height:"1px",overflow:"hidden",left:"-1981px",top:e(a.start).pos().y+"px","white-space":"nowrap"}),e(s.body).append(r),_IE){var d=i.range.get(!0);try{d.moveToElementText(r[0]),d.select(),d.execCommand("paste"),c.preventDefault()}catch(c){return!1}}else i.range.selectNodeContents(r[0]),i.select(),r[0].tabIndex=-1,r[0].focus();setTimeout(function(){n(),l=!1},0)}})}),t.beforeGetHtml(function(e){return _IE&&8>=_V&&(e=e.replace(/<div\s+[^>]*data-ke-input-tag="([^"]*)"[^>]*>([\s\S]*?)<\/div>/gi,function(e,t){return unescape(t)}),e=e.replace(/(<input)((?:\s+[^>]*)?>)/gi,function(e,t,n){return/\s+type="[^"]+"/i.test(e)?e:t+' type="text"'+n})),e.replace(/(<(?:noscript|noscript\s[^>]*)>)([\s\S]*?)(<\/noscript>)/gi,function(e,t,n,i){return t+_unescape(n).replace(/\s+/g," ")+i}).replace(/<img[^>]*class="?ke-(flash|rm|media)"?[^>]*>/gi,function(e){var t=_getAttrList(e),n=_getCssList(t.style||""),i=_mediaAttrs(t["data-ke-tag"]),a=_undef(n.width,""),r=_undef(n.height,"");return/px/i.test(a)&&(a=_removeUnit(a)),/px/i.test(r)&&(r=_removeUnit(r)),i.width=_undef(t.width,a),i.height=_undef(t.height,r),_mediaEmbed(i)}).replace(/<img[^>]*class="?ke-anchor"?[^>]*>/gi,function(e){var t=_getAttrList(e);return'<a name="'+unescape(t["data-ke-name"])+'"></a>'}).replace(/<div\s+[^>]*data-ke-script-attr="([^"]*)"[^>]*>([\s\S]*?)<\/div>/gi,function(e,t,n){return"<script"+unescape(t)+">"+unescape(n)+"</script>"}).replace(/<div\s+[^>]*data-ke-noscript-attr="([^"]*)"[^>]*>([\s\S]*?)<\/div>/gi,function(e,t,n){return"<noscript"+unescape(t)+">"+unescape(n)+"</noscript>"}).replace(/(<[^>]*)data-ke-src="([^"]*)"([^>]*>)/gi,function(e,t,n,i){return e=e.replace(/(\s+(?:href|src)=")[^"]*(")/i,function(e,t,i){return t+_unescape(n)+i}),e=e.replace(/\s+data-ke-src="[^"]*"/i,"")}).replace(/(<[^>]+\s)data-ke-(on\w+="[^"]*"[^>]*>)/gi,function(e,t,n){return t+n})}),t.beforeSetHtml(function(e){return _IE&&8>=_V&&(e=e.replace(/<input[^>]*>|<(select|button)[^>]*>[\s\S]*?<\/\1>/gi,function(e){var t=_getAttrList(e),n=_getCssList(t.style||"");return"none"==n.display?'<div class="ke-display-none" data-ke-input-tag="'+escape(e)+'"></div>':e})),e.replace(/<embed[^>]*type="([^"]+)"[^>]*>(?:<\/embed>)?/gi,function(e){var n=_getAttrList(e);return n.src=_undef(n.src,""),n.width=_undef(n.width,0),n.height=_undef(n.height,0),_mediaImg(t.themesPath+"common/blank.gif",n)}).replace(/<a[^>]*name="([^"]+)"[^>]*>(?:<\/a>)?/gi,function(e){var n=_getAttrList(e);return n.href!==undefined?e:'<img class="ke-anchor" src="'+t.themesPath+'common/anchor.gif" data-ke-name="'+escape(n.name)+'" />'}).replace(/<script([^>]*)>([\s\S]*?)<\/script>/gi,function(e,t,n){return'<div class="ke-script" data-ke-script-attr="'+escape(t)+'">'+escape(n)+"</div>"}).replace(/<noscript([^>]*)>([\s\S]*?)<\/noscript>/gi,function(e,t,n){return'<div class="ke-noscript" data-ke-noscript-attr="'+escape(t)+'">'+escape(n)+"</div>"}).replace(/(<[^>]*)(href|src)="([^"]*)"([^>]*>)/gi,function(e,t,n,i,a){return e.match(/\sdata-ke-src="[^"]*"/i)?e:e=t+n+'="'+i+'" data-ke-src="'+_escape(i)+'"'+a}).replace(/(<[^>]+\s)(on\w+="[^"]*"[^>]*>)/gi,function(e,t,n){return t+"data-ke-"+n}).replace(/<table[^>]*\s+border="0"[^>]*>/gi,function(e){return e.indexOf("ke-zeroborder")>=0?e:_addClassToTag(e,"ke-zeroborder")})})})}}(window),define("kindEditor",function(e){return function(){var t;return t||e.KindEditor}}(this)),KindEditor.plugin("lineheight",function(e){var t=this,n="lineheight",i=t.lang(n+".");t.clickToolbar(n,function(){var a="",r=t.cmd.commonNode({"*":".line-height"});r&&(a=r.css("line-height"));var s=t.createMenu({name:n,width:150});e.each(i.lineHeight,function(n,i){e.each(i,function(e,n){s.addItem({title:n,checked:a===e,click:function(){t.cmd.toggle('<span style="line-height:'+e+';"></span>',{span:".line-height="+e}),t.updateState(),t.addBookmark(),t.hideMenu()}})})})})}),define("kindEditor.lineheight",function(){}),define("component/editor/plugins/toolbar",["require","../../../util/i18n","../../../module/common/globalService"],function(e){e(["kindEditor"],function(){e(["kindEditor.lineheight"]);var t=e("../../../util/i18n"),n=e("../../../module/common/globalService"),i="zh_CN"==n.getConfig("context.locale")?"zh_CN":"en";KindEditor.each({"plug-align":{name:t.t("common/lbl_align_style"),method:{justifyleft:t.t("common/lbl_justify_left"),justifycenter:t.t("common/lbl_justify_center"),justifyright:t.t("common/lbl_justify_right")}},"plug-order":{name:t.t("common/lbl_order_style"),method:{insertorderedlist:t.t("common/lbl_insert_ordered_list"),insertunorderedlist:t.t("common/lbl_insert_unordered_list")}},"plug-indent":{name:t.t("common/lbl_indent"),method:{indent:t.t("common/lbl_indent_right"),outdent:t.t("common/lbl_indent_left")}}},function(e,t){var n={};n[e]=t.name,KindEditor.lang(n,i),KindEditor.plugin(e,function(n){var i=this;i.clickToolbar(e,function(){var a=i.createMenu({name:e,width:t.width||100});n.each(t.method,function(t,n){a.addItem({title:n,checked:!1,iconClass:e+"-"+t,click:function(){i.exec(t).hideMenu()}})})})})})})}),define("component/editor/plugins/link",["require","kindEditor","../../../util/i18n"],function(e){var t=e("kindEditor"),n=e("../../../util/i18n");t.plugin("link",function(e){var t=this,i="link";t.plugin.link={edit:function(){var a='<div style="padding:18px 40px"><div class="ke-dialog-row" style="line-height: 28px"><label for="keUrl" style="width:60px;cursor: default">'+n.t("common/lbl_url_text")+'</label><input class="ke-input-text" type="text" id="keUrl" name="title" style="width:260px; height: 22px;" /></div><div class="ke-dialog-row" style="line-height: 28px"><label for="keUrl" style="width:60px;cursor: default">'+n.t("common/lbl_url_link")+'</label><input class="ke-input-text" type="text" id="keUrl" name="url" style="width:260px; height: 22px;" /></div></div>',r=t.createDialog({name:i,width:450,title:t.lang(i),body:a,yesBtn:{name:t.lang("yes"),click:function(){var n=e.trim(o.val()),i=e.trim(l.val());return"http://"==n||e.invalidUrl(n)?(alert(t.lang("invalidUrl")),void o[0].focus()):void t.exec("createlink",i,n,"_blank").hideDialog().focus()}}}),s=r.div,o=e('input[name="url"]',s),l=e('input[name="title"]',s);o.val("http://"),t.cmd.selection();var c=t.plugin.getSelectedLink();c?(t.cmd.range.selectNode(c[0]),t.cmd.select(),o.val(c.attr("data-ke-src")),l.val(c.text())):l.val(t.selectedHtml()),o[0].focus(),o[0].select()},"delete":function(){t.exec("unlink",null)}},t._handlers.clickToolbarlink&&t._handlers.clickToolbarlink.length>0&&(t._handlers.clickToolbarlink=[]),t.clickToolbar(i,t.plugin.link.edit)})}),define("component/editor/plugins/image",["require","i18n!mail,common","kindEditor","../../../util/common-controls","../../../util/i18n"],function(e){e("i18n!mail,common");var t=e("kindEditor"),n=e("../../../util/common-controls"),i=e("../../../util/i18n");t.plugin("image",function(e){var t=this,a="image",r=e.undef(t.allowImageUpload,!0),s=e.undef(t.allowImageRemote,!0),o=e.undef(t.formatUploadUrl,!0),l=e.undef(t.allowFileManager,!1),c=e.undef(t.uploadJson,t.basePath+"php/upload_json.php"),d=e.undef(t.imageTabIndex,0),u=n.assetPath("style/css/editor/xt5/image/"),p=e.undef(t.extraFileUploadParams,{}),m=e.undef(t.filePostName,"imgFile"),h=e.undef(t.fillDescAfterUploadImage,!1),f=t.lang(a+".");t.plugin.imageDialog=function(n){function r(e,t){E.val(e),D.val(t),$=e,N=t}var s=(n.imageUrl,e.undef(n.imageWidth,""),e.undef(n.imageHeight,""),e.undef(n.imageTitle,""),e.undef(n.imageAlign,""),e.undef(n.showRemote,!0)),d=e.undef(n.showLocal,!0),v=e.undef(n.tabIndex,0),g=n.clickFn,b="kindeditor_upload_iframe_"+(new Date).getTime(),_=[];for(var y in p)_.push('<input type="hidden" name="'+y+'" value="'+p[y]+'" />');var w,x=['<div style="padding:10px 20px 20px 20px;">','<div class="tabs"></div>','<div class="tab1" style="display:none;">','<iframe name="'+b+'" style="display:none;"></iframe>','<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+b+'" action="'+e.addParam(c,"dir=image")+'">','<div class="ke-dialog-row">',_.join(""),'<label style="width:60px;">'+f.localUrl+"&nbsp;: </label>",'<input type="text" name="localUrl" class="ke-input-text" tabindex="-1" style="width:200px;" readonly="true" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+f.upload+'" />',"</div>","</form>","</div>",'<div class="tab2" style="display:none;">','<div class="ke-dialog-row">','<label for="remoteUrl" style="width:60px;">'+f.remoteUrl+"&nbsp;: </label>",'<input type="text" id="remoteUrl" class="ke-input-text" name="url" value="" style="width:200px;" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+f.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="remoteWidth" style="width:60px;">'+f.size+"&nbsp;: </label>",f.width+' <input type="text" id="remoteWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> px  &nbsp;&nbsp;',f.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> px ','<img class="ke-refresh-btn" src="'+u+'refresh.png" width="16" height="16" alt="" style="cursor:pointer;" title="'+f.resetSize+'" />',"</div>",'<div class="ke-dialog-row">','<label style="width:60px;">'+f.align+"&nbsp;: </label>",'<input type="radio" name="align" class="ke-inline-block" value="" checked="checked" /> <img name="defaultImg" src="'+u+'align_top.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="left" /> <img name="leftImg" src="'+u+'align_left.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="right" /> <img name="rightImg" src="'+u+'align_right.gif" width="23" height="25" alt="" />',"</div>",'<div class="ke-dialog-row">','<label for="remoteTitle" style="width:60px;">'+f.imgTitle+"&nbsp;: </label>",'<input type="text" id="remoteTitle" class="ke-input-text" name="title" value="" style="width:200px;" />',"</div>","</div>","</div>"].join(""),C=d||l?450:400,k=d&&s?300:250,S=t.createDialog({name:a,width:C,height:k,title:t.lang(a),body:x,yesBtn:{name:i.t("common/confirm"),click:function(n){if(!S.isLoading){if(d&&s&&w&&0===w.selectedIndex||!s)return""==F.fileBox.val()?void alert(i.t("mail/compose_editor_img_upload_empty")):(S.showLoading(i.t("mail/compose_editor_img_upload_ing")),F.submit(),void I.val(""));var a=e.trim(j.val()),r=E.val(),o=D.val(),l=M.val(),c="";return L.each(function(){return this.checked?(c=this.value,!1):void 0}),"http://"==a||e.invalidUrl(a)?(alert(i.t("mail/compose_editor_img_upload_invalid_url")),void j[0].focus()):/^\d*$/.test(r)?/^\d*$/.test(o)?void g.call(t,a,l,r,o,0,c):(alert(i.t("mail/compose_editor_img_upload_invalid_width")),void D[0].focus()):(alert(i.t("mail/compose_editor_img_upload_invalid_width")),void E[0].focus())}}},beforeRemove:function(){A.unbind(),E.unbind(),D.unbind(),P.unbind()}}),T=S.div,j=e('[name="url"]',T),I=e('[name="localUrl"]',T),A=e('[name="viewServer"]',T),E=e('.tab1 [name="width"]',T),D=e('.tab1 [name="height"]',T),P=e(".ke-refresh-btn",T),M=e('.tab1 [name="title"]',T),L=e('.tab1 [name="align"]',T);s&&d?(w=e.tabs({src:e(".tabs",T),afterSelect:function(e){}}),w.add({title:f.localImage,panel:e(".tab1",T)}),w.add({title:f.remoteImage,panel:e(".tab2",T)}),w.select(v)):s?e(".tab1",T).show():d&&e(".tab2",T).show();var F=e.uploadbutton({button:e(".ke-upload-button",T)[0],fieldName:m,form:e(".ke-form",T),target:b,width:60,afterUpload:function(n){if(S.hideLoading(),"S_OK"===n.code){var a=n["var"];if(a.contentType&&0!==a.contentType.indexOf("image"))return alert(i.t("mail/compose_editor_img_upload_type_error")),!1;t.afterUpload&&t.afterUpload.call(t,a);var r=a.url;o&&(r=e.formatUrl(r,"absolute")),h?(e(".ke-dialog-row #remoteUrl",T).val(r),e(".ke-tabs-li",T)[0].click(),e(".ke-refresh-btn",T).click()):g.call(t,r,n.title,n.width,n.height,n.border,n.align)}else{if("FA_FILE_SIZE_EXCEEDED"==n.code)return alert(i.t("mail/compose_editor_img_size_exceed")),!1;alert(i.t("mail/compose_editor_img_upload_fail"))}},afterError:function(e){S.hideLoading(),
t.errorDialog(e)}});F.fileBox.change(function(e){I.val(F.fileBox.val())}),l?A.click(function(n){t.loadPlugin("filemanager",function(){t.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(n,i){t.dialogs.length>1&&(e('[name="url"]',T).val(n),t.afterSelectFile&&t.afterSelectFile.call(t,n),t.hideDialog())}})})}):A.hide();var $=0,N=0;return P.click(function(t){var n=e('<img src="'+j.val()+'" />',document).css({position:"absolute",visibility:"hidden",top:0,left:"-1000px"});n.bind("load",function(){r(n.width(),n.height()),n.remove()}),e(document.body).append(n)}),E.change(function(e){$>0&&D.val(Math.round(N/$*parseInt(this.value,10)))}),D.change(function(e){N>0&&E.val(Math.round($/N*parseInt(this.value,10)))}),j.val(n.imageUrl),r(n.imageWidth,n.imageHeight),M.val(n.imageTitle),L.each(function(){return this.value===n.imageAlign?(this.checked=!0,!1):void 0}),s&&0===v&&(j.focus(),j.select()),S},t.plugin.image={edit:function(){var e=t.plugin.getSelectedImage();t.plugin.imageDialog({imageUrl:e?e.attr("data-ke-src"):"http://",imageWidth:e?e.width():"",imageHeight:e?e.height():"",imageTitle:e?e.attr("title"):"",imageAlign:e?e.attr("align"):"",showRemote:s,showLocal:r,tabIndex:e?1:d,clickFn:function(n,i,a,r,s,o){e?(e.attr("src",n),e.attr("data-ke-src",n),e.attr("width",a),e.attr("height",r),e.attr("title",i),e.attr("align",o),e.attr("alt",i)):t.exec("insertimage",n,i,a,r,s,o),setTimeout(function(){t.hideDialog().focus()},0)}})},"delete":function(){var e=t.plugin.getSelectedImage();"a"==e.parent().name&&(e=e.parent()),e.remove(),t.addBookmark()}},t.clickToolbar(a,t.plugin.image.edit)})}),define("component/editor/plugins/spellcheck",["require","kindEditor","../../../util/index","../../../module/common/globalService","jquery"],function(e){function t(e,n,i){for(var a=0;a<n.childNodes.length;a++){var r=n.childNodes[a];if(3==r.nodeType){var s=r.nodeValue;(s.search(/\w+/g)>-1&&i||!i)&&e.push(r)}else t(e,r,i)}}function n(e){for(var t=[],n="",i="",a=0;a<e.length;a++){var r=e.charAt(a);/^[0-9a-zA-Z]$/g.test(r)?(n+=r,i.length>0&&(t[t.length]=i,i="")):(i+=r,n.length>0&&(t[t.length]=n,n=""))}return n.length>0&&(t[t.length]=n),i.length>0&&(t[t.length]=i),t}function i(e){var t=p.Deferred();return e=e||{},d.xhr.simpleCall({query:{func:"user:checkSpelling",sid:u.getSid()},data:e},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function a(e){var t=p.Deferred();return d.xhr.simpleCall({query:{func:"user:addSegments",sid:u.getSid()},data:{segments:[e]}},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function r(e){for(var t=e.offsetLeft;e=e.offsetParent;)t+=e.offsetLeft;return t+10}function s(e){for(var t=e.offsetTop;e=e.offsetParent;)t+=e.offsetTop;return t+10}function o(e){e.preventDefault?(e.preventDefault(),e.stopPropagation()):(e.returnValue=!1,e.cancelBubble=!0)}function l(e,t,n){var i=this;return p("<a />",{"class":"n",href:"javascript:void(0)",text:e,cursor:m?"hand":"pointer",idx:t}).on("click",function(e){i.hideMenu(),n&&(e.preventDefault(),n(this.innerHTML))})}var c=e("kindEditor"),d=e("../../../util/index"),u=e("../../../module/common/globalService"),p=e("jquery"),m=document.all,h=5,f=function(e){this.cachedElements=[],this.spellList=[],this.ignoreWordList=[],this.$context=p("[data-panel='compose:"+e+"']")};f.prototype.clickForSpell=function(e,t){function n(n){if(t){m||o(n),i.hideMenu();var r=p(i.getEditor("iframe")),s=e.event&&e.event.srcElement?e.event.srcElement:n?n.target:window.event.srcElement;if(-1!=s.className.indexOf("CM-XT5-Spell")){var l=s.id;i.displaySpellElement("spell",s,"",l,function(e){r.find("#"+l).html(e).css({borderBottom:"",cursor:"auto"}),i.ignoreWordList.push(l)},function(){r.find("#"+l).css({borderBottom:"",cursor:"auto"}),i.ignoreWordList.push(l)},function(){r.find("#"+l).css({borderBottom:"",cursor:"auto"}),p.when(a(s.innerHTML)).then(function(){i.ignoreWordList.push(l)})})}}}var i=this;t&&p(e).on("click",n)},f.prototype.updateCacheElements=function(){var e=this,i=e.getEditor("body");e.getEditor("spellChk").remove(),this.clickForSpell(i,!1);for(var a,r=0;r<e.cachedElements.length;r++){var s=e.cachedElements[r],o=s.node,l=o.innerHTML,c=o.parentNode;if(c||(o=o.ownerDocument.getElementById(o.id),o&&(c=o.parentNode),c)){if(s.word!=l){var d=[];t(d,o,!0);for(var u=0;u<d.length;u++)for(var p=n(d[u].nodeValue),m=0;m<p.length;m++){var h=p[m];a=c.ownerDocument.createTextNode(h),c.insertBefore(a,o)}}else a=c.ownerDocument.createTextNode(l),c.insertBefore(a,o);c.removeChild(o)}}this.clearCacheElements()},f.prototype.clearCacheElements=function(){this.cachedElements=[],this.spellList=[],this.ignoreWordList=[]},f.prototype.getSubjectsById=function(e){var t=null;return p.each(this.spellList,function(n,i){return i.id==e?(t=i.suggests,!1):void 0}),t},f.prototype.hideMenu=function(){var e=this.getEditor("spellChk");e.length>0&&e.is(":visible")&&e.hide()},f.prototype.getEditor=function(e){var t;switch(e){case"iframe":t=this.$context.find(".ke-edit-iframe")[0].contentDocument;break;case"body":t=this.$context.find(".ke-edit-iframe")[0].contentDocument.body;break;case"wrapper":t=this.$context.find(".ke-container");break;case"spellChk":t=this.$context.find(".ke-container #dvSpellCheck")}return t},f.prototype.displaySpellElement=function(e,t,n,i,a,o,c){var u=this,m=u.getEditor("wrapper"),f=u.getEditor("spellChk"),v=u.getSubjectsById(i);if(u.hideMenu(),!(u.ignoreWordList.indexOf(i)>-1)){if("spell"==e){f.length>0&&f.remove();var g=p("<div/>",{id:"dvSpellCheck"}).css({position:"absolute"}).append(p("<div/>",{html:'<div id="list"></div>'}).css({padding:"1px",background:"#fff",border:"1px solid #838383",width:"100px","box-shadow":"2px 2px 3px #CCC","border-radius":"3px 3px 3px 3px"}));if(v&&v.length>0)for(var b=0;b<v.length&&h>b;b++){var _=v[b],y=l.call(u,_,b,a);g.find("#list").append(y)}else{var w=p("<div/>",{"class":"no-suggestion",text:d.i18n.t("mail/no_suggestions")});g.find("#list").append(w)}var x=p("<div />",{"class":"separator"});if(g.find("#list").append(x),!v)return;var C=l.call(u,d.i18n.t("mail/ignore"),v.length,o);g.find("#list").append(C);var k=l.call(u,d.i18n.t("mail/addToDict"),v.length+1,c);g.find("#list").append(k),m.append(g),e="dvSpellCheck"}if("string"==typeof e){e=m.find("#dvSpellCheck");var S,T,j=r(t),I=s(t),A=e[0].clientHeight,E=u.getEditor("body").scrollTop,D=u.getEditor("body").clientHeight;return T=I-E,S=A+T>D?T-A:T+t.offsetHeight,e.css({left:j+"px",top:S+"px",display:n}),!0}}},f.prototype.doBeforeCheckSpelling=function(){var e,i,a,r,s=this,o=s.getEditor("body"),l=[],c=[];s.clickForSpell(o,!0),t(l,o,!0);for(var d=0;d<l.length;d++)if(e=l[d],i=e.parentNode,a=e.nodeValue,0!=a.trim()&&null!=i){r=n(a);for(var u=0;u<r.length;u++){var p=r[u];if(p.length>0)if(p.search(/\w/g)>-1){for(var m=Math.floor(1e3*Math.random());-1!=c.indexOf(m);)m=Math.floor(1e3*Math.random());c[c.length]=m;var h=(new Date).getTime()+"-"+m,f=i.ownerDocument.createElement("SPAN");f.className="CM-XT5-Spell "+h,f.id=h,f.innerHTML=p,i.insertBefore(f,e),s.cachedElements[s.cachedElements.length]={name:h,word:p,node:f,highlight:!1}}else{var v=i.ownerDocument.createTextNode(p);i.insertBefore(v,e)}}i.removeChild(e)}},f.prototype.checkSpelling=function(e){var n=this;n.doBeforeCheckSpelling(),p.when(i({isHtml:!0,text:e})).then(function(e){if(0==e[0].segments.length)return void n.updateCacheElements();var i,a,r,s=e[0].segments,o={};p.each(e[0].segments,function(e,t){var n=t.segment;o[n]||(o[n]=1)});for(var l=0,c=s.length;c>l;l++){var d=s[l],u=d.segment;if(o[u]){var m=d.suggests;for(i=0;i<n.cachedElements.length;i++)if(a=n.cachedElements[i],a.word==u){a.highlight=!0,r=a.node,r.style.cursor=document.all?"hand":"pointer",r.style.borderBottom="2px dotted red";var h={id:r.id,suggests:m};n.spellList.push(h)}}}var f=[];for(i=0;i<n.cachedElements.length;i++)if(a=n.cachedElements[i],a.highlight)f.push(a);else{r=a.node;var v=r.parentNode;if(v)try{var g="",b=[];t(r,b,!1);for(var _=v.ownerDocument.createTextNode(""),y=0;y<b.length;y++)g+=b[y].nodeValue;_.nodeValue=g,v.insertBefore(_,r),v.removeChild(r),a.node=_}catch(w){f.push(a)}}n.cachedElements=f})},c.plugin("spellcheck",function(){var e=this;e.scObj&&e.scObj instanceof f||(e.scObj=new f(e.composeId)),this.clickToolbar("spellcheck",function(){e.scObj.checkSpelling(e.html())})}),c.plugin("spellrecheck",function(){var e=this;this.clickToolbar("spellrecheck",function(){e.scObj.updateCacheElements(),e.scObj.checkSpelling(e.html())})}),c.plugin("finishcheck",function(){var e=this;this.clickToolbar("finishcheck",function(){e.scObj.updateCacheElements()})})}),define("component/editor/lang",["require","kindEditor","../../util/common-controls","../../module/common/globalService"],function(e){var t=e("kindEditor"),n=e("../../util/common-controls"),i=e("../../module/common/globalService"),a="zh_CN"==i.getConfig("context.locale")?"zh_CN":"en",r=n.componentsPath("kindeditor/lang/")+a+".js";t.loadScript(r)}),define("component/editor/editor",["require","./plugins/toolbar","./plugins/link","./plugins/image","./plugins/spellcheck","./lang","jquery","kindEditor","../../util/common-controls","../../module/common/globalService"],function(e){e("./plugins/toolbar"),e("./plugins/link"),e("./plugins/image"),e("./plugins/spellcheck"),e("./lang");var t=e("jquery"),n=e("kindEditor"),i=e("../../util/common-controls"),a=e("../../module/common/globalService"),r="zh_CN"==a.getConfig("context.locale")?"zh_CN":"en";t.extend(n.options,{filterMode:!1,resizeType:0,basePath:i.componentsPath("kindeditor/"),pluginsPath:i.componentsPath("kindeditor/plugins/"),themeType:"xt5",themesPath:i.assetPath("style/css/editor/"),cssPath:i.assetPath("style/css/editor/iframe/iframe.css"),minWidth:200,minHeight:100,items:["bold","italic","underline","fontname","fontsize","forecolor","hilitecolor","|","lineheight","plug-align","plug-order","plug-indent"],allowFlashUpload:!1,allowMediaUpload:!1,allowFileManager:!1,langType:r,minChangeSize:500,afterCreate:function(){this.statusbar.hide()}});var s=n.create;return n.create=function(e,i){return s(e,t.extend({},n.options,i))},n}),define("component/fileupload/pasteUploadUtil",["require","./attachupload-ui","jquery","../../module/common/globalService","../../util/index","../confirmbox"],function(e){function t(e){for(var t="jpg,png,gif,bmp,jpeg",n=[],i=0;i<e.length;i++)if(e[i].length>0){var a=e[i].substring(e[i].lastIndexOf(".")+1,e[i].length);-1!==t.indexOf(a.toLowerCase())&&n.push(e[i])}return n}function n(e,t,n,i,a){if("native"==t)for(var r=0;r<n.length;r++)e.insertHtml('<img src="'+n[r].previewUrl+'" >');else if("office"==t)for(var s=0;s<n.length;s++)for(var o=n[s].name,l=i[o],c=0;c<l.length;c++)d(e.edit.doc).find(".pasteUpload_"+a+"_"+l[c]).each(function(){0==d(this).attr("src").length&&(d(this).attr("src",n[s].previewUrl),d(this).attr("data-ke-src",n[s].previewUrl))})}function i(e,t){var i=[],a=e.attachupload("getScreenClipboard");for(var r in a)isNaN(a[r])||i.push(a[r]);e.attachupload("pluginAdd",i,{inlined:!0}).off("attachuploadcompleted.screenClipboardUpload").on("attachuploadcompleted.screenClipboardUpload",function(e,a){d.each(i,function(e,i){return i==a.index&&a.files[0].inlined?(n(t,"native",[a.files[0]]),a.context.remove(),!1):void 0})})}function a(e){var t=navigator.userAgent.toLowerCase();t.match(/firefox\/([\d.]+)/)&&setTimeout(function(){d(e.edit.doc).find("img").each(function(){-1!==d(this).attr("src").indexOf("base64")&&d(this).remove()})},1)}function r(e,r,s){if(s.attachupload("supportEmbeddedFile")){var o=s.attachupload("getPathFileClipboard");if(o.length>0){a(r);var l=o.split(";"),c=t(l);if(c.length>0){for(var u=[],p=null,m=0;m<c.length;m++)if(p=s.attachupload("getUploadFileByName",c[m]))n(r,"native",[p]);else{var h=e.addEmbbedFile(c[m]);"ffffffff"!=Number(h).toString(16)&&u.push(h)}u.length>0&&s.attachupload("pluginAdd",u,{inlined:!0}).off("attachuploadcompleted.nativeUpload").on("attachuploadcompleted.nativeUpload",function(e,t){d.each(u,function(e,i){return i==t.index&&t.files[0].inlined?(n(r,"native",[t.files[0]]),t.context.remove(),!1):void 0})})}}else 0===s.attachupload("getHTMLClipboard").length&&(a(r),i(s,r))}}function s(e,i,a,r,s,l){if(a.attachupload("supportEmbeddedFile")){var c=a.attachupload("getHTMLClipboard");if(-1!==c.indexOf("file:///")){var u=navigator.userAgent.indexOf("MSIE 8.0")>0&&r%2===0;if(u)return!1;for(var p=null,m=null,h=null,f=[],v=null,g={},b=0,_=/<!--\[if gte vml 1\]>([\s\S]*?)<!\[endif\]>/g,y=/<!\[if !vml\]>([\s\S]*?)<!\[endif\]>/g,w=/<!--\[if !mso & vml\]>([\s\S]*?)<!\[endif\]-->/g,x=/(?:<v\:imagedata\s[^>]*src=(?:['"]?)(\S[^'"\ ]+)(?:['"]?[^>]+)(?:(?:(?:\/>){1})|(?:[>]{1})))/gi,C=/(?:<img\s[^>]*src=(?:['"]?)(\S[^'"\ ]+)(?:['"]?[^>]+)(?:(?:(?:\/>){1})|(?:[>]{1})))/gi;null!=(p=_.exec(c));)f.push(p);if(0!==f.length)for(var k=0;k<f.length;k++){p=null,x.lastIndex=0;var S="<img class='pasteUpload_"+r+"_"+b+"' src=''/>";if(null!=(m=y.exec(f[k][0]))){if(-1===m[1].indexOf("table"))S=m[1],null!=(h=C.exec(m[1]))&&(S=S.replace(h[1],'" class="pasteUpload_'+r+"_"+b),C.lastIndex=0);else for(var T="";null!=(T=w.exec(c));)c=c.replace(T[0],"");y.lastIndex=0}c=c.replace(f[k][0],S),null!=(p=x.exec(f[k][0]))&&p[1]&&0===p[1].indexOf("file:///")&&(v=p[1].substring("file:///".length,p[1].length),0!==t([v]).length&&(g[v]?g[v].push(b++):g[v]=[b++]))}else if(c.indexOf("<v:imagedata")>0){for(;null!=(p=x.exec(c));)if(p[1]&&0===p[1].indexOf("file:///")){var j="<img class='pasteUpload_"+r+"_"+b+"' src=''/>";v=p[1].substring("file:///".length,p[1].length),0!==t([v]).length&&(g[v]?g[v].push(b++):g[v]=[b++]),c=c.replace(p[0],j)}}else for(;null!=(p=C.exec(c));)if(p[1]&&0===p[1].indexOf("file:///")){var I="<img class='pasteUpload_"+r+"_"+b+"' src=''/>";v=p[1].substring("file:///".length,p[1].length),0!==t([v]).length&&(g[v]?g[v].push(b++):g[v]=[b++]),c=c.replace(p[0],I)}i.insertHtml(c),i.insertHtml("<br/>");var A=[];for(var E in g)if(g.hasOwnProperty(E)){var D=a.attachupload("getUploadFileByName",E);if(D)n(i,"office",[D],g,r);else{var P=e.addEmbbedFile(E);"ffffffff"!=Number(P).toString(16)&&A.push(P)}}return A.length>0&&a.attachupload("pluginAdd",A,{inlined:!0}).off("attachuploadcompleted.officeUpload").on("attachuploadcompleted.officeUpload",function(e,t){d.each(A,function(e,s){return s==t.index&&t.files[0].inlined?(n(i,"office",[t.files[0]],g,r),a.attachupload("removeUploadFileByName",t.files[0].name),t.context.remove(),!1):void 0})}),!1}}else o(s,l,i);return!0}function o(e,t,n){function i(e,i){var r=new FileReader;r.readAsDataURL(i),r.onload=function(){var t=r.result;-1!==t.indexOf("base64")&&l(n,e,a(t))},c(t)}function a(e){for(var t,n=e.split("data:")[1].split(";base64,")[0],i=e.split("base64,")[1],a=atob(i),r=new ArrayBuffer(a.length),s=new Uint8Array(r),o=0;o<a.length;o++)s[o]=a.charCodeAt(o);return t=new Blob([s],{type:n})}if(t.originalEvent&&t.originalEvent.clipboardData){var r=t.originalEvent.clipboardData.items;r||setTimeout(function(){for(var t=n.edit.doc.getElementsByTagName("img"),i=t.length-1;i>=0;i--){var r=t[i];-1!==r.src.indexOf("base64")&&l(n,e,a(r.src),r),-1!==r.src.indexOf("webkit-fake-url://")&&d(r).remove()}},1)}else if(window.clipboardData)for(var s=window.clipboardData.files||[],o=0;o<s.length;o++)c(t),i(e,s[o])}function l(e,t,i,a){var r=u.getSid(),s=new FormData,o=(new Date).getTime()+"."+i.type.split("/")[1];s.append("file",i,o),d.ajax({type:"post",url:p.xhr.getFullRequestURL({url:"XT5/jsp/upload.jsp",query:{func:"directData",sid:r,composeId:t,inlined:!0,dir:"image",contentType:i.type}}),data:s,processData:!1,contentType:!1,success:function(i){i=JSON.parse(i);var s=i.code;if("S_OK"===s){var o=i["var"]||{},l=p.xhr.getFullRequestURL({url:"s/json",query:{func:"mbox:getComposeData",sid:r,composeId:t,attachId:o.attachmentId}});a?d(a).attr("src",l).attr("data-ke-src",l):n(e,"native",[{previewUrl:l}])}else"FA_UPLOAD_SIZE_EXCEEDED"===s?(a&&d(a).remove(),m.alert(p.i18n.t("mail/FA_UPLOAD_SIZE_EXCEEDED"))):"FA_COMPOSE_NOT_FOUND"===s?(a&&d(a).remove(),m.alert(p.i18n.t("mail/FA_ID_NOT_FOUND"))):"FA_DATA_CORRUPT"===s&&(a&&d(a).remove(),m.alert(p.i18n.t("mail/FA_DATA_CORRUPT")))}})}function c(e){e.preventDefault?(e.preventDefault(),e.stopPropagation()):(e.returnValue=!1,e.cancelBubble=!0)}e("./attachupload-ui");var d=e("jquery"),u=e("../../module/common/globalService"),p=e("../../util/index"),m=e("../confirmbox");return{handleEditorNativeImage:r,handlePaste:s}}),define("module/mail/compose/service",["require","exports","module","jquery.iframeTransport","../../common/globalService","../service","../../../util/index","moment","jquery"],function(e,t){function n(e){var t,n,a=f.Deferred(),r=u.getUser(),s=u.getConfig("user.allemails")||[],o=u.getConfig("setting.enableforcesendername"),c=m.securityLevel.getSenderSecurityLevel(),d={};return e=e||{},n=1!==r.displaysender,o&&(r.true_name=s[0]?s[0].name:""),f.each(s,function(e,t){t.email=n&&t.name?'"'+t.name.replace(/\"/g,'\\"')+'" <'+t.addr+">":t.addr}),d={accounts:s.length>1?s:[],from:n&&r.true_name?'"'+r.true_name.replace(/\"/g,'\\"')+'" <'+r.email+">":r.email,senderSecurityLevel:c},e.mid||e.id?(t=p.getComposeInfo(f.extend(e,{returnInfo:!0})),e.mid&&(d.draftId=e.mid)):t=i({onlyVar:!0}),t.then(function(t){"string"===f.type(t)?d.composeId=t:f.extend(d,t,{composeId:t.id,from:t.account}),f.extend(d,l(e)),a.resolve(d)},function(e){a.reject(e)}),a}function i(e){var t,n,i,a,r=f.Deferred();if(e=f.extend({attrs:{}},e),t="boolean"==typeof e.onlyVar?e.onlyVar:!1,delete e.onlyVar,f.each(e,function(t){0===t.indexOf("_")&&delete e[t]}),f.each(e.attrs,function(t){0===t.indexOf("_")&&delete e.attrs[t]}),e.attrs.hasOwnProperty("encryptPassword")&&(e.encryptPassword=e.attrs.encryptPassword,delete e.attrs.encryptPassword),e.attrs.hasOwnProperty("savePassword")&&(e.savePassword=e.attrs.savePassword,delete e.attrs.savePassword),e.attrs.lettercontent){if(i=m.detector.supportAjaxUpload(),n=f.extend({uploadMode:"preEncodedData",returnInfo:!0},e.attrs),a={url:m.xhr.getFullRequestURL({url:"/XT5/jsp/mformdata.jsp",query:{func:"mbox:composeF",sid:u.getSid(),uploadMode:"preEncodedData"}}),type:"post",processData:!1,contentType:!1},i){var s=new FormData;f.each(n,function(e,t){s.append(e,t)}),a.data=s}else f.extend(a,{data:n,useiframe:!0,forceIframeTransport:!0});return f.ajax(a).complete(function(e){var t=JSON.parse(e.responseText);t.other&&(f.extend(t,t.other),delete t.other),"S_OK"===t.code?r.resolve(t):r.reject(t)}).fail(function(){r.reject()}),r.promise()}return m.xhr.simpleCall({query:{func:"mbox:compose",sid:u.getSid(),isUserConfirmed:!0},data:e,onlyVar:t},function(e){r.resolve(e)},function(e,t,n){r.reject(n)}),r.promise()}function a(e){var t=f.Deferred();return e=e||{},m.params.isValid(e,"mid")&&m.params.isValid(e,"bcc")?(m.xhr.simpleCall({query:{func:"mbox:forwardMessages",sid:u.getSid()},data:{mboxa:e.mboxa||"",ids:"array"===f.type(e.mid)?e.mid:[e.mid],mode:"transmit",attrs:{bcc:"array"===f.type(e.bcc)?e.bcc:[e.bcc]}}},function(){t.resolve()},function(){t.reject()}),t.promise()):t.reject()}function r(e){var t=f.Deferred();return e=e||{},e.ids="array"===f.type(e.ids)?e.ids:[e.ids],e.deleteDraft="boolean"===f.type(e.deleteDraft)?e.deleteDraft:!1,m.xhr.simpleCall({query:{func:"mbox:cancelComposes",sid:u.getSid()},data:e},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function s(e){var t=f.Deferred(),n=c(e);return m.xhr.simpleCall({query:{func:"pab:getDefaultKeyByEmails",sid:u.getSid()},data:{emails:n}},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function o(e){var t=f.Deferred();return e=e||{},m.xhr.simpleCall({query:{func:"user:authenticateSmimeKeyPass",sid:u.getSid()},data:e},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function l(e){var t=u.getUser(),n={};return e.to&&(n.to="array"===f.type(e.to)?e.to.join(","):e.to,n.formatTo=n.to),e.cc&&(n.cc="array"===f.type(e.cc)?e.cc.join(","):e.cc,n.formatCc=n.cc),e.bcc&&(n.bcc="array"===f.type(e.bcc)?e.bcc.join(","):e.bcc,n.formatBcc=n.bcc),e.subject&&(n.subject=e.subject),e.attachments&&(n.attachments="array"===f.type(e.attachments)?e.attachments:[e.attachments]),e.scheduledate&&(n.scheduledate=h(e.scheduledate).toDate()),n.defaultAccount=e.defaultAccount||t.default_sender_address||t.email||"",n}function c(e){var t=[];return f.each(e._contacts,function(e,n){m.Email.test(n.addr)&&-1===t.indexOf(n.addr)&&t.push(n.addr)}),t}function d(e){var t=f.Deferred();return e=e||{},f.ajax({type:"post",url:m.xhr.getFullRequestURL({query:{func:"mbox:uploadAttach",sid:u.getSid(),composeId:e.composeId}}),data:e.data,processData:!1,contentType:!1}).complete(function(e){t.resolve(e)}).fail(function(){t.reject()}),t.promise()}e("jquery.iframeTransport");var u=e("../../common/globalService"),p=e("../service"),m=e("../../../util/index"),h=e("moment"),f=e("jquery");t.getInitComposeInfo=n,t.sendMail=i,t.directForward=a,t.cancelCompose=r,t.getReceiverCerts=s,t.authenticateSmimeKeyPass=o,t.uploadDectyptedFile=d}),define("module/setting/account/signature/service",["require","jquery","../../../../util/index","module/common/globalService"],function(e){function t(e){e="boolean"===o.type(e)?e:!1;var t=o.Deferred();return d.length>0&&e?t.resolve(d):l.xhr.simpleCall({contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:l.xhr.getRequestURL({url:"/XT5/jsp/setting.jsp",query:{func:"user:getAllSignature",sid:c.getSid()}}),preprocess:!1},function(e){d=e,t.resolve(e)}),t.promise()}function n(e){var t=o.Deferred();return l.xhr.simpleCall({query:{func:"user:deleteSignatures",sid:c.getSid()},data:{ids:[e]}},function(){d=o.grep(d,function(t){return t.id!=e}),t.resolve(d)},function(){t.reject()}),t.promise()}function i(e){var t=o.Deferred();return l.xhr.simpleCall({query:{func:"user:updateSignatures",sid:c.getSid()},data:{items:[e]}},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function a(e){var t=o.Deferred();return l.xhr.simpleCall({query:{func:"user:createSignatures",sid:c.getSid()},data:{items:[e]}},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function r(){var e=o.Deferred();return l.xhr.simpleCall({query:{func:"user:getSignImageSpareSize",sid:c.getSid()}},function(t){e.resolve(t)},function(){e.reject()}),e.promise()}function s(){var e=o.Deferred();return l.xhr.simpleCall({query:{func:"user:clearUnReferencedImages",sid:c.getSid()}},function(t){e.resolve(t)},function(){e.reject()}),e.promise()}var o=e("jquery"),l=e("../../../../util/index"),c=e("module/common/globalService"),d=[];return{getSignatures:t,deleteSignature:n,updateSignature:i,createSignature:a,getSignImageSpareSize:r,clearUnReferredImage:s}}),define("components/requirejs-text/text!component/../../template/component/filelistbox.tpl.html",[],function(){return'<!--   -->\r\n<div class="u-filelistbox-wrap">\r\n\r\n  {{#raw}}\r\n  <script type=\'x-handlebars-template\' id=\'filelistTpl\'>\r\n    <div class="c-filebox-content j-filebox-content-warp">\r\n      <div class="c-filebox-tab j-filebox-tab">\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type=\'x-handlebars-template\' id=\'forbiddenTpl\'>\r\n    [[[ i18n "file/msg_filebox_forbidden" ]]]\r\n  </script>\r\n\r\n  <script type=\'x-handlebars-template\' id=\'blankTpl\' data-container=\'.c-filebox-tab\'>\r\n    [[[ i18n "file/msg_filebox_nonexist" ]]]\r\n  </script>\r\n\r\n  <script type="x-handlebars-template" id="utabTpl" data-container=\'.c-filebox-tab\'>\r\n    <div class="u-tab u-tab-highlight-down">\r\n      <ul data-role="nav">\r\n        [[#if transitcenter]]\r\n        <li data-role="trigger" data-type="transitcenter" >\r\n          <span class="bar"></span>\r\n          <a href="javascript:void(0);" >{{ i18n "main/appname_BNF" }}</a>\r\n        </li>\r\n        [[/if]]\r\n        [[#if personalnf]]\r\n        <li data-role="trigger" data-type="personalnf" >\r\n          <span class="bar"></span>\r\n          <a href="javascript:void(0);">{{ i18n "main/appname_NF" }}</a>\r\n        </li>\r\n        [[/if]]\r\n        [[#if enterprisenf]]\r\n        <li data-role="trigger" data-type="enterprisenf" >\r\n          <span class="bar"></span>\r\n          <a href="javascript:void(0);" >{{ i18n "main/appname_ENF" }}</a>\r\n        </li>\r\n        [[/if]]\r\n        [[#if accessory]]\r\n        <li data-role="trigger" data-type="accessory" >\r\n          <span class="bar"></span>\r\n          <a href="javascript:void(0);" >{{ i18n "file/lbl_accessory_dealings" }}</a>\r\n        </li>\r\n        [[/if]]\r\n      </ul>\r\n    </div>\r\n    <div class="u-tab-content u-scroll" data-role="content">\r\n      [[#if transitcenter]]\r\n      <div class="f-dn" data-type="transitcenter" data-role="panel">{{{ i18n "file/msg_filebox_loading" }}}</div>\r\n      [[/if]]\r\n      [[#if personalnf]]\r\n      <div class="f-dn" data-type="personalnf" data-role="panel">{{{ i18n "file/msg_filebox_loading" }}}</div>\r\n      [[/if]]\r\n      [[#if enterprisenf]]\r\n      <div class="f-dn" data-type="enterprisenf" data-role="panel">{{{ i18n "file/msg_filebox_loading" }}}</div>\r\n      [[/if]]\r\n      [[#if accessory]]\r\n      <div class="f-dn" data-type="accessory" data-role="panel">{{{ i18n "file/msg_filebox_loading" }}}</div>\r\n      [[/if]]\r\n    </div>\r\n  </script>\r\n\r\n  <script type="x-handlebars-template" id="accessoryTpl">\r\n    <div class="c-filebox-list onlyFile accessory-list j-filelist u-scroll">\r\n      <table class="u-table u-table-row">\r\n        <tbody>\r\n        </tbody>\r\n      </table>\r\n      <div class="j-file-list-tip"></div>\r\n      <div class="c-filebox-list-func j-filelist-func">\r\n        <div class="loading">{{{ i18n "file/msg_filebox_loading" }}}</div>\r\n        <div class="page">\r\n          <div class="u-page u-page-round">\r\n            <a class="u-page-prev z-current" rel="prev"><span class="iconfont iconprevious"></span></a>\r\n            <a class="u-page-next z-current" rel="next"><span class="iconfont iconnext"></span></a>\r\n          </div>\r\n        </div>\r\n        <div class="retry"></div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="x-handlebars-template" id="accessoryItemTpl">\r\n    [[#each fileList]]\r\n    <tr class="file-item"\r\n        data-accid="[[ this.id ]]"\r\n        data-accpartid="[[ this.partId ]]"\r\n        data-contenttype="[[ this.contentType ]]"\r\n        data-size="[[ this.attsize ]]"\r\n        data-name="[[ this.attn ]]">\r\n      <td class="col-chk">\r\n                <span>\r\n                  <input type="checkbox" class="u-input j-item-chk" />\r\n                </span>\r\n      </td>\r\n      <td class="col-name">\r\n        <i class="file-small-icon [[ GetFileIco this.attn \'icon-small-\' ]]"></i>\r\n        <span>[[this.attn]]</span>\r\n      </td>\r\n      [[#if ../enableSecurityLevel]]\r\n        <td class="col-date">[[ DepartSLFromName this.attn ]]</td>\r\n      [[/if]]\r\n      <td class="col-date">[[ GetDateMD this.sentDate ]]</td>\r\n    </tr>\r\n    [[/each]]\r\n  </script>\r\n\r\n  <script type="x-handlebars-template" id="transitcenterListTpl" data-container=\'.u-tab-content [data-type="transitcenter"]\'>\r\n    <div class="c-filebox-list onlyFile j-filelist">\r\n      <table class="u-table u-table-row">\r\n        <tbody>\r\n        [[#each fileList]]\r\n        <tr class="file-item"\r\n            data-id="[[ this.id ]]"\r\n            data-fid="[[ this.fid ]]"\r\n            data-size="[[ this.size ]]"\r\n            data-name="[[ this.name ]]"\r\n            data-contenttype="[[ this.contentType ]]"\r\n            data-securitylevel="[[#if ../enableSecurityLevel]][[ this.misc.securityLevel ]][[/if]]">\r\n          <td class="col-chk">\r\n                <span>\r\n                  <input type="checkbox" class="u-input j-item-chk" />\r\n                </span>\r\n          </td>\r\n          <td class="col-name">\r\n            <i class="file-small-icon [[ GetFileIco this.name \'icon-small-\' ]]"></i>\r\n            <span>[[this.name]]</span>\r\n          </td>\r\n          [[#if ../enableSecurityLevel]]\r\n          <td class="col-securityLevel">\r\n            [[ TranslateSL this.misc.securityLevel ]]\r\n          </td>\r\n          [[/if]]\r\n          <td class="col-date">\r\n            [[#if this.misc.remaintime ]]\r\n            [[ GetRemainDH this.misc.remaintime ]]\r\n            [[else]]\r\n            [[ GetDateMD this.creationDate ]]\r\n            [[/if]]\r\n          </td>\r\n        </tr>\r\n        [[/each]]\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n  </script>\r\n  <script type="x-handlebars-template" id="nfListTpl">\r\n    <ul class="c-filebox-crumb u-crumb">\r\n      <li>[[ i18n "nf/bf_path" ]]&nbsp;</li>\r\n\r\n      <li class="j-hiddenPath f-dn">\r\n        <a href="javascript:void(0);" data-action="enterFolder" title="">..</a>\r\n      </li>\r\n\r\n      [[#each parentFolders]]\r\n      <li class="j-parentPath" data-fid="[[this.fid]]">\r\n        [[#unless this.isRoot]]\r\n        <i>&gt;</i>\r\n        [[/unless]]\r\n        <a href="javascript:void(0);" data-action="enterFolder" data-fid="[[this.fid]]">\r\n          [[#if this.isRoot]]\r\n          [[#if ../../isEnf ]]\r\n          [[ i18n "main/efdr_root" ]]\r\n          [[else]]\r\n          [[ i18n "main/pfdr_root" ]]\r\n          [[/if]]\r\n          [[else]]\r\n          [[this.name]]\r\n          [[/if]]\r\n        </a>\r\n      </li>\r\n      [[/each]]\r\n\r\n      <li>\r\n        [[#if folderInfo.isRoot ]]\r\n          [[#if ../isEnf ]]\r\n            [[ i18n "main/efdr_root" ]]\r\n          [[else]]\r\n            [[ i18n "main/pfdr_root" ]]\r\n          [[/if]]\r\n        [[else]]\r\n          <i>&gt;</i>\r\n          [[folderInfo.name]]\r\n        [[/if]]\r\n      </li>\r\n\r\n    </ul>\r\n    [[#if isBlank]]\r\n    [[[ blankMsg ]]]\r\n    [[else]]\r\n    <div class="c-filebox-list j-filelist">\r\n      <table class="u-table u-table-row">\r\n        <tbody>\r\n        [[#each subFolders]]\r\n        <tr class="file-item">\r\n          <td class="col-chk">\r\n          </td>\r\n          <td class="col-name">\r\n            <i class="file-small-icon icon-small-folder"></i>\r\n            <a href="javascript:void(0);" data-action="enterFolder" data-fid="[[ this.id ]]">[[this.name]]</a>\r\n          </td>\r\n          [[#if ../enableSecurityLevel]]\r\n            <td class="col-securityLevel"></td>\r\n          [[/if]]\r\n          <td class="col-date"></td>\r\n        </tr>\r\n        [[/each]]\r\n        [[#each nfFiles]]\r\n        <tr class="file-item"\r\n            data-id="[[ this.id ]]"\r\n            data-fid="[[ this.fid ]]"\r\n            data-size="[[ this.size ]]"\r\n            data-name="[[ this.name ]]"\r\n            data-contenttype="[[ this.contentType ]]"\r\n            data-securitylevel="[[#if ../enableSecurityLevel]][[ this.misc.securityLevel ]][[/if]]">\r\n          <td class="col-chk">\r\n                <span>\r\n                  <input type="checkbox" class="u-input j-item-chk" />\r\n                </span>\r\n          </td>\r\n          <td class="col-name">\r\n            <i class="file-small-icon [[ GetFileIco this.name \'icon-small-\' ]]"></i>\r\n            <span>[[this.name]]</span>\r\n          </td>\r\n          [[#if ../enableSecurityLevel]]\r\n            <td class="col-securityLevel">[[ TranslateSL this.misc.securityLevel ]]</td>\r\n          [[/if]]\r\n          <td class="col-date">[[ GetDateMD this.creationDate ]]</td>\r\n        </tr>\r\n        [[/each]]\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n    [[/if]]\r\n  </script>\r\n  {{/raw}}\r\n\r\n</div>'}),define("component/filelistbox",["require","i18n!main,file,common,mbox,nf","text!../../template/component/filelistbox.tpl.html","jquery","moment","handlebars","cui/ui/dialog/confirmbox","cui/ui/switchable/tabs","cui/util/templatable/templatable","cui/core/events/pubsub","cui/core/events/events","cui/core/view/view","../util/index","../module/common/globalService","../module/file/fileService","../util/file","./userauth2"],function(e){function t(e){if(!e||!e.widget.tabs)return[];
var t=e.widget.tabs.$("[data-role=panel]:visible"),n=t.find('.j-filelist input.j-item-chk[type="checkbox"]:checked');return n}e("i18n!main,file,common,mbox,nf");var n=e("text!../../template/component/filelistbox.tpl.html"),i=e("jquery"),a=e("moment"),r=e("handlebars"),s=e("cui/ui/dialog/confirmbox"),o=e("cui/ui/switchable/tabs"),l=e("cui/util/templatable/templatable"),c=e("cui/core/events/pubsub"),d=e("cui/core/events/events"),u=e("cui/core/view/view"),p=e("../util/index"),m=e("../module/common/globalService"),h=e("../module/file/fileService"),f=e("../util/file"),v=e("./userauth2"),g=i(r.compile(n)({})),b=new d,_={selectNumUpdate:"selectNumUpdate"},y=u.extend({Implements:l,attrs:{template:g.find("#accessoryTpl").html(),fileItemTpl:g.find("#accessoryItemTpl").html(),current:0,limit:10,total:0,interval:3,api:h.getAccList,scrollTimer:0},events:{"click .j-filelist-func .page a":"_handlePageChange"},render:function(){y.superclass.render.call(this),this.$tip=this.$(".j-file-list-tip"),this.$func=this.$(".j-filelist-func"),this.$table=this.$(".u-table"),this.$tbody=this.$table.find("tbody"),this._fetchData()},destroy:function(){y.superclass.destroy.call(this)},_initScrollEvent:function(){this.element.on("scroll",i.proxy(this._handleWrapScroll,this))},_offScrollEvent:function(){this.element.off("scroll")},_handleWrapScroll:function(e,t){var n=this;clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout(function(){var t=i(e.currentTarget);t[0].scrollHeight-t.scrollTop()-t.outerHeight()<20&&(n._offScrollEvent(),n._handleScrollToBt())},300)},_handlePageChange:function(e,t){var n,a=i(e.currentTarget),r=a.attr("href");e.preventDefault(),""!=r&&(n=parseInt(r.slice(1)),this.$tbody.empty(),this.set("current",n),b.trigger(_.selectNumUpdate))},_onChangeCurrent:function(e,t){this._fetchData()},_handleScrollToBt:function(){var e=this.get("current"),t=this.get("total"),n=this.get("limit"),i=this.get("interval");t>(e+1)*n&&(e+1)%i>0&&this.set("current",e+1)},_fetchData:function(){var e=this,t={start:this.get("current")*this.get("limit"),limit:this.get("limit"),returnTotal:!0};this._toggleListTool(!0,!1,!1),i.when(this.get("api")(t)).then(function(t){var n=t["var"];e._toggleListTool(),e.set("total",t.total),e._renderData(null,{fileList:n,enableSecurityLevel:m.getConfig("user.enablesecuritylevel")})})},_renderData:function(e,t){var n,a=this,r=p.i18n.t("file/msg_list_att_blank"),s=p.i18n.t("file/msg_list_att_fail"),o=this.get("current"),l=this.get("total"),c=this.get("limit"),d=this.get("interval");e?(n=i(s),this.$tip.html(n)):t.fileList.length<=0?(n=i(r),this.$tip.html(n)):(n=i(a.compile(this.get("fileItemTpl"),t)).customRadioCheckbox(),this.$tbody.append(n).end(),this._toggleListTool(),(o+1)*c>=l?o+1>d&&(this._toggleListTool(!1,!0,!1),this._toggleListToolPage(Math.max(0,o-o%d-d),!1)):(o+1)%d==0?(this._toggleListTool(!1,!0,!1),this._toggleListToolPage(o+1-2*d,o+1)):this._initScrollEvent())},_toggleListTool:function(e,t,n){var i="f-dn",a="f-dbi";e||t||n?this.$func.removeClass(i):this.$func.addClass(i),e?this.$func.find(".loading").addClass(a):this.$func.find(".loading").removeClass(a),t?this.$func.find(".page").addClass(a):this.$func.find(".page").removeClass(a),n?this.$func.find(".retry").addClass(a):this.$func.find(".retry").removeClass(a)},_toggleListToolPage:function(e,t){var n=this.$func.find(".page .u-page"),i="number"==typeof e&&e>=0,a="number"==typeof t&&t>=0,r="z-current";i?n.find("[rel=prev]").removeClass(r).attr("href","#"+e):n.find("[rel=prev]").addClass(r).attr("href",""),a?n.find("[rel=next]").removeClass(r).attr("href","#"+t):n.find("[rel=next]").addClass(r).attr("href","")},templateHelpers:{GetDateMD:function(e){return e?new r.SafeString(a(e).format("MM-DD")):void 0},GetFileIco:function(e,t){return e&&t?t+f.formatFileType(e):""},DepartSLFromName:function(e){return p.securityLevel.departSLFromFilename(e)}}}),w=s.extend({Implements:l,widget:{tabs:null},pubSub:null,authority:{transitcenter:!0,personalnf:!0,enterprisenf:!0,accessory:!0},attrs:{isShare:!1,fileType:"",title:"",closeTpl:'<i class="iconfont icontabclose"></i>',confirmTpl:"",cancelTpl:"",message:"",$selectedSum:null},events:{"click [data-role=close]":function(e){e.preventDefault(),this.trigger("cancel"),this.hide()},"change.crc .j-item-chk":"_handleCheckboxChange"},setup:function(){var e=this,t={},n=m.getConfig("context.locale").toLowerCase(),i=0==n.indexOf("en")?650:526;this.$dialogContent=null,this.tabEntities={},e.set("title",p.i18n.t("file/lbl_att_from_file_center"),{silent:!0}),e.set("confirmTpl",p.i18n.t("common/confirm"),{silent:!0}),e.set("cancelTpl",p.i18n.t("common/cancel"),{silent:!0}),e.set("fileType",!1,{silent:!0}),e.set("width",i),e.set("height",464),e.set("message",e.compile(g.find("#filelistTpl").html(),t)),e.pubSub=new c("component.filelistbox"),e.authority.accessory=!!m.getConfig("file.ispermitattmgr"),e.authority.personalnf=!!m.getConfig("file.ispermitnf"),e.authority.enterprisenf=!!m.getConfig("file.ispermitenf"),e.authority.transitcenter=!!m.getConfig("file.ispermittrs"),e.config={enableSecurityLevel:m.getConfig("user.enablesecuritylevel")},w.superclass.setup.call(this),this.after("render",function(){e._initDialogContentDom(),e._renderTabs(),e._initStyle(),e._initUTabs(e.get("type")),e._initEvent()})},render:function(){var e,t;w.superclass.render.call(this),e=this.$("."+this.get("classPrefix")+"-operation").eq(0),t=i('<span class="u-filebox-selectedSum"/>'),this.set("$selectedSum",t),e.append(t)},destroy:function(){this.widget.tabs.destroy(),this.tabEntities.accessory&&this.tabEntities.accessory.destroy(),this._offEvent(),w.superclass.destroy.call(this)},_renderTabs:function(){var e,t=this,n=g.find("#utabTpl"),i=t.$(n.data("container"));i.children().remove(),e=t.compile(n.html(),t.authority),i.html(e)},_renderBlank:function(){var e,t=this,n=g.find("#blankTpl"),i=t.$(n.data("container"));i.children().remove(),e=t.compile(n.html()),i.html(e)},_renderForbidden:function(e){var t,n=this,i=g.find("#forbiddenTpl");e.children().remove(),t=n.compile(i.html()),e.html(t)},_renderPersonalnf:function(){var e,t=this,n=p.i18n.t("file/msg_list_pnf_blank"),a=p.i18n.t("file/msg_list_pnf_fail"),r=m.getFolderLockedStatus(!0),s=this.$dialogContent.find('.u-tab-content [data-type="personalnf"]'),o=i('<div class="c-filebox-auth2lock"><div class="c-filebox-auth2lock-wrap"></div></div>');r.isAuth?t._renderNfList.call(t,!1,h.getPNfFolderStructure,n,a):(s.html(o),e=new v({root:o.find(".c-filebox-auth2lock-wrap"),successCb:function(){e.close(),t._renderNfList.call(t,!1,h.getPNfFolderStructure,n,a)}}))},_renderEnterprisenf:function(){var e=this,t=p.i18n.t("file/msg_list_enf_blank"),n=p.i18n.t("file/msg_list_enf_fail");e._renderNfList.call(e,!0,h.getENfFolderStructure,t,n)},_renderTransitcenter:function(){var e=p.i18n.t("file/msg_list_trs_blank"),t=p.i18n.t("file/msg_list_trs_fail"),n=h.getTrsFiles,i={};this._renderList("transitcenter",n,i,e,t)},_renderList:function(e,t,n,a,r){var s,o=this,l=g.find("#"+e+"ListTpl"),c=o.$dialogContent.find(l.data("container"));return"function"!==i.type(t)?!1:c.attr("data-rendered")?!1:(i.isPlainObject(n)||(n={}),void i.when(t(n)).then(function(e){var t=e["var"];s=t.length<=0?a:o.compile(l.html(),{fileList:t,enableSecurityLevel:o.config.enableSecurityLevel}),c.html(s).customRadioCheckbox(),c.attr("data-rendered",!0)},function(){s=r,c.html(s)}))},_renderNfList:function(e,t,n,a,r){var s,o=this,l=g.find("#nfListTpl"),c=o.$dialogContent.find('.u-tab-content [data-type="'+o.get("fileType")+'"]');return"function"!==i.type(t)?!1:"true"==c.attr("data-rendered")?!1:(c.html(p.i18n.t("file/msg_filebox_loading")),void i.when(t(r,!0,!0,!0)).then(function(r){var d,u,p={parentFolders:r.folderTree.length>0?r.folderTree.reverse():[],subFolders:r.folders,nfFiles:r.files,folderInfo:r.folderInfo,isEnf:e,blankMsg:n,isBlank:r.folders.length<=0&&r.files.length<=0,enableSecurityLevel:o.config.enableSecurityLevel},m="f-dn",h=".j-parentPath",f=function(){var e,t,n=d[0].scrollHeight,i=d.outerHeight();n>i+3&&(e=d.find(h).eq(0),t=e.data("fid"),e.remove(),u.removeClass(m),u.data("fid",t),u.find("a").data("fid",t),f())};c.children().remove(),s=o.compile(l.html(),p),c.html(s).customRadioCheckbox(),d=c.find(".u-crumb"),u=d.find(".j-hiddenPath").eq(0),f(),c.find('a[data-action="enterFolder"]').on("click",function(r){var s=i(r.target).data("fid");r.preventDefault(),c.attr("data-rendered","false"),o._renderNfList(e,t,n,a,s)}),c.attr("data-rendered","true"),b.trigger(_.selectNumUpdate)},function(){s=a,c.html(s)}))},_initDialogContentDom:function(){this.$dialogContent=this.$("."+this.get("classPrefix")+"-content")},_initStyle:function(){this.$(".u-dialog-close").addClass("u-filebox-close"),this.$dialogContent.parent(".u-dialog-wrap").addClass("c-filebox-dialog")},_initUTabs:function(e){var t=this,n=0,a=".j-filebox-content-warp .j-filebox-tab";e&&this.authority[e]||i.each(this.authority,function(t,n){return n?(e=t,!1):void 0}),!!e&&t.$(a).find('[data-role="trigger"]').each(function(t){return i(this).data("type")===e?(n=t,!1):void 0}),t.widget.tabs=new o({element:a,activeTriggerClass:"z-current",activeIndex:n,triggerType:"click"}),t.widget.tabs.on("switch",function(e,n){var a=i(this.get("triggers")[e]).data("type");t.set.call(t,"fileType",a)}).on("switched",function(){b.trigger(_.selectNumUpdate)}),t.set("fileType",e)},_initEvent:function(){this._initWidgetEvent(),b.on(_.selectNumUpdate,function(){this._updateSelectedSum()},this)},_initWidgetEvent:function(){var e=this;e.on("confirm",e._handleConfirm,e),e.on("cancel",e._handleCancel,e)},_offEvent:function(){b.off(_.selectNumUpdate)},_onChangeFileType:function(e){var t,n,i=this,a=this.$(".u-tab-content");if(e=e.toLowerCase(),t=a.find('[data-type="'+e+'"]').eq(0),!e||!i.authority.hasOwnProperty(e))return this._renderBlank(),!1;if(!this.authority[e])return this._renderForbidden(t),!1;if("accessory"===e&&!this.tabEntities[e])return this.tabEntities[e]=new y,this.tabEntities[e].render(),void a.find(".u-switchable-panel[data-type="+e+"]").html(this.tabEntities[e].element);switch(e){case"personalnf":n=i._renderPersonalnf;break;case"enterprisenf":n=i._renderEnterprisenf;break;case"transitcenter":n=i._renderTransitcenter}!!n&&n.call(i)},_handleCheckboxChange:function(e){this._updateSelectedSum()},_handleConfirm:function(){var e,t,n=this,a=n.get("_doConfirm");switch(n.get("fileType")){case"accessory":e=n._handleConfirmAccessory;break;case"personalnf":e=n._handleConfirmPersonalnf;break;case"enterprisenf":e=n._handleConfirmEnterprisenf;break;case"transitcenter":e=n._handleConfirmTransitcenter}return!!e&&"function"===i.type(e)&&(t=e.call(n)),!!a&&"function"===i.type(a)&&a(t),n.hide()},_handleCancel:function(){var e=this,t=e.get("_doCancel");return!!t&&"function"===i.type(t)&&t(),e.hide()},_handleConfirmAccessory:function(){var e,n,a,r,s,o,l=this,c="internal",d=t(l),u=[];return d.each(function(){e=i(this).parents(".file-item"),n=e.data("accid"),a=e.data("accpartid"),r=e.data("contenttype"),s=e.data("size"),o=e.data("name"),u.unshift({mid:n,part:a,type:c,name:o,size:s,contentType:r})}),u},_handleConfirmPersonalnf:function(){var e,n,a,r,s,o,l,c,d=this,u="netfolder",p=t(d),m=[];return p.each(function(){e=i(this).parents(".file-item"),n=e.data("id"),a=e.data("fid"),r=e.data("contenttype"),s=e.data("size"),o=e.data("name"),l=e.data("securitylevel"),c={mid:n,type:u,name:o,size:s,contentType:r},d.config.enableSecurityLevel&&(c.securityLevel=l),m.unshift(c)}),m},_handleConfirmEnterprisenf:function(){var e,n,a,r,s,o,l,c=this,d="netfolder",u=t(c),p=m.getConfig("file.enfuid"),h=[];return u.each(function(){e=i(this).parents(".file-item"),n=e.data("id"),a=e.data("contenttype"),r=e.data("size"),s=e.data("name"),o=e.data("securitylevel"),l={mid:n,type:d,name:s,size:r,contentType:a,enfUid:p},c.config.enableSecurityLevel&&(l.securityLevel=o),h.unshift(l)}),h},_handleConfirmTransitcenter:function(){var e,n,a,r,s,o,l,c=this,d="trs",u=t(c),p=[];return u.each(function(){e=i(this).parents(".file-item"),n=e.data("id"),a=e.data("contenttype"),r=e.data("size"),s=e.data("name"),o=e.data("securitylevel"),l={mid:n,type:d,name:s,size:r,contentType:a},c.config.enableSecurityLevel&&(l.securityLevel=o),p.unshift(l)}),p},_updateSelectedSum:function(){var e=t(this).length,n=this.get("$selectedSum");0>=e?n.html(""):n.html(p.i18n.t("file/msg_filebox_slected_sum",{num:e}))},templateHelpers:{GetDateMD:function(e){return e?new r.SafeString(a(e).format("MM-DD")):void 0},GetRemainDH:function(e){a.locale(m.getConfig("context.locale"));var t=a.duration(e);if(e)return new r.SafeString(t.humanize())},GetFileIco:function(e,t){return e&&t?t+f.formatFileType(e):""},TranslateSL:function(e){return e?p.securityLevel.i18n(e,"sender_security_level"):""}}});w.DEFAULT={type:"",_doConfirm:null,_doCancel:null},w.init=function(e,t,n,a){var r={type:e||"",_doConfirm:t,_doCancel:n};new w(i.extend(null,r,a)).show().after("hide",function(){this.destroy()})},w.pnf=function(e,t,n){w.init("personalnf",e,t,n)},w.enf=function(e,t,n){w.init("enterprisenf",e,t,n)},w.acc=function(e,t,n){w.init("accessory",e,t,n)},w.trs=function(e,t,n){w.init("transitcenter",e,t,n)};var x=i.fn.fileListBox;return i.fn.fileListBox=function(e){return this.each(function(){var t=i(this),n=t.data("cm.filelistbox");e=i.extend({},w.DEFAULT,i.isPlainObject(t.data())&&t.data(),i.isPlainObject(e)&&e),n||(t.data("cm.filelistbox",n=new w(e)),n.show().after("hide",function(){t.data("cm.filelistbox",null),this.destroy()}))})},i.fn.fileListBox.Constructor=w,i.fn.fileListBox.notConflict=function(){i.fn.fileListBox=x},w}),define("component/stationery/stationery",["require","i18n!compose","widget/pagination/pagination","jquery","cui/core/view/view","cui/util/templatable/templatable","../../util/index","cui/util/detector/detector"],function(e){function t(){var e=r.Deferred();return l.xhr.simpleCall({url:"./89517/script/component/stationery/stationery.json",preprocess:!1,onlyVar:!1},function(t){e.resolve(t)},function(){e.reject()}),e.promise()}function n(e){return CC.path("common/stationery/thumbnail/"+e+"?pv="+CC.pv())}function i(e){var t,n,i=CC.pv(),a=e.find("[background]");if(t=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),n=t+"/"+CC.path("common/stationery/"),/background="/gi.test(e.html()))return e.html().replace(/ background="(.+?)"/gi,' background="'+n+"$1?pv="+i+'"');for(var r=0;r<a.length;r++)a.eq(r).attr("background",n+a.eq(r).attr("background")+"?pv="+i);return e.html()}function a(e){/firefox/i.test(c.browser.name)&&(e.cmd.doc.execCommand("enableInlineTableEditing",!1,"false"),e.cmd.doc.execCommand("enableObjectResizing",!1,"false"))}e("i18n!compose"),e("widget/pagination/pagination");var r=e("jquery"),s=e("cui/core/view/view"),o=e("cui/util/templatable/templatable"),l=e("../../util/index"),c=e("cui/util/detector/detector"),d='<div class="j-stationery-box"><div class="{{prefixCls}}">{{#each array}}<div class="stationery-item"><a href="javascript:void(0)" title="{{title}}" class="stationery-thumb" index="{{index}}"><img src="{{imgSrc}}"><span class="bg"></span></a></div>{{/each}}</div></div>',u=s.extend({Implements:o,attrs:{editor:null,prefixCls:null,container:null,pagination:null,template:d},setup:function(){u.superclass.setup.call(this),this._params={limit:13,stationeryCache:null,img:["Peace_m.jpg","Buckle_m.jpg","LeatherCowBoy_m.jpg","Lilium_martagan_m.jpg","Lotus_m.jpg"],selectedTpl:r('<a href="javascript:void(0)" class="z-current"><img src="'+CC.path("common/stationery/thumbnail/selected.gif?pv="+CC.pv())+'"></a>')}},render:function(){u.superclass.render.call(this),this._initView(),this._initModuleEvent()},_initView:function(){var e=this,t=e._params.img.length;e._renderStationeryList(0),e._initPagination(t,e._params.limit)},_initModuleEvent:function(){var e=this,t=e.get("container");t.on("click",".stationery-thumb",function(t){t.preventDefault(),e._getStationery(this)})},_initPagination:function(e,t){var n=this;n.get("pagination").pagination({total:e,limit:t,currentPage:0,menu:!1,round:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(e){n._renderStationeryList(e*t)}})},_renderStationeryList:function(e){for(var t=this,i=[],a=t.get("container"),r=t.get("template"),s=e;s-e<t._params.limit&&t._params.img[s];s++)i.push({title:l.i18n.t("compose/stationery_type"+(s+1)),imgSrc:n(t._params.img[s]),index:s});i.unshift({title:l.i18n.t("compose/stationery_type0"),imgSrc:n("none_zh.png"),index:-1}),a.find(".j-stationery-box").remove(),a.find(".j-stationery").append(t.compile(r,{array:i,prefixCls:t.get("prefixCls")})).show()},_getStationery:function(e){var n=this,i=n.get("container"),a=parseInt(r(e).attr("index"));-1===a?n._updateStationery():t().then(function(e){n._updateStationery(e["stationery-type"+a].join(""))}),i.find(".stationery-thumb").removeClass("stationery-selected"),r(e).addClass("stationery-selected")},_formatStationery:function(e,t){var n,a=r("<div/>").append(e),s=a.find("#tdRidBody");s.html(t),n=10-r("br",s).length||0;for(var o=0;n>o;o++)s.append("<br />");return a.find("#tdRidBody").html(s.html()),i(a)},_updateStationery:function(e){var t,n=this,i=n.get("editor"),s=i.html();e=e||"";try{t=r(s).find("#tdRidBody").length>0?r(s).find("#tdRidBody").html():s}catch(o){t=s}0!==e.length?(t=n._formatStationery(e,t),i.html(t)):i.html(t),a(i)}});return u}),define("components/requirejs-text/text!component/../../template/component/sourcePreview.tpl.html",[],function(){return'<div class="m-tpl-variable">\r\n  <div class="j-list-header"></div>\r\n  <div class="u-variable-list"></div>\r\n\r\n  {{#raw}}\r\n  <script type="x-handlebars-template" id="variableHeaderTpl">\r\n    <div class="var-list-header j-list-desc">[[[i18n \'prop:mail/lbl_template_resolve_result\' 0=total 1=0]]] </div>\r\n    <div class="var-list-rcpts">\r\n      <label>[[i18n \'mail/lbl_chose_source_rcps_column\']]</label>\r\n      <select name="rcpt_column_name" class="j-rcpt-name">\r\n        [[#each keys]]\r\n        <option value="[[this]]">[[this]]</option>\r\n        [[/each]]\r\n      </select>\r\n    </div>\r\n    <div class="j-source-pagination pagination"></div>\r\n  </script>\r\n\r\n  <script type="x-handlebars-template" id="variableTpl">\r\n    <div class="preview-wrapper">\r\n      <table class="u-table u-table-row j-var-table">\r\n        <thead>\r\n        <tr>\r\n          <th class="chk"><input class="j-chk-all" type="checkbox" [[#if selectAll]] checked [[/if]]/></th>\r\n          [[#each keys]]\r\n          <th>[[this]]</th>\r\n          [[/each]]\r\n        </tr>\r\n        </thead>\r\n        <tbody>\r\n        [[#each items]]\r\n        <tr>\r\n          <td>\r\n            <input class="j-select-single" type="checkbox"\r\n              [[computeSelect ../startIndex @index ../selectedItemIndex]]\r\n              value="[[math ../startIndex \'+\' @index ]]"\r\n              data-index=[[math ../startIndex \'+\' @index ]] />\r\n          </td>\r\n          [[[showItems this ../keys]]]\r\n        </tr>\r\n        [[/each]]\r\n        </tbody>\r\n      </table>\r\n      <br>\r\n    </div>\r\n  </script>\r\n  {{/raw}}\r\n</div>'}),define("component/sourcePreviewBox",["require","i18n!mail","jquery","../util/index","cui/ui/dialog/confirmbox","../module/common/globalService","text!../../template/component/sourcePreview.tpl.html"],function(e){e("i18n!mail");var t=e("jquery"),n=e("../util/index"),i=e("cui/ui/dialog/confirmbox"),a=(e("../module/common/globalService"),e("text!../../template/component/sourcePreview.tpl.html")),r=n.i18n,s=n.messageFormat.format,o=i.extend({attrs:{title:r.t("mail/lbl_template_file_upload"),closeTpl:'<span class="iconfont icontabclose"></span>',confirmTpl:n.i18n.t("common/confirm"),cancelTpl:n.i18n.t("common/cancel"),message:null,selectAll:!1,width:"800",height:"700",selectItems:{},columnKeys:[],parsedData:[]},templateHelpers:{showItems:function(e,n){var i="";return t.each(n,function(t,n){i+="<td>"+e[n]+"</td>"}),i},computeSelect:function(e,n,i){var a=""+(e+n);return-1!==t.inArray(a,i)?"checked":""}},events:{"change.crc .j-chk-all":"_handleSelectAll","change.crc .j-select-single":"_handleSelectSingle"},setup:function(){var e=this,t=this.get("parsedData");this.set("message",this.compile(a)),this.set("columnKeys",Object.keys(t[0])),this.on("confirm",function(){var t=this.get("parent"),n=e._handleSelectItem();t._params.varList=n.varList,t._params.varListRcptsName=n.rcptsKey,t.$(".j-form-item-to input").tagEditor("updateTags",n.tagList,!0),e.hide()}),this.on("hide",function(){setTimeout(function(){e.trigger("close")},20)}),this.after("render",function(){e.element.addClass("u-source-preview")}),o.superclass.setup.call(this)},render:function(){o.superclass.render.call(this),this._renderListHeader(),this._renderList(0),this._initPagination()},_renderListHeader:function(){this.$(".j-list-header").html(this.compile(this.$("#variableHeaderTpl").html(),{keys:this.get("columnKeys"),total:this.get("parsedData").length}))},_renderList:function(e){var t=10*e,n=this.$("#variableTpl").html(),i=this.get("parsedData").slice(t,t+10);this.$(".u-variable-list").html(this.compile(n,{startIndex:t,selectAll:this.get("selectAll"),items:i,keys:this.get("columnKeys"),selectedItemIndex:Object.keys(this.get("selectItems"))})).customRadioCheckbox()},_initPagination:function(){var e=this,t=this.get("parsedData");this.$(".j-source-pagination").pagination({total:t.length,limit:10,currentPage:0,menu:!0,round:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(t){e._renderList(t)}})},_handleSelectItem:function(){var e=this.get("selectItems"),n=this.$(".j-rcpt-name").val(),i=[];return Object.keys(e).forEach(function(t){i.push(e[t])}),{rcptsKey:n,varList:i,tagList:t.map(i,function(e){return e[n]})}},_handleSelectAll:function(e,n){function i(e){for(var t={},n=0;n<e.length;++n)t[n]=e[n];return t}var a=this.$('.j-var-table input[type="checkbox"]'),r=this.get("parsedData"),s=t(n).is(":checked");this.set("selectAll",s),s?(a.prop("checked",!0),a.next(".checkbox").addClass("checkbox-checked"),this.set("selectItems",i(r),{override:!0})):(a.prop("checked",!1),a.next(".checkbox").removeClass("checkbox-checked"),this.set("selectItems",{},{override:!0})),this._updateSelectInfo(s?r.length:0,r.length)},_handleSelectSingle:function(e,n){var i=t(n).data("index"),a=t(n).is(":checked"),r=this.get("selectItems"),s=this.get("parsedData"),o=this.$(".j-chk-all");a?r[i]=s[i]:(delete r[i],this.set("selectAll",!1)),Object.keys(r).length===s.length?(o.prop("checked",!0),o.next(".checkbox").addClass("checkbox-checked"),this.set("selectAll",!0)):(o.prop("checked",!1),o.next(".checkbox").removeClass("checkbox-checked")),this._updateSelectInfo(Object.keys(r).length,s.length)},_updateSelectInfo:function(e,t){this.$(".j-list-desc").html(s(r.t("mail/lbl_template_resolve_result"),[t,e]))},destroy:function(){o.superclass.destroy.call(this)}});return o}),define("module/setting/delivery/template/service",["require","jquery.iframeTransport","jquery","module/common/globalService","../../../../util/index"],function(e){function t(e,t){var n=l.Deferred();return d.xhr.simpleCall({query:{func:t?"user:updateComposeTemplates":"user:createComposeTemplates",sid:c.getSid()},data:{items:e}},function(e){n.resolve(e)},function(){n.reject()}),n.promise()}function n(){var e=l.Deferred();return d.xhr.simpleCall({query:{func:"user:listComposeTemplates",sid:c.getSid()}},function(t){e.resolve(t)},function(){e.reject()}),e.promise()}function i(e){var t=l.Deferred();return d.xhr.simpleCall({query:{func:"user:deleteComposeTemplates",sid:c.getSid()},data:e},function(n){t.resolve(l.extend(n,e))},function(){t.reject()}),t.promise()}function a(e){var t=l.Deferred();return d.xhr.simpleCall({query:{func:"user:getComposeTemplatesMeta",sid:c.getSid()},data:e},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function r(e){var t=l.Deferred();return d.xhr.simpleCall({query:{func:"user:updateComposeTemplatesMeta",sid:c.getSid()},data:{attrs:e}},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function s(e){var t,n,i=l.Deferred(),a=d.detector.supportAjaxUpload(),r={url:d.xhr.getFullRequestURL({url:"/XT5/jsp/upload.jsp",query:{func:"directData",sid:c.getSid(),composeId:"c:1"}}),type:"post",processData:!1,contentType:!1};return a?(t=new FormData,t.append("tplSourceFile",e[0].files[0]),r.data=t):(r.files=e,r.useiframe=!0),l.ajax(r).complete(function(e){n=JSON.parse(e.responseText),i.resolve(n)}).fail(function(){i.reject()}),i.promise()}function o(e,t){var n=l.Deferred();return d.xhr.simpleCall({query:{func:"mbox:tplComposeCsvParse",sid:c.getSid()},data:{keepOriginal:!1,attachmentId:e,composeId:"c:1",importVarListTo:t},preprocess:!1,onlyVar:!1},function(e){n.resolve(e)},function(){n.reject()}),n.promise()}e("jquery.iframeTransport");var l=e("jquery"),c=e("module/common/globalService"),d=e("../../../../util/index");return{upsetMailTpl:t,listMailTpl:n,deleteMailTpl:i,getMailTplMeta:a,updateMailTplMeta:r,uploadTplSourceFile:s,parseTplSource:o}}),define("component/mailTemplate",["require","i18n!mail","widget/pagination/pagination","../util/index","jquery","cui/core/view/view","cui/util/templatable/templatable","../module/common/globalService","cui/ui/dialog/confirmbox","cui/core/events/pubsub","./sourcePreviewBox","../module/setting/delivery/template/service"],function(e){function t(){var e=i.Deferred();return n.xhr.simpleCall({query:{func:"user:listComposeTemplates",sid:s.getSid()}},function(t){e.resolve(t)},function(){e.reject()}),e.promise()}e("i18n!mail"),e("widget/pagination/pagination");var n=e("../util/index"),i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/util/templatable/templatable"),s=e("../module/common/globalService"),o=e("cui/ui/dialog/confirmbox"),l=e("cui/core/events/pubsub"),c=e("./sourcePreviewBox"),d=e("../module/setting/delivery/template/service"),u=n.i18n,p='<ul class=\'template-list\'>{{#each list}}{{#is type "in" "remove,add"}}{{#compare type "==" "remove"}}<li class="f-csp no-use-tpl" data-action="removeTpl"><i class="iconfont iconchoose"></i></li>{{/compare}}{{#compare type "==" "add"}}<li class="f-csp create-mail-tpl"><span data-action="createNewTpl" class="iconfont iconadd"></span></li>{{/compare}}{{else}}<li data-action="addToCompose" data-index="{{id}}" class="f-csp {{#compare id "==" ../../selectedID}} selected {{/compare}}"><span class="wrapper">{{name}} <i class="iconfont iconchoose"></i></span></li>{{/is}}{{/each}}<ul>',m='<div class="u-poptip j-source-pop-tip"><div class="u-poptip-container"><div class="u-poptip-arrow u-poptip-arrow-11"><em></em><span></span></div><div class="u-poptip-content"> {{{i18n "mail/msg_tpl_guidance"}}}</div></div></div>',h=a.extend({Implements:r,attrs:{editor:null,container:null,pagination:null,template:p,popupTpl:m,templates:[],selectedTemplateID:null,parent:null,tipsAppended:!1,userCookieName:"source_tip_hide"+s.getConfig("user.uid"),injectLastAddedTpl:!1},setup:function(){h.superclass.setup.call(this),this.cPubsub=new l("component.mailTemplate"),this._initModuleEvent()},destroy:function(){this.cPubsub.offMessage(),h.superclass.destroy.call(this)},render:function(){h.superclass.render.call(this),this._fetchData(!0)},_fetchData:function(e){var i=this,a=n.cache.getItem("compose_tpl_map")||{},r=this.get("parent").get("composeId");t().then(function(t){t.reverse(),t.unshift({type:"remove"}),t.push({type:"add"}),2===t.length&&t.shift(),a[r]&&i.set("selectedTemplateID",a[r]),i.set("templates",t),i._renderList(0),e&&i._initPagination()})},_initModuleEvent:function(){var e=this;this.cPubsub.onMessage("list:refresh",function(){e._fetchData(!0)},null),this.cPubsub.onMessage("switch.template",function(t){e.get("parent").get("composeId")==t.message.composeId&&e.set("injectLastAddedTpl",!0)},null)},_renderList:function(e){var t=8*e,n=this.get("templates"),a=n.slice(t,t+8),r=i(this.compile(p,{list:a,selectedID:this.get("selectedTemplateID")}));this.get("container").html(r),r.on("click","[data-action]",i.proxy(this._dispatchAction,this)),this.get("injectLastAddedTpl")&&(r.find("li:eq(1)").trigger("click"),this.set("injectLastAddedTpl",!1))},_dispatchAction:function(e){var t=i(e.target);switch(t.data("action")){case"addToCompose":this._handleAddTplToCompose(t);break;case"createNewTpl":this._handleSwitchToCreateTpl();break;case"removeTpl":this._handleRemoveTpl(t)}},_initPagination:function(){var e=this,t=this.get("templates");this.get("pagination").pagination({total:t.length,limit:8,currentPage:0,menu:!1,round:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(t){e._renderList(t)}})},_handleUploadSourceFile:function(e){var t=i(e.target),a=this.get("parent"),r=a._params.composeInfo.composeId;d.uploadTplSourceFile(t).then(function(e){if("S_OK"===e.code){var t=e["var"].attachmentId;d.parseTplSource(t,r).then(function(e){switch(e.code){case"FA_UNSUPPORTED_FILE":case"FA_BAD_CSV_FILE":case"FA_BAD_XLS_FILE":o.alert(n.i18n.t("mail/msg_parse_bad_file"));break;case"FA_XLS_SUPPORT_NOT_INSTALLED":i.notify.error(n.i18n.t("mail/msg_xls_support_not_installed"));break;case"S_OK":e["var"].length>0?new c({parsedData:e["var"],parent:a}).show():o.confirm(n.i18n.t("mail/msg_parse_csv_empty"))}})}}).always(function(){t.replaceWith(t.clone(!0))})},_handleAddTplToCompose:function(e){function t(){c.designMode?l.isHtml?c.html(l.content):c.html(n.html.text2html(l.content)):l.isHtml?c.text(n.html.html2text(l.content)):c.text(l.content),f&&(a=c.html(),a=v(a,"",f,c.designMode),c.html(a)),e.siblings().removeClass("selected").end().addClass("selected"),r.set("selectedTemplateID",l.id),r.get("tipsAppended")||n.cookies.get(p,0)||!h||(c.designMode||m.css({left:"280px"}),d.$(".j-form-edr").append(m),r.set("tipsAppended",!0)),h?d.$(".j-import-source-file").show().off("change").on("change",i.proxy(r._handleUploadSourceFile,r)):(d.$(".j-import-source-file").hide(),d.$(".j-source-pop-tip").remove(),r.set("tipsAppended",!1)),d._params.varList=null,d._params.varListRcptsName=null}if(!e.hasClass("selected")){var a,r=this,s=e.data("index"),l=i.grep(this.get("templates"),function(e){return e.id==s})[0],c=this.get("editor"),d=this.get("parent"),p=this.get("userCookieName"),m=i(this.compile(this.get("popupTpl"))),h=!!(l.opt&&l.opt.variables&&l.opt.variables.length>0),f=d._params.currentSign,v=d._replaceEditorSign;m.on("click","a",function(){m.remove(),n.cookies.set(p,1)}),this.get("editor").isEmpty()?t():o.confirm(u.t("mail/msg_remove_original_content"),function(){r.get("parent")._handleTblDraft(),t()},function(){t()},{confirmTpl:u.t("mail/lbl_replace_and_save"),cancelTpl:u.t("mail/lbl_replace_without_save")})}},_handleSwitchToCreateTpl:function(){var e={module:"setting.delivery.template"},t=this.get("parent").get("composeId");s.setCurrentState(i.extend(e,{param:{type:"create",id:t}})),this.cPubsub.sendMessage("dispatcher","history:add",e)},_handleRemoveTpl:function(e){var t=this.get("parent"),n="";t.$(".j-import-source-file").hide(),t.$(".j-source-pop-tip").remove(),t._params.varList=null,t._params.varListRcptsName=null,e.siblings().removeClass("selected").end().addClass("selected"),t._params.currentSign?(n=t._replaceEditorSign("","",t._params.currentSign,this.get("editor").designMode),this.get("editor").html(n)):this.get("editor").html(""),this.set("selectedTemplateID",null),this.set("tipsAppended",!1)}});return h}),define("components/requirejs-text/text!component/../../template/component/voiceupload.tpl.html",[],function(){return'<!---->\r\n<div class="voice-upload">\r\n    <div class="u-alert-warning">\r\n        <span class="sndStateDesc">{{i18n \'compose/ready\'}}</span>\r\n    </div>\r\n    <div class="u-voice-cont">\r\n        <select name="select_snd_dev" class="select_snd_dev">\r\n            <option value="0" class="default_snd_dev" selected></option>\r\n        </select>\r\n        <div class="btnDiv">\r\n            <span class="btnSpan" data-action="rec">\r\n                <input type="button" class="u-btn u-btn-default sndStartRec" value="{{i18n \'compose/btn_rec\'}}" disabled="true"/>\r\n            </span>\r\n            <span class="btnSpan" data-action="stop">\r\n                <input type="button" class="u-btn u-btn-default sndStopRec" value="{{i18n \'compose/btn_stop\'}}" disabled="true"/>\r\n            </span>\r\n            <span class="btnSpan" data-action="play">\r\n                <input type="button" class="u-btn u-btn-default sndReplayInfo" value="{{i18n \'compose/btn_play\'}}" disabled="true" />\r\n            </span>\r\n            <input type="hidden" class="sndStateID">\r\n        </div>\r\n        <div class="sndReplayPos" style="display:none;">\r\n            <object class="MediaRePlayer" type="application/x-vnd.FBBasicMediaPlayer"></object>\r\n        </div>\r\n    </div>\r\n<div>';
}),define("component/voiceupload/voiceupload",["require","i18n!compose,common","../fileupload/fileupload-plugin","cui/util/templatable/templatable","text!../../../template/component/voiceupload.tpl.html","jquery","../../util/index","cui/ui/dialog/confirmbox"],function(e){e("i18n!compose,common"),e("../fileupload/fileupload-plugin");var t=e("cui/util/templatable/templatable"),n=e("text!../../../template/component/voiceupload.tpl.html"),i=e("jquery"),a=e("../../util/index"),r=e("cui/ui/dialog/confirmbox"),s=r.extend({Implements:t,attrs:{width:"auto",title:a.i18n.t("compose/snd_title"),message:"",confirmTpl:a.i18n.t("common/confirm"),cancelTpl:a.i18n.t("common/cancel"),dnd:!0,uploader:null},events:{"click [data-role=confirm]":function(e){var t=this;e.preventDefault(),t._checkDevice()&&t._handleUpload(),t.hide()},"click [data-role=cancel]":function(e){var t=this;e.preventDefault(),t._handleCancel(),t.hide()}},setup:function(){this._params={},s.superclass.setup.call(this)},render:function(){var e=this;e._params.voiceState={Initializing:0,Ready:1,Recording:2,Stopping:3,Finish:4},e._params.soundRecord=e.element.cmplugin("voice"),s.superclass.render.call(this),e._checkDevice()?(e.set("message",t.compile(n,{})),e.$(".u-dialog-wrap").addClass("u-voiceupload"),e.show(),e._initVoice()):e._checkDevice()},destroy:function(){s.superclass.destroy.call(this)},_initVoice:function(){var e=this,t=e.$(".voice-upload");return e._initDevice(),e._changeState("ready"),t.off("click",".btnSpan"),t.on("click",".btnSpan",function(){var t=i(this);e._dispatcher(t)}),!0},_checkDevice:function(){var e=this,i=e._params.soundRecord.wavDeviceNum;return 0===i?(e.set({message:a.i18n.t("compose/nosnddev")},t.compile(n,{})),e.$(".u-dialog-wrap").addClass("u-videoAlert"),e.show(),!1):!0},_initDevice:function(){var e=this,t=e.$(".select_snd_dev")[0],n=e._params.soundRecord.wavDeviceNum;e.$(".default_snd_dev").text(a.i18n.t("compose/default_dev")+"-"+e._params.soundRecord.wavDeviceDesc(0));for(var i=1;n>i;++i)t.options[i]=new Option(e._params.soundRecord.wavDeviceDesc(i),i)},_handleStart:function(){var e=this,t=e.$(".select_snd_dev");e._params.soundRecord.init({size:0,recordtime:60,wavidx:parseInt(t.val())}),e._params.soundRecord.start(),e._changeState("recording")},_handleStop:function(){var e=this;e._params.soundRecord.stop(),e._changeState("ready")},_handleReplay:function(){var e=this,t=e.$(".voice-upload"),n=t.find(".sndStateID"),i=t.find(".sndReplayPos"),s=i.find(".MediaRePlayer");return"replaying"!==n.val()?(e._params.soundRecord.stop(),e._params.soundRecord.state===e._params.voiceState.Initializing?(r.alert(a.i18n.t("compose/no_file_record")),!1):e._params.soundRecord.state===e._params.voiceState.Finish?(e._changeState("replaying"),setTimeout(function(){e._funReplay(s[0],e._params.soundRecord.filename)},100),!0):r.alert(a.i18n.t("compose/msg_opsTooFrequent"))):(e._changeState("ready"),void s.stop())},_handleUpload:function(){var e=this;if(e._params.soundRecord.state===e._params.voiceState.Initializing)return alert(a.i18n.t("compose/no_file_record")),!1;if(e._params.soundRecord.state!==e._params.voiceState.Finish)return alert(a.i18n.t("compose/msg_opsTooFrequent")),e._params.soundRecord.closeAll(),!1;if(e._params.soundRecord.filename){var t=e._params.soundRecord.upload();e.get("uploader").attachupload("pluginAdd",t)}},_handleCancel:function(){var e=this;e._params.soundRecord.closeAll()},_funReplay:function(e,t){e.valid?e.play1(t):r.alert("Browser not support replay!")},_changeState:function(e){var t=this,n=t.$(".voice-upload"),i=n.find(".sndStartRec"),r=n.find(".sndStopRec"),s=n.find(".sndReplayInfo"),o=n.find(".sndUploadRec"),l=n.find(".sndCancelRec"),c=n.find(".sndStateID"),d=n.find(".sndReplayPos"),u=t.$(".sndStateDesc");c.val(e),i.attr("disabled","recording"===e||"replaying"===e),r.attr("disabled","ready"===e||"replaying"===e),s.attr("disabled","recording"===e),s.val("replaying"===e?a.i18n.t("compose/btn_cancel_play"):a.i18n.t("compose/btn_play")),d[0].style.display="replaying"===e?"":"none",o.attr("disabled","recording"===e||"replaying"===e),l.attr("disabled","recording"===e||"replaying"===e),u.html(a.i18n.t("compose/"+e))},_dispatcher:function(e){var t=this,n=e.data("action");switch(n){case"rec":this._handleStart();break;case"stop":t._handleStop();break;case"play":t._handleReplay()}}});return s}),define("components/requirejs-text/text!component/../../template/component/videoupload.tpl.html",[],function(){return'<div class="video-upload">\r\n    <div class="u-alert-warning">\r\n        <span class="vdoStateDesc">{{i18n \'compose/ready\'}}</span>\r\n    </div>\r\n    <div class="u-video-cont">\r\n        <div class="u-select">\r\n            <select class="select_vdo_dev">\r\n                <option value="0" class="default_vdo_dev" selected></option>\r\n            </select>\r\n        </div>\r\n        <div class="u-select">\r\n            <select class="select_vdo_snd_dev">\r\n                <option value="0" class="default_vdo_snd_dev" selected></option>\r\n            </select>\r\n        </div>\r\n        <div class="btnDiv">\r\n            <span class="btnSpan" data-action="rec">\r\n                <input type="button" class="u-btn u-btn-default vdoStartRec" value="{{i18n \'compose/btn_rec\'}}" disabled="true"/>\r\n            </span>\r\n            <span class="btnSpan" data-action="stop">\r\n                <input type="button" class="u-btn u-btn-default vdoStopRec" value="{{i18n \'compose/btn_stop\'}}" disabled="true"/>\r\n            </span>\r\n            <span class="btnSpan" data-action="play">\r\n                <input type="button" class="u-btn u-btn-default vdoReplayInfo" value="{{i18n \'compose/btn_play\'}}" disabled="true"/>\r\n            </span>\r\n            <input type="hidden" class="vdoStateID">\r\n        </div>\r\n        <div class="vdoReplayPos" style="display:none;">\r\n            <object class="MediaRePlayer1" type="application/x-vnd.FBBasicMediaPlayer"></object>\r\n        </div>\r\n    </div>\r\n\r\n</div>\r\n'}),define("component/videoupload/videoupload",["require","i18n!compose,common","cui/util/templatable/templatable","text!../../../template/component/videoupload.tpl.html","jquery","../../util/index","cui/ui/dialog/confirmbox"],function(e){e("i18n!compose,common");var t=e("cui/util/templatable/templatable"),n=e("text!../../../template/component/videoupload.tpl.html"),i=e("jquery"),a=e("../../util/index"),r=e("cui/ui/dialog/confirmbox"),s=r.extend({Implements:t,widget:{tabs:null},pubSub:null,attrs:{width:"auto",title:a.i18n.t("compose/vdo_title"),confirmTpl:a.i18n.t("common/confirm"),cancelTpl:a.i18n.t("common/cancel"),dnd:!0,uploader:null},events:{"click [data-role=confirm]":function(e){var t=this;e.preventDefault(),t._checkDevice()&&t._vdoUpload(),t.hide()},"click [data-role=cancel]":function(e){var t=this;e.preventDefault(),t._vdoCancel(),t.hide()}},setup:function(){this._params={},s.superclass.setup.call(this)},render:function(){var e=this;e._params.videoState={Initializing:0,Ready:1,Recording:2,RecFinish:3,Compassing:4,ComFinish:5},e._params.vdoRecorder=e.element.cmplugin("video"),s.superclass.render.call(this),e._checkDevice()?(e.set("message",t.compile(n,{})),e.$(".u-dialog-wrap").addClass("u-videoupload"),e._initVideo(),e.show()):e._checkDevice()},destroy:function(){s.superclass.destroy.call(this)},_initVideo:function(){var e=this,t=e.$(".video-upload");return e._initVdoDevice(),e._changeVdoState("ready"),t.off("click",".btnSpan").on("click",".btnSpan",function(){var t=i(this);e._dispatcher(t)}),!0},_checkDevice:function(){var e=this,i=e._params.vdoRecorder.wavDeviceNum,r=e._params.vdoRecorder.capDeviceNum;return 0===i?0===r?(e.set({message:a.i18n.t("compose/novdodev_and_nosnddev")},t.compile(n,{})),e.$(".u-dialog-wrap").addClass("u-videoAlert"),e.show(),!1):(e.set({message:a.i18n.t("compose/nosnddev")},t.compile(n,{})),e.$(".u-dialog-wrap").addClass("u-videoAlert"),e.show(),!1):0===r?(e.set({message:a.i18n.t("compose/novdodev")},t.compile(n,{})),e.$(".u-dialog-wrap").addClass("u-videoAlert"),e.show(),!1):!0},_initVdoDevice:function(){var e=this,t=e.$(".select_vdo_snd_dev")[0],n=e.$(".select_vdo_dev")[0],i=e._params.vdoRecorder.wavDeviceNum,r=e._params.vdoRecorder.capDeviceNum;e.$(".default_vdo_snd_dev").text(a.i18n.t("compose/default_dev")+"-"+e._params.vdoRecorder.wavDeviceDesc(0));for(var s=1;i>s;++s)t.options[s]=new Option(e._params.vdoRecorder.wavDeviceDesc(s),s);e.$(".default_vdo_dev").text(e._params.vdoRecorder.capDeviceDesc(0));for(var o=1;r>o;++o)n.options[s]=new Option(e._params.vdoRecorder.capDeviceDesc(o),o)},_vdoStart:function(){var e=this,t=e.$(".select_vdo_snd_dev"),n=e.$(".select_vdo_dev");e._params.vdoRecorder.init({size:2,recordtime:40,wavidx:parseInt(t.val()),capidx:parseInt(n.val())}),e._params.vdoRecorder.start(),e._changeVdoState("recording")},_vdoStop:function(){function e(){t._params.vdoRecorder.state===t._params.videoState.RecFinish?(t._params.vdoRecorder.compress(!0),t._changeVdoState("ready")):setTimeout(e,100)}var t=this;t._params.vdoRecorder.stop(),setTimeout(e,100)},_vdoReplay:function(){var e=this,t=e.$(".video-upload"),n=t.find(".vdoStateID"),i=t.find(".MediaRePlayer1");return"replaying"!==n.val()?(e._params.vdoRecorder.stop(),e._params.vdoRecorder.state===e._params.videoState.Initializing?(r.alert(a.i18n.t("compose/no_file_record")),!1):e._params.vdoRecorder.state===e._params.videoState.ComFinish?(e._changeVdoState("replaying"),setTimeout(function(){e._funReplay(i[0],e._params.vdoRecorder.filename)},100),!0):(r.alert(a.i18n.t("compose/msg_opsTooFrequent")),!1)):(e._changeVdoState("ready"),void i.stop())},_vdoUpload:function(){var e=this;if(e._params.vdoRecorder.state===e._params.videoState.Initializing)return alert(a.i18n.t("compose/no_file_record")),!1;if(e._params.vdoRecorder.state===e._params.videoState.ComFinish){if(e._params.vdoRecorder.filename){var t=e._params.vdoRecorder.upload();e.get("uploader").attachupload("pluginAdd",t),e.hide()}return!0}alert(a.i18n.t("compose/msg_opsTooFrequent")),e._vdoCancel()},_vdoCancel:function(){var e=this;e._params.vdoRecorder.closeAll(),e.hide()},_changeVdoState:function(e){var t=this.$(".video-upload"),n=t.find(".vdoStartRec"),i=t.find(".vdoStopRec"),r=t.find(".vdoReplayInfo"),s=t.find(".vdoUploadRec"),o=t.find(".vdoCancelRec"),l=t.find(".vdoStateID"),c=t.find(".vdoReplayPos"),d=this.$(".vdoStateDesc");l.val(e),n.attr("disabled","recording"===e||"replaying"===e),i.attr("disabled","ready"===e||"replaying"===e),r.attr("disabled","recording"===e),r.val("replaying"===e?a.i18n.t("compose/btn_cancel_play"):a.i18n.t("compose/btn_play")),c[0].style.display="replaying"===e?"":"none",s.attr("disabled","recording"===e||"replaying"===e),o.attr("disabled","recording"===e||"replaying"===e),d.html(a.i18n.t("compose/"+e))},_funReplay:function(e,t){e.valid?e.play1(t):r.alert("Browser not support replay!")},_dispatcher:function(e){var t=this,n=e.data("action");switch(n){case"rec":this._vdoStart();break;case"stop":t._vdoStop();break;case"play":t._vdoReplay()}}});return s}),define("components/requirejs-text/text!component/../../template/component/mailPreview.tpl.html",[],function(){return'<div class="m-mail-preview">\r\n  <div class="preview-header">\r\n      <div class="preview-status">\r\n        <span class="j-preview-total"></span>\r\n        <div class="preview-btns j-toolbar-pagination"></div>\r\n      </div>\r\n  </div>\r\n\r\n  <div class="preview-wrapper m-read j-preview-container">\r\n    <div class="j-mail-headers f-pr"></div>\r\n    <div class="mail-content">\r\n      <iframe width="100%" scrolling="no" src="jsp/mailPreview.jsp" frameborder="0" allowtransparency="true" name="previewFrame" id="mail-PreviewIframe"></iframe>\r\n    </div>\r\n    <div class="j-attachments"></div>\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <script type="x-handlebars-template" id="previewTpl">\r\n    <div class="mail-top">\r\n      <div class="top-bar">\r\n        <div class="f-tar f-vh">\r\n          <span class="mail-flagged f-pr f-csp" >\r\n            <i class="iconfont iconflat" title="[[i18n \'mbox/mail_flag_flagged_true\']]"></i>\r\n            <i class="iconfont icondown"></i>\r\n          </span>\r\n          <span class="f-pr f-csp">\r\n            <i class="iconfont iconclock"></i>\r\n          </span>\r\n          <a class="iconfont iconemailcontacts" href="#" title=\'[[i18n "mbox/mail_dealings"]]\'></a>\r\n          <a class="iconfont iconnewtab" href="#" title=\'[[i18n "mbox/mail_blank"]]\'></a>\r\n        </div>\r\n        <div class="f-tar">\r\n          <span>[[date]]</span>\r\n        </div>\r\n      </div>\r\n      <div class="mail-top-info">\r\n        <h3 class="mail-subject ">\r\n            <span class="icon"><i class="iconfont" ></i></span>\r\n            [[subject]]\r\n        </h3>\r\n        <div class="short-info j-short-info f-ellipsis" style="display: block;">\r\n          <a href="javascript:void(0);">[[from]]</a>\r\n          <span>[[i18n "mbox/send_to"]]</span>\r\n          <a href="javascript:void(0)">[[#unless previewTo]] [[to]] [[else]] [[previewTo]] [[/unless]]</a>\r\n        </div>\r\n\r\n        <div class="full-info j-full-info f-dn">\r\n          <table class="u-table u-table-row">\r\n            <tr>\r\n              <td class="info-item">[[i18n "mbox/mail_from"]] :</td>\r\n              <td>\r\n                <span class="u-email j-u-email">\r\n                  <span class="name">[[hemail from \'nameOnly\']]</span>\r\n                  <span class="address">[[hemail from \'addrWithQuote\']]</span>\r\n                </span>\r\n              </td>\r\n            </tr>\r\n            <tr>\r\n              <td class="info-item">[[#if showOneRcpt]] [[i18n "mail/mail_onercpt"]] [[else]] [[i18n "mbox/mail_to"]] [[/if]] :</td>\r\n              <td>\r\n                [[#unless previewTo]]\r\n                [[#each to]]\r\n                <span class="u-email j-u-email">\r\n                  <span class="name">[[hemail this \'nameOnly\']]</span>\r\n                  <span class="address">[[hemail this \'addrWithQuote\']]</span>\r\n                </span>\r\n                [[/each]]\r\n                [[else]]\r\n                <span class="u-email j-u-email">\r\n                  <span class="name">[[hemail previewTo \'nameOnly\']]</span>\r\n                  <span class="address">[[hemail previewTo \'addrWithQuote\']]</span>\r\n                </span>\r\n                [[/unless]]\r\n              </td>\r\n            </tr>\r\n            [[#if cc.length]]\r\n            <tr>\r\n              <td class="info-item">[[i18n "mbox/mail_cc"]] :</td>\r\n              <td>\r\n                [[#each cc]]\r\n                <span class="u-email j-u-email">\r\n                  <span class="name">[[hemail this \'nameOnly\']]</span>\r\n                  <span class="address">[[hemail this \'addrWithQuote\']]</span>\r\n                </span>\r\n                [[/each]]\r\n              </td>\r\n            </tr>\r\n            [[/if]]\r\n\r\n            [[#if bcc.length]]\r\n            <tr>\r\n              <td class="info-item">[[i18n "mbox/mail_bcc"]] :</td>\r\n              <td>\r\n                [[#each bcc]]\r\n                <span class="u-email j-u-email">\r\n                  <span class="name">[[hemail this \'nameOnly\']]</span>\r\n                  <span class="address">[[hemail this \'addrWithQuote\']]</span>\r\n                </span>\r\n                [[/each]]\r\n              </td>\r\n            </tr>\r\n            [[/if]]\r\n          </table>\r\n        </div>\r\n      </div>\r\n      <div class="mail-divider">\r\n        <a href="javascript:void(0)" class="u-btn u-btn-default u-btn-round f-fr j-toggle-info"><i class="iconfont icondown"></i></a>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <script id="attachTpl" type="text/x-handlebars-template">\r\n\r\n    [[#if containBothType]]\r\n    <div class="u-tab j-tab-wrap">\r\n      <ul class="attach-nav">\r\n        <li class="j-tab-trigger z-current"><a href="javascript:void(0)">[[i18n "mbox/mail_normalatt"]]([[attachments.length]] [[i18n "mail/attachments_number"]])</a></li>\r\n        <li class="j-tab-trigger"><a href="javascript:void(0)">[[i18n "mbox/mail_largeatt"]]([[trsAttachments.length]] [[i18n "mail/attachments_number"]])</a></li>\r\n      </ul>\r\n    </div>\r\n    [[else]]\r\n\r\n    [[#unless trsAttachments]]\r\n    <div class="attach-title">\r\n      <h3>[[i18n "mbox/mail_normalatt"]]([[attachments.length]] [[i18n "mail/attachments_number"]])</h3>\r\n    </div>\r\n    [[/unless]]\r\n\r\n    [[#unless attachments]]\r\n    <div class="attach-title">\r\n      <h3>[[i18n "mbox/mail_largeatt"]]([[trsAttachments.length]] [[i18n "mail/attachments_number"]])</h3>\r\n    </div>\r\n    [[/unless]]\r\n\r\n    [[/if]]\r\n\r\n\r\n    <!---->\r\n    <div class="attach-content">\r\n    [[#if attachments]]\r\n      <div id="attachments" class="j-tab-panels f-cf">\r\n        <div class="attach-tab-panels f-cf">\r\n          [[#each attachments]]\r\n          <div class="attachment f-fl">\r\n            <div class="attachment-item attach-type">\r\n              <span class="file-big-icon icon-big-[[GetFileIco displayName]]"></span>\r\n            </div>\r\n            <div class="attachment-item attach-name f-ellipsis">[[displayName]]</div>\r\n            <div class="attachment-item attach-size">[[bytesToSize size]]</div>\r\n          </div>\r\n          [[/each]]\r\n        </div>\r\n      </div>\r\n    [[/if]]\r\n\r\n    <!---->\r\n    [[#if trsAttachments]]\r\n    <div id="trsAttachments" class="j-tab-panels f-cf [[#if attachments.length]]f-dn[[/if]]">\r\n      [[#each trsAttachments]]\r\n      <div class="trsAttachment f-fl" attach-type="trsAttachments" attach-index=\'[[@index]]\'>\r\n        <div class="attachment-item attach-type">\r\n          <span class="file-big-icon icon-big-[[GetFileIco displayName]]"></span>\r\n        </div>\r\n        <div class="attachment-item attach-name f-ellipsis">[[displayName]]</div>\r\n        <div class="attachment-item attach-size">[[bytesToSize size]]</div>\r\n      </div>\r\n      [[/each]]\r\n    </div>\r\n    [[/if]]\r\n    </div>\r\n  </script>\r\n  {{/raw}}\r\n</div>'}),function(){"use strict";function e(){}function t(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function n(e){return function(){return this[e].apply(this,arguments)}}var i=e.prototype,a=this,r=a.EventEmitter;i.getListeners=function(e){var t,n,i=this._getEvents();if(e instanceof RegExp){t={};for(n in i)i.hasOwnProperty(n)&&e.test(n)&&(t[n]=i[n])}else t=i[e]||(i[e]=[]);return t},i.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},i.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&(t={},t[e]=n),t||n},i.addListener=function(e,n){var i,a=this.getListenersAsObject(e),r="object"==typeof n;for(i in a)a.hasOwnProperty(i)&&-1===t(a[i],n)&&a[i].push(r?n:{listener:n,once:!1});return this},i.on=n("addListener"),i.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},i.once=n("addOnceListener"),i.defineEvent=function(e){return this.getListeners(e),this},i.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},i.removeListener=function(e,n){var i,a,r=this.getListenersAsObject(e);for(a in r)r.hasOwnProperty(a)&&(i=t(r[a],n),-1!==i&&r[a].splice(i,1));return this},i.off=n("removeListener"),i.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},i.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},i.manipulateListeners=function(e,t,n){var i,a,r=e?this.removeListener:this.addListener,s=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(i=n.length;i--;)r.call(this,t,n[i]);else for(i in t)t.hasOwnProperty(i)&&(a=t[i])&&("function"==typeof a?r.call(this,i,a):s.call(this,i,a));return this},i.removeEvent=function(e){var t,n=typeof e,i=this._getEvents();if("string"===n)delete i[e];else if(e instanceof RegExp)for(t in i)i.hasOwnProperty(t)&&e.test(t)&&delete i[t];else delete this._events;return this},i.removeAllListeners=n("removeEvent"),i.emitEvent=function(e,t){var n,i,a,r,s,o=this.getListenersAsObject(e);for(r in o)if(o.hasOwnProperty(r))for(n=o[r].slice(0),a=n.length;a--;)i=n[a],i.once===!0&&this.removeListener(e,i.listener),s=i.listener.apply(this,t||[]),s===this._getOnceReturnValue()&&this.removeListener(e,i.listener);return this},i.trigger=n("emitEvent"),i.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},i.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},i._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},i._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return a.EventEmitter=r,e},"function"==typeof define&&define.amd?define("components/eventEmitter/EventEmitter",[],function(){return e}):"object"==typeof module&&module.exports?module.exports=e:a.EventEmitter=e}.call(this),function(e){function t(t){var n=e.event;return n.target=n.target||n.srcElement||t,n}var n=document.documentElement,i=function(){};n.addEventListener?i=function(e,t,n){e.addEventListener(t,n,!1)}:n.attachEvent&&(i=function(e,n,i){e[n+i]=i.handleEvent?function(){var n=t(e);i.handleEvent.call(i,n)}:function(){var n=t(e);i.call(e,n)},e.attachEvent("on"+n,e[n+i])});var a=function(){};n.removeEventListener?a=function(e,t,n){e.removeEventListener(t,n,!1)}:n.detachEvent&&(a=function(e,t,n){e.detachEvent("on"+t,e[t+n]);try{delete e[t+n]}catch(i){e[t+n]=void 0}});var r={bind:i,unbind:a};"function"==typeof define&&define.amd?define("components/eventie/eventie",r):"object"==typeof exports?module.exports=r:e.eventie=r}(window),function(e,t){"use strict";"function"==typeof define&&define.amd?define("components/imagesloaded/imagesloaded",["../eventEmitter/EventEmitter","../eventie/eventie"],function(n,i){return t(e,n,i)}):"object"==typeof module&&module.exports?module.exports=t(e,require("wolfy87-eventemitter"),require("eventie")):e.imagesLoaded=t(e,e.EventEmitter,e.eventie)}(window,function(e,t,n){function i(e,t){for(var n in t)e[n]=t[n];return e}function a(e){return"[object Array]"==u.call(e)}function r(e){var t=[];if(a(e))t=e;else if("number"==typeof e.length)for(var n=0;n<e.length;n++)t.push(e[n]);else t.push(e);return t}function s(e,t,n){if(!(this instanceof s))return new s(e,t,n);"string"==typeof e&&(e=document.querySelectorAll(e)),this.elements=r(e),this.options=i({},this.options),"function"==typeof t?n=t:i(this.options,t),n&&this.on("always",n),this.getImages(),c&&(this.jqDeferred=new c.Deferred);var a=this;setTimeout(function(){a.check()})}function o(e){this.img=e}function l(e,t){this.url=e,this.element=t,this.img=new Image}var c=e.jQuery,d=e.console,u=Object.prototype.toString;s.prototype=new t,s.prototype.options={},s.prototype.getImages=function(){this.images=[];for(var e=0;e<this.elements.length;e++){var t=this.elements[e];this.addElementImages(t)}},s.prototype.addElementImages=function(e){"IMG"==e.nodeName&&this.addImage(e),this.options.background===!0&&this.addElementBackgroundImages(e);var t=e.nodeType;if(t&&p[t]){for(var n=e.querySelectorAll("img"),i=0;i<n.length;i++){var a=n[i];this.addImage(a)}if("string"==typeof this.options.background){var r=e.querySelectorAll(this.options.background);for(i=0;i<r.length;i++){var s=r[i];this.addElementBackgroundImages(s)}}}};var p={1:!0,9:!0,11:!0};s.prototype.addElementBackgroundImages=function(e){for(var t=m(e),n=/url\(['"]*([^'"\)]+)['"]*\)/gi,i=n.exec(t.backgroundImage);null!==i;){var a=i&&i[1];a&&this.addBackground(a,e),i=n.exec(t.backgroundImage)}};var m=e.getComputedStyle||function(e){return e.currentStyle};return s.prototype.addImage=function(e){var t=new o(e);this.images.push(t)},s.prototype.addBackground=function(e,t){var n=new l(e,t);this.images.push(n)},s.prototype.check=function(){function e(e,n,i){setTimeout(function(){t.progress(e,n,i)})}var t=this;if(this.progressedCount=0,this.hasAnyBroken=!1,!this.images.length)return void this.complete();for(var n=0;n<this.images.length;n++){var i=this.images[n];i.once("progress",e),i.check()}},s.prototype.progress=function(e,t,n){this.progressedCount++,this.hasAnyBroken=this.hasAnyBroken||!e.isLoaded,this.emit("progress",this,e,t),this.jqDeferred&&this.jqDeferred.notify&&this.jqDeferred.notify(this,e),this.progressedCount==this.images.length&&this.complete(),this.options.debug&&d&&d.log("progress: "+n,e,t)},s.prototype.complete=function(){var e=this.hasAnyBroken?"fail":"done";if(this.isComplete=!0,this.emit(e,this),this.emit("always",this),this.jqDeferred){var t=this.hasAnyBroken?"reject":"resolve";this.jqDeferred[t](this)}},o.prototype=new t,o.prototype.check=function(){var e=this.getIsImageComplete();return e?void this.confirm(0!==this.img.naturalWidth,"naturalWidth"):(this.proxyImage=new Image,n.bind(this.proxyImage,"load",this),n.bind(this.proxyImage,"error",this),n.bind(this.img,"load",this),n.bind(this.img,"error",this),void(this.proxyImage.src=this.img.src))},o.prototype.getIsImageComplete=function(){return this.img.complete&&void 0!==this.img.naturalWidth},o.prototype.confirm=function(e,t){this.isLoaded=e,this.emit("progress",this,this.img,t)},o.prototype.handleEvent=function(e){var t="on"+e.type;this[t]&&this[t](e)},o.prototype.onload=function(){this.confirm(!0,"onload"),this.unbindEvents()},o.prototype.onerror=function(){this.confirm(!1,"onerror"),this.unbindEvents()},o.prototype.unbindEvents=function(){n.unbind(this.proxyImage,"load",this),n.unbind(this.proxyImage,"error",this),n.unbind(this.img,"load",this),n.unbind(this.img,"error",this)},l.prototype=new o,l.prototype.check=function(){n.bind(this.img,"load",this),n.bind(this.img,"error",this),this.img.src=this.url;var e=this.getIsImageComplete();e&&(this.confirm(0!==this.img.naturalWidth,"naturalWidth"),this.unbindEvents())},l.prototype.unbindEvents=function(){n.unbind(this.img,"load",this),n.unbind(this.img,"error",this)},l.prototype.confirm=function(e,t){this.isLoaded=e,this.emit("progress",this,this.element,t)},s.makeJQueryPlugin=function(t){t=t||e.jQuery,t&&(c=t,c.fn.imagesLoaded=function(e,t){var n=new s(this,e,t);return n.jqDeferred.promise(c(this))})},s.makeJQueryPlugin(),s}),define("component/mailPreviewBox",["require","i18n!mail,common","widget/pagination/pagination","jquery","handlebars","../util/index","cui/ui/dialog/confirmbox","../module/common/globalService","cui/core/events/pubsub","cui/ui/switchable/tabs","text!../../template/component/mailPreview.tpl.html","moment","imagesloaded"],function(e){function t(e){var t=n.Deferred();return e=e||{},a.xhr.simpleCall({query:{func:"mbox:tplComposePreview",sid:s.getSid()},data:e},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}e("i18n!mail,common"),e("widget/pagination/pagination");var n=e("jquery"),i=e("handlebars"),a=e("../util/index"),r=e("cui/ui/dialog/confirmbox"),s=e("../module/common/globalService"),o=e("cui/core/events/pubsub"),l=e("cui/ui/switchable/tabs"),c=e("text!../../template/component/mailPreview.tpl.html"),d=e("moment"),u=e("imagesloaded"),p=a.i18n,m=r.extend({attrs:{title:p.t("mail/lbl_template_preview"),message:i.compile(c)({}),closeTpl:'<span class="iconfont icontabclose"></span>',confirmTpl:a.i18n.t("common/confirm"),cancelTpl:"",width:"800",height:"600",pagination:null,filterLinks:!1,filterImages:!1,composeInfo:null,keyForRcpts:"",baseRequestParams:{},basePreviewInfo:{},varList:[],frameLoaded:!1,toggleDetail:!1,pageEntity:{total:1,limit:1,currentPage:0},onClose:function(){this.hide(),this.destroy()},onConfirm:function(){this.hide(),this.destroy()}},templateHelpers:{GetFileIco:function(e){return e?a.file.formatFileType(e):""},bytesToSize:function(e){return e?a.size.bytesToSize(e,2):""}},events:{"click .j-toggle-info":"_handleToggleDetail"},setup:function(){var e=this,t=this.get("composeInfo");if(m.superclass.setup.call(this),this.cPubsub=new o("component.previewBox"),this._initModuleEvent(),t.varList&&t.varList.length>0){var i=t.varKeyForRcpt,a=n.map(t.varList,function(e){return e[i]}),r=[];n.each(t.to,function(e,s){-1!==n.inArray(s,a)&&r.push(n.grep(t.varList,function(e){return e[i]===s})[0])}),0!==r.length&&(t.varList=r,this.set("keyForRcpts",i),this.set("varList",t.varList),this.set("pageEntity",{total:t.varList.length},{silent:!0}),this.set("baseRequestParams",{filterLinks:this.get("filterLinks"),filterImages:this.get("filterImages"),isHtml:t.isHtml,template:t.content}))}this.set("basePreviewInfo",{subject:t.subject,from:t.account,to:t.to,cc:t.cc,bcc:t.bcc,attachments:t.attachments,date:d().format("YYYY-MM-DD, HH:mm:ss"),mailContent:t.content,showOneRcpt:t.showOneRcpt,isHtml:t.isHtml}),this.after("render",function(){e.element.addClass("u-preview-box")}),this.after("hide",function(){e.destroy()})},render:function(){m.superclass.render.call(this),this._fetchData(),this._initPagination()},destroy:function(){this.cPubsub.offMessage(),m.superclass.destroy.call(this)},_initModuleEvent:function(){var e=this;this.cPubsub.onMessage("preview:loaded",function(){e.set("frameLoaded",!0)},null)},_fetchData:function(e){var i=this.get("varList"),a=this;if(e=e||0,0===i.length)a._generatePreview();else{var r=this.get("keyForRcpts"),s=n.extend(this.get("baseRequestParams"),{"var":i[e]});t(s).then(function(e){a._generatePreview(e,s["var"][r])})}},_generatePreview:function(e,t){var i,a=this.get("basePreviewInfo"),r=this.$("#previewTpl").html(),s=this;if(e=e||a.mailContent,this.$(".j-mail-headers").html(this.compile(r,n.extend(a,{previewTo:t}))),this.$(".j-preview-container").scroll(function(e){s.$(".j-mail-headers").css({left:n(e.target).scrollLeft()})}),a.attachments.length>0){var o=n.grep(a.attachments,function(e){return("boolean"==typeof e.deleted?!e.deleted:!0)&&"trs"!=e.type}),c=n.grep(a.attachments,function(e){return("boolean"==typeof e.deleted?!e.deleted:!0)&&"trs"==e.type}),d=o.length>0&&c.length>0;(o.length>0||c.length>0)&&(i=this.$("#attachTpl").html(),this.$(".j-attachments").html(this.compile(i,{attachments:o,trsAttachments:c,containBothType:d})),d&&new l({element:this.$(".j-tab-wrap"),triggers:this.$(".j-tab-trigger"),panels:this.$(".j-tab-panels"),activeIndex:0,triggerType:"click",activeTriggerClass:"z-current"}))}a.isHtml||(e='<pre style="word-wrap:break-word;" wrap="soft">'+e+"</pre>"),this.set("compiledHTML",e),this.get("frameLoaded")&&this._injectToFrame()},_injectToFrame:function(){var e=this.get("compiledHTML"),t=this.$("#mail-PreviewIframe")[0];n(t.contentDocument.body).html(e),t.contentWindow.postMessage("resize",location.protocol+"//"+location.host),/<img\b[^>]+>/.test(e)&&(u.makeJQueryPlugin(n),n(t.contentDocument.body).imagesLoaded().done(function(){t.contentWindow.postMessage("resize",location.protocol+"//"+location.host)}))},_initPagination:function(){var e=this,t=this.get("pageEntity");this.$(".j-preview-total").html(p.t("mail/lbl_preview_total",{total:t.total})),this.$(".j-toolbar-pagination").pagination({total:t.total,limit:t.limit,currentPage:t.currentPage,round:!0,prevText:p.t("common/op_prevmail"),nextText:p.t("common/op_nextmail"),menu:!0,callback:function(t){e._fetchData(t)}})},_handleToggleDetail:function(){var e=this.get("toggleDetail");this.$(".j-short-info").toggle(),this.$(".j-full-info").toggle(),this.$(".j-toggle-info").html(e?'<i class="iconfont icondown"></i>':'<i class="iconfont iconup"></i>'),this.set("toggleDetail",!e)},_onChangeFrameLoaded:function(){this._injectToFrame()}});return m}),define("module/mail/compose/smsnotify",["require","jquery","handlebars","../../../util/index","module/common/globalService","module/contact/service","../../../component/confirmbox"],function(e){var t=e("jquery"),n=e("handlebars"),i=e("../../../util/index"),a=i.Email,r=i.i18n,s=e("module/common/globalService"),o=e("module/contact/service"),l=e("../../../component/confirmbox"),c=!0,d=function(e){var n,i,a={},r=[];if("array"!==t.type(e))return r;
for(n=e.length-1;n>=0;n--)i=e[n],a.hasOwnProperty(i)||(r.push(i),a[i]=1);return r},u=function(){var e=s.getConfig("user.sendmailwithsmsmode"),t=i.params.deserialize(e),n={};return n.scope=t.scope.split(","),n.needConfirm=!("undefined"!=typeof t.mobilenumbertip&&"0"==t.mobilenumbertip),n},p=function(e,n){var i,r=[],s=e.$(".j-form-tt");return t.each(n,function(e,t){var n=s.find("input[name="+t+"]");n.length>0&&r.push(n.val())}),i=t.grep(a.parse(r.join(",")),function(e){return e.address&&e.address.length>0})},m=function(e){var n=c?[h,f]:[f,h],i=[],a={},r=[],s=t.Deferred(),o=function(){return s.resolve(a,r)};return"array"!==t.type(e)||e.length<=0?o():(i=t.map(e,function(e){return e.address}),t.when(n[0](i)).then(function(e){var s=[],l={};t.isEmptyObject(e)?s=i:(t.each(i,function(t,n){e.hasOwnProperty(n)||s.push(n)}),t.each(e,function(e,t){t?l[e]=t:s.push(e)}),t.extend(!0,a,l)),s.length<=0?o():t.when(n[1](s)).then(function(e){return t.isEmptyObject(e)?r=s:(t.each(s,function(t,n){e.hasOwnProperty(n)||r.push(n)}),t.extend(!0,a,e)),o()},function(){return o()})},function(){return o()}),s.promise())},h=function(e){var n=t.Deferred(),i={};return s.getConfig("user.supportpab")?"undefined"==typeof e?n.resolve(i):("array"!==t.type(e)&&(e=[e]),o.getPabContactsByEmail(e.join(",")).then(function(e){return t.each(e,function(e,t){return t?void(i[e]=t["TEL;CELL;VOICE"]):!0}),n.resolve(i)},function(){return n.resolve(i)}),n.promise()):n.resolve(i)},f=function(e){var n=t.Deferred(),i={};return s.getConfig("user.supportoab")?"undefined"==typeof e?n.resolve(i):("array"!==t.type(e)&&(e=[e]),t.when(o.getOabAttrs(e.join(","),["@id","email","mobile_number"])).then(function(e){return t.each(e,function(e,t){return t?void(i[t.email]=t.mobile_number):!0}),n.resolve(i)},function(){return n.resolve(i)}),n.promise()):n.resolve(i)},v=function(e,i,a){var s=-1,o='<div class="j-sms-list" style="position:relative;"><div class="tableHead"><table class="u-table" style="font-size:13px;"><thead style="background-color:#f0f0f0;"><tr><th style="padding:6px;border: none;"><span>{{i18n "contact/lbl_emailaddr"}}</span></th><th style="padding:6px;border: none;"><span>{{i18n "contact/lbl_mobile"}}</span></th></tr></thead></table></div><div class="j-list u-list u-scroll" style="max-height:290px;margin-bottom:6px;"><table class="u-table" style="font-size:13px;text-align:center;"><tbody>{{#each smsMaps}}<tr><td style="padding:6px;border:1px solid #ddd;border-width:0 0 1px;">{{@key}}</td><td style="padding:6px;border:1px solid #ddd;border-width:0 0 1px;"><input value="{{this}}" data-email="{{@key}}" class="j-input" style="text-align: center;" /></td> </tr>{{/each}}{{#each unMatchAddress}}<tr><td style="padding:6px;border:1px solid #ddd;border-width:0 0 1px;">{{this}}</td><td style="padding:6px;border:1px solid #ddd;border-width:0 0 1px;"><input value="" data-email="{{this}}" class="j-input" style="text-align: center;" /></td> </tr>{{/each}}</tbody></table></div><p class="error j-error" style="font-size:14px;color:#E15051;line-height:1.5;"></p></div>',c=n.compile(o)({smsMaps:e,unMatchAddress:i}),d=function(e){var n=/^[0-9]+$/,i=!0,a={maps:{},blank:[]};return e.each(function(){var e=t(this),r=e.val(),s=e.data("email");if(r.length<=0)a.blank.push(s);else{if(!n.test(r))return i=!1,!1;a.maps[s]=r}}),i?a:!1},u=function(){var e=this.$('[data-role="message"] .j-sms-list').eq(0),t=e.find(".j-input"),n=e.find(".j-error"),i=r.t("mail/msg_sendMailWithSms_error"),o=d(t);o?(clearTimeout(s),a(!0,o.maps,o.blank),this.hide()):(n.html(i),clearTimeout(s),s=setTimeout(function(){n.html("")},3e3))},p=function(){a(!1),this.hide()};"function"!==t.type(a)&&(a=t.noop),l.confirm(c,t.noop,t.noop,{title:r.t("mail/msg_sendMailWithSms_to"),onConfirm:u,onCancel:p})},g=function(e,n){var i,a;return e?(!n&&(n=t.noop),i=u(),a=p(e,i.scope),void m(a).then(function(e,a){var r=/^[0-9]+$/,s={},o=[];if(i.needConfirm){if(t.isEmptyObject(e)&&0===a.length)return n(!0,s,o);v(e,d(a),function(e){e?(t.extend(!0,s,arguments[1]),o=o.concat(arguments[2]),n(!0,s,o)):n(!1)})}else t.each(e,function(e,t){t&&r.test(t)?s[e]=t:o.push(e)}),o=o.concat(a),n(!0,s,d(o))})):!1};return{initSmsNumber:g}}),define("component/verifycodedg",["require","exports","module","i18n!main,mail","jquery","util/index","cui/ui/dialog/confirmbox","module/mail/compose/service","../module/common/globalService"],function(e,t,n){function i(e){var t=c.FAILED_CODE_PROPERTIES[e];return t?a.i18n.t(t):e}e("i18n!main,mail");var a=(e("jquery"),e("util/index")),r=e("cui/ui/dialog/confirmbox"),s=e("module/mail/compose/service"),o=e("../module/common/globalService"),l='<div class="u-verifycode"><form class="u-form j-vc-form" onsubmit="return false"><input name="action" type="hidden" value="deliver"/><input name="id" type="hidden" value="{{composeId}}"/><input name="returnInfo" type="hidden" value="true"/><p class="j-vc-tip">{{msgTip}}</p><div><label>{{label}}</label><input type="text" name="verifyCode" class="u-input j-vc-input"/><img alt="image" class="j-vc-image"/><a href="javascript:;" class="j-vc-refresh">{{refreshTxt}}</a></div></form></div>',c=r.extend({attrs:{composeId:null,callback:function(){}},Statics:{FAILED_CODE_PROPERTIES:{FA_NEED_VERIFY_CODE:"mail/lbl_antispam_needVerifyCode",FA_INVALID_VERIFY_CODE:"mail/lbl_antispam_wrongVerifyCode"}},events:{"click .j-vc-refresh":"_doUpdateVerifyCode"},setup:function(){var e=this;e.set("title",a.i18n.t("main/sys_info")),e.set("message",e.compile(l,{msgTip:a.i18n.t("mail/lbl_antispam_needVerifyCode"),label:a.i18n.t("mail/lbl_antispam_hint"),refreshTxt:a.i18n.t("mail/lbl_antispam_refreshTxt"),composeId:e.get("composeId")})),c.superclass.setup.call(this),e.on("confirm",function(){e._doReCompose()}),e.on("cancel",function(){e.destroy()})},render:function(){c.superclass.render.call(this),this.show(),this._doUpdateVerifyCode()},destroy:function(){c.superclass.destroy.call(this)},_doUpdateVerifyCode:function(){var e="/coremail/displayVerifyCode.jsp?category=compose&sid={0}&random={1}",t=parseInt(1e10*Math.random());this.$(".j-vc-image").attr("src",a.messageFormat.format(e,[o.getSid(),t]))},_doReCompose:function(){var e=this,t=e.$(".j-vc-form").serializeJSON({parseBooleans:!0});s.sendMail(t).done(function(t){e.get("callback")(t),e.destroy()}).fail(function(t){var n=(t||{}).code||"";e.$(".j-vc-tip").html(i(n)),e.$(".j-vc-input").val(""),e._doUpdateVerifyCode()})}});n.exports=c}),define("components/requirejs-text/text!template/module/mail/compose.tpl.html",[],function(){return'<div class="m-mlcompose">\r\n\r\n    {{#raw}}\r\n    <script id="plgtiptpl" type="text/x-handlebars-template">\r\n        <div class="u-alert u-alert-warning u-alert-dismissible plgtip j-plgtip" style="display: none;">\r\n            <span class="close iconfont icondelword j-close"></span>\r\n            <span class="cnt j-cnt">{{{i18n \'common/upload_plugin_install\'}}}</span>\r\n        </div>\r\n    </script>\r\n\r\n    <script id="toolbartpl" type="text/x-handlebars-template">\r\n      <div class="toolbar j-toolbar">\r\n        <span class="u-btn u-btn-default f-fr aside-toggle" data-type="aside"><i class="iconfont iconnext"></i></span>\r\n        <span class="u-btn u-btn-primary f-mgr j-tbl-send" data-type="send">[[i18n \'compose/lbt_send\']]</span>\r\n        <span class="u-btn u-btn-default" data-type="preview">[[i18n \'compose/htmltool_preview\']]</span>\r\n\r\n        [[#if config.enableSaveDraft]]\r\n        <span class="u-btn u-btn-default j-tbl-draft" data-type="draft">[[i18n \'compose/lbt_compose_save\']]</span>\r\n        [[/if]]\r\n\r\n        <span class="u-btn u-btn-default j-tbl-cancel" data-type="cancel">[[i18n \'compose/lbt_compose_cancel\']]</span>\r\n      </div>\r\n    </script>\r\n\r\n    <script id="maintpl" type="text/x-handlebars-template">\r\n        <div class="main j-main"></div>\r\n    </script>\r\n\r\n    <script id="sidebartpl" type="text/x-handlebars-template">\r\n        <div class="mn-aside j-aside">\r\n            <div class="u-tab u-tab-highlight-down [[#if enableMailTemplate]] u-tab-three-items [[/if]]">\r\n                <ul data-role="nav">\r\n                    <li class="z-current"><span class="bar"></span><a href="javascript:void(0);">[[i18n \'contact/tab_pab\']]</a></li>\r\n                    <li class="stationery"><span class="bar"></span><a href="javascript:void(0);">[[i18n \'main/stationery\']]</a></li>\r\n                    [[#if enableMailTemplate]]\r\n                    <li class="template"><span class="bar"></span><a href="javascript:void(0);">[[i18n \'mail/lbl_template\']]</a></li>\r\n                    [[/if]]\r\n                </ul>\r\n            </div>\r\n            <div class="content-wrapper">\r\n                <!---->\r\n                <div class="sidebar-content" data-role="panel">\r\n                    <div class="u-input-control">\r\n                        <input type="text" class="u-input u-input-round" id="searchInput" placeholder="[[i18n \'main/g_search\']]">\r\n                        <span class="iconfont iconsreachm"></span>\r\n                        <span class="iconfont icontabclose close"></span>\r\n                    </div>\r\n                    <div class="wrapper-container u-scroll">\r\n                        <div id="mptree"></div>\r\n                        <div class="contacts-wrapper f-dn" id="searchResultContainer">\r\n                            <ul class="expand"></ul>\r\n                            <div class="u-divider"></div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <!---->\r\n                <div class="sidebar-content j-stationery stationery-wrapper disabled" data-role="panel">\r\n                    <div class="stationery-disableTxt">[[i18n \'compose/stationery_disable\']]</div>\r\n                    <div class="stationery-mask"></div>\r\n                    <div class="j-stationery-pagination pagination"></div>\r\n                </div>\r\n                [[#if enableMailTemplate]]\r\n                <!---->\r\n                <div class="sidebar-content j-template template-wrapper disabled" data-role="panel">\r\n                  <div class="j-template-box"></div>\r\n                  <div class="j-template-pagination pagination"></div>\r\n                </div>\r\n                [[/if]]\r\n            </div>\r\n        </div>\r\n    </script>\r\n\r\n    <script id="formtpl" type="text/x-handlebars-template">\r\n        <form action="" method="post" class="u-form mn-form j-form">\r\n            <div class="form-tt j-form-tt">\r\n                <div class="u-form-item j-all-email">\r\n                    <ul class="u-list u-list-horizontal color f-fr j-ft-contact">\r\n                        <li>\r\n                            <a href="javascript:void(0)" data-type="cc" class="z-active">[[i18n \'mail/mail_uncc\']]</a>\r\n                        </li>\r\n                        <li>|</li>\r\n                        <li>\r\n                            [[#if bcc]]\r\n                            <a href="javascript:void(0);" data-type="bcc" class="z-active">[[i18n \'mail/mail_unbcc\']]</a>\r\n                            [[else]]\r\n                            <a href="javascript:void(0);" data-type="bcc">[[i18n \'mail/mail_bcc\']]</a>\r\n                            [[/if]]\r\n                        </li>\r\n                        [[#if config.enableShowOneRcpt]]\r\n                        <li>|</li>\r\n                        <li class="mgrn"><a href="javascript:void(0);" data-type="onercpt">[[i18n \'mail/mail_onercpt\']]</a></li>\r\n                        [[/if]]\r\n                    </ul>\r\n\r\n                    <label class="u-form-label">\r\n                      <span class="f-pd">[[i18n \'compose/lbt_from\']]</span>\r\n                    </label>\r\n                    [[#if accounts]]\r\n                    <select name="from" class="j-accounts">\r\n                        [[#each accounts]]\r\n                          [[#if ../draftId]]\r\n                          <option value="[[email]]" [[#compare email \'==\' ../../from]] selected [[/compare]]>[[email]] &nbsp;&nbsp;</option>\r\n                          [[else]]\r\n                          <option value="[[email]]" [[#compare addr \'==\' ../../defaultAccount]] selected [[/compare]]>[[email]] &nbsp;&nbsp;</option>\r\n                          [[/if]]\r\n                        [[/each]]\r\n                    </select>\r\n                    [[else]]\r\n                    <div class="u-sender">\r\n                        <span class="name">[[hemail from \'nameOnly\']]</span>\r\n                        <span class="address">[[hemail from \'addrWithQuote\']]</span>\r\n                    </div>\r\n                  [[/if]]\r\n                </div>\r\n\r\n                <div class="u-form-item border border-dark j-form-item-to">\r\n                    <span class="bar bar-left"></span>\r\n                    <label class="u-form-label"><a href="javascript:void(0);" [[#if embedCompose]]disabled[[/if]] class="link"\r\n                      [[#if config.enableModifySendTo]]contact="to"[[/if]] >[[i18n \'compose/lbt_to\']]</a></label>\r\n                    <input type="text" role="contact" name="to" value="[[formatTo]]"/>\r\n                    <span class="bar bar-right"></span>\r\n                </div>\r\n                <div class="u-form-item border j-form-item-cc">\r\n                    <span class="bar bar-left"></span>\r\n                    <label class="u-form-label"><a href="javascript:void(0);" class="link" [[#if embedCompose]]disabled[[/if]]\r\n                      [[#if config.enableModifySendTo]]contact="cc"[[/if]] >[[i18n \'compose/lbt_cc\']]</a></label>\r\n                    <input type="text" role="contact" name="cc" value="[[formatCc]]"/>\r\n                    <span class="bar bar-right"></span>\r\n                </div>\r\n                <div class="u-form-item border [[#unless bcc]]f-dn[[/unless]] j-form-item-bcc">\r\n                    <span class="bar bar-left"></span>\r\n                    <label class="u-form-label"><a href="javascript:void(0);" class="link" [[#if embedCompose]]disabled[[/if]]\r\n                      [[#if config.enableModifySendTo]]contact="bcc"[[/if]] >[[i18n \'compose/lbt_bcc\']]</a></label>\r\n                    <input type="text" role="contact" name="bcc" value="[[formatBcc]]"/>\r\n                    <span class="bar bar-right"></span>\r\n                </div>\r\n                <div class="u-form-item border">\r\n                    <span class="bar bar-left"></span>\r\n                    <label class="u-form-label"><span class="f-pd">[[i18n \'compose/lbt_subject\']]</span></label>\r\n                    <input type="text" class="input" name="subject" value="[[subject]]"/>\r\n                    <span class="bar bar-right"></span>\r\n                </div>\r\n                [[#if config.enableSecurityLevel]]\r\n                <div class="u-form-item border">\r\n                    <span class="bar bar-left"></span>\r\n                    <label class="u-form-label"><span class="f-pd">[[i18n \'mail/compose_security_level\']]</span></label>\r\n                    <select name="security_level" class="j-securityLevel">\r\n                        [[#each senderSecurityLevel.schema]]\r\n                        <option value="[[value]]" [[#compare ../../senderSecurityLevel.value \'==\' value]] selected [[/compare]]>[[name]] &nbsp;&nbsp;</option>\r\n                        [[/each]]\r\n                    </select>\r\n                    <span class="bar bar-right"></span>\r\n                </div>\r\n                [[/if]]\r\n                <div class="u-form-item-att border f-dn j-attachItem">\r\n                    <label class="u-form-label">\r\n                      <span class="f-pd">[[i18n \'compose/lb_attach\']]</span>\r\n                    </label>\r\n                    <div class="attachContainer j-attaches"></div>\r\n                    <div class="attach-summary j-attach-summary">\r\n                        <div class="attach-more j-attach-more">\r\n                            <span class="j-attach-info info"></span>\r\n                            <span class="j-attach-expand f-dn">\r\n                              <a href="javascript:void(0)" class="link j-attach-expand-link">[[i18n \'mail/compose_attach_expand\']]</a>\r\n                              <span class="j-attach-expand-desc expand-desc"></span>\r\n                            </span>\r\n                        </div>\r\n                        <div class="attach-less f-dn j-attach-less">\r\n                            <a href="javascript:void(0)" class="link j-attach-hide">[[i18n \'mail/compose_attach_hide\']]</a>\r\n                        </div>\r\n                    </div>\r\n                    <div class="u-alert u-alert-warning u-alert-dismissible attach-tips j-attach-tips f-dn">\r\n                      <span class="close iconfont icondelword j-close"></span>\r\n                      <span class="cnt j-cnt"></span>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class="f-cf j-ft-menu f-pr">\r\n                    <ul class="u-list u-list-horizontal f-fl j-attachment-menu">\r\n                        <li class="disabled-mask f-dn"></li>\r\n                        <li>\r\n                            <a href="javascript:void(0);" tabindex="-1" class="u-upload" data-type="upload">\r\n                                <i class="iconfont iconacc"></i>[[i18n \'compose/lbt_addattach_local\']]<span class="j-attachLimit"></span>\r\n                                <input type="file" name="attachments" id="attachments" multiple tabindex="-1"/>\r\n                            </a>\r\n                        </li>\r\n                        <li><a href="javascript:void(0);" tabindex="-1" data-type="attach"><i class="iconfont icondrop"></i></a></li>\r\n                    </ul>\r\n\r\n                    <ul class="u-list u-list-horizontal f-dn j-text-menu">\r\n                        <li>\r\n                            <a href="javascript:void(0);" tabindex="-1" data-type="signature">[[i18n \'compose/htmltool_Sign\']]\r\n                            <i class="iconfont icondrop"></i></a>\r\n                        </li>\r\n                        <li>\r\n                          <label class="u-import-source j-import-source-file" for="import_source_1_[[id]]">\r\n                            [[i18n \'mail/lbl_import_tpl_source\']]&nbsp;\r\n                            <input type="file" name="source" style="position: fixed; left: -9999px" id="import_source_1_[[id]]"/>\r\n                          </label>\r\n                        </li>\r\n                        <li class="f-fr mgr">\r\n                            <a href="javascript:void(0);" tabindex="-1" data-type="html">[[i18n \'mail/compose_html\']]</a>\r\n                        </li>\r\n                    </ul>\r\n\r\n                    <ul class="u-list u-list-horizontal j-html-menu">\r\n                        <li>\r\n                          <a href="javascript:void(0);" tabindex="-1" data-type="etbr" title="[[i18n \'mail/compose_toolbar\']]"><i class="iconfont iconword"></i></a>\r\n                        </li>\r\n                        <li>\r\n                          <a href="javascript:void(0);" tabindex="-1" data-type="link" title="[[i18n \'compose/htmltool_Url\']]"><i class="iconfont iconlink"></i></a>\r\n                        </li>\r\n                        <li>\r\n                          <a href="javascript:void(0);" tabindex="-1" data-type="screencapture" title="[[i18n \'compose/lbt_capture\']]"><i class="iconfont iconpiccut"></i></a>\r\n                        </li>\r\n                        <li>\r\n                          <a href="javascript:void(0);" tabindex="-1" data-type="image" title="[[i18n \'compose/lbt_picture\']]"><i class="iconfont iconpicture"></i></a>\r\n                        </li>\r\n                        <li>\r\n                          <a href="javascript:void(0);" tabindex="-1" data-type="more">[[i18n \'main/opt_more\']]<i class="iconfont icondrop"></i></a>\r\n                        </li>\r\n                        <li>\r\n                          <a href="javascript:void(0);" tabindex="-1" data-type="signature">[[i18n \'compose/htmltool_Sign\']]<i class="iconfont icondrop"></i></a>\r\n                        </li>\r\n                        <li><span data-type="attachuploaded"></span></li>\r\n                        <li>\r\n                          <label class="u-import-source j-import-source-file" for="import_source_2_[[id]]">\r\n                            [[i18n \'mail/lbl_import_tpl_source\']]&nbsp;\r\n                            <input type="file" name="source" style="position: fixed; right: -9999px" id="import_source_2_[[id]]"/>\r\n                          </label>\r\n                        </li>\r\n                        <li class="f-fr mgr">\r\n                          <a href="javascript:void(0);" tabindex="-1" data-type="text">[[i18n \'compose/lb_plaintext\']]</a>\r\n                        </li>\r\n                        <li class="f-fr">\r\n                          <a href="javascript:void(0);" tabindex="-1" data-type="typo" data-mode="mode_checkspelling">[[i18n \'compose/htmltool_spellcheck\']]</a>\r\n                        </li>\r\n                    </ul>\r\n\r\n                    <ul class="u-list u-list-horizontal expand f-ib">\r\n                        <li class="f-fr mgrn"><a href="javascript:void(0);" tabindex="-1" data-type="expand"><i class="iconfont iconenlarge"></i></a></li>\r\n                    </ul>\r\n\r\n                </div>\r\n            </div>\r\n\r\n            <div class="form-edr j-form-edr">\r\n                <textarea name="ml-editor" id="[[_editorid]]" class="editor"></textarea>\r\n\r\n                <div class="form-edr-dnd j-form-dnd f-dni"><div class="j-dnd-info">{{i18n \'mail/compose_dnd\'}}</div></div>\r\n            </div>\r\n            <div class="form-toolbar j-form-toolbar">\r\n              <!---->\r\n              [[#if config.supportSMIMEServer]]\r\n                <div>\r\n                  <ul class="u-list u-list-horizontal bt-hd">\r\n                    <li>\r\n                      <label title="[[i18n \'compose/lbt_smime_tips\']]">\r\n                        <input type="checkbox" data-category="coremaillEncrypt" data-type="smimeSign"/> [[i18n \'compose/lbt_sendMailWithSigned\']]\r\n                      </label>\r\n                    </li>\r\n                    <li>\r\n                      <label  title="[[i18n \'compose/lbt_smime_tips\']]">\r\n                        <input data-category="coremaillEncrypt" [[#if config.encryptedCheckedDefault]]checked[[/if]] type="checkbox" data-type="smimeEncrypt"/>\r\n                        [[i18n \'compose/lbt_sendMailWithEncrypted\']]\r\n                      </label>\r\n                    </li>\r\n                    <li>\r\n                      <select data-category="coremaillEncrypt" id="smimeEnvelopId" name="smimeEnvelopId" class="j-smime-envelop">\r\n                        <option value="">[[i18n \'compose/lbt_envelope_default\']]&nbsp;</option>\r\n                      </select>\r\n                    </li>\r\n                  </ul>\r\n                </div>\r\n              [[/if]]\r\n\r\n              [[#if config.supportSMIMEClient]]\r\n                <div>\r\n                  <ul class="u-list u-list-horizontal bt-hd">\r\n                    <li>\r\n                      <label title="[[i18n \'compose/lbt_smime_tips\']]"><input type="checkbox" data-type="cacompose" data-action="useCASign"/> [[i18n \'compose/lbt_sendMailWithSigned\']]</label>\r\n                    </li>\r\n                    <li>\r\n                      <label  title="[[i18n \'compose/lbt_smime_tips\']]"><input type="checkbox" data-type="cacompose" data-action="useCAEncrypt"/>  [[i18n \'compose/lbt_sendMailWithEncrypted\']]</label>\r\n                    </li>\r\n                  </ul>\r\n                </div>\r\n              [[/if]]\r\n                <div class="bt-hd-wrap">\r\n                  <ul class="u-list u-list-horizontal bt-hd">\r\n                    <li class="bt-hd-more bt-hd-more-show f-dn"><a href="javascript:void(0);"><i class="iconfont icondown"></i> [[i18n \'common/more\']]</a></li>\r\n                    <li class="bt-hd-more bt-hd-more-hide f-dn"><a href="javascript:void(0);"><i class="iconfont iconup"></i> [[i18n \'common/hide\']]</a></li>\r\n                    <li><label><input type="checkbox" data-type="savesent"/> [[i18n \'compose/lb_savetosend\']]</label></li>\r\n                    <li><label><input type="checkbox" data-type="urgent"/> [[i18n \'mail/lbl_urgent\']]</label></li>\r\n                    <li><label><input type="checkbox" data-type="rrr"/> [[i18n \'compose/lb_mdn\']]</label></li>\r\n                    <li><label><input type="checkbox" data-type="timesend"/> [[i18n \'compose/lbt_compose_timesend_set\']]</label></li>\r\n                    [[#if config.enableAutoDel]]\r\n                    <!---->\r\n                    <li><label><input type="checkbox" data-type="autodel"/>[[i18n \'compose/lb_autoDelMail\']]</label></li>\r\n                    [[/if]]\r\n                    [[#if config.enableMailCipher]]\r\n                    <!--    -->\r\n                    <li><label><input [[#if config.encryptedCheckedDefault]]disabled[[/if]] type="checkbox" data-type="mailcipher"/> [[i18n \'compose/lb_mail_cipher\']]</label></li>\r\n                    [[/if]]\r\n                    [[#if config.forbidDownload]]\r\n                    <li><label><input type="checkbox" data-type="forbidDownload"/> [[i18n \'compose/lb_mail_forbidDownload\']]</label></li>\r\n                    [[/if]]\r\n                    [[#if config.enableDeliverWithSms]]\r\n                    <li><label><input type="checkbox" data-type="sendMailWithSms"/> [[i18n \'compose/lbt_sendMailWithSms\']]</label></li>\r\n                    [[/if]]\r\n                  </ul>\r\n                </div>\r\n\r\n                <div class="bt-cnt">\r\n                  <div class="timesend j-tb-timesend f-dn"></div>\r\n                  <div class="mailcipher j-form-tb-mailcipher f-dn"></div>\r\n                  <div class="autodel j-tb-autodel f-dn"></div>\r\n                </div>\r\n            </div>\r\n        </form>\r\n    </script>\r\n\r\n    <script id="timesendtpl" type="text/x-handlebars-template">\r\n        <div class="j-time-select">[[[scheduleDateSelect]]]</div>\r\n        <p class="j-timesend-desc">[[[scheduleDate]]]</p>\r\n    </script>\r\n\r\n    <script id="mailciphertpl" type="text/x-handlebars-template">\r\n        <p class="desc">\r\n          <strong>[[i18n \'mail/lbl_cipher_h1\']]</strong>\r\n          <span>[[i18n \'mail/msg_cipher_h2\']]</span>\r\n        </p>\r\n        <div class="content f-cf">\r\n          <label class="f-fl" for="bt-mailcipher-password">[[i18n \'mail/lbl_cipher_password_label\']]</label>\r\n          <div class="f-fl content-form">\r\n              <div class="content-form-item">\r\n                <input type="text" class="u-input" id="bt-mailcipher-password" name="bt-mailcipher-password"  maxlength="[[config.mailCipherPassLen]]">&nbsp;\r\n                <span class="others">([[i18n \'prop:mail/msg_cipher_password_hint\' 0=config.mailCipherPassLen]])</span>\r\n              </div>\r\n              <div class="content-form-item">\r\n                <input type="checkbox" name="bt-mailcipher-savePassword" id="bt-mailcipher-savePassword"/>\r\n                <label for="bt-mailcipher-savePassword">[[i18n \'mail/msg_cipher_save_password_in_sent\']]</label>\r\n              </div>\r\n          </div>\r\n        </div>\r\n    </script>\r\n\r\n    <script id="autodeltpl" type="text/x-handlebars-template">\r\n        <p class="u-autodel-dec">\r\n            <span class="title">[[i18n \'compose/autoDelMail_h1\']]</span>\r\n            <span class="tips">[[i18n \'compose/autoDelMail_h2\']]</span>\r\n        </p>\r\n        <p class="u-autodel-set">\r\n            <label>[[i18n \'compose/autoDelMail_readtimes_label\']]</label>\r\n            <input type="text" name="autoDelReadLimit" class="u-input j-read-limit" value="1" maxlength="2" >\r\n            <span>[[i18n \'compose/autoDelMail_readtimes_hint\']]</span>\r\n        </p>\r\n        <p class="u-autodel-set">\r\n            <label>[[i18n \'compose/autoDelMail_deltime_label\']]</label>\r\n            [[[autoDelDateSelect]]]\r\n            <span>[[i18n \'compose/autoDelMail_deltime_hint\']]</span>\r\n        </p>\r\n    </script>\r\n\r\n    <script id="forwarddtpl" type="text/x-handlebars-template">\r\n        <div class="fwd-main">\r\n            <div class="fwd-title">[[i18n \'compose/lb_transmit_title\']]</div>\r\n            <div class="fwd-content">\r\n                <input type="text" class="u-input" name="bcc"/>\r\n            </div>\r\n            <div class="fwd-bottom j-toolbar">\r\n                <span class="u-btn u-btn-primary" data-type="forward">{{i18n \'compose/lbt_transmit_ok\'}}</span>\r\n                <span class="u-btn u-btn-default" data-type="forwardCancel">{{i18n \'compose/lbt_compose_cancel\'}}</span>\r\n            </div>\r\n        </div>\r\n    </script>\r\n\r\n    <script id="successtpl" type="text/x-handlebars-template">\r\n        <div class="suc-main u-scroll">\r\n            <div class="suc-title j-suc-title">\r\n                <div class="h2">\r\n                  <i class="iconfont iconpass"></i>\r\n                  [[#if scheduletime]]\r\n                    [[i18n \'mail/compose_scheduled_success\' date=scheduletime]]\r\n                  [[else]]\r\n                    [[i18n \'mail/compose_send_success\']]\r\n                  [[/if]]\r\n                </div>\r\n                [[#if status]]\r\n                <a href="javascript:void(0);" class="link" action="status">[[i18n \'mail/compose_show_status\']]</a>\r\n                [[#if config.supportRecallMail]]\r\n                <a href="javascript:void(0);" class="link" action="recall">[[i18n \'mail/compose_recall_mail\']]</a>\r\n                [[/if]]\r\n                [[/if]]\r\n                <a href="javascript:void(0);" class="link" action="checkSent">[[i18n \'mail/compose_check_sent\']]</a>\r\n            </div>\r\n            [[#if encryptPassword]]\r\n            <!--   -->\r\n            <div class="suc-content">\r\n              <div class="suc-mailcipher">\r\n                <p class="icon"><i class="iconfont iconlock"></i></p>\r\n                <p class="tips">\r\n                  [[[ i18n \'prop:compose/cipher_msg_send_tip_1\' 0=encryptPassword]]]\r\n                  <br/>\r\n                  [[ i18n \'compose/cipher_msg_send_tip_2\' ]]\r\n                </p>\r\n              </div>\r\n            </div>\r\n            [[/if]]\r\n            <div class="suc-content">\r\n                <div class="j-status-detail"></div>\r\n                <div class="j-contactlist cont"></div>\r\n                <div class="desc [[#if aftersend_saveaddr]]toggled[[/if]] j-autosave-desc f-dn">\r\n                  <p class="autosave">\r\n                    [[i18n \'mail/compose_save_contact\']]<a href="javascript:void(0);" class="link">[[i18n \'compose/msg_send_autoSave\']]</a>\r\n                  </p>\r\n                  <p class="no-autosave">\r\n                    [[i18n \'mail/compose_not_save_contact\']]<a href="javascript:void(0);" class="link">[[i18n \'compose/msg_send_notautoSave\']]</a>\r\n                  </p>\r\n                </div>\r\n            </div>\r\n            [[#if smsAddrs]]\r\n            <div class="suc-content">\r\n              <p class="suc-content-title">[[i18n \'mail/compose_sent_smsaddrs_title\']]</p>\r\n              <table class="u-table">\r\n                <tbody>\r\n                [[#each smsAddrs]]\r\n                <tr>\r\n                  <td class="f-ellipsis" title="[[@key]]([[this]])">\r\n                    <span>[[@key]]</span>\r\n                    <span class="mobile">([[this]])</span>\r\n                  </td>\r\n                </tr>\r\n                [[/each]]\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n            [[/if]]\r\n            <div class="suc-content">\r\n                <div class="more-action u-btns j-more-action">\r\n                  <a class="u-btn u-btn-default" data-type="back">{{i18n \'mail/compose_backtolist\'}}</a>\r\n                  [[#if config.enableCompose]]\r\n                  <a class="u-btn u-btn-primary" data-type="continue">{{i18n \'mail/compose_continue\'}}</a>\r\n                  [[/if]]\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="searchResultItem">\r\n        <li><a href="javascript:void(0)" title="[[matchText]]" data-addr="[[matchText]]">[[[matchPart]]]</a></li>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="autosavecontactlisttpl">\r\n      <p>\r\n        [[#compare contacts.length ">" 1]]<span>[[i18n \'compose/msg_send_groupmail\']]</span>[[/compare]]\r\n        [[#if aftersend_saveaddr]]<span>[[i18n \'compose/msg_send_addresslist_title\']]</span>[[/if]]\r\n      </p>\r\n\r\n      <table class="u-table">\r\n        <tbody>\r\n        [[#each contacts]]\r\n        <tr>\r\n          <td class="f-ellipsis" title="[[name]][[#if name]]&lt;[[to]]&gt;[[else]][[to]][[/if]]">\r\n            <span class="name">[[securityLevel]] [[name]]</span>\r\n            [[#if name]]\r\n            <span class="addr">&lt;[[addr]]&gt;</span>\r\n            [[else]]\r\n            <span class="addr">[[addr]]</span>\r\n            [[/if]]\r\n            [[#if isAutoSave]]\r\n            <span>([[i18n \'compose/msg_send_status_added\']])</span>\r\n            [[/if]]\r\n            [[#if isExist]]\r\n            <span class="addr">([[i18n \'compose/msg_send_status_exist\']])</span>\r\n            [[/if]]\r\n          </td>\r\n          <td class="f-tar">\r\n            <a href="javascript:void(0);" class="link" data-id="[[id]]" data-addr="[[addr]]" data-name="[[name]]">\r\n              [[#if id]][[i18n \'main/bt_edit\']][[else]][[i18n \'main/bt_add\']][[/if]]\r\n            </a>\r\n          </td>\r\n        </tr>\r\n        [[/each]]\r\n        </tbody>\r\n      </table>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="deliverystatustpl">\r\n      <table class="u-table">\r\n        <thead>\r\n        <tr>\r\n          <th>[[i18n \'compose/lbt_to\']]</th>\r\n          <th>[[i18n \'mail/compose_status\']]</th>\r\n        </tr>\r\n        </thead>\r\n        <tbody>\r\n        [[#each result]]\r\n        <tr>\r\n          <td class="f-ellipsis" title="[[to_name]][[#if to_name]]&lt;[[to]]&gt;[[else]][[to]][[/if]]">\r\n            <span class="name">[[to_name]]</span>\r\n            [[#if name]]\r\n            <span class="addr">&lt;[[to]]&gt;</span>\r\n            [[else]]\r\n            <span class="addr">[[to]]</span>\r\n            [[/if]]\r\n          </td>\r\n          <td>\r\n            <span>[[status]]</span>\r\n            <span class="time">([[time]])</span>\r\n          </td>\r\n        </tr>\r\n        [[/each]]\r\n        </tbody>\r\n      </table>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="contactsTpl">\r\n        [[#each groups]]\r\n        <div class="contacts-wrapper [[flag]]">\r\n            <div class="aWrapper">\r\n                <a href="javascript:void(0)" data-toggled title="[[title]]"><i class="iconfont [[#if expand]]icondown[[^]]iconright[[/if]]"></i>[[name]]</a>\r\n                <a href="javascript:void(0)" class="addToAddrField" data-trigger title="[[i18n \'contact/lbl_addContactsToAddressField\']]">([[count]])</a>\r\n            </div>\r\n            <ul class="[[#if expand]]expand toggled[[/if]]">\r\n                [[#each children]]\r\n                <li data-name="[[name]]" data-addr="[[emailaddr]]" title="[[emailaddr]]"><span>[[name]]</span></li>\r\n                [[/each]]\r\n            </ul>\r\n            [[#or flag @last]]\r\n            <div class="u-divider"></div>\r\n            [[/or]]\r\n        </div>\r\n        [[/each]]\r\n    </script>\r\n\r\n    <!---->\r\n    <script id="recallMailTpl" type="text/x-handlebars-template">\r\n      <div class="recall-wrap j-recall-wrap">\r\n        [[#if isConfirm ]]\r\n        <p class="j-recall-confirm">\r\n          [[i18n "mail/recall_todo"]]<br/>\r\n          [[i18n "mail/recall_detail"]]\r\n        </p>\r\n        [[/if]]\r\n        [[#if isFail]]\r\n        <p class="j-recall-fail">\r\n          [[ meta.recallFailReason ]]\r\n        </p>\r\n        [[/if]]\r\n        [[#if isSuccess]]\r\n        <div class="j-recall-success u-scroll" style="max-height:350px;">\r\n          <p>[[i18n "mail/recall_succ_message"]]</p>\r\n          <table class="u-table">\r\n            <tbody>\r\n            [[#each meta.recallData]]\r\n            <tr>\r\n              <td>[[emailAddress]]</td>\r\n              <td>[[recallMessage]]</td>\r\n            </tr>\r\n            [[/each]]\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n        [[/if]]\r\n      </div>\r\n    </script>\r\n\r\n    <!--  -->\r\n    <script id="pluginInstallTpl" type="text/x-handlebars-template">\r\n        <p style="font-size:16px"> [[[title]]] </p>\r\n        [[#if supportNPAPI]]\r\n        [[[i18n "mail/attach_error_tips"]]]\r\n        [[/if]]\r\n    </script>\r\n\r\n  <!-- CA   -->\r\n  <script id="CAattachTpl" type="text/x-handlebars-template">\r\n    [[#each items]]\r\n    <div class="u-fileupload">\r\n      <div class="icon j-icon"><i class="iconfont iconacc"></i></div>\r\n      <div class="name j-name" style="max-width: 600px">[[this.fileName]]</div>\r\n      <div class="info j-info"><i class="iconfont iconchoose"></i></div>\r\n      <div class="size j-size">[[this.size]]</div>\r\n      <div class="btns j-btns"><a href="javascript:void(0);" class="link j-delete-caattach" data-index="[[@index]]">[[i18n "common/delete"]]</a></div>\r\n      </div>\r\n    [[/each]]\r\n  </script>\r\n\r\n  <!-- CA   -->\r\n  <script id="CApluginInjectTpl" type="text/x-handlebars-template">\r\n    <div role="CAcomposePlugin">\r\n      <object classid="clsid:A996E48C-D3DC-4244-89F7-AFA33EC60679" id="oCAPICOM"></object>\r\n      <object type="application/x-cmplugin">\r\n        <param name="onload" value="pluginLoaded">\r\n      </object>\r\n    </div>\r\n  </script>\r\n\r\n  {{/raw}}\r\n\r\n\r\n</div>';
}),define("module/mail/compose/index",["require","jquery.ztree","i18n!compose,contact,mail,common","../../../component/contactac","../../../component/contactdg","../../../widget/tageditor/tageditor","../../../component/fileupload/attachupload-ui","../../../component/securityleveldg","jquery","moment","../../../dispatcher","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/select/select","../../../component/confirmbox","../../../component/editor/editor","../../../util/index","cui/ui/switchable/tabs","../../../component/fileupload/pasteUploadUtil","../../common/globalService","./service","../../setting/account/signature/service","../service","module/contact/service","../../setting/service","../../../component/filelistbox","../../../component/xnffilebox","../../../component/stationery/stationery","../../../component/mailTemplate","../../../component/voiceupload/voiceupload","../../../component/videoupload/videoupload","../../../component/mailPreviewBox","../../../configurable/index","../smime","./smsnotify","../../../component/verifycodedg","text!template/module/mail/compose.tpl.html"],function(e){function t(e){var t,n,i,a,r=e.$(".j-plgtip"),s=e.$(".j-toolbar"),o=e.$(".j-main"),l=o.find(".j-aside"),c=o.find(".j-form"),d=c.find(".j-form-tt"),u=c.find(".j-form-edr"),p=c.find(".j-form-toolbar");return t=o.data("size")||{},n={plgtipHeight:r.outerHeight(!0),toolbarHeight:s.outerHeight(!0),mainHeight:o.height(),formttHeight:d.outerHeight(!0),formedrHeight:u.outerHeight(!0),formedrWidth:u.width(),formtblHeight:p.outerHeight(!0)},(t.mainHeight!==n.mainHeight||t.formttHeight!==n.formttHeight||t.formtblHeight!==n.formtblHeight||t.formedrWidth!==n.formedrWidth)&&(i=Math.max(300,n.mainHeight-n.formttHeight-n.formtblHeight),a=n.formttHeight+n.formtblHeight+i,n.formedrHeight=i,u.css("height",i),l.css("height",a),c.css("height",a),o.data("size",n)),n}function n(e,t){var n=e.$(".j-form"),i=!0;switch(t){case"to":case"cc":case"bcc":n.find("input[role=contact]").each(function(){var e;return h(this).attr("name")===t?(e=h(this).val(),e=e&&e.split(/[,;]/),h.each(e,function(e,t){return C.Email.test(t)?i=!1:void 0}),!1):void 0});break;case"subject":i=!n.find("input[name=subject]").val();break;case"content":i=!e.get("editor").html()&&!n.find("#"+e._params.editorid).val()}return!i}function i(e,t){var n,i,a,r,o,l,c,d,u=e.$(".j-form"),p={_contacts:[],scheduleDate:null,encryptPassword:""},m={upload:[],trs:[]},f=e.config.supportSMIME,v=[];if(p.account=e._params.composeInfo.from,n=u.find(".j-accounts"),n.length>0&&(p.account=n.val()),u.find("input[role=contact]").each(function(){var t,n,i=h(this),a=[],r=i.attr("name");i.closest(".u-form-item").hasClass("f-dn")?p[r]=[]:(t=i.val(),e.config.enableSecurityLevel&&(t=C.securityLevel.formatContactList(t)),n=t?C.Email.parse(t):[],h.each(n,function(t,n){var i=!0,r=null,s="";if(n.trueName){e.config.enableSecurityLevel&&(r=C.securityLevel.departSLFromTrueName(n.trueName),s=r.securityLevel,n.trueName=r.trueName);var o=n.trueName.replace(/\"/g,'\\"');a.push('"'+o+'" <'+n.address+">")}else a.push(n.address);h.each(p._contacts,function(e,t){return n.address===t.addr?i=!1:void 0}),i&&p._contacts.push({name:n.trueName,addr:n.address,securityLevel:s})}),a.length>0?p[r]=a:p[r]=[])}),p._contacts.length>0&&(e._params.composeInfo._contacts=p._contacts),p.showOneRcpt=u.find("a[data-type=onercpt]").hasClass("z-active"),u.find("input[data-type=urgent]").is(":checked")&&(p.priority=1),p.smimeSign=!1,p.smimeEncrypt=!1,p.smimeEnvelopId="",f&&(u.find("input[data-type=smimeSign]").is(":checked")&&(p.smimeSign=!0),u.find("input[data-type=smimeEncrypt]").is(":checked")&&(p.smimeEncrypt=!0)),p.saveSentCopy=u.find("input[data-type=savesent]").is(":checked"),u.find("input[data-type=rrr]").is(":checked")&&(p.requestReadReceipt=!0),u.find("input[data-type=timesend]").is(":checked")&&(a=u.find(".timesend select[data-type=year]").val(),r=u.find(".timesend select[data-type=month]").val(),o=u.find(".timesend select[data-type=day]").val(),l=u.find(".timesend select[data-type=hour]").val(),c=u.find(".timesend select[data-type=minute]").val(),p.scheduleDate=new Date(+a,+r-1,+o,+l,+c)),u.find("input[data-type=autodel]").is(":checked")&&(a=u.find(".autodel select[data-type=year]").val(),r=u.find(".autodel select[data-type=month]").val(),o=u.find(".autodel select[data-type=day]").val(),d=u.find(".autodel .j-read-limit").val(),p.autoDel={expiryDate:new Date(+a,+r-1,+o,23,59,59),readLimit:+d}),u.find("input[data-type=mailcipher]").is(":checked")){var g=u.find(".form-toolbar .bt-cnt .mailcipher"),b=g.find("input[name=bt-mailcipher-password]").val(),_=g.find("input[name=bt-mailcipher-savePassword]").is(":checked");p.encryptPassword=b,p.savePassword=_}return 0!==u.find(".j-securityLevel").length&&(p.ctrls={"CM-SECURITY":u.find(".j-securityLevel").val()}),u.find("input[data-type=forbidDownload]").is(":checked")&&(p.forbidDownload=!0),u.find("input[data-type=sendMailWithSms]").is(":checked")&&(h.isEmptyObject(e._params.sendMailWithSms)||(v=[],h.each(e._params.sendMailWithSms,function(e,t){v.push([e,t].join("="))}),p.sendMailWithSms="true",p.smsAddrs=v.join(","))),p.subject=u.find("input[name=subject]").val(),p.isHtml=!!e.get("editor").designMode,p.content=e.get("editor").html()||u.find("#"+e._params.editorid).val(),e._params.varList&&(p.varList=e._params.varList,p.varKeyForRcpt=e._params.varListRcptsName,p.showOneRcpt=!0),t||(p.content=s(p.content)),p.attachments=[],i=e.get("uploader").attachupload("notInlinedFiles"),h.each(i,function(t,n){var i=n.cmMeta.exportToCompose();if(e.config.enableSecurityLevel){i.securityLevel=n.cmMeta.securityLevel+"";var a=C.securityLevel.departSLFromFilename(i.displayName);a||(a=C.securityLevel.i18n(i.securityLevel,"sender_security_level",!0),i.displayName=a+i.displayName)}switch(i.type){case"upload":case"internal":m.upload.push(i);break;case"trs":case"netfolder":m.trs.push(i)}}),p.attachments=p.attachments.concat(m.upload).concat(m.trs),p}function a(e,t,n,i,a){var s,o,l=!!i,c=l?"<br><br><br>":"\n\n\n",d=/(((<br\s*[\/]?>\s?)*$)|\s*$)/i,u=function(){var t,i,a=T.getConfig("setting.issignaturerelated");return n?(e=e.replace(d,c),l&&a?(t=h("<div/>"),t.html(e),i=t.children("blockquote.ReferenceQuote"),i.length?(i=i.eq(0),i.before(h("<p/>").html(n)),t.html()):e+=n):e+=n):e};if(n=r(n,l),l){if(null!=a){if(o=new RegExp("<br>?<br>?<br>--<br>"+t,"i"),o.test(e))return e.replace(o,c+n)}else if(s=/<span([^>]*)\s*id=["']spnEditorSign["'].*>(<span[^>]*>(<span[^>]*>(<span[^>]*>(<span[^>]*>(<span[^>]*>[\s\S]*?<\/span>|[\s\S])*?<\/span>|[\s\S])*?<\/span>|[\s\S])*?<\/span>|[\s\S])*?<\/span>|[\s\S])*?<\/span>/i,s.test(e))return e.replace(s,n);return u()}return t?(o=new RegExp("\n{1,3}--[\n\r\u2028\u2029]*"+C.html.escapeRegExp(t),"gi"),o.test(e)?e.replace(o,c+n):e.replace(d,c)+n):u()}function r(e,t){if(!e)return"";var n=T.getConfig("user.signatures"),i=null;return h.each(n,function(){return this.content===e?(i=this,!1):void 0}),null==i&&(i={isHtml:!0,content:e}),t?(e=i.isHtml?e:C.html.text2html(e),'<span id="spnEditorSign">--<br>'+e+"</span>"):(e=i.isHtml?C.html.html2text(e):e,"--\n"+e)}function s(e){return e.replace(/id="*spnEditorSign"*|$/gi,"")}function o(){var e=(new Date).getTime(),t="__SIGN_REPLACE_HOOK__";return t+e}function l(e,t){var n,i=e.getFullYear(),a=e.getMonth()+1,r=e.getDate(),s=e.getHours(),o=e.getMinutes(),l=31,c=(new Date).getFullYear(),d=[],u=[],p=[],m=[],f=t||["year","month","day","hour","minute"],v=h(document.createDocumentFragment());return h.each(f,function(e,t){var f=h('<select data-type="'+t+'"'+("hour"===t||"minute"===t?' class="sel sel-small"/>':"year"===t?' class="sel sel-first"/>':' class="sel"/>')),g=h("<label>",{text:C.i18n.t("compose/lb_timesend_"+t)});switch(t){case"year":h.each([c,++c,++c],function(e,t){f.append(h("<option></option>").attr("value",t).attr("selected",t==i).text(t))});break;case"month":for(n=1;12>=n;n++)d.push(n);h.each(d,function(e,t){f.append(h("<option></option>").attr("value",t).attr("selected",t==a).text(t))});break;case"day":switch(a){case 2:l=i%4==0&&i%100!=0||i%400==0?29:28;break;case 1:case 3:case 5:case 7:case 8:case 10:case 12:l=31;break;case 4:case 6:case 9:case 11:l=30}for(n=1;l>=n;n++)u.push(n);h.each(u,function(e,t){f.append(h("<option></option>").attr("value",t).attr("selected",t==r).text(t))});break;case"hour":for(n=0;23>=n;n++)p.push(n);h.each(p,function(e,t){f.append(h("<option></option>").attr("value",t).attr("selected",t==s).text(t))});break;case"minute":for(n=0;59>=n;n++)m.push(n);h.each(m,function(e,t){f.append(h("<option></option>").attr("value",t).attr("selected",t==o).text(t))})}v.append(f),v.append(g)}),h("<p/>").append(v).html()}function c(e,t){return C.Email.parseAddress(e.account)!=C.Email.parseAddress(t.defaultAccount)||(e.to||[]).join(",")!==(t.to||"")||(e.cc||[]).join(",")!==(t.cc||"")||(e.bcc||[]).join(",")!==(t.bcc||"")||e.subject!==(t._subject||"")||e.content!==(t.content||"")||d(e.attachments,t.attachments)||(e.priority||1)!==(t.priority||1)||(e.requestReadReceipt||!1)!==(t.requestReadReceipt||!1)||(e.saveSentCopy||!1)!==(t.saveSentCopy||1===T.getUser().save_sent)||(e.smimeSign||!1)!==(t.smimeSign||!1)||(e.smimeEncrypt||!1)!==(t.smimeEncrypt||T.getConfig("mail.encryptedcheckeddefault"))}function d(e,t){t=t||[];var n=0,i=0,a=0,r=0,s=0,o=0;return e.length!=t.length?!0:(h.each(e,function(e,t){switch(t.type){case"upload":n++;break;case"trs":i++;break;case"netfolder":a++;break;case"internal":r++}}),h.each(t,function(e,t){"upload"===t.type&&s++,"trs"===t.type&&o++}),n!==s||i!==o||r>0||a>0)}function u(e,t,n){var i,a,r,s=(e||{}).code||"",o="mail/"+s,l=C.i18n.t(o),c=!0;if("FA_OVERFLOW"===s)i=e.overflowReason,o="mail/"+s+"."+i,l=C.i18n.t(o);else if("FA_MTA_RCPT_ERROR"===s){for(var d in e.errorRcpts){a=d,r=e.errorRcpts[d];break}switch(r){case"MTA5101":case"MTA5102":case"MTA5103":case"MTA5104":case"MTA5105":case"MTA5106":case"MTA5107":l=C.i18n.t("mail/"+s+"."+r),("MTA5104"===r||"MTA5105"===r||"MTA5106"===r||"MTA5107"===r)&&(l=l.replace("{0}",a));break;default:l=C.i18n.t("mail/FA_MTA_RCPT_ERROR.MTA_OTHER").replace("{0}",a)}}else"FA_NEED_VERIFY_CODE"===s&&(c=!1,new H({composeId:e["var"].id,callback:h.proxy(n._afterDone,n)}).render());c&&(l!==o?h.notify.error(l):t&&h.notify.error(t))}function p(e){var t,n,i="mail.compose",a=e.get("composeId"),r=decodeURIComponent(v.getModuleCurrentPath(i));return n=r.indexOf("|"),n>=0?(t=r.substring(n+1),t=t?JSON.parse(t):{}):t={},"string"!=typeof r||r.length<=0?!1:r.indexOf(i)<0?!1:a.length<=0?"undefined"==typeof t.id:t.id===a?!0:!1}function m(e){var t=e.config,n=e.state.param.ctype||"";return C.regexpRuler.exec(n,{forwardd:t.enableForwardd,"reply.*":t.enableReply,"forward.*":t.enableForward,"edit.*":t.enableCompose,$$:t.enableCompose})}e("jquery.ztree"),e("i18n!compose,contact,mail,common"),e("../../../component/contactac"),e("../../../component/contactdg"),e("../../../widget/tageditor/tageditor"),e("../../../component/fileupload/attachupload-ui"),e("../../../component/securityleveldg");var h=e("jquery"),f=e("moment"),v=e("../../../dispatcher"),g=e("cui/core/view/view"),b=e("cui/core/view/viewmanager"),_=e("cui/util/templatable/templatable"),y=e("cui/ui/select/select"),w=e("../../../component/confirmbox"),x=e("../../../component/editor/editor"),C=e("../../../util/index"),k=e("cui/ui/switchable/tabs"),S=e("../../../component/fileupload/pasteUploadUtil"),T=e("../../common/globalService"),j=e("./service"),I=e("../../setting/account/signature/service"),A=e("../service"),E=e("module/contact/service"),D=e("../../setting/service"),P=e("../../../component/filelistbox"),M=e("../../../component/xnffilebox"),L=e("../../../component/stationery/stationery"),F=e("../../../component/mailTemplate"),$=e("../../../component/voiceupload/voiceupload"),N=e("../../../component/videoupload/videoupload"),R=e("../../../component/mailPreviewBox"),O=e("../../../configurable/index"),U=e("../smime"),q=e("./smsnotify"),H=e("../../../component/verifycodedg"),B=g.extend({Implements:_,attrs:{editor:{value:null,setter:function(e){return e}},uploader:{value:null,setter:function(e){return e}},className:{value:null,setter:function(e){return e?"m-mlcompose-embed":""}}},state:null,smime:null,events:{"click .j-toolbar .u-btn":"_handleToolbar","click .j-attach-expand-link":function(e){e.preventDefault(),this._handleAttachSummary(!1)},"click .j-attach-hide":function(e){e.preventDefault(),this._handleAttachSummary(!0)},"keyup #searchInput":"_searchPabContact","click .sidebar-content .close":"_clearSearchCont","click #searchResultContainer li a":"_updateContactTags"},initProps:function(){var e=T.getCurrentState(),t=e.param.id,n="undefined"==typeof t;this.set("name",n?"mail.compose":"mail.compose:"+t),this.set("tabId",n?e.param.view:e.param.view+":"+t),this.set("composeId",n?"":t)},setup:function(){this.state=T.getCurrentState(),this._params={composeInfo:{},pasteUploadCount:0,intervalTimer:0,resizeTimer:0,dndShowTimer:0,dndHideTimer:0,refreshedFolder:!1,notify:null,signs:{},currentSign:"",destroyed:!1,prevTags:[],sendMailWithSms:{},autoSendAfterAttachUploaded:!1,editorid:"ml-editor-"+this.state.param.id,useCASign:!1,useCAEncrypt:!1,caAttachment:[],selectInstance:null,varList:null},this.set("className",this.state.param.embed),this.config=O("mail.compose"),this._params.composeInfo.config=this.config,f.locale(this.config.locale)},render:function(e){return e="boolean"==typeof e?e:!1,e||B.superclass.render.call(this),m(this)?("forwardd"===this.state.param.ctype?this._renderDirectForward():this._renderNormal(),void this._initModuleEvent()):(this.undelegateEvents(),void this._renderForbidden())},destroy:function(e){e="boolean"==typeof e?e:!1,h(this.element).off("resize.compose"),this._params.notify&&this._params.notify.close(),this.get("editor")&&this.get("editor").remove(),this.get("uploader")&&this.$(this.get("uploader")[0]).length>0&&!!this.get("uploader").attachupload("instance")&&this.get("uploader").attachupload("activeFiles")>0&&this.$(".j-cancel").click(),this._params.intervalTimer&&clearTimeout(this._params.intervalTimer),this._params.resizeTimer&&clearTimeout(this._params.resizeTimer),this._params.dndHideTimer&&clearTimeout(this._params.dndHideTimer),this._params.dndShowTimer&&clearTimeout(this._params.dndShowTimer),this._params.destroyed=!0,e||B.superclass.destroy.call(this),h(window).off("beforeunload.compose")},_onRenderClassName:function(e){this.element.addClass(e)},confirmbeforedestroy:function(){return m(this)},beforedestroy:function(e){var t,n=this;return this._params.notify||this._params.destroyed||"forwardd"===this.state.param.ctype?void e():(t=i(this,!0),c(t,this._params.composeInfo)?void(n.config.enableSaveDraft?w.confirm(C.i18n.t(t.scheduleDate?"mail/msg_schedule_before_cancel":"mail/msg_save_before_cancel"),function(){j.sendMail({action:"save",id:n._params.composeInfo.composeId,attrs:t}).then(function(){h.notify.success(C.i18n.t("mail/compose_draft_success")),n._refreshDraftFolder(),e()})},function(){},{confirmTpl:C.i18n.t(t.scheduleDate?"common/save":"mail/compose_leave_save"),uncertainTpl:C.i18n.t(t.scheduleDate?"common/unsave":"mail/compose_leave_unsave"),onUncertain:function(){this.hide(),e()}}):w.confirm(C.i18n.t("mail/msg_before_cancel"),function(){e()})):void e())},rerender:function(){this.destroy(!0),this.element.children("div").remove(),this.setup(),this.render(!0)},_renderForbidden:function(){var e=this,t=this.state.param.ctype||"",n=C.regexpRuler.exec(t,{forwardd:"mail.compose_forbidden_forwardd","reply.*":"mail.compose_forbidden_reply","forward.*":"mail.compose_forbidden_forward",$$:"mail.compose_forbidden"});w.alert(C.i18n.t(n),function(){e.sendMessage("mail","view:close",{})})},_renderNormal:function(){var e=this,t=function(t){return function(){0===--t&&e.element.mask("hide")}}(3);e.element.mask(),this._renderView(t),this._renderSidebar(t),this._renderForm(t),this._initViewEvent()},_renderDirectForward:function(){var e=this.$("#forwarddtpl").html();this.element.append(this.compile(e)),this.$("input[name=bcc]").tagEditor({contactac:{container:this.element},onClick:function(e,t){t.addClass("z-active")},onBlur:function(e,t){t.removeClass("z-active")}}).focus()},_renderView:function(e){var t,n=this.$("#plgtiptpl").html(),i=this.$("#toolbartpl").html(),a=this.$("#maintpl").html();t=this.compile(n)+this.compile(i,this)+this.compile(a),this.element.append(t),e()},_renderSidebar:function(e){var t,n=this,i=n.$(".j-main"),a=n.$("#sidebartpl").html();i.append(n.compile(a,n.config)),n.config.supportPab&&n._renderRecentContacts(),t=new k({element:n.$(".j-aside"),activeTriggerClass:"z-current",triggerType:"click"}),t.on("switch",function(e){switch(e){case 1:n._renderStationery();break;case 2:n._renderTemplate()}}),e()},_renderForm:function(e){var t=this,n=t.state.param;h.when(j.getInitComposeInfo(n)).always(function(){e()}).done(function(e){t._params.composeInfo=h.extend(t._params.composeInfo,e),t.state.param.mid=t.state.param.mid||e.composeId,t._params.composeInfo._subject=t._params.composeInfo.subject||"",t._params.composeInfo._editorid=t._params.editorid,t._params.composeInfo.isHtml="boolean"===h.type(e.isHtml)?e.isHtml:1===T.getUser().edit_mode,t._params.composeInfo.draftId&&(t._params.composeInfo.config.encryptedCheckedDefault=!1),t._initFormTpl(),t._initSubject(),t._initContact(),t._initFormTTMenu(),t._initEditor(),t._initFormToolbar(),t._initSaveDraft(),t._initCursorFocus(),t._initSecurityLevel()}).fail(function(e){"FA_FORBIDDEN"===e.code?C.xhr.simpleCall({query:{func:"mbox:compose",sid:T.getSid()},data:{id:t.state.param.id}},function(e){},function(e,n,i){i&&"FA_ID_NOT_FOUND"===i.code?A.getComposeInfo({ctype:"normal"}).then(function(e){e&&e.id&&(T.setCurrentState({module:"mail.compose",param:{id:e.id}}),t.rerender(),t.sendMessage("dispatcher","view:render",{module:"mail.compose",param:{vid:"compose:"+e.id,id:e.id}}))}):t._params.notify=h.notify.error(C.i18n.t("mail/FA_MBOX_TARGET_READ_ONLY"),{forever:!0})}):t._params.notify=h.notify.error(C.i18n.t("mail/compose_init_fail"),{forever:!0})})},_initFormTpl:function(){var e=this.$(".j-main"),t=this.$("#formtpl").html();e.append(this.compile(t,this._params.composeInfo))},_initSubject:function(){function e(e){return function(){t&&clearInterval(t),e&&(t=setInterval(function(){var e=a.val();e!==i.composeInfo.subject&&(n._enableToolbar("draft"),n._handleSubject(e))},500))}}var t,n=this,i=n._params,a=this.$("input[name=subject]");a.on({focus:e(!0),blur:e(!1)}),this.sendMessage("mail","tab:change",{id:n.get("tabId"),title:i.composeInfo.subject||C.i18n.t("compose/lb_compose")})},_initContact:function(){this._initContactShowOrHide(),this._initContactFrom(),this._initContactTag(),(this.config.supportPab||this.config.supportOab)&&this._initContactDialog()},_initContactShowOrHide:function(){var e=this,t=this.$(".j-ft-contact");t.on("click","a[data-type]",function(n){n.preventDefault();var i,a,r,s,o=h(this),l=o.attr("data-type"),c=!o.hasClass("z-active"),d=e.$(".j-form-item-cc"),u=e.$(".j-form-item-bcc"),p=e.$(".j-form-item-to"),m=[];switch(l){case"cc":c?(o.html(C.i18n.t("mail/mail_uncc")).addClass("z-active"),d.removeClass("f-dn")):(s=function(){o.html(C.i18n.t("mail/mail_cc")).removeClass("z-active"),d.addClass("f-dn")},d.find(".tag-editor-li").length>0?w.confirm(C.i18n.t("mail/msg_confirm_remove_cc_addr"),function(){d.find(".tag-editor-li").remove().end().find(".tag-editor-hidden-src").val(""),s()},h.noop()):s());break;case"bcc":c?(o.html(C.i18n.t("mail/mail_unbcc")).addClass("z-active"),u.removeClass("f-dn")):(s=function(){o.html(C.i18n.t("mail/mail_bcc")).removeClass("z-active"),u.addClass("f-dn")},u.find(".tag-editor-li").length>0?w.confirm(C.i18n.t("mail/msg_confirm_remove_bcc_addr"),function(){u.find(".tag-editor-li").remove().end().find(".tag-editor-hidden-src").val(""),s()},h.noop()):s());break;case"onercpt":var f=p.find("input[role=contact]"),v=u.find("input[role=contact]"),g=d.find("input[role=contact]");i=t.find("a[data-type=cc]"),a=t.find("a[data-type=bcc]"),c?(o.html(C.i18n.t("mail/mail_unonercpt")).addClass("z-active"),e.$("a[contact=to]").html(C.i18n.t("mail/mail_onercpt_short")),d.addClass("f-dn"),u.addClass("f-dn"),i.closest("li").hide().next("li").hide(),a.closest("li").hide().next("li").hide(),e._params.prevTags=f.val().split(","),r=h.unique(h.merge(v.val().split(","),g.val().split(","))),f.tagEditor("addTags",r,!0),p.click()):(o.html(C.i18n.t("mail/mail_onercpt")).removeClass("z-active"),e.$("a[contact=to]").html(C.i18n.t("compose/lbt_to")),i.hasClass("z-active")&&d.removeClass("f-dn"),a.hasClass("z-active")&&u.removeClass("f-dn"),i.closest("li").show().next("li").show(),a.closest("li").show().next("li").show(),r=f.tagEditor("getTags")[0].tags,h.each(r,function(t,n){-1===h.inArray(n,e._params.prevTags)&&m.push(n)}),f.tagEditor("removeTags",m))}})},_initContactFrom:function(){var e=this.$(".j-accounts");return e.length<1?!1:void new y({parentNode:e.closest(".u-form-item"),trigger:this.$(".j-accounts"),classPrefix:"u-select"}).render()},_initContactTag:function(){var e=this;e.config.enableModifySendTo?this.$("input[role=contact]").tagEditor({i18n:{dragMsg:C.i18n.t("common/tagEditor_drag")},enableSecurityLevel:e.config.enableSecurityLevel,contactac:{container:this.element},onChange:function(){e._enableToolbar("draft")},onClick:function(t){e.cType=t.attr("name")}}):this.$("input[role=contact]").tagEditor({ctxClickEvent:!1,sortable:!1,eventTrigger:{mousemove:!1,mouseup:!1,mousedown:!1,editorSpacerMousemove:!1,editorDeleteClick:!1,tagDblclick:!1},enableSecurityLevel:e.config.enableSecurityLevel})},_initContactDialog:function(){var e,t=this,n=this.$(".j-form-tt");n.contactdg({trigger:this.$("a[contact]"),onSelect:function(i){t.trigger("contact:tag:update",i),n.find('input[name="'+e+'"]').focus(),t._enableCompose()},onClose:function(){n.find('input[name="'+e+'"]').focus(),t._enableCompose()}}),n.on("click","a[contact]",function(i){i.preventDefault(),e=h(this).attr("contact"),n.contactdg("show",e,t._getContacts()),t._disableCompose()})},_initFormTTMenu:function(){var e=this;this._params.composeInfo.isHtml?this._stationeryAble():(this.$(".j-text-menu").show(),this.$(".j-html-menu").hide(),this._stationeryDisable()),this._initFormTTMenuUpload(),this._initFormTTMenuAttach(),this._initFormTTMenuMore(),this._initFormTTMenuSignature(),this._initFormTTMenuScreenCapture(),this.$(".j-ft-menu").on("click","[data-type]",function(t){var n=h(this),i=n.attr("data-type");switch("upload"!==i&&t.preventDefault(),i){case"etbr":e._handleEditorToolbar(n);break;case"link":e._handleEditorLink(n);break;case"screencapture":e._handleEditorScreenCapture(n);break;case"image":e._handleEditorImage(n);break;case"html":case"text":e._handleEditorMode(n,i);break;case"expand":e._handleEditorExpand(n);break;case"typo":e._handleSpellCheck(n)}})},_initFormTTMenuUpload:function(){var e,t=this,n=this._params.composeInfo,i=n.attachments,a=t.config.enableDnDUpload,r=this.$(".j-attach-tips"),s="f-dni";r.on("click",".j-close",function(e){e.preventDefault(),r.slideUp()}),this.set("uploader",this.$("[data-type=upload]").attachupload({composeId:n.composeId,filesContainer:t.$(".j-attaches"),prependFiles:!0,deletedStatus:!1,enableSecurityLevel:t.config.enableSecurityLevel}).on("attachuploadaddstart",function(e,i){var a,r=i.files[0].name||"";n.subject||(r=r.split(/[\/\\]/).pop(),a=r.lastIndexOf("."),r=a>-1?r.substring(0,a):r,t.$("input[name=subject]").val(r),t._handleSubject(r)),i.files[0].inlined||t.$(".j-attachItem").slideDown()}).on("attachuploadstart attachuploadmergestart",function(){t._disableToolbar(),t._handleAttachSummary(!1)}).on("attachuploadaddrepeat",function(){setTimeout(function(){h.notify.error(C.i18n.t("mail/lbl_attachment_add_repeated"))},50)}).on("attachuploaddragenter attachuploaddragover",function(){var e=h(this).attachupload("option","enableDnd");return p(t)&&a&&e?(clearTimeout(t._params.dndHideTimer),clearTimeout(t._params.dndShowTimer),void(t._params.dndShowTimer=setTimeout(function(){t.$(".j-form-dnd").removeClass(s)},50))):!1}).on("attachuploaddragleave",function(e){var n=h(this).attachupload("option","enableDnd");return p(t)&&a&&n?(e.preventDefault(),clearTimeout(t._params.dndShowTimer),clearTimeout(t._params.dndHideTimer),void(t._params.dndHideTimer=setTimeout(function(){t.$(".j-form-dnd").addClass(s)},300))):!1}).on("attachuploaddrop",function(e){var n=h(this).attachupload("option","enableDnd");if(!p(t)||!a||!n)return!1;var i;return clearTimeout(t._params.dndHideTimer),clearTimeout(t._params.dndShowTimer),t.$(".j-form-dnd").addClass(s),i=e.originalEvent.delegatedEvent.target,h(i).closest(".j-form-dnd").length<=0?!1:void 0}).on("attachuploadplugindragenter",function(){var e=h(this).attachupload("option","enableDnd");return p(t)&&a&&e?void t.$(".j-form-dnd").find(".j-dnd-info").text(C.i18n.t("mail/compose_dnd_ie")).end().removeClass(s):!1}).on("attachuploadplugindragleave attachuploadplugindrop",function(){var e=h(this).attachupload("option","enableDnd");return p(t)&&a&&e?void t.$(".j-form-dnd").addClass(s):!1}).on("attachuploadprogress attachuploadpluginprogress",function(){h(this).attachupload("failFiles").length>0&&(t.$(".j-disable-edit,.j-enable-edit").remove(),t._params.autoSendAfterAttachUploaded=!1),t._disableToolbar()}).on("attachuploadcompleted",function(){t._handleAttachUploaded()}).on("attachuploadfailed",function(e,n){var i,a=h(this),r=a.attachupload("option","errorCode"),s=n.files[0].errorThrown||n.errorThrown,o=n.customNetFolder,l=n.isForbidNetFolder,c=n.netfolder;switch(s){case r.overflow:o?l?i="forbid_netfolder":c&&(i="overflow_netfolder"):i="overflow",t._handleAttachTips("uploadFail",!1,{type:i});break;case r.withoutPlugin:t._handleAttachTips("uploadFail",!1,{type:"requirePlugin"})}}).on("attachuploaddone",function(e,n){"trs"===n.uploadType&&(t.sendMessage("file.transitcenter","trsUpload"),t._handleAttachTips("toTrs",!1,{isSuccess:!0})),setTimeout(function(){h(t.element).trigger("resize.compose")},100)}).on("attachuploadplugindone",function(e,n){"trs"===n.uploadType&&(t.sendMessage("file.transitcenter","trsUpload"),t._handleAttachTips("toTrs",!1,{isSuccess:!0})),setTimeout(function(){h(t.element).trigger("resize.compose")},100)}).on("attachuploaddestroy",function(e,n){"trs"===n.uploadType&&(t.sendMessage("file.transitcenter","trsDestroy"),t._handleAttachTips("toTrs",!1,{isSuccess:!0})),setTimeout(function(){h(t.element).trigger("resize.compose")},100)}).on("attachuploadpluginfail",function(e,n){var i=n.files[0].errorThrown||n.errorThrown;i&&"abort"!==i&&t._handleAttachTips("uploadFail",!1)}).on("attachuploadstop",function(){t._handleAttachSummary(!0),t._enableToolbar(),t._params.autoSendAfterAttachUploaded&&(h(this).attachupload("failFiles").length>0?t._handleFileUploadFailDialog():(t.$(".j-disable-edit,.j-enable-edit").remove(),setTimeout(function(){t._handleTblSend()},0))),h(t.element).trigger("resize.compose")}).on("attachuploadmergestop",function(){t._enableToolbar(),t._handleAttachSummary(!1)}).on("attachuploaddestroyed",function(){t._handleAttachSummary(),t._handleAttachUploaded(),0===h(this).attachupload("notDeletedFiles").length&&t.$(".j-attachItem").slideUp(),h(t.element).trigger("resize.compose")}).on("attachuploaddestroyfailed",function(e,t){u(t)})),e=h(this.element).cmplugin("valid")||h.support.xhrFileUpload?C.size.bytesToSize(this.config.trsMaxFileSize>=this.config.maxAttachmentSize?this.config.trsMaxFileSize:this.config.maxAttachmentSize,2):C.size.bytesToSize(this.config.maxAttachmentSize,2),n._formatAttachLimit=e,this.$(".j-attachLimit").html(C.i18n.t("compose/lbt_addattach_limit").replace("{0}",e)),i&&i.length>0&&t._handleMergeAttachments(i)},_initFormTTMenuAttach:function(){var e=this,t=[],n=this.get("uploader"),i=T.getConfig("file.xnfengines"),a=i.length,r=T.getConfig("file.ispermittrs")||T.getConfig("file.ispermitnf")||T.getConfig("file.ispermitenf")||T.getConfig("file.ispermitattmgr");r&&t.push({name:C.i18n.t("mail/compose_attach_add_from_filecenter"),value:"file",icon:"iconfiler"}),a>0&&t.push({name:C.i18n.t("mail/compose_attach_add_from_external_nf").replace("{0}",i[0].engineName),value:"externalNf",icon:"iconfiler"}),(n.attachupload("isPluginValid")||h.support.xhrFileUpload)&&T.getConfig("file.ispermittrs")&&t.push({name:C.i18n.t("compose/lbt_uploadattach_trs"),value:"totrs",icon:"iconyin"}),T.getConfig("mail.supportvoicemail")&&t.push({name:C.i18n.t("compose/lbt_addattach_voice"),value:"audio",icon:"iconmusic"}),T.getConfig("mail.supportvideomail")&&t.push({name:C.i18n.t("compose/lbt_addattach_video"),value:"video",icon:"iconvideo"}),this.$("[data-type=attach]").dropdown({data:t,beforeShow:function(){h(this).addClass("active")},callback:function(t){e._handleAttach(t,this)},afterHide:function(){h(this).removeClass("active")}})},_initFormTTMenuMore:function(){var e=this,t=this.$("a[data-type=more]"),n=[{name:C.i18n.t("mail/source_edit"),value:"source",icon:"iconcode1",classNames:"j-edit-source"}];t.dropdown({data:n,beforeShow:function(){var e=h(this);e.addClass("active")},callback:function(t){e._handleEditorMore(t)},afterHide:function(){var e=h(this);e.removeClass("active")}})},_initFormTTMenuSignature:function(e){e="boolean"==typeof e?e:!1;var t,n=this,i=n._params.composeInfo.isHtml,r=[],s=!1,o=C.i18n.t("compose/msg_from_lunkr"),l="m-mlcompose-embed"===n.get("className");h.when(I.getSignatures(e)).then(function(e){n._params.signs={},h.each(e,function(){n._params.signs[this.id]=this,this.isDefault&&l&&(s=!0,this.content=this.content+o)}),T.updateConfig("user.signatures",n._params.signs),h.each(e,function(){this.isDefault?(n._params.currentSign=this.content,n._params.composeInfo.content||(t=n.get("editor").html(),t=a(t,"",this.content,i),n.get("editor").html(t)),n._params.composeInfo.content=n.get("editor").html(),r.push({name:this.name,value:"sign-"+this.id,"default":!0})):r.push({name:this.name,value:"sign-"+this.id})}),!s&&l&&(n._params.currentSign=o,n._params.composeInfo.content||(t=n.get("editor").html(),t=a(t,"",o,i),n.get("editor").html(t)),n._params.composeInfo.content=n.get("editor").html()),n._bindDropDownMenuSignatureEvent(r)})},_initFormTTMenuScreenCapture:function(){h(this.element).cmplugin("capture")},_initEditor:function(){var e=this,n=C.xhr.getFullRequestURL({url:"XT5/jsp/upload.jsp",query:{func:"directData"}});n=C.url.addUrlParams(n,{sid:T.getSid(),composeId:e._params.composeInfo.composeId,inlined:!0}),t(e),e.set("editor",x.create("#"+e._params.editorid,{uploadJson:n,designMode:e._params.composeInfo.isHtml,composeId:e.state.param.id,afterCreate:function(){this.toolbar.div.hide(),this.statusbar.hide(),h(this.edit.doc).mousedown(function(){h(document).trigger("hide.menu")}),this.toolbar.div.click(function(){h(document).trigger("hide.menu")})},afterFocus:function(){h(e.element).trigger("resize.compose"),e._enableToolbar("draft")},afterBlur:function(){this.sync()},afterChange:function(){},afterUpload:function(t){t.url=C.xhr.getRequestURL({query:{func:"mbox:getComposeData",sid:T.getSid(),composeId:e._params.composeInfo.composeId,attachId:t.attachmentId}})}})),h(e.get("editor").cmd.doc.body).on("keydown",function(t){var n=t||window.event,i=n.keyCode,a=e._params.composeInfo.isHtml,r=T.getUser();a&&n.ctrlKey&&(86===i&&S.handleEditorNativeImage(h(e.element).cmplugin("pluginUpload"),e.get("editor"),e.get("uploader")),1===r.shortcut&&(83===i?(n.preventDefault(),n.stopPropagation(),e._handleTblDraft()):13===i&&e._handleTblSend()))}),h(e.get("editor").cmd.doc.body).on("paste",function(t){var n=e._params.composeInfo.isHtml;return e._params.pasteUploadCount++,n?S.handlePaste(h(e.element).cmplugin("pluginUpload"),e.get("editor"),e.get("uploader"),e._params.pasteUploadCount,e._params.composeInfo.composeId,t):void 0}),h(e.get("editor").cmd.doc.body).on("click","a[data-ke-src]",function(e){window.open(e.target.href)}),e._params.composeInfo.content&&(e.get("editor").html(e._params.composeInfo.content),e._params.composeInfo.content=e.get("editor").html(),e.get("editor").sync()),this._handleEditorIframeEvent(),this._bindEditorResize();
},_initFormToolbar:function(){var e=this,t=T.getUser();t.save_sent&&this.$(".j-form-toolbar").find("input[data-type=savesent]").prop("checked",!0),e._params.composeInfo.smimeSign&&this.$(".j-form-toolbar").find("input[data-type=smimeSign]").prop("checked",!0),e._params.composeInfo.smimeEncrypt&&this.$(".j-form-toolbar").find("input[data-type=smimeEncrypt]").prop("checked",!0),V(this,!1),this.$(".j-form-toolbar").on("click",".bt-hd .bt-hd-more",function(){V(e,h(this).hasClass("bt-hd-more-show"))}).on("click","input[data-type]",function(t){e._handleFormToolbar(t,this)}).customRadioCheckbox(),e._params.composeInfo.scheduleDate&&e.$("input[data-type=timesend]",".j-form-toolbar").click(),1===e._params.composeInfo.priority&&e.$("input[data-type=urgent]",".j-form-toolbar").click(),e._params.composeInfo.requestReadReceipt&&e.$("input[data-type=rrr]",".j-form-toolbar").click(),e.config.supportSMIMEClient&&e._params.composeInfo.useCacompose&&(e._params.composeInfo.isSigned&&e.$("input[data-action='useCASign']").trigger("click"),e._params.composeInfo.isEncrypted&&e.$("input[data-action='useCAEncrypt']").trigger("click"),e._params.caAttachment=C.cache.getItem(e._params.composeInfo.attachId,!1)||[],e.$("[data-type=upload]").trigger("initUpload"))},_initSaveDraft:function(){var e=this;this._params.intervalTimer=setTimeout(function(){var t=i(e,!0);clearTimeout(e._params.intervalTimer),c(t,e._params.composeInfo)&&e._handleAutoDelValid(!0)?h.when(e._handleTblDraft(t)).always(function(){e._initSaveDraft()}):e._initSaveDraft()},e.config.autoSaveDraftInterval||18e4)},_initViewEvent:function(){var e=this;this.off("contact:tag:update").on("contact:tag:update",function(t){var n=e.$(".j-ft-contact");h.each(t,function(t,i){var a=e.$('input[name="'+t+'"]'),r=[];!a.closest(".u-form-item").is(":visible")&&i.length>0&&n.find('a[data-type="'+t+'"]').click(),h.each(i,function(t,n){var i=n.name;e.config.enableSecurityLevel&&n.isOab&&(i=C.securityLevel.formatTrueName(i,n.securityLevel,"security_level",!0)),r.push(new C.Email(i,n.addr).toString(e.config.enableSecurityLevel&&n.isOab))}),a.tagEditor("updateTags",r,!0)})}),this.off("contact:tag:add").on("contact:tag:add",function(t){var n=e._getContacts(),i=!1,a=e.cType,r=n[a];r||(e.cType="to",r=n[e.cType]);for(var s=0;s<r.length;s++)if(r[s].addr===t.addr){i=!0;break}i||(r.push(t),e.trigger("contact:tag:update",n))})},_initCursorFocus:function(){this._params.composeInfo.to&&this._params.composeInfo.to.length>0?(this.get("editor").focus(),this._params.composeInfo.isHtml||this.$(".ke-edit-textarea").caret(1)):this.$(".j-form-item-to").find(".tag-editor").trigger("mousedown")},_initSecurityLevel:function(){var e,t=this,n=this.$(".j-securityLevel"),i=this.$(".j-form-tt"),a=-1;return t.config.enableSecurityLevel?(t._params.selectInstance=new y({parentNode:n.closest(".u-form-item"),trigger:n,classPrefix:"u-select",onChange:function(e){a=e.data("value"),t.get("uploader").attachupload("updateMailSecurityLevel",a)}}).render(),i.securityleveldg({onSelect:function(n,i){var a=C.securityLevel.i18n(n.value,"sender_security_level",!0)+i;e=t.get("uploader").attachupload("getUploadFileByName",i,!1),e.cmMeta.securityLevel=n.value,t.$(".j-attaches .j-name").each(function(){return h(this).attr("oname")===i?(h(this).html(C.html.encode(a)),!1):void 0}),t._checkMailSecurityLevel()}}),void i.on("click",".j-editSecurityLevel",function(n){n.preventDefault();var r=h(this).closest(".j-btns").siblings(".j-name").attr("oname")||"";e=t.get("uploader").attachupload("getUploadFileByName",r,!1),i.securityleveldg("show",e.cmMeta.securityLevel,r,a)})):!1},_checkMailSecurityLevel:function(){var e=this,t=e.$(".j-securityLevel").val(),n=e.get("uploader").attachupload("notInlinedFiles"),i=-1;return n.length>0&&(h.each(n,function(e,t){t.cmMeta.securityLevel&&t.cmMeta.securityLevel>i&&(i=t.cmMeta.securityLevel)}),i>t)?(w.confirm(C.i18n.t("mail/msg_level_exceed_tip_desc"),function(){e._params.selectInstance.select('[data-value="'+i+'"]')},h.noop(),{title:C.i18n.t("mail/msg_level_exceed_tip_title"),confirmTpl:C.i18n.t("mail/lbl_level_exceed_tip_confirm"),cancelTpl:C.i18n.t("mail/lbl_level_exceed_tip_cancel")}),!1):!0},_initModuleEvent:function(){var e=this;e.offMessage("view:active").onMessage("view:active",function(){t(e)}),e.subscribe("dispatcher","url:changed",function(t){var n=t.message.oldState;"mail.compose"===n.module&&e._handleEditorExpand(h('[data-type="expand"]'),!1,!1)}),e.unsubscribe("setting.account.signature","signs:refresh").subscribe("setting.account.signature","signs:refresh",function(){e._initFormTTMenuSignature(!1)}),h(window).on("beforeunload.compose",function(t){return e.get("tab_close")||h(document.activeElement)&&h(document.activeElement).is("a")||e.get("uploader").attachupload("option","pluginBrowsing")?void 0:c(i(e,!0),e._params.composeInfo)?(t&&(t.returnValue=C.i18n.t("mail/msg_save_onbeforeunload")),C.i18n.t("mail/msg_save_onbeforeunload")):void 0}),e.offMessage("mail:op").onMessage("mail:op",function(t){var n=T.getCurrentState();("mail.compose"===n.module||n.param.id===e.get("composeId"))&&(t.message&&"savedraft"===t.message.action?e._handleTblDraft():e._handleTblSend())})},_bindEditorResize:function(){var e=this;h(e.element).off("resize.compose").on("resize.compose",function(){clearTimeout(e._params.resizeTimer),e._params.resizeTimer=setTimeout(function(){V(e);var n=t(e);e.get("editor")&&e.get("editor").toolbar&&e.get("editor").resize("100%",n.formedrHeight-20,!0)},300)})},_handleSubject:function(e){null!=e&&(this._params.composeInfo.subject=e),e=e||C.i18n.t("compose/lb_compose"),this.sendMessage("mail","tab:change",{id:this.get("tabId"),title:e})},_handleToolbar:function(e,t){var n=h(t).data("type");switch(n){case"aside":this._handleTblAside(t);break;case"send":this._handleTblSend(t);break;case"preview":this._handleTblPreview();break;case"draft":this._handleTblDraft();break;case"cancel":this._handleTblCancel(t);break;case"forward":this._handleForward();break;case"forwardCancel":this._handleForwardCancel()}},_handleFormToolbar:function(e,t){var n=h(t).data("type");switch(n){case"":break;case"timesend":this._handleTimeSend(t);break;case"mailcipher":this._handleMailCipher(t);break;case"autodel":this._handleAutoDel(t);break;case"savesent":this._handleSaveSent(e,h(t));break;case"cacompose":this._handleCacompose(h(t));break;case"smimeSign":case"smimeEncrypt":this._handleSmimeSign(t)}h(this.get("editor")).focus()},_handleTblAside:function(e,t){t="boolean"===h.type(t)?t:!h(e).data("hide"),t?(this.$(".j-main").addClass("z-aside-hide"),h(e).children(".iconfont").removeClass("iconnext").addClass("iconprevious")):(this.$(".j-main").removeClass("z-aside-hide"),h(e).children(".iconfont").removeClass("iconprevious").addClass("iconnext")),h(e).data("hide",t),setTimeout(function(){h(this.element).trigger("resize.compose")},100)},_handleTblPreview:function(){var e=this,t=this.get("editor");new R({mailContent:t.designMode?t.html():t.text(),composeInfo:i(e)}).show()},_handleTblSend:function(){function e(e){var t=s.get("uploader").attachupload("notInlinedFiles"),n=0,i=!1;return h.each(t,function(t,a){i="boolean"===h.type(a.deleted)?a.deleted:!1,!e&&"trs"===a.attachType||i||(n+=parseInt(a.size))}),n}function t(e,t){return e instanceof Function?e(t):e instanceof RegExp?e.exec(t):"string"==typeof e?-1!==t.indexOf(e):!1}var a,r,s=this,o=this.$(".j-form"),l=this.$(".j-tbl-send"),c=this.smime,d=function(){var e,t=o.find(".form-toolbar .bt-cnt .mailcipher"),n=t.find("input[name=bt-mailcipher-password]"),i=n.val(),a=i.length;return 0===a?e=C.i18n.t("mail/msg_cipher_password_invalid_empty"):h.trim(i).length!==a?e=C.i18n.t("mail/msg_cipher_password_invalid_no_space_heading_tailing"):a!==s.config.mailCipherPassLen&&(e=C.i18n.t("mail/msg_cipher_password_invalid",{len:s.config.mailCipherPassLen})),e?(w.alert(e,function(){n.focus()}),!1):!0};return l.hasClass("disabled")?!1:n(this,"to")||n(this,"cc")||n(this,"bcc")?!n(this,"to")&&o.find("input[data-type=timesend]").is(":checked")?w.alert(C.i18n.t("mail/msg_needrcpt"),function(){o.find("input[name=to]").focus()}):o.find("input[data-type=mailcipher]").is(":checked")&&!d()?!1:this._handleAutoDelValid(!1,o)?(o.find("[data-type=more] a").text()===C.i18n.t("mail/close_source_edit")&&s.get("editor").clickToolbar("source"),"mode_checkspelling"!==o.find("a[data-type=typo]").data("mode")&&s.get("editor").clickToolbar("finishcheck"),void h.when(!0).then(function(){var e=h.Deferred();return n(s,"subject")?e.resolve():w.confirm(C.i18n.t("mail/compose_confirm_empty",{type:C.i18n.t("mail/mail_subject")}),function(){setTimeout(function(){e.resolve()},0)},function(){o.find("input[name=subject]").focus(),setTimeout(function(){e.reject()},0)}),e.promise()}).then(function(){var e=h.Deferred();return n(s,"content")?e.resolve():w.confirm(C.i18n.t("mail/compose_confirm_empty",{type:C.i18n.t("mail/mail_content")}),function(){setTimeout(function(){e.resolve()},0)},function(){s.get("editor").focus(),setTimeout(function(){e.reject()},0)}),e.promise()}).then(function(){var n=h.Deferred(),i=[/\battachments?\b/i,String.fromCharCode(38468)+String.fromCharCode(20214)],a=!1,r=T.getConfig("mail.supportattachdetect");if(r&&0===e(!0)&&0===s._params.caAttachment.length){var l=o.find("input[name=subject]").val(),c=o.find("#"+s._params.editorid).val();h.each(i,function(e,n){(t(n,l)||t(n,c))&&(a=!0)})}if(a){var d=C.i18n.t("mail/send_without_attach");w.confirm(d,function(){setTimeout(function(){n.resolve()},0)},function(){s.get("editor").focus(),setTimeout(function(){n.reject()},0)},{title:C.i18n.t("mail/prompt")})}else n.resolve();return n.promise()}).then(function(){var e=h.Deferred();return s.get("uploader").attachupload("activeFiles")>0?(s._params.autoSendAfterAttachUploaded=!0,s.element.append(h("<div/>",{"class":"compose-disable-edit j-disable-edit"})),s.element.append(h("<div/>",{"class":"compose-enable-edit u-alert u-alert-warning j-enable-edit"})),s.$(".j-enable-edit").append("<span>"+C.i18n.t("mail/compose_send_after_uploaded")+'</span><a href="javascript:void(0)">'+C.i18n.t("mail/compose_back_edit")+"</a>"),s.$(".j-enable-edit a").off("click").on("click",function(e){e.preventDefault(),s._params.autoSendAfterAttachUploaded=!1,s.$(".j-disable-edit,.j-enable-edit").remove()}),e.reject()):(s.$(".j-disable-edit,.j-enable-edit").remove(),s._params.autoSendAfterAttachUploaded=!1,e.resolve()),e.promise()}).then(function(){var e,t=h.Deferred();return s.$(".j-form").find("input[data-type=sendMailWithSms]").is(":checked")?(s._params.sendMailWithSms={},e=function(e,n,i){return e?(n=arguments[1],h.isEmptyObject(n)?t.resolve():(h.extend(!0,s._params.sendMailWithSms,n),t.resolve())):t.reject()},q.initSmsNumber(s,e)):t.resolve(),t.promise()}).then(function(){a=i(s);var e=h.Deferred(),t=T.getConfig("user.uid"),n=C.Email.parseAddress(a.account);return t!==n?D.getPOPAccounts().then(function(t){h.each(t,function(e,t){return t.username===n?(a.accountSettings={smtpHost:t.smtpHost,smtpPort:t.smtpPort,useSSL:"boolean"==typeof t.smtpUseSSL?t.smtpUseSSL:!1,popWebId:t.id},!1):void 0}),e.resolve()}):e.resolve(),e.promise()}).then(function(){var e,t=h.Deferred();return s._params.useCASign||s._params.useCAEncrypt?(e=c.initCertificate(s.config.domainName),c.setBaseMailInfo(a,s._params.caAttachment),s._params.useCASign&&(e&&c.signMail(e)?s._params.useCAEncrypt||(a.lettercontent=c.mimeNode.build(),t.resolve()):t.reject()),s._params.useCAEncrypt&&j.getReceiverCerts(a).then(function(n){c.encryptMail(e,n,s._params.useCASign)?(a.lettercontent=c.mimeNode.build(),t.resolve()):t.reject()})):t.resolve(),t.promise()}).then(function(){var e=h.Deferred();if(a.varList&&a.varList.length>0){var t=s._params.varListRcptsName,n=h.map(a.varList,function(e){return e[t]});n.length!==a.to.length&&(w.alert(C.i18n.t("mail/msg_rcpts_not_the_same")),e.reject()),h.each(a.to,function(t,i){return-1===h.inArray(i,n)?(w.alert(C.i18n.t("mail/msg_rcpts_not_the_same")),e.reject(),!1):void 0}),e.resolve()}else e.resolve();return e.promise()}).then(function(){var e=h.Deferred();return s.config.enableMultiRcptsAlert&&a._contacts&&a._contacts.length>1?w.confirm(C.i18n.t("mail/msg_multiple_rcpts"),function(){setTimeout(function(){e.resolve()},0)},function(){setTimeout(function(){e.reject()},0)}):e.resolve(),e.promise()}).then(function(){return s.get("uploader").attachupload("detectUploadedAttachSizeExceed")?void h.notify.error(C.i18n.t("mail/FA_OVERFLOW")):(h.extend(!0,s._params.composeInfo,a),void((!s.config.enableSecurityLevel||s._checkMailSecurityLevel())&&(r=a.scheduleDate,s.element.mask(),s._disableToolbar(),j.sendMail({action:r?"schedule":"deliver",id:s._params.composeInfo.composeId,attrs:a,returnInfo:!0,autosaveHitCounter:!0}).done(function(e){s._afterDone(e)}).fail(function(e){console.debug(e);var t=e["var"];if(t&&t.attachments){var n=t.attachments;s.get("uploader").attachupload("updateComposeAttachmentId",n)}u(e,C.i18n.t("mail/compose_send_fail"),s),delete s._params.composeInfo.to,delete s._params.composeInfo.cc,delete s._params.composeInfo.bcc}).always(function(){s.element.mask("hide"),s._enableToolbar()}))))})):!1:w.alert(C.i18n.t("mail/compose_need_rcpt"),function(){o.find("input[name=to]").focus()})},_afterDone:function(e){var t=e.savedSent||{};this._params.refreshedFolder&&this._refreshDraftFolder(),this._handleSendSuccess(t.mid,this._params.composeInfo.scheduleDate,this._params.composeInfo.encryptPassword)},_handleSendSuccess:function(e,t,n){var i,a,r,s,o=this,l=this.$("#successtpl").html(),c=this.$("#autosavecontactlisttpl").html(),d=this.$("#deliverystatustpl").html(),u=1===T.getUser().aftersend_saveaddr,p=this._params.composeInfo,m=p._contacts,v="true"===p.sendMailWithSms&&this._params.sendMailWithSms,g=[],b=[],_=A.getFoldersMap();this.destroy(!0),this.element.children("div").remove(),n&&(n='<span class="pass">'+C.html.encode(n)+"</span>"),this.element.append(o.compile(l,{aftersend_saveaddr:u,scheduletime:t?f(t).format("lll"):"",status:!!e,encryptPassword:n,smsAddrs:v,config:o.config}));var y=[];h.each(m,function(e,t){y.push(t.addr)}),E.getPabContactsByEmail(y.join(",")).then(function(e){u?(h.each(m,function(t,n){e[n.addr]?b.push({id:e[n.addr].id,name:n.name,addr:n.addr,isExist:!0,securityLevel:n.securityLevel}):g.push({FN:n.name,"EMAIL;PREF":n.addr})}),E.createPabContacts(g,!0).then(function(e){g=b,h.each(e,function(e,t){if("added"===t.action){var n="",i=t.item["EMAIL;PREF"];o.config.enableSecurityLevel&&h.each(m,function(e,t){return t.addr===i?(n=t.securityLevel,!1):void 0}),g.push({name:t.item.FN,addr:i,id:t.item.id,isAutoSave:!0,securityLevel:n})}}),o.$(".j-contactlist").html(o.compile(c,{contacts:g,aftersend_saveaddr:u})),o.$(".j-autosave-desc").removeClass("f-dn")})):(h.each(m,function(t,n){e[n.addr]&&(n.id=e[n.addr].id,n.isExist=!0)}),o.$(".j-contactlist").html(o.compile(c,{contacts:m,aftersend_saveaddr:u})),o.$(".j-autosave-desc").removeClass("f-dn"))}),this.$(".j-contactlist").on("click","a",function(e){e.preventDefault();var t=h(this).data("name"),n=h(this).data("addr"),i=""+h(this).data("id"),a=h(this);i?o.sendMessage("dispatcher","history:add",{module:"contact.pab",param:{type:"edit",id:i}}):E.createPabContacts([{FN:t,"EMAIL;PREF":n}]).then(function(e){h.notify.success(C.messageFormat.format(C.i18n.t("common/added_user_address"),n)),a.text(C.i18n.t("main/bt_edit")),a.data({id:e[0]})})}),i=this.$(".j-autosave-desc"),r=this.$(".j-contactlist"),u&&i.addClass("toggled"),i.on("click","a",function(e){if(e.preventDefault(),!u){var t=[],n=[];r.find("a").each(function(e,i){var a=""+h(i).data("id");a?n.push({FN:h(i).data("name"),"EMAIL;PREF":h(i).data("addr"),id:a,isExist:!0}):t.push({FN:h(i).data("name"),"EMAIL;PREF":h(i).data("addr")})}),0!==t.length&&E.createPabContacts(t,!0).then(function(e){h.each(e,function(e,t){if("added"===t.action){var i=t.item["EMAIL;PREF"],a="";o.config.enableSecurityLevel&&h.each(m,function(e,t){return t.addr===i?(a=t.securityLevel,!1):void 0}),n.push({name:t.item.FN,addr:i,id:t.item.id,isExist:!0,securityLevel:a})}}),r.html(o.compile(c,{contacts:n}))})}T.updateUser({aftersend_saveaddr:u?0:1},!0).then(function(){h.notify.success(C.i18n.t("mail/msg_params_update_success")),i.hasClass("toggled")?i.removeClass("toggled"):i.addClass("toggled"),u=!u})}),a=this.$(".j-suc-title"),s=this.$(".j-status-detail"),e&&a.on("click","a",function(t){t.preventDefault();var n=h(this),i=n.attr("action"),a=o.state.param.mboxa||"";switch(i){case"status":n.hasClass("z-active")?(n.removeClass("z-active"),n.text(C.i18n.t("mail/compose_show_status")),s.html("")):(n.text(C.i18n.t("mail/compose_hide_status")),n.addClass("z-active"),A.listDeliveryHistory({mid:e,mboxa:a}).then(function(e){h.each(e,function(e,t){t.status=A.getDeliveryStatusI18n(t.result,t.rclResult||"");var n=f(t.modtime);t.time=n.format("LL")+" "+n.format("HH:mm")}),s.html(e.length>0?o.compile(d,{result:e}):C.i18n.t("mail/msg_no_delivery_status"))}));break;case"recall":o.recallBox?o.recallBox.show():!function(){var t=o.$("#recallMailTpl").html(),n={CONFIRM:"needConfirm",FAIL:"fail",SUCCESS:"success"},i=function(e,i){var a={isConfirm:!1,isFail:!1,isSuccess:!1,meta:{}};if(e)switch(e){case n.CONFIRM:a.isConfirm=!0;break;case n.FAIL:a.isFail=!0;break;case n.SUCCESS:a.isSuccess=!0;break;default:a.isConfirm=!0}else a.isConfirm=!0;return h.isPlainObject(i)&&(a.meta=i),o.compile(t,a)},a=function(e){var t;if(e&&e.code)switch(e.code){case"FA_MAIL_NOT_FOUND":t=C.i18n.t("mail/recall_fail_mail_not_found");break;case"FA_UNSUPPORT_RECALL":t=C.i18n.t("mail/recall_fail_unsupport");break;case"FA_MAIL_EXPIRED":t=C.i18n.t("mail/recall_fail_expired");break;default:t=C.i18n.t("mail/recall_fail")}else t=C.i18n.t("mail/recall_fail");s.set("message",i(n.FAIL,{recallFailReason:t}))},r=function(e){s.set("message",i(n.SUCCESS,{recallData:e}))},s=o.recallBox=new w({isRecallConfirm:!1,title:C.i18n.t("mail/recall_mail"),message:i(n.CONFIRM),confirmTpl:C.i18n.t("common/confirm"),cancelTpl:C.i18n.t("common/cancel"),onConfirm:function(){s.get("isRecallConfirm")?this.hide():(s.set("isRecallConfirm",!0),s.element.mask(),A.recallMessage({mid:e}).then(function(e){r(e),s.element.mask("hide")},function(e){a(e),s.element.mask("hide")}),s.set("cancelTpl",""))},onCancel:function(){this.hide()}});o.recallBox.show()}();break;case"checkSent":o.sendMessage("mail","view:change",{module:"mail.read",param:{fid:_.sent,id:e,mid:e,tabTitle:p.subject}})}}),this.$(".j-more-action").on("click","a",function(e){e.preventDefault();var t,n=h(this),i=n.data("type"),a={};"back"===i?(t=T.getUser().preview_layout,o.get("editorExpand")?(a.fid=1,t&&(a.layout=t),o.sendMessage("dispatcher","history:add",{module:t?"mail.previewlayout":"mail.list",param:a})):o.sendMessage("mail","view:close",{id:o.get("tabId"),target:t?"previewlayout":"list"})):"continue"===i&&A.getComposeInfo({ctype:"normal"}).then(function(e){e&&e.id&&(a.id=e.id),T.setCurrentState({module:"mail.compose",param:a}),o.rerender(),o.sendMessage("dispatcher","view:render",{module:"mail.compose",param:{vid:"compose:"+e.id,id:e.id}})})})},_handleTblDraft:function(e){var t,n=this,a=h.Deferred(),r=this.$(".j-tbl-draft");if(t=h.isPlainObject(e)?e:i(this,!0),h.extend(!0,this._params.composeInfo,t),r.hasClass("disabled")||0!==this.get("uploader").attachupload("activeFiles"))a.resolve();else{if(n.get("uploader").attachupload("detectUploadedAttachSizeExceed"))return h.notify.error(C.i18n.t("mail/FA_OVERFLOW")),a.reject(),a.promise();this._disableToolbar(),j.sendMail({action:"save",id:n._params.composeInfo.composeId,attrs:t,returnInfo:!0}).done(function(e){h.notify.success(C.i18n.t("mail/compose_draft_success")),n._params.composeInfo.draftId=e.draftId,n._params.composeInfo._subject=t.subject||"";var i=e["var"].attachments;i&&n.get("uploader").attachupload("updateComposeAttachmentId",i),n.state.param.mid=e.draftId,n._refreshDraftFolder(),a.resolve()}).fail(function(e){u(e,C.i18n.t("mail/compose_draft_fail")),a.reject()}).always(function(){n._enableToolbar(),n._disableToolbar("draft")})}return a.promise()},_handleTblCancel:function(e){var t=this;if(!h(e).hasClass("disabled"))if(C.detector.isDetachMode()){var n=C.i18n.t("mail/msg_save_onbeforeunload")+"<br />"+C.i18n.t("mail/compose_confirm_before_leave");w.confirm(n,function(){t.set("tab_close",!0),window.open("","_parent",""),window.close()},function(){t.set("tab_close",!1)})}else this.beforedestroy(function(){t._setFullScreenMode(!1),j.cancelCompose({ids:t._params.composeInfo.composeId}).done(function(){t.sendMessage("mail","view:close",{})}).fail(function(){h.notify.error(C.i18n.t("mail/compose_cancel_fail"))})})},_handleForward:function(){var e=this,t=this.$("input[name=bcc]").val(),n=[],i=[];return t=t.split(/[,;]/),h.each(t,function(e,t){C.Email.test(t)&&(n.push(t),i.push({name:C.Email.parseTrueName(t),addr:C.Email.parseAddress(t)}))}),0===n.length?h.notify.error(C.i18n.t("mail/compose_need_rcpt")):(this._params.composeInfo._contacts=i,e.element.mask(),void j.directForward({mboxa:this.state.param.mboxa||"",mid:this.state.param.mid,bcc:n}).done(function(){e._handleSendSuccess()}).fail(function(){h.notify.error(C.i18n.t("mail/compose_send_fail"))}).always(function(){e.element.mask("hide")}))},_handleForwardCancel:function(){this.sendMessage("mail","view:close",{})},_handleAttach:function(e){var t=this,n=this.get("uploader").attachupload("isPluginValid"),i=e.value,a="macosx"===C.detector.os.name;switch(i){case"file":P.init("personalnf",function(e){h.isArray(e)&&e.length>0&&(t.$(".j-attachItem").show(),t.get("uploader").attachupload("mergeFiles",e))});break;case"externalNf":t._handleExternalAttach();break;case"totrs":t.get("uploader").attachupload("forceUploadToTrs");break;case"audio":n&&!a?t._handleVideoVoiceAttach("audio"):t._handleInstallTip("video");break;case"video":n&&!a?t._handleVideoVoiceAttach("video"):t._handleInstallTip("video")}},_handleExternalAttach:function(){var e=this,t=this.get("editor"),n=this._params.composeInfo.isHtml,i=function(e){var n=t.html();n+=e,t.html(n)},a=function(t,a){var r="";"boolean"!=typeof t||t||a?(t.length&&(h.each(t,function(e,t){n&&(r+='<div><a href="'+t.url+'" target="_blank">'+t.name+"</a></div>")}),i(r)),h.isArray(a)&&a.length>0&&(e.$(".j-attachItem").show(),e.get("uploader").attachupload("mergeFiles",a))):h.notify.error(C.i18n.t("file/msg_xnfbox_fail_select"))};n?M.selectFilesFromXNF(a,null,e._params.composeInfo.composeId).show():h.notify.error(C.i18n.t("file/msg_xnfbox_fail_editor_plaintext"))},_handleVideoVoiceAttach:function(e){var t=this;"video"===e?t._params.videoUpload?t._params.videoUpload.show():t._params.videoUpload=new N({uploader:t.get("uploader")}).render():t._params.voiceUpload?t._params.voiceUpload.show():t._params.voiceUpload=new $({uploader:t.get("uploader")}).render()},_handleAttachSummary:function(e){var t=this.$(".j-attach-summary"),n=this.$(".j-attaches"),i=n.find(".j-fileupload"),a=0,r=0;i.each(function(e,t){var n=h(t),i=n.data("data").files[0],s=i.size||i.actualSize;s="number"===h.type(s)?s:0,h(t).hasClass("u-fileupload-error")?a++:r+=s}),i.length>0?(t.show().find(".j-attach-info").html(C.i18n.t("mail/compose_attach_more",{total:i.length,size:C.size.bytesToSize(r,2),failed:a>0?C.i18n.t("mail/compose_attach_more_failed",{fail:a}):""})),i.length>4?(t.find(".j-attach-expand").show(),t.find(".j-attach-expand-desc").show().html(C.i18n.t("mail/compose_attach_expand_desc",{all:i.length-4})),"boolean"==typeof e&&(e?(i.filter(":gt(3)").slideUp(),t.find(".j-attach-less").hide().end().find(".j-attach-more").show()):(i.filter(":hidden").slideDown(),t.find(".j-attach-more").hide().end().find(".j-attach-less").show()))):(i.filter(":hidden").slideDown(),t.find(".j-attach-less").hide().end().find(".j-attach-expand").hide().end().find(".j-attach-more").show())):(i.filter(":hidden").slideDown(),t.hide())},_handleAttachUploaded:function(){var e=this.$(".j-html-menu span[data-type=attachuploaded]"),t=0;h.each(this.get("uploader").attachupload("doneFiles"),function(e,n){t+=n.cmMeta.size}),t>0?e.html(C.i18n.t("mail/compose_attach_uploaded")+C.size.bytesToSize(t,2)):e.html("")},_handleAttachTips:function(e,t,n){if("undefined"==typeof e)return!1;switch(t="boolean"==typeof t?t:!0,h.isPlainObject(n)||(n={}),e){case"toTrs":this._handleAttachToTrsTip(t,n.isSuccess);break;case"uploadFail":this._handleAttachUploadFailTip(n.type);break;case"hide":t&&this._handleAttachHideAllTip()}},_handleAttachToTrsTip:function(e,t){var n,i,a,r=this.$(".j-attach-tips"),s=r.find(".j-cnt"),o=2,l=C.size.bytesToSize(this.config.maxAttachmentSize,2);return e="boolean"==typeof e?e:!0,t="boolean"==typeof t?t:!0,e?(s.html(""),void r.slideUp()):void(t?(i=this.$(".j-fileupload.u-fileupload-trs"),n=[],a="mail/compose_attach_auto_to_trs",i.each(function(e,t){var i=h(t),a=i.data("data"),r=a.files[0];r.composeToTrs&&n.push(r.cmMeta.dname)}),n.length?(s.html(C.i18n.t(a,{limit:l,names:n.slice(0,o).join(C.i18n.t("mail/compose_attach_auto_to_trs_comma")),num:n.length,alive:T.getConfig("file.trsfileexpiry")})),r.slideDown()):(s.html(""),r.slideUp())):(s.html(""),r.slideUp()))},_handleAttachUploadFailTip:function(e){var t=C.size.bytesToSize(this.config.smtpMaxSendMailSize,2),n=C.size.bytesToSize(this.config.trsMaxFileSize,2),i={common:C.i18n.t("mail/compose_attach_error"),overflowNetfolder:C.i18n.t("mail/compose_attach_error_exceed_netfolder",{limit:n}),overflowCommon:C.i18n.t("mail/attach_error_tips_title_overflow",{limit:t}),forbidNetfolder:C.i18n.t("mail/compose_attach_error_forbid_netfolder")},a=function(){w.alert(i.common)};if("undefined"==typeof e||"string"!=typeof e)return void a();switch(e){case"requirePlugin":this._handleInstallTip("requirePlugin");break;case"overflow_netfolder":w.alert(i.overflowNetfolder);break;case"overflow":w.alert(i.overflowCommon);break;case"forbid_netfolder":w.alert(i.overflowCommon);break;default:a()}},_handleFileUploadFailDialog:function(){var e=this;e.fileUploadFailedBox||(e.fileUploadFailedBox=new w({parentNode:e.element,confirmTpl:C.i18n.t("mail/compose_ingore_and_send"),cancelTpl:C.i18n.t("mail/compose_back_edit"),title:C.i18n.t("main/sys_info"),message:C.i18n.t("mail/compose_upload_failed"),onConfirm:function(){e.$(".j-disable-edit,.j-enable-edit").remove(),e._params.autoSendAfterAttachUploaded=!1,e._handleTblSend(),this.hide()},onCancel:function(){e.$(".j-disable-edit,.j-enable-edit").remove(),e._params.autoSendAfterAttachUploaded=!1,this.hide()}}),e.fileUploadFailedBox.show())},_handleAttachHideAllTip:function(){var e=this.$(".j-attach-tips"),t=e.find(".j-cnt");t.html(""),e.slideUp()},_handleEditorToolbar:function(e,t){t="boolean"===h.type(t)?t:h(e).hasClass("active"),t?h(e).removeClass("active"):h(e).addClass("active"),this.get("editor").toolbar.div[t?"hide":"show"]("")},_handleEditorLink:function(){this.get("editor").clickToolbar("link")},_handleEditorIframeEvent:function(){var e,t,n,i,a;return i=this.get("uploader"),a=this.get("editor"),i&&a?(e=i.attachupload("option","dropZone"),t=h(h(a.container[0]).find("iframe").contents()),t.on("dragstart","img",function(){return!1}),n=[],h.merge(n,e),h.merge(n,t),i.attachupload("option","dropZone",n),!1):!1},_handleEditorScreenCapture:function(e){var t=this.get("uploader").attachupload("isPluginValid");if(t){if(h(e).hasClass("disabled"))return!1;var n,i,a=h(this.element).cmplugin("capture"),r=this;a.supportCapture?(n=a.capture(),n&&(i=a.upload(),this.get("uploader").attachupload("pluginAdd",i,{inlined:!0}).off("attachuploadcompleted.screencapture").on("attachuploadcompleted.screencapture",function(e,t){h.each(i,function(e,n){n===t.index&&t.files[0].inlined&&(r.get("editor").insertHtml('<img src="'+t.files[0].previewUrl+'" >'),t.context.remove())})}))):this._handleInstallTip("capture")}else this._handleInstallTip("capture")},_handleInstallTip:function(e,t){var n,i,a,r,s=C.detector.isSupportNPAPI();switch(e){case"requirePlugin":i=C.i18n.t("mail/attach_error_tips_need_plugin");break;case"overflow":i=C.i18n.t("mail/attach_error_tips_title_overflow",{limit:t});break;case"capture":i=s?C.i18n.t("mail/attach_error_tips_need_feature"):C.i18n.t("mail/attach_error_tips_title_"+e);break;case"video":i=s?C.i18n.t("mail/attach_error_tips_need_feature"):C.i18n.t("mail/attach_error_tips_title_"+e),i="macosx"===C.detector.os.name?C.i18n.t("compose/system_not_support")+"<br />"+i:i}n=this.compile(this.$("#pluginInstallTpl").html(),{supportNPAPI:s,title:i}),r=s?C.i18n.t("mail/attach_error_tips_install"):C.i18n.t("common/confirm"),a="macosx"===C.detector.os.name?"/cab/cmplugin_setup.dmg":"/cab/cmplugin_setup.exe",s?w.confirm(n,h.noop(),h.noop(),{onConfirm:function(){window.open(a),this.hide()},onCancel:function(){this.hide()},title:C.i18n.t("main/tip_title"),confirmTpl:r}):w.alert(n)},_handleEditorImage:function(){this.get("editor").clickToolbar("image")},_handleEditorMore:function(e){"source"===e.value&&(this.get("editor").designMode?this._stationeryDisable():this._stationeryAble(),this.get("editor").clickToolbar("source"),h(e.li).find("a").text(function(e,t){return t===C.i18n.t("mail/source_edit")?C.i18n.t("mail/close_source_edit"):C.i18n.t("mail/source_edit")}))},_handleEditorSignature:function(e){var t,n,i,r=this,s=e.value,o=e.isSame,l=r._params.composeInfo.isHtml;switch(s){case"edit":var c={module:"setting.account.signature",param:{}};T.setCurrentState(c),r.sendMessage("dispatcher","history:add",c);break;case"none":t=r.get("editor").html(),t=a(t,r._params.currentSign,"",l),r.get("editor").html(t),r._params.currentSign="";break;case"divider":break;default:if(o||null==s||s.indexOf("sign-")<0)break;if(n=s.substr(5),i=r._params.signs[n],null==i)break;t=r.get("editor").html(),t=a(t,r._params.currentSign,i.content,l),r.get("editor").html(t),r._params.currentSign=i.content}},_handleEditorMode:function(e,t,n){var i,r,s,l,c,d,u=this;n=n||{},s=n.confirmCall||h.noop,l=n.cancelCall||h.noop,c=n.confirmMsg||C.i18n.t("common/editor_html_source"),d=n.needConfirm||!1,"text"===t&&u.get("editor").designMode?(u._params.composeInfo.isHtml=!1,!u.get("editor").isEmpty()||d?w.confirm(c,h.noop(),h.noop(),{onConfirm:function(){r=o(),i=u.get("editor").html(),u.get("editor").clickToolbar("source"),i=a(i,u._params.currentSign,r,!0),i=C.html.html2text(i),i=a(i,r,u._params.currentSign,!1),u.get("editor").html(i),r=null,u._handleEditorToolbar(u.$("a[data-type=etbr]"),!0),u.$(".j-html-menu").hide(),u.$(".j-text-menu").show(),u._stationeryDisable(),h(u.get("editor")).blur(),this.hide(),s()},onCancel:function(){this.hide(),l()}}):(u.get("editor").clickToolbar("source"),u.get("editor").text(""),u._handleEditorToolbar(u.$("a[data-type=etbr]"),!0),u.$(".j-html-menu").hide(),u.$(".j-text-menu").show(),u._stationeryDisable(),s())):"html"!==t||u.get("editor").designMode?"text"!==t||u.get("editor").designMode||s():(u._params.composeInfo.isHtml=!0,i=u.get("editor").html(),u.get("editor").clickToolbar("source"),""===u.get("editor").text()&&(u._params.currentSign=""),r=o(),i=a(i,u._params.currentSign,r,!1),i=C.html.text2html(i),i=a(i,r,u._params.currentSign,!0,!0),u.get("editor").html(i),r=null,u.$(".j-html-menu").show(),u.$(".j-text-menu").hide(),u._stationeryAble(),s())},_handleMergeAttachments:function(e){var t=this,n=[];h.each(e,function(e,i){i.inlined||i.deleted||("internal"===i.type&&(i.composeId=t._params.composeInfo.composeId),n.push(i))}),n.length>0&&(t.$(".j-attachItem").show(),t.get("uploader").attachupload("mergeFiles",n,!1))},_bindDropDownMenuSignatureEvent:function(e){var t=this,n={none:[{name:C.i18n.t("mail/cancel_signature"),value:"none","default":0===e.length}]};n.signs=e,n.edit=[{name:C.i18n.t("mail/edit_signature"),value:"edit"}],t.$("a[data-type=signature]").find(".u-menu").length>0&&t.$("a[data-type=signature]").dropdown("destroy"),t.$("a[data-type=signature]").dropdown({maxWidth:400,data:n,beforeShow:function(){h(this).addClass("active")},callback:function(e){t._handleEditorSignature(e)},afterHide:function(){h(this).removeClass("active")}})},_handleEditorExpand:function(e,t,n){t="boolean"===h.type(t)?t:!h(e).data("expand"),n="boolean"===h.type(n)?n:!0,this._setFullScreenMode(t),t?h(e).children().removeClass("iconenlarge").addClass("iconnarrow"):h(e).children().removeClass("iconnarrow").addClass("iconenlarge"),
h(e).data("expand",t),this.set("editorExpand",t),n&&(h(this.element).trigger("resize.compose"),h(window).trigger("layoutResize"))},_handleSpellCheck:function(e){var t=this,n=e.data("mode");"mode_checkspelling"===n?(t.get("editor").clickToolbar("spellcheck"),e.data("mode","mode_re_checkspelling").text(C.i18n.t("compose/htmltool_re_spellcheck"))):"mode_re_checkspelling"===n&&t.get("editor").clickToolbar("spellrecheck")},_handleTimeSend:function(e){var t=this,n=t._params.composeInfo.scheduleDate?f(t._params.composeInfo.scheduleDate).toDate():new Date((new Date).getTime()+864e5),i=h(e),a=i.closest(".j-form-toolbar"),r=a.find(".bt-cnt .j-tb-timesend"),s="f-dn",o="ts";if(i.prop("checked")){if(!this._toggleFormToolChkTMAC(o,!0,a))return!1;t.$(".j-tbl-send").text(C.i18n.t("compose/lbt_compose_timesend_set")),r.removeClass(s)}else t.$(".j-tbl-send").text(C.i18n.t("compose/lbt_send")),r.addClass(s),this._toggleFormToolChkTMAC(o,!1,a);var c=t.$("#timesendtpl").html(),d={scheduleDate:C.messageFormat.format(C.i18n.t("mail/timesend_desc"),f(n).format("lll")),scheduleDateSelect:l(n)};r.html(t.compile(c,d)),r.off("change","select").on("change","select",function(){var e=h(this).val();switch(h(this).data("type")){case"year":n.setFullYear(e);break;case"month":n.setMonth(e-1);break;case"day":n.setDate(e);break;case"hour":n.setHours(e);break;case"minute":n.setMinutes(e)}t.$(".j-time-select").html(l(n)),t.$(".j-timesend-desc").html(C.messageFormat.format(C.i18n.t("mail/timesend_desc"),f(n).format("lll")))})},_handleMailCipher:function(e){var t,n,i=this,a=h(e),r=a.closest(".j-form-toolbar"),s=r.find('[data-type="savesent"]'),o=r.find(".bt-cnt .j-form-tb-mailcipher"),l="f-dn",c="rendered",d="mc";if(a.prop("checked")){if(!this._toggleFormToolChkTMAC(d,!0,r))return!1;o.removeClass(l),o.hasClass(c)||(n=i.$("#mailciphertpl").html(),o.html(i.compile(n,i)).addClass(c).customRadioCheckbox(),t=o.find("#bt-mailcipher-savePassword"),s.length<=0?t.parent().remove():(s.on("change",function(){h(this).prop("disabled")?z.disableChk(t):z.activeChk(t),!h(this).prop("checked")&&z.unCheckChk(t)}),t.on("click",function(){t.prop("checked")&&(s.prop("disabled")?z.unCheckChk(t):z.checkChk(s))})))}else o.addClass(l),this._toggleFormToolChkTMAC(d,!1,r)},_handleSmimeSign:function(e){var t=this,n=h(e),i=n.closest(".j-form-toolbar"),a=i.find('[data-category="coremaillEncrypt"]'),r='<div><div>{{i18n "mail/msg_signed_tip"}}</div><div><input type="password" size="40" value="" id="smimeKeyPass" autocomplete="off" tabindex="1"></div></div>';n.prop("checked")?(this._toggleFormToolChkTMAC("cm",!0,i),this.config.openSMIMEKeyPass&&"smimeSign"===n.attr("data-type")&&w.confirm(t.compile(r,{}),function(){j.authenticateSmimeKeyPass({smimeKeyPass:this.$("#smimeKeyPass").val()}).then(function(){return!0},function(){n.click(),n.val(!1),w.alert(C.i18n.t("compose/smime_pwd_err"))})},function(){n.click()})):a.eq(0).prop("checked")||a.eq(1).prop("checked")?this._toggleFormToolChkTMAC("cm",!0,i):this._toggleFormToolChkTMAC("cm",!1,i)},_handleAutoDel:function(e){var t,n=this,i=new Date((new Date).getTime()+864e5),a=h(e),r=h(e).closest(".j-form-toolbar"),s=r.find(".bt-cnt .j-tb-autodel"),o=r.find("input[data-type=savesent]"),c="f-dn",d="ad";if(a.prop("checked")){if(!this._toggleFormToolChkTMAC(d,!0,r))return!1;n._handleEditorMode(null,"text",{confirmCall:function(){o.length>0&&z.checkChk(o),n.$(".j-text-menu").find("[data-type=html]").hide(),n.$(".j-attachment-menu").addClass("attach-disabled"),t=n.compile(n.$("#autodeltpl").html(),{autoDelDateSelect:l(i,["year","month","day"])}),s.html(t),s.removeClass(c)},cancelCall:function(){a.click()}})}else o.length>0&&z.activeChk(o),this._toggleFormToolChkTMAC(d,!1,r),n._handleEditorMode(null,"html"),n.$(".j-attachment-menu").removeClass("attach-disabled"),s.addClass(c),n.$(".j-text-menu").find("[data-type=html]").show()},_handleSaveSent:function(e,t){var n=t.closest(".j-form-toolbar");n.find("[data-type=autodel]").is(":checked")&&(e.preventDefault(),z.checkChk(t),w.alert(C.i18n.t("mail/msg_autodel_save_local")))},_handleCacompose:function(e){var t,n=this,i="ca",a=e.data("action"),r=this.$("a[data-type=onercpt]"),s=this.get("uploader").attachupload("allFiles").length>0,o=e.closest(".j-form-toolbar"),l="useCAEncrypt"===a?this._params.useCASign:this._params.useCAEncrypt;if(0===h("[role=CAcomposePlugin]").length){var c=this.compile(n.$("#CApluginInjectTpl").html());h("body").append(c)}if(e.prop("checked")){if(!this._toggleFormToolChkTMAC(i,!0,o))return!1;if(!this.smime&&(t=h("[role=CAcomposePlugin]").find("object")[1],this.smime=new U(t),this.smime.invaild))return this.smime=null,this._toggleFormToolChkTMAC(i,!1,o),void z.unCheckChk(e);if(l)return void(this._params[a]=!0);this._handleEditorMode(null,"text",{confirmCall:function(){n.$(".j-text-menu").find("[data-type=html]").hide(),n.$(".j-attachItem").hide(),n.$(".j-attach-info").empty(),n.$(".j-attach-summary").hide(),n.$(".j-attach-tips").hide(),n.$(".u-fileupload").remove(),n._params[a]=!0,n._handleCaAttachment(),r.hasClass("z-active")&&r.click(),r.hide()},cancelCall:function(){n._toggleFormToolChkTMAC(i,!1,o),z.unCheckChk(e)},needConfirm:s,confirmMsg:C.i18n.t(s?"mail/msg_switch_to_cacompose":"common/editor_html_source")})}else{if(this._params[a]=!1,l)return;this._params.caAttachment.length>0?w.confirm(C.i18n.t("mail/ca_attachment_lost_notify"),function(){n._toggleFormToolChkTMAC(i,!1,o),n._handleEditorMode(null,"html"),n.$("[data-type=attach]").show(),n._params.caAttachment=[],n._initFormTTMenuUpload(),n.$(".j-text-menu").find("[data-type=html]").show(),n.$(".j-attachItem").hide(),n.$(".u-fileupload").remove(),r.show()},function(){n._params[a]=!0,n._toggleFormToolChkTMAC(i,!0,o),z.checkChk(e)}):(n._toggleFormToolChkTMAC(i,!1,o),n._handleEditorMode(null,"html"),n.$("[data-type=attach]").show(),r.show(),n._initFormTTMenuUpload())}},_handleCaAttachment:function(){var e,t,n=this,i=this.$("#CAattachTpl").html(),a=this.$(".j-attachItem"),r=this.$(".j-attaches");this.get("uploader").off("attachuploaddragenter attachuploaddragover attachuploaddragleave attachuploaddrop"),this.$("[data-type=attach]").hide(),this.$(".j-attachLimit").html(C.i18n.t("compose/lbt_addattach_limit").replace("{0}",C.size.bytesToSize(this.config.smimeUploadAttachSizeLimit))),this.$("[data-type=upload]").off("click").on("click initUpload",function(t){"initUpload"!==t.type&&(n._params.caAttachment=n.smime.dealWithAddResult(n._params.caAttachment,n.config.smimeUploadAttachSizeLimit)),n._params.caAttachment.length&&(e=n.compile(i,{items:n._params.caAttachment}),r.html(e),a.show())}),a.on("click",".j-delete-caattach",function(s){s.preventDefault(),t=h(s.target).data("index"),n._params.caAttachment.splice(t,1),e=n.compile(i,{items:n._params.caAttachment}),r.html(e),n._params.caAttachment.length||a.hide()})},_handleAutoDelValid:function(e,t){("undefined"==typeof t||t.length<=0)&&(t=this.$(".j-form"));var n,i,a,r,s,o,l=t.find(".j-form-toolbar"),c=l.find("input[data-type=autodel]"),d=l.find(".bt-cnt .j-tb-autodel"),u=/^(0?[1-9]|[1-9][0-9])/;return e="boolean"==typeof e?e:!0,c.length<0||!c.is(":checked")?!0:(r=+d.find(".j-read-limit").val(),u.test(r)?this.get("uploader").attachupload("allFiles").length>0?(!e&&w.alert(C.i18n.t("mail/msg_autodel_attachment_unsuppoerted"),function(){d.find(".j-read-limit").focus()}),!1):(n=d.find("select[data-type=year]").val(),i=d.find("select[data-type=month]").val(),a=d.find("select[data-type=day]").val(),s=new Date(+n,+i-1,+a,23,59,59),o=new Date,s.getTime()<o.getTime()?(!e&&w.alert(C.i18n.t("mail/msg_autodel_limit_wronttime")),!1):!0):(!e&&w.alert(C.i18n.t("mail/msg_autodel_limit_require")),!1))},_disableCompose:function(){this._disableToolbar(),h(this.element).off("resize.compose"),this._params.resizeTimer&&clearTimeout(this._params.resizeTimer)},_enableCompose:function(){this._enableToolbar(),this._bindEditorResize(),h(this.element).trigger("resize.compose")},_setFullScreenMode:function(e){var t,n=this.element;for(e="boolean"===h.type(e)?e:!0,e?this.element.addClass("z-expand"):this.element.removeClass("z-expand");(t=h(n).parent()).length>0;)e?t.addClass("u-fullscreen"):t.removeClass("u-fullscreen"),n=t},_disableToolbar:function(e){var t,n=this,i=n.$(".j-toolbar");switch(e){case"draft":t=i.find(".j-tbl-draft").data("disabled",!0),t.hasClass("disabled")||t.addClass("disabled").html(C.i18n.t("common/saved"));break;default:i.find(".u-btn[data-type!=aside]").each(function(){var e=h(this);return n.get("uploader").attachupload("activeFiles")>0&&"send"===e.data("type")?(e.removeClass("disabled"),!0):("draft"===e.attr("data-type")&&e.hasClass("disabled")&&e.html(C.i18n.t("compose/lbt_compose_save")),void e.addClass("disabled"))}).end().addClass("disabled")}},_enableToolbar:function(e){var t,n=this,i=n.$(".j-toolbar");if(this.get("uploader").data("cm-attachupload")&&this.get("uploader").attachupload("activeFiles")>0)return!1;switch(e){case"draft":i.hasClass("disabled")||(t=i.find(".j-tbl-draft").data("disabled",!1),t.hasClass("disabled")&&t.removeClass("disabled").html(C.i18n.t("compose/lbt_compose_save")));break;default:i.find(".u-btn[data-type!=aside]").each(function(){var e=h(this);"draft"===e.attr("data-type")&&e.hasClass("disabled")&&e.html(C.i18n.t("compose/lbt_compose_save")),e.removeClass("disabled")}).end().removeClass("disabled")}},_refreshDraftFolder:function(){var e=A.getFoldersMap().draft;this.sendMessage("mail","folder:refresh",{ids:e}),this.sendMessage("mail.list","view:refresh",{fid:e}),this._params.refreshedFolder=!0},_getContacts:function(){var e,t=this.$(".j-form-tt"),n=this,i={};return e=t.find("input[role=contact]").tagEditor("getTags"),h.each(e,function(e,t){var a=h(t.field).attr("name");i[a]=[],h.each(t.tags,function(e,t){var r,s,o,l,c=-1;n.config.enableSecurityLevel&&(o=C.securityLevel.departSLFromAddress(t),t=o.address,c=C.securityLevel.getSLValueByName(o.securityLevel,!1)),r=C.Email.parseTrueName(t),s=C.Email.parseAddress(t),l={name:r,addr:s},-1!==c&&(l.securityLevel=c,l.isOab=!0),i[a].push(l)})}),i},_renderRecentContacts:function(){var e=this,t=e.config.enableModifySendTo;h.when(E.getPabHitCounterWithDetails(),E.getPabGroupsAndItsMembers()).then(function(n,i){h.each(i,function(e,t){"OTHER"===t.id&&(t.name=C.i18n.t("contact/gp_other")),t.title=C.messageFormat.format(C.i18n.t("contact/lbl_grpNameWithCount"),[t.name,t.count])}),0!==n.length&&i.unshift({name:C.i18n.t("main/pab_recent_contact"),count:n.length,title:C.messageFormat.format(C.i18n.t("contact/lbl_grpNameWithCount"),[C.i18n.t("main/pab_recent_contact"),n.length]),children:n,expand:!0,flag:"j-recent"});var a=e.$("#contactsTpl").html(),r=e.compile(a,{groups:i});r=h(r).on("click","a[data-toggled]",function(e){e.preventDefault();var t=h(this).parents(".aWrapper").next();t.hasClass("toggled")?t.slideUp(300):t.slideDown(300),h(this).find(".iconfont").toggleClass("icondown iconright"),t.toggleClass("toggled")}).on("click","li",function(n){t&&(n.preventDefault(),e.trigger("contact:tag:add",{addr:h(this).data("addr"),name:h(this).data("name")}))}).on("click","a[data-trigger]",function(n){if(t){n.preventDefault();var i=h(this).parents(".aWrapper").next();i.find("li").each(function(){e.trigger("contact:tag:add",{addr:h(this).data("addr"),name:h(this).data("name")})})}}),e.$("#mptree").html(r)})},_clearSearchCont:function(e){h("#searchInput").val("").focus(),this._searchPabContact(e,this.$("#searchInput"))},_searchPabContact:function(e,t){if(!T.getConfig("user.supportpab"))return!1;var n=this,i=h(t).val();i?(n.$("#mptree").children(':not(".j-recent")').addClass("f-dn"),n.$("#searchResultContainer").removeClass("f-dn"),E.matchPabContacts(i).then(function(e){var t=n.$("#searchResultItem").html(),i="";h.each(e,function(e,a){i+=n.compile(t,a)}),n.$("#searchResultContainer ul").html(i)})):(n.$("#mptree").children().removeClass("f-dn"),n.$("#searchResultContainer").addClass("f-dn"))},_updateContactTags:function(e,t){if(this.config.enableModifySendTo){var n=this,i=h(t).data("addr"),a=C.Email.parseTrueName(i),r=C.Email.parseAddress(i);n.trigger("contact:tag:add",{addr:r,name:a})}},_renderTemplate:function(){0===this.$(".j-aside .template-list").length&&new F({editor:this.get("editor"),container:this.$("div.j-template-box"),pagination:this.$(".j-template-pagination"),parent:this}).render()},_renderStationery:function(){0===this.$(".j-aside .j-stationery-box").length&&new L({editor:this.get("editor"),prefixCls:"stationery-content",container:this.$("div.j-aside"),pagination:this.$(".j-stationery-pagination")}).render()},_stationeryDisable:function(){h(".stationery-wrapper").addClass("disabled").find(".stationery-thumb").removeClass("stationery-selected")},_stationeryAble:function(){this.$(".stationery-wrapper",".j-aside").removeClass("disabled")},_replaceEditorSign:a,_toggleFormToolChkTMAC:function(){var e,t,n,i,a,r="ts",s="mc",o="ad",l="ca",c="cm";return function(d,u,p){if(d&&p){if(e=p.find('[data-type="timesend"]'),t=p.find('[data-type="mailcipher"]'),n=p.find('[data-type="autodel"]'),i=p.find('[data-type="cacompose"]'),a=p.find('[data-category="coremaillEncrypt"]'),u){if(d===r&&e.length>0){if(t.is(":checked")||n.is(":checked")||i.is(":checked"))return z.unCheckAndDisableChk(e),!1;z.unCheckAndDisableChk(t),z.unCheckAndDisableChk(n),z.unCheckAndDisableChk(i)}else if(d===s&&t.length>0){if(e.is(":checked")||n.is(":checked")||i.is(":checked")||a.is(":checked"))return z.unCheckAndDisableChk(t),!1;z.unCheckAndDisableChk(e),z.unCheckAndDisableChk(n),z.unCheckAndDisableChk(i),z.unCheckAndDisableChk(a)}else if(d===o&&n){if(e.is(":checked")||t.is(":checked")||i.is(":checked"))return z.unCheckAndDisableChk(n),!1;z.unCheckAndDisableChk(t),z.unCheckAndDisableChk(e),z.unCheckAndDisableChk(i)}else if(d===l&&i){if(e.is(":checked")||t.is(":checked")||n.is(":checked"))return z.unCheckAndDisableChk(i),!1;z.unCheckAndDisableChk(t),z.unCheckAndDisableChk(e),z.unCheckAndDisableChk(n)}else if(d===c&&a){if(t.is(":checked"))return z.unCheckAndDisableChk(a),!1;z.unCheckAndDisableChk(t)}}else d!==r&&e.length>0&&z.activeChk(e),d!==s&&t.length>0&&z.activeChk(t),d!==o&&n&&z.activeChk(n),d!==l&&i.length>0&&z.activeChk(i),d!==c&&a.length>0&&z.activeChk(a);return!0}}}(),templateHelpers:{}});b.module({name:"mail.compose",template:e("text!template/module/mail/compose.tpl.html")},B);var z={chkDisableClass:"rc-disabled",chkCheckedClass:"checkbox-checked",disableChk:function(e){e.prop("disabled",!0).next("i.checkbox").addClass(this.chkDisableClass)},activeChk:function(e){e.prop("disabled",!1).next("i.checkbox").removeClass(this.chkDisableClass)},unCheckChk:function(e){e.prop("checked",!1).next("i.checkbox").removeClass(this.chkCheckedClass)},checkChk:function(e){e.prop("checked",!0).next("i.checkbox").addClass(this.chkCheckedClass)},checkAndActiveChk:function(e){this.checkChk(e),this.activeChk(e)},unCheckAndDisableChk:function(e){this.unCheckChk(e),this.disableChk(e)}},V=function(){var e,t,n,i,a;return function(r,s){var o,l,c="f-dn";return(!e||e.length<=0)&&(e=r.$(".j-form-toolbar"),t=e.find(".bt-hd-wrap"),n=e.find(".bt-hd"),i=e.find(".bt-hd-more-show"),a=e.find(".bt-hd-more-hide")),o=i.height(),l=n.height(),l===o?(a.addClass(c),i.addClass(c),void t.css("height",o+"px")):(s="boolean"==typeof s?s:!a.hasClass(c),void(s?(a.removeClass(c),i.addClass(c),t.css("height",l+"px")):(a.addClass(c),i.removeClass(c),t.css("height",o+"px"))))}}()}),define("components/requirejs-text/text!template/module/contact/contact.tpl.html",[],function(){return'<section class="m-contact j-contact" id="contactView">\r\n  <div class="contact-wrapper">\r\n    <aside class="ctsidebar">\r\n      <div class="navbar-expand j-navbar-toggle">\r\n        <i class="iconfont iconright"></i>\r\n      </div>\r\n    </aside>\r\n    <article class="ctmain">\r\n      <div class="ctmain-bg"></div>\r\n      <div class="j-contact-content"></div>\r\n    </article>\r\n  </div>\r\n  {{#raw}}\r\n  <script type="text/x-handlebar-template" id="navTabTpl">\r\n    <div class="ctsidebar-bg"></div>\r\n    <nav class="u-tab u-tab-highlight-down">\r\n      <ul class="cttabs">\r\n        [[#if isSupportOab]]\r\n        <li data-trigger="contact.oab">\r\n          <a href="javascript:void(0)">\r\n            {{i18n "contact/tab_oab"}}\r\n            <span class="bar"></span>\r\n          </a>\r\n        </li>\r\n        [[/if]]\r\n        [[#if isSupportPab]]\r\n        <li data-trigger="contact.pab">\r\n          <a href="javascript:void(0)">\r\n            {{i18n "contact/tab_pab"}}\r\n            <span class="bar"></span>\r\n          </a>\r\n        </li>\r\n        [[/if]]\r\n      </ul>\r\n    </nav>\r\n    [[#if isSupportOab]]\r\n    <div class="u-scroll f-dn scroll-wrapper">\r\n      <ul class="ztree" id="cloTree"></ul>\r\n    </div>\r\n    [[/if]]\r\n    [[#if isSupportPab]]\r\n    <div class="u-scroll f-dn scroll-wrapper">\r\n      <ul class="ztree" id="clpTree"></ul>\r\n      <div class="link-wrapper">\r\n        <a href="javascript:void(0)" data-operation="addGroup">[{{i18n "contact/lbl_addGrp"}}]</a>\r\n      </div>\r\n      <div class="link-wrapper">\r\n        <a href="javascript:void(0)" data-operation="addContact">[{{i18n "contact/lbl_addContact"}}]</a>\r\n      </div>\r\n      <div class="link-wrapper">\r\n        <a href="javascript:void(0)" data-operation="mangeGroups">[{{i18n "contact/lbl_manageGroup"}}]</a>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n  </script>\r\n  {{/raw}}\r\n</section>'}),define("module/contact/index",["require","jquery.ztree","util/i18n!contact","jquery","util/i18n","./service","cui/core/view/view","cui/ui/tabview/tabview","util/messageformat","cui/core/view/viewmanager","module/common/globalService","cui/util/templatable/templatable","text!template/module/contact/contact.tpl.html"],function(e){function t(e,t){var n=e.tabview.current().id,i=t.module,a=i+(t.param&&t.param.cid?":"+t.param.cid:"");if(a!==n&&0===i.indexOf("contact.")){if(c.setCurrentState(t),e.tabview.find(a))return e.tabview.switchTo(a),!1;var r={id:a,replaceId:i,title:" ",module:l.module(i)};return e.tabview.addTab(r),!0}return!1}e("jquery.ztree"),e("util/i18n!contact");var n=e("jquery"),i=e("util/i18n"),a=e("./service"),r=e("cui/core/view/view"),s=e("cui/ui/tabview/tabview"),o=e("util/messageformat"),l=e("cui/core/view/viewmanager"),c=e("module/common/globalService"),d=e("cui/util/templatable/templatable"),u=r.extend({Implements:d,events:{"click .j-navbar-toggle":"_toggleExpand","click [data-trigger]":"_switchNavTab"},activeView:"contact.oab",moduleMap:["contact.oab","contact.pab"],_params:{isTriggerByUrl:!1,userDN:c.getUser()["@ou"],orgid:c.getConfig("user.orgid"),isSupportOab:c.getConfig("user.supportoab")||!1,isSupportPab:c.getConfig("user.supportpab")||!1},setup:function(){var e=c.getCurrentState(),t=e.param.view;!t||"oab"!=t&&"pab"!=t||(this.activeView="contact."+t),"contact.oab"!=this.activeView||this._params.isSupportOab||(this.activeView="contact.pab"),"contact.pab"!=this.activeView||this._params.isSupportPab||(this.activeView="contact.oab"),e.module=this.activeView,this._params.isOab="oab"==this.activeView.split(".")[1],delete e.param.view,this._params.cid=e.param.cid,e.param.type&&(this._params.isTriggerByUrl=!0),this._setHistory(e)},render:function(){var e=this;u.superclass.render.call(e),e._renderNavTab(),e._activeNavTab(),e._initNavTree(),e._initTabView(),e._initModuleEvent()},destroy:function(){var e=this;e.tabview&&e.tabview.destroy(),u.superclass.destroy.call(e)},_renderNavTab:function(){var e=this,t=e.compile(e.$("#navTabTpl").html(),{isSupportOab:e._params.isSupportOab,isSupportPab:e._params.isSupportPab});n(".ctsidebar").prepend(t)},_initTabView:function(){var e=this,t=[];e._params.isSupportOab&&t.push({id:"contact.oab:"+(e._params.cid||e._params.userDN),title:" ",module:l.module("contact.oab")}),e._params.isSupportPab&&t.push({id:"contact.pab:"+(e._params.cid||""),title:" ",module:l.module("contact.pab")}),!e._params.isSupportOab&&e._params.isSupportPab&&(e.activeView="contact.pab");var i=e.activeView;i+="contact.pab"==i?":"+(e._params.cid||""):":"+(e._params.cid||e._params.userDN),e.tabview=new s({element:".j-contact",classPrefix:"j-contact",activeTabId:i,activeTriggerClass:"active",onlyRenderActive:!0,tabs:t}),e.tabview.render(),e.tabview.on("render",function(t){var i=t.split(":");e.activeView=i[0];var a={module:i[0],param:{}};if("undefined"!==n.type(i[1])&&(a.param.cid=i[1]),e._params.isTriggerByUrl){var r=c.getCurrentState();r.param&&delete r.param.view,a=n.extend(!0,r,a),e._params.isTriggerByUrl=!1}e.sendMessage("dispatcher","view:render",a)}),e.tabview.on("refresh",function(t){var i=t.split(":");e.activeView=i[0];var a={module:i[0],param:{}};"undefined"!==n.type(i[1])&&(a.param.cid=i[1]),e.sendMessage("dispatcher","view:refresh",a),e.sendMessage(a.module,"methodInvocation",{method:"refreshList"})})},_initNavTree:function(){var e=this;e.options={view:{showLine:!1,showIcon:!1,selectedMulti:!1,addDiyDom:function(t,n){e._addDiyDom(e,t,n)}},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"pId",rootPId:""}},callback:{beforeClick:function(i,a){var r=!!a.dn,s=n.fn.zTree.getZTreeObj(r?"cloTree":"clpTree");a.isParent&&s.expandNode(a,!0);var o=r?"contact.oab":"contact.pab",l=r?a.dn:a.id;r&&e.$('.cttabs [data-trigger="contact.oab"]').data("cid",l),e._params.cid=l,e._params.isOab=r;var c={module:o,param:{cid:l}};return t(e,c),!0},onNodeCreated:function(e,t,i){n("#"+i.tId+"_a").attr("title",i.name)}}},e.on("renderPabGrps",function(){n.when(a.getPabGroupsWithCount()).then(function(t){var a=t.groups;n.each(a,function(e,t){var n=t.name||i.t("common/none");t.name=o.format(i.t("contact/lbl_grpNameWithCount"),[n,t.count])}),a.unshift({name:o.format(i.t("contact/lbl_grpNameWithCount"),[i.t("contact.gp_all"),t.gcCount]),id:""}),a.push({name:o.format(i.t("contact/lbl_grpNameWithCount"),[i.t("contact.gp_other"),t.noGroupContactsCount]),id:"OTHER"}),e.pzTree=n.fn.zTree.init(e.$("#clpTree"),e.options,a),"contact.pab"==e.activeView&&e._clickNode(e.pzTree,e._params.cid||"",!1)})}),e.on("renderOabDirs",function(){n.when(a.getOabDirectories()).then(function(t){var r=e._params.userDN,s=a.format2TreeAndSetIndex(t);n.each(t,function(e,t){t.name=t.name||i.t("common/none")}),e.ozTree=n.fn.zTree.init(e.$("#cloTree"),e.options,s),"contact.oab"==e.activeView&&e._clickNode(e.ozTree,e._params.cid||r)})}),"contact.oab"==e.activeView&&e._params.isSupportOab&&e.trigger("renderOabDirs"),"contact.pab"==e.activeView&&e._params.isSupportPab&&e.trigger("renderPabGrps")},_setHistory:function(e){this.sendMessage("dispatcher","view:render",e)},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(n){var i=n.message.newState;0===i.module.indexOf("contact.")&&(e._activeNavTab(e.moduleMap.indexOf(i.module)),e._params.cid=i.param&&i.param.cid,"contact.oab"==i.module?(e._params.isOab=!0,e.ozTree?e._params.cid&&e._clickNode(e.ozTree,e._params.cid):e.trigger("renderOabDirs")):(e._params.isOab=!1,e.trigger("renderPabGrps")),delete i.param.view,e._params.isTriggerByUrl=!0,!t(e,i)&&e.sendMessage(i.module,"methodInvocation"))}),e.subscribe("dispatcher","view:changed",function(t){var n=t.message.newState;0===n.module.indexOf("contact")&&("contact.oab"==n.module&&(e._params.isOab||delete e._params.cid,e._params.isOab=!0,e.ozTree?e._params.cid&&e._clickNode(e.ozTree,e._params.cid):e.trigger("renderOabDirs")),"contact.pab"==n.module&&(e._params.isOab&&delete e._params.cid,e._params.isOab=!1,e.trigger("renderPabGrps")),e.sendMessage(n.module,"methodInvocation",{method:"refreshList"}))}),e.$("aside.ctsidebar").on("click","[data-operation]",function(){var t=n(this).data("operation");t&&e.sendMessage("contact.pab","methodInvocation",{method:t})}),e.onMessage("refresh:pabTree",function(){e.trigger("renderPabGrps")}),e.onMessage("oabTree:markNode",function(t){var n=t.message;e._clickNode(e.ozTree,n.cid),-1===n.cid.indexOf("/")&&e.$("aside.ctsidebar div.scroll-wrapper:eq(0)").scrollTop(0)})},_activeNavTab:function(e){var t=this,i=t.$(".cttabs > li"),a=t.$(".ctsidebar > .scroll-wrapper");1==i.length?(i.addClass("z-current"),a.removeClass("f-dn")):(e="undefined"!==n.type(e)?e:t.moduleMap.indexOf(t.activeView),i.removeClass("z-current"),i.eq(e).addClass("z-current"),a.addClass("f-dn"),a.eq(e).removeClass("f-dn"))},_switchNavTab:function(e,i){var a=this,r=n(i).data("trigger"),s=a.moduleMap.indexOf(r);a._activeNavTab(s);var o={module:r,param:{}},l=n(i).data("cid");"undefined"!==n.type(l)&&(o.param.cid=l),t(a,o)},_toggleExpand:function(){var e=this;e.$(".contact-wrapper").toggleClass("expanded"),e.$(".navbar-expand i").toggleClass("iconright iconleft")},_addDiyDom:function(e,t,n){var i=16,a=e.$("#"+n.tId+"_a"),r=e.$("#"+n.tId+"_switch"),s=a.find("#"+n.tId+"_ico");s.before(r),n.level=n.level?n.level:0;var o='<span style="display: inline-block;width: '+i*(n.level+1)+'px"></span>';if(r.before(o),!n.isParent){var l='<i class="iconfont icongroup"></i>';r.css("line-height","14px").html(l)}r.parent().wrap(function(){return'<div class="node-wrapper"/>'})},_clickNode:function(e,t,i){i="boolean"===n.type(i)?i:!0;var a=e.getNodeByParam(i?"dn":"id",t);e.selectNode(a),a&&a.isParent&&e.expandNode(a,!0)}});l.module({name:"contact",template:e("text!template/module/contact/contact.tpl.html")},u)}),define("module/contact/oab/service",["require","jquery","util/index","util/sitenode","module/contact/service","module/common/globalService"],function(e){function t(e,n,i){if("array"!=a.type(e)){var r=[];return r.push(e),t(r,n,i)}for(var s in e){var o=e[s].id;o=o==n?n:n+"/"+o;var l=e[s].name||"";i=i?i+"/"+l:l,c[o]||(c[o]=i),e[s].ou&&t(e[s].ou,n,i),i=i.substr(0,i.lastIndexOf("/"))}return c}function n(){var e=a.Deferred();return o.getOabDirectories().then(function(n){var i=l.getUser()["@ou"],a=s.getOrg(i),r=t(n,a);e.resolve(r)}),e.promise()}function i(e,t){var n=a.Deferred();return r.xhr.simpleCall({preprocess:!1,query:{func:"oab:exportToPAB",sid:l.getSid()},data:{list:e,grp:t,returnSummary:!0},onlyVar:!1},function(e){var t=e.summary||{};n.resolve(t.added,t.updated,t.ignored)},function(){n.reject()}),n.promise()}var a=e("jquery"),r=e("util/index"),s=e("util/sitenode"),o=e("module/contact/service"),l=e("module/common/globalService"),c={};return{getDirectoriesRecursive:n,exportToPab:i}}),define("util/province-city",["require","jquery"],function(e){function t(e,t,i,r,l){var c='<option value="-1">-----------</option>',d='<option value="-1">-----------</option>';i=i||-1,r=r||-1;for(var u=0;u<s.length;u++){var p=s[u];c+='<option value="'+p.id+'">'+(n(l)?p.text:p.py_text)+"</option>"}a(e).html(c),a(e).val(i),a(e).on("change",function(){var e=a(this).val();if(-1!=e){for(var i="",r=0;r<o.length;r++){var s=o[r];s.pid==e&&(i+='<option value="'+s.id+'">'+(n(l)?s.text:s.py_text)+"</option>")}a(t).html(i)}});for(var m=0;m<o.length;m++){var h=o[m];h.pid==i&&(d+='<option value="'+h.id+'">'+(n(l)?h.text:h.py_text)+"</option>")}a(t).html(d),a(t).val(r)}function n(e){return""==e||"zh_CN"==e}function i(e,t,i){if(i=i||"",-1==e)return"";for(var a="",l="",c=0;c<s.length;c++){var d=s[c];if(d.id==e){if(a=n(i)?d.text+r.province.text:d.py_text+" "+r.province.py_text,-1==t)return a;for(var u=0;u<o.length;u++){var p=o[u];if(p.pid==e&&p.id==t)return l=n(i)?p.text+r.city.text:p.py_text+" "+r.city.py_text,n(i)?a+l:l+", "+a}}}}var a=e("jquery"),r={province:{text:"",py_text:"Province"},city:{text:"",py_text:"City"}},s=[{text:"",py_text:"Guangdong",id:0},{text:"",py_text:"Guangxi",id:1},{text:"",py_text:"Beijing",id:2},{text:"",py_text:"Hainan",id:3},{text:"",py_text:"Fujian",id:4},{text:"",py_text:"Tianjin",id:5},{text:"",py_text:"Hunan",id:6},{text:"",py_text:"Hubei",id:7},{text:"",py_text:"He'nan",id:8},{text:"",py_text:"Hebei",id:9},{text:"",py_text:"Shandong",id:10},{text:"",py_text:"Shanxi",id:11},{text:"",py_text:"Heilongjiang",id:12},{text:"",py_text:"Liaoning",id:13},{text:"",py_text:"Shanghai",id:14},{text:"",py_text:"Gansu",id:15},{text:"",py_text:"Qinghai",id:16},{text:"",py_text:"Xinjiang",id:17},{text:"",py_text:"Tibet",id:18},{text:"",py_text:"Ningxia",id:19},{text:"",py_text:"Sichuan",id:20},{text:"",py_text:"Yunnan",id:21},{text:"",py_text:"Jilin",id:22},{text:"",py_text:"Inner Mongolia",id:23},{text:"",py_text:"Shanxi",id:24},{text:"",py_text:"Anhui",id:25},{text:"",py_text:"Guizhou",id:26},{text:"",py_text:"Jiangsu",id:27},{text:"",py_text:"Chongqin",id:28},{text:"",py_text:"Zhejiang",id:29},{text:"",py_text:"Jiangxi",id:30},{text:"",py_text:"Abroad",id:31},{text:"",py_text:"Taiwan",id:32},{text:"",py_text:"Hongkong",id:33},{text:"",py_text:"Macao",id:34}],o=[{text:"",py_text:"GuangZhou",id:0,pid:0},{text:"",py_text:"ShenZhen",id:1,pid:0},{text:" ",py_text:"ZhuHai",id:2,pid:0},{text:"",py_text:"ShaoGuan",id:3,pid:0},{text:"",py_text:"ChaoZhou",id:4,pid:0},{text:"",py_text:"ShanTou",id:5,pid:0},{text:"",py_text:"ZhaoQing",id:6,pid:0},{text:"",py_text:"ZhanJiang",id:7,pid:0},{text:"",py_text:"FoShan",id:8,pid:0},{text:"",py_text:"XinHui",id:9,pid:0},{text:"",py_text:"HeYuan",id:10,pid:0},{text:"",py_text:"ChaoYang",id:11,pid:0},{text:"",py_text:"JieYang",id:12,pid:0},{text:"",py_text:"NanHai",id:13,pid:0},{text:"",py_text:"MaoMing",id:15,pid:0},{text:" ",py_text:"HuiZhou",id:16,pid:0},{text:"",py_text:"MeiZhou",id:17,pid:0},{text:"",py_text:"Shanwei",id:18,pid:0},{text:"",py_text:"YangJiang",id:19,pid:0},{text:"",py_text:"QingYuan",id:20,pid:0},{text:"",py_text:"DongWan",id:21,pid:0},{text:"",py_text:"ZhongShan",id:22,pid:0},{text:"",py_text:"YunFu",id:23,pid:0},{text:"",py_text:"Other",id:9999,pid:0},{text:"",py_text:"NanNing",id:0,pid:1},{text:"",py_text:"LiuZhou",id:1,pid:1},{text:"",py_text:"GuiLin",id:2,pid:1},{text:"",py_text:"BeiHai",id:3,pid:1},{text:"",py_text:"WuZhou",id:6,pid:1},{text:"",py_text:"YuLIn",id:7,pid:1},{text:"",py_text:"FangCheng",id:9,pid:1},{text:"",py_text:"QinZhou",id:10,pid:1},{text:"",py_text:"GuiGang",id:11,pid:1},{text:"",py_text:"BaiSe",id:12,pid:1},{text:"",py_text:"HeZhou",id:13,pid:1},{text:" ",py_text:"HeChi",id:14,pid:1},{text:"",py_text:"LaiBin",id:15,pid:1},{text:"",py_text:"ChongZuo",id:16,pid:1},{text:"",py_text:"Other",id:9999,pid:1},{text:"",py_text:"Beijing",id:0,pid:2},{text:"",py_text:"HaiKou",id:0,pid:3},{text:"",py_text:"SanYa",id:1,pid:3},{text:"",py_text:"QiongHai",id:2,pid:3},{text:"",py_text:"DanZhou",id:3,pid:3},{text:"",py_text:"WuZhiShan",id:6,pid:3},{text:"",py_text:"WenChang",id:7,pid:3},{text:"",py_text:"WanNing",id:8,pid:3},{text:"",py_text:"DongFang",id:9,pid:3},{text:"",py_text:"DingAnXian",id:10,pid:3},{text:"",py_text:"TunChangXian",id:11,pid:3},{text:"",py_text:"ChengMaiXian",id:12,pid:3},{text:"",py_text:"LinGaoXian",id:13,pid:3},{text:"",py_text:"BaiShaLiZuZiZhiXian",id:14,pid:3},{text:"",py_text:"ChangJiangLiZuZiZhiXian",id:15,pid:3},{text:"",py_text:"LeDongLiZuZiZhiXian",id:16,pid:3},{text:"",py_text:"LingShuiLiZuZiZhiXian",id:17,pid:3},{text:"",py_text:"BaoTingLiZuMiaoZuZiZhiXian",id:18,pid:3},{text:"",py_text:"QiongZhongLiZuMiaoZuZiZhiXian",id:19,pid:3},{text:"",py_text:"XiShaQunDao",id:20,pid:3},{text:"",py_text:"NanShaQunDao",id:21,pid:3},{text:"",py_text:"ZhongShaQunDaoDeDaoJiaoJiQiHaiYu",id:22,pid:3},{text:"",py_text:"Other",id:9999,pid:3},{text:"",py_text:"FuZhou",id:0,pid:4},{text:"",py_text:"XiaMen",id:1,pid:4},{text:"",py_text:"QuanZhou",id:2,pid:4},{text:"",py_text:"ZhangZhou",id:3,pid:4},{text:"",py_text:"NanPing",id:4,pid:4},{text:"",py_text:"SanMing",id:5,pid:4},{text:"",py_text:"PuTian",id:6,pid:4},{text:"",py_text:"LongYan",id:7,pid:4},{text:"",py_text:"NingDe",id:13,pid:4},{text:"",py_text:"Other",id:9999,pid:4},{text:"",py_text:"Tianjin",id:0,pid:5},{text:"",py_text:"ChangSha",id:0,pid:6},{text:"",py_text:"HengYang",id:1,pid:6},{text:"",py_text:"ShaoYang",id:2,pid:6},{text:"",py_text:"XiangTan",id:3,pid:6},{
text:"",py_text:"YueYang",id:4,pid:6},{text:" ",py_text:"ZhuZhou",id:5,pid:6},{text:"",py_text:"ChangDe",id:6,pid:6},{text:"",py_text:"YiYang",id:10,pid:6},{text:" ",py_text:"ZhangJiaJie",id:11,pid:6},{text:"",py_text:"YongZhou",id:13,pid:6},{text:"",py_text:"HuaiHua",id:14,pid:6},{text:"",py_text:"LouDi",id:15,pid:6},{text:"",py_text:"ChenZhou",id:16,pid:6},{text:"",py_text:"XiangXiTuJiaZuMiaoZuZiZhiZhou",id:17,pid:6},{text:"",py_text:"Other",id:9999,pid:6},{text:"",py_text:"WuHan",id:0,pid:7},{text:"",py_text:"HuangShi",id:1,pid:7},{text:"",py_text:"JingSha",id:2,pid:7},{text:" ",py_text:"ShiYan",id:3,pid:7},{text:"",py_text:"XiangFan",id:4,pid:7},{text:"",py_text:"YiChang",id:5,pid:7},{text:"",py_text:"EZhou",id:6,pid:7},{text:"",py_text:"HuangGang",id:7,pid:7},{text:"",py_text:"SuiZhou",id:8,pid:7},{text:"",py_text:"JinMen",id:9,pid:7},{text:"",py_text:"XianNing",id:12,pid:7},{text:"",py_text:"XiaoGan",id:13,pid:7},{text:"",py_text:"JinZhou",id:14,pid:7},{text:"",py_text:"EnShiTuJiaZuMiaoZuZiZhiZhou",id:15,pid:7},{text:"",py_text:"XianTao",id:16,pid:7},{text:"",py_text:"QianJiang",id:17,pid:7},{text:"",py_text:"TianMen",id:18,pid:7},{text:"",py_text:"ShenNongJiaLinQu",id:19,pid:7},{text:"",py_text:"Other",id:9999,pid:7},{text:"",py_text:"ZhengZhou",id:0,pid:8},{text:"",py_text:"JiaoZuo",id:1,pid:8},{text:"",py_text:"ShangQiu",id:2,pid:8},{text:"",py_text:"LuoYang",id:3,pid:8},{text:"",py_text:"PingDingShan",id:4,pid:8},{text:"",py_text:"HeBi",id:5,pid:8},{text:"",py_text:"XinXiang",id:6,pid:8},{text:"",py_text:"AnYang",id:7,pid:8},{text:"",py_text:"KaiFeng",id:8,pid:8},{text:"",py_text:"LuoHe",id:9,pid:8},{text:"",py_text:"NanYang",id:10,pid:8},{text:"",py_text:"NanYang",id:11,pid:8},{text:"",py_text:"PuYang",id:12,pid:8},{text:"",py_text:"SanMenXiao",id:13,pid:8},{text:"",py_text:"XinYang",id:14,pid:8},{text:"",py_text:"XuChang",id:15,pid:8},{text:"",py_text:"ZhuMaDian",id:16,pid:8},{text:"",py_text:"ZhouKou",id:17,pid:8},{text:"",py_text:"Other",id:9999,pid:8},{text:"",py_text:"ShiJiaZang",id:0,pid:9},{text:"",py_text:"TangShan",id:1,pid:9},{text:"",py_text:"HanDan",id:2,pid:9},{text:"",py_text:"QinHuangDao",id:3,pid:9},{text:"",py_text:"XingTai",id:4,pid:9},{text:"",py_text:"BaoDing",id:5,pid:9},{text:" ",py_text:"ZhangJiaKou",id:6,pid:9},{text:"",py_text:"ChenDe",id:7,pid:9},{text:"",py_text:"CangZhou",id:8,pid:9},{text:"",py_text:"DingZhou",id:9,pid:9},{text:"",py_text:"LangFang",id:10,pid:9},{text:"",py_text:"HengShui",id:13,pid:9},{text:"",py_text:"Other",id:9999,pid:9},{text:"",py_text:"JiNan",id:0,pid:10},{text:"",py_text:"QingDao",id:1,pid:10},{text:"",py_text:"ZiBo",id:2,pid:10},{text:"",py_text:"YanTai",id:3,pid:10},{text:"",py_text:"JiNing",id:4,pid:10},{text:"",py_text:"DeZhou",id:5,pid:10},{text:"",py_text:"TaiAn",id:6,pid:10},{text:"",py_text:"WeiFang",id:7,pid:10},{text:"",py_text:"DongYing",id:8,pid:10},{text:"",py_text:"ZaoZhuang",id:9,pid:10},{text:"",py_text:"LaiWu",id:10,pid:10},{text:"",py_text:"LiaoCheng",id:11,pid:10},{text:"",py_text:"QingZhou",id:12,pid:10},{text:"",py_text:"RiZhao",id:13,pid:10},{text:"",py_text:"WeiHai",id:14,pid:10},{text:"",py_text:"HeZe",id:17,pid:10},{text:"",py_text:"TaiAn",id:22,pid:10},{text:"",py_text:"LinYi",id:24,pid:10},{text:"",py_text:"BinZhou",id:25,pid:10},{text:"",py_text:"Other",id:9999,pid:10},{text:"",py_text:"TaiYuan",id:0,pid:11},{text:"",py_text:"LinFen",id:1,pid:11},{text:"",py_text:"DaTong",id:2,pid:11},{text:"",py_text:"YangQuan",id:3,pid:11},{text:"",py_text:"JinCheng",id:4,pid:11},{text:"",py_text:"ChangZhi",id:5,pid:11},{text:"",py_text:"XinZhou",id:6,pid:11},{text:"",py_text:"YunCheng",id:9,pid:11},{text:"",py_text:"SuoZhou",id:10,pid:11},{text:"",py_text:"JinZhong",id:16,pid:11},{text:"",py_text:"LvLiang",id:17,pid:11},{text:"",py_text:"Other",id:9999,pid:11},{text:"",py_text:"HaErBin",id:0,pid:12},{text:"",py_text:"DaQing",id:1,pid:12},{text:"",py_text:"JiaMuSi",id:2,pid:12},{text:"",py_text:"MuDanJiang",id:3,pid:12},{text:"",py_text:"QiQiHaEr",id:4,pid:12},{text:"",py_text:"YiChun",id:5,pid:12},{text:"",py_text:"SuiHua",id:6,pid:12},{text:"",py_text:"HeiHe",id:7,pid:12},{text:"",py_text:"WuDaLian",id:8,pid:12},{text:"",py_text:"JiXi",id:11,pid:12},{text:"",py_text:"HeGang",id:12,pid:12},{text:"",py_text:"ShuangYaShan",id:13,pid:12},{text:"",py_text:"QiTaiHe",id:14,pid:12},{text:"",py_text:"DaXingAnLingDiQu",id:15,pid:12},{text:"",py_text:"Other",id:9999,pid:12},{text:"",py_text:"ShenYang",id:0,pid:13},{text:"",py_text:"JinZhou",id:1,pid:13},{text:"",py_text:"DanDong",id:2,pid:13},{text:"",py_text:"DaLian",id:3,pid:13},{text:"",py_text:"PanJin",id:4,pid:13},{text:"",py_text:"AnShan",id:5,pid:13},{text:"",py_text:"FuShun",id:6,pid:13},{text:"",py_text:"BenXi",id:7,pid:13},{text:"",py_text:"YingKou",id:8,pid:13},{text:"",py_text:"TieLing",id:9,pid:13},{text:"",py_text:"ChaoYang",id:10,pid:13},{text:"",py_text:"DongGang",id:11,pid:13},{text:"",py_text:"HaiCheng",id:12,pid:13},{text:"",py_text:"HuLuDao",id:13,pid:13},{text:"",py_text:"LiaoYang",id:14,pid:13},{text:"",py_text:"FuXin",id:17,pid:13},{text:"",py_text:"Other",id:9999,pid:13},{text:"",py_text:"Shanghai",id:0,pid:14},{text:"",py_text:"LanZhou",id:0,pid:15},{text:"",py_text:"JiaYuGuan",id:1,pid:15},{text:"",py_text:"JinChang",id:2,pid:15},{text:"",py_text:"YuMen",id:3,pid:15},{text:"",py_text:"TianShui",id:4,pid:15},{text:"",py_text:"BaiYin",id:5,pid:15},{text:"",py_text:"DunHuang",id:6,pid:15},{text:"",py_text:"WuWei",id:7,pid:15},{text:" ",py_text:"ZhangYe",id:8,pid:15},{text:"",py_text:"PingLiang",id:9,pid:15},{text:"",py_text:"LinXia",id:10,pid:15},{text:"",py_text:"JiuQuan",id:11,pid:15},{text:"",py_text:"QingYang",id:14,pid:15},{text:"",py_text:"DingXi",id:15,pid:15},{text:"",py_text:"LongNan",id:16,pid:15},{text:"",py_text:"LinXiaHuiZuZiZhiZhou",id:17,pid:15},{text:"",py_text:"GanNanZangZuZiZhiZhou",id:18,pid:15},{text:"",py_text:"Other",id:9999,pid:15},{text:"",py_text:"XiNing",id:0,pid:16},{text:"",py_text:"HaiBeiZangZuZiZhiZhou",id:7,pid:16},{text:"",py_text:"HuangNanZangZuZiZhiZhou",id:8,pid:16},{text:"",py_text:"HaiNanZangZuZiZhiZhou",id:9,pid:16},{text:"",py_text:"GuoLuoZangZuZiZhiZhou",id:10,pid:16},{text:" ",py_text:"YuShuZangZuZiZhiZhou",id:11,pid:16},{text:"",py_text:"HaiXiMengGuZuZangZuZiZhiZhou",id:12,pid:16},{text:"",py_text:"HaiDongDiQu",id:13,pid:16},{text:"",py_text:"Other",id:9999,pid:16},{text:"",py_text:"WuLuMuQi",id:0,pid:17},{text:"",py_text:"KeLaMaYi",id:1,pid:17},{text:"",py_text:"TuLuFanDiQu",id:2,pid:17},{text:"",py_text:"ShiHeZi",id:3,pid:17},{text:"",py_text:"ALeTaiDiQu",id:4,pid:17},{text:"",py_text:"AKeSuDiQu",id:5,pid:17},{text:"",py_text:"BaYinGuoLengMengGuZiZhiZhou",id:6,pid:17},{text:"",py_text:"KeZiLeSuKeErKeZiZiZhiZhou",id:7,pid:17},{text:"",py_text:"YiLiHaSaKeZiZhiZhou",id:9,pid:17},{text:"",py_text:"MiQuan",id:10,pid:17},{text:"",py_text:"TaChengDiQu",id:11,pid:17},{text:"",py_text:"KeShiDiQu",id:12,pid:17},{text:"",py_text:"HaMiDiQu",id:13,pid:17},{text:"",py_text:"ChangJiHuiZuZiZhiQu",id:14,pid:17},{text:"",py_text:"BoLeTaLaMengGuZiZhiZhou",id:15,pid:17},{text:"",py_text:"HeTianDiQu",id:16,pid:17},{text:"",py_text:"ALaEr",id:20,pid:17},{text:"",py_text:"TuMuShuKe",id:21,pid:17},{text:" ",py_text:"WuJiaQu",id:22,pid:17},{text:"",py_text:"Other",id:9999,pid:17},{text:"",py_text:"Lasa",id:0,pid:18},{text:"",py_text:"Rikaze",id:1,pid:18},{text:"",py_text:"Linzhi",id:2,pid:18},{text:"",py_text:"Changdu",id:3,pid:18},{text:"",py_text:"Naqu",id:4,pid:18},{text:"",py_text:"Shannan",id:7,pid:18},{text:"",py_text:"Ali",id:8,pid:18},{text:"",py_text:"Other",id:9999,pid:18},{text:"",py_text:"YinChuan",id:0,pid:19},{text:"",py_text:"ShiZhuiSha",id:1,pid:19},{text:" ",py_text:"WuZong",id:2,pid:19},{text:"",py_text:"GuYuan",id:4,pid:19},{text:"",py_text:"ZhongWei",id:6,pid:19},{text:"",py_text:"Other",id:9999,pid:19},{text:"",py_text:"ChengDu",id:0,pid:20},{text:"",py_text:"LuZhou",id:1,pid:20},{text:"",py_text:"PanZhiHua",id:2,pid:20},{text:"",py_text:"ZiGong",id:3,pid:20},{text:"",py_text:"LangZhong",id:4,pid:20},{text:"",py_text:"LeShan",id:5,pid:20},{text:"",py_text:"YiBin",id:6,pid:20},{text:"",py_text:"NanChong",id:10,pid:20},{text:"",py_text:"XiChang",id:12,pid:20},{text:"",py_text:"YaAn",id:13,pid:20},{text:"",py_text:"GuangYuan",id:14,pid:20},{text:"",py_text:"SongPan",id:17,pid:20},{text:"",py_text:"MianYang",id:18,pid:20},{text:"",py_text:"DeYang",id:20,pid:20},{text:"",py_text:"SuiNing",id:21,pid:20},{text:"",py_text:"NeiJiang",id:22,pid:20},{text:"",py_text:"GuangAn",id:23,pid:20},{text:"",py_text:"DaZhou",id:24,pid:20},{text:"",py_text:"BaZhong",id:25,pid:20},{text:"",py_text:"ZiYang",id:26,pid:20},{text:"",py_text:"ABaZangZuQiangZuZiZhiZhou",id:27,pid:20},{text:"",py_text:"GanZiZangZuZiZhiZhou",id:28,pid:20},{text:"",py_text:"LiangShanYiZuZiZhiZhou",id:29,pid:20},{text:"",py_text:"MeiShan",id:30,pid:20},{text:"",py_text:"Other",id:9999,pid:20},{text:"",py_text:"KunMing",id:0,pid:21},{text:"",py_text:"ZhaoTong",id:8,pid:21},{text:"",py_text:"YuXi",id:9,pid:21},{text:"",py_text:"QuJin",id:11,pid:21},{text:"",py_text:"BaoShan",id:12,pid:21},{text:"",py_text:"LiJiang",id:18,pid:21},{text:"",py_text:"LinCang",id:19,pid:21},{text:"",py_text:"ChuXiongYiZuZiZhiZhou",id:20,pid:21},{text:"",py_text:"HongHeHaNiZuYiZuZiZhiZhou",id:21,pid:21},{text:"",py_text:"WenShanZhuangZuMiaoZuZiZhiZhou",id:22,pid:21},{text:"",py_text:"XiShuangBanNaDaiZuZiZhiZhou",id:23,pid:21},{text:"",py_text:"DaLiBaiZuZiZhiZhou",id:24,pid:21},{text:"",py_text:"DehongDaizuJingpozuZizhizhou",id:25,pid:21},{text:"",py_text:"DeqinZangZuZiZhiZhou",id:26,pid:21},{text:"",py_text:"PuEr",id:27,pid:21},{text:"",py_text:"NuJiangLiSuZuZiZhiZhou",id:28,pid:21},{text:"",py_text:"Other",id:9999,pid:21},{text:"",py_text:"ChangChun",id:0,pid:22},{text:"",py_text:"JiLin",id:1,pid:22},{text:"",py_text:"LiaoYuan",id:2,pid:22},{text:"",py_text:"SiPing",id:3,pid:22},{text:"",py_text:"TongHua",id:4,pid:22},{text:"",py_text:"BaiCheng",id:5,pid:22},{text:"",py_text:"BaiShan",id:6,pid:22},{text:"",py_text:"YanBianChaoXianZuZiZhiZhou",id:12,pid:22},{text:"",py_text:"SongYuan",id:13,pid:22},{text:"",py_text:"Other",id:9999,pid:22},{text:"",py_text:"HuHeHaoTe",id:0,pid:23},{text:"",py_text:"BaoTou",id:1,pid:23},{text:"",py_text:"WuHai",id:2,pid:23},{text:"",py_text:"ChiFeng",id:3,pid:23},{text:"",py_text:"TongLiao",id:7,pid:23},{text:"",py_text:"EErDuoSi",id:11,pid:23},{text:"",py_text:"HuLunBeiEr",id:12,pid:23},{text:"",py_text:"BaYanNaoEr",id:13,pid:23},{text:"",py_text:"WuLanChaBu",id:14,pid:23},{text:"",py_text:"XingAnMeng",id:15,pid:23},{text:"",py_text:"XiLinGuoLeMeng",id:16,pid:23},{text:"",py_text:"ALaShanMeng",id:17,pid:23},{text:"",py_text:"Other",id:9999,pid:23},{text:"",py_text:"XiAn",id:0,pid:24},{text:"",py_text:"YinChuan",id:1,pid:24},{text:"",py_text:"BaoJi",id:2,pid:24},{text:"",py_text:"HanZhong",id:3,pid:24},{text:"",py_text:"WeiNan",id:4,pid:24},{text:"",py_text:"XianYang",id:5,pid:24},{text:"",py_text:"YanAn",id:6,pid:24},{text:"",py_text:"YuLin",id:7,pid:24},{text:"",py_text:"AnKang",id:9,pid:24},{text:"",py_text:"ShangLuo",id:11,pid:24},{text:"",py_text:"Other",id:9999,pid:24},{text:"",py_text:"HeFei",id:0,pid:25},{text:"",py_text:"HuaiBei",id:1,pid:25},{text:" ",py_text:"BengBu",id:2,pid:25},{text:"",py_text:"MaAnShan",id:3,pid:25},{text:"",py_text:"HuangShan",id:4,pid:25},{text:"",py_text:"AnQing",id:5,pid:25},{text:"",py_text:"HuaiNan",id:6,pid:25},{text:"",py_text:"TongLing",id:7,pid:25},{text:"",py_text:"WuHu",id:8,pid:25},{text:"",py_text:"HaoZou",id:9,pid:25},{text:"",py_text:"ChaoHu",id:10,pid:25},{text:"",py_text:"ChuZhou",id:11,pid:25},{text:"",py_text:"FuYang",id:12,pid:25},{text:" ",py_text:"ChiZhou",id:13,pid:25},{text:"",py_text:"JieShou",id:14,pid:25},{text:"",py_text:"LiuAn",id:15,pid:25},{text:"",py_text:"SuZhou",id:17,pid:25},{text:"",py_text:"TianChang",id:18,pid:25},{text:"",py_text:"XuanCheng",id:19,pid:25},{text:"",py_text:"Other",id:9999,pid:25},{text:"",py_text:"GuiYang",id:0,pid:26},{text:"",py_text:"AnShun",id:1,pid:26},{text:"",py_text:"LiuPanShui",id:2,pid:26},{text:"",py_text:"ZunYi",id:3,pid:26},{text:"",py_text:"TongRen",id:6,pid:26},{text:"",py_text:"BiJie",id:9,pid:26},{text:"",py_text:"QianXiNaoBuYiZuMiaoZuZiZhiZhou",id:14,pid:26},{text:"",py_text:"QianDongNanMiaoZuDongZuZiZhiZhou",id:15,pid:26},{text:"",py_text:"QianNanBuYiZuMiaoZuZiZhiZhou",id:16,pid:26},{text:"",py_text:"Other",id:9999,pid:26},{text:"",py_text:"NanJing",id:0,pid:27},{text:"",py_text:"XuZhou",id:1,pid:27},{text:"",py_text:"LianYunGang",id:2,pid:27},{text:"",py_text:"SuZhou",id:3,pid:27},{text:" ",py_text:"WuXi",id:4,pid:27},{text:"",py_text:"ChangZhou",id:5,pid:27},{text:"",py_text:"HuaiAn",id:7,pid:27},{text:"",py_text:"NanTong",id:8,pid:27},{text:"",py_text:"TaiZhou",id:10,pid:27},{text:"",py_text:"TongZhou",id:11,pid:27},{text:"",py_text:"YangZhou",id:12,pid:27},{text:"",py_text:"YiXing",id:13,pid:27},{text:"",py_text:"ZhenJiang",id:14,pid:27},{text:"",py_text:"YanCheng",id:19,pid:27},{text:"",py_text:"XiuQian",id:20,pid:27},{text:"",py_text:"Other",id:9999,pid:27},{text:"",py_text:"Chongqing",id:0,pid:28},{text:"",py_text:"HangZhou",id:0,pid:29},{text:"",py_text:"NingBo",id:1,pid:29},{text:"",py_text:"WenZhou",id:2,pid:29},{text:"",py_text:"ShaoXing",id:3,pid:29},{text:"",py_text:"JinHua",id:4,pid:29},{text:"",py_text:"JiaXing",id:5,pid:29},{text:"",py_text:"QuZhou",id:6,pid:29},{text:"",py_text:"LiShui",id:11,pid:29},{text:"",py_text:"ZhouShan",id:17,pid:29},{text:"",py_text:"TaiZhou",id:22,pid:29},{text:"",py_text:"HuZhou",id:24,pid:29},{text:"",py_text:"Other",id:9999,pid:29},{text:"",py_text:"NanCang",id:0,pid:30},{text:"",py_text:"JingDeZhen",id:1,pid:30},{text:"",py_text:"PingXiang",id:2,pid:30},{text:"",py_text:"JiuJiang",id:3,pid:30},{text:"",py_text:"GanZhou",id:4,pid:30},{text:"",py_text:"XinYu",id:5,pid:30},{text:"",py_text:"JiAn",id:6,pid:30},{text:"",py_text:"YingTan",id:11,pid:30},{text:"",py_text:"YiChun",id:12,pid:30},{text:"",py_text:"ShangRao",id:13,pid:30},{text:"",py_text:"FuZhou",id:14,pid:30},{text:"",py_text:"Other",id:9999,pid:30},{text:"",py_text:"Asia",id:0,pid:31},{text:"",py_text:"North America",id:1,pid:31},{text:"",py_text:"South America",id:2,pid:31},{text:"",py_text:"Europe",id:3,pid:31},{text:"",py_text:"Africa",id:4,pid:31},{text:"",py_text:"Oceania",id:5,pid:31},{text:"",py_text:"Taibei",id:0,pid:32},{text:"",py_text:"Kaohsiung",id:1,pid:32},{text:"",py_text:"Taizhong",id:2,pid:32},{text:"",py_text:"Tainan",id:3,pid:32},{text:"",py_text:"Jilong",id:4,pid:32},{text:"",py_text:"Xinzhu",id:5,pid:32},{text:"",py_text:"Other",id:9999,pid:32},{text:"",py_text:"Hongkong",id:0,pid:33},{text:"",py_text:"Kowloon",id:1,pid:33},{text:"",py_text:"New Territories",id:2,pid:33},{text:"",py_text:"Macao",id:0,pid:34}];return{init:t,out:i}}),define("module/contact/grpNameValidate",["require","util/i18n!pab,contact","util/i18n","util/messageformat"],function(e){function t(e,t,s,o){var l=e.tagName?e.value:e;l=l.trim();var c,d=24,u="%'\"\\/:*?<>|=,^";if(l){if(i(l)>d)c=a.t("pab/c_new_addprg_name_length");else if(n(l,u))c=r.format(a.t("contact/msg_grpNameContainIllegalCharacter"),u);else if(t.push({name:a.t("pab/c_allgrp")},{name:a.t("pab/c_others")}),"addnew"==s){for(var p=0;p<t.length&&l!=t[p].name;p++);p!=t.length&&(c=a.t("contact/msg_grpNameExist"))}else if("update"==s){for(var m=0;m<t.length&&(l!=t[m].name||l==o);m++);m!=t.length&&(c=a.t("contact/msg_grpNameExist"))}}else c=a.t("pab/c_new_addprg_name_empty");return c?{state:!1,errMsg:c}:{state:!0}}function n(e,t){for(var n=0;n<e.length;n++)if(t.indexOf(e.charAt(n))>=0)return!0;return!1}function i(e){for(var t=0,n=0;n<e.length;n++)e.charCodeAt(n)>255?t+=2:t++;return t}e("util/i18n!pab,contact");var a=e("util/i18n"),r=e("util/messageformat");return{validate:t}}),define("components/requirejs-text/text!template/module/contact/oabContact.tpl.html",[],function(){return'<section class="m-ctoab">\r\n\r\n  <div class="main-wrapper">\r\n    <div class="content-wrapper">\r\n\r\n      <!--  -->\r\n      <section class="content content-list">\r\n        <header class="toolbar">\r\n          <button class="u-btn u-btn-primary u-btns-hide j-goPrevLevel" data-action="goPrev">\r\n              <i class="iconfont iconupperlayer"></i>{{i18n "contact/op_goPrevLevel"}}\r\n          </button>\r\n          <button class="u-btn u-btn-default" data-operation="showSearchList">\r\n            <i class="iconfont iconsreachm"></i>\r\n          </button>\r\n\r\n          <div id="pagination" class="u-btns f-fr"></div>\r\n        </header>\r\n        <div class="deptInfo"></div>\r\n        <div class="u-list u-scroll">\r\n          <table class="u-table u-table-assign u-table-row">\r\n            <thead></thead>\r\n            <tbody></tbody>\r\n          </table>\r\n        </div>\r\n      </section>\r\n\r\n      <!--  -->\r\n      <section class="content content-searchlist" id="searchViewContainer"></section>\r\n\r\n      <!--  -->\r\n      <section class="content content-mailList" id="listMailListContainer">\r\n        <header class="toolbar j-mailListToolbar"></header>\r\n\r\n        <div class="j-listDetail u-maillist-info"></div>\r\n\r\n        <div class="u-list u-scroll mailList">\r\n          <div class="j-listTableDec"></div>\r\n          <table class="u-table u-table-assign u-table-row">\r\n            <thead></thead>\r\n            <tbody></tbody>\r\n          </table>\r\n        </div>\r\n      </section>\r\n\r\n    </div>\r\n\r\n    <!--  -->\r\n    <section class="panel">\r\n      <!--   -->\r\n      <header class="toolbar">\r\n        <div class="toolbar-wrapper">\r\n\r\n          <div class="u-btns btns-list j-switch-menu f-fr">\r\n            <button class="u-btn u-btn-default">\r\n              <i class="iconfont iconblock"></i>\r\n            </button>\r\n            <button class="u-btn u-btn-default">\r\n              <i class="iconfont iconlist"></i>\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <div class="panel-content u-scroll u-scroll-wrapper">\r\n        <!--  -->\r\n        <div class="detail j-panel-detail">\r\n        </div>\r\n\r\n        <!--  -->\r\n        <div class="list j-panel-list">\r\n          <div class="thumbview">\r\n            <div class="list-wrapper">\r\n              <ul>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n          <div class="listview">\r\n            <table class="u-table u-table-assign2">\r\n              <tbody></tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n\r\n      </div>\r\n\r\n    </section>\r\n    <!-- end -->\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="listHeadTpl">\r\n    <tr>\r\n      <th class="firstTH">\r\n        <span class="j-selectAll">\r\n          <input type="checkbox" />\r\n        </span>\r\n      </th>\r\n      <th class="nth2TH">&nbsp;</th>\r\n      [[#each fields]]\r\n      <th width="[[width]]" data-sort="[[id]]" class="[[#compare @index \'>\' \'1\']]hideForShrink[[/compare]]"><div class="f-ellipsis">[[label]]<i class="iconfont"/></div></th>\r\n      [[/each]]\r\n    </tr>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="listTpl">\r\n    <tr data-action="[[#compare type \'==\' \'O\']]goNext[[^]][[#compare type \'==\' \'L\']]accessToList[[else]]show[[/compare]][[/compare]]"\r\n        data-dn="[[#compare type \'==\' \'O\']][[id]][[^]][[/compare]]"\r\n        data-email="[[emailaddr]]"\r\n        data-gender="[[gender]]">\r\n      <td class="firstTD">[[#if emailaddr]]<input type="checkbox" value="[[emailaddr]]" data-name="[[#compare type \'==\' \'O\']][[name]][[^]][[true_name]][[/compare]]" data-cdn="[[cdn]]" data-uniqueid="[[uniqueid]]" data-gender="[[gender]]">[[^]]&nbsp;[[/if]]</td>\r\n      <td class="nth2TD"><i class="iconfont [[class]]"></i></td>\r\n      [[#each fields]]\r\n        [[#compare ../type \'==\' \'O\']]\r\n          [[#compare id \'==\' \'true_name\']]\r\n            <td colspan="[[../../../fields.length]]"><div class="f-ellipsis" title="[[formatted value]]">[[formatted value]]</div></td>\r\n          [[/compare]]\r\n        [[^]]\r\n          <td width="[[width]]" class="[[#compare @index \'>\' \'1\']]hideForShrink[[/compare]]">\r\n            <div class="f-ellipsis" title="[[formatted value]]">[[formatted value]]</div>\r\n          </td>\r\n        [[/compare]]\r\n      [[/each]]\r\n    </tr>\r\n  </script>\r\n  <script type="text/x-handlebars-template" id="mailListDetailsTpl">\r\n    <h4>[[i18n \'contact/lbl_maillist_dec\']]</h4>\r\n    <div class="detail-item">\r\n      <label>[[i18n \'contact/lbl_maillist_name\']]</label>\r\n      <span class="f-mgl">[[name]]</span>\r\n    </div>\r\n    <div class="detail-item">\r\n      <label>[[i18n \'contact/lbl_maillist_email\']]</label>\r\n      <span class="f-mgl" id="maillist_id">[[id]]</span>\r\n    </div>\r\n    <div class="detail-item">\r\n      <label>[[i18n \'contact/lbl_maillist_location\']]</label>\r\n      <span class="f-mgl">[[location]]</span>\r\n    </div>\r\n  </script>\r\n\r\n  <!-- @type= \'L\' -->\r\n  <script type="text/x-handlebars-template" id="listMailListTpl">\r\n    <tr data-action="show" data-email="[[emailaddr]]" data-gender="[[gender]]">\r\n      <td class="firstTD">\r\n        [[#if emailaddr]]\r\n        <input type="checkbox" value="[[emailaddr]]" data-name="[[true_name]]" data-cdn="[[cdn]]" data-uniqueid="[[uniqueid]]" data-gender="[[gender]]">\r\n        [[^]]&nbsp;[[/if]]\r\n      </td>\r\n      <td class="nth2TD"><i class="iconfont [[class]]"></i></td>\r\n      [[#each fields]]\r\n      <td width="[[width]]" class="[[#compare @index \'>\' \'1\']]hideForShrink[[/compare]]">\r\n        <div class="f-ellipsis" title="[[formatted value]]">[[formatted value]]</div>\r\n      </td>\r\n      [[/each]]\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="selectedContactListTpl">\r\n    <tr data-uniqueid="[[uniqueid]]" data-cdn="[[cdn]]" data-name="[[name]]" data-emailaddr="[[emailaddr]]" class="[[#if isDir]]j-dir[[/if]]">\r\n      <td class="firstTD"><span class="f-ellipsis">[[formatted name]]</span></td>\r\n      <td class="nth2TD"><span class="f-ellipsis">[[emailaddr]]</span></td>\r\n      <td class="lastTD"><a href="javascript:void(0)" data-operation="remove">{{i18n "contact/op_remove"}}</a></td>\r\n    </tr>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="selectedContactThumbTpl">\r\n    <li data-uniqueid="[[uniqueid]]" data-cdn="[[cdn]]">\r\n      <div>\r\n        <a class="del" href="javascript:void(0)" data-operation="remove"><i class="iconfont icondelword"></i></a>\r\n        <div class="u-img u-img-thumbnails"><a href="javascript:void(0)"><img src="[[avatar]]" alt="avatar"></a></div>\r\n        <p class="f-ellipsis">[[formatted name]]</p>\r\n      </div>\r\n    </li>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="contactTpl">\r\n    <div class="avatar">\r\n      <div class="u-img">\r\n        <a href="javascript:void(0)"><img src="[[avatar]]" alt="avatar"></a>\r\n      </div>\r\n      <div class="text">\r\n        <div class="name">\r\n          <a href="javascript:void(0)">[[formatted name]]</a>\r\n          <i class="iconfont [[genderCls]]"></i>\r\n        </div>\r\n        [[#if ou]]\r\n        <div class="department"><a data-action="accessToOu" title="{{i18n \'contact/lbl_viewOuMembers\'}}">[[formatted location]]</a></div>\r\n        [[/if]]\r\n        <div class="position">[[formatted duty]]</div>\r\n      </div>\r\n    </div>\r\n    <div class="infos">\r\n      <table class="u-table u-table-assign1">\r\n        <tbody>\r\n        [[#each fields]]\r\n        <tr>\r\n          <td>[[label]]</td><td title="[[formatted value]]">[[formatted value]]</td>\r\n        </tr>\r\n        [[/each]]\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="advanceSearchTpl">\r\n    <div class="advsearch-panel u-scroll">\r\n      <div class="header">\r\n        <span class="hd-name">{{i18n "contact/op_advanceSearch"}}</span>\r\n        <div class="hd-close" data-operation="closePopup">\r\n          <a href="javascript:void(0)">\r\n            <i class="iconfont icontabclose"></i>\r\n          </a>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="content">\r\n        <form name="advanceSearchForm" id="advanceSearchForm" action="#">\r\n          <input type="hidden" name="action" value="advanceSearch"/>\r\n          <div class="form-item">\r\n            <label class="label label-1">{{i18n "contact/lbl_searchPosition"}}</label>\r\n            <div class="input">\r\n              <select name="dn"></select>\r\n            </div>\r\n          </div>\r\n          <div class="form-item">\r\n            <label class="label label-1"></label>\r\n            <div class="input j-recursive">\r\n              <input type="checkbox" id="recursive" name="recursive" checked value="true"/>\r\n              <label for="recursive">{{i18n "contact/lbl_recursive"}}</label>\r\n            </div>\r\n          </div>\r\n          <div class="form-item">\r\n            <label class="label label-1">{{i18n "contact/lbl_name"}}</label>\r\n            <div class="input">\r\n              <input type="text" class="u-input" name="true_name" autocomplete="off" />\r\n            </div>\r\n          </div>\r\n          <div class="form-item">\r\n            <label class="label label-1">{{i18n "contact/lbl_emailaddr"}}</label>\r\n            <div class="input">\r\n              <input type="text" class="u-input" name="email" autocomplete="off" />\r\n            </div>\r\n          </div>\r\n          <div class="form-item">\r\n            <label class="label label-1">{{i18n "oab/h_mobile_number"}}</label>\r\n            <div class="input">\r\n              <input type="text" class="u-input" name="mobile_number" autocomplete="off" />\r\n            </div>\r\n          </div>\r\n          <div class="form-item form-item-lt">\r\n            <label class="label label-1">{{i18n "contact/lbl_company_phone"}}</label>\r\n            <div class="input">\r\n              <input type="text" class="u-input" name="company_phone" autocomplete="off" />\r\n            </div>\r\n          </div>\r\n        </form>\r\n      </div>\r\n      <div class="footer">\r\n        <div class="u-btns u-btns-1" data-action="advanceSearch">\r\n          <button class="u-btn u-btn-primary">\r\n            {{i18n "contact/op_startSearch"}}\r\n          </button>\r\n        </div>\r\n        <div class="u-btns" data-operation="closePopup">\r\n          <button class="u-btn u-btn-default">\r\n            {{i18n "contact/op_cancel"}}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="constructOptionTpl">\r\n    <option value="[[dn]]" [[#if selected]]selected[[/if]]>[[value]]</option>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="groupsOptionTpl">\r\n    [[#each groups]]\r\n    <li data-action="addToPabContact" data-groupid="[[id]]"><a href="javascript:void(0)">[[formatted name]]</a></li>\r\n    [[/each]]\r\n    <li class="divider"></li>\r\n    <li data-action="addToPabContact"><a href="javascript:void(0)">{{i18n "pab/c_others"}}</a></li>\r\n    <li data-action="addGroup"><a href="javascript:void(0)">{{i18n "pab/c_group_new"}}</a></li>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="toolbarTpl">\r\n      <button class="u-btn u-btn-primary btn-detail" data-operation="closeDetails" id="collapse"><i class="iconfont iconright"></i>{{i18n "contact/op_collapse"}}</button>\r\n      <button class="u-btn u-btn-default btn-list" data-operation="removeAll" id="removeAll">{{i18n "contact/op_removeAll"}}</button>\r\n      <div class="u-btns">\r\n        [[#if enableSendMail]]\r\n        <button class="u-btn u-btn-default" data-action="goCompose">{{i18n "contact/op_compose"}}</button>\r\n        [[/if]]\r\n        [[#if ssoLunkrHost]]\r\n        <button class="u-btn u-btn-default" data-action="toLunkr" role="toLunkr">{{i18n "contact/op_lunkr"}}</button>\r\n        [[/if]]\r\n        <span class="u-btn u-btn-default j-moreOp">{{i18n "contact/op_more"}}<i class="iconfont icondown"></i>\r\n          <ul class="u-menu u-menu-hidden">\r\n              [[#if isSupportPab]]\r\n              <li class="u-submenu" role="submenu">\r\n                  <a href="javascript:void(0)">{{i18n "oab/act_exportToPAB"}}</a>\r\n                  <i class="iconfont iconright right"></i>\r\n                  <ul class="u-menu u-menu-hidden">\r\n                      <li class="divider"></li>\r\n                      <li data-action="addToPabContact"><a href="javascript:void(0)">{{i18n "pab/c_others"}}</a></li>\r\n                      <li data-action="addGroup"><a href="javascript:void(0)">{{i18n "pab/c_group_new"}}</a></li>\r\n                  </ul>\r\n              </li>\r\n              [[/if]]\r\n              <li data-action="listMails">\r\n                  <a href="javascript:void(0)">{{i18n "oab/act_listmails"}}</a>\r\n              </li>\r\n          </ul>\r\n        </span>\r\n      </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="mailListToolbarTpl">\r\n    <button class="u-btn u-btn-primary" data-action="goPrev" data-type="mailList"> {{i18n "common/back"}}</button>\r\n    [[#if enableSendMail]]\r\n    <button class="u-btn u-btn-default"  data-action="goCompose" >{{i18n "oab/act_compose_userlist"}} </button>\r\n    [[/if]]\r\n    [[#if ssoLunkrHost]]\r\n    <button class="u-btn u-btn-default" data-action="toLunkr" role="toLunkr">{{i18n "contact/op_lunkr"}}</button>\r\n    [[/if]]\r\n    <div class="u-btns">\r\n      <span class="u-btn u-btn-default j-moreOp">{{i18n "contact/op_more"}}<i class="iconfont icondown"></i>\r\n        <ul class="u-menu u-menu-hidden">\r\n          [[#if isSupportPab]]\r\n          <li class="u-submenu" role="submenu">\r\n            <a href="javascript:void(0)">{{i18n "oab/act_exportToPAB"}}</a>\r\n            <i class="iconfont iconright right"></i>\r\n            <ul class="u-menu u-menu-hidden">\r\n              <li class="divider"></li>\r\n              <li data-action="addToPabContact"><a href="javascript:void(0)">{{i18n "pab/c_others"}}</a></li>\r\n              <li data-action="addGroup"><a href="javascript:void(0)">{{i18n "pab/c_group_new"}}</a></li>\r\n            </ul>\r\n          </li>\r\n          [[/if]]\r\n          <li data-action="listMails">\r\n            <a href="javascript:void(0)">{{i18n "oab/act_listmails"}}</a>\r\n          </li>\r\n        </ul>\r\n      </span>\r\n    </div>\r\n    <button class="u-btn u-btn-default" data-operation="showSearchList">\r\n      <i class="iconfont iconsreachm"></i>\r\n    </button>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="addGroupTpl">\r\n    <div><label>{{i18n "contact/lbl_newGrpName"}}</label><input type="text" id="addGrpName" class="u-input" autocomplete="off" /></div>\r\n    <div id="errMsg" class="f-dn u-alert u-alert-error"><i class="iconfont iconinformation"></i><label></label></div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="contactsEmptyTpl">\r\n    <tr><td colspan="[[colspan]]">{{i18n "oab/no_user"}}</td></tr>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="searchViewTpl">\r\n    <header class="toolbar">\r\n          <span class="u-btn u-btn-default" data-operation="showList">\r\n            {{i18n "oab/act_search_back"}}\r\n          </span>\r\n      <div class="u-input-control u-input-control-1 left">\r\n        <span class="iconfont iconsreachm"></span>\r\n        <input type="text" class="u-input u-input-1" id="searchInput" placeholder=\'{{i18n "contact/lbl_quickSearchContacts"}}\' autocomplete="off">\r\n        <span class="iconfont iconenter rightSide" data-action="startSearch"></span>\r\n      </div>\r\n      <div style="position: relative;display: inline-block;" id="advanceSearchTplContainer">\r\n            <span class="u-btn u-btn-default j-advanceSearch">\r\n              {{i18n "contact/op_advanceSearch"}}\r\n            </span>\r\n      </div>\r\n      <div id="pagination1" class="u-btns f-fr"></div>\r\n      <div class="searchResult">\r\n        <label>{{i18n "pab/c_search_result"}}</label><label class="f-dn"></label>\r\n      </div>\r\n    </header>\r\n    <div class="searchlist u-scroll">\r\n      <table class="u-table u-table-assign u-table-row">\r\n        <thead></thead>\r\n        <tbody></tbody>\r\n      </table>\r\n      <div class="j-searchHint">{{i18n "contact/lbl_oabSearchTips"}}</div>\r\n    </div>\r\n  </script>\r\n  {{/raw}}\r\n</section>';
}),define("module/contact/oab/index",["require","widget/pagination/pagination","util/i18n!common,contact,oab,pab","jquery","util/i18n","util/index","util/sitenode","cui/ui/popup/popup","cui/core/view/view","./service","util/messageformat","component/confirmbox","module/contact/service","module/mail/service","cui/core/view/viewmanager","cui/ui/switchable/switchable","module/common/globalService","../../../util/province-city","cui/util/templatable/templatable","module/contact/grpNameValidate","text!template/module/contact/oabContact.tpl.html"],function(e){e("widget/pagination/pagination"),e("util/i18n!common,contact,oab,pab");var t=e("jquery"),n=e("util/i18n"),i=e("util/index"),a=e("util/sitenode"),r=e("cui/ui/popup/popup"),s=e("cui/core/view/view"),o=e("./service"),l=e("util/messageformat"),c=e("component/confirmbox"),d=e("module/contact/service"),u=e("module/mail/service"),p=e("cui/core/view/viewmanager"),m=e("cui/ui/switchable/switchable"),h=e("module/common/globalService"),f=e("../../../util/province-city"),v=e("cui/util/templatable/templatable"),g=e("module/contact/grpNameValidate"),b=s.extend({Implements:v,events:{"click [data-action]":"_dispatchAction","click [data-operation]":"_dispatchOperation","click [data-sort]":"_doSortList","keydown #searchInput":"_searchContact"},setup:function(){var e=this;e.state=h.getCurrentState(),e.dn=e.state.param.cid||h.getUser()["@ou"],e.limit=parseInt(h.getConfig("contact.itemperpage"))||20,e.locale=h.getConfig("context.locale")||"",e.isSupportPab=h.getConfig("user.supportpab"),e.displayFields=h.getConfig("contact.oab.normallistattrs"),e.displaySearchFields=h.getConfig("contact.oab.searchlistattrs"),e.viewReturnAttrs=h.getConfig("contact.oab.viewreturnattrs"),e.viewFields=h.getConfig("contact.oab.viewattrs"),e._params={isSearchView:!1,isRecursive:!1,uniqueIds:[]}},render:function(){b.superclass.render.call(this),this._renderList(),this._initTabView(),this._initDropDownMenu(),this._initModuleEvent(),this._initExtraAction()},_renderList:function(e){var n=this;n.$(".content-wrapper .content:visible").mask(),e=t.extend({dn:n.dn,start:0,limit:n.limit,order:n.order,resetPage:!0},e),d.getOabOuUserList(e.dn,e.start,e.limit,e.order).then(function(t,i,a,r){n._displayList(t,i,a,r),n._resetPrevLevelClass(),e.resetPage&&n._initPagination(i)}).always(function(){setTimeout(function(){n.$(".content-wrapper .content:visible").mask("hide")},300)})},_initTabView:function(){new m({element:"section.panel",triggers:".j-switch-menu > .u-btn",panels:"div.j-panel-list > div",activeIndex:0,triggerType:"click",activeTriggerClass:"u-btn-active"})},_initDropDownMenu:function(){function e(e){var t=s.$("#groupsOptionTpl").html(),n=s.compile(t,{groups:e});s.$("span.j-moreOp .u-submenu .u-menu").html(n)}var i,a,r,s=this;r={enableSendMail:h.getConfig("mail.enablesendmail"),isSupportPab:s.isSupportPab,ssoLunkrHost:h.getConfig("user.ssolunkrhost")},i=s.$("#toolbarTpl").html(),a=s.compile(i,r),s.$(".panel .toolbar-wrapper").prepend(a),a=s.$("#mailListToolbarTpl").html(),a=s.compile(a,r),s.$(".j-mailListToolbar").prepend(a),s.isSupportPab&&(s.pabGroups?e(s.pabGroups):d.getAllPabGroups().then(function(t){e(t),s.pabGroups=t})),s.$("span.j-moreOp").dropdown({chooseHtml:!1,callback:function(){var e=t(this).data("action"),i=[],a=[],r=s.$(".panel-content > div:visible"),o=s.$(".j-mailListToolbar").find(t(this)).length>0;if(o)a.push(s.$(".j-listDetail").find("#maillist_id").text()),i.push(s.$(".j-listDetail").find("#maillist_id").text());else if(r.hasClass("list")){var l=s.$(".listview .j-contact");t.each(l,function(e,n){i.push(t(n).data("uniqueid").toString()),a.push(t(n).data("emailaddr"))})}else if(r.hasClass("detail")){var d=s.$("div.j-panel-detail").data("info")||{};i.push(d["@id"]),a.push(d.email)}switch(e){case"addToPabContact":var u=t(this).data("groupid");u="undefined"!==t.type(u)?u.toString():"",0!=i.length?0!=s.$(".listview .j-dir").length?c.alert(n.t("contact/msg_ignoreDepartments"),t.noop(),{closeTpl:"&times;",onConfirm:function(){s._handleAddToPabContact(i,u),this.hide()}}):s._handleAddToPabContact(i,u):c.alert(n.t("contact/msg_selContactToAdd"));break;case"addGroup":s._handleAddGroup(i);break;case"listMails":s.sendMessage("dispatcher","history:add",{module:"mail.search",param:{fromType:"oab",fromAddress:a.join(",")}})}}})},_initDeptStruction:function(){function e(e){var i="",a=n.$("#constructOptionTpl").html();t.each(e,function(e,t){var r={dn:e,value:t};e==n.dn&&(r.selected=!0),i+=n.compile(a,r)}),n.$("#advanceSearchForm select").html(i)}var n=this;n.popup=new r({template:n.$("#advanceSearchTpl").html(),trigger:".j-advanceSearch",triggerType:"click",parentNode:"#advanceSearchTplContainer",align:{baseXY:["100%",0]}}).render(),n.departments?e(n.departments):o.getDirectoriesRecursive().then(function(t){t=t||{},e(t),n.departments=t})},_initModuleEvent:function(){var e=this;e.onMessage("methodInvocation",function(t){var n=t.message&&t.message.method;switch(n){default:e._initExtraAction()}}),e.$("section.content").on("click","span.j-selectAll .checkbox",function(n){n.stopPropagation();var i=t(this).hasClass("checkbox-checked"),a=e._getEleData(i);e.trigger("inputSelect",!0,i,t(this).prev()),e.trigger("updateListItems",!1,i,a)}).on("click",".u-table tbody .checkbox",function(n){n.stopPropagation();var i=t(this).hasClass("checkbox-checked"),a=e._getEleData(i,t(this).prev());e.trigger("inputSelect",!1,i,t(this).prev()),e.trigger("updateListItems",!1,i,a)}).on("div.j-recursive .checkbox",function(e){e.stopPropagation(),t(this).prev().val(""+t(this).hasClass("checkbox-checked"))}),e.on("inputSelect",function(n,i,a){n="boolean"===t.type(n)?n:!1,i="boolean"===t.type(i)?i:!1,a.prop("checked",i);var r=e.$("section.content:visible tbody :checkbox"),s=r.filter(":not(:checked)"),o=r.filter(":checked");if(n)i?(s.prop("checked",!0),s.next().addClass("checkbox-checked"),s.parents("tr").addClass("contact-selected")):(o.prop("checked",!1),o.next().removeClass("checkbox-checked"),o.parents("tr").removeClass("contact-selected"));else{a.parents("tr").toggleClass("contact-selected");var l=e.$("section.content span.j-selectAll .checkbox"),c=l.prev();0==s.length?(l.addClass("checkbox-checked"),c.prop("checked",!0)):(l.removeClass("checkbox-checked"),c.prop("checked",!1))}}),e.on("simulateInputSelect",function(n,i,a){n="boolean"===t.type(n)?n:!1,i="boolean"===t.type(i)?i:!1;var r,s,o,l;n?(r=e.$("section.content tbody :checkbox"),r.prop("checked",i),o=r.next(),l=r.parents("tr"),i?(o.addClass("checkbox-checked"),l.addClass("contact-selected")):(o.removeClass("checkbox-checked"),l.removeClass("contact-selected"))):(r=e.$("section.content tbody"),t.each(a,function(e,t){s=r.find('[data-uniqueid="'+t.uniqueid+'"]').filter('[data-cdn="'+t.cdn+'"]'),0!=s.length&&(o=s.next(),l=s.parents("tr"),s.prop("checked",i),i?(o.addClass("checkbox-checked"),l.addClass("contact-selected")):(o.removeClass("checkbox-checked"),l.removeClass("contact-selected")))})),e.$("section.content").each(function(){var e=t(this).find("span.j-selectAll :checkbox");0==t(this).find("tbody :checkbox:not(:checked)").length?(e.prop("checked",!0),e.next().addClass("checkbox-checked")):(e.prop("checked",!1),e.next().removeClass("checkbox-checked"))})}),e.on("updateListItems",function(n,i,a){e.$("[data-action=toLunkr]").toggle(1==e._params.uniqueIds.length&&!!h.getConfig("user.ssolunkrhost")),n="boolean"===t.type(n)?n:!1,i="boolean"===t.type(i)?i:!1,i?(e._switchPanel("list"),e._appendSelectedList(a)):(e._removeSelectedList(n,a),0==e._params.uniqueIds.length&&e._switchPanel("-list"))}),e.on("customCheckbox",function(){e.element&&e.element.customRadioCheckbox()}),e.on("inputChange",function(){t("#searchInput").on("input propertychange",function(){e._handleSearchChange()})})},_initExtraAction:function(){var e=this,t=h.getCurrentState();if(t.param){var n=t.param.type;if(!n)return!1;switch(e._switchPanel(n),n){case"detail":t.param.id&&e._showContactDetailInfo(t.param.id)}}},_getEleData:function(e,n){var i=this;e="boolean"===t.type(e)?e:!1;var a=n,r=[];return a||(a=e?i.$("section.content:visible tbody :checkbox:not(:checked)"):i.$("section.content:visible tbody :checkbox:checked")),a.each(function(){r.push({uniqueid:t(this).data("uniqueid"),name:t(this).data("name"),emailaddr:t(this).val(),cdn:t(this).data("cdn"),isDir:"show"!=t(this).parents("tr").data("action")})}),r},_renderMailList:function(e){var a,r,s,o=this,c="string"===t.type(e)?e:t(e).find(":checkbox").data("uniqueid");o.$(".content-wrapper").addClass("toggled-mailList"),o.$(".content-wrapper .content:visible").mask(),o.$(".content:visible .u-table thead").html(a),s=o.$(".content:visible .u-table tbody"),d.getOabAttrs(c,o.viewReturnAttrs).then(function(e){e=e[0],r=e["@list"].split(","),a=o.compile(o.$("#mailListDetailsTpl").html(),{name:e.true_name,id:e["@id"],location:e["@location"]}),o.$(".j-listTableDec").html(l.format(n.t("contact/lbl_deptInfo3"),[0,0])),s.html(o.compile(o.$("#contactsEmptyTpl").html(),{colspan:o.displayFields.length+2})),o.$(".j-listDetail").html(a),""!==e["@list"]&&d.getOabAttrs(e["@list"],o.viewReturnAttrs).then(function(e){o.$(".j-listTableDec").html(l.format(n.t("contact/lbl_deptInfo3"),[e.length,e.length]));for(var a=o.$("#listMailListTpl").html(),c="",d=0;d<e.length;d++){var u=e[d];null==u&&(u={true_name:r[d],email:r[d],"@id":r[d]}),u.gender=u.gender?u.gender:0,u["class"]=1==u.gender?"iconwomen gender-woman":"iconman gender-man",u.emailaddr=u.email,u.uniqueid=u["@id"],u.cdn=u["@ou"],u["@ou"]=u["@location"];var p=[];t.each(o.displayFields,function(e,t){if("security_level"===t.id||"user_security_role"===t.id||"sender_security_level"===t.id){var n=u[t.id];u[t.id]=i.securityLevel.i18n(n,t.id)}p.push({id:t.id,value:"O"==u.type&&"true_name"==t.id?u.name:u[t.id]})}),u.fields=p,c+=o.compile(a,u)}s.html(c);var m=[];o.$("div.listview .u-table tbody tr").each(function(){m.push({uniqueid:t(this).data("uniqueid"),cdn:t(this).data("cdn")})}),o.trigger("simulateInputSelect",!1,!0,m),o.trigger("customCheckbox")})}).always(function(){setTimeout(function(){o.$(".content-wrapper .content:visible").mask("hide")},300)})},_displayList:function(e,a,r,s){var o=this,c=!1;o._params.isSearchView&&o._params.isRecursive?c=!0:t.each(o.displayFields,function(e,t){return"@ou"===t.id?(c=!0,!1):void 0});var d=o.$("#listHeadTpl").html(),u=c?o.displaySearchFields:o.displayFields,p=o.compile(d,{fields:u});o.$(".content:visible .u-table thead").html(p);var m=o.$(".content:visible .u-table tbody");if(o._params.isSearchView?o.$(".j-searchHint").remove():(o.$("div.deptInfo").html(l.format(n.t("contact/lbl_deptInfo1"),[i.html.encode(s||""),a,r,a-r])),0==r&&o.$("div.deptInfo .deptcnt").hide()),0==e.length)m.html(o.compile(o.$("#contactsEmptyTpl").html(),{colspan:u.length+2}));else{for(var h=o.$("#listTpl").html(),f="",v=0;v<e.length;v++){var g=e[v];g.type=g["@type"]||"O",g.gender=g.gender?g.gender:0,g["class"]="O"==g.type?"icongroup":"L"==g.type?"iconmaillist":1==g.gender?"iconwomen gender-woman":"iconman gender-man",g.emailaddr=g.email,g.uniqueid=g.id||g["@id"],g.cdn=g["@ou"],g["@ou"]=g["@location"];var b=[];t.each(u,function(e,t){if("security_level"===t.id||"user_security_role"===t.id||"sender_security_level"===t.id){var n=g[t.id];g[t.id]=i.securityLevel.i18n(n,t.id)}b.push({id:t.id,value:"O"==g.type&&"true_name"==t.id?g.name:g[t.id]})}),g.fields=b,f+=o.compile(h,g)}m.html(f);var _=[];o.$("div.listview .u-table tbody tr").each(function(){_.push({uniqueid:t(this).data("uniqueid"),cdn:t(this).data("cdn")})}),o.trigger("simulateInputSelect",!1,!0,_)}o.trigger("customCheckbox")},_initPagination:function(e){var t=this;t.$("#pagination").pagination({total:e||1,limit:t.limit,round:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(e){t._renderList({start:e*t.limit,resetPage:!1})}})},_initSearchListPagination:function(e){var t=this;t.$("#pagination1").pagination({total:e||1,limit:t.limit,round:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(e){var n={dn:t.dn,start:e*t.limit,limit:t.limit,resetPage:!1};t.order&&(n.order=t.order.field,n.desc=t.order.desc),t._renderSearchList(n)}})},_switchPanel:function(e){var t=this;if(0==e.indexOf("-")){var n=e.substring(1);return void("detail"==n&&0!=t._params.uniqueIds.length?t.$(".main-wrapper").removeClass("switch-detail").addClass("switch-list"):t.$(".main-wrapper").removeClass("switch-detail switch-list"))}"list"==e?t.$(".main-wrapper").removeClass("switch-detail").addClass("switch-list"):t.$(".main-wrapper").removeClass("switch-list").addClass("switch-detail")},_renderSearchList:function(e){var a=this;a.$(".content-wrapper > .content:visible").mask();var r="boolean"===t.type(e.resetPage)?e.resetPage:!0;delete e.resetPage,d.advanceSearchOabContacts(e).then(function(e,t){a._displayList(e),r&&a._initSearchListPagination(t);var s=i.messageFormat.format(n.t("contact/lbl_summary"),t);a.$("div.searchResult label:eq(1)").removeClass("f-dn").html(s)}).always(function(){setTimeout(function(){a.$(".content-wrapper > .content:visible").mask("hide"),a.$("#searchInput").focus()},300)})},_dispatchAction:function(e,i){var r=this,s=t(i).data("action"),o=null;switch(s){case"advanceSearch":var l=t('[name="advanceSearchForm"]').serializeJSON({parseBooleans:!0});r.dn=l.dn,l.limit=r.limit,r._params.isRecursive=l.recursive,r._renderSearchList(l),r.popup&&r.popup.hide();break;case"goNext":r.dn=t(i).data("dn"),r._renderList();break;case"goPrev":if("mailList"==t(i).data("type"))r.$(".content-wrapper").removeClass("toggled-mailList");else{var p=a.getOrg(r.dn);r.dn=d.getDNIndex(r.dn)||p,r._renderList()}break;case"show":r._switchPanel("detail"),r._showContactDetailInfo(i);break;case"startSearch":r._startSearchContact(t(i).prev().val().trim());break;case"goCompose":var m=[],h=r.$(".panel-content > div:visible"),f=r.$(".j-mailListToolbar").find(t(i)).length>0;if(f)m.push(r.$(".j-listDetail").find("#maillist_id").text());else if(h.hasClass("list"))t.each(r.$(".listview tbody tr"),function(e,n){var i,a=t(n).data("name"),r=t(n).data("emailaddr");i=a?a+" <"+r+">":r,m.push(i)});else if(h.hasClass("detail")){var v="";o=r.$("div.j-panel-detail").data("info")||{},v=o.true_name?o.true_name+" <"+o.email+">":o.email,m.push(v)}u.getComposeInfo({ctype:"normal",to:m}).then(function(e){r.sendMessage("dispatcher","history:add",{module:"mail.compose",param:{id:e.id}})});break;case"toLunkr":m=[],h=r.$(".panel-content > div:visible"),f=r.$(".j-mailListToolbar").find(t(i)).length>0,f?m.push(r.$(".j-listDetail").find("#maillist_id").text()):h.hasClass("list")?t.each(r.$(".listview tbody tr"),function(e,n){var i=t(n).data("emailaddr");m.push(i)}):h.hasClass("detail")&&(o=r.$("div.j-panel-detail").data("info")||{},m.push(o.email)),0===m.length?c.alert(n.t("contact/msg_empty_email")):1===m.length&&t("body").trigger("Lunkr.view.refresh",{type:"route",route:m[0],origin:"webMailNewChat2"});break;case"accessToOu":o=t(i).closest(".j-panel-detail").data("info")||{},r.dn=o["@ou"],r._params.isSearchView=!1,r._toggleContentView(!0),r._renderList(),r.sendMessage("contact","oabTree:markNode",{cid:r.dn});break;case"accessToList":r._renderMailList(i)}},_dispatchOperation:function(e,n){var i=this,a=t(n).data("operation");switch(a){case"remove":var r=t(n).parents("[data-uniqueid]"),s=[{uniqueid:r.data("uniqueid"),cdn:r.data("cdn")}];i.trigger("updateListItems",!1,!1,s),i.trigger("simulateInputSelect",!1,!1,s);break;case"removeAll":i.trigger("updateListItems",!0,!1,s),i.trigger("simulateInputSelect",!0,!1);break;case"showSearchList":i._params.isSearchView=!0,i._toggleContentView();break;case"showList":i._params.isSearchView=!1,i._toggleContentView();break;case"closePopup":i.popup&&i.popup.hide();break;case"cleanUpText":t(n).addClass("f-dn"),t(n).prev("input").val("");break;case"closeDetails":i._switchPanel("-detail")}},_doSortList:function(e,t){var n=this,i=n.$(t).data("sort"),a=n.$(t).find("i");a.hasClass("icondown")||a.hasClass("iconup")?a.toggleClass("icondown iconup"):(n.$(".content:visible [data-sort] i").removeClass("icondown iconup"),a.addClass("iconup")),n.order?n.order={field:i,desc:!n.order.desc}:n.order={field:i,desc:!1},n._params.isSearchView?n._renderSearchList({start:0,limit:n.limit,order:n.order.field,desc:n.order.desc}):n._renderList()},_appendSelectedList:function(e){for(var n=this,i=n.$("#selectedContactListTpl").html(),a=n.$("#selectedContactThumbTpl").html(),r="",s="",o=[],l=0;!0&&l!=e.length;l++){var c=e[l],u=c.uniqueid;-1==t.inArray(u,n._params.uniqueIds)&&(n._params.uniqueIds.push(u),n.$("[data-action=toLunkr]").toggle(1==n._params.uniqueIds.length&&!!h.getConfig("user.ssolunkrhost")),c.isDir?c.avatar=CC.assetPath("style/img/people.png"):o.push(u),r+=n.compile(i,c),s+=n.compile(a,c))}n.$("div.thumbview ul").append(s),n.$("div.listview .u-table tbody").append(r),d.getContactAvatar("oab",o.join(" ")).then(function(e){t.each(e,function(e,t){n.$('div.thumbview [data-uniqueid="'+t.uid+'"] img').attr("src",t.avatarUrl),n.$('div.listview [data-uniqueid="'+t.uid+'"]').addClass("j-contact")})})},_removeSelectedList:function(e,n){var i=this;e="boolean"===t.type(e)?e:!1,e?(i.$("div.listview tbody").empty(),i.$("div.thumbview ul").empty(),i._params.uniqueIds=[]):t.each(n,function(e,n){var a=n.uniqueid,r=t.inArray(a,i._params.uniqueIds);i._params.uniqueIds.splice(r,1),i.$('div.thumbview [data-uniqueid="'+a+'"]').remove(),i.$('div.listview [data-uniqueid="'+a+'"]').remove()})},_showContactDetailInfo:function(e){var a=this,r="string"===t.type(e)?e:t(e).find(":checkbox").data("uniqueid");a.$(".panel").mask(),t.when(d.getOabAttrs(r,a.viewReturnAttrs),d.getContactAvatar("oab",r)).then(function(e,s){e=e[0]||{},t.isEmptyObject(e)&&(e.id=r,e.name=r,e.email=r),e.id=e["@id"],e.name=e.true_name?e.true_name:e.nick_name?e.nick_name+n.t("contact/lbl_nickName"):"",e.avatar=s[0].avatarUrl,e.emailaddr=e.email,e.location=e["@location"],e.ou=e["@ou"],e.genderCls=1==e.gender?"iconwomen gender-woman":"iconman gender-man",e.province&&e.city&&(e.area=f.out(e.province,e.city,a.locale));var o=[],l="true_name @location @ou duty emails".split(" ");t.each(a.viewFields,function(n,a){if(-1==t.inArray(a.id,l)){var r;if("email"==a.id&&e.emails)r=e.emails.join(",");else if("security_level"==a.id||"user_security_role"==a.id||"sender_security_level"==a.id){var s=e[a.id];r=i.securityLevel.i18n(s)}else r=e[a.id];o.push(t.extend({value:r},a))}}),e.fields=o;var c=a.$("#contactTpl").html(),d=a.compile(c,e);a.$("div.j-panel-detail").html(d).data("info",e)}).always(function(){setTimeout(function(){a.$(".panel").mask("hide")},300)})},_toggleContentView:function(e){var n=this;e="boolean"===t.type(e)?e:!1,n.$(".content-wrapper").hasClass("toggled-searchList")?(n._params.isMailList&&n.$(".content-wrapper").addClass("toggled-mailList"),n.$(".content-wrapper").removeClass("toggled-searchList")):e||(n._params.isMailList=n.$(".content-wrapper").hasClass("toggled-mailList"),n.$(".content-wrapper").removeClass("toggled-mailList").addClass("toggled-searchList"),n.$("#searchViewContainer").html(n.$("#searchViewTpl").html()),setTimeout(function(){n.$("#searchInput").focus(),n.trigger("inputChange")},100),n._initDeptStruction(),n._params.isRecursive=!0,n.trigger("customCheckbox"))},_resetPrevLevelClass:function(e){var t=this;e=e||t.dn,a.isOrgRoot(e)?t.$("button.j-goPrevLevel").hide():t.$("button.j-goPrevLevel").show()},_searchContact:function(e,n){var i=this,a=t.trim(t(n).val());13==e.which&&(t(n).blur(),i._startSearchContact(a))},_handleSearchChange:function(){var e=t.trim(this.$("#searchInput").val());e.length>0&&this.$("#searchInput").parent().addClass("f-have-content")},_startSearchContact:function(e){var t=this;t.dn=a.getOrg(t.dn),t._params.isRecursive=!0,-1!=e.indexOf("@")?t._renderSearchList({email:e,dn:t.dn,limit:t.limit,recursive:!0,action:"advanceSearch"}):t._renderSearchList({general:e,dn:t.dn,limit:t.limit,recursive:!0,action:"quickSearch"})},_handleAddGroup:function(e){var i=this,a=i.$("#addGroupTpl").html();return 0==e.length?(c.alert(n.t("contact/msg_selContactToAdd"),t.noop(),{parentNode:".content:visible"}),!1):void d.getAllPabGroups().then(function(r){c.confirm(a,t.noop(),t.noop(),{parentNode:".content:visible",onConfirm:function(){var a=i.$("#addGrpName").val(),s=g.validate(a,r,"addnew");return s.state?(d.savePabGroup({name:a,type:1,uidsForOab:e.join(" ")}).then(function(e){var i=e.summary||{};t.notify(l.format(n.t("contact/msg_exportToPabSuccessful"),[i.added,i.updated,i.ignored]))}),void this.hide()):(i.$("#errMsg").removeClass("f-dn").find("label").html(s.errMsg),!1)}})})},_handleAddToPabContact:function(e,i){o.exportToPab(e,i).then(function(e,i,a){t.notify(l.format(n.t("contact/msg_exportToPabSuccessful"),[e,i,a]))},function(){t.notify(n.t("contact/msg_exportToPabFail"),{type:"error"})})},templateHelpers:{formatted:function(e){return"array"===t.type(e)&&(e=e.join(",")),e||n.t("common/none")}}});p.module({name:"contact.oab",template:e("text!template/module/contact/oabContact.tpl.html")},b)}),function(e){"function"==typeof define&&define.amd?define("components/cropper/dist/cropper",["jquery"],e):e("object"==typeof exports?require("jquery"):jQuery)}(function(e){"use strict";function t(e){return"number"==typeof e}function n(e){return"undefined"==typeof e}function i(e,n){var i=[];return t(n)&&i.push(n),i.slice.apply(e,i)}function a(e,t){var n=i(arguments,2);return function(){return e.apply(t,n.concat(i(arguments)))}}function r(e){var t=e.match(/^(https?:)\/\/([^\:\/\?#]+):?(\d*)/i);return t&&(t[1]!==m.protocol||t[2]!==m.hostname||t[3]!==m.port)}function s(e){var t="timestamp="+(new Date).getTime();return e+(-1===e.indexOf("?")?"?":"&")+t}function o(e){return e?"rotate("+e+"deg)":"none"}function l(e,t){var n,i,a=q(e.degree)%180,r=(a>90?180-a:a)*Math.PI/180,s=H(r),o=B(r),l=e.width,c=e.height,d=e.aspectRatio;return t?(n=l/(o+s/d),i=n/d):(n=l*o+c*s,i=l*s+c*o),{width:n,height:i}}function c(t,n){var i=e("<canvas>")[0],a=i.getContext("2d"),r=n.naturalWidth,s=n.naturalHeight,o=n.rotate,c=l({width:r,height:s,degree:o});return o?(i.width=c.width,i.height=c.height,a.save(),a.translate(c.width/2,c.height/2),a.rotate(o*Math.PI/180),a.drawImage(t,-r/2,-s/2,r,s),a.restore()):(i.width=r,i.height=s,a.drawImage(t,0,0,r,s)),i}function d(t,n){this.$element=e(t),this.options=e.extend({},d.DEFAULTS,e.isPlainObject(n)&&n),this.ready=!1,this.built=!1,this.rotated=!1,this.cropped=!1,this.disabled=!1,this.load()}var u=e(window),p=e(document),m=window.location,h=".cropper",f=/^(e|n|w|s|ne|nw|sw|se|all|crop|move|zoom)$/,v="cropper-modal",g="cropper-hide",b="cropper-hidden",_="cropper-invisible",y="cropper-move",w="cropper-crop",x="cropper-disabled",C="cropper-bg",k="mousedown touchstart",S="mousemove touchmove",T="mouseup mouseleave touchend touchleave touchcancel",j="wheel mousewheel DOMMouseScroll",I="dblclick",A="resize"+h,E="build"+h,D="built"+h,P="dragstart"+h,M="dragmove"+h,L="dragend"+h,F="zoomin"+h,$="zoomout"+h,N=e.isFunction(e("<canvas>")[0].getContext),R=Math.sqrt,O=Math.min,U=Math.max,q=Math.abs,H=Math.sin,B=Math.cos,z=parseFloat,V={};V.load=function(t){var n,i,a,o=this.options,l=this.$element;t||(l.is("img")?t=l.prop("src"):l.is("canvas")&&N&&(t=l[0].toDataURL())),t&&(i=e.Event(E),l.one(E,o.build).trigger(i),i.isDefaultPrevented()||(o.checkImageOrigin&&r(t)&&(n=" crossOrigin",l.prop("crossOrigin")||(t=s(t))),this.$clone=a=e("<img>"),a.one("load",e.proxy(function(){var e=a.prop("naturalWidth")||a.width(),n=a.prop("naturalHeight")||a.height();this.image={naturalWidth:e,naturalHeight:n,aspectRatio:e/n,rotate:0},this.url=t,this.ready=!0,this.build()},this)).attr({src:t,crossOrigin:n}),a.addClass(g).insertAfter(l)))},V.build=function(){var t,n,i=this.$element,a=this.$clone,r=this.options;this.ready&&(this.built&&this.unbuild(),this.$cropper=t=e(d.TEMPLATE),i.addClass(b),a.removeClass(g),this.$container=i.parent().append(t),this.$canvas=t.find(".cropper-canvas").append(a),this.$dragBox=t.find(".cropper-drag-box"),this.$cropBox=n=t.find(".cropper-crop-box"),this.$viewBox=t.find(".cropper-view-box"),this.addListeners(),this.initPreview(),r.aspectRatio=z(r.aspectRatio)||NaN,r.autoCrop?(this.cropped=!0,r.modal&&this.$dragBox.addClass(v)):n.addClass(b),r.background&&t.addClass(C),r.highlight||n.find(".cropper-face").addClass(_),r.guides||n.find(".cropper-dashed").addClass(b),r.movable||n.find(".cropper-face").data("drag","move"),r.resizable||n.find(".cropper-line, .cropper-point").addClass(b),this.setDragMode(r.dragCrop?"crop":"move"),this.built=!0,this.render(),i.one(D,r.built).trigger(D))},V.unbuild=function(){this.built&&(this.built=!1,this.removeListeners(),this.$preview.empty(),this.$preview=null,this.$viewBox=null,this.$cropBox=null,this.$dragBox=null,this.$canvas=null,this.$container=null,this.$cropper.remove(),this.$cropper=null)},e.extend(V,{render:function(){this.initContainer(),this.initCanvas(),this.initCropBox()},initContainer:function(){var e=this.$element,t=this.$container,n=this.$cropper,i=this.options;n.addClass(b),e.removeClass(b),n.css(this.container={width:U(t.width(),z(i.minContainerWidth)||200),height:U(t.height(),z(i.minContainerHeight)||100)}),e.addClass(b),n.removeClass(b)},initCanvas:function(){var t=this.options,n=this.container,i=n.width,a=n.height,r=this.image,s=r.aspectRatio,o={aspectRatio:s,width:i,height:a,left:0,top:0,minLeft:-i,minTop:-a,maxLeft:i,maxTop:a,minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0};a*s>i?t.strict?o.width=a*s:o.height=i/s:t.strict?o.height=i/s:o.width=a*s,o.oldLeft=o.left=(i-o.width)/2,o.oldTop=o.top=(a-o.height)/2,this.canvas=o,this.limitCanvas(),this.initialImage=e.extend({},r),this.initialCanvas=e.extend({},this.canvas),this.renderCanvas()},limitCanvas:function(){var e=this.options,t=this.container,n=t.width,i=t.height,a=this.canvas,r=a.aspectRatio,s=n,o=i;i*r>n?e.strict?s=i*r:o=n/r:e.strict?o=n/r:s=i*r,e.strict?(a.minWidth=s,a.minHeight=o,a.maxLeft=0,a.maxTop=0,a.minLeft=n-s,a.minTop=i-o):(a.minLeft=-s,a.minTop=-o)},renderCanvas:function(t){var n,i,a,r=this.options,s=this.container,c=this.canvas,d=this.image;this.rotated&&(this.rotated=!1,a=l({width:d.width,height:d.height,degree:d.rotate}),n=a.width/a.height,n!==c.aspectRatio&&(c.left-=(a.width-c.width)/2,c.top-=(a.height-c.height)/2,c.width=a.width,c.height=a.height,c.aspectRatio=n,this.limitCanvas())),(c.width>c.maxWidth||c.width<c.minWidth)&&(c.left=c.oldLeft),(c.height>c.maxHeight||c.height<c.minHeight)&&(c.top=c.oldTop),c.width=O(U(c.width,c.minWidth),c.maxWidth),c.height=O(U(c.height,c.minHeight),c.maxHeight),r.strict?(c.minLeft=s.width-c.width,c.minTop=s.height-c.height):(c.minLeft=-c.width,c.minTop=-c.height),c.oldLeft=c.left=O(U(c.left,c.minLeft),c.maxLeft),c.oldTop=c.top=O(U(c.top,c.minTop),c.maxTop),this.$canvas.css({width:c.width,height:c.height,left:c.left,top:c.top}),d.rotate?(i=l({width:c.width,height:c.height,degree:d.rotate,aspectRatio:d.aspectRatio},!0),e.extend(d,{width:i.width,height:i.height,left:(c.width-i.width)/2,top:(c.height-i.height)/2})):e.extend(d,{width:c.width,height:c.height,left:0,top:0}),this.$clone.css({width:d.width,height:d.height,marginLeft:d.left,marginTop:d.top,transform:o(d.rotate)}),t&&(this.preview(),r.crop&&r.crop.call(this.$element,this.getData()))},initCropBox:function(){var t=this.options,n=this.container,i=this.canvas,a=t.strict,r=t.aspectRatio,s=z(t.minCropBoxWidth)||0,o=z(t.minCropBoxHeight)||0,l=z(t.autoCropArea)||.8,c=n.width,d=n.height,u={width:a?c:i.width,height:a?d:i.height,minWidth:s,minHeight:o,maxWidth:c,maxHeight:d};r&&(d*r>c?(u.height=u.width/r,u.maxHeight=c/r):(u.width=u.height*r,u.maxWidth=d*r),a||(u.height*i.aspectRatio>u.width?(u.height=i.height,u.width=u.height*r):(u.width=i.width,u.height=u.width/r)),s?u.minHeight=u.minWidth/r:o&&(u.minWidth=u.minHeight*r)),u.minWidth=O(u.maxWidth,u.minWidth),u.minHeight=O(u.maxHeight,u.minHeight),u.width=U(u.minWidth,u.width*l),u.height=U(u.minHeight,u.height*l),u.oldLeft=u.left=(c-u.width)/2,u.oldTop=u.top=(d-u.height)/2,this.initialCropBox=e.extend({},u),this.cropBox=u,this.cropped&&this.renderCropBox()},renderCropBox:function(){var e=this.options,t=this.container,n=t.width,i=t.height,a=this.$cropBox,r=this.cropBox;(r.width>r.maxWidth||r.width<r.minWidth)&&(r.left=r.oldLeft),(r.height>r.maxHeight||r.height<r.minHeight)&&(r.top=r.oldTop),r.width=O(U(r.width,r.minWidth),r.maxWidth),r.height=O(U(r.height,r.minHeight),r.maxHeight),r.oldLeft=r.left=O(U(r.left,0),n-r.width),r.oldTop=r.top=O(U(r.top,0),i-r.height),e.movable&&a.find(".cropper-face").data("drag",r.width===n&&r.height===i?"move":"all"),a.css({width:r.width,height:r.height,left:r.left,top:r.top}),this.disabled||(this.preview(),e.crop&&e.crop.call(this.$element,this.getData()))}}),V.initPreview=function(){var t=this.url;this.$preview=e(this.options.preview),this.$viewBox.html('<img src="'+t+'">'),this.$preview.each(function(){var n=e(this);n.data({width:n.width(),height:n.height()}).html('<img src="'+t+'" style="display:block;width:100%;min-width:0!important;min-height:0!important;max-width:none!important;max-height:none!important;image-orientation: 0deg!important">')})},V.preview=function(){var t=this.image,n=this.canvas,i=this.cropBox,a=t.width,r=t.height,s=i.left-n.left-t.left,l=i.top-n.top-t.top,c=t.rotate;this.cropped&&!this.disabled&&(this.$viewBox.find("img").css({width:a,height:r,marginLeft:-s,marginTop:-l,transform:o(c)}),this.$preview.each(function(){var t=e(this),n=t.data(),d=n.width/i.width,u=n.width,p=i.height*d;p>n.height&&(d=n.height/i.height,u=i.width*d,p=n.height),t.width(u).height(p).find("img").css({width:a*d,height:r*d,marginLeft:-s*d,marginTop:-l*d,transform:o(c)})}))},V.addListeners=function(){var t=this.options;this.$element.on(P,t.dragstart).on(M,t.dragmove).on(L,t.dragend).on(F,t.zoomin).on($,t.zoomout),this.$cropper.on(k,e.proxy(this.dragstart,this)).on(I,e.proxy(this.dblclick,this)),t.zoomable&&t.mouseWheelZoom&&this.$cropper.on(j,e.proxy(this.wheel,this)),p.on(S,this._dragmove=a(this.dragmove,this)).on(T,this._dragend=a(this.dragend,this)),t.responsive&&u.on(A,this._resize=a(this.resize,this))},V.removeListeners=function(){var e=this.options;this.$element.off(P,e.dragstart).off(M,e.dragmove).off(L,e.dragend).off(F,e.zoomin).off($,e.zoomout),this.$cropper.off(k,this.dragstart).off(I,this.dblclick),e.zoomable&&e.mouseWheelZoom&&this.$cropper.off(j,this.wheel),p.off(S,this._dragmove).off(T,this._dragend),e.responsive&&u.off(A,this._resize)},e.extend(V,{resize:function(){var t,n,i,a=this.$container,r=this.container;this.disabled||(i=a.width()/r.width,(1!==i||a.height()!==r.height)&&(t=this.getCanvasData(),n=this.getCropBoxData(),this.render(),this.setCanvasData(e.each(t,function(e,n){t[e]=n*i})),this.setCropBoxData(e.each(n,function(e,t){n[e]=t*i}))))},dblclick:function(){this.disabled||(this.$dragBox.hasClass(w)?this.setDragMode("move"):this.setDragMode("crop"))},wheel:function(e){var t=e.originalEvent,n=1;this.disabled||(e.preventDefault(),t.deltaY?n=t.deltaY>0?1:-1:t.wheelDelta?n=-t.wheelDelta/120:t.detail&&(n=t.detail>0?1:-1),this.zoom(.1*n))},dragstart:function(t){var n,i,a,r=this.options,s=t.originalEvent,o=s&&s.touches,l=t;if(!this.disabled){if(o){if(a=o.length,a>1){if(!r.zoomable||!r.touchDragZoom||2!==a)return;l=o[1],this.startX2=l.pageX,this.startY2=l.pageY,n="zoom"}l=o[0]}if(n=n||e(l.target).data("drag"),f.test(n)){if(t.preventDefault(),i=e.Event(P,{originalEvent:s,dragType:n}),this.$element.trigger(i),i.isDefaultPrevented())return;this.dragType=n,this.cropping=!1,this.startX=l.pageX,this.startY=l.pageY,"crop"===n&&(this.cropping=!0,this.$dragBox.addClass(v))}}},dragmove:function(t){var n,i,a=this.options,r=t.originalEvent,s=r&&r.touches,o=t,l=this.dragType;if(!this.disabled){if(s){if(i=s.length,i>1){if(!a.zoomable||!a.touchDragZoom||2!==i)return;o=s[1],this.endX2=o.pageX,this.endY2=o.pageY}o=s[0]}if(l){if(t.preventDefault(),n=e.Event(M,{originalEvent:r,dragType:l}),this.$element.trigger(n),n.isDefaultPrevented())return;this.endX=o.pageX,this.endY=o.pageY,
this.change()}}},dragend:function(t){var n,i=this.dragType;if(!this.disabled&&i){if(t.preventDefault(),n=e.Event(L,{originalEvent:t.originalEvent,dragType:i}),this.$element.trigger(n),n.isDefaultPrevented())return;this.cropping&&(this.cropping=!1,this.$dragBox.toggleClass(v,this.cropped&&this.options.modal)),this.dragType=""}}}),e.extend(V,{reset:function(){this.disabled||(this.image=e.extend({},this.initialImage),this.canvas=e.extend({},this.initialCanvas),this.renderCanvas(),this.cropped&&(this.cropBox=e.extend({},this.initialCropBox),this.renderCropBox()))},clear:function(){this.cropped&&!this.disabled&&(e.extend(this.cropBox,{left:0,top:0,width:0,height:0}),this.renderCropBox(),this.cropped=!1,this.$dragBox.removeClass(v),this.$cropBox.addClass(b))},destroy:function(){var e=this.$element;this.ready||this.$clone.off("load").remove(),this.unbuild(),e.removeClass(b).removeData("cropper")},replace:function(e){this.ready&&!this.disabled&&e&&this.load(e)},enable:function(){this.built&&(this.disabled=!1,this.$cropper.removeClass(x))},disable:function(){this.built&&(this.disabled=!0,this.$cropper.addClass(x))},move:function(e,n){var i=this.canvas;this.built&&!this.disabled&&t(e)&&t(n)&&(i.left+=e,i.top+=n,this.renderCanvas(!0))},zoom:function(t){var n,i,a,r=this.canvas;if(t=z(t),t&&this.built&&!this.disabled&&this.options.zoomable){if(n=t>0?e.Event(F):e.Event($),this.$element.trigger(n),n.isDefaultPrevented())return;t=-1>=t?1/(1-t):1>=t?1+t:t,i=r.width*t,a=r.height*t,r.left-=(i-r.width)/2,r.top-=(a-r.height)/2,r.width=i,r.height=a,this.renderCanvas(!0),this.setDragMode("move")}},rotate:function(e){var t=this.image;e=z(e),e&&this.built&&!this.disabled&&this.options.rotatable&&(t.rotate=(t.rotate+e)%360,this.rotated=!0,this.renderCanvas(!0))},getData:function(){var t,n,i=this.cropBox,a=this.canvas,r=this.image,s=r.rotate;return this.built&&this.cropped?(n={x:i.left-a.left,y:i.top-a.top,width:i.width,height:i.height},t=r.width/r.naturalWidth,e.each(n,function(e,i){i/=t,n[e]=i})):n={x:0,y:0,width:0,height:0},n.rotate=s,n},getContainerData:function(){return this.built?this.container:{}},getImageData:function(){return this.ready?this.image:{}},getCanvasData:function(){var e,t=this.canvas;return this.built&&(e={left:t.left,top:t.top,width:t.width,height:t.height}),e||{}},setCanvasData:function(n){var i=this.canvas,a=i.aspectRatio;this.built&&!this.disabled&&e.isPlainObject(n)&&(t(n.left)&&(i.left=n.left),t(n.top)&&(i.top=n.top),t(n.width)?(i.width=n.width,i.height=n.width/a):t(n.height)&&(i.height=n.height,i.width=n.height*a),this.renderCanvas(!0))},getCropBoxData:function(){var e,t=this.cropBox;return this.built&&this.cropped&&(e={left:t.left,top:t.top,width:t.width,height:t.height}),e||{}},setCropBoxData:function(n){var i=this.cropBox,a=this.options.aspectRatio;this.built&&this.cropped&&!this.disabled&&e.isPlainObject(n)&&(t(n.left)&&(i.left=n.left),t(n.top)&&(i.top=n.top),a?t(n.width)?(i.width=n.width,i.height=i.width/a):t(n.height)&&(i.height=n.height,i.width=i.height*a):(t(n.width)&&(i.width=n.width),t(n.height)&&(i.height=n.height)),this.renderCropBox())},getCroppedCanvas:function(t){var n,i,a,r,s,o,l,d,u,p,m;if(this.built&&this.cropped&&N)return e.isPlainObject(t)||(t={}),m=this.getData(),n=m.width,i=m.height,d=n/i,e.isPlainObject(t)&&(s=t.width,o=t.height,s?(o=s/d,l=s/n):o&&(s=o*d,l=o/i)),a=s||n,r=o||i,u=e("<canvas>")[0],u.width=a,u.height=r,p=u.getContext("2d"),t.fillColor&&(p.fillStyle=t.fillColor,p.fillRect(0,0,a,r)),p.drawImage.apply(p,function(){var e,t,a,r,s,o,d=c(this.$clone[0],this.image),u=d.width,p=d.height,h=[d],f=m.x,v=m.y;return-n>=f||f>u?f=e=a=s=0:0>=f?(a=-f,f=0,e=s=O(u,n+f)):u>=f&&(a=0,e=s=O(n,u-f)),0>=e||-i>=v||v>p?v=t=r=o=0:0>=v?(r=-v,v=0,t=o=O(p,i+v)):p>=v&&(r=0,t=o=O(i,p-v)),h.push(f,v,e,t),l&&(a*=l,r*=l,s*=l,o*=l),s>0&&o>0&&h.push(a,r,s,o),h}.call(this)),u},setAspectRatio:function(e){var t=this.options;this.disabled||n(e)||(t.aspectRatio=z(e)||NaN,this.built&&this.initCropBox())},setDragMode:function(e){var t=this.$dragBox,n=!1,i=!1;if(this.ready&&!this.disabled){switch(e){case"crop":this.options.dragCrop?(n=!0,t.data("drag",e)):i=!0;break;case"move":i=!0,t.data("drag",e);break;default:t.removeData("drag")}t.toggleClass(w,n).toggleClass(y,i)}}}),V.change=function(){var e,t=this.dragType,n=this.canvas,i=this.container,a=i.width,r=i.height,s=this.cropBox,o=s.width,l=s.height,c=s.left,d=s.top,u=c+o,p=d+l,m=!0,h=this.options.aspectRatio,f={x:this.endX-this.startX,y:this.endY-this.startY};switch(h&&(f.X=f.y*h,f.Y=f.x/h),t){case"all":c+=f.x,d+=f.y;break;case"e":if(f.x>=0&&(u>=a||h&&(0>=d||p>=r))){m=!1;break}o+=f.x,h&&(l=o/h,d-=f.Y/2),0>o&&(t="w",o=0);break;case"n":if(f.y<=0&&(0>=d||h&&(0>=c||u>=a))){m=!1;break}l-=f.y,d+=f.y,h&&(o=l*h,c+=f.X/2),0>l&&(t="s",l=0);break;case"w":if(f.x<=0&&(0>=c||h&&(0>=d||p>=r))){m=!1;break}o-=f.x,c+=f.x,h&&(l=o/h,d+=f.Y/2),0>o&&(t="e",o=0);break;case"s":if(f.y>=0&&(p>=r||h&&(0>=c||u>=a))){m=!1;break}l+=f.y,h&&(o=l*h,c-=f.X/2),0>l&&(t="n",l=0);break;case"ne":if(h){if(f.y<=0&&(0>=d||u>=a)){m=!1;break}l-=f.y,d+=f.y,o=l*h}else f.x>=0?a>u?o+=f.x:f.y<=0&&0>=d&&(m=!1):o+=f.x,f.y<=0?d>0&&(l-=f.y,d+=f.y):(l-=f.y,d+=f.y);0>o&&0>l?(t="sw",l=0,o=0):0>o?(t="nw",o=0):0>l&&(t="se",l=0);break;case"nw":if(h){if(f.y<=0&&(0>=d||0>=c)){m=!1;break}l-=f.y,d+=f.y,o=l*h,c+=f.X}else f.x<=0?c>0?(o-=f.x,c+=f.x):f.y<=0&&0>=d&&(m=!1):(o-=f.x,c+=f.x),f.y<=0?d>0&&(l-=f.y,d+=f.y):(l-=f.y,d+=f.y);0>o&&0>l?(t="se",l=0,o=0):0>o?(t="ne",o=0):0>l&&(t="sw",l=0);break;case"sw":if(h){if(f.x<=0&&(0>=c||p>=r)){m=!1;break}o-=f.x,c+=f.x,l=o/h}else f.x<=0?c>0?(o-=f.x,c+=f.x):f.y>=0&&p>=r&&(m=!1):(o-=f.x,c+=f.x),f.y>=0?r>p&&(l+=f.y):l+=f.y;0>o&&0>l?(t="ne",l=0,o=0):0>o?(t="se",o=0):0>l&&(t="nw",l=0);break;case"se":if(h){if(f.x>=0&&(u>=a||p>=r)){m=!1;break}o+=f.x,l=o/h}else f.x>=0?a>u?o+=f.x:f.y>=0&&p>=r&&(m=!1):o+=f.x,f.y>=0?r>p&&(l+=f.y):l+=f.y;0>o&&0>l?(t="nw",l=0,o=0):0>o?(t="sw",o=0):0>l&&(t="ne",l=0);break;case"move":n.left+=f.x,n.top+=f.y,this.renderCanvas(!0),m=!1;break;case"zoom":this.zoom(function(e,t,n,i){var a=R(e*e+t*t),r=R(n*n+i*i);return(r-a)/a}(q(this.startX-this.startX2),q(this.startY-this.startY2),q(this.endX-this.endX2),q(this.endY-this.endY2))),this.startX2=this.endX2,this.startY2=this.endY2,m=!1;break;case"crop":f.x&&f.y&&(e=this.$cropper.offset(),c=this.startX-e.left,d=this.startY-e.top,o=s.minWidth,l=s.minHeight,f.x>0?f.y>0?t="se":(t="ne",d-=l):f.y>0?(t="sw",c-=o):(t="nw",c-=o,d-=l),this.cropped||(this.cropped=!0,this.$cropBox.removeClass(b)))}m&&(s.width=o,s.height=l,s.left=c,s.top=d,this.dragType=t,this.renderCropBox()),this.startX=this.endX,this.startY=this.endY},e.extend(d.prototype,V),d.DEFAULTS={aspectRatio:NaN,autoCropArea:.8,crop:null,preview:"",strict:!0,responsive:!0,checkImageOrigin:!0,modal:!0,guides:!0,highlight:!0,background:!0,autoCrop:!0,dragCrop:!0,movable:!0,resizable:!0,rotatable:!0,zoomable:!0,touchDragZoom:!0,mouseWheelZoom:!0,minCropBoxWidth:0,minCropBoxHeight:0,minContainerWidth:200,minContainerHeight:100,build:null,built:null,dragstart:null,dragmove:null,dragend:null,zoomin:null,zoomout:null},d.setDefaults=function(t){e.extend(d.DEFAULTS,t)},d.TEMPLATE=function(e,t){return t=t.split(","),e.replace(/\d+/g,function(e){return t[e]})}('<0 6="5-container"><0 6="5-canvas"></0><0 6="5-2-9" 3-2="move"></0><0 6="5-crop-9"><1 6="5-view-9"></1><1 6="5-8 8-h"></1><1 6="5-8 8-v"></1><1 6="5-face" 3-2="all"></1><1 6="5-7 7-e" 3-2="e"></1><1 6="5-7 7-n" 3-2="n"></1><1 6="5-7 7-w" 3-2="w"></1><1 6="5-7 7-s" 3-2="s"></1><1 6="5-4 4-e" 3-2="e"></1><1 6="5-4 4-n" 3-2="n"></1><1 6="5-4 4-w" 3-2="w"></1><1 6="5-4 4-s" 3-2="s"></1><1 6="5-4 4-ne" 3-2="ne"></1><1 6="5-4 4-nw" 3-2="nw"></1><1 6="5-4 4-sw" 3-2="sw"></1><1 6="5-4 4-se" 3-2="se"></1></0></0>',"div,span,drag,data,point,cropper,class,line,dashed,box"),d.other=e.fn.cropper,e.fn.cropper=function(t){var a,r=i(arguments,1);return this.each(function(){var n,i=e(this),s=i.data("cropper");s||i.data("cropper",s=new d(this,t)),"string"==typeof t&&e.isFunction(n=s[t])&&(a=n.apply(s,r))}),n(a)?this:a},e.fn.cropper.Constructor=d,e.fn.cropper.setDefaults=d.setDefaults,e.fn.cropper.noConflict=function(){return e.fn.cropper=d.other,this}}),define("module/contact/pab/service",["require","jquery.iframeTransport","jquery","util/index","module/contact/service","module/common/globalService"],function(e){function t(e){var t=b.Deferred();return e.isCreate="boolean"===b.type(e.isCreate)?e.isCreate:!1,e.isCreate?(t.resolve({}),t.promise()):(y.getPabAttrs(e.ids).then(function(e){e=y.filterPabContacts(e),t.resolve(e[0])}),t.promise())}function n(e){var t=b.Deferred();return _.xhr.simpleCall({contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:_.xhr.getRequestURL({url:"/XT5/jsp/contact.jsp",query:{func:"pab:deleteGroup",sid:w.getSid()}}),data:"groupid="+e,onlyVar:!1},function(){t.resolve()}),t.promise()}function i(e){var t=b.Deferred();return _.xhr.simpleCall({contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:_.xhr.getRequestURL({url:"/XT5/jsp/contact.jsp",query:{func:"pab:cleanGroup",sid:w.getSid()}}),data:"groupid="+e,onlyVar:!1},function(){t.resolve()}),t.promise()}function a(e,t){var n=b.Deferred();return _.xhr.simpleCall({contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:_.xhr.getRequestURL({url:"/XT5/jsp/contact.jsp",query:{func:"pab:renameGroup",sid:w.getSid()}}),data:"groupid="+e+"&groupname="+t,onlyVar:!1},function(){n.resolve()}),n.promise()}function r(e){var t=b.Deferred(),n={};return y.getAllPabContacts({groups:e.groups,returnAttrs:["id","FN","EMAIL;PREF"]}).then(function(e){e=e||[],b.each(e,function(e,t){t.emailaddr=t["EMAIL;PREF"]}),n.contacts=e,t.resolve(n)}),t.promise()}function s(e){var t=b.Deferred();return _.xhr.simpleCall({contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:_.xhr.getRequestURL({url:"/XT5/jsp/contact.jsp",query:{func:"pab:addToGroup",sid:w.getSid()}}),data:b.param(e),onlyVar:!1},function(){t.resolve()}),t.promise()}function o(e){var t=b.Deferred();return _.xhr.simpleCall({contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:_.xhr.getRequestURL({url:"/XT5/jsp/contact.jsp",query:{func:"pab:moveToGroup",sid:w.getSid()}}),data:b.param(e),onlyVar:!1},function(){t.resolve()}),t.promise()}function l(e){var t=b.Deferred();return _.xhr.simpleCall({query:{func:"pab:getContactKeys",sid:w.getSid()},data:e},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}function c(e){var t,n,i,a=b.Deferred(),r=_.detector.supportAjaxUpload();return t={url:_.xhr.getFullRequestURL({url:"/XT5/jsp/mformdata.jsp",query:{func:"pab:addContactKeyStd",sid:w.getSid()}}),type:"post",processData:!1,contentType:!1},r?(n=new FormData,n.append("publicKeyFile",e[0].files[0]),t.data=n):(t.files=e,t.useiframe=!0),b.ajax(t).complete(function(e){i=JSON.parse(e.responseText),a.resolve(i)}).fail(function(){a.reject()}),a.promise()}function d(e){var t=b.Deferred();return _.xhr.simpleCall({query:{func:"pab:saveContactKey",sid:w.getSid()},data:e},function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()}function u(e){var t=b.Deferred();return _.xhr.simpleCall({query:{func:"pab:deleteContactKey",sid:w.getSid()},data:e},function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()}function p(e){var t=b.Deferred();return _.xhr.simpleCall({query:{func:"pab:setContactDefaultKey",sid:w.getSid()},data:e},function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()}function m(e){var t=b.Deferred();return _.xhr.simpleCall({query:{func:"pab:getContactSingleKeyContent",sid:w.getSid()},data:e},function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()}function h(e){var t=b.Deferred();return _.xhr.simpleCall({query:{func:"pab:deleteContacts",sid:w.getSid()},data:{ids:e||[]}},function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()}function f(e){var t=b.Deferred();return _.xhr.simpleCall({query:{func:"pab:updateAllGroups",sid:w.getSid()},data:e},function(){t.resolve()},function(){t.reject()}),t.promise()}function v(e,t){var n=b.Deferred(),i={};return b.extend(i,{url:_.xhr.getFullRequestURL({url:"/XT5/jsp/mformdata.jsp",query:{func:"pab:importContacts",sid:w.getSid()}}),type:"post",processData:!1,contentType:!1,useiframe:!0,files:t,data:e}),b.ajax(i).complete(function(e){n.resolve(window.JSON.parse(e.responseText))}).fail(function(){n.reject()}),n.promise()}function g(e){var t=b.Deferred();return e.imgData?_.xhr.simpleCall({query:{func:"pab:addContactAvatar",sid:w.getSid()},data:e,onlyVar:!1,preprocess:!1},function(e){t.resolve(e)},function(){t.reject()}):b.ajax({url:_.xhr.getFullRequestURL({url:"/XT5/jsp/mformdata.jsp",query:{func:"pab:addContactAvatarStd",sid:w.getSid(),uid:e.uid}}),type:"post",files:e.file,iframe:!0,contentType:!1}).complete(function(e){t.resolve(window.JSON.parse(e.responseText))}).fail(function(){t.reject()}),t.promise()}e("jquery.iframeTransport");var b=e("jquery"),_=e("util/index"),y=e("module/contact/service"),w=e("module/common/globalService");return{executeCreateOrEditContact:t,deleteGroup:n,cleanGroup:i,renameGroup:a,executeEditGroup:r,addToGroup:s,moveToGroup:o,importContacts:v,updateAllGroups:f,deleteContacts:h,addContactAvatar:g,getContactKeys:l,saveContactKey:d,deleteContactKey:u,setContactDefaultKey:p,addContactKeyStd:c,getContactSingleKeyContent:m}}),define("components/requirejs-text/text!template/module/contact/pabContact.tpl.html",[],function(){return'<section class="m-ctpab">\r\n\r\n  <div class="main-wrapper">\r\n    <div class="content-wrapper">\r\n\r\n      <!--  -->\r\n      <section class="content content-list">\r\n        <header class="toolbar">\r\n          <div>\r\n            <div class="u-btns j-doMore">\r\n              <button class="u-btn u-btn-default">\r\n                {{i18n "contact/op_more"}}\r\n                <i class="iconfont icondown"></i>\r\n              </button>\r\n              <ul class="u-menu u-menu-hidden">\r\n              </ul>\r\n            </div>\r\n          <button class="u-btn u-btn-default" data-operation="showSearchList">\r\n            <i class="iconfont iconsreachm"></i>\r\n          </button>\r\n            <div id="pagination" class="u-btns f-fr">\r\n            </div>\r\n          </div>\r\n        </header>\r\n        <div class="deptInfo"></div>\r\n        <div class="u-list u-scroll u-list-up">\r\n          <table class="u-table u-table-assign u-table-row">\r\n            <thead></thead>\r\n            <tbody></tbody>\r\n          </table>\r\n        </div>\r\n      </section>\r\n\r\n      <!--  -->\r\n      <section class="content content-searchlist" id="searchViewContainer"></section>\r\n\r\n      <!--  -->\r\n      <section class="content content-grpManage">\r\n        <header class="toolbar">\r\n          <span class="u-btn u-btn-default" data-operation="goBack">\r\n            {{i18n "oab/act_search_back"}}\r\n          </span>\r\n        </header>\r\n        <div class="grpsInfo">\r\n          <b>{{i18n "contact/lbl_manageGroup"}}</b>\r\n          <label class="info"></label>\r\n        </div>\r\n        <div class="grpList u-scroll"></div>\r\n      </section>\r\n\r\n    </div>\r\n\r\n    <!--  -->\r\n    <section class="panel pab-panel">\r\n      <!--   -->\r\n      <header class="toolbar pab-toolbar">\r\n\r\n        <div class="toolbar-wrapper">\r\n          <!-- / -->\r\n          <div class="mixins">\r\n\r\n            <span class="u-btns u-btns-mr" id="more">\r\n              <button class="u-btn u-btn-default">{{i18n "contact/op_more"}}<i class="iconfont icondown"></i></button>\r\n              <ul class="u-menu u-menu-hidden">\r\n                <li class="u-submenu" id="addToGroup" role="submenu">\r\n                  <a href="javascript:void(0)">{{i18n "main/paboptjointo"}}<i class="iconfont iconright"></i></a>\r\n                  <ul class="u-menu u-menu-hidden"></ul>\r\n                </li>\r\n                <li class="u-submenu" id="moveToGroup" role="submenu">\r\n                  <a href="javascript:void(0)">{{i18n "main/paboptmoveto"}}<i class="iconfont iconright"></i></a>\r\n                  <ul class="u-menu u-menu-hidden"></ul>\r\n                </li>\r\n                <li data-action="listMails"><a href="javascript:void(0)">{{i18n "pab/c_listmail"}}</a></li>\r\n                <li data-action="print"><a href="javascript:void(0)">{{i18n "contact/op_print"}}</a></li>\r\n                <li data-action="deleteContacts"><a href="javascript:void(0)">{{i18n "pab/c_btn_remove"}}</a></li>\r\n              </ul>\r\n            </span>\r\n\r\n            <div class="u-btns j-pab-switch-menu btns-list f-fr">\r\n              <button class="u-btn u-btn-default">\r\n                <i class="iconfont iconblock"></i>\r\n              </button>\r\n              <button class="u-btn u-btn-default">\r\n                <i class="iconfont iconlist"></i>\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          <!--  -->\r\n          <div class="edit">\r\n            <button class="u-btn u-btn-primary" data-action="saveContact">{{i18n "contact/op_save"}}</button>\r\n            <button class="u-btn u-btn-default" data-operation="closeContact">{{i18n "contact/op_cancel"}}</button>\r\n          </div>\r\n\r\n          <!--  -->\r\n          <div class="import">\r\n            <button class="u-btn u-btn-primary" data-action="importContact">{{i18n "contact/op_import"}}</button>\r\n            <button class="u-btn u-btn-default" data-operation="closeImport">{{i18n "contact/op_cancel"}}</button>\r\n            <button class="u-btn u-btn-primary f-dn" data-operation="closeImport"><i class="iconfont iconright"></i>{{i18n "contact/op_collapse"}}</button>\r\n          </div>\r\n\r\n          <!--  -->\r\n          <div class="export">\r\n            <button class="u-btn u-btn-primary" data-action="exportContact">{{i18n "pab/c_export_btn_action"}}</button>\r\n            <button class="u-btn u-btn-default" data-operation="closeExport">{{i18n "contact/op_cancel"}}</button>\r\n          </div>\r\n\r\n          <!--  -->\r\n          <div class="gedit">\r\n            <button class="u-btn u-btn-primary" data-action="saveGroup">{{i18n "contact/op_confirm"}}</button>\r\n            <button class="u-btn u-btn-default" data-operation="closeGroup">{{i18n "contact/op_cancel"}}</button>\r\n          </div>\r\n\r\n          <!--  -->\r\n          <div class="glist">\r\n            <button class="u-btn u-btn-primary" data-operation="closeGroupList"><i class="iconfont iconright"></i>{{i18n "contact/op_collapse"}}</button>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <div class="panel-content pab-panel-content u-scroll u-scroll-wrapper">\r\n        <!--  -->\r\n        <div class="list j-pab-panel-list">\r\n          <div class="thumbview">\r\n            <div class="list-wrapper">\r\n              <ul>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n          <div class="listview">\r\n            <table class="u-table u-table-assign2">\r\n              <tbody></tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n\r\n        <!--  -->\r\n        <div class="detail">\r\n          <div class="detailview"></div>\r\n        </div>\r\n\r\n        <!---->\r\n        <div class="edit" id="newContactContainer"></div>\r\n\r\n        <!--  -->\r\n        <div class="import">\r\n          <form action="#" name="importContactsForm" id="importContactsForm"></form>\r\n          <div id="importResultContainer" class="f-dn"></div>\r\n        </div>\r\n\r\n        <!--  -->\r\n        <div class="export">\r\n          <iframe id="exportIframe" style="display:none"></iframe><!-- iframe -->\r\n\r\n          <form action="#" name="exportContactsForm">\r\n            <input type="hidden" name="func" value="pab:exportContacts"/>\r\n            <div class="form-header">\r\n              <h3>{{i18n "contact/lbl_export"}}</h3>\r\n            </div>\r\n            <div class="form-body">\r\n              <div class="form-item">\r\n                <label class="label">{{i18n "contact/lbl_exportFormat"}}</label>\r\n                <div class="input">\r\n                  <input type="radio" id="toCsv" name="outformat" value="8" checked><label for="toCsv">{{i18n "pab/c_export_csv"}}</label>\r\n                </div>\r\n                <div class="input">\r\n                  <input type="radio" id="toVCard" name="outformat" value="10"><label for="toVCard">{{i18n "pab/c_export_vcard"}}</label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </form>\r\n        </div>\r\n\r\n        <!--  -->\r\n        <div class="gedit" id="newGroupContainer"></div>\r\n\r\n        <!--  -->\r\n        <div class="glist" id="groupsManagementContainer"></div>\r\n      </div>\r\n    </section>\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="listHeadTpl">\r\n    <tr>\r\n      <th class="firstTH"><span class="j-selectAll"><input type="checkbox" /></span></th>\r\n      [[#each fields]]\r\n        <th width="[[width]]" data-sort="[[id]]" class="[[#compare @index \'>\' \'1\']]hideForShrink[[/compare]]"><div class="f-ellipsis">[[label]]<i class="iconfont"/></div></th>\r\n      [[/each]]\r\n    </tr>\r\n  </script>\r\n  <script type="text/x-handlebars-template" id="listTpl">\r\n    <tr data-action="show" data-email="[[emailaddr]]" data-id="[[id]]">\r\n      <td class="firstTD"><input type="checkbox"  name="mid" value="[[emailaddr]]" data-id="[[id]]" data-groups="[[groups]]" data-uniqueid="[[id]]" data-name="[[name]]"></td>\r\n      [[#each fields]]\r\n        <td width="[[width]]" class="[[#compare @index \'>\' \'1\']]hideForShrink[[/compare]]"><div class="f-ellipsis" title="[[formatted value]]">[[formatted value]]</div></td>\r\n      [[/each]]\r\n    </tr>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="selectedContactListTpl">\r\n    <tr data-uniqueid="[[uniqueid]]" data-emailaddr="[[emailaddr]]" data-name="[[name]]">\r\n      <td class="firstTD"><span class="f-ellipsis">[[formatted name]]</span></td>\r\n      <td class="nth2TD"><span class="f-ellipsis">[[emailaddr]]</span></td>\r\n      <td class="lastTD"><a href="javascript:void(0)" data-operation="remove">{{i18n "contact/op_remove"}}</a></td>\r\n    </tr>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="selectedContactThumbTpl">\r\n    <li data-uniqueid="[[uniqueid]]">\r\n      <a class="del" href="javascript:void(0)" data-operation="remove"><i class="iconfont icontabclose"></i></a>\r\n      <div class="u-img u-img-thumbnails"><a href="javascript:void(0)"><img src alt="avatar"></a></div>\r\n      <p class="f-ellipsis">[[formatted name]]</p>\r\n    </li>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="groupItem">\r\n    <option value="[[id]]">[[formatted name]]</option>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="groupItem2">\r\n    <li data-action="[[#if isMtg]]moveToGroup[[^]]addToGroup[[/if]]" data-groupid="[[id]]"><a href="javascript:void(0)">[[formatted name]]</a></li>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="contactInfoTpl">\r\n    <div class="avatar">\r\n      <div class="u-img">\r\n        <a href="javascript:void(0)"><img src="[[avatar]]" alt="avatar"></a>\r\n      </div>\r\n      <div class="text">\r\n        [[#each basic]]\r\n        <div class="name [[#compare id \'==\' \'FN\']]bold[[/compare]]">\r\n          [[#compare id \'==\' \'groups\']]\r\n            [[#if value]]\r\n            <label class="label">[[label]]</label>\r\n            <div class="input-1" title="[[value]]">[[value]]</div>\r\n            [[/if]]\r\n          [[^]]\r\n          <label class="label">[[label]]</label>\r\n          <div class="input-1" title="[[formatted value]]">[[formatted value]]</div>\r\n          [[/compare]]\r\n        </div>\r\n        [[/each]]\r\n      </div>\r\n    </div>\r\n    <div class="infos">\r\n      <table class="u-table u-table-assign1">\r\n        <tbody>\r\n        <tr>\r\n          <td class="[[#if certs]]cert-label [[else]]f-tac[[/if]]">[[i18n \'contact/lbl_certificate\']]</td>\r\n          <td>[[#unless certs]][[i18n \'common/none\']] [[/unless]]</td>\r\n        </tr>\r\n        [[#if certs]]\r\n        <tr>\r\n          <td colspan="2">\r\n            <div class="cert-list details">\r\n              <ul>\r\n                [[#each certs]]\r\n                <li>\r\n                  <a href="#" class="[[#compare @index \'==\' \'0\']] cert-default [[else]] f-vh [[/compare]]">\r\n                    <i class="iconfont icontipsc"></i>\r\n                  </a>\r\n                  <span class="cert-addr">[[subjectDN.EMAILADDRESS]]</span>\r\n                  <span class="cert-opt f-dn">\r\n                    <a href="#" data-operation="downloadCert" data-index="[[@index]]"> <i class="iconfont icondownloadc" ></i></a>\r\n                  </span>\r\n                  [[#if status.isExpired]]\r\n                  <span class="cert-err cert-err-expired">[[i18n "contact/lbl_certExpired"]]</span>\r\n                  [[/if]]\r\n                  [[#if status.isUnmatched]]\r\n                  <span class="cert-err cert-err-addr">[[i18n "contact/lbl_certAddrNotMatch"]]</span>\r\n                  [[/if]]\r\n                </li>\r\n                [[/each]]\r\n              </ul>\r\n            </div>\r\n          </td>\r\n        </tr>\r\n        [[/if]]\r\n        [[#each extra]]\r\n        <tr>\r\n          <td class="f-tac">[[label]]</td><td title="[[formatted value]]">[[formatted value]]</td>\r\n        </tr>\r\n        [[/each]]\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="newContact">\r\n    <form name="contactInfo" action="#" enctype="multipart/form-data" id="contactInfo" >\r\n      <input type="hidden" name="action" value="[[action]]">\r\n      <input type="hidden" name="id" value="[[id]]">\r\n      <!--TODO:  -->\r\n      <input type="hidden" name="deleteOldVcardKey" value="false">\r\n      <input type="hidden" name="hashId">\r\n      <input type="hidden" name="certHashId" value="">\r\n      <div class="form-item-block">\r\n        <div class="block-name">\r\n          <span>{{i18n "contact/lbl_avatarModify"}}</span>\r\n        </div>\r\n        <div class="form-item">\r\n          <a class="u-img">\r\n            <img src="[[avatar]]" alt="avatar" class="j-avatar"/>\r\n          </a>\r\n          <div class="u-img-text">\r\n            <a href="javascript:void(0)" data-operation="modifyAvatar">{{i18n "contact/lbl_avatarModify"}}</a>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      [[#each attrs]]\r\n\r\n      [[#compare blockId \'==\' \'opt\']]\r\n      <div class="j-cert-import"></div>\r\n      [[/compare]]\r\n\r\n      <div class="form-item-block">\r\n        <div class="block-name">\r\n          <span>[[blockName]]</span>\r\n        </div>\r\n        [[#compare blockId \'==\' \'grp\']]\r\n        <div class="form-item">\r\n          <label class="label">[[blockContent.label]]:</label>\r\n          [[#each blockContent.checkedGroups]]\r\n          <div class="input">\r\n            <input type="checkbox" name="groups[]" [[isChecked]] value="[[id]]" id="[[id]]">\r\n            <label for="[[id]]">[[name]]</label>\r\n          </div>\r\n          [[/each]]\r\n        </div>\r\n        [[^]]\r\n        [[#each blockContent]]\r\n        <div class="form-item">\r\n          <label class="label">[[label]]:</label>\r\n          <div class="input">\r\n            <input type="text" class="u-input [[#compare id \'==\' \'BDAY\']]j-pickDate[[/compare]]" value="[[value]]" name="[[id]]"/>\r\n            [[#compare id \'==\' \'FN\']]\r\n            <label class="required">**</label>\r\n            <label class="error f-dn"></label>\r\n            <p class="tip">{{i18n "contact/lbl_nameTip"}}</p>\r\n            [[/compare]]\r\n            [[#compare id \'==\' \'EMAIL;PREF\']]\r\n            <label class="icon-wrapper"><i class="iconfont iconadd" data-operation="addInput"></i></label>\r\n            <label class="error f-dn"></label>\r\n            [[/compare]]\r\n            [[#compare id \'==\' \'TEL;CELL;VOICE\']]\r\n            &nbsp;<label class="error f-dn"></label>\r\n            [[/compare]]\r\n            [[#contains id \'EMAIL;#\']]\r\n            <label class="icon-wrapper"><i class="iconfont iconremove" data-operation="removeInput"></i></label>\r\n            <label class="error f-dn"></label>\r\n            [[/contains]]\r\n          </div>\r\n        </div>\r\n        [[/each]]\r\n        [[/compare]]\r\n      </div>\r\n      [[/each]]\r\n    </form>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="addInputTpl">\r\n    <div class="form-item">\r\n      <label class="label">[[label]]:</label>\r\n      <div class="input">\r\n        <input type="text" class="u-input" name="[[id]]">\r\n        <label class="icon-wrapper"><i class="iconfont iconremove" data-operation="removeInput"></i></label>\r\n        <label class="error f-dn"></label>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="groupsManagement">\r\n    [[#each groups]]\r\n    <div class="list-item">\r\n      <span class="label">\r\n        <a href="javascript:void(0)" data-action="switchToGroup" data-groupid="[[id]]">[[formatted name]]</a>\r\n        [[#compare count \'!=\' 0]]\r\n        <label>[[count]]</label>\r\n        [[/compare]]\r\n      </span>\r\n      <div class="wrapper">\r\n        [[#compare reserved \'!=\' true]]\r\n        <a href="javascript:void(0)" data-action="renameGroup" data-groupid="[[id]]" data-groupname="[[name]]">[{{i18n "contact/op_renameGroup"}}]</a>\r\n        [[/compare]]\r\n        <a href="javascript:void(0)" data-action="[[#compare count \'==\' 0]][[^]]cleanUpGroup[[/compare]]" class="[[#compare count \'==\' 0]]disabled[[^]][[/compare]]" data-groupid="[[id]]" data-groupname="[[name]]">[{{i18n "main/act_empty"}}]</a>\r\n        <a href="javascript:void(0)" data-action="[[#compare count \'==\' 0]]deleteGroup[[^]][[/compare]]" class="[[#compare count \'==\' 0]][[^]]disabled[[/compare]]" data-groupid="[[id]]" data-groupname="[[name]]">[{{i18n "main/act_delete"}}]</a>\r\n      </div>\r\n    </div>\r\n    [[/each]]\r\n    <!--  -->\r\n    <div class="list-item">\r\n      <span class="label">\r\n        <a href="javascript:void(0)" data-action="switchToGroup" data-groupid="OTHER">{{i18n "main/addrgrp_other"}}</a>\r\n        [[#compare noGroupContactsCount \'!=\' 0]]\r\n        <label>[[noGroupContactsCount]]</label>\r\n        [[/compare]]\r\n      </span>\r\n      <div class="wrapper">&nbsp;</div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="newGroup">\r\n    <div class="form-item form-item-4">\r\n      <span class="panelName">[[#if isCreate]]{{i18n "contact/lbl_addGrp"}}[[^]]{{i18n "contact/lbl_editGrp"}}[[/if]]</span>\r\n    </div>\r\n    <form name="newGroupInfo" action="#" onsubmit="return false">\r\n      <input type="hidden" name="func" value="[[#if isCreate]]create[[^]]edit[[/if]]">\r\n      <input type="hidden" value="[[id]]" name="gid"/>\r\n      <div class="form-item form-item-3">\r\n        <label class="label">{{i18n "pab/c_new_name"}}</label>\r\n        <div class="input">\r\n          [[#if isReversed]]\r\n          <span>[[name]]</span>\r\n          <input type="hidden" value="[[name]]" name="name"/>\r\n          [[^]]\r\n          <input type="text" class="u-input" name="name" value="[[name]]"/>\r\n          <label class="required">{{i18n "pab/c_new_need"}}</label>\r\n          [[/if]]\r\n          <input type="hidden" value="[[name]]" name="originalName"/>\r\n          <p class="tip error f-dn">{{i18n "contact/lbl_emptyGroupNameErr"}}</p>\r\n        </div>\r\n      </div>\r\n      <div class="form-item form-item-4">\r\n        <span class="panelName">[[#if isCreate]]{{i18n "contact/lbl_addGroupMember"}}[[^]]{{i18n "contact/lbl_updateGroupMember"}}[[/if]]</span>\r\n      </div>\r\n      <div class="form-item addrContainer u-scroll" id="addrContainer"></div>\r\n      <div class="form-item">\r\n        <p><a href="javascript:void(0)" data-action="addFromContact">{{i18n "contact/op_addFromContact"}}</a></p>\r\n      </div>\r\n    </form>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="addrTpl">\r\n    <div class="j-contactItem">\r\n      <input type="hidden" value="[[id]]" data-name="[[name]]" data-addr="[[addr]]" data-isoab="[[isOab]]"/>\r\n      <div class="nWrapper"><span class="f-ellipsis">[[formatted name]]</span></div>\r\n      <div class="addrWrapper"><span class="f-ellipsis">[[addr]]</span></div>\r\n      <div class="opWrapper"><a href="javascript:void(0)" data-operation="removeFromGroup">{{i18n "contact/op_remove"}}</a></div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="renameGroupTpl">\r\n    <div><label>{{i18n "pab/input_newname"}}</label><input type="text" id="newGroupName" value="[[name]]"/></div>\r\n    <div id="errMsg" class="f-dn u-alert u-alert-error"><i class="iconfont iconinformation"></i><label></label></div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="avatarContainer">\r\n    <div class="u-avatar-dialog">\r\n      <form>\r\n        <div class="avt-tips">{{i18n "contact/lbl_uploadAvatarTips"}}</div>\r\n        <div class="avt-content">\r\n          <div class="cnt-cropper j-wrapper">\r\n          </div>\r\n          <div class="cnt-preview">\r\n            <div class="u-btn u-btn-primary">\r\n              <span>{{i18n "contact/lbl_selectLocalImage"}}</span>\r\n              <input type="file" id="avatarInput" name="signImgFile" class="avt-upload"/>\r\n            </div>\r\n            <div class="avt-preview j-preview">\r\n              <img alt="avatar" src="[[avatar]]"/>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class="avt-size">\r\n          {{i18n "contact/lbl_uploadAvatarButtonTips"}}\r\n        </div>\r\n      </form>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="importResultTpl">\r\n    <div class="form-item form-item-4">\r\n      <span class="panelName">{{i18n "pab/ok_import"}}</span>\r\n    </div>\r\n    <div class="form-item">\r\n      <label class="label label-1">{{i18n "pab/c_import_prevcnt"}}</label>\r\n      <div class="input">\r\n        <label>[[prevcnt]]</label>\r\n      </div>\r\n    </div>\r\n    <div class="form-item">\r\n      <label class="label label-1">{{i18n "pab/c_import_dupicate"}}</label>\r\n      <div class="input">\r\n        <label>[[existcnt]]</label>\r\n      </div>\r\n    </div>\r\n    <div class="form-item">\r\n      <label class="label label-1">{{i18n "pab/c_import_replace"}}</label>\r\n      <div class="input">\r\n        <label>[[replacedcnt]]</label>\r\n      </div>\r\n    </div>\r\n    <div class="form-item">\r\n      <label class="label label-1">{{i18n "pab/c_import_new"}}</label>\r\n      <div class="input">\r\n        <label>[[addedcnt]]</label>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="importContactsFormTpl">\r\n    <input type="hidden" name="informat" id="informat" value />\r\n    <div class="form-header">\r\n      <h3>{{i18n "pab/c_import"}}</h3>\r\n    </div>\r\n    <div class="form-body">\r\n      <div class="form-item">\r\n        <label class="label label-1">{{i18n "contact/lbl_fileChoose"}}</label>\r\n        <div class="input">\r\n          <div class="u-btn u-btn-primary fileSelector">\r\n            <span>{{i18n "contact/lbl_fileChoose"}}</span>\r\n            <input type="file" id="fileChoose" name="files">\r\n          </div>\r\n          <p class="tip f-ib">{{i18n "contact/lbl_fileTypeLimit"}}<a href="csv/example.csv">{{i18n "contact/lbl_downloadCsvTemplate"}}</a></p>\r\n          <div class="f-dn" id="fileName"></div>\r\n        </div>\r\n      </div>\r\n      <div class="form-item">\r\n        <label class="label label-1">{{i18n "pab/c_import_toGroup"}}</label>\r\n        <div class="input">\r\n          <select id="importToGroup" name="group">\r\n            <option value>{{i18n "pab/c_default_group"}}</option>\r\n          </select>\r\n        </div>\r\n      </div>\r\n      <div class="form-item">\r\n        <label class="label label-1">{{i18n "pab/c_import_dupicate"}}</label>\r\n        <div class="input">\r\n          <p class="radio-wrapper">\r\n            <input type="radio" id="cover" name="importmode" value="0" checked><label for="cover">{{i18n "pab/c_import_overwrite"}}</label>\r\n          </p>\r\n          <p class="radio-wrapper">\r\n            <input type="radio" id="notExport" name="importmode" value="1" class="f-mr40"><label for="notExport">{{i18n "pab/c_import_skip"}}</label>\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="contactsEmptyTpl">\r\n    <tr><td colspan="[[colspan]]">{{i18n "oab/no_user"}}</td></tr>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="searchViewTpl">\r\n    <header class="toolbar">\r\n        <span class="u-btn u-btn-default" data-operation="showList">\r\n          {{i18n "oab/act_search_back"}}\r\n        </span>\r\n      <div class="u-input-control u-input-control-1 left">\r\n        <span class="iconfont iconsreachm"></span>\r\n        <input type="text" class="u-input u-input-1" id="pabSearchInput" placeholder=\'{{i18n "contact/lbl_quickSearchContacts"}}\'>\r\n        <span class="iconfont iconenter rightSide" data-action="startSearch"></span>\r\n      </div>\r\n      <div id="pagination1" class="u-btns f-fr"></div>\r\n      <div class="searchResult">\r\n        <label>{{i18n "pab/c_search_result"}}</label><label class="f-dn"></label>\r\n      </div>\r\n    </header>\r\n    <div class="searchlist u-scroll">\r\n      <table class="u-table u-table-assign u-table-row">\r\n        <thead></thead>\r\n        <tbody></tbody>\r\n      </table>\r\n      <div class="j-searchHint">{{i18n "contact/lbl_pabSearchTips"}}</div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="toolbarTpl">\r\n    <button class="u-btn u-btn-primary btn-detail" data-operation="closeDetails" id="collapse"><i class="iconfont iconright"></i>{{i18n "contact/op_collapse"}}</button>\r\n    <button class="u-btn u-btn-default btn-list" data-operation="removeAll" id="removeAll">{{i18n "contact/op_removeAll"}}</button>\r\n    [[#if enableSendMail]]\r\n    <button class="u-btn u-btn-default" data-action="goCompose">{{i18n "oab/act_compose"}}</button>\r\n    [[/if]]\r\n    <button class="u-btn u-btn-default" data-action="editContact">{{i18n "contact/op_edit"}}</button>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="dropdownTpl">\r\n    <li data-panel="edit"><a href="javascript:void(0)">{{i18n "contact/lbl_addContact"}}</a></li>\r\n    <li data-panel="gedit"><a href="javascript:void(0)">{{i18n "contact/lbl_editCurrentGroup"}}</a></li>\r\n    <li data-panel="import"><a href="javascript:void(0)">{{i18n "contact/lbl_import"}}</a></li>\r\n    <li data-panel="export"><a href="javascript:void(0)">{{i18n "contact/lbl_export"}}</a></li>\r\n    <li data-panel="glist"><a href="javascript:void(0)">{{i18n "contact/lbl_manageGroup"}}</a></li>\r\n    [[#if enableSendMail]]\r\n    <li data-panel="gcompose"><a href="javascript:void(0)">{{i18n "pab/c_link_sendToThisGrp"}}</a></li>\r\n    [[/if]]\r\n  </script>\r\n  <script type="text/x-handlebar-template" id="importCertTpl">\r\n    <div class="form-item-block">\r\n      <div class="block-name">\r\n        <span>[[i18n \'contact/op_importCert\']]</span>\r\n      </div>\r\n      <div class="cert-notify">\r\n        <span>[[i18n \'contact/lbl_cert_desc\']]</span>\r\n        <div class="cert-upload">\r\n          <a href="#">\r\n            <span>[[i18n \'contact/op_importCert\']]</span>\r\n            <input type="file" id="certChoose" name="publicKeyFile" accept="application/pkix-cert" class="f-csp">\r\n          </a>\r\n        </div>\r\n      </div>\r\n      <div class="cert-list [[#unless len]]cert-list-empty[[/unless]]">\r\n        [[#unless len]]\r\n          <span class="cert-import">[[i18n \'contact/lbl_importCertText\']]</span>\r\n        [[/unless]]\r\n        <ul>\r\n        [[#each certs]]\r\n          <li>\r\n            <a href="#" data-operation="setCertAsDefault" data-index="[[@index]]" class="[[#compare @index \'==\' \'0\']] cert-default [[else ]] f-vh [[/compare]] default-setter">\r\n              <i class="iconfont icontipsc"></i>\r\n            </a>\r\n            <span class="cert-show">\r\n              <a href="#" data-operation="showCert" data-index="[[@index]]">[[subjectDN.EMAILADDRESS]]</a>\r\n            </span>\r\n            <span class="cert-opt f-dn">\r\n                <a href="#" data-operation="checkCert"    data-index="[[@index]]"> <i class="iconfont iconsreachm" ></i></a>\r\n                <a href="#" data-operation="downloadCert" data-index="[[@index]]"> <i class="iconfont icondownloadc" ></i></a>\r\n                <a href="#" data-operation="deleteCert"   data-index="[[@index]]" data-name="[[subjectDN.EMAILADDRESS]]"><i class="iconfont icondelc" ></i></a>\r\n             </span>\r\n            [[#if status.isExpired]]\r\n            <span class="cert-err cert-err-expired">[[i18n "contact/lbl_certExpired"]]</span>\r\n            [[/if]]\r\n            [[#if status.isUnmatched]]\r\n            <span class="cert-err cert-err-addr">[[i18n "contact/lbl_certAddrNotMatch"]]</span>\r\n            [[/if]]\r\n          </li>\r\n          [[/each]]\r\n        </ul>\r\n      </div>\r\n    </div>\r\n  </script>\r\n  <script type="text/x-handlebar-template" id="certListItem">\r\n    <li>\r\n      <a href="#" class="default-setter"><i class="iconfont icontipsc"></i></a>\r\n      <span class="f-mgl">[[subjectDN.EMAILADDRESS]]</span>\r\n    </li>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="certStatusTpl">\r\n     <div>\r\n       <label> [[i18n \'contact/lbl_certName\']]</label>\r\n       <div class="f-ib">[[subjectDN.EMAILADDRESS]]</div>\r\n     </div>\r\n     <div style="margin-top: 12px">\r\n       <label> [[i18n \'contact/lbl_certStatus\']]</label>\r\n       <div class="f-ib">\r\n         [[#or status.isUnmatched status.isExpired]]\r\n            [[#if status.isUnmatched]] [[i18n \'contact/msg_contactKeyNotMatch\']] [[/if]]\r\n            [[#if status.isExpired]] [[i18n \'contact/msg_contactKeyExpired\']] [[/if]]\r\n         [[else]]\r\n            [[i18n \'contact/msg_contactKeyIsVaild\']]\r\n         [[/or]]\r\n       </div>\r\n     </div>\r\n     [[#if query]]\r\n     <div style="margin-top: 12px">\r\n       [[i18n \'contact/msg_contactKeyAddQuery\']]\r\n     </div>\r\n     [[/if]]\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="certDetailsTpl">\r\n    <div>\r\n      <label> [[i18n \'contact/lbl_certStatus\']]</label>\r\n      <div class="f-ib">\r\n        [[#or status.isUnmatched status.isExpired]]\r\n        [[#if status.isUnmatched]] [[i18n \'contact/msg_contactKeyNotMatch\']] [[/if]]\r\n        [[#if status.isExpired]] [[i18n \'contact/msg_contactKeyExpired\']] [[/if]]\r\n        [[else]]\r\n        [[i18n \'contact/msg_contactKeyIsVaild\']]\r\n        [[/or]]\r\n      </div>\r\n    </div>\r\n    <div style="margin-top: 12px">\r\n      <label> [[i18n \'contact/lbl_certName\']]</label>\r\n      <div class="f-ib">[[subjectDN.EMAILADDRESS]]</div>\r\n    </div>\r\n    <div style="margin-top: 12px">\r\n      <label> [[i18n \'contact/lbl_certIssuer\']]</label>\r\n      <div class="f-ib">[[issuerDN.O]] [[issuerDN.ST]],[[issuerDN.L]]</div>\r\n    </div>\r\n    <div style="margin-top: 12px">\r\n      <label> [[i18n \'contact/lbl_certValidity\']]</label>\r\n      <div class="f-ib">[[formattedValidity notBefore notAfter]]</div>\r\n    </div>\r\n  </script>\r\n\r\n  {{/raw}}\r\n</section>\r\n';
}),define("module/contact/pab/index",["require","jquery.datepicker","jquery.imageCropper","component/contactdg","widget/pagination/pagination","util/i18n!common,contact,oab,pab","components/jquery-file-upload/js/jquery.fileupload","jquery","util/i18n","moment","util/index","cui/core/view/view","./service","util/messageformat","component/confirmbox","module/contact/service","cui/core/view/viewmanager","cui/ui/switchable/switchable","module/common/globalService","module/mail/service","cui/util/templatable/templatable","module/contact/grpNameValidate","text!template/module/contact/pabContact.tpl.html"],function(e){function t(e){var t=[];return e&&0!=a.trim(e).length||t.push({name:"FN",index:0,causes:"nameEmpty"}),t}function n(e){var t=[];return e.length>0&&!a.isNumeric(e)&&t.push({name:"TEL;CELL;VOICE",index:0,causes:"onlyNumber"}),t}function i(e,t){var n,i,r=[],s=[],l=t||[];return l.unshift(e||""),a.each(l,function(e,t){n=!0,t?1!=o.Email.parse(t).length?i="emailExceed":o.Email.test(t)?-1!=a.inArray(t,r)?i="emailDuplicate":n=!1:i="emailFormat":n=!1,n?s.push({name:0==e?"EMAIL;PREF":"EMAIL;#[]",index:0==e?e:e-1,causes:i}):t&&r.push(t)}),s}e("jquery.datepicker"),e("jquery.imageCropper"),e("component/contactdg"),e("widget/pagination/pagination"),e("util/i18n!common,contact,oab,pab"),e("components/jquery-file-upload/js/jquery.fileupload");var a=e("jquery"),r=e("util/i18n"),s=e("moment"),o=e("util/index"),l=e("cui/core/view/view"),c=e("./service"),d=e("util/messageformat"),u=e("component/confirmbox"),p=e("module/contact/service"),m=e("cui/core/view/viewmanager"),h=e("cui/ui/switchable/switchable"),f=e("module/common/globalService"),v=e("module/mail/service"),g=e("cui/util/templatable/templatable"),b=e("module/contact/grpNameValidate"),_=l.extend({Implements:g,events:{"click [data-action]":"_dispatchAction","click [data-operation]":"_dispatchOperation","click [data-sort]":"_doSortList","keydown #pabSearchInput":"_searchContact","change #avatarInput":"_uploadAvatar","change #certChoose":"_uploadCertFile"},setup:function(){this.state=f.getCurrentState(),this.cid=this.state.param.cid||"",this.limit=f.getConfig("contact.itemperpage")||20,this.displayFields=f.getConfig("contact.pab.normallistattrs"),this.schema=f.getConfig("contact.pab.schema"),this.viewFields=f.getConfig("contact.pab.viewattrs"),this.editFieldsBase=f.getConfig("contact.pab.editfieldsbase"),this.editFieldsOpt=f.getConfig("contact.pab.editfieldsopt"),this.editFieldsAdv=f.getConfig("contact.pab.editfieldsadv"),this._params={allIds:[],uniqueIds:[],isSearchView:!1,groups:{}}},render:function(){var e=this;_.superclass.render.call(e),e._renderContactList({groupid:e.cid,reload:!0,resetPage:!0}),e._getAllGroups(),e._initDropdownMenu(),e._initTabView(),e._enableGroupDeleteAndEdit(),e._initContactDialog(),e._initModuleEvent(),e._initExtraAction()},_displayList:function(e){var t=this,n=t.displayFields.split(" "),i=[];a.each(n,function(e,n){i.push({id:n,label:t.schema[n]})});var r=t.compile(t.$("#listHeadTpl").html(),{fields:i});t.$(".content:visible .u-table thead").html(r);var s=t.$(".content:visible .u-table tbody");if(0==e.length)s.html(t.compile(t.$("#contactsEmptyTpl").html(),{colspan:n.length+1}));else{for(var o=t.$("#listTpl").html(),l="",c=0;c<e.length;c++){var d=e[c];d.emailaddr=d["EMAIL;PREF"],d.name=d.FN;var u=[];a.each(n,function(e,t){u.push({value:d[t]})}),d.fields=u,l+=t.compile(o,d)}s.html(l);var p=[];t.$("div.listview .u-table tbody tr").each(function(){p.push({uniqueid:a(this).data("uniqueid")})}),t.trigger("simulateInputSelect",!1,!0,p)}t.trigger("customCheckbox")},_renderImportContactTpl:function(){var e=this,t=e.$("#importContactsFormTpl").html(),n=e.$(".panel .toolbar-wrapper .import");e.$("#importResultContainer").addClass("f-dn"),e.$("#importContactsForm").removeClass("f-dn").html(t),n.find("button:last").addClass("f-dn"),n.find("button:lt(2)").removeClass("f-dn"),e.element&&e.element.customRadioCheckbox(),e._initImportContact(),p.getAllPabGroups().then(function(t){var n=e.$("#groupItem").html(),i="";a.each(t,function(t,a){i+=e.compile(n,a)}),e.$("#importToGroup").append(i)})},_initPagination:function(e){var t=this;t.$("#pagination").pagination({total:e||t.result.length||1,limit:t.limit,round:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(e){var n={start:e*t.limit,groupid:t.cid};t.order&&(n=a.extend({order:t.order.field,desc:t.order.desc},n)),t._renderContactList(n)}})},_initSearchListPagination:function(e){var t=this;t.$("#pagination1").pagination({total:e||t.searchViewResult.length||1,limit:t.limit,round:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(e){t._renderContactList({start:e*t.limit,limit:t.limit})}})},_getAllGroups:function(){var e=this,t={};a.when(p.getAllPabGroups()).then(function(n){var i=e.$("#groupItem2").html(),r="",s="";a.each(n,function(n,a){t[a.id]=a,a.id!=e.cid&&(r+=e.compile(i,a),a.isMtg=!0,s+=e.compile(i,a))}),e._params.groups=t,e.$("#addToGroup ul").append(r),e.$("#moveToGroup ul").append(s)})},_initDropdownMenu:function(){var e=this,t=f.getConfig("mail.enablesendmail"),n=e.$("#toolbarTpl").html(),i=e.compile(n,{enableSendMail:t});e.$(".panel .mixins").prepend(i);var r=e.$("#dropdownTpl").html(),s=e.compile(r,{enableSendMail:t});e.$(".j-doMore ul").append(s),e.$("div.j-doMore").dropdown({chooseHtml:!1,callback:function(){var t=a(this).data("panel");switch(t){case"edit":e._editContact(!0);break;case"gedit":e._handleEditGroup({groupid:e.cid});break;case"glist":e._handleGroupsManage();break;case"import":e._renderImportContactTpl()}"gcompose"==t?e._handleComposeToGrpMember():"glist"==t?e._toggleContentView("grpManage"):e._switchPanel(t)}}),e.$("#more").dropdown({chooseHtml:!1,callback:function(){var t,n=a(this).data("action"),i=[],r=[],s=!1,o=e.$(".panel-content > div:visible");if(o.hasClass("list")){var l=e.$(".listview tbody tr");a.each(l,function(e,t){i.push(a(t).data("uniqueid").toString()),r.push(a(t).data("emailaddr").toString())}),s=!0}else if(o.hasClass("detail")){var c=e.$("div.detailview").data("info")||{};i.push(c.id),r.push(c["EMAIL;PREF"])}switch(n){case"addToGroup":t=a(this).data("groupid").toString(),e._handleAddToGroup(t,i,s);break;case"moveToGroup":t=a(this).data("groupid").toString(),e._handleMoveToGroup(t,e.cid,i,s);break;case"deleteContacts":e._handleDeleteContact(i,s);break;case"listMails":e.sendMessage("dispatcher","history:add",{module:"mail.search",param:{fromType:"pab",fromAddress:i.join(","),fromEmail:r.join(",")}});break;case"print":var d="contact.pabPrint",u="./detach.jsp?sid="+f.getSid()+"#"+d+"?ids="+i.join(",");window.open(u)}}})},_initTabView:function(){new h({element:"section.pab-panel",triggers:".j-pab-switch-menu > .u-btn",panels:"div.j-pab-panel-list > div",activeIndex:0,triggerType:"click",activeTriggerClass:"u-btn-active"})},_initContactDialog:function(){var e=this,t=e.$("#newGroupContainer");t.contactdg({trigger:'a[data-action="addFromContact"]',selectType:[{type:"contact"}],isDisplayOab:f.getConfig("contact.enableaddedfromoab")&&f.getConfig("user.supportoab"),onSelect:function(t){e.trigger("contactdg:updateGrpContacts",t.contact||[])},onClose:function(){}}),t.on("click",'a[data-action="addFromContact"]',function(){t.contactdg("show","contact",e._getcontacts())})},_initModuleEvent:function(){var e=this;e.on("contactdg:updateGrpContacts",function(t){var n="";a.each(t,function(t,i){i.isUser&&(n+=e.compile(e.$("#addrTpl").html(),i))}),e.$("#addrContainer").html(n)}),e.on("compose",function(t){var n=[];t.forEach(function(e){o.Email.test(e)&&(n[n.length]=e)}),v.getComposeInfo({ctype:"normal",to:n}).then(function(t){e.sendMessage("dispatcher","history:add",{module:"mail.compose",param:{id:t.id}})})}),e.onMessage("methodInvocation",function(t){var n=t.message&&t.message.method;switch(n){case"addGroup":e._handleCreateGroup();break;case"addContact":e._editContact(!0);break;case"mangeGroups":e.$('[data-panel="glist"]').trigger("click");break;case"refreshList":e._toggleContentView("-searchList","-grpManage"),e._renderContactList({groupid:e.cid,reload:!0,resetPage:!0});break;default:e._initExtraAction(),e._renderContactList({groupid:e.cid,reload:!0,resetPage:!0})}}),e.$("section.content").on("click","span.j-selectAll .checkbox",function(t){t.stopPropagation();var n=a(this).hasClass("checkbox-checked"),i=e._getEleData(n);e.trigger("inputSelect",!0,n,a(this).prev()),e.trigger("updateListItems",!1,n,i)}).on("click",".u-table tbody .checkbox",function(t){t.stopPropagation();var n=a(this).hasClass("checkbox-checked"),i=e._getEleData(n,a(this).prev());e.trigger("inputSelect",!1,n,a(this).prev()),e.trigger("updateListItems",!1,n,i)}),e.$("section.panel").on("focus",".j-pickDate",function(){a(this).datepicker({dateFormat:"yyyy-mm-dd",autoClose:!0})}).on("click","i.ckeckbox",function(){a(this).prev().prop("checked",a(this).hasClass("checkbox-checked"))}),e.on("inputSelect",function(t,n,i){t="boolean"===a.type(t)?t:!1,n="boolean"===a.type(n)?n:!1,i.prop("checked",n);var r=e.$("section.content:visible tbody :checkbox"),s=r.filter(":not(:checked)"),o=r.filter(":checked");if(t)n?(s.prop("checked",!0),s.next().addClass("checkbox-checked"),s.parents("tr").addClass("contact-selected")):(o.prop("checked",!1),o.next().removeClass("checkbox-checked"),o.parents("tr").removeClass("contact-selected"));else{i.parents("tr").toggleClass("contact-selected");var l=e.$("section.content span.j-selectAll .checkbox"),c=l.prev();0==s.length?(l.addClass("checkbox-checked"),c.prop("checked",!0)):(l.removeClass("checkbox-checked"),c.prop("checked",!1))}}),e.on("simulateInputSelect",function(t,n,i){t="boolean"===a.type(t)?t:!1,n="boolean"===a.type(n)?n:!1;var r,s,o,l;t?(r=e.$("section.content tbody :checkbox"),r.prop("checked",n),o=r.next(),l=r.parents("tr"),n?(o.addClass("checkbox-checked"),l.addClass("contact-selected")):(o.removeClass("checkbox-checked"),l.removeClass("contact-selected"))):(r=e.$("section.content tbody"),a.each(i,function(e,t){s=r.find('[data-uniqueid="'+t.uniqueid+'"]'),0!=s.length&&(o=s.next(),l=s.parents("tr"),s.prop("checked",n),n?(o.addClass("checkbox-checked"),l.addClass("contact-selected")):(o.removeClass("checkbox-checked"),l.removeClass("contact-selected")))})),e.$("section.content").each(function(){var e=a(this).find("span.j-selectAll :checkbox");0==a(this).find("tbody :checkbox:not(:checked)").length?(e.prop("checked",!0),e.next().addClass("checkbox-checked")):(e.prop("checked",!1),e.next().removeClass("checkbox-checked"))})}),e.on("updateListItems",function(t,n,i){t="boolean"===a.type(t)?t:!1,n="boolean"===a.type(n)?n:!1,n?(e._switchPanel("list"),e._appendSelectedList(i)):(e._removeSelectedList(t,i),0==e._params.uniqueIds.length&&e._switchPanel("-list"))}),e.on("customCheckbox",function(){e.element&&e.element.customRadioCheckbox()}),e.on("afterSaveGroup",function(){var e=this,t=e.$("div.content-wrapper");t.hasClass("toggled-searchList")||(t.hasClass("toggled-grpManage")?e._handleGroupsManage():e._renderContactList({groupid:e.cid,reload:!0}))}),e.on("inputChange",function(){e.$("#pabSearchInput").on("input propertychange",function(){e._handleSearchChange()})}),e.on("restoreInputError",function(){e.$("#contactInfo .error").html("").addClass("f-dn")}),e.on("showInputError",function(t){a.each(t,function(t,n){var i=o.i18n.t("contact/lbl_"+n.causes+"Error"),a='#contactInfo [name="'+n.name+'"]:eq('+n.index+")";e.$(a).siblings(".error").html(i).removeClass("f-dn")})})},_getEleData:function(e,t){var n=this;e="boolean"===a.type(e)?e:!1;var i=t,r=[];return i||(i=e?n.$("section.content:visible tbody :checkbox:not(:checked)"):n.$("section.content:visible tbody :checkbox:checked")),i.each(function(){r.push({uniqueid:a(this).data("uniqueid"),name:a(this).data("name"),emailaddr:a(this).val()})}),r},_initExtraAction:function(){var e=this,t=f.getCurrentState();if(t.param){var n=t.param.type;if(!n)return!1;e._switchPanel(n);var i="undefined"!==a.type(t.param.id)?t.param.id.toString():"";switch(n){case"detail":i&&e._getAndShowUserInfo([i]);break;case"edit":i&&e._editContact(!1,[i])}}},_initImportContact:function(){var e=this;this.$("#fileChoose").on("change",function(){e.$("#fileName").removeClass("f-dn").html(a(this).val())})},_searchContact:function(e,t){var n=this,i=a.trim(a(t).val());13==e.which&&(a(t).blur(),n._startSearchContact(i))},_handleSearchChange:function(){var e=a.trim(this.$("#pabSearchInput").val());e.length>0&&this.$("#pabSearchInput").parent().addClass("f-have-content")},_startSearchContact:function(e){var t=this;t.keyword=e,t._renderContactList({keyword:e,resetPage:!0,reload:!0})},_renderContactList:function(e){var t=this,n=e.resetPage;delete e.resetPage,t.$(".content-wrapper .content:visible").mask(),a.when(p.searchPabContacts(e)).then(function(e,i,a){t._params.isSearchView?(t.searchViewResult=e,t.$(".j-searchHint").remove(),n&&(t._initSearchListPagination(i),t.$(".searchResult label:eq(1)").removeClass("f-dn").html(""+i+""))):(t.result=e,n&&t._initPagination(i),a||(""==t.cid?a=o.i18n.t("contact/gp_all"):"OTHER"==t.cid&&(a=o.i18n.t("contact.gp_other"))),t.$("div.deptInfo").html(d.format(o.i18n.t("contact/lbl_deptInfo2"),[o.html.encode(a),i]))),t._displayList(e)}).always(function(){setTimeout(function(){t.$(".content-wrapper .content:visible").mask("hide"),t._params.isSearchView&&t.$("#pabSearchInput").focus()},300)})},_dispatchAction:function(e,t){var n=this,i=a(t).data("action");switch(i){case"editContact":n._editContact();break;case"saveContact":n._saveContact();break;case"createContact":n._editContact(!0);break;case"exportContact":n._exportContacts();break;case"importContact":n._importContacts();break;case"show":n._switchPanel("detail"),n._getAndShowUserInfo([a(t).data("id").toString()]);break;case"deleteGroup":u.confirm(d.format(o.i18n.t("pab/confirm_del"),o.html.encode(""+a(t).data("groupname"))),function(){n._handleDeleteGroup(a(t).data("groupid").toString())},a.noop(),{parentNode:".content:visible"});break;case"cleanUpGroup":u.confirm(d.format(o.i18n.t("pab/confirm_clean"),o.html.encode(a(t).data("groupname"))),function(){n._handleCleanUpGroup(a(t).data("groupid").toString())},a.noop(),{parentNode:".content:visible"});break;case"renameGroup":n._handleRenameGroup(t);break;case"saveGroup":n._handleSaveGroup();break;case"switchToGroup":n._toggleContentView("-searchList","-grpManage"),n._renderContactList({groupid:a(t).data("groupid").toString(),resetPage:!0});break;case"startSearch":n._startSearchContact(a.trim(a(t).prev().val()));break;case"goCompose":var r=[],s=n.$(".panel-content > div:visible");if(s.hasClass("list"))a.each(n.$(".listview tbody tr"),function(e,t){var n,i=a(t).data("name"),s=a(t).data("emailaddr");n=i?i+" <"+s+">":s,r.push(n)});else if(s.hasClass("detail")){var l="",c=n.$("div.detailview").data("info")||{};l=c.FN?c.FN+" <"+c["EMAIL;PREF"]+">":c["EMAIL;PREF"],r.push(l)}n.trigger("compose",r)}},_dispatchOperation:function(e,t){var n=this,i=a(t).data("operation");switch(i){case"remove":var r=a(t).parents("[data-uniqueid]"),s=[{uniqueid:r.data("uniqueid")}];n.trigger("updateListItems",!1,!1,s),n.trigger("simulateInputSelect",!1,!1,s);break;case"removeAll":n.trigger("updateListItems",!0,!1,s),n.trigger("simulateInputSelect",!0,!1);break;case"showSearchList":n._params.isSearchView=!0,n._toggleContentView("searchList"),n.$("#searchViewContainer").html(n.$("#searchViewTpl").html()),setTimeout(function(){n.$("#pabSearchInput").focus(),n.trigger("inputChange")},100);break;case"showList":n._params.isSearchView=!1,n._toggleContentView("-searchList");break;case"closeDetails":n._switchPanel("-detail");break;case"closeContact":var o=n.$(".panel-content .listview tbody tr");if(0==o.length){var l=n.$('[name="contactInfo"] [name="action"]').val();if("edit"==l){var c=n.$('[name="contactInfo"] [name="id"]').val();n._switchPanel("detail"),n._getAndShowUserInfo([c.toString()])}else n._switchPanel("-edit")}else n._switchPanel("-edit");break;case"closeImport":n._switchPanel("-import");break;case"closeExport":n._switchPanel("-export");break;case"closeGroup":n._switchPanel("-gedit");break;case"goBack":n._toggleContentView("-grpManage");break;case"edit":n._switchPanel("detail"),n._editContact();break;case"removeFromGroup":a(t).parents(".j-contactItem").remove();break;case"cleanUpText":a(t).addClass("f-dn"),a(t).prev("input").val("");break;case"modifyAvatar":n._handleModifyAvatar();break;case"addInput":var d=n.compile(n.$("#addInputTpl").html(),{id:"EMAIL;#[]",label:n.schema["EMAIL;PREF"]});a(t).closest(".form-item-block").append(d);break;case"removeInput":a(t).closest(".form-item").remove();break;case"setCertAsDefault":n._handleSetCertAsDefault(t);break;case"deleteCert":n._handleDeleteCert(t);break;case"showCertDetails":n._showCertDetails();break;case"downloadCert":n._handleDownloadCert(t);break;case"checkCert":n._handleCheckCert(t);break;case"showCert":n._handleShowCertDetail(t)}},_handleDeleteContact:function(e,t){var n=this;c.deleteContacts(e).then(function(){a.notify(o.i18n.t("contact/msg_delContactSuccessfully")),n._renderContactList({groupid:n.cid,reload:!0,resetPage:!0}),t?n.trigger("updateListItems",!0):n._switchPanel("-detail"),n.sendMessage("contact","refresh:pabTree");var e=n.$(".content:visible .j-selectAll .checkbox");e.removeClass("checkbox-checked"),e.prev().prop("checked",!1)},function(){a.notify(o.i18n.t("contact/msg_delContactFailErr"),{type:"error"})})},_toggleContentView:function(){if(0!=arguments.length){var e=this,t=e.$(".content-wrapper");-1==arguments[0].indexOf("-")?t.addClass("toggled-"+arguments[0]):t.removeClass("toggled"+arguments[0]),e._toggleContentView.apply(e,Array.prototype.slice.call(arguments,1))}},_getAndShowUserInfo:function(e){var t=this;t.$(".panel").mask(),a.when(p.getPabAttrs(e),p.getContactAvatar("pab",e[0]),c.getContactKeys({uid:e[0],requireContent:!0}),p.getAllPabGroups()).then(function(e,n,i,r){var s,o=e[0]||{},l=t.schema,c=t.viewFields.split(" "),d=[],u=[];a.each(c,function(e,t){switch(t){case"EMAIL;#":a.each(o,function(e,n){0==e.indexOf(t)&&d.push({label:l["EMAIL;PREF"],value:n})});break;case"FN":case"EMAIL;PREF":d.push({id:t,label:l[t],value:o[t]});break;case"groups":var n=[];a.each(o[t],function(e,t){a.each(r,function(e,i){return i.id===t?(n.push(i.name),!1):void 0})}),d.push({id:t,label:l[t],value:n});break;default:u.push({label:l[t],value:o[t]})}}),i&&(s=t._parseCertInfo(i,o["EMAIL;PREF"]));var p=t.compile(t.$("#contactInfoTpl").html(),{avatar:n[0].avatarUrl,basic:d,extra:u,certs:s});t.$("div.detailview").html(p).data("info",o)}).always(function(){setTimeout(function(){t.$(".panel").mask("hide")},300)})},_editContact:function(e,t){var n=this;e="boolean"===a.type(e)?e:!1;var i=[];if(!e)if("undefined"!==a.type(t))i=t;else{var r=n.$(".panel-content > div:visible");if(r.hasClass("list")){var s=n.$(".listview tbody tr");if(0==s.length)return u.alert(o.i18n.t("contact/msg_noOneToEdit")),!1;if(s.length>1)return u.alert(o.i18n.t("contact/msg_oneToEdit")),!1;a.each(s,function(e,t){i.push(a(t).data("uniqueid").toString())})}else if(r.hasClass("detail")){var l=n.$("div.detailview").data("info");i.push(l.id)}}n._switchPanel("edit"),a.when(c.executeCreateOrEditContact({isCreate:e,ids:i}),p.getContactAvatar("pab",i[0]||""),c.getContactKeys({uid:i[0]}),p.getAllPabGroups()).then(function(t,i,r,s){var l=n.editFieldsBase.split(" "),c=n.editFieldsOpt.split(" "),d=n.editFieldsAdv.split(" "),u=!1,p={};if((-1!=a.inArray("groups",l)||-1!=a.inArray("groups",c)||-1!=a.inArray("groups",d))&&(u=!0),e)a.each(s,function(e,t){t.name=t.name||o.i18n.t("common/none"),t.id==n.cid&&(t.isChecked="checked")}),p.action="create";else{var m=t.groups;a.each(s,function(e,t){t.name=t.name||o.i18n.t("common/none");for(var n=0;!0;n++){if(n==m.length){t.isChecked="";break}if(m[n]==t.id){t.isChecked="checked";break}}s[e]=t}),p.action="edit"}var h=[{blockId:"base",blockContent:[],blockName:o.i18n.t("contact/lbl_basic"),fields:l},{blockId:"opt",blockContent:[],blockName:o.i18n.t("contact/lbl_contact_info"),fields:c},{blockId:"adv",blockContent:[],blockName:o.i18n.t("contact/lbl_extraInfo"),fields:d}];a.each(h,function(e,i){a.each(i.fields,function(e,r){"EMAIL;#"===r?a.each(t,function(e,t){0==e.indexOf(r)&&i.blockContent.push({id:"EMAIL;#[]",label:n.schema["EMAIL;PREF"],value:t})}):"groups"!==r&&i.blockContent.push({id:r,label:n.schema[r],value:t[r]})})}),u&&h.splice(1,0,{blockId:"grp",blockContent:{label:n.schema.groups,checkedGroups:s},blockName:o.i18n.t("contact/lbl_group_info")}),p.avatar=i[0].avatarUrl,p.id=t.id,p.attrs=h;var f=n.compile(n.$("#newContact").html(),p);n.$("#newContactContainer").html(f).scrollTo(0,0);var v=n._parseCertInfo(r,t["EMAIL;PREF"]);f=n.compile(n.$("#importCertTpl").html(),{certs:v,len:r.length}),n.$(".j-cert-import").html(f).data("certs",v),n.element&&n.element.customRadioCheckbox()})},_handleSetCertAsDefault:function(e){var t=this,n=parseInt(a(e).data("index")),i=this.$("#contactInfo").find("[name=id]").val(),s=this.$("#contactInfo").find('[name="EMAIL;PREF"]').val();c.setContactDefaultKey({uid:i,keyIndex:n}).then(function(e){"S_OK"==e.code?c.getContactKeys({uid:i}).then(function(e){var n=t._parseCertInfo(e,s),i=t.compile(t.$("#importCertTpl").html(),{certs:n,len:e.length});t.$(".j-cert-import").data("certs",n).html(i),a.notify.success(r.t("contact/msg_setKeyAsDefaultSuccess"))}):a.notify.error(r.t("contact/msg_setKeyAsDefaultFail"))})},_handleDeleteCert:function(e){var t,n,i=parseInt(a(e).data("index")),s=a(e).data("name"),o=this.$("#contactInfo"),l=o.find("[name=id]").val(),p=o.find('[name="EMAIL;PREF"]').val(),m=this;u.confirm(d.format(r.t("contact/msg_deleteKeyConfirm"),[s]),function(){c.deleteContactKey({uid:l,keyIndex:i}).then(function(e){"S_OK"==e.code?c.getContactKeys({uid:l}).then(function(e){t=m._parseCertInfo(e,p),n=m.compile(m.$("#importCertTpl").html(),{certs:t,len:e.length}),m.$(".j-cert-import").data("certs",t).html(n),a.notify.success(r.t("contact/msg_deleteKeySuccess"))}):a.notify.error(r.t("contact/msg_deleteKeyFail"))})})},_handleDownloadCert:function(e){var t=parseInt(a(e).data("index")),n=this.$(".detailview").data("info").id;a(e).attr("href",o.xhr.getRequestURL({query:{func:"pab:downloadContactSingleKey",sid:f.getSid(),uid:n,keyIndex:t}}))},_handleCheckCert:function(e){var t=a(e).data("index"),n=this.$(".j-cert-import").data("certs"),i=this.compile(this.$("#certStatusTpl").html(),n[t]);u.confirm(i,function(){},a.noop(),{title:o.i18n.t("contact/lbl_checkCert")})},_saveContact:function(){var e=this,r=e.$('form[name="contactInfo"]').serializeJSON({parseBooleans:!0}),s=r.action,l=r["EMAIL;#"],c=t(r.FN),m=i(r["EMAIL;PREF"],l),h=n(r["TEL;CELL;VOICE"]),f=c.concat(m,h);return e.trigger("restoreInputError"),0!=f.length?(e.trigger("showInputError",f),!1):(r["EMAIL;#"]=l?l.join(","):"",void p.createOrEditPabContact(r).then(function(t){e._renderContactList({groupid:e.cid,resetPage:!0,reload:!0}),e._removeSelectedList(!0),e._switchPanel("-edit"),"edit"==s?a.notify(d.format(o.i18n.t("pab/ok_edit"),t.FN)):(a.notify(d.format(o.i18n.t("pab/ok_add"),t.FN)),e.sendMessage("contact","refresh:pabTree"))},function(e){u.alert(e)}))},_handleShowCertDetail:function(e){var t,n=a(e).data("index"),i=this.$(".j-cert-import").data("certs"),r=i[n];t=this.compile(this.$("#certDetailsTpl").html(),r),u.confirm(t,function(){},a.noop(),{title:o.i18n.t("contact/lbl_certDetails")})},_appendSelectedList:function(e){for(var t=this,n=t.$("#selectedContactListTpl").html(),i=t.$("#selectedContactThumbTpl").html(),r="",s="",o=[],l=0;!0&&l!=e.length;l++){var c=e[l];-1==a.inArray(c.uniqueid,t._params.uniqueIds)&&(t._params.uniqueIds.push(c.uniqueid),o.push(c.uniqueid),r+=t.compile(n,c),s+=t.compile(i,c))}t.$("div.thumbview ul").append(s),t.$("div.listview .u-table tbody").append(r),p.getContactAvatar("pab",o.join(" ")).then(function(e){a.each(e,function(e,n){t.$('div.thumbview [data-uniqueid="'+n.uid+'"] img').attr("src",n.avatarUrl)})})},_removeSelectedList:function(e,t){var n=this;e="boolean"===a.type(e)?e:!1,e?(n.$("div.listview tbody").empty(),n.$("div.thumbview ul").empty(),n._params.uniqueIds=[]):a.each(t,function(e,t){var i=t.uniqueid,r=a.inArray(i,n._params.uniqueIds);n._params.uniqueIds.splice(r,1),n.$("div.thumbview [data-uniqueid='"+i+"']").remove(),n.$("div.listview [data-uniqueid='"+i+"']").remove()})},_handleGroupsManage:function(){var e=this;p.getPabGroupsWithCount().then(function(t){var n=e.$("#groupsManagement").html(),i=d.format(o.i18n.t("contact/msg_groupSummary"),[t.groups.length,t.gcCount,f.getConfig("contact.pab.maxiaddresscount")]),a=e.compile(n,t);e.$("div.grpList").html(a),e.$("section.content-grpManage label.info").html(i)})},_handleDeleteGroup:function(e){var t=this;c.deleteGroup(e).then(function(){a.notify(o.i18n.t("pab/c_grp_delete")),t._handleGroupsManage(),t.sendMessage("contact","refresh:pabTree")})},_handleCleanUpGroup:function(e){var t=this;c.cleanGroup(e).then(function(){a.notify(o.i18n.t("pab/c_grp_clean")),t._handleGroupsManage(),t.sendMessage("contact","refresh:pabTree")})},_handleRenameGroup:function(e){var t=this,n=a(e).data("groupid").toString(),i=a(e).data("groupname"),r=t.compile(t.$("#renameGroupTpl").html(),{name:i});p.getAllPabGroups().then(function(s){u.confirm(r,a.noop(),a.noop(),{parentNode:".content:visible",onConfirm:function(){var r=t.$("#newGroupName").val(),l=b.validate(r,s,"update",i);return l.state?(c.renameGroup(n,r).then(function(){a(e).data("groupname",r),a(e).siblings().data("groupname",r),a(e).parents(".list-item").find(".label a").html(r),a.notify(o.i18n.t("pab/c_grp_rename")),t.sendMessage("contact","refresh:pabTree")}),void this.hide()):(t.$("#errMsg").removeClass("f-dn").find("label").html(l.errMsg),!1)}})})},_handleCreateGroup:function(){var e=this;e._switchPanel("gedit"),e._handleEditGroup({isCreate:!0})},_handleEditGroup:function(e){var t,n=this,i="boolean"==a.type(e.isCreate)?e.isCreate:!1,r=n.$("#newGroup").html();return i?(t=n.compile(r,e),n.$("#newGroupContainer").html(t),!1):void p.getAllPabContacts({groups:[e.groupid],returnAttrs:["id","FN","EMAIL;PREF"]}).then(function(s){s=s||[],a.each(s,function(e,t){t.addr=t["EMAIL;PREF"],t.name=t.FN,t.isOab=!1,t.isUser=!0,n._params.allIds.push(t.id)});var o={};i||(o.name=n._params.groups[e.groupid].name,o.id=e.groupid,o.name||(o.isRequired=!0),n._params.groups[e.groupid].reserved&&(o.isReversed=!0)),t=n.compile(r,o),n.$("#newGroupContainer").html(t),n.trigger("contactdg:updateGrpContacts",s)})},_handleSaveGroup:function(){var e=this,t=e.$('form[name="newGroupInfo"]').serializeJSON();p.getAllPabGroups().then(function(n){var i=e._getGrpAddAndUpdateIds(e.$("#addrContainer :hidden"));a.extend(t,{uidsForPab:i.addIds.pIds.join(" "),updateUids:i.updateIds.join(" "),uidsForOab:i.addIds.oIds.join(" ")});var r,s="edit"==t.func;return r=s?b.validate(t.name,n,"update",t.originalName):b.validate(t.name,n,"addnew"),r.state?void p.savePabGroup(t).then(function(t){s?a.notify(o.i18n.t("contact/msg_successfullyEditGrp")):a.notify(o.i18n.t("pab/c_grp_add")),e._switchPanel("-gedit"),e.needUpdateList=[],e.cid=t.id,e._params.groups[t.id]=a.extend(t,{isMtg:!0}),e.sendMessage("contact","refresh:pabTree"),e.trigger("afterSaveGroup")}):(u.alert(r.errMsg),!1)})},_handleAddToGroup:function(e,t,n){var i=this;c.addToGroup({gid:e,uid:t.join(" ")}).then(function(){n||i._getAndShowUserInfo(t),a.notify(o.i18n.t("pab/c_jointo_success")),i.sendMessage("contact","refresh:pabTree")})},_handleMoveToGroup:function(e,t,n,i){var r=this;c.moveToGroup({gid:e,fGid:t,uid:n.join(" ")}).then(function(){i||r._getAndShowUserInfo(n),a.notify(o.i18n.t("pab/c_moveto_success")),r.sendMessage("contact","refresh:pabTree"),r._renderContactList({groupid:r.cid,reload:!0,resetPage:!0})})},_handleModifyAvatar:function(){var e,t,n=this,i=n.$("img.j-avatar"),r=i.attr("src"),s=n.$('[name="contactInfo"] [name="id"]').val()||"-1",l=n.compile(a("#avatarContainer").html(),{avatar:r,sid:f.getSid(),uid:s});u.confirm(l,function(){var l=o.detector.supportBlobURL()&&o.detector.supportAjaxUpload();l?(e=a("div.j-wrapper > img").cropper("getCroppedCanvas",{width:132,height:132}),t=e.toDataURL("image/jpeg"),t.length>0&&r!==t&&c.addContactAvatar({uid:s,imgData:t}).then(function(e){var r=e["var"];"S_OK"===e.code?(a.notify(o.i18n.t("contact/msg_successfullySaveAvatar")),i.attr("src",t),r.hashId&&n.$('[name="contactInfo"] [name="hashId"]').val(r.hashId)):"FA_ATTR_SIZE_EXCEEDED"==e.code||"FA_FILE_SIZE_EXCEEDED"==e.code||"FA_OVERFLOW"==e.code?a.notify(o.i18n.t("error/"+e.code)):a.notify(o.i18n.t("common/FA_OTHER_CODE",{code:e.code}))})):i.attr("src",n.$("div.j-preview img").attr("src"))},a.noop(),{title:o.i18n.t("contact/lbl_uploadAvatarInit"),effect:"fade",parentNode:".content:visible"})},_uploadCertFile:function(){var e,t,n,i,r=this,s=this.$("#certChoose"),l=this.$("#contactInfo"),d=l.find("[name=id]").val(),p=l.find("[name='EMAIL;PREF']").val();c.addContactKeyStd(s).then(function(m){if("S_OK"===m.code){if(i=m["var"],""==d)return n=l.find("[name=certHashId]").val(),l.find("[name=certHashId]").val(n.concat(i.hashId,",")),a.notify.success(o.i18n.t("contact/msg_contactKeySaveSuccess")),t=r._parseCertInfo([i.cerInfo],p)[0],e=r.compile(r.$("#certListItem").html(),t),l.find(".cert-import").length>0&&l.find(".cert-list").html("<ul></ul>"),void l.find(".cert-list").removeClass("cert-list-empty").append(e);var h=function(){c.saveContactKey({hashId:i.hashId,uid:d}).then(function(){c.getContactKeys({uid:d}).then(function(n){a.notify.success(o.i18n.t("contact/msg_contactKeySaveSuccess")),t=r._parseCertInfo(n,p),e=r.compile(r.$("#importCertTpl").html(),{certs:t,len:n.length}),r.$(".j-cert-import").data("certs",t).html(e)})})},f=r._parseCertInfo([i.cerInfo],p)[0];f.query=!0,f.status.isExpired||f.status.isUnmatched?(e=r.compile(r.$("#certStatusTpl").html(),f),u.confirm(e,function(){h()},a.noop(),{title:o.i18n.t("contact/lbl_checkCert")})):h()}else"FA_FILE_SIZE_EXCEEDED"===m.code||"FA_PARSE_CER"==m.code?(s.replaceWith(s.clone(!0)),u.alert(o.i18n.t("error/"+m.code))):u.alert(o.i18n.t("common/FA_OTHER_CODE",{code:m.code}))})},_handleComposeToGrpMember:function(){var e=this;p.searchPabContacts({groupid:e.cid,reload:!0,returnAll:!0}).then(function(t){var n=[];a.each(t,function(e,t){var i='"'+(t.FN||"")+'" <'+t["EMAIL;PREF"]+">";n.push(i)}),e.trigger("compose",n)})},_enableGroupDeleteAndEdit:function(){var e=this;e.cid?"OTHER"==e.cid&&e.$('[data-panel="gedit"]').addClass("f-dn"):(e.$('[data-panel="gedit"]').addClass("f-dn"),e.$("#moveToGroup").addClass("f-dn"))},_switchPanel:function(e){function t(e,t){return(t.match(/\bswitch-\S+/g)||[]).join(" ")}var n=this;if(0==e.indexOf("-")){var i=e.substring(1);return void("detail"!=i&&"export"!=i&&"import"!=i&&"edit"!=i&&"gedit"!=i||0==n._params.uniqueIds.length?n.$(".main-wrapper").removeClass(t):n.$(".main-wrapper").removeClass(t).addClass("switch-pab-list"))}n.$(".main-wrapper").removeClass(t).addClass("switch-pab-"+e)},_exportContacts:function(){var e=this,t=e.$('[name="exportContactsForm"]').serializeJSON();t=a.extend({sid:f.getSid()},t),e.$("#exportIframe").attr("src",CC.basePath("jsp/contact.jsp?"+a.param(t)))},_importContacts:function(){var e,t,n,i,r=this,s=this.$("#fileChoose"),l=r._checkFileSuffix(s);return l?(n=r.$('[name="importContactsForm"]').serializeJSON(),void c.importContacts(n,s).then(function(n){"S_OK"===n.code?(i=n["var"],e=r.$("#importResultTpl").html(),t=r.compile(e,i||{}),r.$("#importResultContainer").removeClass("f-dn").html(t),r.$("#importContactsForm").addClass("f-dn"),r.$(".panel .toolbar-wrapper .import button").toggleClass("f-dn"),r.sendMessage("contact","refresh:pabTree",null),r.cid="",r._renderContactList({reload:!0,resetPage:!0})):"FA_GROUP_NOT_FOUND"===n.code||"FA_EMPTY_UPLOAD_FILE"===n.code||"FA_INVALID_UPLOAD_FILE"===n.code?a.notify(o.i18n.t("error/"+n.code)):a.notify(o.i18n.t("common/FA_OTHER_CODE",{code:n.code}))})):!1},_checkFileSuffix:function(e){var t=this,n=t.$(".content:visible");if(!e.val())return u.alert(o.i18n.t("contact/msg_importFileEmptyErr"),a.noop(),{
parentNode:n}),!1;var i=e[0].files&&e[0].files[0].filename||e.val(),r=i.substring(i.lastIndexOf(".")+1).toLowerCase();return"vcf"!=r&&"csv"!=r?(u.alert(o.i18n.t("contact/msg_importFileFormatErr"),a.noop(),{parentNode:n}),!1):"vcf"==r?(t.$("#informat").val("10"),!0):"csv"==r?(t.$("#informat").val("8"),!0):void 0},_doSortList:function(e,t){var n=this,i=n.$(t).data("sort"),a=n.$(t).find("i");a.hasClass("icondown")||a.hasClass("iconup")?a.toggleClass("icondown iconup"):(n.$(".content:visible [data-sort] i").removeClass("icondown iconup"),a.addClass("iconup")),n.order?n.order={field:i,desc:!n.order.desc}:n.order={field:i,desc:!1},n._params.isSearchView?n.keyword&&n._renderContactList({keyword:n.keyword,order:n.order.field,desc:n.order.desc,resetPage:!0}):n._renderContactList({order:n.order.field,desc:n.order.desc,groupid:n.cid,resetPage:!0})},_uploadAvatar:function(e,t){function n(e){return e.type?/^image\/\w+$/.test(e.type):/\.(jpg|jpeg|png|gif)$/.test(e)}function i(e){var t=a('<img src="'+e+'"/>');a("section.j-contact div.j-wrapper").empty().html(t),t.cropper({aspectRatio:1,preview:a("section.j-contact div.j-preview").selector,minContainerWidth:200,minContainerHeight:200,zoomable:!1})}var r,s,l,d,p,m=this,h=o.detector.supportBlobURL()&&o.detector.supportAjaxUpload();if(h)r=a(t).prop("files"),r.length>0&&(l=r[0],n(l)?(a("#avatar-tips").empty(),d=window.URL.createObjectURL(l),i(d)):u.alert(o.i18n.t("contact/msg_invalidImageType")));else{if(!n(a(t).val()))return u.alert(o.i18n.t("contact/msg_invalidImageType")),!1;p=m.$("#avatarInput"),s=m.$('#contactInfo [name="id"]').val()||"-1",c.addContactAvatar({uid:s,file:p}).then(function(e){0==e.code.indexOf("FA_")?"FA_ATTR_SIZE_EXCEEDED"==e.code||"FA_FILE_SIZE_EXCEEDED"==e.code||"FA_OVERFLOW"==e.code?a.notify(o.i18n.t("error/"+e.code)):a.notify(o.i18n.t("common/FA_OTHER_CODE",{code:e.code})):(a.notify(o.i18n.t("contact/msg_successfullySaveAvatar")),m.$("div.j-preview img").attr("src",o.url.addUrlParams("/coremail/s?func=pab:getContactAvatar",{uid:s,time:(new Date).getTime(),sid:f.getSid()})))})}},_getcontacts:function(){var e=[];return this.$("#addrContainer :hidden").each(function(){e.push({id:a(this).val(),name:a(this).data("name"),addr:a(this).data("addr"),isOab:a(this).data("isoab"),isUser:!0})}),{contact:e}},_getGrpAddAndUpdateIds:function(e){var t=this;e=e||[];var n=t._params.allIds,i=[];a.each(n,function(t,n){var r=-1;a.each(e,function(e,t){return n==a(t).val()?(r=e,!1):void 0}),-1==r?i.push(n):e.splice(r,1)});var r=[],s=[];return a.each(e,function(e,t){a(t).data("isoab")?r.push(a(t).val()):s.push(a(t).val().toString())}),{updateIds:i,addIds:{oIds:r,pIds:s}}},_parseCertInfo:function(e,t){function n(e){var t,n=e.split(/,\s?/),i={};return a.each(n,function(e,n){t=n.split("="),i[t[0]]=t[1]}),i}function i(e,i,a){var r=n(a).EMAILADDRESS;return{isExpired:!s().isBetween(i,e),isUnmatched:r!=t}}var r=[];return a.each(e,function(e,t){r.push({issuerDN:n(t.issuerDN),subjectDN:n(t.subjectDN),notAfter:t.notAfter.match(/^\d{4}-\d{1,2}-\d{1,2}/)[0],notBefore:t.notBefore.match(/^\d{4}-\d{1,2}-\d{1,2}/)[0],status:i(t.notAfter,t.notBefore,t.subjectDN)})}),r},templateHelpers:{formatted:function(e){return e||o.i18n.t("common/none")},formattedValidity:function(e,t){var n=s(e).format("YYYY-MM-DD"),i=s(t).format("YYYY-MM-DD");return d.format(o.i18n.t("contact/lbl_certValidityDisplay"),[n,i])}}});m.module({name:"contact.pab",template:e("text!template/module/contact/pabContact.tpl.html")},_)}),define("components/requirejs-text/text!template/module/contact/pabPrint.tpl.html",[],function(){return'<section class="m-ctpabPrint">\r\n    <header>\r\n        <div class="header header-primary">\r\n            <p class=""></p>\r\n            <form name="conditionsForm" action="#">\r\n                <div class="default" id="defContainer"></div>\r\n                <div class="extra f-dn" id="extraContainer"></div>\r\n            </form>\r\n        </div>\r\n\r\n        <div class="header f-tar">\r\n            <label></label>\r\n            <button class="u-btn u-btn-primary" data-operation="doPrint"></button>\r\n            <!--<button class="u-btn u-btn-default"></button>-->\r\n        </div>\r\n    </header>\r\n    <div class="content u-scroll">\r\n        <section class="container u-scroll" id="previewItemContainer"></section>\r\n    </div>\r\n\r\n    {{#raw}}\r\n    <script type="text/x-handlebar-template" id="conditionsTpl">\r\n        <div class="content">\r\n            [[#each conditions]]\r\n            <span class="cbWrapper">\r\n                <input type="checkbox" name="[[name]]" id="[[name]]" value="[[label]]" [[isChecked]]/>\r\n                <label for="[[name]]">[[label]]</label>\r\n            </span>\r\n            [[/each]]\r\n            [[#if withMoreOp]]\r\n            <span class="aWrapper">\r\n                <a href="javascript:void(0)" data-operation="showExtra"><i class="iconfont iconup"></i></a>\r\n            </span>\r\n            [[/if]]\r\n        </div>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="previewItemTpl">\r\n        [[#each previewItem]]\r\n        <div class="u-box u-box-primary">\r\n            <div class="u-box-head">\r\n                <h3 class="u-box-head-title">[[formatted name]]</h3>\r\n            </div>\r\n            <div class="u-box-container">\r\n                [[#each extra]]\r\n                <div class="u-box-content">\r\n                    <div class="label label-left"><label>[[label]]</label></div>\r\n                    <div class="label label-right"><label>[[value]]</label></div>\r\n                </div>\r\n                [[/each]]\r\n            </div>\r\n        </div>\r\n        [[/each]]\r\n    </script>\r\n    {{/raw}}\r\n</section>'}),define("module/contact/pabPrint/index",["require","util/i18n!common","jquery","util/i18n","cui/core/view/view","module/contact/service","cui/core/view/viewmanager","module/common/globalService","cui/util/templatable/templatable","text!template/module/contact/pabPrint.tpl.html"],function(e){e("util/i18n!common");var t=e("jquery"),n=e("util/i18n"),i=e("cui/core/view/view"),a=e("module/contact/service"),r=e("cui/core/view/viewmanager"),s=e("module/common/globalService"),o=e("cui/util/templatable/templatable"),l=i.extend({Implements:o,events:{"click [data-operation]":"_dispatchOperation","click header .checkbox":"_updatePreviewItem"},setup:function(){this.defChecked={"EMAIL;PREF":!0,"TEL;CELL;VOICE":!0,ORGNAME:!0,"ADR;WORK":!0}},render:function(){var e=this;l.superclass.render.call(e),e._initContactSchema(),e._initPreviewItem()},_initContactSchema:function(){var e=this;a.getPabContactSchema().then(function(n){var i=[],a=[],r=e.$("#conditionsTpl").html();t.each(n,function(t,n){e.defChecked[n.name]?(n.isChecked="checked",i.push(n),e.defChecked[n.name]=n.label):"FN"!=n.name&&a.push(n)});for(var s=6-i.length,o=0;s>o&&0!=a.length;o++)i.push(a[0]),a.shift();e.$("#defContainer").html(e.compile(r,{withMoreOp:!0,conditions:i}));var l=a.length;if(l>0&&7>=l)e.$("#extraContainer").html(e.compile(r,{conditions:a}));else if(l>7)for(var c=0,d=c;l>c;c+=7){var u=a.slice(c,d+=7);e.$("#extraContainer").append(e.compile(r,{conditions:u}))}e.element&&e.element.customRadioCheckbox()})},_initPreviewItem:function(){var e=this,n=s.getCurrentState(!0),i=n.param.ids;return i?void a.getPabAttrs(i.split(",")).then(function(n){var i=[];t.each(n,function(n,a){var r=[];t.each(e.defChecked,function(e,t){"Grouping"==e&&(e="groups"),a[e]&&r.push({label:t,value:a[e]})}),i.push({id:a.id,name:a.FN,extra:r})});var a=e.$("#previewItemTpl").html();e.$("#previewItemContainer").html(e.compile(a,{previewItem:i}))}):!1},_dispatchOperation:function(e,n){var i=this,a=t(n).data("operation");switch(a){case"showExtra":t(n).find("i").toggleClass("icondown iconup"),i.$("#extraContainer").toggleClass("f-dn"),i._adjustPrevContainer();break;case"doPrint":i.$("> header").addClass("f-dn"),i._adjustPrevContainer(),window.print(),i.$("> header").removeClass("f-dn"),i._adjustPrevContainer()}},_updatePreviewItem:function(){var e=this;e.defChecked=e.$('[name="conditionsForm"]').serializeJSON({parseBooleans:!0}),e._initPreviewItem()},_adjustPrevContainer:function(){var e=this,t=e.$("> header").height()+36;e.$("> .content").css("top",t)},templateHelpers:{formatted:function(e){return e||n.t("common/none")}}});r.module({name:"contact.pabPrint",template:e("text!template/module/contact/pabPrint.tpl.html")},l)}),define("components/requirejs-text/text!template/module/setting/index.tpl.html",[],function(){return' <section class="m-setting j-setting">\r\n  <aside class="sgsidebar">\r\n    <div class="sgsidebar-bg"></div>\r\n    <ul class="nav ztree j-nav-tree"></ul>\r\n  </aside>\r\n  <article class="sgmain">\r\n    <div class="sgmain-bg"></div>\r\n    <div class="j-setting-content"></div>\r\n  </article>\r\n   {{#raw}}\r\n   <script type="text/x-handlebars-template" id="tabTpl">\r\n     <li>\r\n       <a title=\'{{i18n "setting/nav_account"}}\' data-trigger="setting.account">{{i18n "setting/nav_account"}}</a>\r\n     </li>\r\n     <li>\r\n       <a title=\'{{i18n "setting/nav_display"}}\' data-trigger="setting.display">{{i18n "setting/nav_display"}}</a>\r\n     </li>\r\n     <li>\r\n       <a title=\'{{i18n "setting/nav_delivery"}}\' data-trigger="setting.delivery">{{i18n "setting/nav_delivery"}}</a>\r\n     </li>\r\n     <li>\r\n       <a title=\'{{i18n "setting/nav_filter"}}\' data-trigger="setting.filter">{{i18n "setting/nav_filter"}}</a>\r\n     </li>\r\n     <li>\r\n       <a title=\'{{i18n "setting/nav_security"}}\' data-trigger="setting.security">{{i18n "setting/nav_security"}}</a>\r\n     </li>\r\n     <li>\r\n       <a title=\'{{i18n "setting/nav_folder"}}\' data-trigger="setting.folder">{{i18n "setting/nav_folder"}}</a>\r\n     </li>\r\n     [[#if supportCal]]\r\n     <li>\r\n       <a title=\'{{i18n "setting/nav_calendar"}}\' data-trigger="setting.calendar">{{i18n "setting/nav_calendar"}}</a>\r\n     </li>\r\n     [[/if]]\r\n     <li>\r\n       <a title=\'{{i18n "setting/nav_advance"}}\' data-trigger="setting.advance">{{i18n "setting/nav_advance"}}</a>\r\n     </li>\r\n   </script>\r\n   {{/raw}}\r\n</section>'}),define("module/setting/index",["require","i18n!setting","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","module/common/globalService","text!template/module/setting/index.tpl.html"],function(e){function t(e,t){var n=e.tabview.current(),i=t.module;if(i!==n&&0===i.indexOf("setting.")){var r=i.split(".");if(3==r.length&&(i="setting."+r[1]),o.setCurrentState(t),e.tabview.find(i))e.tabview.switchTo(i);else{var s={id:i,replaceId:"setting*",title:" ",module:a.module(i)};e.tabview.addTab(s)}e._setHoverSidebarNav(i)}}e("i18n!setting");var n=e("jquery"),i=e("cui/core/view/view"),a=e("cui/core/view/viewmanager"),r=e("cui/util/templatable/templatable"),s=e("cui/ui/tabview/tabview"),o=e("module/common/globalService"),l=i.extend({Implements:r,activeTabId:"account",events:{"click ul.ztree li a":"_changeTabView"},setup:function(){var e=this;e.state=o.getCurrentState(),e.activeTabId=e.state.module.split(".")[1]||"account"},render:function(){var e=this;l.superclass.render.call(e),e._initTabView(),e._initModuleEvent()},destroy:function(){var e=this;e.tabview&&e.tabview.destroy(),l.superclass.destroy.call(e)},_changeTabView:function(e){e.preventDefault();var n=this,i=n.$(e.target),a=i.data("trigger");a&&t(n,{module:a})},_setHoverSidebarNav:function(e){var t=this;t.$("ul.nav li a").each(function(){n(this).data("trigger")==e?n(this).hasClass("curSelectedNode")||n(this).addClass("curSelectedNode"):n(this).removeClass("curSelectedNode")})},_initTabView:function(){var e,n=this,i={supportCal:o.getConfig("calendar.enable")};e=n.compile(n.$("#tabTpl").html(),i),n.$(".j-nav-tree").html(e);var r=[{id:"setting.account",title:" ",module:a.module("setting.account")},{id:"setting.display",title:" ",module:a.module("setting.display")},{id:"setting.delivery",title:" ",module:a.module("setting.delivery")},{id:"setting.filter",title:" ",module:a.module("setting.filter")},{id:"setting.security",title:" ",module:a.module("setting.security")},{id:"setting.folder",title:" ",module:a.module("setting.folder")},{id:"setting.calendar",title:" ",module:a.module("setting.calendar")},{id:"setting.advance",title:" ",module:a.module("setting.advance")}];i.supportCal||r.splice(6,1),n.tabview=new s({element:"section.j-setting",classPrefix:"j-setting",activeTabId:"setting."+n.activeTabId,activeTriggerClass:"curSelectedNode ",onlyRenderActive:!0,tabs:r}),n.tabview.render(),n._setHoverSidebarNav("setting."+n.activeTabId),n.tabview.on("render",function(e){n.activeTabId=e;var i=o.getCurrentState();t(n,i),n.sendMessage("dispatcher","view:render",{module:e,param:{}})}),n.tabview.on("refresh",function(e){n.activeTabId=e,n.sendMessage("dispatcher","view:refresh",{module:e,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(n){t(e,n.message.newState)})},_setHistory:function(e){var t=this,i=n.extend(!0,{},e);i.param={},t.sendMessage("dispatcher","view:render",i)}});a.module({name:"setting",template:e("text!template/module/setting/index.tpl.html")},l)}),define("components/requirejs-text/text!template/module/setting/account/index.tpl.html",[],function(){return'<section class="m-sgaccount j-account">\r\n\r\n  <nav class="nav u-tab u-tab-highlight-down">\r\n    <ul class="j-account-nav"></ul>\r\n  </nav>\r\n\r\n  <div class="content j-account-content"></div>\r\n\r\n  {{#raw}}\r\n  <script type="x-handlebars-template" id="tabTpl">\r\n    [[#if profile]]\r\n    <li data-trigger="account.personal">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n \'setting/tab_personal\'}}</a>\r\n    </li>\r\n    [[/if]]\r\n\r\n    [[#or enableExternalAuth enableDefaultAuth]]\r\n    <li data-trigger="account.password">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n \'setting/tab_password\'}}</a>\r\n    </li>\r\n    [[/or]]\r\n\r\n    [[#if signature]]\r\n    <li data-trigger="account.signature">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n "setting/tab_signature"}}</a>\r\n    </li>\r\n    [[/if]]\r\n\r\n    [[#if question]]\r\n    <li data-trigger="account.question">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n "setting/tab_question"}}</a>\r\n    </li>\r\n    [[/if]]\r\n\r\n  </script>\r\n  {{/raw}}\r\n\r\n</section>\r\n\r\n\r\n\r\n\r\n'}),define("module/setting/account/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","util/i18n","module/common/globalService","configurable/index","text!template/module/setting/account/index.tpl.html"],function(e){function t(e,t){return i("<div>",{"data-panel":e.sid,"class":t+" u-scroll",style:"display:none",html:""})}function n(e,t){if(0==t.indexOf("setting.account")){var n=t.substring("setting.".length);e.tabview.find(n)&&(c.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("cui/ui/tabview/tabview"),l=e("util/i18n"),c=e("module/common/globalService"),d=e("configurable/index"),u=a.extend({Implements:s,activeTabId:"account.personal",setup:function(){var e;this.state=c.getCurrentState(),e=this.state.module.split("."),this.activeTabId=e[2]?"account."+e[2]:this.activeTabId,this.state.module="setting."+this.activeTabId,c.setCurrentState(this.state),this.config=d("setting.account"),this._setHistory(this.state)},render:function(){u.superclass.render.call(this),this._initTabView(),this._initModuleEvent()},_initTabView:function(){var e=this,n=e.compile(e.$("#tabTpl").html(),e.config);e.$(".j-account-nav").html(n);var i=[{id:"account.personal",title:l.t("setting.tab_personal"),module:r.module("setting.account.personal")},{id:"account.password",title:l.t("setting.tab_password"),module:r.module("setting.account.password")}];e.config.externalauth&&(e.config.externalauthurl?i.splice(1,1,{id:"account.password",title:l.t("setting.tab_password"),module:r.module("setting.account.externalauth")}):i.splice(1,1)),e.config.signature&&i.push({id:"account.signature",title:l.t("setting.tab_signature"),module:r.module("setting.account.signature")}),e.config.question&&i.push({id:"account.question",title:l.t("setting.tab_question"),module:r.module("setting.account.question")}),e.tabview=new o({element:"section.j-account",classPrefix:"j-account",activeTabId:e.activeTabId,activeTriggerClass:"z-current",onlyRenderActive:!0,generatePanelMarkup:t,tabs:i}),e.tabview.render(),e.tabview.on("render",function(t){e.activeTabId=t,e._setHistory({module:"setting."+t})}),e.tabview.on("refresh",function(t){e.activeTabId=t,e.sendMessage("dispatcher","view:refresh",{module:"setting."+t,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(t){var i=t.message.newState;n(e,i.module)})},_setHistory:function(e){var t=this,n=i.extend(!0,{},e);0==n.module.indexOf("setting.account.")&&(n.param={},t.sendMessage("dispatcher","view:render",n))}});r.module({name:"setting.account",template:e("text!template/module/setting/account/index.tpl.html")},u)}),define("module/setting/account/externalauth/index",["require","cui/core/view/view","cui/core/view/viewmanager","module/common/globalService"],function(e){var t=e("cui/core/view/view"),n=e("cui/core/view/viewmanager"),i=e("module/common/globalService"),a=t.extend({attrs:{template:'<iframe src="'+i.getConfig("setting.externalauthurl")+'" width="100%" height="98%">'},render:function(){a.superclass.render.call(this)}});n.module({name:"setting.account.externalauth"},a)}),define("util/pwdvalidator",[],function(){function e(e){var n=e.dnEmail||"";e.requireLength&&(e.requireLength.WEAK=1),this.requireLength=e.requireLength||{WEAK:1,FAIR:6,GOOD:8,STRONG:8},this.minStrength=e.minStrength||"WEAK",this.minLength=this.requireLength[this.minStrength],this.weakPasswords=e.weakPasswords||[],this.aliasEmails=e.aliasEmails||[],this.username=t(n),this.specCharRequire={WEAK:0,FAIR:1,GOOD:2,STRONG:3}}function t(e){return e.indexOf("@")>0?e.substring(0,e.indexOf("@")):e}function n(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1}function i(e,t){return e.length>0&&e.length>=t}function a(e,t){return""!=e?!n(t,e):void 0}function r(e,t){return""!=e?c(e)>=t:void 0}function s(e,n,i){if(""!=i){if(e==i)return!1;for(var a=0;a<n.length;a++)if(t(n[a])==i)return!1;return!0}}function o(e){if(""!=e){for(var t=e.charCodeAt(0),n=1;n<e.length;n++)if(e.charCodeAt(n)!=t)return!0;return!1}}function l(e){if(""!=e){var t=48,n=57,i=65,a=90,r=97,s=122,o=e.charCodeAt(0);if(o>=t&&n>=o){if(o+e.length>n+1)return!0}else if(o>=r&&s>=o){if(o+e.length>s+1)return!0}else{if(!(o>=i&&a>=o))return!0;if(o+e.length>a+1)return!0}for(var l=1;l<e.length;l++)if(e.charCodeAt(l)!=o+l)return!0;return!1}}function c(e){for(var t=48,n=57,i=65,a=90,r=97,s=122,o=0,l=0,c=0,d=0,u=0;u<e.length;u++){var p=e.charCodeAt(u);p>=t&&n>=p?o=1:p>=r&&s>=p?l=1:p>=i&&a>=p?c=1:d=1}return o+l+c+d}return e.prototype.rndPassword=function(e,t,n,i,a){var r="",s="";t&&(r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"),n&&(r+="abcdefghijklmnopqrstuvwxyz"),i&&(r+="0123456789"),a&&(r+="!#$%&*+-=?@^_~");for(var o=0;e>o;o++)s+=r.charAt(Math.floor(Math.random()*r.length));return s},e.prototype.getPasswordStrength=function(e){if(null==e||e.length<this.requireLength.FAIR)return"WEAK";if(!s(this.username,this.aliasEmails,e))return"WEAK";if(!o(e)||!l(e))return"WEAK";if(!a(e,this.weakPasswords))return"WEAK";if(e.length<this.requireLength.GOOD)return"FAIR";var t=c(e);return 2>t?"FAIR":3>t||e.length<this.requireLength.STRONG?"GOOD":"STRONG"},e.prototype.getPasswordRulesMatch=function(e){var t;switch(this.minStrength){case"WEAK":t={isMatchMinLength:i(e,this.minLength),isNotWeakPassword:a(e,this.weakPasswords)};break;case"FAIR":t={isMatchMinLength:i(e,this.minLength),isNotWeakPassword:a(e,this.weakPasswords),isNotRepetition:o(e),isNotSameAsAlias:s(this.username,this.aliasEmails,e),isNotSequential:l(e)};break;case"GOOD":t={isMatchMinLength:i(e,this.minLength),isNotWeakPassword:a(e,this.weakPasswords),isNotSameAsAlias:s(this.username,this.aliasEmails,e),isContainSpecChar:r(e,this.specCharRequire[this.minStrength])};break;case"STRONG":t={isMatchMinLength:i(e,this.minLength),isNotWeakPassword:a(e,this.weakPasswords),isNotSameAsAlias:s(this.username,this.aliasEmails,e),isContainSpecChar:r(e,this.specCharRequire[this.minStrength])}}return t.strength=this.getPasswordStrength(e),t},e}),function(){define("module/setting/security/twofactorauth/store",["require","exports","module","util/i18n!setting","jquery","i18n","configstore","component/confirmbox"],function(e,t,n){e("util/i18n!setting");var i=e("jquery"),a=e("i18n"),r=e("configstore"),s=e("component/confirmbox"),o=parseInt(r.getConfig("setting.otppwdlength"),10),l=parseInt(r.getConfig("setting.validsmscodelength"),10);isNaN(o)&&(o=99);var c={DISABLED:"DISABLED",SMS:"SMS",DYNAMIC:"DYNAMIC",OTP:"OTP"},d={LOGIN:"login",CHANGE_PWD:"change_password",RESTORE_PWD:"restore_password",UPDATE_AUTH:"update_second_auth"},u={FA_INVALID_SESSION:a.t("setting/lbl_twofactorauth_edit_time_exceed"),FA_INVALID_PARAMETER:a.t("setting/lbl_twofactorauth_invalid_param"),FA_USER_NOT_FOUND:a.t("setting/lbl_twofactorauth_invalid_user"),FA_INVALID_STAGE:a.t("setting/lbl_twofactorauth_invalid_param"),FA_FORBBIDEN:a.t("setting/lbl_twofactorauth_invalid_forbidden")},p={INITIAL:"INITIAL",VALIDATING:"VALIDATING",VALIDATED:"VALIDATED",PREPARE_UPDATE:"PREPARE_UPDATE",UPDATED:"UPDATED",FINAL:"FINAL"},m=function(e){return function(t,n){var a=i.isPlainObject(n.model)?n.model:{};if(null==t)return"";var r=a.errorMsg&&a.errorMsg[t]||e[t]||e.FA_FORBBIDEN;return r}}(u),h={SMS:{type:"SMS",enable:!0,name:a.t("setting/lbl_twofactorauth_sms"),cellNumber:null,cellLength:11,sendAgainTimeout:6e4,codeLimit:l,caseSensitive:!1,cache:null,ui:{bgClass:"bg-sms",iconClass:"iconmoblie"},reset:i.noop,errorMsg:{FA_INVALID_PARAMETER:a.t("setting/lbl_twofactorauth_invalid_param"),FA_FORBIDDEN:a.t("setting/lbl_twofactorauth_sms_send_error"),FS_SEND_FAILED:a.t("setting/msg_sendValidateCodeFail"),FA_INVALID_STAGE:a.t("setting/lbl_twofactorauth_sms_unsent_error"),FA_INVALID_VERIFY_CODE:a.t("setting/lbl_twofactorauth_sms_verify_code_invalid"),FA_INVALID_VERIFY_CELL:a.t("setting/lbl_twofactorauth_sms_verify_code_invalid")}},DYNAMIC:{type:"DYNAMIC",enable:!0,name:a.t("setting/lbl_twofactorauth_dynamic"),email:r.getConfig("user.uid"),authkeyid:null,codeLimit:6,cache:null,ui:{bgClass:"bg-dynamic",iconClass:"icondp"},reset:function(){this.authkeyid=null},errorMsg:{FA_INVALID_DYNAMIC_PWD:a.t("setting/msg_authBindErrorCode4003"),FA_DYNAMIC_PWD_EXHAUST:a.t("setting/msg_authBindErrorCode4001"),FA_NOT_SUPPORT_TYPE:a.t("setting/lbl_twofactorauth_invalid_param")}},OTP:{type:"OTP",enable:!0,name:a.t("setting/lbl_twofactorauth_otp"),deviceInfo:null,codeLimit:o,cache:null,ui:{bgClass:"bg-otp",iconClass:"iconqr"},reset:function(){this.deviceInfo=null},errorMsg:{common:a.t("setting/lbl_twofactorauth_otp_push_verify_error"),FA_INVALID_DYNAMIC_PWD:a.t("setting/lbl_twofactorauth_otp_code_verify_error"),FS_UNKNOWN:a.t("setting/lbl_twofactorauth_otp_gen_secret_fail")}}},f=function(e,t){var n=Math.floor(e/1e3%60).toString(),i=Math.floor(e/1e3/60%60).toString();t="boolean"==typeof t?t:!0,n=1===n.length&&t?"0"+n:n,i=1===i.length&&t?"0"+i:i;var a=Math.floor(e/36e5%24),r=Math.floor(e/864e5);return{total:e,days:r,hours:a,minutes:i,seconds:n}},v=function(e,t,n){var a,r=function(){var t=e-Date.parse(new Date);return f(t)},s=function(){null!=a&&clearTimeout(a)};return t=i.isFunction(t)?t:i.noop,n=i.isFunction(n)?n:i.noop,a=setInterval(function(){var e=r();e.total<=0?(s(),n(e)):t(e)},1e3),s},g=function(e){var t=/^[0-9]+$/;return null!=e&&e.length?t.test(e):!1},b=function(e){var t=!1;if(null==e||null==e.code)return t;switch(e.code){case"FA_INVALID_SESSION":s.alert(u.FA_INVALID_SESSION),e.errorProcessed(),t=!0}return t},_=b;n.exports={authOptions:c,authModels:h,authTrans:d,transStages:p,formatMilliSecondMap:f,countdownTick:v,validateNumeric:g,matchErrorMsg:m,commonErrorMsg:u,validateAuthErrorCallback:b,updateAuthErrorCallback:_}})}(),function(){define("module/setting/security/twofactorauth/service",["require","exports","module","jquery","../../../../util/index","module/common/globalService","./store"],function(e,t,n){function i(){var e=m.getConfig("setting.supporttwofactorauthtypes"),t=m.getConfig("setting.usedynamicpwd"),n=m.getConfig("setting.supportsms")&&m.getConfig("setting.supportsmsloginverify"),i=m.getConfig("user.enablecellphonebinding"),a={sms:("custom"===e||"sms"===e)&&n,dynamic:("custom"===e||"dynamic"===e)&&t,otp:("custom"===e||"app"===e)&&t},r={supportDynamicPwd:t,supportSmsNotify:n,enableCellphoneBinding:i};return{permits:a,config:r,isForbidden:!(a.sms||a.dynamic||a.otp)}}function a(){var e=u.Deferred();return p.xhr.simpleCall({query:{func:"user:querySecondAuth",sid:m.getSid()}},function(t){e.resolve(t)},function(t,n,i){e.reject(i)}),e.promise()}function r(){var e=u.Deferred(),t=i(),n=t.permits,r=function(i){return e.resolve({state:i,config:t.config,permits:n})};return n.sms||n.dynamic||n.otp?(u.when(a()).then(function(e){var t,n=e.type;switch(n){case"SMS":t={type:n,cellNumber:e.cellNumber};break;case"DYNAMIC":t={type:n,authkeyid:e.authkeyid};break;case"OTP":t={type:n,deviceInfo:e.deviceInfo};break;case"DISABLE":default:t={type:f.DISABLED}}r(t)},function(e){console.debug("twofactorauth","can not query auth info",e.toString())}),e.promise()):r(null)}function s(e){var t=u.Deferred();return p.xhr.simpleCall({query:{func:"user:triggerSecondAuth",sid:m.getSid()},data:e},function(e){t.resolve(e)},function(e,n,i){t.reject(i)}),t.promise()}function o(e){var t=u.Deferred();return p.xhr.simpleCall({query:{func:"user:validateSecondAuth",sid:m.getSid()},data:e},function(e){t.resolve(e)},function(e,n,i){h.validateAuthErrorCallback(i)?t.reject({}):t.reject(i)}),t.promise()}function l(e){var t=u.Deferred();return p.xhr.simpleCall({query:{func:"user:prepareUpdateSecondAuth",sid:m.getSid()},data:e},function(e){t.resolve(e)},function(e,n,i){t.reject(i)}),t.promise()}function c(e){var t=u.Deferred();return p.xhr.simpleCall({query:{func:"user:updateSecondAuth",sid:m.getSid()},data:e},function(e){t.resolve(e)},function(e,n,i){h.validateAuthErrorCallback(i)?t.reject({}):t.reject(i)}),t.promise()}function d(e){var t=u.Deferred();return p.xhr.simpleCall({query:{func:"user:querySecondAuthValidateStage",sid:m.getSid()},data:e},function(e){t.resolve(e)},function(e,n,i){t.reject(i)}),t.promise()}var u=e("jquery"),p=e("../../../../util/index"),m=e("module/common/globalService"),h=e("./store"),f=h.authOptions;n.exports={getAuthConfig:i,queryAuthInfo:a,initAuthData:r,prepareValidateAuth:s,validateAuth:o,prepareUpdateAuth:l,updateAuth:c,queryValidateStage:d}})}(),function(){define("module/setting/security/logindevices/service",["require","exports","module","jquery","../../../../util/index","module/common/globalService"],function(e,t,n){var i=e("jquery"),a=e("../../../../util/index"),r=e("module/common/globalService"),s=function(e,t){return{module:"module.setting.security.logindevices.service",msg:e,meta:t}},o=function(e){var t=i.Deferred();return i.isPlainObject(e)?null==e.deviceId?t.reject(s("invalid params: accessToken or id is required!",e)):"boolean"!=typeof e.auth?t.reject(s("invalid params: auth value shall be boolean type",e)):(a.xhr.simpleCall({query:{func:"user:authDevice",sid:r.getSid()},data:e},function(e){t.resolve(e)},function(e,n,i){t.reject(s("authDevice failed",i))}),t.promise()):t.reject(s("invalid params object type required!",e))},l=function(){var e=i.Deferred();return a.xhr.simpleCall({query:{func:"user:listDevices",sid:r.getSid()}},function(t){e.resolve(t)},function(t,n,i){e.reject(s("listDevices failed",i))}),e.promise()},c=function(e){var t,n=i.Deferred();if(!i.isPlainObject(e))return n.reject(s("invalid params object type required!",e));if(t=e.ids,!i.isArray(t)){if(t=parseInt(t,10),isNaN(t))return n.reject(s("invalid params: ids shall be int type of array"),e);e.ids=[t]}return a.xhr.simpleCall({query:{func:"user:deleteDevices",sid:r.getSid()},data:e},function(e){n.resolve(e)},function(e,t,i){n.reject(s("deleteDevices failed",i))}),n.promise()},d=function(){var e=i.Deferred(),t=r.getSid();return r.getConfig("setting.supportauthorizeddevice")?(i.when(l()).then(function(n){var i,a=n.authorized,r=!1;if(!a.length)return e.resolve(!1);for(var s=0;s<a.length;s++)if(i=a[s],i.lastSid===t){r=i.authorized;break}return e.resolve(r)},function(){e.resolve(!1)}),e.promise()):e.resolve(!1)};n.exports={authDevice:o,listDevices:l,deleteDevices:c,checkCurrentDeviceIsAuthorized:d}})}(),define("components/requirejs-text/text!template/module/setting/security/twofactorauth/verify.tpl.html",[],function(){return'<div class="verify-wrap j-verify-wrap">\r\n  <div class="verify-main j-verify-main"></div>\r\n  <div class="verify-error j-error f-dn"></div>\r\n\r\n  {{#raw}}\r\n\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="SmsVerifyTpl">\r\n    <div class="verify-desc j-desc">[[ i18n "setting/lbl_smsSending" mobile=cellNumber ]]</div>\r\n    <div class="verify-input mg-top-16">\r\n      <input type="text" class="u-input j-input-code" maxlength="[[ codeLimit ]]" placeholder=\'{{ i18n "setting/lbl_twofactorauth_sms" }}\' />\r\n      <button class="u-btn u-btn-default btn-send-code j-send">\r\n        <span class="j-send-text">{{ i18n "setting/lbl_twofactorauth_sms_send" }}</span>\r\n        <span class="j-send-again-left"></span>\r\n      </button>\r\n    </div>\r\n  </script>\r\n\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="dynamicVerifyTpl">\r\n    <div class="verify-desc">{{ i18n "setting/lbl_twofactorauth_dynamic_verify_desc" }}</div>\r\n    <div class="verify-desc-sub mg-top-10">{{ i18n "setting/lbl_twofactorauth_dynamic_verify_desc_sub" }}</div>\r\n    <div class="verify-input mg-top-16">\r\n      <input type="text" class="u-input j-input-pwd" maxlength="[[ codeLimit ]]" placeholder=\'{{ i18n "setting/lbl_Authkeypwd" }}\' />\r\n    </div>\r\n  </script>\r\n\r\n  <!--Coremail App -->\r\n  <script type="text/x-handlebars-template" id="otpPushVerifyTpl">\r\n    <div class="verify-desc">{{ i18n "setting/lbl_twofactorauth_otp_push_verify_desc" }}</div>\r\n    <div class="verify-desc-sub mg-top-10">{{ i18n "setting/lbl_twofactorauth_otp_push_verify_desc_sub" }}</div>\r\n    <a href="javascript:void(0);" class="use-code j-use-code">{{ i18n "setting/lbl_twofactorauth_otp_verify_code" }}</a>\r\n  </script>\r\n\r\n  <!--Coremail App  -->\r\n  <script type="text/x-handlebars-template" id="otpCodeVerifyTpl">\r\n    <div class="verify-desc">{{ i18n "setting/lbl_twofactorauth_otp_code_verify_desc" }}</div>\r\n    <div class="verify-input mg-top-16">\r\n      <input type="text" class="u-input j-authcode" maxlength="[[codeLimit]]" />\r\n    </div>\r\n    [[#unless forceCode ]]\r\n    <a href="javascript:void(0);" class="use-push j-use-push">{{ i18n "setting/lbl_twofactorauth_otp_verify_push" }}</a>\r\n    [[/unless]]\r\n  </script>\r\n\r\n  {{/raw}}\r\n</div>'}),function(){define("module/setting/security/twofactorauth/verify",["require","exports","module","util/i18n!setting,common,pref/mobile","../../../../util/hbshelper","jquery","handlebars","cui/core/class/class","cui/ui/dialog/confirmbox","i18n","./store","./service","../logindevices/service","../../service","component/wsStore","text!template/module/setting/security/twofactorauth/verify.tpl.html"],function(e,t,n){e("util/i18n!setting,common,pref/mobile"),e("../../../../util/hbshelper");var i=e("jquery"),a=e("handlebars"),r=e("cui/core/class/class"),s=e("cui/ui/dialog/confirmbox"),o=e("i18n"),l=e("./store"),c=e("./service"),d=e("../logindevices/service"),u=e("../../service"),p=e("component/wsStore"),m=l.validateNumeric,h=l.matchErrorMsg,f=function(e){
return"string"==typeof e&&e.length?!0:(i.notify.error(o.t("setting/lbl_twofactorauth_invalid_param")),!1)},v=l.authOptions,g=l.authTrans,b={VERIFY:1,UNBIND:2,UPDATE:3},_={BOX:1},y=e("text!template/module/setting/security/twofactorauth/verify.tpl.html"),w=r.create({initialize:function(e){return i.isPlainObject(e)&&null!=e.$wrap?(this.verifyType=e.verifyType?e.verifyType:b.VERIFY,this.model=e.model,this.next=i.isFunction(e.onSuccess)?e.onSuccess:i.noop,this.errorCb=i.isFunction(e.onError)?e.onError:i.noop,this.$wrap=e.$wrap,this.$main=this.$wrap.find(".j-verify-main"),this.$error=this.$wrap.find(".j-error"),this.trans=e.verifyTrans?e.verifyTrans:g.UPDATE_AUTH,void(this.tempSid=e.tempSid?e.tempSid:null)):{}},submit:i.noop,cancel:function(){this._destroy()},_renderError:function(e){var t=this.$error,n=t.html();this.errorTimeoutId&&clearTimeout(this.errorTimeoutId),e&&e.length&&t.html(e),t.removeClass("f-dn"),this.errorCb(e),this.errorTimeoutId=setTimeout(function(){t.addClass("f-dn"),e&&e.length&&t.html(n)},3e3)},_doUnbind:function(e){var t=this;i.when(c.prepareUpdateAuth({tempSid:this.tempSid,newType:v.DISABLED})).then(function(){i.when(c.updateAuth({tempSid:t.tempSid})).then(function(){e()},function(e){null!=e.code?t._renderError(h(e.code,{model:t.model})):console.debug("twofactorauth","can not update auth status to disabled",e.toString())})},function(e){null!=e.code?t._renderError(h(e.code,{model:t.model})):console.debug("twofactorauth","can not prepare to disable auth",e.toString())})},_destroy:function(){this.$main.html(""),this.$error.html("")}}),x=w.extend({initialize:function(e){x.superclass.initialize.call(this,e),this._render()},submit:function(){var e,t,n=this;if(e=this.$main.find(".j-input-pwd"),t=i.trim(e.val()),!t.length)return this._renderError(o.t("setting/msg_authkeyNull")),!1;if(t.length!==this.model.codeLimit)return this._renderError(o.t("setting/lbl_twofactorauth_dynamic_verify_error")),!1;if(this.verifyType===b.UNBIND)i.when(u.unbindAuthKey({authkeyid:this.model.authkeyid,authkeypwd:t})).then(function(e){"S_OK"===e.code?(n.next(),n._destroy()):n._renderError(e["var"].desc)});else if(this.verifyType===b.VERIFY){if(!f(this.tempSid))return!1;i.when(c.validateAuth({tempSid:this.tempSid,verifyCode:t,trans:this.trans})).then(function(){n.next(n.tempSid),n._destroy()},function(e){null!=e.code?n._renderError(h(e.code,{model:n.model})):console.debug("twofactorauth","can not validate dynamic auth",e.toString())})}return!1},_render:function(){var e=this,t=this.$wrap.find("#dynamicVerifyTpl").html();this.$main.html(a.compile(t)(this.model)),this.verifyType===b.VERIFY&&i.when(c.prepareValidateAuth({trans:this.trans})).then(function(t){e.tempSid=t.tempSid,f(e.tempSid)},function(t){null!=t.code?e._renderError(h(t.code,{model:e.model})):console.debug("twofactorauth","can not trigger validate dynamic auth",t.toString())})}});x.authType=v.DYNAMIC;var C=w.extend({initialize:function(e){C.superclass.initialize.call(this,e),this.toggleConfirm=i.isFunction(e.toggleConfirm)?e.toggleConfirm:i.noop,this.patternEnum={PUSH:1,CODE:2},this.pattern=this.patternEnum.PUSH,this.cancelSubscribe=null,this._render()},submit:function(){var e;return this.pattern!==this.patternEnum.CODE?!1:(e=i.trim(this.$main.find(".j-authcode").val()),e.length&&m(e)?void this._doSubmit(e):(this._renderError(),!1))},cancel:function(){this._doCancelSubscribe(),C.superclass.cancel.call(this)},_render:function(){var e=this,t=function(t){var n=t.payload,i=n.trans;return i!==e.trans?(e._renderError(l.commonErrorMsg.FA_INVALID_PARAMETER),!1):void c.queryValidateStage({tempSid:e.tempSid,trans:e.trans}).then(function(t){var n=t.stage;return n!==l.transStages.VALIDATED?(e._renderError(l.commonErrorMsg.FA_FORBBIDEN),!1):void e._afterValidate()},function(t){null!=t.code?e._renderError(h(t.code,{model:e.model})):console.debug("twofactorauth","can not query trans stage",t.toString())})};this.$main.addClass("otp-verify-wrap"),this.pattern===this.patternEnum.CODE?this._renderCode():this._renderPush(),i.when(c.prepareValidateAuth({trans:this.trans})).then(function(n){var i=p.topicList.OTP_AUTH;return f(n.tempSid)?(e.tempSid=n.tempSid,i=i.replace("$tempsid$",e.tempSid),void(e.cancelSubscribe=p.subscribe(i,t))):!1},function(t){null!=t.code?e._renderError(h(t.code,{model:e.model})):console.debug("twofactorauth","can not trigger validate otp auth",t.toString())})},_renderPush:function(){var e=this,t=this.$wrap.find("#otpPushVerifyTpl").html();this.pattern=this.patternEnum.PUSH,this.toggleConfirm(!0),this.$error.html(o.t("setting/lbl_twofactorauth_otp_push_verify_error")),this.$main.html(a.compile(t)(this.model)),this.$main.off("click",".j-use-code").on("click",".j-use-code",function(){e._renderCode()})},_renderCode:function(){var e=this,t=this.$wrap.find("#otpCodeVerifyTpl").html();this.pattern=this.patternEnum.CODE,this.toggleConfirm(!1),this.$error.html(o.t("setting/lbl_twofactorauth_otp_code_verify_error")),this.$main.html(a.compile(t)(this.model)),this.$main.off("click",".j-use-push").on("click",".j-use-push",function(){e._renderPush()})},_doSubmit:function(e){var t=this;return f(this.tempSid)?(this._doCancelSubscribe(),void i.when(c.validateAuth({tempSid:this.tempSid,verifyCode:e,trans:this.trans})).then(function(){t._afterValidate()},function(e){null!=e.code?t._renderError(h(e.code,{model:t.model})):console.debug("twofactorauth","can not validate otp auth",e.toString())})):!1},_afterValidate:function(){var e=this;this.verifyType===b.UNBIND?this._doUnbind(function(){e.tempSid=null,e.next(),e._destroy()}):(this.next(this.tempSid),this._destroy())},_doCancelSubscribe:function(){null!=this.cancelSubscribe&&this.cancelSubscribe(),this.cancelSubscribe=null},_destroy:function(){this.$main.removeClass("otp-verify-wrap"),this._doCancelSubscribe(),C.superclass._destroy.call(this)}});C.authType=v.OTP;var k=w.extend({initialize:function(e){k.superclass.initialize.call(this,e),this.$desc=null,this.$btnSend=null,this.$sendLeft=null,this.clearSendAgain=null,this._render()},submit:function(){var e=i.trim(this.$main.find(".j-input-code").val()).toUpperCase();return e.length?e.length!==this.model.codeLimit?(this._renderError(o.t("setting/lbl_twofactorauth_sms_verify_code_invalid")),!1):(this._validateVerifyCode(e),!1):(this._renderError(o.t("setting/lbl_twofactorauth_sms_verify_code_blank")),!1)},_render:function(){var e=this,t=this.$wrap.find("#SmsVerifyTpl").html();this.$main.addClass("sms-verify-wrap"),this.$main.html(a.compile(t)(this.model)),this.$desc=this.$main.find(".j-desc"),this.$btnSend=this.$main.find(".j-send"),this.$sendLeft=this.$main.find(".j-send-again-left"),this._sendVerifyCode(function(){e._renderDesc(!1)},function(){e._renderDesc(!0)}),this.$btnSend.on("click",function(){return e.$btnSend.hasClass("disabled")?!1:void e._sendVerifyCode(function(){e.$desc.attr("data-failed")&&e._renderDesc(!1),e._sendAgainCountdown()},function(){e._renderDesc(!0)})})},_renderDesc:function(e){var t=this.model.cellNumber;e="boolean"==typeof e?e:!1,e?this.$desc.html(o.t("setting/lbl_smsSentFail",{mobile:this._formatMobileSafe(t)})):this.$desc.html(o.t("setting/lbl_smsAlreadySent",{mobile:this._formatMobileSafe(t)})),this.$desc.attr("data-failed",e)},_sendVerifyCode:function(e,t){var n=this,a=this.model.cellNumber;e=i.isFunction(e)?e:i.noop,t=i.isFunction(t)?t:i.noop,i.when(u.sendVerifyCode(a)).then(function(){e()},function(e){null!=e.code?n._renderError(h(e.code,{model:n.model})):n._renderError(o.t("setting/lbl_twofactorauth_sms_send_error")),t()})},_sendAgainCountdown:function(){var e=this,t=this.model,n=Date.parse(new Date)+t.sendAgainTimeout,i=function(t){e.$sendLeft.html(["(",t.seconds,"s",")"].join(""))},a=function(){e.$btnSend.removeClass("disabled"),e.$sendLeft.html("")};e.$btnSend.addClass("disabled"),this.clearSendAgain=l.countdownTick(n,i,a)},_validateVerifyCode:function(e){var t,n,i=this,a=this.model.cellNumber;t=u.updateSmsAttrs,n={attrs:{cellNumber:a},verifyCode:e},t(n).then(function(){i.next(),i._destroy()},function(e){switch(e.code){case"FA_INVALID_VERIFY_CODE":i._renderError(o.t("setting/lbl_invalidCode"))}})},_formatMobileSafe:function(e){return null!=e?(e=e.toString().replace(/\D+/g,""),e.substr(0,4)+"****"+e.substr(e.length-4)):""},_destroy:function(){this.clearSendAgain&&this.clearSendAgain(),this.$main.removeClass("sms-verify-wrap"),k.superclass._destroy.call(this)}}),S=k.extend({initialize:function(e){S.superclass.initialize.call(this,e)},_sendVerifyCode:function(e,t){var n=this;e=i.isFunction(e)?e:i.noop,t=i.isFunction(t)?t:i.noop;var a,r;switch(this.verifyType){case b.UPDATE:a=c.prepareUpdateAuth,r={tempSid:this.tempSid,newType:v.SMS,cellNumber:this.model.cellNumber};break;case b.UNBIND:case b.VERIFY:a=c.prepareValidateAuth,r={trans:this.trans}}i.when(a(r)).then(function(t){f(t.tempSid)&&(n.tempSid=t.tempSid,e())},function(e){null!=e.code?n._renderError(h(e.code,{model:n.model})):n._renderError(o.t("setting/lbl_twofactorauth_sms_send_error")),t()})},_validateVerifyCode:function(e){var t,n,a=this;if(!f(this.tempSid))return!1;switch(this.verifyType){case b.UPDATE:t=c.updateAuth,n={tempSid:this.tempSid,verifyCode:e};break;case b.UNBIND:case b.VERIFY:t=c.validateAuth,n={tempSid:this.tempSid,verifyCode:e,trans:this.trans}}i.when(t(n)).then(function(e){console.log(e),a.verifyType===b.UNBIND?a._doUnbind(function(){a.next(a.tempSid),a._destroy()}):(a.next(a.tempSid),a._destroy())},function(e){null!=e.code?a._renderError(h(e.code,{model:a.model})):console.log("twofactorauth","can not validate auth info",e.toSring())})}}),T="m-setting-twofactorauth-verifybox",j=s.extend({attrs:{confirmCb:i.noop,cancelCb:i.noop,message:a.compile(y)(),confirmTpl:o.t("common/confirm"),cancelTpl:o.t("common/cancel"),verifyType:b.VERIFY,verifyTrans:g.UPDATE_AUTH,authType:null,authModel:null,tempSid:null},setup:function(){this.get("verifyType")===b.UNBIND?this.set("title",o.t("setting/lbl_twofactorauth_unbind_title")):this.set("title",o.t("setting/lbl_twofactorauth_vefify_title")),j.superclass.setup.call(this)},render:function(){j.superclass.render.call(this);var e=this.get("classPrefix"),t=this.element.find([".",e,"-operation"].join("")).eq(0);this.$message=this.element.find([".",e,"-message"].join("")).eq(0),this.$btnConfirm=t.find('[data-role="confirm"]').eq(0),this.$message.addClass(T),this.verifyIns=this._initVerifyContent(),this.on("confirm",function(){return this.$btnConfirm&&this.$btnConfirm.hasClass("disabled")?!1:void this.verifyIns.submit()}),this.on("cancel",function(){var e=this.get("cancelCb");this.verifyIns.cancel(),i.isFunction(e)?e()&&this.destroy():this.destroy()})},destroy:function(){j.superclass.destroy.call(this)},_initVerifyContent:function(){var e,t=this.get("authType"),n=this.get("authModel"),a={model:n,onSuccess:i.proxy(this._handleVerifySuccess,this),onError:i.proxy(this._handleVerifyError,this),$wrap:this.$message,verifyType:this.get("verifyType"),verifyTrans:this.get("verifyTrans")};switch(t){case v.DYNAMIC:e=new x(a);break;case v.OTP:a.toggleConfirm=i.proxy(this._toggleConfirmBtn,this),e=new C(a);break;case v.SMS:a.tempSid=this.get("tempSid"),e=new S(a);break;case"CellNumber":e=new k(a)}return e},_handleVerifySuccess:function(e){var t=arguments.length,n=this.get("confirmCb");i.isFunction(n)&&(t?t>1?n.apply(this,arguments):n.call(this,e):n.call(this)),this.verifyIns.cancel(),delete this.verifyIns,this.destroy()},_handleVerifyError:function(){},_toggleConfirmBtn:function(e){e="boolean"==typeof e?e:!1,e?this.$btnConfirm&&this.$btnConfirm.addClass("disabled"):this.$btnConfirm&&this.$btnConfirm.removeClass("disabled")}}),I=function(e){if(null==e)return!1;var t,n;if(i.isFunction(e))t=e,n=i.noop;else{if(!i.isPlainObject(e))return!1;t=e.next?e.next:i.noop,n=e.cancel?e.cancel:i.noop}var a,r,s=e.uiType?e.uiType:_.BOX,o=e.verifyType?e.verifyType:b.VERIFY,u=e.verifyTrans?e.verifyTrans:g.UPDATE_AUTH;i.when(d.checkCurrentDeviceIsAuthorized(),c.initAuthData()).then(function(e,c){var d=c.state;return e?(t(null),!1):null==d?(t(null),!1):d.type===v.DISABLED?(t(null),!1):(a=d.type,r=i.extend(!0,{},l.authModels[a],d),void(s===_.BOX&&new j({uiType:s,verifyType:o,verifyTrans:u,authType:a,authModel:r,confirmCb:t,cancelCb:n}).show()))},function(e){i.notify.error(e.toString())})},A=function(e){var t,n,a=e.model,r=e.uiType?e.uiType:_.BOX,s=e.verifyType?e.verifyType:b.VERIFY,o=e.tempSid?e.tempSid:"";return null==a?(console.log("can not verify without model!"),!1):(t=e.next?e.next:i.noop,n=e.cancel?e.cancel:i.noop,void(r===_.BOX&&new j({tempSid:o,verifyType:s,uiType:r,authType:a.type,authModel:a,confirmCb:t,cancelCb:n}).show()))},E=function(e){var t=l.authModels.SMS,n=e.cellNumber?e.cellNumber:null;return null==n?(console.log("missing cellNumber param when validate."),!1):(e.model=i.extend(!0,{},t,{type:"CellNumber",cellNumber:n}),void A(e))};n.exports={initVerify:I,initVerifyWithModel:A,validateMobile:E,verifyTypes:b,uiTypes:_,verifyTrans:g}})}(),define("components/requirejs-text/text!template/module/setting/account/password/index.tpl.html",[],function(){return'<section class="m-password">\r\n    <div class="main-wrapper">\r\n        <div class="content-wrapper">\r\n            <!-- -->\r\n            <div class="grid-col12 j-pwd-info"></div>\r\n        </div>\r\n\r\n        <!--[if lt IE 9]>\r\n        <div class="sg-mask"></div>\r\n        <![endif]-->\r\n        \r\n        <!--  -->\r\n        <div class="panel u-scroll edit-panel u-pass-edit">\r\n            <div class="j-pwd-edit"></div>\r\n        </div>\r\n        <!-- -->\r\n        <div class="panel u-scroll client-panel u-client-pwd"></div>\r\n\r\n    </div>\r\n\r\n  {{#raw}}\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="passSetTpl">\r\n      <div class="u-pass-info">\r\n          <div class="u-form-item">\r\n              <div class="f-fl">\r\n                  <label class="u-form-label f-mgr">[[i18n "pref/password/userid"]]</label>\r\n              </div>\r\n              <div class="u-form-value account">\r\n                [[policySet.dnEmail]]\r\n              </div>\r\n          </div>\r\n          <div class="u-form-item">\r\n              <label class="u-form-label f-mgr">[[i18n "setting/lbl_accountPassword"]]</label>\r\n              <button class="u-btn u-btn-default" data-action="editPwd">[[i18n "setting/op_update_pwd"]]</button>\r\n          </div>\r\n          <!-- -->\r\n          [[#if policySet.isEnablePasswordAge]]\r\n          <div class="u-form-item">\r\n              <label class="u-form-label f-mgr">[[i18n "setting/lbl_passwordExpiryTime"]]</label>\r\n              <div class="item-value">\r\n                  [[#if policySet.password_expiry_time]]\r\n                   [[formatDate policySet.password_expiry_time]]\r\n                  [[else]]\r\n                    [[#compare policySet.passwordAge \'==\' 0]]\r\n                       [[i18n "setting/lbl_expiry_forever"]]\r\n                    [[else]]\r\n                       [[i18n "prop:setting/lbl_expiry_after_days" 0=policySet.passwordAge]]\r\n                    [[/compare]]\r\n                  [[/if]]\r\n                  [[#if notifyBeforeExpiry]]<span class="expiry_notify">[[i18n "setting/lbl_changePwdBeforeExpiryNotify"]]</span>[[/if]]\r\n              </div>\r\n          </div>\r\n          [[/if]]\r\n\r\n          <!-- -->\r\n          [[#if useStaticPwdAuth]]\r\n          <div class="u-form-item">\r\n              <div class="f-fl">\r\n                  <label class="u-form-label f-mgr">[[i18n "pref/password/lbl_staticpwd"]]:</label>\r\n              </div>\r\n              <div class="u-form-value">\r\n                  [[#if policySet.staticpwd]]\r\n                  <span class="j-static-pwd"></span>\r\n                  <span class="j-static-set">\r\n                      <button data-action="generatePwd" class="u-btn u-btn-default f-mgl" > [[i18n "setting/op_reset"]] </button>\r\n                      <button data-action="closeStaticPwd" class="u-btn u-btn-default f-mgl" > [[i18n "setting/op_cancel"]] </button>\r\n                  </span>\r\n                  [[else]]\r\n                  <span class="j-static-pwd">[[i18n \'pref/password/hint_staticpwd\']]</span>\r\n                  <span class="j-static-set">\r\n                      <button data-action="generatePwd" class="u-btn u-btn-default f-mgl" >[[i18n "setting/op_generate"]]</button>\r\n                  </span>\r\n                  [[/if]]\r\n              </div>\r\n          </div>\r\n          [[/if]]\r\n      </div>\r\n\r\n  </script>\r\n\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="passEditTpl">\r\n      <form action="#" method="post" name="changePwd" class="u-form" onsubmit="return false;">\r\n          <div class="u-btns-top">\r\n              <button type="button" data-action="changePwd" disabled class="u-btn u-btn-primary">{{i18n "setting/op_save"}}</button>\r\n              <button type="reset" class="u-btn u-btn-default " data-action="cancel">{{i18n "setting/op_cancel"}}</button>\r\n          </div>\r\n          <h4>{{i18n "setting/lbl_passwordSet"}}</h4>\r\n\r\n          <div class="u-form-item j-oldPwd">\r\n              <label class="u-form-label">{{i18n "pref/password/curpass"}}</label>\r\n              <input type="password" class="u-input" name="oldPassword">\r\n              <div class="notify f-dn">\r\n                  [[i18n \'pref/password/failedMod\']]\r\n              </div>\r\n          </div>\r\n\r\n\r\n          <div class="u-form-item j-newPwd f-pr">\r\n              <label class="u-form-label">{{i18n "pref/password/newpass"}}</label>\r\n              <input type="password" class="u-input" name="newPassword">\r\n              <div class="notify j-strength-hint f-dn"></div>\r\n              <div class="pwd-tip-popover j-pwd-tips f-dn"></div>\r\n          </div>\r\n\r\n          <div class="u-form-item">\r\n              <label class="u-form-label">{{i18n "setting/lbl_confirmPassword"}}</label>\r\n              <input type="password" class="u-input" name="rePassword">\r\n              <div class="notify f-dn">{{i18n "pref/password/mustsame"}}</div>\r\n          </div>\r\n\r\n          [[#if isEnablePasswordAge]]\r\n          [[#compare passwordAge "==" 0]]\r\n          <div class="u-form-item">\r\n              <label class="u-form-label">{{i18n "pref/password/passworkage"}}</label>\r\n              <select class="u-input" name="passwordAge:number" id="passwordAge">\r\n                  <option value="0">  {{i18n "pref/password/passworkage_forever"}}</option>\r\n                  <option value="7"> {{i18n "pref/password/passworkage_1w"}}   ([[countDown \'7\']])</option>\r\n                  <option value="30"> {{i18n "pref/password/passworkage_1m"}}  ([[countDown \'30\']])</option>\r\n                  <option value="90"> {{i18n "pref/password/passworkage_3m"}}  ([[countDown \'90\']])</option>\r\n                  <option value="180">{{i18n "pref/password/passworkage_6m"}}  ([[countDown \'180\']])</option>\r\n                  <option value="365">{{i18n "pref/password/passworkage_12m"}} ([[countDown \'365\']])</option>\r\n              </select>\r\n              <span class="expiry_desc">[[i18n \'setting/lbl_changePwdBeforeExpiry\']]</span>\r\n          </div>\r\n          [[/compare]]\r\n          [[/if]]\r\n      </form>\r\n  </script>\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="clientPwd">\r\n      <form action="#" method="post" name="generateClientPwd" class="u-form" onsubmit="return false;">\r\n          <div class="u-btns-top">\r\n              <button type="button" data-action="saveStaticPwd" disabled class="u-btn u-btn-primary">{{i18n "setting/op_save"}}</button>\r\n              <button type="reset" class="u-btn u-btn-default" data-action="cancel">{{i18n "setting/op_back"}}</button>\r\n          </div>\r\n          <h4>{{i18n "setting/lbl_generateClientPwd"}}</h4>\r\n\r\n          <div class="u-form-item f-mgb">\r\n              <label class="u-form-label">{{i18n "setting/lbl_userPassword"}}&nbsp;:</label>\r\n              <input type="password" class="u-input j-user-pwd" name="password">\r\n          </div>\r\n\r\n          <div class="u-form-item">\r\n              <label class="u-form-label">{{i18n "setting/lbl_generatePwd"}}&nbsp;:</label>\r\n              <div class="j-client-pwd f-ib"></div>\r\n              <button type="button" class="u-btn u-btn-primary j-generate-btn f-vat" data-action="generate">{{i18n "setting/lbl_generatePwd"}}</button>\r\n          </div>\r\n      </form>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="pwdStrengthTpl">\r\n      <ul class="rule-list">\r\n          <li><i class="iconfont [[showIcon result \'isMatchMinLength\']]"></i><span>[[i18n "prop:setting/lbl_acctountPwdMinLength" 0=requireLength]]</span></li>\r\n          [[#if notRepetition]]\r\n          <li><i class="iconfont [[showIcon result \'isNotRepetition\']]"></i><span>[[i18n "setting/lbl_norepetiton"]]</span></li>\r\n          [[/if]]\r\n          [[#if notSameAsUserId]]\r\n          <li><i class="iconfont [[showIcon result \'isNotSameAsAlias\']]"></i><span>[[i18n "setting/lbl_noSameAsUserID"]]</span></li>\r\n          [[/if]]\r\n          [[#if notSequential]]\r\n          <li><i class="iconfont [[showIcon result \'isNotSequential\']]"></i><span>[[i18n "setting/lbl_noSequential"]]</span></li>\r\n          [[/if]]\r\n          [[#if notWeakPassword]]\r\n          <li><i class="iconfont [[showIcon result \'isNotWeakPassword\']]"></i><span>[[i18n "setting/lbl_noConatinInWeakList"]]</span></li>\r\n          [[/if]]\r\n          [[#if specialCharacterCount]]\r\n          <li><i class="iconfont [[showIcon result \'isContainSpecChar\']]"></i><span>[[i18n "prop:setting/lbl_specialCharacterRequire" 0=specialCharacterCount]]</span></li>\r\n          [[/if]]\r\n      </ul>\r\n      <div class="u-pwd-stength [[#if strength]] [[strength]][[/if]]">\r\n          <span class="pillar pillar1"></span>\r\n          <span class="pillar pillar2"></span>\r\n          <span class="pillar pillar3"></span>\r\n          <span class="pillar pillar4"></span>\r\n      </div>\r\n  </script>\r\n\r\n  {{/raw}}\r\n</section>\r\n'}),define("module/setting/account/password/index",["require","util/i18n!setting,pref/password,error","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/dialog/confirmbox","cui/ui/select/select","../../../../util/index","module/common/globalService","./../../service","moment","../../../../util/pwdvalidator","../../../../configurable/index","../../security/twofactorauth/verify","text!template/module/setting/account/password/index.tpl.html"],function(e){function t(e,t){return(t.match(/\bswitched\S+/g)||[]).join(" ")}e("util/i18n!setting,pref/password,error");var n=e("jquery"),i=e("cui/core/view/view"),a=e("cui/core/view/viewmanager"),r=e("cui/util/templatable/templatable"),s=e("cui/ui/dialog/confirmbox"),o=e("cui/ui/select/select"),l=e("../../../../util/index"),c=e("module/common/globalService"),d=e("./../../service"),u=e("moment"),p=e("../../../../util/pwdvalidator"),m=e("../../../../configurable/index"),h=l.i18n,f=e("../../security/twofactorauth/verify"),v=i.extend({Implements:r,events:{"click [data-action]":"_dispatchAction",'blur input[name="rePassword"]':"_checkInputValue","click form .u-input":"_checkUserEdit",'keyup input[name="newPassword"]':"_showCheckStatus",'focus input[name="newPassword"]':"_handleShowPwdStrength",'blur input[name="newPassword"]':"_handleHidePwdStrength"},templateHelpers:{formatDate:function(e){return u(e).format("YYYY-MM-DD")},countDown:function(e){return u().add(e,"days").format("YYYY-MM-DD")+h.t("setting/lbl_expiry")},showIcon:function(e,t){return e&&"undefined"!=e[t]?e[t]?"iconchoose":"icontabclose":"iconround"}},setup:function(){this.config=m("setting.account.password"),this._params={policySet:{isEnablePasswordAge:this.config.isEnablePasswordAge},useStaticPwdAuth:this.config.useStaticPwdAuth},this.validator=null,this.twoFactorAuthTempSid=null},render:function(){v.superclass.render.call(this),this._initView()},_initView:function(){var e,t=this,i=[];t.element.mask(),i.push("password_expiry_time"),t.config.useStaticPwdAuth&&i.push("staticpwd"),n.when(d.getPasswordPolicy(),d.getAttrs(i)).then(function(i,a){a.authkeyid&&a.bindauthkey&&n.extend(t._params.policySet,{bindAuthKeyEnable:!0}),a.password_expiry_time&&(t._params.notifyBeforeExpiry=u(a.password_expiry_time).subtract(7,"days").isBefore(Date.now(),"day")),n.extend(t._params.policySet,i,a),t.validator=new p(i),t._params.policySet.passwordAge=i.passwordAge,e=t.compile(t.$("#passSetTpl").html(),t._params),t.$(".j-pwd-info").html(e),t.element.mask("hide")})},_dispatchAction:function(e,t){var i=n(t).data("action");switch(i){case"editPwd":this._handleEditPassword();break;case"cancel":this._handleClosePanel();break;case"changePwd":this._handleChangePwd();break;case"generatePwd":this._handleShowGeneratePwd();break;case"generate":this._handleGeneratePwd();break;case"saveStaticPwd":this._handleSaveStaticPwd();break;case"closeStaticPwd":this._handleCloseStaticPwd()}},_handleEditPassword:function(){var e=this,n=this._params.policySet,i=function(i){e.twoFactorAuthTempSid=i,d.auth2continue(c.getLockOpValues().updatePwd).then(function(){var i=e.compile(e.$("#passEditTpl").html(),n);e.$(".j-pwd-edit").html(i),n.isEnablePasswordAge&&0==n.passwordAge&&new o({classPrefix:"u-select",trigger:e.$("#passwordAge"),style:{width:230}}).render(),e._generatePwdValidateRules(),e.$(".main-wrapper").removeClass(t).addClass("switched-edit"),e.editFlag=!1})};f.initVerify({next:i,uiType:f.uiTypes.BOX,verifyType:f.verifyTypes.VERIFY,verifyTrans:f.verifyTrans.CHANGE_PWD})},_generatePwdValidateRules:function(){var e,t,n=this._params.policySet.minStrength,i=this._params.policySet.requireLength;switch(n){case"WEAK":e={requireLength:i.WEAK,notWeakPassword:!0};break;case"FAIR":e={requireLength:i.FAIR,notRepetition:!0,notSameAsUserId:!0,notSequential:!0,notWeakPassword:!0};break;case"GOOD":e={requireLength:i.GOOD,notSameAsUserId:!0,notWeakPassword:!0,specialCharacterCount:2};break;case"STRONG":e={requireLength:i.STRONG,notSameAsUserId:!0,notWeakPassword:!0,specialCharacterCount:3}}this._params.options=e,t=this.compile(this.$("#pwdStrengthTpl").html(),e),this.$(".j-pwd-tips").html(t)},_showCheckStatus:function(e,t){var i,a=n(t).val(),r={},s=this,o=!1;r.result=this.validator.getPasswordRulesMatch(a),r.strength=this.validator.getPasswordStrength(a),n.extend(r,this._params.options),i=this.compile(this.$("#pwdStrengthTpl").html(),r),this.$(".j-pwd-tips").html(i),n.each(r.result,function(e,t){return void 0==t||t?void 0:(o=!0,s.$(".j-strength-hint").html(s.$(".rule-list").find(".icontabclose").first().siblings().text()),s.$("[data-action=changePwd]").prop("disabled",!0),s.$(".j-newPwd").addClass("error"),!1)}),o||(s.$(".j-newPwd").removeClass("error"),s.$("[data-action=changePwd]").prop("disabled",!1))},_handleClosePanel:function(){this.$(".main-wrapper").removeClass(t),this.editFlag=!1},_handleShowGeneratePwd:function(){var e=this.compile(this.$("#clientPwd").html());this.$(".u-client-pwd").html(e),this.editFlag=!1,this.$(".main-wrapper").removeClass(t).addClass("switched-client")},_handleChangePwd:function(){var e=this,i=e.$("form[name='changePwd']").serializeJSON();return i.oldPassword?i.newPassword?i.newPassword!==i.rePassword?(this.$("input[name='rePassword']").parent().addClass("error"),void n.notify.error(h.t("pref/password/mustsame"))):this.config.isRejectConsistentPwd&&i.newPassword==i.oldPassword?void n.notify.error(h.t("pref/password/mustDifferentPass")):(delete i.rePassword,null!=this.twoFactorAuthTempSid&&(i.tempSid=this.twoFactorAuthTempSid),void d.changePassword(i).then(function(a){switch(a.code){case"S_OK":n.notify.success(h.t("pref/password/successMod")),l.cache.setItemWithLocal("cm_setting",{passwordAge:i.passwordAge}),e._initView(),e.$(".main-wrapper").removeClass(t);break;case"FA_USER_IN_GRAYLIST":n.notify.error(h.t("error/FA_USER_IN_GRAYLIST"));break;case"FA_UNAUTHORIZED":n.notify.error(h.t("pref/password/failedMod")),e.$(".j-oldPwd").addClass("error");break;case"FA_PASSWORD_TOO_WEAK":var r=h.t("setting/lbl_"+a.minStrength.toLowerCase()),s=h.t("setting/msg_passwordTooWeak"),o=l.messageFormat.format(s,r);n.notify.error(o),e.$(".j-strength-hint").html(o),e.$(".j-newPwd").addClass("error")}})):void n.notify.error(h.t("pref/password/mustpass")):void n.notify.error(h.t("pref/password/mustoldpass"))},_handleGeneratePwd:function(){var e,t;return this.$("button[data-action='saveStaticPwd']").prop("disabled",!1),this.$(".j-user-pwd").val()?(e=this.validator.rndPassword(16,!0,!0,!0,!0),t='<span class="client-pwd">{{value}} </span><input type="hidden" value="{{value}}" name="staticpwd">',this.$(".j-generate-btn").html(h.t("setting/lbl_regeneratePwd")),void this.$(".j-client-pwd").html(this.compile(t,{value:e}))):void s.alert(h.t("pref/password/mustoldpass"))},_handleSaveStaticPwd:function(){var e=this.$('form[name="generateClientPwd"]').serializeJSON(),n=this;c.updateUser(e).then(function(){var i='<a href="javascript:void(0)" class="f-mgl" data-action="generatePwd">'+h.t("setting/op_reset")+'</a><a href="javascript:void(0)" class="f-mgl" data-action="closeStaticPwd">'+h.t("setting/op_cancel")+"</a>";n.$(".j-static-pwd").html(e.staticpwd),n.$(".j-static-set").html(i),n.$(".main-wrapper").removeClass(t)},function(){s.alert(h.t("setting/msg_easWrongPass"))})},_handleCloseStaticPwd:function(){var e=this,t="<div class ='diaglog-item'><label class='label'>"+h.t("pref/password/curpass")+"</label>&nbsp;&nbsp;&nbsp;<input type='password' class='u-input j-password' style='padding:2px 4px' name='password'/><p class='u-form-explain j-explain'></p></div>";s.confirm(t,n.noop(),n.noop(),{onConfirm:function(){var t=this.$(".j-password").val(),n=this;c.updateUser({password:t,staticpwd:""}).then(function(){e._initView(),n.hide()})}})},_checkInputValue:function(e,t){var i=this.$("input[name='rePassword']").val(),a=this.$("input[name='newPassword']").val();n(t).parent().toggleClass("error",i!==a)},_checkUserEdit:function(){this.editFlag?this.$(".u-form-item").removeClass("error"):(this.$("button[data-action]").prop("disabled",!1),this.editFlag=!0)},_handleShowPwdStrength:function(){this.$(".pwd-tip-popover").show()},_handleHidePwdStrength:function(){this.$(".pwd-tip-popover").hide()}});a.module({name:"setting.account.password",template:e("text!template/module/setting/account/password/index.tpl.html")},v)}),define("widget/validate/validate",["require","jquery"],function(e){var t=e("jquery"),n=/^(.+?)\[(.+)\]$/,i=/^[0-9]+$/,a=/^\-?[0-9]+$/,r=/^\-?[0-9]*\.?[0-9]+$/,s=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,o=/^[a-z]+$/i,l=/^[a-z0-9]+$/i,c=/^[a-z0-9_\-]+$/i,d=/^[0-9]+$/i,u=/^[1-9][0-9]*$/i,p=/^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})$/i,m=/[^a-zA-Z0-9\/\+=]/i,h=/^[\d\-\s]+$/,f=/^((http|https):\/\/(\w+:{0,1}\w*@)?(\S+)|)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/,v=/^\(?\d{3,4}\)?\s?\-?\d{7,8}$|^\+?\d+$|^\+?\d+\s?\d+$/,g=/^\d{4}-\d{1,2}-\d{1,2}$/,b=function(e,t){var n,i;{if(!(e.length>0)||"radio"!==e[0].type&&"checkbox"!==e[0].type)return e[t];for(n=0,i=e.length;i>n;n++)if(e[n].checked)return e[n][t]}},_=function(e){if(!e.match("today")&&!e.match(g))return!1;var t,n=new Date;return e.match("today")||(t=e.split("-"),n.setFullYear(t[0]),n.setMonth(t[1]-1),n.setDate(t[2])),n},y=function(e,t,n){this.callback=n||function(){},this.errors=[],this.fields={},this.form=this._formByNameOrNode(e)||{},this.messages={};for(var i=0,a=t.length;a>i;i++){var r=t[i];if((r.name||r.names)&&r.rules)if(r.names)for(var s=0,o=r.names.length;o>s;s++)this._addField(r,r.names[s]);else this._addField(r,r.name)}var l=this.form.onsubmit;this.form.onsubmit=function(e){return function(t){try{return e._validateForm(t)&&(void 0===l||l());
}catch(n){}}}(this)};y.validators={required:function(e){var t=e.value;return"checkbox"===e.type||"radio"===e.type?e.checked===!0:null!==t&&""!==t},"default":function(e,t){return e.value!==t},matches:function(e,t){var n=this.form[t];return n?e.value===n.value:!1},valid_email:function(e){return s.test(e.value)},valid_date:function(e){return g.test(e.value)},valid_companyPhone:function(e){return v.test(e.value)},valid_emails:function(e){for(var t=e.value.split(/\s*,\s*/g),n=0,i=t.length;i>n;n++)if(!s.test(t[n]))return!1;return!0},min_length:function(e,t){return i.test(t)?e.value.length>=parseInt(t,10):!1},max_length:function(e,t){return i.test(t)?e.value.length<=parseInt(t,10):!1},exact_length:function(e,t){return i.test(t)?e.value.length===parseInt(t,10):!1},greater_than:function(e,t){return r.test(e.value)?parseFloat(e.value)>parseFloat(t):!1},less_than:function(e,t){return r.test(e.value)?parseFloat(e.value)<parseFloat(t):!1},alpha:function(e){return o.test(e.value)},alpha_numeric:function(e){return l.test(e.value)},alpha_dash:function(e){return c.test(e.value)},numeric:function(e){return i.test(e.value)},integer:function(e){return a.test(e.value)},decimal:function(e){return r.test(e.value)},is_natural:function(e){return d.test(e.value)},is_natural_no_zero:function(e){return u.test(e.value)},valid_ip:function(e){return p.test(e.value)},valid_base64:function(e){return m.test(e.value)},valid_url:function(e){return f.test(e.value)},valid_credit_card:function(e){if(!h.test(e.value))return!1;for(var t=0,n=0,i=!1,a=e.value.replace(/\D/g,""),r=a.length-1;r>=0;r--){var s=a.charAt(r);n=parseInt(s,10),i&&(n*=2)>9&&(n-=9),t+=n,i=!i}return t%10===0},is_file_type:function(e,t){if("file"!==e.type)return!0;var n=e.value.substr(e.value.lastIndexOf(".")+1),i=t.split(","),a=!1,r=0,s=i.length;for(r;s>r;r++)n==i[r]&&(a=!0);return a},greater_than_date:function(e,t){var n=_(e.value),i=_(t);return i&&n?n>i:!1},less_than_date:function(e,t){var n=_(e.value),i=_(t);return i&&n?i>n:!1},greater_than_or_equal_date:function(e,t){var n=_(e.value),i=_(t);return i&&n?n>=i:!1},less_than_or_equal_date:function(e,t){var n=_(e.value),i=_(t);return i&&n?i>=n:!1}},y.prototype={constructor:y,_formByNameOrNode:function(e){return"object"==typeof e?e:document.forms[e]},_addField:function(e,t){this.fields[t]={name:t,message:e.message||"",display:e.display||"",rules:e.rules,id:null,element:null,type:null,value:null,checked:null}},_validateForm:function(e){var t,n,i;this.errors=[];for(t in this.fields)this.fields.hasOwnProperty(t)&&(n=this.fields[t]||{},i=this.form[n.name],i&&void 0!==i&&(n.id=b(i,"id"),n.element=i,n.type=i.length>0?i[0].type:i.type,n.value=b(i,"value"),n.checked=b(i,"checked"),this._validateField(n)));return"function"==typeof this.callback&&this.callback(this.errors,e),this.errors.length>0&&(e&&e.preventDefault?e.preventDefault():event&&(event.returnValue=!1)),!0},_validateField:function(e){var i,a,r,s,o,l,c,d,u,p;if("string"==typeof e.rules?(i=e.rules.split("|"),r=e.rules.indexOf("required")):a=e.rules,s=!e.value||""===e.value||void 0===e.value,o=!1,a)o=a.call(this,e);else for(l=0,c=i.length;c>l&&(d=i[l],p=n.exec(d),-1===r&&s||(p&&(d=p[1],u=p[2]),"!"===d.charAt(0)&&(d=d.substring(1,d.length)),"function"==typeof y.validators[d]&&(y.validators[d].apply(this,[e,u])||(o=!0)),!o));l++);o&&("function"==typeof e.display?e.display.call(this,e.message):e.display&&t(this.form).find(e.display).html(e.message),this.errors.push({id:e.id,element:e.element,name:e.name,message:e.message,rule:d}))}},t.fn.validate=function(e,t){return this.each(function(){new y(this,e,t)})}}),define("module/setting/account/personal/service",["require","jquery","../../../../util/index","module/common/globalService","jquery.iframeTransport"],function(e){function t(e){var t=s.getConfig("user.schema"),n=a.Deferred();return e="boolean"==typeof e?e:!0,t&&!e&&n.resolve(t),r.xhr.simpleCall({query:{func:"user:getSchema",sid:s.getSid()},data:{id:"Personal",withValue:!0}},function(e){t=e,n.resolve(e)},function(){n.reject()}),n.promise()}function n(e,t){var n,i=a.Deferred();return n=t?{query:{func:"user:setAttrs",sid:s.getSid()},data:{avatarChangeStatus:e}}:{query:{func:"user:addHeadImageStd",sid:s.getSid()},data:{temp:0}},r.xhr.simpleCall(n,function(e){i.resolve(e)},function(){i.reject()}),i.promise()}function i(e){var t=a.Deferred(),n={url:r.xhr.getFullRequestURL({url:"/XT5/jsp/mformdata.jsp",query:{func:"user:addHeadImageStd",sid:s.getSid(),temp:1}}),type:"post",files:e,useiframe:!0,contentType:!1};return a.ajax(n).complete(function(e){t.resolve(window.JSON.parse(e.responseText))}).fail(function(){t.reject()}),t.promise()}var a=e("jquery"),r=e("../../../../util/index"),s=e("module/common/globalService");return e("jquery.iframeTransport"),{getUserSchema:t,saveAvatar:n,addAvatar:i}}),define("components/requirejs-text/text!template/module/setting/account/personal/index.tpl.html",[],function(){return'<section class="m-personal">\r\n\r\n  <div class="profile j-personal u-scroll">\r\n      <div class="u-profile"></div>\r\n      <div class="u-profile-edit f-dn"></div>\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="avtTpl">\r\n    <div class="u-avatar-dialog">\r\n      <form id="uploadform" action="jsp/mformdata.jsp?sid=[[sid]]&temp=1&func=user:addContactAvatarStd" enctype="multipart/form-data" method="post">\r\n        <div class="avt-tips">{{i18n "pref/personal/upload_avatar_tips"}}</div>\r\n        <div class="avt-content">\r\n          <div class="cnt-cropper j-cnt-cropper">\r\n          </div>\r\n          <div class="cnt-preview">\r\n            <div class="u-btn u-btn-primary">\r\n              <span>{{i18n "pref/personal/select_local_image"}}</span>\r\n              <input type="file" class="avt-upload j-avt-upload" name="signImgFile"/>\r\n            </div>\r\n            <div class="avt-preview j-preview">\r\n              <img alt="avatar" src="[[avtUrl]]" class="j-avatar j-preview-avatar"/>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class="avt-size">\r\n          {{i18n "pref/personal/upload_avatar_button_tips"}}\r\n        </div>\r\n      </form>\r\n    </div>\r\n  </script>\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="profiletpl">\r\n      <div class="u-btns-top">\r\n          <button data-action="edit"  class="u-btn u-btn-default">{{i18n \'setting/op_edit\'}}</button>\r\n      </div>\r\n      <div class="m-detail-box">\r\n          <div class="m-avatar u-img u-img-round">\r\n            <img alt="avatar" class="j-avatar" src="[[avtUrl]]"/>\r\n          </div>\r\n          <div class="m-list">\r\n             <div class="list-group">\r\n                <h4 class="nick-name-title">\r\n                  [[#and true_name true_name.value]]\r\n                    [[true_name.value]]\r\n                  [[^]]\r\n                    [[#and nick_name nick_name.value]]\r\n                      [[nick_name.value]]( [[nick_name.label]] )\r\n                    [[^]]\r\n                      [[emailAddr.value]]( [[emailAddr.label]] )\r\n                    [[/and]]\r\n                  [[/and]]\r\n                </h4>\r\n                [[#and gender gender.value]]\r\n                  <i class="iconfont [[#compare gender.value \'==\' \'1\']]iconwomen[[^]]iconman[[/compare]]"></i>\r\n                [[/and]]\r\n\r\n                 <table>\r\n\r\n                   [[#if forceSenderName]]\r\n                   <tr>\r\n                     <td>[[i18n "setting/lbl_forceSenderName"]]&nbsp;</td>\r\n                     <td>[[forceSenderName]]</td>\r\n                   </tr>\r\n                   [[/if]]\r\n\r\n                   [[#each schema]]\r\n                     [[#compare name \'!=\' \'gender\']]\r\n                       <tr>\r\n                         <td>[[label]]&nbsp;</td>\r\n                         <td>\r\n                           [[#is type \'in\' \'date,radio\']]\r\n\r\n                             [[#compare type \'==\' \'date\']]\r\n                               [[GetDateYMD value false]]\r\n                             [[/compare]]\r\n\r\n                             [[#compare type \'==\' \'radio\']]\r\n                               [[#each values]]\r\n                                 [[#compare @key \'==\' ../value]][[this]][[/compare]]\r\n                               [[/each]]\r\n                             [[/compare]]\r\n\r\n                           [[^]]\r\n                             [[isSet value]]\r\n                           [[/is]]\r\n                         </td>\r\n                       </tr>\r\n                     [[/compare]]\r\n                   [[/each]]\r\n                 </table>\r\n\r\n             </div>\r\n          </div>\r\n      </div>\r\n  </script>\r\n\r\n    <!---->\r\n  <script type="text/x-handlebars-template" id="profiletpl2">\r\n      <form method="post" name="profile" class="u-form" id="editAccount" onsubmit="return false">\r\n          <div class="u-btns-top">\r\n              <button type="button" class="u-btn u-btn-primary j-form-submit" disabled>{{i18n \'setting/op_save\'}}</button>\r\n              <button type="reset"  class="u-btn u-btn-default" data-action="cancel">{{i18n \'setting/op_cancel\'}}</button>\r\n          </div>\r\n            <!---->\r\n          <div class="title dotted">\r\n              <h4>[[i18n "setting/lbl_userGeneralInfo"]]</h4>\r\n          </div>\r\n\r\n          <div class="grid-row">\r\n              <div class="grid-col2 u-avatar u-img u-img-round">\r\n                  <img alt="avatar" class="j-avatar" src="[[avtUrl]]"/>\r\n                  <div>\r\n                      <a class="avt-change j-avt-change f-csp">[[i18n "setting/lbl_changeAvatar"]]</a>\r\n                  </div>\r\n              </div>\r\n              <div class="grid-col7">\r\n                  [[#each schema]]\r\n                  <div class="u-form-item">\r\n                      <label class="u-form-label">[[label]]</label>\r\n                      [[#is type \'in\' \'radio,textarea,select\']]\r\n\r\n                        [[#compare type \'==\' \'radio\']]\r\n                          [[#each values]]\r\n                            <span class="f-ib f-mgl">\r\n                              <input type="radio" class="u-input" name="[[../name]]" id="[[../name]]_[[@key]]" value="[[@key]]" [[#compare @key \'==\' ../value]]checked[[/compare]]/>\r\n                              <label for="[[../name]]_[[@key]]">[[this]]</label>\r\n                            </span>\r\n                          [[/each]]\r\n                        [[/compare]]\r\n\r\n                        [[#compare type \'==\' \'textarea\']]\r\n                          <textarea name="[[name]]" class="u-input [[#if readonly]]z-disabled[[/if]]" [[#if readonly]]disabled[[/if]]>[[value]]</textarea>\r\n                        [[/compare]]\r\n\r\n                        [[#compare type \'==\' \'select\']]\r\n                          [[#each values]]\r\n                            <select name="[[name]]" class="[[name]] u-input [[#if readonly]]z-disabled[[/if]]" [[#if readonly]]disabled[[/if]]></select>\r\n                          [[/each]]\r\n                        [[/compare]]\r\n\r\n                      [[^]]\r\n                        <input type=\'text\' class=\'u-input [[#compare type "==" "date"]]datepicker[[/compare]] [[#if readonly]]z-disabled[[/if]]\'\r\n                               name=\'[[name]]\' value=\'[[#compare type "==" "date"]][[GetDateYMD value true]][[^]][[value]][[/compare]]\'[[#if readonly]]disabled[[/if]] />\r\n                        [[#compare name \'==\' \'forceSenderName\']]\r\n                        <span class="f-db">[[i18n "setting/lbl_forceSenderNameDescription"]]</span>\r\n                        [[/compare]]\r\n                      [[/is]]\r\n                      <span class="u-form-explain f-dn"></span>\r\n                  </div>\r\n                  [[/each]]\r\n              </div>\r\n          </div>\r\n      </form>\r\n\r\n  </script>\r\n  {{/raw}}\r\n\r\n</section>\r\n\r\n\r\n'}),define("module/setting/account/personal/index",["require","util/i18n!setting,pref/personal","jquery.datepicker","jquery.imageCropper","jquery.validate","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","moment","util/index","module/common/globalService","../../../../util/province-city","./service","../../../../configurable/index","text!template/module/setting/account/personal/index.tpl.html"],function(e){function t(e){return e.type?/^image\/\w+$/.test(e.type):/\.(jpg|jpeg|png|gif)$/.test(e)}e("util/i18n!setting,pref/personal"),e("jquery.datepicker"),e("jquery.imageCropper"),e("jquery.validate");var n=e("jquery"),i=e("cui/core/view/view"),a=e("cui/core/view/viewmanager"),r=e("cui/util/templatable/templatable"),s=e("component/confirmbox"),o=e("moment"),l=e("util/index"),c=e("module/common/globalService"),d=e("../../../../util/province-city"),u=e("./service"),p=e("../../../../configurable/index"),m=i.extend({Implements:r,events:{"click form .radio":"_checkUserEdit","focus form :input":"_checkUserEdit","click [data-action]":"_dispatchAction","focus .datepicker":"_handleInitDatePicker","click .j-form-submit":"_handleFormSubmit"},setup:function(){this.state=c.getCurrentState(),this.config=p("setting.account.personal")},render:function(){m.superclass.render.call(this),this._initView()},_initView:function(e){var t=this;e=!!e,t.element.mask(),n.when(u.getUserSchema(),c.getUserAvatar()).then(function(i,a){t.avtUrl=a;var r={name:"area",label:l.i18n.t("setting/lbl_location"),type:"select",values:[],value:""},s=0,o=0,u=0,p=0,m=0,h=0,f=!1,v={emailAddr:{label:l.i18n.t("setting/lbl_emailAddress"),value:c.getUser().email}},g=!1,b=!1;if(n.each(i,function(e,t){switch(t.name){case"true_name":u=e,g=!!t.value,v.true_name={label:t.label,value:t.value};break;case"nick_name":p=e,b=!!t.value,v.nick_name={label:t.label,value:t.value};break;case"gender":v.gender={value:t.value},t.type="radio";break;case"address":case"remarks":t.type="textarea";break;case"province":s=e,m=t.value,r.values.push(t);break;case"city":o=e,h=t.value,r.values.push(t);break;case"security_level":case"user_security_role":case"sender_security_level":t=n.extend({},t),i[e]=t,t.value=t.values[t.value]}}),t.config.enableForceSenderName&&(v.forceSenderName=t.config.allEmails[0].name),2==r.values.length&&(r.value=d.out(m,h,t.config.locale),i.splice(s,1,r),i.splice(o,1),f=!0),e){if(t.config.enableForceSenderName&&i.splice(1,0,{readonly:!0,value:t.config.allEmails[0].name,label:l.i18n.t("setting/lbl_forceSenderName"),name:"forceSenderName"}),t.$(".u-profile-edit").html(t.compile(n("#profiletpl2").html(),{avtUrl:a,schema:i})),f){var _=t.$("select.province"),y=t.$("select.city");d.init(_,y,m,h,t.config.locale)}t.element.customRadioCheckbox(),t._initFormValidate(),t._initAvatarUpload()}else g&&i.splice(u,1),!g&&b&&i.splice(p,1),t.$("div.u-profile").html(t.compile(n("#profiletpl").html(),n.extend(v,{schema:i,avtUrl:a})))}).always(function(){t.element.mask("hide")})},_dispatchAction:function(e,t){var i=this,a=n(t).data("action");switch(a){case"edit":i._toggleView(),i._initView(!0);break;case"cancel":e.preventDefault(),i._toggleView()}},_initAvatarUpload:function(){var e,i,a=this,r=l.detector.supportBlobURL()&&l.detector.supportAjaxUpload(),o=this.$("img.j-avatar");this.$(".j-avt-change").on("click",function(){var d=a.compile(a.$("#avtTpl").html(),{avtUrl:a.avtUrl,sid:c.getSid()});s.confirm(d,function(){r?(e=a.$("div.j-cnt-cropper > img").cropper("getCroppedCanvas",{width:132,height:132}),i=e.toDataURL("image/jpeg"),a.dataUrl=i,o.attr("src",i)):c.getUserAvatar(!0).then(function(e){o.attr("src",e),a.dataUrl=e})},n.noop(),{title:l.i18n.t("setting/lbl_uploadAvatar"),effect:"fade",parentNode:"div.profile"}),a.$(".j-avt-upload").change(function(){var e,i,o,d;r?(e=n(this).prop("files"),e.length>0&&(i=e[0]),t(i)?(a.$("div.avt-tips").empty(),o=window.URL.createObjectURL(i),d=n('<img src="'+o+'"/>'),a.$("div.j-cnt-cropper").empty().html(d),d.cropper({aspectRatio:1,preview:a.$("div.j-preview").selector,minContainerWidth:200,minContainerHeight:200,zoomable:!1})):s.alert(l.i18n.t("setting/msg_invalidImageType"))):u.addAvatar(n(this)).then(function(e){"S_OK"===e.code?c.getUserAvatar(!0).then(function(e){a.$(".j-preview-avatar").attr("src",e)}):"FA_ATTR_SIZE_EXCEEDED"==e.code||"FA_FILE_SIZE_EXCEEDED"==e.code?s.alert(l.i18n.t("pref/imageSizeExceeded")):s.alert(l.i18n.t("common/FA_OTHER_CODE",{code:e.code}))})})})},_checkUserEdit:function(){this.$(".j-form-submit").prop("disabled",!1)},_handleInitDatePicker:function(e,t){n(t).datepicker()},_handleFormSubmit:function(){this.$("#editAccount").submit(),this.formInvalid||this._save()},_save:function(){var e,t=this,i=l.detector.supportBlobURL()&&l.detector.supportAjaxUpload();e=t.$("form[name='profile']").serializeJSON(),e.birthday=e.birthday&&o(e.birthday).format("YYYY-MM-DD HH:MM:SS"),e.anniversary=e.anniversary&&o(e.anniversary).format("YYYY-MM-DD HH:MM:SS"),n.when(c.updateUser(e,!0),t.dataUrl?u.saveAvatar(t.dataUrl,i):n.noop()).then(function(){n.notify(l.i18n.t("setting/msg_savesucceed")),t.dataUrl&&(n("img.j-avatar").attr("src",t.dataUrl),t.dataUrl=null),n(".j-truename").text(e.true_name),t._initView(),t._toggleView()})},_initFormValidate:function(){var e=this;e.$("#editAccount").validate([{name:"alt_email",rules:"valid_email"},{name:"anniversary",rules:"valid_date"},{name:"birthday",rules:"valid_date"},{name:"mobile_number",rules:"numeric"},{name:"company_phone",rules:"valid_companyPhone"},{name:"home_phone",rules:"numeric"},{name:"fax_number",rules:"numeric"}],function(t){e.formInvalid=t.length>0,e.formInvalid&&(e.$("#editAccount").find(".u-form-item").removeClass("error"),n.each(t,function(e,t){var i=l.i18n.t("setting/msg_"+t.name+"_err");n(t.element).parent().addClass("error").children(".u-form-explain").html(i)}))})},_toggleView:function(){this.$("div.u-profile").toggleClass("f-dn"),this.$("div.u-profile-edit").toggleClass("f-dn"),this.dataUrl&&(this._initView(),this.dataUrl=null)},templateHelpers:{GetDateYMD:function(e,t){return e?o(e).format("YYYY-MM-DD"):t?"":l.i18n.t("setting/msg_itemUnset")},isSet:function(e){return e?e:l.i18n.t("setting/msg_itemUnset")}}});a.module({name:"setting.account.personal",template:e("text!template/module/setting/account/personal/index.tpl.html")},m)}),define("components/requirejs-text/text!template/module/setting/account/question/index.tpl.html",[],function(){return'<section class="m-question">\r\n    <div class="main-wrapper">\r\n        <div class="content-wrapper j-question">\r\n            <div class="u-btns-top f-ib">\r\n                <button type="button" data-action="save" class="u-btn u-btn-primary" >{{i18n "setting/op_save"}}</button>\r\n            </div>\r\n            <form action="#" onsubmit="return false" class="j-form"></form>\r\n        </div>\r\n    </div>\r\n    {{#raw}}\r\n    <script type="text/x-handlebar-template" id="questionTpl">\r\n        [[#if isExist]]\r\n        <div class="title dotted top">\r\n            <h4>[[i18n \'setting/lbl_question_tip1\']]</h4>\r\n        </div>\r\n        <div class="wrapper">\r\n            <div class="label">[[i18n \'setting/lbl_question_birthday\']]:</div>\r\n            <div class="sub-wrapper">\r\n                <div class="input-wrapper">\r\n                    <input type="text" name="birthday" class="u-input" role="date"/>\r\n                    <label class="error f-dn j-oldbirthErr"></label>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class="wrapper">\r\n            <div class="label">[[i18n \'setting/lbl_question_issue\']]:</div>\r\n            <div class="sub-wrapper">\r\n                <div class="input-wrapper">\r\n                    <label>[[question]]</label>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class="wrapper">\r\n            <div class="label">[[i18n \'setting/lbl_question_answer\']]:</div>\r\n            <div class="sub-wrapper">\r\n                <div class="input-wrapper">\r\n                    <input type="text" name="answer" class="u-input"/>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        [[/if]]\r\n        <div class="title dotted top">\r\n            <h4>[[i18n \'setting/lbl_question_tip2\']]</h4>\r\n        </div>\r\n        <div class="wrapper">\r\n            <div class="label">[[i18n \'setting/lbl_question_birthday\']]:</div>\r\n            <div class="sub-wrapper">\r\n                <div class="input-wrapper">\r\n                    <input type="text" name="newbirthday" class="u-input" role="date"/>\r\n                    <label class="error f-dn j-newbirthErr"></label>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class="wrapper">\r\n            <div class="label">[[i18n \'setting/lbl_question_issue\']]:</div>\r\n            <div class="sub-wrapper">\r\n                <div class="input-wrapper">\r\n                    <input type="text" name="newquestion" class="u-input" placeholder="[[i18n \'setting/lbl_question_hint1\']]"/>\r\n                    <label class="error f-dn j-newquestionErr"></label>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class="wrapper">\r\n            <div class="label">[[i18n \'setting/lbl_question_answer\']]:</div>\r\n            <div class="sub-wrapper">\r\n                <div class="input-wrapper">\r\n                    <input type="text" name="newanswer" class="u-input" placeholder="[[i18n \'setting/lbl_question_hint2\']]"/>\r\n                    <label class="error f-dn j-newanswerErr"></label>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </script>\r\n    {{/raw}}\r\n</section>'}),define("module/setting/account/question/index",["require","util/i18n!setting","jquery","util/index","cui/core/view/view","module/setting/service","cui/core/view/viewmanager","module/common/globalService","cui/util/templatable/templatable","text!template/module/setting/account/question/index.tpl.html"],function(e){e("util/i18n!setting");var t=e("jquery"),n=e("util/index"),i=e("cui/core/view/view"),a=e("module/setting/service"),r=e("cui/core/view/viewmanager"),s=e("module/common/globalService"),o=e("cui/util/templatable/templatable"),l=i.extend({Implements:o,events:{"click [data-action]":"_dispatchAction"},setup:function(){this.state=s.getCurrentState(),delete this.state.param.view,this.sendMessage("dispatcher","view:render",this.state)},render:function(){l.superclass.render.call(this),this._initialize(),this._initModuleEvent()},_initialize:function(){var e=this;a.getAttrs(["pwd_hint_question"]).then(function(t){var n=!1;t.pwd_hint_question&&(n=!0);var i=e.compile(e.$("#questionTpl").html(),{isExist:n,question:t.pwd_hint_question});e.$("form.j-form").html(i)})},_initModuleEvent:function(){var e=this;e.$("form.j-form").on("focus",'[role="date"]',function(){t(this).datepicker({dateFormat:"yyyy-mm-dd",autoClose:!0})}),e.on("hideErr",function(){e.$("label.error").hide().html("")}),e.on("showErr",function(t,n){e.$("label.j-"+t).html(n).show()})},_dispatchAction:function(e,n){var i=t(n).data("action");switch(i){case"save":this._handleUpdateQuestion()}},_handleUpdateQuestion:function(){var e=this,i=e.$("form.j-form").serializeJSON();e.trigger("hideErr"),a.setForgetPasswordAttrs(i).then(function(){t.notify(n.i18n.t("setting/msg_question_setSuccessfully")),e._initialize()},function(n){t.each(n.msg,function(n,i){"returnErr"!=n?e.trigger("showErr",n,i):t.notify.error(i)})})}});r.module({name:"setting.account.question",template:e("text!template/module/setting/account/question/index.tpl.html")},l)}),define("components/requirejs-text/text!template/module/setting/account/signature/index.tpl.html",[],function(){return'<section class="m-signature">\r\n\r\n    <div class="main-wrapper">\r\n        <div class="content-wrapper">\r\n            <div class="grid-col12 j-signature-box"></div>\r\n        </div>\r\n\r\n        <!--[if lt IE 9]>\r\n        <div class="sg-mask" />\r\n        <![endif]-->\r\n\r\n        <!---->\r\n        <div class="panel m-edit-sign"></div>\r\n    </div>\r\n\r\n    {{#raw}}\r\n    <script type="text/x-handlebars-template" id="signListTpl" >\r\n        <div class="title dotted">\r\n            <h4>[[i18n "pref/preference/signature_setting"]]</h4>\r\n        </div>\r\n        <div class="u-form-item">\r\n            <div class="f-fl">\r\n                <label class="u-form-label">[[i18n "pref/preference/signature_position_text"]]</label>\r\n            </div>\r\n            <div class="u-form-value">\r\n                <div class="u-form-explain">\r\n                    <div class="signature_position signature_position_0">\r\n                        <a>[[i18n "pref/preference/signature_position_v_0"]]</a>\r\n                      <span class="signature_position_img [[#compare signPref/signature_position \'==\' 0]] checked [[/compare]]" data-signPref = "0">\r\n                          <i class="iconfont iconchoose"></i>\r\n                      </span>\r\n                    </div>\r\n                    <div class="signature_position signature_position_1">\r\n                        <a>[[i18n "pref/preference/signature_position_v_1"]]</a>\r\n                        <span class="signature_position_img [[#compare signPref/signature_position \'==\' 1]] checked [[/compare]]" data-signPref = "1">\r\n                          <i class="iconfont iconchoose"></i>\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class="title dotted">\r\n            <h4>[[i18n "pref/preference/signature_setting"]]</h4>\r\n        </div>\r\n        <div>\r\n            <!---->\r\n            <div class="u-notify-top">\r\n                <button class="u-btn u-btn-primary j-toggle-panel" data-action="createSign" [[#compare privateSignCount \'==\' maxSignLimit]]disabled[[/compare]]>\r\n                    [[i18n "setting/op_addSignature"]]\r\n                </button>\r\n                <span id="signNotify" class="signNotify [[#compare privateSignCount \'==\' maxSignLimit]]maxLimit[[/compare]]">\r\n                    [[[i18n "prop:setting/msg_signatureOverView" 0=privateSignCount 1=maxSignLimit ]]]</span>\r\n            </div>\r\n            <div class="sign-box f-cb">\r\n                <!---->\r\n                <div class="sign-category">\r\n                    <ul>\r\n                        [[#each signatures]]\r\n                        <li class="u-switchable-content u-switchable-nav">\r\n                            <div class="panel-head u-switchable-trigger f-usn [[#compare isPublic \'==\' true]]modify[[/compare]] [[#if isDefault]] default-sign[[/if]]" data-sid="[[id]]" data-role="trigger">\r\n                                <i class="iconchoose iconfont j-default" data-action="setDefault" data-sid="[[id]]"></i>\r\n                                <a data-action="getSign" data-sign-id="[[id]]" data-type="[[#if isPublic]]public[[/if]]">\r\n                                    [[#if isPublic]]<span class="public-sign"> [[i18n "setting/lbl_publicSignature"]]</span>[[/if]]\r\n                                    <span class="signContent" title="[[name]]">[[name]]</span>\r\n                                    <span class="default-sign-text">( [[i18n \'setting/lbl_default_sign_text\']] )</span>\r\n                                </a>\r\n                               <div class="sign-opr">\r\n                                   <a class="link f-mgr f-csp" data-action="deleteSign" data-sid="[[id]]">[[i18n "pref/signature/btn_del"]]</a>\r\n                                   <a class="link f-mgr f-csp" data-action="editSign" data-sid="[[id]]">[[i18n "pref/signature/btn_update"]]</a>\r\n                               </div>\r\n                            </div>\r\n                            <!---->\r\n                            <div class="sign-overview panel-body u-switchable-panel f-dn" data-role="panel">\r\n                                <div id="panel_[[id]]" class="sign-content u-scroll">\r\n                                    [[#if isHtml]] [[[content]]] [[else]] <pre>[[[content]]]</pre> [[/if]]\r\n                                </div>\r\n                            </div>\r\n                        </li>\r\n                        [[/each]]\r\n                    </ul>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </script>\r\n\r\n    <script type="text/x-handlebars-template" id="editSignTpl">\r\n        <div class="u-btns-top">\r\n            <button type="button" data-action="[[#if sign.id]]updateSign[[else]]saveSign[[/if]]" class="u-btn u-btn-primary" >[[i18n "setting/op_confirm"]]</button>\r\n            <button type="reset"  data-action="cancel" class="u-btn u-btn-default">[[i18n "setting/op_cancel"]]</button>\r\n        </div>\r\n        <h4 class="sub-header">\r\n            [[#if typeCreate]]\r\n                [[i18n "setting/op_addSignature"]]\r\n            [[else]]\r\n                [[i18n "setting/lbl_editSignature"]]\r\n            [[/if]]\r\n            <span class="j-spare-size">[[[i18n "prop:setting/msg_signatureImageSpareSize" 0=spareSize]]]</span>\r\n        </h4>\r\n\r\n        <form name="editSign" class="u-form" onsubmit="return false;">\r\n            [[#if sign.id]]<input type="hidden" name="id:number" value="[[sign.id]]"/>[[/if]]\r\n            <div class="u-form-item">\r\n                <label class="u-form-label">[[i18n "setting/lbl_signatureName"]]&nbsp;:</label>\r\n                <input type="text" class="u-input j-sign-name" name="name" value="[[sign.name]]"  />\r\n            </div>\r\n            <div class="u-form-item">\r\n                <label class="u-form-label">[[i18n "setting/lbl_signatureContent"]]&nbsp;:</label>\r\n                <textarea name="content" id="sg-sign-editor">[[#if sign.content]][[[sign.content]]][[/if]]</textarea>\r\n            </div>\r\n            <input type="hidden" name="isHtml" value="[[sign.isHtml]]"/>\r\n        </form>\r\n    </script>\r\n    {{/raw}}\r\n</section>'}),define("module/setting/account/signature/index",["require","util/i18n!setting,pref/signature,pref/preference","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","../../../../component/editor/editor","../../../../util/index","module/common/globalService","./../../service","./service","../../../../configurable/index","text!template/module/setting/account/signature/index.tpl.html"],function(e){e("util/i18n!setting,pref/signature,pref/preference");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("component/confirmbox"),s=e("../../../../component/editor/editor"),o=e("../../../../util/index"),l=e("module/common/globalService"),c=e("./../../service"),d=e("./service"),u=e("../../../../configurable/index"),p=o.i18n,m=o.size,h=o.messageFormat,f=n.extend({Implements:a,render:function(){f.superclass.render.call(this),this._initView(!0)},events:{"click [data-action]":"_dispatchAction","click .signature_position_img":"_handleSaveSignPref"},setup:function(){this.state=l.getCurrentState(),this.config=u("setting.account.signature"),this.cache={editor:null,signatures:null,privateSignCount:null,spareSize:null,maxSignLimit:this.config.maxSignLimit}},_initView:function(e){var n,i=this,a=-1;e="boolean"===t.type(e)?e:!1,this.element.mask(),t.when(c.getAttrs("signature_position"),d.getSignatures()).then(function(r,s){t.each(s,function(e,t){return t.isDefault?(a=e,!1):void 0}),a>=0&&(n=s.splice(a,1),s.unshift(n[0])),i.cache.signPref=r,i.cache.signatures=s,i.cache.privateSignCount=t.grep(s,function(e){return e.isPublic===!1}).length,
i.$(".j-signature-box").html(i.compile(i.$("#signListTpl").html(),i.cache)),i.cache.signatures.length>0&&!i.focusId&&i.$("[data-action=getSign]").eq(0).trigger("click"),i.focusId&&i.$("[data-sign-id="+i.focusId+"]").click(),e||i.publish("signs:refresh",null),i._handleClearUnReferencedImages()}).always(function(){i.element.mask("hide")})},_togglePanel:function(){this.$(".main-wrapper").toggleClass("toggled")},_dispatchAction:function(e,n){var i=t(n).data("action");switch(i){case"createSign":this._handleCreateSign();break;case"deleteSign":this._handleDeleteSign(n);break;case"editSign":this._handleEditSign(n);break;case"saveSign":this._handleSaveSign();break;case"updateSign":this._handleUpdateSign();break;case"getSign":this._handleGetSign(n);break;case"setDefault":this._handleDefault(n);break;case"cancel":this._togglePanel(),this._handleClearUnReferencedImages();break;case"modeSwitch":this._handleEditorModeSwitch(n)}},_checkSignature:function(e){var n=t.trim(e.name),i=t.trim(e.content),a=!1,s=!1;if(!n)return r.alert(p.t("setting/msg_signatureNameEmpty")),!1;if(!i)return r.alert(p.t("pref/signature/content_empty")),!1;if(e.id){var o=t.grep(this.cache.signatures,function(t){return t.id==e.id})[0];o.name!==n&&(s=!0)}return(void 0===e.id||s)&&t.each(this.cache.signatures,function(e,i){return t.trim(i.name)===n?(a=!0,!1):void 0}),a?(r.alert(p.t("pref/signature/name_exist")),!1):!0},_handleGetSign:function(e){var n=t(e),i=n.parent().next(".panel-body");n.toggleClass("z-current"),i.toggleClass("f-dn")},_handleEditorModeSwitch:function(e){var n=this,i=this.cache.editor.designMode,a=this.cache.editor.html();i?this.cache.editor.isEmpty()?(this.cache.editor.clickToolbar("source"),this.$("input[name='isHtml']").val(!i),t(e).text(p.t("mail/compose_html")),this.$(".ke-toolbar >span").animate({width:"toggle"},200)):r.confirm(p.t("common/editor_html_source"),function(){n.cache.editor.clickToolbar("source"),a=o.html.html2text(a),n.cache.editor.html(a),n.$("input[name='isHtml']").val(!i),t(e).text(p.t("mail/compose_html")),n.$(".ke-toolbar > span").animate({width:"toggle"},200)}):(this.$("input[name='isHtml']").val(!i),this.cache.editor.clickToolbar("source"),a=o.html.text2html(a),this.cache.editor.html(a),t(e).text(p.t("compose/lb_plaintext")),this.$(".ke-toolbar > span").animate({width:"toggle"},200))},_handleDefault:function(e){var n=t(e).closest(".panel-head"),i=this.$(".panel-head"),a=!0;n.hasClass("default-sign")&&(a=!1),d.updateSignature({id:n.data("sid"),isDefault:a}).then(function(){a?(i.removeClass("default-sign"),n.addClass("default-sign"),t.notify.success(p.t("pref/signature/setsigndefault"))):(n.removeClass("default-sign"),t.notify.success(p.t("pref/signature/cancelsigndefault")))})},_handleDeleteSign:function(e){var n=this,i=t(e).data("sid"),a=t.grep(this.cache.signatures,function(e){return e.id==i})[0];r.confirm(h.format(p.t("setting/msg_signatureDeleteConfirm"),o.html.encode(a.name)),function(){d.deleteSignature(i).then(function(i){t(e).closest(".u-switchable-content").remove(),n.cache.signatures=i,n.cache.privateSignCount--,n._handleUpdateNotify(),t.notify.success(p.t("setting/msg_signatureRemoveSuccess")),n.publish("signs:refresh",{}),n.$(".u-switchable-trigger")[0]||n.$("#btn-group").hide(),n._handleImageSpareSize()})})},_handleCreateSign:function(){var e,n,i,a=this;return this.cache.privateSignCount>=this.cache.maxSignLimit?r.alert(h.format(p.t("pref/signature/overflow"),this.cache.maxSignLimit)):(e=1==this.config.editMode,n=this.compile(this.$("#editSignTpl").html(),{typeCreate:!0,sign:{isHtml:e},spareSize:this.cache.spareSize}),this.$(".m-edit-sign").html(n),i=o.xhr.getFullRequestURL({url:"XT5/jsp/upload.jsp",query:{func:"addSignatrueImage",sid:l.getSid()}}),this.cache.editor=s.create("#sg-sign-editor",{designMode:e,uploadJson:i,filePostName:"signImgFile",noDisableItems:["switch"],items:["bold","italic","underline","fontname","fontsize","forecolor","hilitecolor","image","|","plug-align","plug-order","plug-indent"],afterCreate:function(){e?this.toolbar.div.show():a.$(".ke-toolbar > span").hide(),this.statusbar.hide(),t(this.edit.doc).mousedown(function(){t(document).trigger("hide.menu")}),this.toolbar.div.click(function(){t(document).trigger("hide.menu")}),a.$(".ke-toolbar").append(t("<div />",{text:e?p.t("compose/lb_plaintext"):p.t("mail/compose_html"),"data-action":"modeSwitch","class":"ke-mode-toggle"}))},afterUpload:function(e){e.url=o.xhr.getRequestURL({query:{func:"user:getSignImageData",sid:l.getSid(),hashId:e.hashId}}),a._handleImageSpareSize(!0)}}),this._togglePanel(),this.$("[name='localUrl']").attr("name","signImgFile"),void setTimeout(function(){a.$(".j-sign-name").focus()},500))},_handleSaveSignPref:function(e,n){var i=this,a=t(n),r={signature_position:t(n).attr("data-signPref")};return a.hasClass("checked")?!1:void l.updateUser(r).then(function(){i.cache.signPref=r,i.$(".signature_position_img").removeClass("checked"),a.addClass("checked"),t.notify.success(p.t("setting/msg_prefUpdateSuccess"))})},_handleImageSpareSize:function(e){var t,n=this;e="boolean"==typeof e?e:!1,d.getSignImageSpareSize().then(function(i){n.cache.spareSize=m.bytesToSize(i,1),e&&(t=h.format(p.t("setting/msg_signatureImageSpareSize"),n.cache.spareSize),n.$(".j-spare-size").html(t))})},_handleClearUnReferencedImages:function(){var e=this;d.clearUnReferredImage().then(function(){e._handleImageSpareSize()})},_handleUpdateNotify:function(){var e=h.format(p.t("setting/msg_signatureOverView"),[this.cache.privateSignCount,this.cache.maxSignLimit]);this.$("#signNotify").html(e),this.$("#signNotify").removeClass("maxLimit"),this.$("[data-action=createSign]").attr("disabled",!1)},_handleEditSign:function(e){var n,i,a=this,r=t(e).data("sid"),c=t.grep(this.cache.signatures,function(e){return e.id==r})[0];n=this.compile(this.$("#editSignTpl").html(),{sign:c,spareSize:this.cache.spareSize}),this.$(".m-edit-sign").html(n),this._togglePanel(),i=o.xhr.getFullRequestURL({url:"XT5/jsp/upload.jsp",query:{func:"addSignatrueImage",sid:l.getSid()}}),this.cache.editor=s.create("#sg-sign-editor",{designMode:c.isHtml,uploadJson:i,filePostName:"signImgFile",items:["bold","italic","underline","fontname","fontsize","forecolor","hilitecolor","image","|","plug-align","plug-order","plug-indent"],afterCreate:function(){c.isHtml?this.toolbar.div.show():a.$(".ke-toolbar > span").hide(),this.statusbar.hide(),this.toolbar.div.click(function(){t(document).trigger("hide.menu")}),a.$(".ke-toolbar").append(t("<div />",{text:c.isHtml?p.t("compose/lb_plaintext"):p.t("mail/compose_html"),"data-action":"modeSwitch","class":"ke-mode-toggle"})),t(this.edit.doc).mousedown(function(){t(document).trigger("hide.menu")}),this.toolbar.div.click(function(){t(document).trigger("hide.menu")})},afterUpload:function(e){e.url=o.xhr.getRequestURL({query:{func:"user:getSignImageData",sid:l.getSid(),hashId:e.hashId}}),a._handleImageSpareSize(!0)}})},_handleUpdateSign:function(){var e,n=this;n.cache.editor.sync(),e=n.$("form[name='editSign']").serializeJSON({parseBooleans:!0}),e.isHtml||(e.content=n.cache.editor.text()),n._checkSignature(e)&&d.updateSignature(e).then(function(){n.focusId=e.id,n._initView(),n._togglePanel(),t.notify.success(p.t("setting/msg_signatureUpdateSuccess"))})},_handleSaveSign:function(){var e,n=this;n.cache.editor.sync(),e=n.$("form[name='editSign']").serializeJSON({parseBooleans:!0}),e.isHtml||(e.content=n.cache.editor.text()),n._checkSignature(e)&&d.createSignature(e).then(function(e){n.focusId=e[0],n._initView(),n._togglePanel(),t.notify.success(p.t("setting/msg_signatureCreateSuccess"))})}});i.module({name:"setting.account.signature",template:e("text!template/module/setting/account/signature/index.tpl.html")},f)}),define("components/requirejs-text/text!template/module/setting/advance/index.tpl.html",[],function(){return'<section class="m-sgadvance j-advance">\n    <nav class="nav u-tab u-tab-highlight-down">\n      <ul class="j-advance-nav"></ul>\n    </nav>\n\n    <div class="j-advance-content content">\n    </div>\n\n  {{#raw}}\n  <script type="text/x-handlebars-template" id="tabTpl">\n\n    [[#if mboxshare]]\n    <li data-trigger="advance.mboxshare">\n      <span class="bar"></span>\n      <a href="javascript:void(0)">{{i18n "setting/tab_mboxshare"}}</a>\n    </li>\n    [[/if]]\n\n    [[#if enablePopWebmailAgent]]\n    <li data-trigger="advance.pop">\n      <span class="bar"></span>\n      <a href="javascript:void(0)">{{i18n "setting/tab_popaccount"}}</a>\n    </li>\n    [[/if]]\n\n    [[#if enableSMSNotifySetting]]\n    <li data-trigger="advance.smsnotification">\n      <span class="bar"></span>\n      <a href="javascript:void(0)">{{i18n "setting/tab_smsnotification"}}</a>\n    </li>\n    [[/if]]\n\n    <li data-trigger="advance.pop3set">\n      <span class="bar"></span>\n      <a href="javascript:void(0)">{{i18n "setting/tab_pop3setting"}}</a>\n    </li>\n\n    [[#if isSupportSync]]\n    <li data-trigger="advance.mailpush">\n      <span class="bar"></span>\n      <a href="javascript:void(0)">{{i18n "pref/eas_device"}}</a>\n    </li>\n    [[/if]]\n\n\n    [[#if enableCellphoneBinding]]\n    <li data-trigger="advance.bindmobile">\n      <span class="bar"></span>\n      <a href="javascript:void(0)">{{i18n "setting/tab_bindmobile"}}</a>\n    </li>\n    [[/if]]\n\n    <li data-trigger="advance.loginnotification" class="j-loginnotification">\n      <span class="bar"></span>\n      <a href="javascript:void(0)">{{i18n "setting/tab_msgset"}}</a>\n    </li>\n\n    [[#if supportShortcut]]\n    <li data-trigger="advance.hotkeys">\n      <span class="bar"></span>\n      <a href="javascript:void(0)">{{i18n "setting/tab_hotkeys"}}</a>\n    </li>\n    [[/if]]\n  </script>\n  {{/raw}}\n</section>'}),define("module/setting/advance/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","configurable/index","module/common/globalService","util/i18n","text!template/module/setting/advance/index.tpl.html"],function(e){function t(e,t){return i("<div>",{"data-panel":e.sid,"class":t+" u-scroll advpanel",style:"display:none",html:""})}function n(e,t){if(0===t.indexOf("setting.advance")){var n=t.substring("setting.".length);e.tabview.find(n)&&(c.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("cui/ui/tabview/tabview"),l=e("configurable/index"),c=e("module/common/globalService"),d=e("util/i18n"),u=a.extend({Implements:s,setup:function(){var e,t=this;t.state=c.getCurrentState(),t.config=l("setting.advance"),e=t.state.module.split("."),t.activeTabId=e[2]?"advance."+e[2]:t.config.mboxshare?"advance.mboxshare":t.config.enablePopWebmailAgent?"advance.pop":t.config.enableSMSNotifySetting?"advance.smsnotification":"advance.pop3set",t.state.module="setting."+t.activeTabId,c.setCurrentState(t.state),t._setHistory(t.state)},render:function(){var e=this;u.superclass.render.call(e),e._initTabView(),e._initModuleEvent()},_initTabView:function(){var e=this,n=e.compile(e.$("#tabTpl").html(),e.config);e.$(".j-advance-nav").html(n);var i=[];e.config.enablePopWebmailAgent&&i.push({id:"advance.pop",title:d.t("setting.tab_popaccount"),module:r.module("setting.advance.pop")}),e.config.mboxshare&&i.splice(0,0,{id:"advance.mboxshare",title:d.t("setting.tab_mboxshare"),module:r.module("setting.advance.mboxshare")}),e.config.enableSMSNotifySetting&&i.push({id:"advance.smsnotification",title:d.t("setting/tab_smsnotification"),module:r.module("setting.advance.smsnotification")}),i.push({id:"advance.pop3set",module:r.module("setting.advance.pop3set"),title:d.t("setting/tab_pop3setting")}),e.config.isSupportSync&&i.push({id:"advance.mailpush",module:r.module("setting.advance.mailpush"),title:d.t("pref/eas_device")}),e.config.enableCellphoneBinding&&i.push({id:"advance.bindmobile",title:d.t("setting/tab_bindmobile"),module:r.module("setting.advance.bindmobile")}),e.config.supportMsgNotify&&e.config.supportMsgNotifyFolder||e.config.supportSMSLoginNotify||e.config.supportAppLoginNotify?i.push({id:"advance.loginnotification",title:d.t("setting/tab_msgset"),module:r.module("setting.advance.loginnotification")}):e.$("li.j-loginnotification").remove(),e.config.supportShortcut&&i.push({id:"advance.hotkeys",title:d.t("setting/tab_hotkeys"),module:r.module("setting.advance.hotkeys")}),e.tabview=new o({element:"section.j-advance",classPrefix:"j-advance",activeTabId:e.activeTabId,activeTriggerClass:"z-current",onlyRenderActive:!0,generatePanelMarkup:t,tabs:i}),e.tabview.render(),e.tabview.on("render",function(t){e._setHistory({module:"setting."+t})}),e.tabview.on("refresh",function(t){e.sendMessage("dispatcher","view:refresh",{module:"setting."+t,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(t){var i=t.message.newState;n(e,i.module)})},_setHistory:function(e){var t=this,n=i.extend(!0,{},e);0===n.module.indexOf("setting.advance.")&&(n.param={},t.sendMessage("dispatcher","view:render",n))}});r.module({name:"setting.advance",template:e("text!template/module/setting/advance/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/advance/bindmobile/index.tpl.html",[],function(){return'<!--\r\n  ~ Copyright (c) 2015 Mailtech.cn, Ltd. All Rights Reserved.\r\n  -->\r\n\r\n\r\n<section class="m-bindmobile">\r\n  <section class="j-bindmobile"></section>\r\n\r\n  <script type="text/x-handlebars-template" id="bindMobileTpl">\r\n    {{#raw}}\r\n      <div id="bindMobile" class="mainPanel">\r\n        <div class="u-btns-top">\r\n          <button type="button" class="u-btn u-btn-primary" data-action="bind">[[i18n "setting/op_save"]]</button>\r\n        </div>\r\n        <div class="title dotted">\r\n          <h4>[[i18n "pref/mobile/notbind"]]</h4>\r\n        </div>\r\n        <div class="mainContent">\r\n          <div class="grid-col12 j-pwd-info">\r\n            <div class="u-form-item">\r\n              <label class="u-form-label f-mgr">[[i18n "pref/mobile/bindto"]]:</label>\r\n              <input type="text" class="u-input" maxlength="11" name="cellNumber" value=""/>\r\n              <span class="cellNumberError"></span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    {{/raw}}\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="mobileBindedTpl">\r\n    {{#raw}}\r\n      <div id="mobileBinded" class="mainPanel">\r\n        <div class="u-btns-top">\r\n          <button type="button" class="u-btn u-btn-primary" data-action="cancelBind">[[i18n "pref/mobile/cancelbind"]]</button>\r\n        </div>\r\n        <div class="cancelBind">\r\n          <div class="grid-col12 j-pwd-info">\r\n            <div class="u-form-item">\r\n              [[i18n "pref/mobile/bound"]] [[cellNumber]]\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <hr class="dotted-line">\r\n\r\n        <div class="u-btns-top">\r\n          <button type="button" class="u-btn u-btn-primary" data-action="bindAnother">[[i18n "setting/op_save"]]</button>\r\n        </div>\r\n        <div class="title dotted">\r\n          <h4>[[i18n "pref/mobile/bindother"]]</h4>\r\n        </div>\r\n        <div class="bindAnother">\r\n          <div class="grid-col12 j-pwd-info">\r\n            <div class="u-form-item">\r\n              <label class="u-form-label f-mgr">[[i18n "pref/mobile/inputmobile"]]:</label>\r\n              <input type="text" class="u-input" maxlength="11" name="cellNumber" value=""/>\r\n              <span class="cellNumberError"></span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    {{/raw}}\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="validateMobileTpl">\r\n    {{#raw}}\r\n      <div id="validateMobile" class="mainPanel">\r\n        <div class="u-btns-top">\r\n          <button type="button" class="u-btn u-btn-primary" data-action="validate">[[i18n "setting/op_save"]]</button>\r\n          <button type="reset" class="u-btn u-btn-default"  data-action="cancelValidate">[[i18n "setting/op_cancel"]]</button>\r\n        </div>\r\n        <div class="title dotted">\r\n          <h4>[[i18n "pref/mobile/inputvalidate"]]</h4>\r\n        </div>\r\n        <div class="validateMobileContent">\r\n          <div class="grid-col12 j-pwd-info">\r\n            <input type="text" class="u-input" name="validateNum" value="" placeholder="[[i18n \'setting/lbl_verifyCode\']]"/>\r\n            <span class="validateNumError"></span>\r\n\r\n            <input type="hidden" class="u-input" name="validateCellNumber" value="[[validateCellNumber]]"/>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    {{/raw}}\r\n  </script>\r\n\r\n</section>\r\n'}),define("module/setting/advance/bindmobile/index",["require","i18n!setting,pref,pref/mobile","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","util/i18n","module/common/globalService","module/setting/service","text!template/module/setting/advance/bindmobile/index.tpl.html"],function(e){e("i18n!setting,pref,pref/mobile");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("util/i18n"),s=e("module/common/globalService"),o=e("module/setting/service"),l=n.extend({Implements:a,events:{"click [data-action]":"_dispatchAction"},setup:function(){var e=this;e.config={enableCellphoneBinding:s.getConfig("user.enablecellphonebinding")}},render:function(){l.superclass.render.call(this),this._initView()},_initView:function(){var e=this;t.when(o.getSMSAttrs()).then(function(t){var n=t.cellNumber;if(n&&n.length>0){e.cellNumber=t.cellNumber;var i=e.compile(e.$("#mobileBindedTpl").html(),e);e.$(".j-bindmobile").html(i)}else{var a=e.compile(e.$("#bindMobileTpl").html(),e);e.$(".j-bindmobile").html(a)}})},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"bindAnother":case"bind":i.$("span.cellNumberError").html("");var s=i.$("input[name='cellNumber']").val();if(!i._isPhoneNumberValid(s))return void i.$("span.cellNumberError").html(r.t("setting/msg_checkCellNumber"));if(s===i.cellNumber)return void i.$("span.cellNumberError").html(r.t("setting/msg_bindMobileFail_norepeat"));t.when(o.isCellnumberBinded(s)).then(function(e){1==e.isBinded?i.$("span.cellNumberError").html(r.t("setting/msg_bindMobileFail")):t.when(o.sendVerifyCode(s)).done(function(){var e=i.compile(i.$("#validateMobileTpl").html(),{validateCellNumber:s});i.$(".j-bindmobile").html(e)}).fail(function(){t.notify(r.t("setting/msg_sendValidateCodeFail"))})});break;case"validate":i.$("span.validateNumError").html("");var l=i.$("input[name='validateNum']").val(),c=i.$("input[name='validateCellNumber']").val();if(0==l.length)i.$("span.validateNumError").html(r.t("setting/msg_emptyValidateCode"));else{var d={attrs:{cellNumber:c},verifyCode:l};t.when(o.updateSmsAttrs(d)).done(function(){i.cellNumber=c;var e=i.compile(i.$("#mobileBindedTpl").html(),i);i.$(".j-bindmobile").html(e),i.cellNumber=c}).fail(function(e){"FA_INVALID_VERIFY_CODE"==e.code&&t.notify.error(r.t("setting/msg_validateFail"))})}break;case"cancelValidate":i.$(".j-bindmobile").html(""),i._initView();break;case"cancelBind":var u={attrs:{cellNumber:""}};t.when(o.updateSmsAttrs(u)).then(function(){i.$(".j-bindmobile").html(""),i._initView()})}},_isPhoneNumberValid:function(e){return null==e||0==e.length?!1:!!e.match(/^(\(?(\+|00)?86\)?\s?)?((13[0-9])|(15[^4])|(17[0,1])|(18[0-9]))\d{8}$/)}});i.module({name:"setting.advance.bindmobile",template:e("text!template/module/setting/advance/bindmobile/index.tpl.html")},l)}),define("components/requirejs-text/text!template/module/setting/advance/hotkeys/index.tpl.html",[],function(){return'<section class="m-sgadv-hotkeys">\r\n  <div class="j-hotkeys-container"></div>\r\n  {{#raw}}\r\n  <script id="categoryTpl" type="text/x-handlebars-template">\r\n    <div class="title dotted">\r\n      <h4>{{i18n "setting/tab_hotkeys"}}</h4>\r\n    </div>\r\n    <div class="u-hotkeys-switch">\r\n      <div class="f-fl">\r\n        <label class="msg-label">{{i18n "setting/tab_hotkeys"}}</label>\r\n      </div>\r\n      <div class="msg-value">\r\n        <input type="checkbox" class="j-hotkey-switch" value="1" role="switchBtn"/>\r\n      </div>\r\n    </div>\r\n    <div class="u-panel j-panel">\r\n      [[#each category]]\r\n      <div class="category">\r\n        <h4 class="title"><span>[[translate name]]</span></h4>\r\n        <div>\r\n          [[#each items]]\r\n          <div class="item">\r\n            <span class="key">[[[formatKey key]]]</span>\r\n            <span class="desc">[[translate key]]</span>\r\n          </div>\r\n          [[/each]]\r\n        </div>\r\n      </div>\r\n      [[/each]]\r\n    </div>\r\n  </script>\r\n  {{/raw}}\r\n</section>'}),define("module/setting/advance/hotkeys/index",["require","util/i18n!setting,pref","jquery","util/index","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","module/common/globalService","text!template/module/setting/advance/hotkeys/index.tpl.html"],function(e){e("util/i18n!setting,pref"),e("jquery");var t=e("util/index"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("module/common/globalService"),s=n.extend({Implements:a,attrs:{useShortCut:null},events:{"change.crc .j-hotkey-switch":"_handleToggle"},Statics:{CATEGORY:[{name:"global",items:[{key:"Ctrl_a"},{key:"Shift_m"},{key:"Del"}]},{name:"read",items:[{key:"r"},{key:"a"},{key:"f"},{key:"k"},{key:"j"}]},{name:"compose",items:[{key:"Ctrl_Enter"},{key:"Ctrl_s"}]}]},setup:function(){},render:function(){s.superclass.render.call(this),this._initView()},_initView:function(){var e=this,t=e.$("#categoryTpl").html();e.$(".j-hotkeys-container").html(e.compile(t,{category:s.CATEGORY})).customRadioCheckbox(),e.set("useShortCut",r.getUser().shortcut)},_handleToggle:function(e,n){var i=this,a=$(n).prop("checked")?1:0;r.updateUser({shortcut:a},!0).then(function(){i.set("useShortCut",a),$.notify(t.i18n.t("setting/"+(a?"msg_hotkeyEnableSuccessfully":"msg_hotkeyDisableSuccessfully")))})},templateHelpers:{formatKey:function(e){for(var n="",i=e.split("_"),a=0;a<i.length;a++)"macosx"===t.detector.os.name&&"Ctrl"===i[a]&&(i[a]=""),n+=a===i.length-1?'<span class="u-key">'+t.html.encode(i[a])+"</span>":'<span class="u-key">'+t.html.encode(i[a])+"</span><a>+</a>";return n},translate:function(e){return t.i18n.t("setting/hotkeys_"+e)}},_onRenderUseShortCut:function(e){e?this.$(".j-panel").addClass("u-panel-toggle"):this.$(".j-panel").removeClass("u-panel-toggle"),e?this.$(".j-hotkey-switch").next().addClass("checkbox-checked"):this.$(".j-hotkey-switch").next().removeClass("checkbox-checked"),this.$(".j-hotkey-switch").prop("checked",e)}});i.module({name:"setting.advance.hotkeys",template:e("text!template/module/setting/advance/hotkeys/index.tpl.html")},s)}),define("component/validatephonedg",["require","exports","module","util/i18n!setting","jquery","util/index","cui/ui/dialog/confirmbox","module/setting/service"],function(e,t,n){e("util/i18n!setting");var i=e("jquery"),a=e("util/index"),r=e("cui/ui/dialog/confirmbox"),s=e("module/setting/service"),o='<div class="u-validatePhone"><p>{{msgTip}}</p><div><input type="text" class="u-input j-verifyCode"/><button type="button" class="u-btn u-btn-default j-sendAgain">{{sendAgainBtn}}<span>(<label>{{countdown}}</label>s)</span></button><p class="j-errorMsg error f-dn"></p></div></div>',l=r.extend({constant:{msgTip:"",sendAgainBtn:a.i18n.t("setting/lbl_sendAgain"),countdown:60},attrs:{title:a.i18n.t("setting/lbl_validatePhone"),cellphone:"",callback:i.noop()},events:{"click .j-sendAgain:not(.countdown)":"_handleSendAgain"},setup:function(){var e=this;e.constant.msgTip=a.i18n.t("setting/lbl_smsAlreadySent",{mobile:this._formatCellphone(this.get("cellphone"))}),e.set("message",e.compile(o,e.constant)),l.superclass.setup.call(this),e.on("confirm",function(){e._handleValidatePhone()}),e.on("cancel",function(){e.destroy()})},render:function(){l.superclass.render.call(this),this.show(),this._handleSendVerifyCode(),this._handleUpdateDomStatus()},_handleSendVerifyCode:function(){var e=this;e.trigger("updateErrorMsgStatus",!1,""),s.sendVerifyCode(e.get("cellphone"))},_handleUpdateDomStatus:function(){var e=this;this.on("updateErrorMsgStatus",function(t,n){var i=e.$(".j-errorMsg");t?i.removeClass("f-dn"):i.addClass("f-dn"),i.html(n)}),this.on("updateSendAgainBtnStatus",function(e){var t=this.$(".j-sendAgain");e?t.removeClass("countdown u-btn-disabled").prop("disabled",!1):t.addClass("countdown u-btn-disabled").prop("disabled",!0)})},_handleSendAgain:function(){this._handleSendVerifyCode(),this._handleCountdown()},_handleCountdown:function(){var e=this,t=this.$(".j-sendAgain"),n=t.find("label");e.trigger("updateSendAgainBtnStatus",!1);var i=setInterval(function(){n.text(function(t,n){return--n>=1?n:(e.trigger("updateSendAgainBtnStatus",!0),clearInterval(i),e.constant.countdown)})},1e3)},_formatCellphone:function(e){return e?e.substr(0,4)+"****"+e.substr(e.length-4):""},_handleValidatePhone:function(){var e=this,t={attrs:{cellNumber:e.get("cellphone")},verifyCode:e.$(".j-verifyCode").val()};return e.trigger("updateErrorMsgStatus",!1,""),t.verifyCode?void s.updateSmsAttrs(t).then(function(){"function"==i.type(e.get("callback"))&&e.get("callback")(),e.destroy()},function(t){switch(t.code){case"FA_INVALID_VERIFY_CODE":e.trigger("updateErrorMsgStatus",!0,a.i18n.t("setting/lbl_invalidCode"))}}):(e.trigger("updateErrorMsgStatus",!0,a.i18n.t("setting/lbl_codeEmptyError")),!1)}});n.exports=l}),define("components/requirejs-text/text!template/module/setting/advance/loginnotification/index.tpl.html",[],function(){return'<section class="m-msgnotify">\r\n  <div class="j-msg-notify">\r\n\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <!---->\r\n  <script id="msgNotifyTpl" type="text/x-handlebars-template">\r\n    <div class="main-wrapper">\r\n      <!---->\r\n      <div class="content-wrapper grid-col12">\r\n        <div>\r\n          <!---->\r\n          <form method="post" class="u-msg-form-part j-msg-form">\r\n            [[#and config.supportMsgNotify config.supportMsgNotifyFolder]]\r\n            <p class="u-part-title">{{i18n "setting/lbl_msg_notify"}}</p>\r\n            <div class="f-cf msg-form-item">\r\n              <div class="f-fl">\r\n                <label class="msg-form-label">{{i18n "setting/lbl_msg_notify"}}:</label>\r\n              </div>\r\n              <div class="msg-form-value">\r\n                <input type="checkbox" class="j-msg-toggle" role="switchBtn" name="ws_msg_notify" value="1" [[#if msgModel.enableMsgNotify]] checked [[/if]]/>\r\n              </div>\r\n              <div class="msg-form-others">\r\n                [[i18n "setting/msg_msg_notify"]]\r\n              </div>\r\n            </div>\r\n            [[#if msgModel.enableMsgNotify]]\r\n            <div class="f-cf msg-form-item j-msg-setting-range">\r\n              <div class="f-fl">\r\n                <label class="msg-form-label">{{i18n "setting/lbl_msg_notify_folder"}}: </label>\r\n              </div>\r\n              <div class="msg-form-value">\r\n                <span>[[msgModel.folderData.filtedFoldersName]]</span>\r\n                <a href="javascript:void(0)" data-action="edit.range.msg">[{{i18n "setting/op_update"}}]</a>\r\n              </div>\r\n              <div class="msg-form-others">\r\n                [[i18n "setting/msg_msg_notify_folder"]]\r\n              </div>\r\n            </div>\r\n            [[/if]]\r\n            [[/and]]\r\n\r\n            [[#or config.supportSMSLoginNotify config.supportAppLoginNotify]]\r\n            <p class="u-part-title">{{i18n "setting/lbl_login_notify"}}</p>\r\n\r\n            [[#if config.supportSMSLoginNotify]]\r\n            <div class="f-cf msg-form-item">\r\n              <div class="f-fl msg-form-label">\r\n                <label>{{i18n "setting/lbl_sms_notify"}} :</label>\r\n              </div>\r\n              <div class="msg-form-value">\r\n                <input type="checkbox" class="j-sms-toggle" role="switchBtn" name="sms_login_notify" value="1" [[#if msgModel.enableSmsNotify]] checked [[/if]] />\r\n              </div>\r\n              <div class="msg-form-others">\r\n                [[translateTerminal config.sendLoginNoticeTerminals \'sms\']]\r\n              </div>\r\n            </div>\r\n\r\n            [[#if msgModel.enableSmsNotify]]\r\n            <div class="f-cf msg-form-item j-phoneArea [[#unless msgModel.cellphone]] unbound [[/unless]]">\r\n\r\n              <div class="f-fl msg-form-label">\r\n                <label>{{i18n "setting/lbl_cellphone"}} :</label>\r\n              </div>\r\n\r\n              <div class="msg-form-value textArea">\r\n                <span class="j-phoneNum">[[msgModel.cellphone]]</span>\r\n                [<a href="javascript:void(0)" data-action="update.phone.msg">{{i18n "setting/op_update"}}</a>]\r\n              </div>\r\n\r\n              <!--  -->\r\n              <div class="msg-form-value inputArea">\r\n                <input type="text" class="u-input j-cellphone" [[#if msgModel.cellphone]] disabled [[/if]]/>\r\n                <span class="j-phoneErrorMsg error f-dn"></span>\r\n              </div>\r\n\r\n              <div class="msg-form-others">\r\n                {{i18n "setting/lbl_cellphone_tip"}}\r\n              </div>\r\n\r\n              <div class="f-fl msg-form-label inputArea">\r\n                <label>{{i18n "setting/lbl_verifyCode"}} :</label>\r\n              </div>\r\n\r\n              <!--   -->\r\n              <div class="msg-form-value inputArea">\r\n                <input type="text" class="u-input j-verifyCode" [[#if msgModel.cellphone]] disabled [[/if]]/>\r\n                <button type="button" class="u-btn u-btn-default j-sendAgain">\r\n                  <span class="btnValue">[[i18n \'setting/lbl_sendVerifyCode\']]</span>\r\n                  <span class="countdownTxt">(<label>[[msgModel.countdown]]</label>s)</span>\r\n                </button>\r\n                <span class="j-codeErrorMsg error f-dn"></span>\r\n                <div class="wrapper">\r\n                  <button type="button" class="u-btn u-btn-primary" data-action="bind.phone.msg">[[i18n \'setting/op_confirm\']]</button>\r\n                  <button type="button" class="u-btn u-btn-default" data-action="cancelBind.phone.msg">[[i18n \'setting/op_cancel\']]</button>\r\n                </div>\r\n              </div>\r\n\r\n            </div>\r\n            [[/if]]\r\n            [[/if]]\r\n\r\n            [[#if config.supportAppLoginNotify]]\r\n            <div class="f-cf msg-form-item">\r\n              <div class="f-fl msg-form-label">\r\n                <label>{{i18n "setting/lbl_appPush_notify"}} :</label>\r\n              </div>\r\n              <div class="msg-form-value">\r\n                <input type="checkbox" class="j-app-toggle" role="switchBtn" name="app_login_notify" value="1" [[#if msgModel.enableAppNotify]] checked [[/if]] />\r\n              </div>\r\n              <div class="msg-form-others">\r\n                [[translateTerminal config.sendLoginNoticeTerminals \'appPush\']]\r\n              </div>\r\n            </div>\r\n            [[/if]]\r\n\r\n            [[/or]]\r\n          </form>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- -->\r\n      <div class="panel u-scroll range-panel">\r\n        <form action="#" name="notifyRange" method="post">\r\n          <div class="u-btns-top">\r\n            <button type="button" data-action="save.msg" class="u-btn u-btn-primary j-btn-error">{{i18n "setting/op_confirm"}}</button>\r\n            <button type="reset"  data-action="cancel.msg"   class="u-btn u-btn-default">{{i18n "setting/op_cancel"}}</button>\r\n          </div>\r\n\r\n          <div class="u-checkall sub-header j-checkall-folders">\r\n            <input type="checkbox" data-action="chkall.msg" class="j-check-all"><i class="iconfont iconfiler"></i>{{i18n "setting/lbl_folder"}}\r\n          </div>\r\n\r\n          <div class="u-form-item">\r\n            <div class="u-form-value j-folder-tree"></div>\r\n          </div>\r\n\r\n        </form>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="folderTreeTpl" >\r\n    <ul class="tree f-fl">\r\n      <!---->\r\n      <li>\r\n        <input type="checkbox" id="chkAllSyFolders" class="j-check-all"/>\r\n        <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[i18n "pref/personal/sysfolder"]]</div>\r\n      </li>\r\n      <li class="parent-node">\r\n        <ul>\r\n          [[#each sysFolders]]\r\n          <li>\r\n            <input type="checkbox" name="rangeItem1[]" class="j-check-sub  [[#if children]] j-check-all [[/if]]" [[#if selected]] checked [[/if]]  value=\'[[id]]\'/>\r\n            <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[name]]</div>\r\n          </li>\r\n          [[#if children]]\r\n          <ul>\r\n            [[#each children]]\r\n            <li>\r\n              <input type="checkbox" name="rangeItem1[]" class="j-check-sub" [[#if selected]] checked[[/if]] value=\'[[id]]\'/>\r\n              <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[name]]</div>\r\n            </li>\r\n            [[/each]]\r\n          </ul>\r\n          [[/if]]\r\n          [[/each]]\r\n        </ul>\r\n      </li>\r\n\r\n      <!---->\r\n      <li>\r\n        [[#compare otherFolders.length "==" 0]]\r\n        <input type="checkbox" id="chkallUserFolders" class="j-check-all" disabled/>\r\n        <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[i18n "setting/lbl_user_folder"]][[i18n "setting/lbl_lack"]]</div>\r\n        [[else]]\r\n        <input type="checkbox" id="chkallUserFolders" class="j-check-all"/>\r\n        <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[i18n "setting/lbl_user_folder"]]</div>\r\n        [[/compare]]\r\n      </li>\r\n      <li class="parent-node">\r\n        <ul>\r\n          [[#each otherFolders]]\r\n          <li>\r\n            <input type="checkbox" name="rangeItem2[]" class="j-check-sub [[#if children]] j-check-all [[/if]]" [[#if selected]] checked [[/if]]  value=\'[[id]]\'/>\r\n            <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[name]]</div>\r\n          </li>\r\n          [[#if children]]\r\n          <ul>\r\n            [[#each children]]\r\n            <li>\r\n              <input type="checkbox" name="rangeItem2[]" class="j-check-sub" [[#if selected]] checked [[/if]]  value=\'[[id]]\'/>\r\n              <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[name]]</div>\r\n            </li>\r\n            [[/each]]\r\n          </ul>\r\n          [[/if]]\r\n          [[/each]]\r\n        </ul>\r\n      </li>\r\n    </ul>\r\n  </script>\r\n  {{/raw}}\r\n\r\n</section>';
}),define("module/setting/advance/loginnotification/index",["require","util/i18n!setting,pref/preference,pref/personal","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","util/index","module/setting/service","configurable/index","component/validatephonedg","module/common/globalService","text!template/module/setting/advance/loginnotification/index.tpl.html"],function(e){function t(e){return!!(e||"").match(/^(\(?(\+|00)?86\)?\s?)?((13[0-9])|(15[^4])|(17[0,1])|(18[0-9]))\d{8}$/)}e("util/i18n!setting,pref/preference,pref/personal");var n=e("jquery"),i=e("cui/core/view/view"),a=e("cui/core/view/viewmanager"),r=e("cui/util/templatable/templatable"),s=e("util/index"),o=e("module/setting/service"),l=e("configurable/index"),c=e("component/validatephonedg"),d=e("module/common/globalService"),u=i.extend({Implements:r,templateHelpers:{translateTerminal:function(e,t){var i=[];return e=n.trim(e||""),n.each(e.split(","),function(e,t){var n="setting/lbl_terminal_"+t.toLowerCase(),a=s.i18n.t(n);a==n&&(a=t),i.push(a)}),s.messageFormat.format(s.i18n.t("setting/lbl_"+t+"_notify_tip"),i.join(""))}},events:{"click [data-action]":"_dispatchAction","click .j-check-all+i":"_handleSelectPartAll","click .j-check-sub+i":"_handleSelectSingleFolder","click .j-lock-item":"_handleCheckLockItem","change.crc .j-msg-toggle,.j-sms-toggle,.j-app-toggle":"_enableMsgNotify","click .j-sendAgain:not(.countdown)":"_handleSendAgain"},setup:function(){this.config=l("setting.advance.loginnotification")},render:function(){u.superclass.render.call(this),this._initView(),this._initModuleEvent()},_initModuleEvent:function(){this.on("updatePhoneAreaDomStatus",function(e,t,i){var a=this;e&&n.each(["phone","code"],function(e,t){a.$(".j-"+t+"ErrorMsg").addClass("f-dn").html("")}),t&&this.$(".j-"+t+"ErrorMsg").removeClass("f-dn").html(i)})},_initView:function(){this._setMsgView()},_renderMsgView:function(){this.$("div.j-msg-notify").html(this.compile(this.$("#msgNotifyTpl").html(),{msgModel:this.msgModel,config:this.config})).customRadioCheckbox()},_dispatchAction:function(e,t){var i=n(t).data("action");switch(i){case"save.msg":this._handleUpdateRange(t);break;case"cancel.msg":this._handleMsgCancel(t);break;case"chkall.msg":this._handleChkAllFolders(t);break;case"edit.range.msg":this._showNotifyRangePanel();break;case"update.phone.msg":this._handleValidatePhone(t);break;case"bind.phone.msg":this._handleBindPhone(t);break;case"cancelBind.phone.msg":this._handleCancelBindPhone()}},_setMsgView:function(){var e,t=this;t.msgModel=t._buildMsgModel(),e={enableFilter:t.msgModel.enableMsgNotify},t.msgModel.filterAll?e.filterAll=!0:e.filterIdList=t.msgModel.notifyFoldersIdList,n.when(o.generateFolderFilterData(e),o.getSMSAttrs()).then(function(e,n){t.msgModel.folderData=e,t.msgModel.cellphone=n.cellNumber,t._renderMsgView()})},_buildMsgModel:function(){var e=d.getUser(),t="@all"===e.ws_msg_notify_folder||null==e.ws_msg_notify_folder,n=t||"@none"===e.ws_msg_notify_folder?[]:e.ws_msg_notify_folder.split(",");return{enableMsgNotify:1===e.ws_msg_notify,filterAll:t,notifyFoldersIdList:n,enableSmsNotify:1===e.sms_login_notify,enableAppNotify:1===e.app_login_notify,countdown:60}},_enableMsgNotify:function(){var e=this,t=e.$(".j-msg-form").serializeJSON({parseNumbers:!0,checkboxUncheckedValue:"0"});d.updateUser(t).then(function(){e.sendMessage("component.notification","notificationReset",t),n.notify(s.i18n.t("setting/msg_prefUpdateSuccess")),e._setMsgView()})},_handleSendAgain:function(){var e=this,i=this.$(".j-cellphone").val();return this.trigger("updatePhoneAreaDomStatus",!0),i?t(i)?void o.isCellnumberBinded(i).then(function(t){1==t.isBinded?e.trigger("updatePhoneAreaDomStatus",!1,"phone",s.i18n.t("setting/lbl_phoneAlreadyBound")):(o.sendVerifyCode(i).fail(function(){n.notify(s.i18n.t("setting/msg_sendValidateCodeFail"))}),e._handleCountdown())}):(this.trigger("updatePhoneAreaDomStatus",!1,"phone",s.i18n.t("setting/lbl_invalidPhoneNumber")),!1):(this.trigger("updatePhoneAreaDomStatus",!1,"phone",s.i18n.t("setting/lbl_phoneEmptyError")),!1)},_handleCountdown:function(){var e=this,t=this.$(".j-sendAgain"),n=t.find("label");t.find(".btnValue").html(s.i18n.t("setting/lbl_sendAgain")),t.addClass("countdown u-btn-disabled").prop("disabled",!0);var i=setInterval(function(){n.text(function(n,a){return--a>=1?a:(t.removeClass("countdown u-btn-disabled").prop("disabled",!1),clearInterval(i),e.msgModel.countdown)})},1e3)},_showNotifyRangePanel:function(){var e=this.compile(this.$("#folderTreeTpl").html(),this.msgModel.folderData);this.$(".j-folder-tree").html(e),this._checkParentNode(),this.element.customRadioCheckbox(),this.$(".main-wrapper").addClass("switched-range")},_handleValidatePhone:function(e){var t=this,i=n(e).prev(".j-phoneNum").html();new c({cellphone:i,callback:function(){n(e).closest(".msg-form-item").addClass("unbound"),t.$(".j-verifyCode").prop("disabled",!1),t.$(".j-cellphone").val(i).prop("disabled",!1)}}).render()},_handleBindPhone:function(){var e=this,i="",a="",r=this.$(".j-cellphone").val(),l=this.$(".j-verifyCode").val();if(this.trigger("updatePhoneAreaDomStatus",!0),r?t(r)?l||(a="code",i=s.i18n.t("setting/lbl_codeEmptyError")):(a="phone",i=s.i18n.t("setting/lbl_invalidPhoneNumber")):(a="phone",i=s.i18n.t("setting/lbl_phoneEmptyError")),a)return this.trigger("updatePhoneAreaDomStatus",!1,a,i),!1;var c={attrs:{cellNumber:r},verifyCode:l};o.updateSmsAttrs(c).then(function(){n.notify(s.i18n.t("setting/msg_bindPhoneSuccessfully")),e.$(".j-phoneArea").removeClass("unbound"),e.$(".j-cellphone, .j-verifyCode").val("").prop("disabled",!0),e.$(".j-sendAgain .btnValue").html(s.i18n.t("setting/lbl_sendVerifyCode")),e.$(".j-phoneNum").html(r),e.msgModel.cellphone=r},function(t){switch(t.code){case"FA_INVALID_VERIFY_CODE":e.trigger("updatePhoneAreaDomStatus",!1,"code",s.i18n.t("setting/lbl_invalidCode"))}})},_handleCancelBindPhone:function(){var e=this;e.msgModel.cellphone?e._renderMsgView():e.$(".j-sms-toggle").trigger("click")},_handleUpdateRange:function(){var e=this,t=e.$('form[name="notifyRange"]').serializeJSON(),i=[];t.rangeItem1||t.rangeItem2?(n.each(t,function(e){i=i.concat(t[e])}),i=i.join(",")):i="@none",d.updateUser({ws_msg_notify_folder:i}).then(function(){n.notify(s.i18n.t("setting/msg_prefUpdateSuccess")),e._setMsgView(),e.$(".main-wrapper").removeClass("switch-range")})},_checkParentNode:function(){var e=this;e.$(".parent-node:visible").each(function(e,t){var i=n(t).find("input:checked").length,a=n(t).find("input").length;a&&i==a&&n(t).prev().find("input").prop("checked",!0)})},_handleMsgCancel:function(){this.$(".main-wrapper").removeClass("switched-range")},_handleChkAllFolders:function(e){var t=n(e).is(":checked");this.$("#chkAllSyFolders").prop("checked",t),this.$("#chkallUserFolders").prop("checked",t)},_handleSelectPartAll:function(e,t){var i="checkbox-checked",a=n(t).parent().next();n(t).hasClass(i)?a.find("li i").addClass(i).end().find("li input").each(function(){this.checked=!0}):a.find("li i").removeClass(i).end().find("li input").each(function(){this.checked=!1})},_handleSelectSingleFolder:function(e,t){var i=n(t).parents(".parent-node"),a=i.find(".checkbox").length,r=i.find(".checkbox-checked").length;a==r?i.prev().find(".checkbox").addClass("checkbox-checked"):i.prev().find(".checkbox").removeClass("checkbox-checked")},_handleCheckLockItem:function(e){n(e.target||e.srcElement).siblings(".checkbox").click()}});a.module({name:"setting.advance.loginnotification",template:e("text!template/module/setting/advance/loginnotification/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/advance/mailpush/index.tpl.html",[],function(){return'<div class="m-st-client-mailpush-wrap grid-row">\r\n  <div class="main-wrapper grid-col12">\r\n    <div class="content-wrapper">\r\n      <section class="m-st-client-mailpush-statement">\r\n\r\n      </section>\r\n      <section class="m-st-client-mailpush-list u-scroll">\r\n\r\n      </section>\r\n    </div>\r\n\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask" />\r\n    <![endif]-->\r\n\r\n    <!--   -->\r\n    <div class="m-st-client-mailpush-panel panel u-scroll" id="synActionTplContainer"></div>\r\n    {{#raw}}\r\n    <script type="text/x-handlebars-template" id="clientMailPushStatementTpl" data-container=".m-st-client-mailpush-statement">\r\n      <p>\r\n        [[#compare pushDevicesLength ">" 0]]\r\n        [[[ i18n "setting/msg_easDeviceSummary" current=pushDevicesLength max=deviceCountLimit ]]]\r\n        [[else]]\r\n        [[[ i18n "setting/msg_easDeviceSummaryEmpty" max=deviceCountLimit ]]]\r\n        [[/compare]]\r\n      </p>\r\n      <p>\r\n        [[[ i18n "pref/mobile/eas_hint_1" ]]]\r\n      </p>\r\n    </script>\r\n\r\n    <script type="text/x-handlebars-template" id="clientMailPushListTpl" data-container=".m-st-client-mailpush-list">\r\n      <ul class="u-list">\r\n        [[#each pushDevices]]\r\n        <li>\r\n          <div class="u-box" data-active="true">\r\n            <div class="u-box-head">\r\n              <h3>\r\n                <!-- Nokia NFE DeviceType  IMIE  deviceInformation  -->\r\n                [[! templateHelper function ]]\r\n                [[ showDeviceType this ]]\r\n              </h3>\r\n              [[#if this.WIPE ]]\r\n                <!--  WIPE  -->\r\n                [[#compare this.WIPE "==" "OK"]]\r\n                  <p>[[ i18n "pref/mobile/eas.syncState.WIPE_OK" ]]</p>\r\n                [[/compare]]\r\n\r\n                <!-- WIPE PENDING  -->\r\n                [[#compare this.WIPE "==" "PENDING"]]\r\n                <p>\r\n                  <span class="highlight_error">[[ i18n "pref/mobile/eas.syncState.WIPE_PENDING" ]]</span>\r\n\r\n                  [[#if this.wipeIssueTime]]\r\n                    <span>[[ i18n "setting/msg_easWipeDeviceIssueTime" ]][[ GetDateYMDHm this.wipeIssueTime ]]</span>\r\n                  [[/if]]\r\n\r\n                  <a href="javascript:void(0);" data-operation="action" data-action="doHandleWipeDevice" data-actionType="cancelWipe" data-deviceID="[[this.id]]">\r\n                    [[ i18n "pref/mobile/eas.action.cancel_wipe" ]]\r\n                  </a>\r\n                </p>\r\n                [[/compare]]\r\n\r\n              [[else]]\r\n                <!--  -->\r\n                <p>[[ i18n "pref/mobile/eas.syncState.OK" ]]</p>\r\n              [[/if]]\r\n              <p>[[ i18n "pref/mobile/eas.deviceId" ]]: [[this.id]]</p>\r\n            </div>\r\n            <!-- id attr is required for collapse -->\r\n            <div class="u-box-container collapse" id="deviceID_[[ this.id ]]_detail">\r\n              [[#compare this.WIPE "==" "OK"]]\r\n                <p>[[ i18n "pref/mobile/eas.syncState.WipeNote" ]]</p>\r\n              [[else]]\r\n                [[#if this.lastSyncTime]]\r\n                  <p>[[ i18n "pref/mobile/eas.lastSyncTime"]][[ GetDateYMDHm this.lastSyncTime ]]</p>\r\n                [[/if]]\r\n                [[#if this.firstSyncTime]]\r\n                  <p>[[ i18n "pref/mobile/eas.firstSyncTime"]][[ GetDateYMDHm this.firstSyncTime]]</p>\r\n                [[/if]]\r\n                [[#if this.userAgent]]\r\n                <p>[[ i18n "pref/mobile/eas.userAgent"]][[this.userAgent]]</p>\r\n                [[/if]]\r\n\r\n                [[! templateHelper function ]]\r\n                [[ showIMEIDeviceInfo this ]]\r\n\r\n              [[/compare]]\r\n            </div>\r\n            <div class="mailpush-action">\r\n              <a href="javascript:void(0);"\r\n                 data-operation="action"\r\n                 data-action="doHandleRecoveryPass"\r\n                 data-actionType="init"\r\n                 data-deviceID=[[ this.id ]]>[[ i18n "pref/mobile/eas.action.recoveryPassword" ]]</a>\r\n              <a href="javascript:void(0);"\r\n                 data-operation="action"\r\n                 data-action="doHandleRemoveDevice"\r\n                 data-actionType="init"\r\n                 data-deviceID=[[ this.id ]]>[[ i18n "pref/mobile/eas.action.remove" ]]</a>\r\n\r\n              [[#unless this.WIPE ]]\r\n                [[#if ../../enableRemoteWipe ]]\r\n                  <a href="javascript:void(0);"\r\n                     data-operation="action"\r\n                     data-action="doHandleWipeDevice"\r\n                     data-actionType="init"\r\n                     data-deviceID=[[ this.id ]]>[[ i18n "pref/mobile/eas.action.wipe" ]]</a>\r\n                [[/if]]\r\n              [[/unless]]\r\n\r\n\r\n            </div>\r\n            <!-- id and href attrs is required for collapse -->\r\n            <a data-toggle="collapse"\r\n               href="#deviceID_[[ this.id ]]_detail" aria-controls="deviceID_[[ this.id ]]_detail">\r\n              <i class="collapse-toggle icondown"></i>\r\n            </a>\r\n          </div>\r\n        </li>\r\n        [[/each]]\r\n      </ul>\r\n    </script>\r\n\r\n    <script type="text/x-handlebars-template" id="checkPassTpl">\r\n      <form action="#" method="post" name="checkPasswordForm">\r\n        <div class="u-btns-top">\r\n          <button type="reset" data-operation="action" data-action="[[actionData.action]]" data-actionType="cancelSubmit" class="u-btn u-btn-default">[[actionData.cancel]]</button>\r\n        </div>\r\n        <h4 class="sub-header">[[i18nData.subHeader]]</h4>\r\n        <label class="label">[[[i18nData.label]]]</label>\r\n        <div class="u-form-item">\r\n          <div class="u-input-control">\r\n            <input type="password" name="password" class="u-input" />\r\n            <span class="iconfont iconlock"></span>\r\n            <button type="submit" data-operation="action" data-action="[[actionData.action]]" data-actionType="[[actionData.nextActionType]]" class="u-btn u-btn-primary">{{i18n "setting/op_confirm"}}</button>\r\n            <input type="hidden" name="deviceId" value="[[actionData.deviceId]]" />\r\n          </div>\r\n          <p class="u-form-explain f-dn"></p>\r\n        </div>\r\n      </form>\r\n    </script>\r\n\r\n    <script type="text/x-handlebars-template" id="infoPanelTpl">\r\n      <div class="u-btns-top">\r\n        <button type="reset"  data-operation="action" data-action="[[actionData.action]]" data-actionType="cancelResult" class="u-btn u-btn-default">{{i18n "setting/op_cancel"}}</button>\r\n      </div>\r\n      <h4 class="sub-header">[[infoData.title]]</h4>\r\n      <p>[[[infoData.content]]]</p>\r\n\r\n    </script>\r\n    {{/raw}}\r\n  </div>\r\n</div>'}),define("module/setting/advance/mailpush/index",["require","i18n!setting,pref,main,pref/mobile","jquery","moment","i18n","handlebars","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","../../../../component/confirmbox","module/common/globalService","./../../service","text!template/module/setting/advance/mailpush/index.tpl.html"],function(e){e("i18n!setting,pref,main,pref/mobile");var t=e("jquery"),n=e("moment"),i=e("i18n"),a=e("handlebars"),r=e("cui/core/view/view"),s=e("cui/core/view/viewmanager"),o=e("cui/util/templatable/templatable"),l=e("../../../../component/confirmbox"),c=e("module/common/globalService"),d=e("./../../service"),u=r.extend({Implements:o,pushDevices:[],$syncActionContainer:null,isSupportSync:null,events:{'click [data-toggle="collapse"]':"_handleCollapse",'click [data-operation="action"]':"_handleOperation"},setup:function(){},render:function(){var e=this;u.superclass.render.call(this),t.notify.loading(),e.$syncActionContainer=e.$("#synActionTplContainer"),e.isSupportSync=c.getConfig("user.supportactivesync"),e.isSupportSync&&this._initDevices.call(this,function(){e._initView()}),t.notify.loading("hide")},destroy:function(){u.superclass.destroy.call(this)},_initDevices:function(e){var n=this;t.when(d.getActiveSyncDevice()).then(function(a){return"S_OK"!=a.code?(t.notify.error(i.t("setting/msg_easDeviceFetchFail")),!1):(n.pushDevices=a.data,void e(n.pushDevices))},function(){return t.notify.error(i.t("setting/msg_easDeviceFetchFail")),!1})},_initView:function(){var e=this,t={pushDevicesLength:e.pushDevices.length,deviceCountLimit:c.getConfig("user.activeSyncDeviceCountLimit")},n={pushDevices:e.pushDevices,enableRemoteWipe:c.getConfig("user.enableremotewipe")};e._initSubTpl("#clientMailPushStatementTpl",t),e._initSubTpl("#clientMailPushListTpl",n)},_initSubTpl:function(e,t){var n,i,a,r=this;n=r.$(e),i=r.compile(n.html(),t),a=r.$(n.attr("data-container")),a.html(i)},_handleCollapse:function(e,n){e.preventDefault();var i,a=t(n),r=a.find("i.collapse-toggle"),s=this.$(a.attr("data-target")||(i=a.attr("href"))&&i.replace(/.*(?=#[^\s]+$)/,""));s.hasClass("collapsing")||(s.hasClass("in")?(s.addClass("collapsing"),s.hide(350,function(){s.removeClass("in").removeClass("collapsing"),r.removeClass("iconup").addClass("icondown")})):(s.addClass("in").addClass("collapsing"),s.show(350,function(){r.removeClass("icondown").addClass("iconup"),s.removeClass("collapsing")})))},_handleOperation:function(e,n){e.preventDefault();var i=this,a=t(n),r=a.attr("data-action"),s=a.attr("data-actionType");return!s&&(s="init"),!!i[r]&&!!i[r][s]&&i[r][s].call(i,a),!1},doHandleRecoveryPass:{action:"doHandleRecoveryPass",retryMeta:{max:5,current:0,lastTryDate:null,tryInterval:6e4},init:function(e){var a,r,s,o,l=this,c=l.doHandleRecoveryPass.retryMeta;return e&&(a=e.attr("data-deviceID"))?(l.doHandleCommon.checkRetryMeta.call(l,c)?(r={action:this.doHandleRecoveryPass.action},s={title:i.t("pref/mobile/eas.action.recoveryPassword"),content:i.t("setting/msg_easWrongPassForbidden",{seconds:Math.floor((c.tryInterval-n().diff(c.lastTryDate))/1e3)})},l.doHandleCommon.initInfoPanel.call(l,{infoData:s,actionData:r})):(r={action:this.doHandleRecoveryPass.action,nextActionType:"submit",deviceId:a,cancel:i.t("setting/op_cancel")},o={subHeader:i.t("pref/mobile/eas.action.recoveryPassword"),label:i.t("pref/mobile/eas.recoveryPassword.checking")},l.doHandleCommon.initCheckPass.call(l,{i18nData:o,actionData:r})),void this.showPanel()):(t.notify.error(i.t("setting/msg_easDeviceMissId")),!1)},submit:function(e){var a,r=this,s={action:this.doHandleRecoveryPass.action},o={title:"",content:""},l=this.$syncActionContainer.find("form[name=checkPasswordForm]").serializeJSON(),c=r.doHandleRecoveryPass.retryMeta,u=n();this.doHandleCommon.submitCheckPass.call(this,e,l)&&(a={password:l.password,deviceId:l.deviceId},t.when(d.getRecoveryPass(a)).then(function(e){var t;t=e["var"]&&e["var"].password?e["var"].password:i.t("pref/mobile/eas.recoveryPassword.emptyResult"),o.title=i.t("pref/mobile/eas.action.recoveryPassword"),o.content=t,r.doHandleCommon.resetRetryMeta(c),r.doHandleCommon.initInfoPanel.call(r,{infoData:o,actionData:s})},function(){r.doHandleCommon.dirtyCheckPass(e,i.t("setting/msg_easWrongPass")),c.current++,c.lastTryDate=u,c.current>=c.max&&(o={title:i.t("pref/mobile/eas.action.recoveryPassword"),content:i.t("setting/msg_easWrongPass")+i.t("setting/msg_easWrongPassForbidden",{seconds:c.tryInterval/1e3})},r.doHandleCommon.initInfoPanel.call(r,{infoData:o,actionData:s}))}))},cancelSubmit:function(){this.hidePanel(),this.$syncActionContainer.html("")},cancelResult:function(){this.hidePanel(),this.$syncActionContainer.html("")}},doHandleRemoveDevice:{action:"doHandleRemoveDevice",init:function(e){var n,a=this;return e&&(n=e.attr("data-deviceID"))?void l.confirm(i.t("pref/mobile/eas.tips_remove_device"),function(){a.doHandleRemoveDevice.confirm.call(a,n)},function(){a.doHandleRemoveDevice.cancelConfirm.call(a)}):(t.notify.error(i.t("setting/msg_easDeviceMissId")),!1)},confirm:function(e){var n=this,a={deviceId:e};t.when(d.removeActiveSyncDevice(a)).then(function(e){"S_OK"===e.code&&(t.notify.success(i.t("setting/msg_easDeviceRemoveSuccess")),n.render.call(n))},function(){t.notify.error(i.t("setting/msg_easDeviceRemoveFailed"))})},cancelConfirm:function(){}},doHandleWipeDevice:{action:"doHandleWipeDevice",retryMeta:{max:5,current:0,lastTryDate:null,tryInterval:6e4},init:function(e){var a,r,s,o,l=this,c=l.doHandleWipeDevice.retryMeta;return e&&(a=e.attr("data-deviceID"))?(l.doHandleCommon.checkRetryMeta.call(l,c)?(r={action:this.doHandleWipeDevice.action},s={title:i.t("pref/mobile/eas.wipe_device.title"),content:i.t("setting/msg_easWrongPassForbidden",{seconds:Math.floor((c.tryInterval-n().diff(c.lastTryDate))/1e3)})},l.doHandleCommon.initInfoPanel.call(l,{infoData:s,actionData:r})):(r={action:this.doHandleWipeDevice.action,nextActionType:"submit",deviceId:a,cancel:i.t("setting/op_cancel")},o={subHeader:i.t("pref/mobile/eas.wipe_device.title"),label:i.t("setting/msg_easWipe_deviceTips")},l.doHandleCommon.initCheckPass.call(l,{i18nData:o,actionData:r})),void this.showPanel()):(t.notify.error(i.t("setting/msg_easDeviceMissId")),!1)},submit:function(e){var a,r=this,s=this.$syncActionContainer.find("form[name=checkPasswordForm]").serializeJSON(),o=r.doHandleWipeDevice.retryMeta,l=n();this.doHandleCommon.submitCheckPass.call(this,e,s)&&(a={password:s.password,deviceId:s.deviceId},t.when(d.remoteWipeDevice(a)).then(function(e){"S_OK"===e.code&&(t.notify.success(i.t("setting/msg_easWipeDeviceSuccess")),r.doHandleWipeDevice.cancelResult.call(r),r.doHandleCommon.resetRetryMeta(o),r.render.call(r))},function(){if(r.doHandleCommon.dirtyCheckPass(e,i.t("setting/msg_easWrongPass")),o.current++,o.lastTryDate=l,o.current>=o.max){var t={action:r.doHandleWipeDevice.action},n={title:i.t("pref/mobile/eas.action.recoveryPassword"),content:i.t("setting/msg_easWrongPass")+i.t("setting/msg_easWrongPassForbidden",{seconds:o.tryInterval/1e3})};r.doHandleCommon.initInfoPanel.call(r,{infoData:n,actionData:t})}}))},cancelSubmit:function(){this.hidePanel(),this.$syncActionContainer.html("")},cancelResult:function(){this.hidePanel(),this.$syncActionContainer.html("")},cancelWipe:function(e){var n,a=this;if(!e||!(n=e.attr("data-deviceID")))return t.notify.error(i.t("setting/msg_easDeviceMissId")),!1;var r={deviceId:n};t.when(d.cancelRemoteWipeDevice(r)).then(function(e){"S_OK"===e.code&&(t.notify.success(i.t("setting/msg_easWipeDeviceCancelSuccess")),a.render.call(a))},function(){t.notify.error(i.t("setting/msg_easWipeDeviceCancelFailed"))})}},doHandleCommon:{initCheckPass:function(e){var t,n;t=this.$("#checkPassTpl"),n=this.compile(t.html(),e),this.$syncActionContainer.html(n)},submitCheckPass:function(e,t){return t.deviceId?t.password?(this.doHandleCommon.cleanCheckPass(e),!0):(this.doHandleCommon.dirtyCheckPass(e,i.t("setting/msg_easMissPass")),!1):(this.doHandleCommon.dirtyCheckPass(e,i.t("setting/msg_easDeviceMissId")),!1)},dirtyCheckPass:function(e,t){var n=e.parent().find("input[type=password]"),i=e.parent().parent(),a=i.find(".u-form-explain").eq(0);n.val(""),i.addClass("error"),a.html(t).removeClass("f-dn")},cleanCheckPass:function(e,t){var n=e.parent().parent(),i=n.find(".u-form-explain").eq(0);n.removeClass("error"),t?i.html(t):i.html("").addClass("f-dn")},initInfoPanel:function(e){var t,n;t=this.$("#infoPanelTpl"),n=this.compile(t.html(),e),this.$syncActionContainer.html(n)},checkRetryMeta:function(e){var t,i=this,a=n(),r=!1,s=!1;return e.current<e.max?r=!1:e.lastTryDate?(t=a.diff(e.lastTryDate),t<e.tryInterval?r=!0:(s=!0)&&(r=!1)):(r=!1,s=!0),s&&(i.doHandleCommon.resetRetryMeta(e),r=!1),r},resetRetryMeta:function(e){e.current=0,e.lastTryDate=null}},templateHelpers:{showIMEIDeviceInfo:function(e){var t,n,r=["FriendlyName","Model","OS","IMEI"],s="",o=0;if(t=e.deviceInformation){for(o;o<r.length;o++)n=r[o],!!t[n]&&(s+="<p>"+i.t("pref/mobile/eas.deviceInformation."+n)+""+t[n]+"</p>");return new a.SafeString(s)}},showDeviceType:function(e){var t;return t=e.deviceInformation&&e.deviceInformation.Model?e.deviceInformation.Model:e.deviceType?e.deviceType:i.t("pref/mobile/eas.unknownDevice"),new a.SafeString(t)},GetDateYMDHm:function(e){return e?new a.SafeString(n(e).format("YYYY-MM-DD HH:mm")):void 0}},showPanel:function(){this.$(".main-wrapper").addClass("toggled")},hidePanel:function(){this.$(".main-wrapper").removeClass("toggled")}});s.module({name:"setting.advance.mailpush",template:e("text!template/module/setting/advance/mailpush/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/advance/mboxshare/index.tpl.html",[],function(){return'<section class="m-mboxshare">\r\n  <div class="main-wrapper">\r\n    <div class="content-wrapper">\r\n      <div class="card-container j-mboxAccess grid-col12"></div>\r\n      <div class="card-container j-mboxShare grid-col12"></div>\r\n    </div>\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask" />\r\n    <![endif]-->\r\n\r\n    <!--   -->\r\n    <div class="panel m-edit-share edit-panel u-scroll"></div>\r\n\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="mboxShareAccountTpl">\r\n    <div class="title dotted">\r\n      <h4>[[i18n "setting/lbl_my_shared_mbox"]]</h4>\r\n    </div>\r\n    [[#each acl]]\r\n    <div class="m-share-card f-pr f-fl">\r\n      <i class="icontabclose iconfont" data-action="delete" data-uid="[[uid]]"></i>\r\n      <a href="#" class="u-img u-img-round f-fl">\r\n        <img src="[[avatar]]" alt="">\r\n      </a>\r\n      <div class="u-profile f-fl">\r\n        <h4 class="f-il f-ellipsis">[[name]]</h4>\r\n        <span class="uid f-ellipsis">[[uid]]</span>\r\n      </div>\r\n      <div class="privilege">\r\n        <div class="u-form-item">\r\n          <div class="f-fl">\r\n            <label class="u-form-label">{{i18n "setting/lbl_privilege"}}&nbsp;:</label>\r\n          </div>\r\n          <div class="u-form-value">\r\n            <label class="f-mgr">[[sendText]]</label>\r\n            <a href="javascript:void(0)" data-action="edit" data-uid="[[uid]]" >{{i18n "setting/op_edit"}}</a>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/each]]\r\n    <div class="m-addcard" data-action="create"><i class="iconadd iconfont"></i></div>\r\n  </script>\r\n\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="mboxAccessAccountTpl">\r\n\r\n    [[#if account.length]]\r\n    <div class="title dotted">\r\n      <h4>[[i18n "setting/lbl_other_shared_mbox"]]</h4>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#each account]]\r\n    <div class="m-share-card accessBox f-pr f-fl">\r\n      <div class="accessBox-header">\r\n        <div class="mbox-toggle">\r\n          <input type="checkbox" class="j-switch" [[#unless hidden]] checked [[/unless]]  value="[[email]]" role="switchBtn">\r\n        </div>\r\n        <label class="mbox-toggle-label ">[[i18n \'setting/lbl_mbox_display_in_folder_list\']]</label>\r\n      </div>\r\n      <a href="#" class="u-img u-img-round f-fl">\r\n        <img src="[[avatar]]" alt="">\r\n      </a>\r\n      <div class="u-profile f-fl">\r\n        <h4 class="f-il f-ellipsis">[[name]]</h4>\r\n        <span class="uid f-ellipsis">[[email]]</span>\r\n      </div>\r\n      <div class="privilege">\r\n        <div class="u-form-item">\r\n          <div class="f-fl">\r\n            <label class="u-form-label">{{i18n "setting/lbl_privilege"}}&nbsp;:</label>\r\n          </div>\r\n          <div class="u-form-value">\r\n            <label class="f-mgr">[[sendText]]</label>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/each]]\r\n  </script>\r\n\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="mboxShareAccountEditTpl">\r\n    <form action="#" name="shareAccount" onsubmit="return false;">\r\n      <div class="u-btns-top">\r\n        <button type="button" data-action="save" class="u-btn u-btn-primary">[[i18n "setting/op_share"]]</button>\r\n        <button type="button" data-action="cancel" class="u-btn u-btn-default">[[i18n "setting/op_cancel"]]</button>\r\n      </div>\r\n      [[#if uid]]\r\n      <h4 class="sub-header">[[i18n "setting/lbl_editMboxShareAccount"]]</h4>\r\n      [[else]]\r\n      <h4 class="sub-header">[[i18n "setting/lbl_createMboxShareAccount"]]</h4>\r\n      [[/if]]\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "setting/lbl_mboxShareTo"]]&nbsp; :</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          [[#if uid]]\r\n          <input type="hidden" name="uid" class="u-input" value="[[uid]]"/>\r\n          <span>[[uid]]</span>\r\n          [[else]]\r\n          <input type="text" name="uid" class="u-input" value="" role="contact" placeholder="[[i18n \'pref/mboxShare/email_input_hint\']]"/>\r\n          [[/if]]\r\n          <span class="notify f-dn">[[i18n "setting/msg_errorEmailFormat"]]</span>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "setting/lbl_privilege"]]&nbsp; :</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n            <select name="send" class="u-select">\r\n              <option value="0" [[#compare send "==" 0]]selected [[/compare]] >[[i18n "pref/mboxShare/share_permission_0"]]</option>\r\n              <option value="1" [[#compare send "==" 1]]selected [[/compare]] >[[i18n "pref/mboxShare/share_permission_1"]]</option>\r\n              <option value="2" [[#compare send "==" 2]]selected [[/compare]] >[[i18n "pref/mboxShare/share_permission_2"]]</option>\r\n            </select>\r\n        </div>\r\n      </div>\r\n    </form>\r\n    <div class="u-tips">\r\n      <h4>[[i18n "pref/personal/tips"]]&nbsp;:</h4>\r\n      <br />\r\n      <img src="89517/style/img/share.png" alt="" />\r\n    </div>\r\n  </script>\r\n  {{/raw}}\r\n</section>'}),define("module/setting/advance/mboxshare/index",["require","util/i18n!setting,pref/mboxShare,pref/personal","../../../../component/contactac","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","../../../../util/index","module/common/globalService","./../../service","configurable/index","text!template/module/setting/advance/mboxshare/index.tpl.html"],function(e){e("util/i18n!setting,pref/mboxShare,pref/personal"),e("../../../../component/contactac");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("component/confirmbox"),s=e("../../../../util/index"),o=e("module/common/globalService"),l=e("./../../service"),c=e("configurable/index"),d=s.i18n,u=n.extend({Implements:a,attrs:{mboxShareAccount:[],mboxAccessAccount:[],editMode:!1},setup:function(){this.state=o.getCurrentState(),this.config=c("setting.advance.mboxshare")},render:function(){u.superclass.render.call(this),this._fetchData()},events:{"click [data-action]":"_dispatchAction","change.crc .j-switch":"_handleSetMboxVisible"},_fetchData:function(){var e=this;t.when(l.getMboxShareACL(),l.listSharedAccessMbox()).then(function(n,i){t.each(n,function(e,t){t.hasHeadImage=t.hasHeadImage||"","1"==t.hasHeadImage&&(t.avatar=t.avatar+"&sid="+o.getSid()+"&uid="+t.uid+"&time="+(new Date).getTime()),t.sendText=d.t("setting/lbl_share_permission_"+t.send),t.name=t.name||d.t("setting/lbl_mboxUnknownName"),n[e]=t}),t.each(i,function(e,t){t.hasHeadImage=t.hasHeadImage||"","1"==t.hasHeadImage&&(t.avatar=t.avatar+"&sid="+o.getSid()+"&uid="+t.email+"&time="+(new Date).getTime()),t.sendText=d.t("setting/lbl_share_permission_"+(t.send?"1":"0")),i[e]=t}),e.set("mboxShareAccount",n),e.set("mboxAccessAccount",i),e.element.mask("hide")})},_dispatchAction:function(e,n){var i=t(n).data();switch(i.action){case"delete":this._handleDeleteMbox(i);break;case"create":this._handleCreateMbox();break;case"save":this._handleSaveMbox();break;case"edit":this._handleEditMbox(i);break;case"cancel":this.set("editMode",!1)}},_handleSetMboxVisible:function(e){var n=this,i={visible:e.target.checked,email:e.target.value};l.setSharedAccessMboxVisible(i).then(function(e){"S_OK"===e.code&&(t.notify.success(d.t("setting/msg_mboxAccessAccountVisibleUpdateSuccess")),
n.sendMessage("mail","folder:refresh",{type:"all"}))})},_handleDeleteMbox:function(e){var n=e.uid,i=this;r.confirm(s.messageFormat.format(d.t("setting/msg_mboxAccountDelConfirm"),n),function(){var e={},a=i.get("mboxShareAccount"),r=t.grep(a,function(e){return e.uid!=n});t.each(r,function(t,n){e[n.uid]={send:n.send,rw:n.rw}}),l.putMboxShareACL(e).then(function(){i.set("mboxShareAccount",[],{silent:!1}),i.set("mboxShareAccount",r)})})},_handleCreateMbox:function(){var e=this;l.auth2continue(o.getLockOpValues().mboxShare).then(function(){var t=e.compile(e.$("#mboxShareAccountEditTpl").html(),"");e.$(".m-edit-share").html(t),e._contactAutoComplete(),e.element.customRadioCheckbox(),e.set("editMode",!0)})},_handleSaveMbox:function(){var e,n=this.$("form[name=shareAccount]").serializeJSON({parseNumbers:!0}),i=this.get("mboxShareAccount"),a={},s=this,o=[];for(n.uid=t.trim(n.uid),n.uid||r.alert(d.t("setting/msg_inputEmpty")),e=0;e<this.config.allEmails.length;e++)if(n.uid==this.config.allEmails[e].addr)return r.alert(d.t("setting/msg_accountSharedToSelf"));for(e=0;e<i.length;e++)n.uid!=i[e].uid&&o.push(i[e].uid),a[i[e].uid]={send:i[e].send,rw:i[e].rw};var c="undefined"!=typeof a[n.uid];l.checkUserForShare(n.uid,o.join(",")).then(function(e){"S_OK"===e?(a[n.uid]={send:void 0==n.send?0:n.send,rw:1==n.send},l.putMboxShareACL(a).then(function(){c?t.notify(d.t("setting/msg_mboxShareAccountUpdateSuccess")):t.notify(d.t("setting/msg_mboxShareAccountCreateSuccess")),s._fetchData(),s.set("editMode",!1)})):r.alert(d.t("setting/msg_mboxShareAccountInvalid"))})},_handleEditMbox:function(e){var n=this;l.auth2continue(o.getLockOpValues().mboxShare).then(function(){var i=e.uid,a=t.grep(n.get("mboxShareAccount"),function(e){return e.uid==i})[0],r=n.compile(n.$("#mboxShareAccountEditTpl").html(),a);n.$(".m-edit-share").html(r),n._contactAutoComplete(),n.element.customRadioCheckbox(),n.set("editMode",!0)})},_contactAutoComplete:function(){var e=this;this.$("input[role=contact]").contactac({enableSecurityLevel:e.config.enableSecurityLevel,select:function(t){e.$("input[role=contact]").val(t.original.emailaddr)},width:256,zIndex:1e3})},_onRenderMboxShareAccount:function(e){var t=this.compile(this.$("#mboxShareAccountTpl").html(),{acl:e});this.$(".j-mboxShare").html(t)},_onRenderMboxAccessAccount:function(e){var t=this.compile(this.$("#mboxAccessAccountTpl").html(),{account:e});this.$(".j-mboxAccess").html(t).customRadioCheckbox()},_onChangeMboxShareAccount:function(e){var t=this.compile(this.$("#mboxShareAccountTpl").html(),{acl:e});this.$(".j-mboxShare").html(t)},_onChangeEditMode:function(e){this.$(".main-wrapper").toggleClass("toggled",e)}});i.module({name:"setting.advance.mboxshare",template:e("text!template/module/setting/advance/mboxshare/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/advance/pop/index.tpl.html",[],function(){return'<section class="m-popaccount">\r\n\r\n  <div class="main-wrapper">\r\n    <div class="content-wrapper j-popaccount">\r\n\r\n    </div>\r\n\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask" />\r\n    <![endif]-->\r\n\r\n    <!--   POP  -->\r\n    <div class="panel u-scroll m-edit-account edit-panel"></div>\r\n\r\n    <!---->\r\n    <div class="panel u-scroll m-sync-status sync-panel"></div>\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="accountCardTpl">\r\n    <div class="u-btns-top f-ib">\r\n      <button type="button" data-action="syncPOP" data-account-id = "all" class="u-btn u-btn-default">{{i18n "setting/op_receiveAll"}}</button>\r\n      <button type="button" data-action="syncPOP" class="u-btn u-btn-default j-showSyncStatus">{{i18n "setting/op_accountStat"}}</button>\r\n    </div>\r\n    <div class="card-container f-cf">\r\n      [[#each popAccount]]\r\n      <div class="m-popcard f-pr">\r\n        <i class="icontabclose iconfont" data-action="deletePOP" data-account-id="[[id]]" data-account-name="[[username]]"></i>\r\n\r\n        <div class="card-header">\r\n          <h4>[[username]]</h4>\r\n        </div>\r\n\r\n        <div class="card-body">\r\n          <div class="u-form-item">\r\n            <div class="f-fl">\r\n              <label class="u-form-label">[[i18n "pref/pop/server"]]:</label>\r\n            </div>\r\n            <div class="u-form-value">\r\n              <label>[[server]]</label>\r\n            </div>\r\n          </div>\r\n\r\n          <div class="u-form-item">\r\n            <div class="f-fl">\r\n              <label class="u-form-label">[[i18n "pref/pop/username"]]:</label>\r\n            </div>\r\n\r\n            <div class="u-form-value">\r\n              <label>[[username]]</label>\r\n            </div>\r\n          </div>\r\n\r\n          <div class="u-form-item">\r\n            <div class="f-fl">\r\n              <label class="u-form-label">[[i18n "pref/pop/folderName"]]:</label>\r\n            </div>\r\n\r\n            <div class="u-form-value">\r\n              <label>[[folderName]]</label>\r\n            </div>\r\n          </div>\r\n\r\n          <div class="u-form-item">\r\n            <div class="f-fl">\r\n              <label class="u-form-label">[[i18n "setting/lbl_isLeaveOnServer"]]:</label>\r\n            </div>\r\n            <div class="u-form-value">\r\n              <label>[[#compare leaveOnServer "==" true]] [[i18n "pref/pop/yes"]] [[else]] [[i18n "pref/pop/no"]] [[/compare]]</label>\r\n            </div>\r\n          </div>\r\n\r\n          <div class="u-form-item">\r\n            <div class="f-fl">\r\n              <label class="u-form-label">[[i18n "setting/lbl_pop_autosync"]]:</label>\r\n            </div>\r\n            <div class="u-form-value">\r\n              <label>[[#compare autoSync "==" true]] [[i18n "pref/pop/yes"]] [[else]] [[i18n "pref/pop/no"]] [[/compare]]</label>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class="card-footer">\r\n          <a href="javascript:void(0)" data-action="syncPOP" data-account-id="[[id]]">[[i18n "pref/pop/sync"]]</a>\r\n          <a href="javascript:void(0)" data-action="editPOP" data-account-id="[[id]]">[[i18n "pref/pop/modify"]]</a>\r\n        </div>\r\n      </div>\r\n      [[/each]]\r\n      <div class="m-pop-create">\r\n        <div class="m-addcard [[#compare popAccount.length \'>=\' maxCount]]m-addcard-disable[[/compare]]" data-action="addPOP">\r\n          <i class="iconadd iconfont"></i>\r\n        </div>\r\n        <div class="m-pop-notify [[#compare popAccount.length \'<\' maxCount]]f-dn[[/compare]]">\r\n          <span id="popAccountNotify" class="u-notify-desc f-ib f-tac">\r\n           [[[i18n "prop:setting/msg_popAccountOverView" 0=maxCount ]]]\r\n          </span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n  </script>\r\n  <!--POP -->\r\n  <script type="text/x-handlebars-template" id="editAccountTpl">\r\n    <form action="" name="editPopForm" id="editPopForm">\r\n      <div class="u-btns-top">\r\n        <button type="button" data-action="checkPOP" class="u-btn u-btn-primary" id="checkBtn">[[i18n "setting/op_check"]]</button>\r\n        <button type="button" [[#if id]] data-action="updatePOP" [[else]] data-action="savePOP" [[/if]] class="u-btn u-btn-primary" id="saveBtn" >[[i18n "setting/op_save"]] </button>\r\n        <button type="button" data-action="cancel" data-panel= "m-edit-account" class="u-btn u-btn-default">[[i18n "setting/op_cancel"]]</button>\r\n      </div>\r\n      [[#if id]]\r\n      <input type="hidden" name="id" value="[[id]]"/>\r\n      [[/if]]\r\n      <h4 class="sub-header">[[i18n "pref/pop/accountSetUp"]]</h4>\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/mailaddress"]]</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input type="text" name="username" class="u-input j-username" value="[[username]]" autocomplete="off" />\r\n          <span class="notify f-dn">[[i18n "setting/msg_errorEmailFormat"]]</span>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item j-pwd">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/password"]]</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          [[#if id]]\r\n          <input type="text" class="u-input j-fakePwd f-ib" value="*********" />\r\n          <input type="password" class="u-input f-dn j-truePwd" name="password" disabled />\r\n          [[else]]\r\n          <input type="password"  class="u-input" name="password" autocomplete="off"/>\r\n          <span class="notify f-dn">[[i18n "setting/msg_checkPOPEmptyPwd"]]</span>\r\n          [[/if]]\r\n        </div>\r\n      </div>\r\n\r\n      <h4 class="sub-header">[[i18n "pref/pop/receiveSetUp"]]</h4>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/servername"]]</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input type="text" name="server" class="u-input" value="[[server]]" />\r\n          <select class="protocol u-select" name="type" [[#if type]]disabled[[/if]]>\r\n          <option value="pop3" [[#compare type "==" "pop3"]] selected="selected" [[/compare]]>POP3</option>\r\n          [[#if enableImportMailType]]\r\n          <option value="imap" [[#compare type "==" "imap"]] selected="selected" [[/compare]]>IMAP</option>\r\n          [[/if]]\r\n          </select>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/timeLimits"]]</label>\r\n        </div>\r\n        <div class="u-form-value f-fl" id="limitDaysOptions"></div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/folder"]]</label>\r\n        </div>\r\n        <div class="u-form-value f-fl">\r\n          [[#if type]]\r\n          [[[folderOption folderData fid]]]\r\n          <button type="button" data-action="createFolder" class="u-btn u-btn-default">{{i18n "main/bt_createfolder"}}</button>\r\n          [[else]]\r\n          <p class="u-explain">\r\n            <input type="radio" name="fid" value="-1" id="notUseInboxFolder" checked />\r\n            <label class="f-fl f-mgr">[[i18n "pref/pop/popCreateFolder"]]</label>\r\n            <input type="text"  class="u-sm-input u-input f-fl" value="" name="folderName"/>\r\n          </p>\r\n          <p class="u-explain " id="inboxFolder">\r\n            <input type="radio" name="fid" value="1" id="useInboxFolder"/>\r\n            <label class="f-fl">[[i18n "pref/pop/popInbox"]]</label>\r\n          </p>\r\n          <p class="u-explain f-dn" id="rootFolder">\r\n            <input type="radio" name="fid" value="0" />\r\n            <label class="f-fl">[[i18n "pref/pop/rootFolder"]]</label>\r\n          </p>\r\n          [[/if]]\r\n\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/checkOptions"]]</label>\r\n        </div>\r\n        <div class="u-form-value u-single-item f-pr">\r\n          <div class="disabled-mask j-leaveOnServer [[#compare type \'!=\' \'imap\']]f-dn[[/compare]]"></div>\r\n          <label class="f-ib">\r\n            <input type="checkbox" name="leaveOnServer" id="leaveOnServer" value="true" [[#compare leaveOnServer "==" true ]] checked [[/compare]]/>\r\n            <span>[[i18n "setting/lbl_pop_backup"]]</span> &nbsp;&nbsp;\r\n          </label>\r\n          <label class="f-ib">\r\n            <input type="checkbox" name="autoSync" id="autoSync" value="true" [[#compare autoSync "==" true ]] checked [[/compare]] />\r\n            [[i18n "pref/pop/lbl_autosync"]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/port"]]</label>\r\n        </div>\r\n        <div class="u-form-value f-fl">\r\n          <p class="u-explain">\r\n            <input type="text" name="port" class="u-input" value="[[#if port]][[port]][[else]]110[[/if]]" /> [[i18n "pref/pop/defaultport"]] <span id="defaultPort">110</span>\r\n          </p>\r\n          <p class="u-explain">\r\n            <label>\r\n              <input type="checkbox" name="useSSL" value="true" [[#compare useSSL "==" true]]checked[[/compare]] />\r\n              [[i18n "pref/pop/requires_secure_conn"]]\r\n            </label>\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/color"]]</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <span class="square square-bg0"><input type="radio" name="color" value="0" [[#compare color \'==\' 0]]checked[[/compare]]/></span>\r\n          <span class="square square-bg1"><input type="radio" name="color" value="1" [[#compare color \'==\' 1]]checked[[/compare]]/></span>\r\n          <span class="square square-bg2"><input type="radio" name="color" value="2" [[#compare color \'==\' 2]]checked[[/compare]]/></span>\r\n          <span class="square square-bg3"><input type="radio" name="color" value="3" [[#compare color \'==\' 3]]checked[[/compare]]/></span>\r\n          <span class="square square-bg4"><input type="radio" name="color" value="4" [[#compare color \'==\' 4]]checked[[/compare]]/></span>\r\n          <span class="square square-bg5"><input type="radio" name="color" value="5" [[#compare color \'==\' 5]]checked[[/compare]]/></span>\r\n          <span class="square square-bg6"><input type="radio" name="color" value="6" [[#compare color \'==\' 6]]checked[[/compare]]/></span>\r\n          <span class="square square-bg7"><input type="radio" name="color" value="7" [[#compare color \'==\' 7]]checked[[/compare]]/></span>\r\n        </div>\r\n      </div>\r\n\r\n      <h4 class="sub-header">[[i18n "pref/pop/sendSetUp"]]</h4>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label"></label>\r\n        </div>\r\n        <div class="u-form-value u-single-item">\r\n          <label>\r\n            <input type="checkbox" name="delegatedSend" value="true" [[#if smtpHost]] checked [[/if]] />\r\n            [[i18n "setting/lbl_enableSmtpDeliver"]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/name"]] :</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input type="text" class="u-input smtp-field" value="[[name]]" name="name" [[#unless smtpHost]] disabled [[/unless]] /> [[i18n "pref/pop/optional"]]\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/smtpHost"]] :</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input type="text" class="u-input smtp-field" value="[[smtpHost]]" name="smtpHost" [[#unless smtpHost]] disabled [[/unless]] />\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/smtpPort"]]:</label>\r\n        </div>\r\n        <div class="u-form-value f-fl">\r\n          <p class="u-explain">\r\n            <input type="text" class="u-input smtp-field" name="smtpPort"  [[#if smtpHost]]  value="[[smtpPort]]" [[else]] value="25" disabled [[/if]] />\r\n          </p>\r\n          <div class="u-explain f-pr">\r\n            <label>\r\n              <input type="checkbox" name="smtpUseSSL" value="true" [[#unless smtpHost]] disabled [[/unless]]  [[#compare smtpUseSSL "==" true]] checked[[/compare]]/>\r\n              [[i18n "setting/lbl_popaccount_requireSSL"]]\r\n            </label>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "pref/pop/smtpPassword"]]</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input type="text"  class="u-input j-fakePwd smtp-field" id="smtpFakePwd" value=\'[[#if id]] ********* [[else]] [[i18n "pref/pop/notChange"]] [[/if]]\'[[#unless smtpHost]] disabled [[/unless]] />\r\n          <input type="password" name="smtpPassword" class="u-input f-dn j-truePwd smtp-field" disabled />\r\n        </div>\r\n      </div>\r\n\r\n      <h4 class="sub-header">[[i18n "setting/lbl_popAdvanceSet"]]</h4>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "setting/lbl_pop_timeout"]]</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input type="text" class="u-input" name="timeout" value="[[#if timeout]][[timeout]][[else]]60[[/if]]" /> [[i18n "pref/pop/commend"]]\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">[[i18n "setting/lbl_pop_accept_all_certs"]]</label>\r\n        </div>\r\n        <div class="u-form-value u-single-item f-pr">\r\n          <label class="f-ib">\r\n            <input type="checkbox" name="acceptAllCerts" value="true" [[#if acceptAllCerts]] checked [[/if]] [[#unless id]] checked [[/unless]]  />\r\n            [[i18n "pref/pop/accept_all_certs"]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n\r\n    </form>\r\n  </script>\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="syncStatusTpl">\r\n    <div class="u-btns-top">\r\n      <button type="button" data-action ="cancel" data-panel="m-sync-status" class="u-btn u-btn-primary">[[i18n "setting/op_back"]]</button>\r\n    </div>\r\n    <h4 class="sub-header">\r\n      [[i18n "setting/lbl_receiveEmail"]]\r\n    </h4>\r\n    <p>[[accounts.statedesc]]</p>\r\n    <table>\r\n      <thead>\r\n      <tr>\r\n        <td>[[i18n "pref/pop/h_serialNum"]]</td>\r\n        <td>[[i18n "pref/pop/h_account"]]</td>\r\n        <td>[[i18n "pref/pop/h_state"]]</td>\r\n      </tr>\r\n      </thead>\r\n      <tbody>\r\n      [[#each accounts]]\r\n      <tr>\r\n        <td>[[math @index "+" 1]]</td>\r\n        <td>[[username]]</td>\r\n        <td id="status_[[id]]"></td>\r\n      </tr>\r\n      [[/each]]\r\n      </tbody>\r\n    </table>\r\n  </script>\r\n  {{/raw}}\r\n\r\n\r\n</section>'}),define("module/setting/advance/pop/index",["require","util/i18n!setting,pref/pop,main","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","module/common/globalService","./../../../mail/service","./../../service","../../../../util/index","../../../../configurable/index","moment","text!template/module/setting/advance/pop/index.tpl.html"],function(e){function t(e,t){return(t.match(/\bswitched\S+/g)||[]).join(" ")}e("util/i18n!setting,pref/pop,main");var n=e("jquery"),i=e("cui/core/view/view"),a=e("cui/core/view/viewmanager"),r=e("cui/util/templatable/templatable"),s=e("component/confirmbox"),o=e("module/common/globalService"),l=e("./../../../mail/service"),c=e("./../../service"),d=e("../../../../util/index"),u=e("../../../../configurable/index"),p=e("moment"),m=i.extend({Implements:r,templateHelpers:{folderOption:function(e,t){var i=n("<select />",{name:"fid","class":"u-select folder"});return i.append(n("<option />").attr("value",0).text(d.i18n.t("pref/pop/rootFolder"))),n.each(e,function(e,a){i.append(n("<option />").attr("value",a.id).attr("selected",t==a.id).text(new Array(a.deepLevel).join("")+d.html.encode(a.name)))}),i[0].outerHTML}},render:function(){m.superclass.render.call(this),this._initView(!0),this._initModuleEvent()},setup:function(){this.state=o.getCurrentState(),this._param={folderData:null},this.config=u("setting.advance.pop")},events:{"click [data-action]":"_dispatchAction","change select.protocol":"_setProtocol","blur .j-username":"_addServerName","blur .j-pwd input":"_checkPwdIsEmpty","keyup .j-username":"_changeCreateFolderName","click input[name='useSSL']":"_changeServerPort","click input[name='smtpUseSSL']":"_changeSMTPPort","click input[name='delegatedSend']":"_toggleSmtpFields","focus .j-fakePwd":"_removeFakeInput","blur  .j-truePwd":"_resumeFakeInput"},_initView:function(e){var t,i=this;i.element.mask(),n.when(c.getPOPAccounts(),l.getFolders(!0,!0,!0)).then(function(a,r){if(i._param.popData=a,i._param.folderData=r,n.each(i._param.popData,function(e,t){t.folderName=i._getFolderNameById(t.fid)}),t=i.compile(i.$("#accountCardTpl").html(),{popAccount:i._param.popData,maxCount:i.config.popMaxCount}),i.$(".j-popaccount").html(t),i.element.mask("hide"),i.$("[data-account-id='all']").prop("disabled",0==a.length),e&&i.state.param.action)switch(o.setCurrentState({module:"setting.account.pop",param:{}}),i.state.param.action){case"sync":var s=o.getCurrentState().param.id;i.$("[data-action='syncPOP']").filter("[data-account-id='"+s+"']").click();break;case"progress":i.$(".j-showSyncStatus").click()}})},_initModuleEvent:function(){var e=this;e.onMessage("sync",function(t){var n=t.message.param.id;e.$("[data-action='sync']").filter("[data-account-id='"+n+"']").click()},null)},_dispatchAction:function(e,t){var i=n(t),a=i.data("action");switch(a){case"addPOP":this._handleAddPopAccount();break;case"editPOP":this._handleEditPopAccount(i);break;case"deletePOP":this._handleDeletePopAccount(i);break;case"checkPOP":this._handleChkPopAccount(i);break;case"savePOP":this._handleSavePopAccount();break;case"updatePOP":this._handleUpdatePopAccount();break;case"syncPOP":this._handleSyncPopAccount(i);break;case"createFolder":this._handleCreateFolder();break;case"cancel":this._handleClosePanel()}},_handleAddPopAccount:function(){if(this._param.popData.length>=this.config.popMaxCount)for(var e=0;2>e;e++)this.$(".m-pop-notify").fadeTo("fast",.5).fadeTo("fast",1);else{var n=this.compile(this.$("#editAccountTpl").html(),{enableImportMailType:this.config.enableImportMailType});this.$(".m-edit-account").html(n),this._initLimitDays(),this.element.customRadioCheckbox(),this.$(".main-wrapper").removeClass(t).addClass("switched-edit")}},_handleEditPopAccount:function(e){var n,i,a=e.data("account-id"),r=this;c.getPOPAccounts([a]).then(function(e){n=e[0],n.folderData=r._param.folderData,n.folderName=r._getFolderNameById(n.fid),n.enableImportMailType=r.config.enableImportMailType,i=r.compile(r.$("#editAccountTpl").html(),n),r.$(".m-edit-account").html(i),r._initLimitDays(n.limitDays),r.$("#defaultPort").html(r._getDefaultPort()),r.element.customRadioCheckbox(),r.$(".main-wrapper").removeClass(t).addClass("switched-edit")})},_handleDeletePopAccount:function(e){var t=e.data("account-id"),i=e.data("account-name"),a=d.messageFormat.format(d.i18n.t("setting/msg_popaccountDelConfirm"),i),r=this;s.confirm(a,function(){n.when(c.deletePOPAccounts([t])).then(function(){n.notify.success(d.i18n.t("setting/msg_deletePOPaccountSuccess")),e.parent(".m-popcard").remove(),r._param.popData=n.grep(r._param.popData,function(e){return e.id!=t}),r.$("[data-account-id='all']").prop("disabled",0==r._param.popData.length),r._updatePopAccountsCount(),r.sendMessage("mail","folder:refresh",{type:"all"}),r.sendMessage("setting.advance.folder","folder:refresh",{}),l.getAllAccounts().then(function(e){o.updateConfig("user.allemails",e),r.publish("accounts:refresh",{})})})})},_handleChkPopAccount:function(){var e,t=this.$("form[name='editPopForm']").serializeJSON({parseBooleans:!1,checkboxUncheckedValue:!1});return t.id||t.password?(e=this._handleAccountObj(t),n.notify.success(d.i18n.t("setting/msg_checkingPOPAccount"),{forever:!0,closeIcon:!1}),void n.when(c.checkPOPAccount(e)).then(function(e){function t(e){switch(e.smtpFailCode){case"FA_BAD_PASSWORD":n.notify.error(d.i18n.t("setting/msg_checkPOPSMTPPwdWrong"));break;case"FA_BAD_CERT":n.notify.error(d.i18n.t("setting/msg_checkPOPSMTPCertError"));break;case"FA_BAD_SERVER":n.notify.error(d.i18n.t("setting/msg_checkPOPSMTPServerError"))}}switch(e.code){case"FA_FORBIDDEN":n.notify.error(d.i18n.t("setting/msg_checkPOPForbidden"));break;case"FA_INVALID_PARAMETER":n.notify.error(d.i18n.t("setting/msg_checkPOPInvaild"));break;case"FA_BAD_SERVER":n.notify.error(d.i18n.t("setting/msg_checkPOPBadServer"));break;case"FA_BAD_PASSWORD":n.notify.error(d.i18n.t("setting/msg_checkPOPBadPassword"));break;case"FA_SMTP_FAILED":t(e["var"]);break;case"FA_CONNECT_TIMEOUT":n.notify.error(d.i18n.t("setting/msg_checkPOPTimeOut"));break;case"FA_ACCOUNT_EXISTS":n.notify.error(d.i18n.t("setting/msg_popAccountExist"));break;case"FS_UNKNOWN":n.notify.error(d.i18n.t("setting/msg_popUnknownError"));break;case"S_OK":n.notify.success(d.i18n.t("setting/msg_checkPOPOK"))}},function(){n.notify.error(d.i18n.t("setting/msg_connectTimeout"))})):(this.$(".j-pwd").addClass("error"),this.$("#checkBtn").prop("disabled",!0),void this.$("#saveBtn").prop("disabled",!0))},_handleSavePopAccount:function(){var e=this,i=this.$("form[name='editPopForm']").serializeJSON({parseBooleans:!0,checkboxUncheckedValue:!1}),a=i.delegatedSend||!1;"-1"==i.fid?delete i.fid:"",c.createPOPAccount(i).then(function(r){switch(r.code){case"FA_INVALID_PARAMETER":s.alert(d.i18n.t("setting/msg_popAccountInvaild"));break;case"FA_ACCOUNT_EXISTS":s.alert(d.i18n.t("setting/msg_popAccountExist"));break;case"S_OK":if(n.notify.success(d.i18n.t("setting/msg_popAccountSucceed")),e.$(".main-wrapper").removeClass(t),e._initView(),i.fid||(e.sendMessage("mail","folder:refresh",{type:"all"}),e.sendMessage("setting.advance.folder","folder:refresh",null)),a){var u=r["var"][0];c.checkPOPAccount({id:u,checkSMTP:!0,updateDelegatedSend:!0,autoUpdate:!0}).then(function(){n.when(l.getAllAccounts()).then(function(e){o.updateConfig("user.allemails",e)})})}}})},_handleUpdatePopAccount:function(){var e,i=this.$("form[name='editPopForm']").serializeJSON({parseBooleans:!0,checkboxUncheckedValue:!1}),a=this;i.delegatedSend||(i.name="",i.smtpHost="",i.smtpPort="",i.smtpUseSSL=!1,i.smtpPassword=""),c.updatePOPAccounts([i]).then(function(){a.$(".main-wrapper").removeClass(t),a._initView(),a.sendMessage("mail","folder:refresh",{type:"all"}),a.sendMessage("setting.advance.folder","folder:refresh",null),i.delegatedSend&&(e=parseInt(i.id,10),n.when(c.checkPOPAccount({id:e,checkSMTP:!0,updateDelegatedSend:!0,autoUpdate:!0})).then(function(){n.when(l.getAllAccounts()).then(function(e){o.updateConfig("user.allemails",e)})}))})},_handleSyncPopAccount:function(e){var i,a,r,s=e.data("account-id"),o=this;switch("number"==typeof s?(r="single",a=n.grep(this._param.popData,function(e){return e.id==s})):"all"==s?(r="all",a=this._param.popData):(r="none",a=this._param.popData),i=this.compile(this.$("#syncStatusTpl").html(),{accounts:a}),this.$(".m-sync-status").html(i),this.$(".main-wrapper").removeClass(t).addClass("switched-sync"),this._param.notEndPopIds=[],r){case"single":c.syncPOPAccounts([s]).then(function(){o._updatePopAccountsUntilEnd([s])});break;case"all":c.syncAllPOPAccounts().then(function(){o._updatePopAccountsUntilEnd()});break;case"none":o._updatePopAccountsUntilEnd()}},_handleCreateFolder:function(){var e="<div class ='diaglog-item'><label class='label'>"+d.i18n.t("setting/msg_inputFolderName")+"</label> &nbsp;&nbsp;&nbsp;<input type='text' name='folderName' class='j-newPOPFolder'/></div>",t=this;s.confirm(e,function(){var e=n("newPOPFolder").val(),i={name:e,parent:0},a=c.isValidString(e);"valid"==a?n.when(c.createFolders([i])).then(function(i){switch(i.code){case"FA_NAME_RESERVED":n.notify.error(d.i18n.t("main/err_folder_NAME_RESERVED"));break;case"FA_NAME_EXISTS":n.notify.error(d.i18n.t("main/err_folder_NAME_EXISTS"));break;case"FA_NAME_INVALID":n.notify.error(d.i18n.t("main/err_folder_NAME_INVALID"));break;case"S_OK":n.notify.success(d.i18n.t("setting/msg_createFolderSuccess"));var a=i["var"][0];t.$("select[name='fid']").append(n("<option />",{value:a,selected:!0,text:e})),t._initView(),t.sendMessage("mail","folder:refresh",{type:"all"}),t.sendMessage("setting.folder.folder","folder:refresh",null)}}):n.notify.error(d.i18n.t("setting/msg_err_folder_"+a))})},_handleClosePanel:function(){this.$(".main-wrapper").removeClass(t),this._param.timer&&(clearTimeout(this._param.timer),this._param.timer=null,this._param.notEndPopIds=[])},_getFolderNameById:function(e){var t="";return n.each(this._param.folderData,function(n,i){return e==i.id?(t=i.name,!1):void 0}),t},_setProtocol:function(e){var t=e.target.value,n=this.$("#editPopForm"),i=n.find("#defaultPort"),a=n.find("#leaveOnServer"),r=n.find("#notUseInboxFolder"),s=n.find("input[name=port]"),o=n.find("input[name=server]"),l=n.find(".j-leaveOnServer"),c=n.find("input[name=useSSL]").is(":checked"),d=o.val();h.checkAndActiveChk(a,"checkbox"),r.trigger("click"),n.find("#inboxFolder").toggle(),n.find("#rootFolder").toggle(),"pop3"==t?(l.hide(),i.html(c?"995":"110"),s.val(c?995:110),o.val(d.replace(/(^imap)/g,"pop"))):"imap"==t&&(l.show(),i.html(c?"993":"143"),s.val(c?993:143),h.checkChk(a,"checkbox"),o.val(d.replace(/(^pop)/g,"imap")))},_addServerName:function(e){var t=e.target.value,i=this.config.userDomainName,a=this.$("#editPopForm"),r=a.find("input[name=server]"),s=a.find("input[name=smtpHost]"),o=a.find("select[name=type]");d.Email.test(t)?(n(e.target).parents(".u-form-item").removeClass("error"),this.$("#checkBtn").prop("disabled",!1),this.$("#saveBtn").prop("disabled",!1)):(n(e.target).parents(".u-form-item").addClass("error"),this.$("#checkBtn").prop("disabled",!0),this.$("#saveBtn").prop("disabled",!0)),""==t||""!=r.val()&&""!=s.val()||(t.indexOf("@")>-1&&(i=t.replace(/.*@/,"")),"pop3"==o.val()&&""==r.val()&&r.val("pop."+i),"imap"==o.val()&&""==r.val()&&r.val("imap."+i),""==s.val()&&s.val("smtp."+i))},_checkPwdIsEmpty:function(e){var t=e.target.value,n=this.$(".j-pwd");t?(n.removeClass("error"),this.$("#checkBtn").prop("disabled",!1),this.$("#saveBtn").prop("disabled",!1)):(n.addClass("error"),this.$("#checkBtn").prop("disabled",!0),this.$("#saveBtn").prop("disabled",!0))},_changeCreateFolderName:function(e){this.$("input[name='folderName']").val(e.target.value)},_resumeFakeInput:function(e){var t=n(e.target);""==t.val()&&t.addClass("f-dn").prop("disabled",!0).siblings("input").show()},_removeFakeInput:function(e){n(e.target).blur().hide().siblings("input").removeClass("f-dn").prop("disabled",!1).focus()},_changeServerPort:function(){var e=this.$("input[name='port']"),t=this._getDefaultPort(),n=this.$("#defaultPort");e.val(t),n.html(t)},_changeSMTPPort:function(){var e=this.$("input[name='smtpPort']"),t=e.val();e.val("994"==t?"25":"994")},_toggleSmtpFields:function(){var e=this.$("#editPopForm"),t=e.find("input[name='delegatedSend']").is(":checked"),n=e.find(".smtp-field"),i=e.find("input[name='smtpUseSSL']");t?(n.prop("disabled",!1),h.unCheckAndDisableChk(i,"checkbox"),h.activeChk(i)):(n.prop("disabled",!0),h.unCheckAndDisableChk(i,"checkbox"))},_handleAccountObj:function(e){var t={};return"id"in e&&(t.id=parseInt(e.id),delete e.id),"-1"==e.fid&&delete e.fid,t.checkSMTP=e.delegatedSend?!0:!1,t.item=e,t},_updatePopAccounts:function(e,t){var i=this,a=this.config.locale||"";c.getPOPAccounts(e,!1).then(function(e){n.each(e,function(e,r){var s,o,l="",c=r.id;if(!r.stats)return l=d.i18n.t("setting/msg_popSyncNotTrigger"),i.$("#status_"+c).html(l),!1;var u=r.stats.code,m=r.stats.failedMessage,h=r.stats.messageSize,f=r.stats.receivedMessageSize,v=r.stats.skippedMessageSize,g=r.stats.startTime,b=r.stats.endTime,_=r.stats.messageCount,y=r.stats.receivedMessageCount,w=r.stats.skippedMessageCount,x=r.stats.exceedQuota,C=r.stats.userReject,k=b&&"PENDING"!=u,S=h>f+v?(f+v)/h:1,T=r.limitDays;if(isNaN(S)&&(S=0),s=m&&"FA_BAD_PASSWORD"!=u&&"FA_BAD_CERT"!=u&&"FA_BAD_SERVER"!=u?d.i18n.t("pref/pop/NOT_VALID").replace("{0}",m):u?d.i18n.t("pref/pop/"+u):d.i18n.t("pref/pop/NOT_START"),
l+='<span class="f-ib f-fl">'+s+"</span>","PENDING"!=u){if(l+='<div class="u-progress f-mgl f-ib f-vm f-fl"><div class="u-progress-bar" id=\'processbar_'+c+'\' style="width:0"></div></div>',g&&(l+='<p class="f-cb">'+d.i18n.t("pref/pop/startTime")+":&nbsp;&nbsp;"+p(g).format("YYYY-MM-DD HH:mm:ss")+"</p>"),b&&(l+="<p>"+d.i18n.t("pref/pop/endTime")+":&nbsp;&nbsp;"+p(b).format("YYYY-MM-DD HH:mm:ss")+"</p>"),"S_OK"!=u&&(_&&(l+="<p>"+d.i18n.t("pref/pop/runningStatus").replace("{0}",_)+d.size.bytesToSize(h,2)+"</p>"),y&&(l+="<p>"+d.i18n.t("pref/pop/runningReceivedStatus").replace("{0}",y).replace("{1}",d.size.bytesToSize(f,2)).replace("{2}",(100*S).toFixed(2)+"%")+"</p>")),"S_OK"==u&&(l+="<p>"+d.i18n.t("pref/pop/receivedCount").replace("{0}",y)+" ("+d.i18n.t("pref/pop/timeLimits")+(T?d.i18n.t("pref/pop/limitDaysLabel",{date:p(T.toString().substring(1),"YYYYMMDD").locale(a).format("LL")}):d.i18n.t("pref/pop/allMails"))+")</p><p>"+d.i18n.t("pref/pop/receivedSize")+"&nbsp;"+d.size.bytesToSize(f,2)+"</p>"),w>0){var j="";x&&(j=d.i18n.t("pref/pop/exceedQuota")),C&&(j+=(j.length>0?"/":"")+d.i18n.t("pref/pop/userReject")),j.length>0&&(j="("+j+")"),j+=d.i18n.t("pref/pop/sikpNum").replace("{0}",w),l+="<p>"+j+d.size.bytesToSize(v,2)+"</p>"}if(i.$("#status_"+c).html(l),h&&f){var I=(100*S).toFixed(2)+"%";i.$("#processbar_"+c).css("width",I)}"S_OK"==u&&i.$("#processbar_"+c).css("width","100%")}o=n.inArray(c,i._param.notEndPopIds),k?i._param.notEndPopIds.splice(o,1):-1==o&&i._param.notEndPopIds.push(c),t&&t()})})},_updatePopAccountsUntilEnd:function(e){var t=this,n=function(){t._param.notEndPopIds.length>0?t._param.timer=setTimeout(function(){t._updatePopAccounts(t._param.notEndPopIds,n)},1e3):clearTimeout(t._param.timer)};t._updatePopAccounts(e,n)},_updatePopAccountsCount:function(){var e=d.messageFormat.format(d.i18n.t("setting/msg_popAccountOverView"),[this._param.popData.length,this.config.popMaxCount]);this.$(".m-addcard").toggleClass("m-addcard-disable",this._param.popData.length>=this.config.popMaxCount),this.$(".m-pop-notify ").toggleClass("f-dn",this._param.popData.length<this.config.popMaxCount),this.$("#popAccountNotify").html(e)},_initLimitDays:function(e){var t,i,a,r=this.config.locale||"",s=this.$("#limitDaysOptions"),o=[7,14,30,60,90,183],l=[d.i18n.t("pref/pop/lastWeek"),d.i18n.t("pref/pop/last2Week"),d.i18n.t("pref/pop/lastMonth"),d.i18n.t("pref/pop/last2Month"),d.i18n.t("pref/pop/last3Month"),d.i18n.t("pref/pop/lastHalfYear")];e=e?""+e:"0","0"==e?(t='<p class="u-explain"><label><input type="radio" name="limitDays" value="0" checked />'+d.i18n.t("pref/pop/allMails")+"</label></p>",n.each(o,function(e,n){a=p().subtract(n,"days"),i='<p class="u-explain"><label><input type="radio" name="limitDays" value="-'+a.format("YYYYMMDD")+'" />'+l[e]+" ("+d.i18n.t("pref/pop/limitDaysLabel",{date:a.locale(r).format("LL")})+")</label></p>",t+=i})):(t='<p class="u-explain"><label><input type="radio" name="limitDays" value="0" />'+d.i18n.t("pref/pop/allMails")+"</label></p>",i='<p class="u-explain"><label><input type="radio" name="limitDays" value="'+e+'" checked />'+d.i18n.t("pref/pop/limitDaysLabel",{date:p(e.substring(1),"YYYYMMDD").locale(r).format("LL")})+"</label></p>",t+=i),s.html(t)},_getDefaultPort:function(){var e=this.$("select.protocol").val(),t=this.$("input[name=useSSL]").is(":checked");return"pop3"==e?t?"995":"110":"imap"==e?t?"993":"143":void 0}});a.module({name:"setting.advance.pop",template:e("text!template/module/setting/advance/pop/index.tpl.html")},m);var h={chkDisableClass:"rc-disabled",chkCheckedClass:"-checked",disableChk:function(e){e.prop("disabled",!0).next("i").addClass(this.chkDisableClass)},activeChk:function(e){e.prop("disabled",!1).next("i").removeClass(this.chkDisableClass)},unCheckChk:function(e,t){e.prop("checked",!1).next("i").removeClass(t+this.chkCheckedClass)},checkChk:function(e,t){e.prop("checked",!0).next("i").addClass(t+this.chkCheckedClass)},checkAndActiveChk:function(e,t){this.checkChk(e,t),this.activeChk(e)},unCheckAndDisableChk:function(e,t){this.unCheckChk(e,t),this.disableChk(e)}}}),define("components/requirejs-text/text!template/module/setting/advance/pop3set/index.tpl.html",[],function(){return'<div class="m-st-client-pop3-wrap">\r\n  <!-- subView is use to toggle -->\r\n  <div class="m-st-client-pop3-edit f-dn" data-toggle="subview"></div>\r\n  <div class="m-st-client-pop3-view" data-toggle="subview"></div>\r\n\r\n\r\n  <!-- region pop3 Edit Tpl -->\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="clientPop3EditTpl" data-container=".m-st-client-pop3-edit">\r\n    <form method="post" name="pop3" id="clientPop3Edit">\r\n      <div class="u-btns-top">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="save">[[i18n "setting/op_save"]]</button>\r\n        <button type="reset"  class="u-btn u-btn-default" data-action="cancel">[[i18n "setting/op_cancel"]]</button>\r\n      </div>\r\n      <div class="title dotted">\r\n        <h4>[[ i18n "setting/lbl_pop3setting" ]]</h4>\r\n      </div>\r\n      <div class="u-form-item m-st-client-pl-20">\r\n        <div class="input u-checkbox">\r\n          <input type="checkbox" class="u-input" name="chargeOther" id="chargeOther"\r\n                 [[#compare otherPop3 \'!=\' 0]]checked [[/compare]] [[#compare otherPop3Blank \'!=\' 0]] disabled="disabled" [[/compare]]>\r\n          <label for="chargeOther">[[i18n "setting/lbl_folderOtherReception"]]</label>\r\n        </div>\r\n      </div>\r\n      <div class="u-form-item m-st-client-pl-20">\r\n        <div class="input u-checkbox">\r\n          <input type="checkbox" class="u-input" name="chargeJunk" id="chargeGarbage"\r\n                 [[#compare junkPop3 \'!=\' 0]]checked [[/compare]]>\r\n          <label for="chargeGarbage">[[i18n "setting/lbl_folderJunkReception"]]</label>\r\n        </div>\r\n      </div>\r\n      <div class="list-item gray">\r\n        [[i18n "setting/msg_pop3Set_desc1"]]\r\n      </div>\r\n      <div class="list-item">\r\n        [[i18n "setting/msg_pop3Set_desc2"]]\r\n      </div>\r\n    </form>\r\n  </script>\r\n  {{/raw}}\r\n  <!-- endregion -->\r\n\r\n  <!-- region pop3 View Tpl -->\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="clientPop3ViewTpl" data-container=".m-st-client-pop3-view">\r\n    <div class="u-btns-top">\r\n      <button type="button" class="u-btn u-btn-primary" data-action="edit">{{i18n \'setting/op_edit\'}}</button>\r\n    </div>\r\n    <div class="title dotted">\r\n      <h4>[[ i18n "setting/lbl_pop3setting" ]]</h4>\r\n    </div>\r\n    <div class="list-item">\r\n      <i class="iconfont [[#compare otherPop3 \'!=\' 0]]iconchoose[[else]]iconerror[[/compare]]"></i>\r\n      [[i18n "setting/lbl_folderOtherReception"]]\r\n    </div>\r\n    <div class="list-item">\r\n      <i class="iconfont [[#compare junkPop3 \'!=\' 0]]iconchoose[[else]]iconerror[[/compare]]"></i>\r\n      [[i18n "setting/lbl_folderJunkReception"]]\r\n    </div>\r\n    <div class="list-item gray">\r\n      [[i18n "setting/msg_pop3Set_desc1"]]\r\n    </div>\r\n    <div class="list-item">\r\n      [[i18n "setting/msg_pop3Set_desc2"]]\r\n    </div>\r\n  </script>\r\n  {{/raw}}\r\n  <!-- endregion -->\r\n\r\n</div>\r\n\r\n\r\n\r\n\r\n'}),define("module/setting/advance/pop3set/index",["require","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","util/i18n","./../../../mail/service","./../../service","text!template/module/setting/advance/pop3set/index.tpl.html"],function(e){var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("util/i18n"),s=e("./../../../mail/service"),o=e("./../../service"),l=n.extend({Implements:a,pop3Setting:{otherPop3:!1,otherPop3Blank:!1,junkPop3:!1},otherFolders:[],junkFolder:null,events:{"click [data-action]":"_dispatchAction"},setup:function(){},destroy:function(){l.superclass.destroy.call(this)},render:function(){var e=this;l.superclass.render.call(this),t.when(s.getFolders(!0)).then(function(t){for(var n=0,i=t.length;i>n;n++){var a=t[n];a.id<0||(a.flags.system===!0?5===a.id&&(e.junkFolder=a):a.isPOP||e.otherFolders.push(a))}e._initPop3Setting.call(e),e._initView.call(e,!0)})},_initPop3Setting:function(){var e=this,n=!0;e.otherFolders.length?(e.pop3Setting.otherPop3Blank=!1,t.each(e.otherFolders,function(e,t){return t.flags.pop3?void 0:n=!1}),e.pop3Setting.otherPop3=n):(e.pop3Setting.otherPop3Blank=!0,e.pop3Setting.otherPop3=!1),e.pop3Setting.junkPop3=!!e.junkFolder.flags.pop3},_initView:function(e){var t=this;e&&t._initPop3ViewTpl.call(t)},_initSubTpl:function(e){var t,n,i,a=this;return e?(t=a.$(e),n=a.compile(t.html(),a.pop3Setting),i=a.$(t.attr("data-container")),void i.html(n).customRadioCheckbox()):a._initPop3EditTpl.call(a)},_initPop3ViewTpl:function(){this._initSubTpl.call(this,"#clientPop3ViewTpl")},_initPop3EditTpl:function(){this._initSubTpl.call(this,"#clientPop3EditTpl")},_toggleView:function(){var e=this;e.$('[data-toggle="subview"]').toggleClass("f-dn")},_dispatchAction:function(e,n){e.preventDefault();var i=this,a=t(n).attr("data-action");switch(a){case"edit":i._initPop3EditTpl.call(i),i._toggleView();break;case"save":i._handleSubmit.call(i,e,n);break;case"cancel":i._initPop3ViewTpl.call(i),i._toggleView()}},_handleSubmit:function(){var e=this,n=e.$('form[name="pop3"]').serializeJSON(),i=[];e.pop3Setting.otherPop3=!!n.chargeOther,e.pop3Setting.junkPop3=!!n.chargeJunk,t.each(e.otherFolders,function(t,n){n.flags.pop3=e.pop3Setting.otherPop3,i.push({id:n.id,flags:{pop3:e.pop3Setting.otherPop3}})}),e.junkFolder.flags.pop3=e.pop3Setting.junkPop3,i=i.concat([{id:e.junkFolder.id,flags:{pop3:e.pop3Setting.junkPop3}}]),t.when(o.updateFolders(i)).then(function(){e._initPop3ViewTpl.call(e),e._toggleView()},function(){t.notify.error(r.t("setting/msg_savefailed"))})}});i.module({name:"setting.advance.pop3set",template:e("text!template/module/setting/advance/pop3set/index.tpl.html")},l)}),define("module/setting/advance/smsnotification/service",["require","jquery","../../../../util/index","module/common/globalService"],function(e){function t(){var e=n.Deferred();return i.xhr.simpleCall({query:{func:"user:getSMSAttrs",sid:a.getSid()}},function(t){e.resolve(t)},function(t,n,i){e.reject(i)}),e.promise()}var n=e("jquery"),i=e("../../../../util/index"),a=e("module/common/globalService");return{getUserSmsAttrs:t}}),define("components/requirejs-text/text!template/module/setting/advance/smsnotification/index.tpl.html",[],function(){return'<section class="m-smsnotification">\r\n    <section class="j-smsnotification"></section>\r\n\r\n    <script type="text/x-handlebars-template" id="unbindMobileTpl">\r\n        {{#raw}}\r\n        <div id="unbindMobile" class="mainPanel">\r\n            <div class="content">\r\n                <div class="grid-col12 j-pwd-info">\r\n                    <div class="u-form-item">\r\n                        [[#if config.enableCellphoneBinding]]\r\n                            [[i18n "pref/mobile/pleasebind_xt5"]]\r\n                            <a href="#" data-action="toBind">[[i18n "pref/mobile/gobinding"]]</a>\r\n                        [[else]]\r\n                        <div class="u-not-phone">\r\n                            <i class="icon iconfont u-not-phone-icon">&#xe662;</i>\r\n                            [[i18n "pref/mobile/contactAdmin"]]\r\n                        </div>\r\n                        [[/if]]\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        {{/raw}}\r\n    </script>\r\n\r\n    <script type="text/x-handlebars-template" id="mmsSettingTpl">\r\n        {{#raw}}\r\n        <div class="mainPanel" id="mmsSetting">\r\n            <div class="u-btns-top">\r\n                <button type="button" class="u-btn u-btn-primary" data-action="save">[[i18n "setting/op_save"]]</button>\r\n                <button type="button" class="u-btn u-btn-default" data-action="cancel">[[i18n "setting/op_cancel"]]</button>\r\n            </div>\r\n            <div class="notifyConf">\r\n                <div class="title dotted">\r\n                    <h4>[[i18n "setting/lbl_smsnotification"]]</h4>\r\n                </div>\r\n                <div class="u-form-item">\r\n                    <label class="u-form-label f-dis">[[i18n "pref/mobile/isopen"]] </label>\r\n                    <div class="u-form-value">\r\n                        <div>\r\n                            <label>\r\n                                <input type="radio" name="notify" value="1" [[#compare notify \'==\' true]] checked="checked" [[/compare]] />\r\n                                [[i18n "pref/mobile/yes"]]\r\n                            </label>\r\n                        </div>\r\n                        <div>\r\n                            <label>\r\n                                <input type="radio" name="notify" value="0" [[#compare notify \'==\' false]] checked="checked" [[/compare]]/>\r\n                                [[i18n "pref/mobile/no"]]\r\n                            </label>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            [[#if config.enableSMSFilter]]\r\n            <div class="mobileRecTimeSet">\r\n                <div class="title dotted">\r\n                    <h4>[[i18n "pref/mobile/receive_time"]]</h4>\r\n                </div>\r\n                <div class="u-form-item f-rel">\r\n                    <label class="u-form-label f-dis">[[i18n "pref/mobile/time"]] :&nbsp;&nbsp;</label>\r\n                    <select name="datefrom" class="u-select j-select-beginHour">\r\n                        [[[timeOptionCreater \'datefrom\' 0 23 sms_filter.datefrom 0]]]\r\n                    </select>\r\n                    <span class="f-dis">&nbsp;:&nbsp;</span>\r\n                    <select name="minfrom" class="u-select j-select-beginHour">\r\n                        [[[timeOptionCreater \'minfrom\' 0 59 sms_filter.minfrom 0]]]\r\n                    </select>\r\n                    <span class="f-dis">&nbsp;~&nbsp;</span>\r\n                    <select name="dateto" class="u-select j-select-beginHour">\r\n                        [[[timeOptionCreater \'dateto\' 0 23 sms_filter.dateto 23]]]\r\n                    </select>\r\n                    <span class="f-dis">&nbsp;:&nbsp;</span>\r\n                    <select name="minto" class="u-select j-select-endHour">\r\n                        [[[timeOptionCreater \'minto\' 0 59 sms_filter.minto 59]]]\r\n                    </select>\r\n                </div>\r\n                <div class="u-form-item">\r\n                    <label class="u-form-label f-dis">[[i18n "pref/mobile/date"]] :&nbsp;&nbsp;</label>\r\n                    <div class="u-form-value">\r\n                        [[#each common.type]]\r\n                        <div>\r\n                            <label>\r\n                                    <input type="radio" name="interval" value="[[this]]" id="[[this]]"\r\n                                       [[#compare this \'==\' @root.sms_filter.intervalType]] checked="checked" [[/compare]] />\r\n                                [[formatResource "pref/mobile/interval_{0}" this]]\r\n                            </label>\r\n                        </div>\r\n                        [[/each]]\r\n                        <div class="customInterval">\r\n                            [[#each common.customDays]]\r\n                                <span>\r\n                                   <label>\r\n                                       <input type="checkbox" name="customInterval" value="[[this]]" [[[customIntervalCheck this @root.sms_filter.interval @root.sms_filter.intervalType]]]/>\r\n                                       [[formatResource "pref/mobile/interval_day_{0}" this]]\r\n                                   </label>\r\n                                </span>\r\n                                [[#compare this \'==\' 5]]\r\n                                    <br/>\r\n                                [[/compare]]\r\n                            [[/each]]\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div class="mobileMailFilter">\r\n                <div class="title dotted">\r\n                    <h4>[[i18n "pref/mobile/phone_email_filter"]]</h4>\r\n                </div>\r\n                <div class="u-form-item">\r\n                    <div class="WBListDiv">\r\n                        <div class="whiteDiv">\r\n                           <label>\r\n                               <input type="radio" name="WBList" value="white" [[#compare sms_filter.enableWhite \'==\'true]]checked="checked"[[/compare]]/>\r\n                               [[i18n "pref/mobile/white_list"]]\r\n                               ( [[i18n "pref/mobile/white_list_desc"]] )\r\n                           </label>\r\n                            [[#if config.isEnableAddedFromOab]]\r\n                                <a href="javascript:void(0)" data-action="addFromContact_white" class="iconfont iconadd" title="{{i18n "setting/op_addFromContact"}}"></a>\r\n                            [[/if]]\r\n                        </div>\r\n                        <div>\r\n                            <textarea name="whiteContent" id="whiteContent" cols="50" rows="5">[[sms_filter.white]]</textarea>\r\n                        </div>\r\n                    </div>\r\n                    <div class="WBListDiv">\r\n                        <div class="blackDiv">\r\n                            <label>\r\n                                <input type="radio" name="WBList" value="black" [[#compare sms_filter.enableBlack \'==\'true]]checked="checked"[[/compare]]/>\r\n                                [[i18n "pref/mobile/black_list"]]\r\n                                ( [[i18n "pref/mobile/black_list_desc"]] )\r\n                            </label>\r\n                            [[#if config.isEnableAddedFromOab]]\r\n                                <a href="javascript:void(0)" data-action="addFromContact_black" class="iconfont iconadd" title="{{i18n "setting/op_addFromContact"}}"></a>\r\n                            [[/if]]\r\n                        </div>\r\n                        <div>\r\n                            <textarea name="blackContent" id="blackContent" cols="50" rows="5">[[sms_filter.black]]</textarea>\r\n                        </div>\r\n                    </div>\r\n                    <div class="desc">\r\n                        <label class="u-form-label f-dis">[[i18n "pref/mobile/description"]] :&nbsp;&nbsp;</label>\r\n                        <div>\r\n                            [[i18n "pref/mobile/emaillist_desc"]]\r\n                        </div>\r\n                        <br/>\r\n                        <label class="u-form-label f-dis">[[i18n "pref/mobile/emaillist_desc2"]] :&nbsp;&nbsp;</label>\r\n                        <div>\r\n                            [[i18n "pref/mobile/emaillist_desc2_detail_1"]]\r\n                            <br/>\r\n                            [[i18n "pref/mobile/emaillist_desc2_detail_2"]]\r\n                            <br/>\r\n                            [[i18n "pref/mobile/emaillist_desc2_detail_3"]]\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            [[/if]]\r\n        </div>\r\n        {{/raw}}\r\n    </script>\r\n\r\n</section>'}),define("module/setting/advance/smsnotification/index",["require","i18n!setting,pref,pref/mobile","component/contactdg","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","util/i18n","util/email","cui/ui/select/select","module/common/globalService","module/setting/service","./service","text!template/module/setting/advance/smsnotification/index.tpl.html"],function(e){e("i18n!setting,pref,pref/mobile"),e("component/contactdg");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("component/confirmbox"),s=e("util/i18n"),o=e("util/email"),l=e("cui/ui/select/select"),c=e("module/common/globalService"),d=e("module/setting/service"),u=e("./service"),p=n.extend({Implements:a,events:{"click [data-action]":"_dispatchAction",'click [name="interval"]':"_handleCustomInterval",'click [name="WBList"]':"_handleWBList"},templateHelpers:{timeOptionCreater:function(e,n,i,a,r){a||(a=r);for(var s="",o=n;i>=o;o++)s+=t("<option>",{text:o,selected:o==a,value:o})[0].outerHTML;return s},formatResource:function(){var e=arguments[0]||"";if(e.length>0)for(var t=1;t<arguments.length-1;t++)e=e.replace(new RegExp("\\{"+(t-1)+"\\}"),arguments[t]);return s.t(e)},customIntervalCheck:function(e,t,n){return"custom"==n&&-1!=t.indexOf(e)?'checked="checked"':""}},setup:function(){var e=this;e.email=c.getUser().primary_email,e.config={enableCellphoneBinding:c.getConfig("user.enablecellphonebinding"),enableSMSNotifySetting:c.getConfig("user.enablesmsnotifysetting"),enableSMSFilter:c.getConfig("user.enablesmsfilter"),isEnableAddedFromOab:c.getConfig("contact.enableaddedfromoab")&&(c.getConfig("user.supportpab")||c.getConfig("user.supportoab"))},e.common={type:["everyday","MonToFri","MonToSat","Weekend","custom"],everyday:"1,2,3,4,5,6,7",MonToFri:"1,2,3,4,5",MonToSat:"1,2,3,4,5,6",Weekend:"6,7",custom:"custom",customDays:[1,2,3,4,5,6,7]}},render:function(){p.superclass.render.call(this),this._initDataAndView()},refresh:function(){this._initDataAndView()},_initDataAndView:function(){var e=this;t.when(u.getUserSmsAttrs()).then(function(t){if(e.notify=t.notify,e.cellNumber=t.cellNumber,e.sms_filter=t.sms_filter||{},e.sms_filter.interval){for(var n=e.common.type,i=0;i<n.length;i++){var a=e.common[n[i]];if(a===e.sms_filter.interval){e.sms_filter.intervalType=n[i];break}}e.sms_filter.intervalType||(e.sms_filter.intervalType="custom")}else e.sms_filter.interval=e.common.everyday,e.sms_filter.intervalType="everyday";e.sms_filter.enableWhite=e.sms_filter.white?e.sms_filter.white.length>0:!0,e.sms_filter.enableBlack=e.sms_filter.black?e.sms_filter.black.length>0:!1,e._initView()})},_initView:function(){var e=this,n=e.cellNumber;if(n&&0!=n.length){var i=e.compile(e.$("#mmsSettingTpl").html(),e);e.$(".j-smsnotification").html(i),e.$(".mobileRecTimeSet .u-select").each(function(){var e={classPrefix:"u-select",maxHeight:170,trigger:t(this)};new l(e).render()}),e.config.isEnableAddedFromOab&&(e._initContactDialog(e.$(".whiteDiv"),'a[data-action="addFromContact_white"]'),e._initContactDialog(e.$(".blackDiv"),'a[data-action="addFromContact_black"]'),e.on("contactdg:afterSelect",function(n,i,a){var r=[];t.each(n.contact,function(e,t){r.push(t.addr)});var s=e.$("input[name='WBList']:checked").val();"white"==s?e.$("textarea[name='whiteContent']").val(r.join(",")):e.$("textarea[name='blackContent']").val(r.join(","))})),e.element.customRadioCheckbox(),e._handleCustomInterval(),e._handleWBList()}else{var a=e.compile(e.$("#unbindMobileTpl").html(),e);e.$(".j-smsnotification").html(a)}},_initContactDialog:function(e,n){var i=this,a=e;a.contactdg({trigger:n,title:s.t("setting/op_addEmail"),selectTitle:s.t("setting/lbl_addMobileMailFilter"),selectType:[{name:s.t("setting/lbl_emailAddress"),type:"contact"}],onSelect:function(e){var n=!1,a=[];if(t.each(e.contact,function(t,r){r.addr==i.email&&(n=!0,e.contact.splice(t,1)),r.isUser||(a.push(r),e.contact.splice(t,1))}),n||a.length>0){var o=s.t("setting/msg_mobileFilter_addWBlist_Err");r.alert(o,t.noop(),{onConfirm:function(){i.trigger("contactdg:afterSelect",e||[]),this.hide()}})}else i.trigger("contactdg:afterSelect",e||[])},onClose:function(){}}),a.on("click",n,function(){a.contactdg("show","contact",i._getExistWBList())})},_getExistWBList:function(){for(var e=this,t=[],n=e.$("input[name='WBList']:checked").val(),i="white"==n?e.$("textarea[name='whiteContent']").val():e.$("textarea[name='blackContent']").val(),a=o.parse(i),r=0;r<a.length;r++)a[r].address.length>0&&t.push({name:a[r].trueName,addr:a[r].address,isUser:!0});return{contact:t}},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"toBind":e.preventDefault(),i.sendMessage("dispatcher","history:add",{module:"setting.advance.bindmobile",param:{}});break;case"save":var r,o=i.$('input[name="interval"]:checked').val();"custom"===o?(r=[],i.$('input[name="customInterval"]:checked').each(function(){r.push(t(this).val())}),r=r?r.join(","):""):r=i.common[o];var l=i.$("input[name='WBList']:checked").val(),c="",u="",p="white"==l?i.$("textarea[name='whiteContent']").val():i.$("textarea[name='blackContent']").val(),m=i._checkWBList(p);if(!m.isRight)return void t.notify(s.t("setting/msg_smsnotification_wblist_error"));"white"==l?c=m.resultList.join(","):u=m.resultList.join(",");var h={attrs:{notify:1==i.$("input[name='notify']:checked").val(),sms_filter:{datefrom:i.$("select[name='datefrom'] option:selected").val(),dateto:i.$("select[name='dateto'] option:selected").val(),minfrom:i.$("select[name='minfrom'] option:selected").val(),minto:i.$("select[name='minto'] option:selected").val(),interval:r,enable:1,black:u,white:c}}};t.when(d.updateSmsAttrs(h)).done(function(e){i.refresh(),t.notify(s.t("setting/msg_saveSmsNotificationSuccess"))}).fail(function(){t.notify(s.t("setting/msg_saveSmsNotificationFail"))});break;case"cancel":this._initDataAndView()}},_checkWBList:function(e){var t=[],n=[];if(e&&e.length>0){n=o.parse(e);for(var i=0;i<n.length;i++){var a=n[i].address;o.test(a)?t.push(n[i]):0==a.indexOf(".")&&o.isValidDomain(a.substring(1))?t.push(n[i]):o.isValidDomain(a)&&t.push(n[i])}}return{isRight:n.length==t.length,resultList:t}},_handleCustomInterval:function(e,t){var n=this;"custom"===n.$("input[name='interval']:checked").val()?n.$(".customInterval").show():n.$(".customInterval").hide()},_handleWBList:function(e,t){var n=this,i=n.$("input[name='WBList']:checked").val();"white"==i?(n.$("textarea[name='blackContent']").attr("disabled","disabled"),n.$("textarea[name='whiteContent']").removeAttr("disabled"),n.$(".blackDiv a").hide(),n.$(".whiteDiv a").show()):(n.$("textarea[name='whiteContent']").attr("disabled","disabled"),n.$("textarea[name='blackContent']").removeAttr("disabled"),n.$(".blackDiv a").show(),n.$(".whiteDiv a").hide())}});i.module({name:"setting.advance.smsnotification",template:e("text!template/module/setting/advance/smsnotification/index.tpl.html")},p)}),define("components/requirejs-text/text!template/module/setting/calendar/index.tpl.html",[],function(){return'<section class="m-sgaccount j-calendar">\r\n\r\n  <nav class="nav u-tab u-tab-highlight-down">\r\n    <ul class="j-calendar-nav">\r\n      <li data-trigger="calendar.calendar">\r\n        <span class="bar"></span>\r\n        <a href="javascript:void(0)">{{i18n \'setting/tab_calendar\'}}</a>\r\n      </li>\r\n    </ul>\r\n  </nav>\r\n\r\n  <div class="content j-calendar-content"></div>\r\n</section>\r\n\r\n'}),define("module/setting/calendar/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","util/i18n","module/common/globalService","text!template/module/setting/calendar/index.tpl.html"],function(e){function t(e,t){return i("<div>",{"data-panel":e.sid,"class":t+" u-scroll",style:"display:none",html:""})}function n(e,t){if(0==t.indexOf("setting.calendar")){var n=t.substring("setting.".length);e.tabview.find(n)&&(c.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("cui/ui/tabview/tabview"),l=e("util/i18n"),c=e("module/common/globalService"),d=a.extend({Implements:s,activeTabId:"calendar.calendar",setup:function(){var e,t=this;t.state=c.getCurrentState(),e=t.state.module.split("."),t.activeTabId=e[2]?"calendar."+e[2]:t.activeTabId,t.state.module="setting."+t.activeTabId,c.setCurrentState(t.state),t._setHistory(t.state)},render:function(){var e=this;d.superclass.render.call(e),e._initTabView(),e._initModuleEvent()},_initTabView:function(){var e=this,n=[{id:"calendar.calendar",title:l.t("setting.tab_personal"),module:r.module("setting.calendar.calendar")}];e.tabview=new o({element:"section.j-calendar",classPrefix:"j-calendar",activeTabId:e.activeTabId,activeTriggerClass:"z-current",onlyRenderActive:!0,generatePanelMarkup:t,tabs:n}),e.tabview.render(),e.tabview.on("render",function(t){e.activeTabId=t,e._setHistory({module:"setting."+t})}),e.tabview.on("refresh",function(t){e.activeTabId=t,e.sendMessage("dispatcher","view:refresh",{module:"setting."+t,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(t){var i=t.message.newState;n(e,i.module)})},_setHistory:function(e){var t=this,n=i.extend(!0,{},e);0==n.module.indexOf("setting.calendar.")&&(n.param={},t.sendMessage("dispatcher","view:render",n))}});r.module({name:"setting.calendar",template:e("text!template/module/setting/calendar/index.tpl.html")},d)}),define("components/requirejs-text/text!template/module/setting/calendar/calendar/index.tpl.html",[],function(){return'<section class="m-calendar-set">\r\n  <div class="main-wrapper">\r\n    <div class="cal-list">\r\n      <div class="title dotted f-pdt">\r\n        <h4>{{i18n "cal/calendar-display-set"}}</h4>\r\n      </div>\r\n\r\n      <div class="u-form-item first-day">\r\n        <div class="f-fl">\r\n          <label>{{i18n "cal/info_first_week_day"}}&nbsp;:&nbsp;&nbsp;</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <span class="j-first-week-day">{{i18n "cal/value_first_week_day_1"}}</span>\r\n          <span class="link f-csp" data-action="changeStartDay">{{i18n "cal/calendar-display-amend"}}</span>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="title dotted list-dotted">\r\n        <h4>{{i18n "cal/my-lists"}}</h4>\r\n      </div>\r\n\r\n      <div class="u-btn-cal">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="createCalendar">{{i18n "cal/addCalendar"}}</button>\r\n      </div>\r\n\r\n      <div class="m-cal-list-head">\r\n        <table class="u-table u-table-row">\r\n          <thead>\r\n          <tr>\r\n            <td data-action="tableToggle" data-target="ownCal" class="f-usn">\r\n              <i class="iconfont iconcollapse"></i>\r\n              {{i18n "setting/lbl_calendar"}}\r\n            </td>\r\n            <td class="opr">{{i18n "setting/lbl_op"}}</td>\r\n          </tr>\r\n          </thead>\r\n        </table>\r\n      </div>\r\n      <div class="m-cal-list-body j-ownCal">\r\n\r\n      </div>\r\n\r\n      <div class="title dotted list-dotted f-pdt2">\r\n        <h4>{{i18n "cal/my-lists"}}</h4>\r\n      </div>\r\n\r\n      <div class="u-cal-notify">\r\n        <span class="circle"></span>\r\n        <h4>{{i18n "setting/lbl_shareCalendarNotify"}}</h4>\r\n      </div>\r\n\r\n      <div class="m-cal-list-head share">\r\n        <table class="u-table u-table-row">\r\n          <thead>\r\n          <tr>\r\n            <td class="cal-index f-usn" data-action="tableToggle" data-target="receivedCal" >\r\n              <i class="iconfont iconcollapse"></i>\r\n              {{i18n "setting/lbl_receivedCalendar"}}\r\n            </td>\r\n            <td>\r\n              {{i18n "setting/lbl_shareCalendarUid"}}\r\n            </td>\r\n            <td class="opr">{{i18n "setting/lbl_op"}}</td>\r\n          </tr>\r\n          </thead>\r\n        </table>\r\n      </div>\r\n      <div class="m-cal-list-body share j-receivedCal">\r\n        <span class="empty">{{i18n "setting/lbl_shareCalendarEmpty"}}</span>\r\n      </div>\r\n    </div>\r\n\r\n\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask"></div>\r\n    <![endif]-->\r\n\r\n    <!---->\r\n    <div class="panel m-edit-cal u-scroll"></div>\r\n\r\n  </div>\r\n  {{#raw}}\r\n  <!--set first day confirm box content-->\r\n  <script type="text/x-handlebars-template" id="setFirstDaytTpl">\r\n    <form onsubmit="return false;">\r\n      <div>\r\n        <label>[[i18n "cal/info_first_week_day"}}&nbsp;:&nbsp;&nbsp;</label>\r\n      <span class="f-ib f-mgr">\r\n        <input type="radio" name="first_week_day" value="1" [[#compare firstDayOfWeek "==" 1 ]] checked [[/compare]] /> [[i18n "cal/value_first_week_day_1"]]\r\n      </span>\r\n      <span class="f-ib">\r\n        <input type="radio" name="first_week_day" value="2" [[#compare firstDayOfWeek "==" 2 ]] checked [[/compare]] /> [[i18n "cal/value_first_week_day_2"]]\r\n      </span>\r\n      </div>\r\n    </form>\r\n  </script>\r\n\r\n  <!-- own calendar -->\r\n  <script type="text/x-handlebars-templates" id="ownCalTpl">\r\n    <table class="u-table u-table-row">\r\n      <tbody>\r\n      [[#each calendars]]\r\n      <tr>\r\n        <td>[[#compare fid \'==\' 1]] [[i18n "cal/myCalendar"]] [[else]] [[name]] [[/compare]]</td>\r\n        <td class="opr">\r\n          <a class="link f-csp" data-action ="updateCalendar" data-fid="[[fid]]">[[i18n "setting/lbl_calendarEdit"]]</a>\r\n          [[#compare fid \'!=\' 1]]\r\n          <a class="link f-csp f-mgl" data-action ="deleteCalendar" data-fid="[[fid]]" data-name="[[name]]" data-type= "own">[[i18n "setting/op_remove"]]</a>\r\n          [[/compare]]\r\n        </td>\r\n      </tr>\r\n      [[/each]]\r\n      </tbody>\r\n    </table>\r\n  </script>\r\n\r\n  <!--calendars that shared with user-->\r\n  <script type="text/x-handlebars-templates" id="receivedCalTpl">\r\n    <table class="u-table u-table-row">\r\n      <tbody>\r\n      [[#each calendars]]\r\n      <tr [[#if hidden]] class="hide_row" [[/if]]>\r\n        <td class="cal-index">[[name]]</td>\r\n        <td class="cal-owner">[[link_uid]]</td>\r\n        <td class="opr">\r\n          <a href="#" class="link"\r\n             data-action="setCalVisible"\r\n             data-fid="[[fid]]"\r\n             data-visible="[[#if hidden]]true[[else]]false[[/if]]">\r\n             [[#if hidden]] [[i18n "setting/lbl_showCalendar"]] [[else]] [[i18n "setting/lbl_hideCalendar"]] [[/if]]\r\n          </a>\r\n          <a href="#" class="link f-mgl"\r\n             data-action ="deleteCalendar"\r\n             data-fid="[[fid]]"\r\n             data-name="[[name]]"\r\n             data-type="received">\r\n            [[i18n "setting/op_remove"]]\r\n          </a>\r\n        </td>\r\n      </tr>\r\n      [[/each]]\r\n      </tbody>\r\n    </table>\r\n  </script>\r\n\r\n\r\n  <!--edit calendar panel-->\r\n  <script type="text/x-handlebars-template" id="calendarSetTpl">\r\n    <form action="" onsubmit="return false;" name="editCalendar">\r\n      <div class="u-btns-top">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="upsetCalendar" data-fid="[[fid]]">[[i18n "setting/op_confirm"]]</button>\r\n        <button type="reset" class="u-btn u-btn-default"  data-action="cancelEdit">[[i18n "setting/op_cancel"]]</button>\r\n      </div>\r\n      <h4 class="sub-header">[[i18n "setting/lbl_calendarSetAndShare"]]</h4>\r\n\r\n      [[#if fid]]\r\n      <input type="hidden" name="fid" value="[[fid]]"/>\r\n      [[/if]]\r\n      <div class="u-form-item">\r\n        <label class="u-form-label">[[i18n "cal/calendar_name"]]&nbsp;:&nbsp;&nbsp;</label>\r\n        [[#compare fid \'==\' 1]]\r\n          <span>[[name]]</span>\r\n        [[else]]\r\n          <input type="text" name="name:string" class="u-input" value="[[name]]">\r\n        [[/compare]]\r\n      </div>\r\n\r\n      <div class="j-contact">\r\n        [[#each targets]]\r\n        <div class="u-form-item">\r\n          <label class="u-form-label">[[i18n "setting/lbl_shareContact"]]&nbsp;:&nbsp;&nbsp;</label>\r\n          <span class="u-contact">[[uid]]</span>\r\n          <input type="hidden" name="targets[][uid]" value="[[uid]]"/>\r\n          <select name="targets[][accessType]:number">\r\n            <option value="1" [[#compare accessType "==" 1 ]] selected[[/compare]] >[[i18n "setting/lbl_calendarAccess_1"]]</option>\r\n            <option value="2" [[#compare accessType "==" 2 ]] selected[[/compare]] >[[i18n "setting/lbl_calendarAccess_2"]]</option>\r\n          </select>\r\n          <a class="link f-csp" data-action="removeContact" data-uid="[[uid]]">[[i18n "cal/lb_cancelShare"]]</a>\r\n        </div>\r\n        [[/each]]\r\n      </div>\r\n    </form>\r\n\r\n    <div class="u-form-item [[#if fid]] f-dn[[/if]]" id="addNewContact">\r\n      <label class="u-form-label">[[i18n "setting/lbl_calendarShareTfo"]]&nbsp;:&nbsp;&nbsp;</label>\r\n      <input type="text" class="u-input share" name="target[uid]" role="contact">\r\n      <select name="targets[accessType]:number" id="accessType">\r\n        <option value="1">[[i18n "setting/lbl_calendarAccess_1"]]</option>\r\n        <option value="2">[[i18n "setting/lbl_calendarAccess_2"]]</option>\r\n      </select>\r\n    </div>\r\n\r\n    <div class="u-form-item">\r\n      <label class="u-form-label">&nbsp;</label>\r\n      <a data-action="addCalShareUser" class="link f-csp">[[i18n "setting/op_addCalendarShareUser"]]</a>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="newContactTpl">\r\n    <div class="u-form-item">\r\n      <label class="u-form-label">[[i18n "setting/lbl_shareContact"]]&nbsp;:&nbsp;&nbsp;</label>\r\n      <span class="u-contact">[[uid]]</span>\r\n      <input type="hidden" name="targets[][uid]" value="[[uid]]"/>\r\n      <select name="targets[][accessType]:number">\r\n        <option value="1" [[#compare accessType "==" 1 ]] selected[[/compare]] >[[i18n "setting/lbl_calendarAccess_1"]]</option>\r\n        <option value="2" [[#compare accessType "==" 2 ]] selected[[/compare]] >[[i18n "setting/lbl_calendarAccess_2"]]</option>\r\n      </select>\r\n      <a class="link f-csp" data-action="removeContact" data-uid="[[uid]]">[[i18n "cal/lb_cancelShare"]]</a>\r\n    </div>\r\n  </script>\r\n\r\n  {{/raw}}\r\n</section>';
}),define("module/setting/calendar/calendar/index",["require","i18n!setting,cal","../../../../component/contactac","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","../../../../util/index","module/common/globalService","./../../service","text!template/module/setting/calendar/calendar/index.tpl.html"],function(e){e("i18n!setting,cal"),e("../../../../component/contactac");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("component/confirmbox"),s=e("../../../../util/index"),o=e("module/common/globalService"),l=e("./../../service"),c=s.i18n,d=n.extend({Implements:a,events:{"click [data-action]":"_dispatchAction"},attrs:{ownCal:[],receivedCal:[],editStatus:{isEditMode:!1,editCalFid:null},firstDayOfWeek:o.getConfig("mail.getfirstdayofweek"),calShareUsers:[]},render:function(){d.superclass.render.call(this),this._fetchData(),this._initModuleEvents()},destroy:function(){d.superclass.destroy.call(this)},_initModuleEvents:function(){var e=this;this.onMessage("view:refresh",function(){e._fetchData()},null)},_fetchData:function(){var e=this;t.when(l.listAllCalFolder(),l.listAccessedCalFolder()).then(function(n,i){e.set("ownCal",n),e.set("receivedCal",i,{override:!0}),t.isPlainObject(n[0])&&-1!=n[0].first_week_day&&e.set("firstDayOfWeek",n[0].first_week_day),e.element.mask("hide")})},_dispatchAction:function(e,n){var i=t(n).data();switch(i.action){case"tableToggle":this._handleTableToggle(n,i);break;case"changeStartDay":this._handleChangeStartDay(i);break;case"deleteCalendar":this._handleDeleteCalendar(i);break;case"removeContact":this._handleRemoveContact(i,t(n));break;case"upsetCalendar":this._handleUpSetCalendar(i);break;case"setCalVisible":this._handleSetCalVisible(i);break;case"addCalShareUser":this.$("#addNewContact").removeClass("f-dn");break;case"updateCalendar":this.set("editStatus",{isEditMode:!0,editCalFid:i.fid});break;case"createCalendar":this.set("editStatus",{isEditMode:!0,editCalFid:null});break;case"cancelEdit":this.set("editStatus",{isEditMode:!1,editCalFid:null})}},_handleTableToggle:function(e,n){this.$(".j-"+n.target).toggle(),t(e).find("i").toggleClass("iconunfold iconcollapse")},_handleInitContactAC:function(){var e=this;this.$("input[role=contact]").contactac({select:function(n){function i(t){t=t||!1,e.$("input[role=contact]").val("").parent().toggleClass("f-dn",t)}var a=n.original.emailaddr,l=e.get("calShareUsers"),d=e.$("#accessType").val(),u=o.getUser().email,p=e.$("#newContactTpl").html();return s.Email.test(a)?u==a?(i(),void r.alert(c.t("setting/msg_CalShareToOwnErr"))):-1!==t.inArray(a,l)?(i(),r.alert(s.messageFormat.format(c.t("setting/msg_errMailExistInCurrentList"),s.html.encode(a)))):(l.push(a),e.set("calShareUsers",l),e.$(".j-contact").append(e.compile(p,{uid:a,accessType:d})),void i(!0)):(i(),r.alert(c.t("setting/msg_errorEmailFormat")))},width:256,zIndex:1e3})},_handleChangeStartDay:function(){var e=this,n=this.get("firstDayOfWeek"),i=this.compile(this.$("#setFirstDaytTpl").html(),{firstDayOfWeek:n});r.confirm(i,function(){var i=t("input[name=first_week_day]:checked").val();n!=i&&o.updateUser({first_week_day:i}).then(function(){e.set("firstDayOfWeek",i)})})},_handleDeleteCalendar:function(e){var n=this,i=c.t("cal/msg_confirm_delete_calendar").replace("{0}",s.html.encode(e.name));r.confirm(i,function(){"own"===e.type?l.deleteCalendar({fid:e.fid}).then(function(){n.set("ownCal",t.grep(n.get("ownCal"),function(t){return t.fid!=e.fid})),t.notify(c.t("cal/info_delete_success")),n.publish("calUpdate",{fid:e.fid,updateType:"DELETE"})}):l.deleteAccessedCalFolder({fid:e.fid}).then(function(){n.set("receivedCal",t.grep(n.get("receivedCal"),function(t){return t.fid!=e.fid})),t.notify(c.t("cal/info_delete_success")),n.publish("calUpdate",{fid:e.fid,updateType:"DELETE"})})})},_handleRemoveContact:function(e,n){var i=t.grep(this.get("calShareUsers"),function(t){return t!==e.uid});this.set("calShareUsers",i),n.parent().remove()},_handleUpSetCalendar:function(e){var n=this,i=""!==e.fid,a=this.get("ownCal"),r=this.$("form[name='editCalendar']").serializeJSON({parseNumbers:!0});return!t.isArray(r.targets)&&(r.targets=[]),i||this._checkCalendar(r)?void l.upsetCalendar(i,r).then(function(s){n.set("ownCal",null,{silent:!0}),i?(t.each(a,function(t,n){return n.fid==e.fid?(a[t]=r,!1):void 0}),n.set("ownCal",a),t.notify(c.t("cal/info_update_success"))):(a.push(t.extend(r,{fid:s.fid,first_week_day:n.get("firstDayOfWeek")})),n.set("ownCal",a),t.notify(c.t("cal/info_create_success"))),n.set("calShareUsers",[]),n.set("editStatus",{isEditMode:!1,editCalFid:null}),n.publish("calUpdate",{fid:i?r.fid:s.fid,updateType:i?"UPDATE":"CREATE"})}):!1},_handleSetCalVisible:function(e){var n=this,i=this.get("receivedCal");this.set("receivedCal",null,{silent:!0}),l.setAccessedCalFolderVisible({fid:e.fid,visible:e.visible}).then(function(){t.each(i,function(t,n){return n.fid==e.fid?(i[t].hidden=!e.visible,!1):void 0}),n.set("receivedCal",i)})},_checkCalendar:function(e){e.name=t.trim(e.name);var n="%'\"\\/:*?<>|=,^",i=50,a=e.name,s=this.get("ownCal");if("valid"!==l.isValidString(a,i,n))return r.alert(c.t("setting/msg_invailCalName").replace("{0}",50).replace("{1}",n)),!1;if(!s&&a!==c.t("cal/myCalendar"))return!0;for(var o=0;o<s.length;o++)if(a==s[o].name.trim()||a==c.t("cal/myCalendar"))return r.alert(c.t("setting/msg_CalNameExist")),!1;return!0},_onChangeFirstDayOfWeek:function(e){this.$(".j-first-week-day").html(c.t("cal/value_first_week_day_"+e)),t.notify.success(c.t("cal/info_update_success")),this.publish("calUpdate",{updateType:"UPDATE_ALL"})},_onChangeOwnCal:function(e){var t=this.compile(this.$("#ownCalTpl").html(),{calendars:e});this.$(".j-ownCal").html(t)},_onChangeReceivedCal:function(e){e=e.sort(function(e){return e.hidden});var t=this.compile(this.$("#receivedCalTpl").html(),{calendars:e});this.$(".j-receivedCal").html(t)},_onChangeEditStatus:function(e){var n,i,a=this.$("#calendarSetTpl").html();e.isEditMode?(null===e.editCalFid?n=this.compile(a):(i=t.grep(this.get("ownCal"),function(t){return t.fid==e.editCalFid})[0],1==e.editCalFid&&(i.name=c.t("cal/myCalendar")),this.set("calShareUsers",t.map(i.targets,function(e){return e.uid})),n=this.compile(a,i)),this.$(".m-edit-cal").html(n),this.$(".main-wrapper").addClass("toggled"),this._handleInitContactAC()):this.$(".main-wrapper").removeClass("toggled")}});i.module({name:"setting.calendar.calendar",template:e("text!template/module/setting/calendar/calendar/index.tpl.html")},d)}),define("components/requirejs-text/text!template/module/setting/client/index.tpl.html",[],function(){return'<section class="m-sgclient">\r\n  <div class="m-st-client-main"></div>\r\n  {{#raw}}\r\n  <script type="x-handlebars-template" id="tabTpl" data-container=".m-st-client-main">\r\n    <nav class="nav u-tab u-tab-highlight-down">\r\n      <ul class="j-client-nav">\r\n        [[#each this]]\r\n          <li data-trigger=[[ this.id ]]>\r\n            <span class="bar"></span>\r\n            <a href="javascript:void(0)">[[ this.title ]]</a>\r\n          </li>\r\n        [[/each]]\r\n      </ul>\r\n    </nav>\r\n    <div class="j-client-content content"></div>\r\n  </script>\r\n  <script type="x-handlebars-template" id="forbiddenTpl" data-container=".m-st-client-main">\r\n    [[ i18n "pref/fa_forbidden" ]]\r\n  </script>\r\n  {{/raw}}\r\n</section>'}),define("module/setting/client/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","util/i18n","module/common/globalService","text!template/module/setting/client/index.tpl.html"],function(e){function t(e,t){if(0==t.indexOf("setting.client")){var n=t.substring("setting.".length);e.tabview.find(n)&&(l.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var n=e("jquery"),i=e("cui/core/view/view"),a=e("cui/core/view/viewmanager"),r=e("cui/util/templatable/templatable"),s=e("cui/ui/tabview/tabview"),o=e("util/i18n"),l=e("module/common/globalService"),c=i.extend({Implements:r,widgets:{tabview:null},activeTabId:"client.pop",setup:function(){var e,t=this;t.config={isSupportSync:l.getConfig("user.supportactivesync")},t.state=l.getCurrentState(),e=t.state.module.split("."),t.activeTabId=e[2]?"client."+e[2]:t.activeTabId,t.state.module="setting."+t.activeTabId,l.setCurrentState(t.state),t._setHistory(t.state)},render:function(){var e=this;c.superclass.render.call(e),e._initModuleEvent(),e._initTabView(),n.notify.loading("hide")},destroy:function(){var e=this;e.widgets.tabview&&e.widgets.tabview.destroy(),c.superclass.destroy.call(e)},_initTabView:function(){var e=this;e.tabs=[{id:"client.pop",module:a.module("setting.client.pop"),title:o.t("setting/tab_pop3setting")}],e.config.isSupportSync&&e.tabs.push({id:"client.mailpush",module:a.module("setting.client.mailpush"),title:o.t("pref/eas_device")});var t=e.$("#tabTpl"),n=e.compile(t.html(),e.tabs),i=e.$(t.attr("data-container"));i.html(n),e.widgets.tabview=new s({element:"section.m-sgclient",classPrefix:"j-client",onlyRenderActive:!0,activeTriggerClass:"z-current",activeTabId:e.activeTabId,tabs:e.tabs}),e.widgets.tabview.render(),e.widgets.tabview.on("render",function(t){e.activeTabId=t,e._setHistory({module:"setting."+t,param:{}})}),e.widgets.tabview.on("refresh",function(t){e.activeTabId=t,e.sendMessage("dispatcher","view:refresh",{module:"setting."+t,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(n){var i=n.message.newState;t(e,i.module)})},_setHistory:function(e){var t=this,i=n.extend(!0,{},e);0==i.module.indexOf("setting.client.")&&(i.param={},t.sendMessage("dispatcher","view:render",i))}});a.module({name:"setting.client",template:e("text!template/module/setting/client/index.tpl.html")},c)}),define("components/requirejs-text/text!template/module/setting/client/mailpush/index.tpl.html",[],function(){return'<div class="m-st-client-mailpush-wrap grid-row">\r\n  <div class="main-wrapper grid-col12">\r\n    <div class="content-wrapper">\r\n      <section class="m-st-client-mailpush-statement">\r\n\r\n      </section>\r\n      <section class="m-st-client-mailpush-list u-scroll">\r\n\r\n      </section>\r\n    </div>\r\n\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask" />\r\n    <![endif]-->\r\n\r\n    <!--   -->\r\n    <div class="m-st-client-mailpush-panel panel u-scroll" id="synActionTplContainer"></div>\r\n    {{#raw}}\r\n    <script type="text/x-handlebars-template" id="clientMailPushStatementTpl" data-container=".m-st-client-mailpush-statement">\r\n      <p>\r\n        [[#compare pushDevicesLength ">" 0]]\r\n        [[[ i18n "setting/msg_easDeviceSummary" current=pushDevicesLength max=deviceCountLimit ]]]\r\n        [[else]]\r\n        [[[ i18n "setting/msg_easDeviceSummaryEmpty" max=deviceCountLimit ]]]\r\n        [[/compare]]\r\n      </p>\r\n      <p>\r\n        [[[ i18n "pref/mobile/eas_hint_1" ]]]\r\n      </p>\r\n    </script>\r\n\r\n    <script type="text/x-handlebars-template" id="clientMailPushListTpl" data-container=".m-st-client-mailpush-list">\r\n      <ul class="u-list">\r\n        [[#each pushDevices]]\r\n        <li>\r\n          <div class="u-box" data-active="true">\r\n            <div class="u-box-head">\r\n              <h3>\r\n                <!-- Nokia NFE DeviceType  IMIE  deviceInformation  -->\r\n                [[! templateHelper function ]]\r\n                [[ showDeviceType this ]]\r\n              </h3>\r\n              [[#if this.WIPE ]]\r\n                <!--  WIPE  -->\r\n                [[#compare this.WIPE "==" "OK"]]\r\n                  <p>[[ i18n "pref/mobile/eas.syncState.WIPE_OK" ]]</p>\r\n                [[/compare]]\r\n\r\n                <!-- WIPE PENDING  -->\r\n                [[#compare this.WIPE "==" "PENDING"]]\r\n                <p>\r\n                  <span class="highlight_error">[[ i18n "pref/mobile/eas.syncState.WIPE_PENDING" ]]</span>\r\n\r\n                  [[#if this.wipeIssueTime]]\r\n                    <span>[[ i18n "setting/msg_easWipeDeviceIssueTime" ]][[ GetDateYMDHm this.wipeIssueTime ]]</span>\r\n                  [[/if]]\r\n\r\n                  <a href="javascript:void(0);" data-operation="action" data-action="doHandleWipeDevice" data-actionType="cancelWipe" data-deviceID="[[this.id]]">\r\n                    [[ i18n "pref/mobile/eas.action.cancel_wipe" ]]\r\n                  </a>\r\n                </p>\r\n                [[/compare]]\r\n\r\n              [[else]]\r\n                <!--  -->\r\n                <p>[[ i18n "pref/mobile/eas.syncState.OK" ]]</p>\r\n              [[/if]]\r\n              <p>[[ i18n "pref/mobile/eas.deviceId" ]]: [[this.id]]</p>\r\n            </div>\r\n            <!-- id attr is required for collapse -->\r\n            <div class="u-box-container collapse" id="deviceID_[[ this.id ]]_detail">\r\n              [[#compare this.WIPE "==" "OK"]]\r\n                <p>[[ i18n "pref/mobile/eas.syncState.WipeNote" ]]</p>\r\n              [[else]]\r\n                [[#if this.lastSyncTime]]\r\n                  <p>[[ i18n "pref/mobile/eas.lastSyncTime"]][[ GetDateYMDHm this.lastSyncTime ]]</p>\r\n                [[/if]]\r\n                [[#if this.firstSyncTime]]\r\n                  <p>[[ i18n "pref/mobile/eas.firstSyncTime"]][[ GetDateYMDHm this.firstSyncTime]]</p>\r\n                [[/if]]\r\n                [[#if this.userAgent]]\r\n                <p>[[ i18n "pref/mobile/eas.userAgent"]][[this.userAgent]]</p>\r\n                [[/if]]\r\n\r\n                [[! templateHelper function ]]\r\n                [[ showIMEIDeviceInfo this ]]\r\n\r\n              [[/compare]]\r\n            </div>\r\n            <div class="mailpush-action">\r\n              <a href="javascript:void(0);"\r\n                 data-operation="action"\r\n                 data-action="doHandleRecoveryPass"\r\n                 data-actionType="init"\r\n                 data-deviceID=[[ this.id ]]>[[ i18n "pref/mobile/eas.action.recoveryPassword" ]]</a>\r\n              <a href="javascript:void(0);"\r\n                 data-operation="action"\r\n                 data-action="doHandleRemoveDevice"\r\n                 data-actionType="init"\r\n                 data-deviceID=[[ this.id ]]>[[ i18n "pref/mobile/eas.action.remove" ]]</a>\r\n\r\n              [[#unless this.WIPE ]]\r\n                [[#if ../../enableRemoteWipe ]]\r\n                  <a href="javascript:void(0);"\r\n                     data-operation="action"\r\n                     data-action="doHandleWipeDevice"\r\n                     data-actionType="init"\r\n                     data-deviceID=[[ this.id ]]>[[ i18n "pref/mobile/eas.action.wipe" ]]</a>\r\n                [[/if]]\r\n              [[/unless]]\r\n\r\n\r\n            </div>\r\n            <!-- id and href attrs is required for collapse -->\r\n            <a data-toggle="collapse"\r\n               href="#deviceID_[[ this.id ]]_detail" aria-controls="deviceID_[[ this.id ]]_detail">\r\n              <i class="collapse-toggle icondown"></i>\r\n            </a>\r\n          </div>\r\n        </li>\r\n        [[/each]]\r\n      </ul>\r\n    </script>\r\n\r\n    <script type="text/x-handlebars-template" id="checkPassTpl">\r\n      <form action="#" method="post" name="checkPasswordForm">\r\n        <div class="u-btns-top">\r\n          <button type="reset" data-operation="action" data-action="[[actionData.action]]" data-actionType="cancelSubmit" class="u-btn u-btn-default">[[actionData.cancel]]</button>\r\n        </div>\r\n        <h4 class="sub-header">[[i18nData.subHeader]]</h4>\r\n        <label class="label">[[[i18nData.label]]]</label>\r\n        <div class="u-form-item">\r\n          <div class="u-input-control">\r\n            <input type="password" name="password" class="u-input" />\r\n            <span class="iconfont iconlock"></span>\r\n            <button type="submit" data-operation="action" data-action="[[actionData.action]]" data-actionType="[[actionData.nextActionType]]" class="u-btn u-btn-primary">{{i18n "setting/op_confirm"}}</button>\r\n            <input type="hidden" name="deviceId" value="[[actionData.deviceId]]" />\r\n          </div>\r\n          <p class="u-form-explain f-dn"></p>\r\n        </div>\r\n      </form>\r\n    </script>\r\n\r\n    <script type="text/x-handlebars-template" id="infoPanelTpl">\r\n      <div class="u-btns-top">\r\n        <button type="reset"  data-operation="action" data-action="[[actionData.action]]" data-actionType="cancelResult" class="u-btn u-btn-default">{{i18n "setting/op_cancel"}}</button>\r\n      </div>\r\n      <h4 class="sub-header">[[infoData.title]]</h4>\r\n      <p>[[[infoData.content]]]</p>\r\n\r\n    </script>\r\n    {{/raw}}\r\n  </div>\r\n</div>'}),define("module/setting/client/mailpush/index",["require","i18n!setting,pref,main,pref/mobile","jquery","moment","i18n","handlebars","cui/util/history/hash","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","../../../../component/confirmbox","module/common/globalService","./../../service","text!template/module/setting/client/mailpush/index.tpl.html"],function(e){e("i18n!setting,pref,main,pref/mobile");var t=e("jquery"),n=e("moment"),i=e("i18n"),a=e("handlebars"),r=(e("cui/util/history/hash"),e("cui/core/view/view")),s=e("cui/core/view/viewmanager"),o=e("cui/util/templatable/templatable"),l=e("../../../../component/confirmbox"),c=e("module/common/globalService"),d=e("./../../service"),u=r.extend({Implements:o,pushDevices:[],$syncActionContainer:null,isSupportSync:null,events:{'click [data-toggle="collapse"]':"_handleCollapse",'click [data-operation="action"]':"_handleOperation"},setup:function(){},render:function(){var e=this;u.superclass.render.call(this),t.notify.loading(),e.$syncActionContainer=e.$("#synActionTplContainer"),e.isSupportSync=c.getConfig("user.supportactivesync"),e.isSupportSync&&this._initDevices.call(this,function(){e._initView()}),t.notify.loading("hide")},destroy:function(){u.superclass.destroy.call(this)},_initDevices:function(e){var n=this;t.when(d.getActiveSyncDevice()).then(function(a){return"S_OK"!=a.code?(t.notify.error(i.t("setting/msg_easDeviceFetchFail")),!1):(n.pushDevices=a.data,void e(n.pushDevices))},function(e){return t.notify.error(i.t("setting/msg_easDeviceFetchFail")),!1})},_initView:function(){var e=this,t={pushDevicesLength:e.pushDevices.length,deviceCountLimit:c.getConfig("user.activeSyncDeviceCountLimit")},n={pushDevices:e.pushDevices,enableRemoteWipe:c.getConfig("user.enableremotewipe")};e._initSubTpl("#clientMailPushStatementTpl",t),e._initSubTpl("#clientMailPushListTpl",n)},_initSubTpl:function(e,t){var n,i,a,r=this;n=r.$(e),i=r.compile(n.html(),t),a=r.$(n.attr("data-container")),a.html(i)},_handleCollapse:function(e,n){e.preventDefault();var i,a=t(n),r=a.find("i.collapse-toggle"),s=this.$(a.attr("data-target")||(i=a.attr("href"))&&i.replace(/.*(?=#[^\s]+$)/,""));s.hasClass("collapsing")||(s.hasClass("in")?(s.addClass("collapsing"),s.hide(350,function(){s.removeClass("in").removeClass("collapsing"),r.removeClass("iconup").addClass("icondown")})):(s.addClass("in").addClass("collapsing"),s.show(350,function(){r.removeClass("icondown").addClass("iconup"),s.removeClass("collapsing")})))},_handleOperation:function(e,n){e.preventDefault();var i=this,a=t(n),r=a.attr("data-action"),s=a.attr("data-actionType");return!s&&(s="init"),!!i[r]&&!!i[r][s]&&i[r][s].call(i,a),!1},doHandleRecoveryPass:{action:"doHandleRecoveryPass",retryMeta:{max:5,current:0,lastTryDate:null,tryInterval:6e4},init:function(e){var a,r,s,o,l=this,c=l.doHandleRecoveryPass.retryMeta;return e&&(a=e.attr("data-deviceID"))?(l.doHandleCommon.checkRetryMeta.call(l,c)?(r={action:this.doHandleRecoveryPass.action},s={title:i.t("pref/mobile/eas.action.recoveryPassword"),content:i.t("setting/msg_easWrongPassForbidden",{seconds:Math.floor((c.tryInterval-n().diff(c.lastTryDate))/1e3)})},l.doHandleCommon.initInfoPanel.call(l,{infoData:s,actionData:r})):(r={action:this.doHandleRecoveryPass.action,nextActionType:"submit",deviceId:a,cancel:i.t("setting/op_cancel")},o={subHeader:i.t("pref/mobile/eas.action.recoveryPassword"),label:i.t("pref/mobile/eas.recoveryPassword.checking")},l.doHandleCommon.initCheckPass.call(l,{i18nData:o,actionData:r})),void this.showPanel()):(t.notify.error(i.t("setting/msg_easDeviceMissId")),!1)},submit:function(e){var a,r=this,s={action:this.doHandleRecoveryPass.action},o={title:"",content:""},l=this.$syncActionContainer.find("form[name=checkPasswordForm]").serializeJSON(),c=r.doHandleRecoveryPass.retryMeta,u=n();this.doHandleCommon.submitCheckPass.call(this,e,l)&&(a={password:l.password,deviceId:l.deviceId},t.when(d.getRecoveryPass(a)).then(function(e){var t;t=e["var"]&&e["var"].password?e["var"].password:i.t("pref/mobile/eas.recoveryPassword.emptyResult"),o.title=i.t("pref/mobile/eas.action.recoveryPassword"),o.content=t,r.doHandleCommon.resetRetryMeta(c),r.doHandleCommon.initInfoPanel.call(r,{infoData:o,actionData:s})},function(t){r.doHandleCommon.dirtyCheckPass(e,i.t("setting/msg_easWrongPass")),c.current++,c.lastTryDate=u,c.current>=c.max&&(o={title:i.t("pref/mobile/eas.action.recoveryPassword"),content:i.t("setting/msg_easWrongPass")+i.t("setting/msg_easWrongPassForbidden",{seconds:c.tryInterval/1e3})},r.doHandleCommon.initInfoPanel.call(r,{infoData:o,actionData:s}))}))},cancelSubmit:function(){this.hidePanel(),this.$syncActionContainer.html("")},cancelResult:function(){this.hidePanel(),this.$syncActionContainer.html("")}},doHandleRemoveDevice:{action:"doHandleRemoveDevice",init:function(e){var n,a=this;return e&&(n=e.attr("data-deviceID"))?void l.confirm(i.t("pref/mobile/eas.tips_remove_device"),function(){a.doHandleRemoveDevice.confirm.call(a,n)},function(){a.doHandleRemoveDevice.cancelConfirm.call(a)}):(t.notify.error(i.t("setting/msg_easDeviceMissId")),!1)},confirm:function(e){var n=this,a={deviceId:e};t.when(d.removeActiveSyncDevice(a)).then(function(e){"S_OK"===e.code&&(t.notify.success(i.t("setting/msg_easDeviceRemoveSuccess")),n.render.call(n))},function(e){t.notify.error(i.t("setting/msg_easDeviceRemoveFailed"))})},cancelConfirm:function(){}},doHandleWipeDevice:{action:"doHandleWipeDevice",retryMeta:{max:5,current:0,lastTryDate:null,tryInterval:6e4},init:function(e){var a,r,s,o,l=this,c=l.doHandleWipeDevice.retryMeta;return e&&(a=e.attr("data-deviceID"))?(l.doHandleCommon.checkRetryMeta.call(l,c)?(r={action:this.doHandleWipeDevice.action},s={title:i.t("pref/mobile/eas.wipe_device.title"),content:i.t("setting/msg_easWrongPassForbidden",{seconds:Math.floor((c.tryInterval-n().diff(c.lastTryDate))/1e3)})},l.doHandleCommon.initInfoPanel.call(l,{infoData:s,actionData:r})):(r={action:this.doHandleWipeDevice.action,nextActionType:"submit",deviceId:a,cancel:i.t("setting/op_cancel")},o={subHeader:i.t("pref/mobile/eas.wipe_device.title"),label:i.t("setting/msg_easWipe_deviceTips")},l.doHandleCommon.initCheckPass.call(l,{i18nData:o,actionData:r})),void this.showPanel()):(t.notify.error(i.t("setting/msg_easDeviceMissId")),!1)},submit:function(e){var a,r=this,s=this.$syncActionContainer.find("form[name=checkPasswordForm]").serializeJSON(),o=r.doHandleWipeDevice.retryMeta,l=n();this.doHandleCommon.submitCheckPass.call(this,e,s)&&(a={password:s.password,deviceId:s.deviceId},t.when(d.remoteWipeDevice(a)).then(function(e){"S_OK"===e.code&&(t.notify.success(i.t("setting/msg_easWipeDeviceSuccess")),r.doHandleWipeDevice.cancelResult.call(r),r.doHandleCommon.resetRetryMeta(o),r.render.call(r))},function(){if(r.doHandleCommon.dirtyCheckPass(e,i.t("setting/msg_easWrongPass")),o.current++,o.lastTryDate=l,o.current>=o.max){var t={action:r.doHandleWipeDevice.action},n={title:i.t("pref/mobile/eas.action.recoveryPassword"),content:i.t("setting/msg_easWrongPass")+i.t("setting/msg_easWrongPassForbidden",{seconds:o.tryInterval/1e3})};r.doHandleCommon.initInfoPanel.call(r,{infoData:n,actionData:t})}}))},cancelSubmit:function(){this.hidePanel(),this.$syncActionContainer.html("")},cancelResult:function(){this.hidePanel(),this.$syncActionContainer.html("")},cancelWipe:function(e){var n,a=this;if(!e||!(n=e.attr("data-deviceID")))return t.notify.error(i.t("setting/msg_easDeviceMissId")),!1;var r={deviceId:n};t.when(d.cancelRemoteWipeDevice(r)).then(function(e){"S_OK"===e.code&&(t.notify.success(i.t("setting/msg_easWipeDeviceCancelSuccess")),a.render.call(a))},function(){t.notify.error(i.t("setting/msg_easWipeDeviceCancelFailed"))})}},doHandleCommon:{initCheckPass:function(e){var t,n;t=this.$("#checkPassTpl"),n=this.compile(t.html(),e),this.$syncActionContainer.html(n)},submitCheckPass:function(e,t){return t.deviceId?t.password?(this.doHandleCommon.cleanCheckPass(e),!0):(this.doHandleCommon.dirtyCheckPass(e,i.t("setting/msg_easMissPass")),!1):(this.doHandleCommon.dirtyCheckPass(e,i.t("setting/msg_easDeviceMissId")),!1)},dirtyCheckPass:function(e,t){var n=e.parent().find("input[type=password]"),i=e.parent().parent(),a=i.find(".u-form-explain").eq(0);n.val(""),i.addClass("error"),a.html(t).removeClass("f-dn")},cleanCheckPass:function(e,t){var n=e.parent().parent(),i=n.find(".u-form-explain").eq(0);n.removeClass("error"),t?i.html(t):i.html("").addClass("f-dn")},initInfoPanel:function(e){var t,n;t=this.$("#infoPanelTpl"),n=this.compile(t.html(),e),this.$syncActionContainer.html(n)},checkRetryMeta:function(e){var t,i=this,a=n(),r=!1,s=!1;return e.current<e.max?r=!1:e.lastTryDate?(t=a.diff(e.lastTryDate),t<e.tryInterval?r=!0:(s=!0)&&(r=!1)):(r=!1,s=!0),s&&(i.doHandleCommon.resetRetryMeta(e),r=!1),r},resetRetryMeta:function(e){e.current=0,e.lastTryDate=null}},templateHelpers:{showIMEIDeviceInfo:function(e){var t,n,r=["FriendlyName","Model","OS","IMEI"],s="",o=0;if(t=e.deviceInformation){for(o;o<r.length;o++)n=r[o],!!t[n]&&(s+="<p>"+i.t("pref/mobile/eas.deviceInformation."+n)+""+t[n]+"</p>");return new a.SafeString(s)}},showDeviceType:function(e){var t;return t=e.deviceInformation&&e.deviceInformation.Model?e.deviceInformation.Model:e.deviceType?e.deviceType:i.t("pref/mobile/eas.unknownDevice"),new a.SafeString(t)},GetDateYMDHm:function(e){return e?new a.SafeString(n(e).format("YYYY-MM-DD HH:mm")):void 0}},showPanel:function(){this.$(".main-wrapper").addClass("toggled")},hidePanel:function(){this.$(".main-wrapper").removeClass("toggled")}});s.module({name:"setting.client.mailpush",template:e("text!template/module/setting/client/mailpush/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/client/pop/index.tpl.html",[],function(){return'<div class="m-st-client-pop3-wrap">\r\n  <!-- subView is use to toggle -->\r\n  <div class="m-st-client-pop3-edit f-dn" data-toggle="subview"></div>\r\n  <div class="m-st-client-pop3-view" data-toggle="subview"></div>\r\n\r\n\r\n  <!-- region pop3 Edit Tpl -->\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="clientPop3EditTpl" data-container=".m-st-client-pop3-edit">\r\n    <form method="post" name="pop3" id="clientPop3Edit" class="">\r\n      <div class="u-btns-top">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="save">[[i18n "setting/op_save"]]</button>\r\n        <button type="reset"  class="u-btn u-btn-default" data-action="cancel">[[i18n "setting/op_cancel"]]</button>\r\n      </div>\r\n      <div class="title dotted">\r\n        <h4>[[ i18n "setting/lbl_pop3setting" ]]</h4>\r\n      </div>\r\n      <div class="u-form-item m-st-client-pl-20">\r\n        <div class="input u-checkbox">\r\n          <input type="checkbox" class="u-input" name="chargeOther" id="chargeOther"\r\n                 [[#compare otherPop3 \'!=\' 0]]checked [[/compare]] [[#compare otherPop3Blank \'!=\' 0]] disabled="disabled" [[/compare]]>\r\n          <label for="chargeOther">[[i18n "setting/lbl_folderOtherReception"]]</label>\r\n        </div>\r\n      </div>\r\n      <div class="u-form-item m-st-client-pl-20">\r\n        <div class="input u-checkbox">\r\n          <input type="checkbox" class="u-input" name="chargeJunk" id="chargeGarbage"\r\n                 [[#compare junkPop3 \'!=\' 0]]checked [[/compare]]>\r\n          <label for="chargeGarbage">[[i18n "setting/lbl_folderJunkReception"]]</label>\r\n        </div>\r\n      </div>\r\n    </form>\r\n  </script>\r\n  {{/raw}}\r\n  <!-- endregion -->\r\n\r\n  <!-- region pop3 View Tpl -->\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="clientPop3ViewTpl" data-container=".m-st-client-pop3-view">\r\n    <div class="u-btns-top">\r\n      <button type="button" class="u-btn u-btn-primary" data-action="edit">{{i18n \'setting/op_edit\'}}</button>\r\n    </div>\r\n    <div class="title dotted">\r\n      <h4>[[ i18n "setting/lbl_pop3setting" ]]</h4>\r\n    </div>\r\n    <div class="list-item">\r\n      <i class="iconfont [[#compare otherPop3 \'!=\' 0]]iconchoose[[else]]iconerror[[/compare]]"></i>\r\n      [[i18n "setting/lbl_folderOtherReception"]]\r\n    </div>\r\n    <div class="list-item">\r\n      <i class="iconfont [[#compare junkPop3 \'!=\' 0]]iconchoose[[else]]iconerror[[/compare]]"></i>\r\n      [[i18n "setting/lbl_folderJunkReception"]]\r\n    </div>\r\n  </script>\r\n  {{/raw}}\r\n  <!-- endregion -->\r\n\r\n</div>\r\n\r\n\r\n\r\n\r\n'}),define("module/setting/client/pop/index",["require","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","util/i18n","module/common/globalService","./../../../mail/service","./../../service","text!template/module/setting/client/pop/index.tpl.html"],function(e){var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("util/i18n"),s=(e("module/common/globalService"),e("./../../../mail/service")),o=e("./../../service"),l=n.extend({Implements:a,pop3Setting:{otherPop3:!1,otherPop3Blank:!1,junkPop3:!1},otherFolders:[],junkFolder:null,events:{"click [data-action]":"_dispatchAction"},setup:function(){},destroy:function(){l.superclass.destroy.call(this)},render:function(){var e=this;l.superclass.render.call(this),t.when(s.getFolders(!0)).then(function(t){for(var n=0,i=t.length;i>n;n++){var a=t[n];a.id<0||(a.flags.system===!0?5===a.id&&(e.junkFolder=a):a.isPOP||e.otherFolders.push(a))}e._initPop3Setting.call(e),e._initView.call(e,!0)})},_initPop3Setting:function(){var e=this,n=!0;e.otherFolders.length?(e.pop3Setting.otherPop3Blank=!1,t.each(e.otherFolders,function(e,t){return t.flags.pop3?void 0:n=!1}),e.pop3Setting.otherPop3=n):(e.pop3Setting.otherPop3Blank=!0,e.pop3Setting.otherPop3=!1),e.pop3Setting.junkPop3=!!e.junkFolder.flags.pop3},_initView:function(e){var t=this;e&&t._initPop3ViewTpl.call(t)},_initSubTpl:function(e){var t,n,i,a=this;return e?(t=a.$(e),n=a.compile(t.html(),a.pop3Setting),i=a.$(t.attr("data-container")),void i.html(n).customRadioCheckbox()):a._initPop3EditTpl.call(a)},_initPop3ViewTpl:function(){this._initSubTpl.call(this,"#clientPop3ViewTpl")},_initPop3EditTpl:function(){this._initSubTpl.call(this,"#clientPop3EditTpl")},_toggleView:function(){var e=this;e.$('[data-toggle="subview"]').toggleClass("f-dn")},_dispatchAction:function(e,n){e.preventDefault();var i=this,a=t(n).attr("data-action");switch(a){case"edit":i._initPop3EditTpl.call(i),i._toggleView();break;case"save":i._handleSubmit.call(i,e,n);break;case"cancel":i._initPop3ViewTpl.call(i),i._toggleView()}},_handleSubmit:function(e,n){var i=this,a=i.$('form[name="pop3"]').serializeJSON(),s=[];i.pop3Setting.otherPop3=!!a.chargeOther,i.pop3Setting.junkPop3=!!a.chargeJunk,t.each(i.otherFolders,function(e,t){t.flags.pop3=i.pop3Setting.otherPop3,s.push({id:t.id,flags:{pop3:i.pop3Setting.otherPop3}})}),i.junkFolder.flags.pop3=i.pop3Setting.junkPop3,s=s.concat([{id:i.junkFolder.id,flags:{pop3:i.pop3Setting.junkPop3}}]),t.when(o.updateFolders(s)).then(function(e){i._initPop3ViewTpl.call(i),i._toggleView()},function(){
t.notify.error(r.t("setting/msg_savefailed"))})}});i.module({name:"setting.client.pop",template:e("text!template/module/setting/client/pop/index.tpl.html")},l)}),define("components/requirejs-text/text!template/module/setting/delivery/index.tpl.html",[],function(){return'<section class="m-sgdelivery j-delivery">\r\n  <nav class="nav u-tab u-tab-highlight-down">\r\n    <ul class="j-delivery-nav"></ul>\r\n  </nav>\r\n\r\n  <div class="j-delivery-content content">\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="tabTpl">\r\n\r\n    <li data-trigger="delivery.compose">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n "setting/tab_compose"}}</a>\r\n    </li>\r\n\r\n    <li data-trigger="delivery.reply">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n "setting/tab_reply"}}</a>\r\n    </li>\r\n\r\n    <li data-trigger="delivery.read">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n "setting/tab_read"}}</a>\r\n    </li>\r\n\r\n    [[#if enableForward]]\r\n    <li data-trigger="delivery.forward">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n "setting/tab_forward"}}</a>\r\n    </li>\r\n    [[/if]]\r\n\r\n    [[#if enableAutoReply]]\r\n    <li data-trigger="delivery.autoreply">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n "setting/tab_autoreply"}}</a>\r\n    </li>\r\n    [[/if]]\r\n\r\n    [[#if enableMailTemplate]]\r\n    <li data-trigger="delivery.template">\r\n      <span class="bar"></span>\r\n      <a href="javascript:void(0)">{{i18n "setting/tab_template"}}</a>\r\n    </li>\r\n    [[/if]]\r\n  </script>\r\n  {{/raw}}\r\n</section>'}),define("module/setting/delivery/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","module/common/globalService","configurable/index","util/i18n","text!template/module/setting/delivery/index.tpl.html"],function(e){function t(e,t){return i("<div>",{"data-panel":e.sid,"class":t+" u-scroll",style:"display:none",html:""})}function n(e,t){if(0==t.indexOf("setting.delivery")){var n=t.substring("setting.".length);e.tabview.find(n)&&(l.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("cui/ui/tabview/tabview"),l=e("module/common/globalService"),c=e("configurable/index"),d=e("util/i18n"),u=a.extend({Implements:s,setup:function(){this.config=c("setting.delivery",this),this.state=l.getCurrentState();var e=this.state.module.split(".");this.activeTabId=e[2]?"delivery."+e[2]:"delivery.compose",this.state.module="setting."+this.activeTabId,l.setCurrentState(this.state),this._setHistory(this.state)},render:function(){u.superclass.render.call(this),this._initTabView(),this._initModuleEvent()},_initTabView:function(){var e,n=this,a=[],s=n.compile(n.$("#tabTpl").html(),n.config);n.$(".j-delivery-nav").html(s),e=[{id:"delivery.compose",title:d.t("setting.tab_compose"),module:r.module("setting.delivery.compose")},{id:"delivery.reply",title:d.t("setting.tab_reply"),module:r.module("setting.delivery.reply")},{id:"delivery.read",title:d.t("setting.tab_read"),module:r.module("setting.delivery.read")},{id:"delivery.forward",title:d.t("setting.tab_forward"),module:r.module("setting.delivery.forward")},{id:"delivery.autoreply",title:d.t("setting.tab_autoreply"),module:r.module("setting.delivery.autoreply")},{id:"delivery.template",title:d.t("setting.tab_template"),module:r.module("setting.delivery.template")}],n.config.enableForward||a.push("delivery.forward"),n.config.enableAutoReply||a.push("delivery.autoreply"),n.config.enableMailTemplate||a.push("delivery.template"),e=i.grep(e,function(e){return-1===i.inArray(e.id,a)}),n.tabview=new o({element:"section.j-delivery",classPrefix:"j-delivery",activeTabId:n.activeTabId,activeTriggerClass:"z-current",onlyRenderActive:!0,generatePanelMarkup:t,tabs:e}),n.tabview.render(),n.tabview.on("render",function(e){n._setHistory({module:"setting."+e})}),n.tabview.on("refresh",function(e){n.sendMessage("dispatcher","view:refresh",{module:"setting."+e,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(t){var i=t.message.newState;n(e,i.module)})},_setHistory:function(e){var t=this,n=i.extend(!0,{},e);0==n.module.indexOf("setting.delivery.")&&(n.param={},t.sendMessage("dispatcher","view:render",n))}});r.module({name:"setting.delivery",template:e("text!template/module/setting/delivery/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/delivery/autoreply/index.tpl.html",[],function(){return'<section class="m-autoreply">\r\n    <section class="j-autoreply"></section>\r\n\r\n{{#raw}}\r\n<script type="text/x-handlebars-template" id="autoReplyTpl">\r\n    <form name="autoreply">\r\n        <div class="u-btns-top">\r\n            <button type="button" class="u-btn u-btn-primary" id="saveAutoReply" data-action="save" disabled>[[i18n \'setting/op_save\']]</button>\r\n            <button type="reset" class="u-btn u-btn-default" data-action="cancel" disabled>[[i18n \'setting/op_cancel\']]</button>\r\n        </div>\r\n\r\n        <div class="u-form-item f-mgt f-cf" id="switch">\r\n            <label class="u-form-label f-dis">[[i18n \'setting/lbl_autoreply\']] :&nbsp;&nbsp;</label>\r\n            <span class="f-ib f-vam">\r\n                <input type="checkbox" name="autorepmode" role="switchBtn" class="checkbox" value="1" [[#compare autorepmode \'==\' \'1\' ]] checked[[/compare]] />\r\n            </span>\r\n        </div>\r\n       <!---->\r\n        <div class="disable-mask [[#compare autorepmode \'==\' \'1\' ]] f-dn[[/compare]]"></div>\r\n\r\n        <div class="u-form-item f-rel">\r\n            <label class="u-form-label f-dis">[[i18n "pref/autoresp/time"]] :&nbsp;&nbsp;</label>\r\n            <input class="hasDatepicker j-beginDate"  type="text" name="autorep_condition[begintime][]" value=\'[[formattedDate begintime "YYYY-MM-DD" ]]\'> :\r\n            <select name="autorep_condition[begintime][]:string" class="u-select j-select-beginHour">\r\n                [[[selectOption begintime]]]\r\n            </select>\r\n            <span class="f-dis">&nbsp;[[i18n "pref/autoresp/to"]]&nbsp;</span>\r\n            <input class="hasDatepicker j-endDate"  type="text" name="autorep_condition[endtime][]" value=\'[[formattedDate endtime "YYYY-MM-DD" ]]\'/>  :\r\n            <select name="autorep_condition[endtime][]:string" class="u-select j-select-endHour">\r\n                [[[selectOption endtime]]]\r\n            </select>\r\n            <div class="error f-dn"></div>\r\n\r\n        </div>\r\n\r\n        <div class="u-form-item">\r\n            <label class="u-form-label f-dis">[[i18n "pref/autoresp/content"]]:&nbsp;&nbsp;</label>\r\n            <textarea name="autoreptext:string" id="dest" cols="50" rows="5">[[autoreptext]]</textarea>\r\n            <p class="u-choice">\r\n              <label for="autoresp_instation">\r\n                <input type="checkbox" name="autorep_condition[instation]:string" id="autoresp_instation" value="1" [[#compare autorep_condition.instation \'==\' \'1\']]checked[[/compare]] />[[i18n "pref/autoresp/instation_tip_set"]]\r\n              </label>\r\n              <br />\r\n              <label for="autorep_welcometip">\r\n                <input type="checkbox" name="autorep_welcometip" id="autorep_welcometip" value="1"  [[#compare autorep_welcometip \'==\' \'1\']]checked[[/compare]] />[[i18n "pref/autoresp/welcome_tip_set"]]\r\n              </label>\r\n            </p>\r\n        </div>\r\n\r\n    </form>\r\n</script>\r\n{{/raw}}\r\n</section>\r\n'}),define("module/setting/delivery/autoreply/index",["require","i18n!setting,pref/autoresp","jquery.datepicker","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/select/select","cui/util/cookie/cookie","module/common/globalService","./../../service","moment","i18n","text!template/module/setting/delivery/autoreply/index.tpl.html"],function(e){e("i18n!setting,pref/autoresp"),e("jquery.datepicker");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("cui/ui/select/select"),s=e("cui/util/cookie/cookie"),o=e("module/common/globalService"),l=e("./../../service"),c=e("moment"),d=e("i18n"),u=n.extend({Implements:a,templateHelpers:{formattedDate:function(e,t){return e?c(e).format(t):""},selectOption:function(e){for(var n=e?c(e).format("HH"):"",i="",a=function(e){return 10>e?"0"+r:""+r},r=0;24>r;r++)i+=t("<option>",{text:a(r),selected:r==n,value:a(r)}).prop("outerHTML");return i}},events:{"click [data-action]":"_dispatchAction","click #switch .checkbox":"_handleToggleBtn","change .hasDatepicker":"_checkSelectDate","blur .hasDatepicker":"_checkSelectDate","change .j-beginDate":"_handleShowPicker","click form :input:not(.u-btn)":"_checkSelectDate"},render:function(){u.superclass.render.call(this),this._initView(!0),this._initModuleEvent()},_initView:function(e){var t,n=this;e=e||!1,e?(n.element.mask(),t=["autorepmode","autoreptext","autorep_condition","autorep_welcometip"],l.getAttrs(t).then(function(e){e.autoreptext=e.autoreptext||d.t("pref/autoresp/default_text"),1==e.autorepmode&&e.autorep_condition?(e.begintime=e.autorep_condition.begintime,e.endtime=e.autorep_condition.endtime):(e.begintime=c().hours(0).format("YYYY-MM-DD HH:mm:ss"),e.endtime=c().hours(0).add(1,"days").format("YYYY-MM-DD HH:mm:ss")),e.instation=e.autorep_condition||0,n.autoReplySet=e,n._generateView(),n.element.mask("hide")})):n._generateView()},_initModuleEvent:function(){var e=this;this.onMessage("view:change",function(){e._initView(!0)},null)},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"save":i._handleSaveAutoReply();break;case"cancel":i._initView()}},_generateView:function(){var e=this,n=new Date,i=e.compile(t("#autoReplyTpl").html(),e.autoReplySet);e.$(".j-autoreply").html(i),e.element.customRadioCheckbox(),e.$("form[name='autoreply'] .u-select").each(function(){var n={classPrefix:"u-select",maxHeight:200,trigger:t(this),style:{minWidth:96}};new r(n).render().on("change",function(){e._checkSelectDate()})}),e.$(".hasDatepicker").datepicker({autoClose:!0,isDisabled:function(e){return e.valueOf()<n}})},_formatDate:function(e){var n=e.autorep_condition.begintime,i=e.autorep_condition.endtime;t.extend(e.autorep_condition,{begintime:c(n[0]).add(n[1],"hours").toDate(),endtime:c(i[0]).add(i[1],"hours").toDate()})},_handleSaveAutoReply:function(){var e=this.$("form[name='autoreply']").serializeJSON({parseNumbers:!0,checkboxUncheckedValue:"0"});0==e.autorepmode&&(delete e.autorep_condition.begintime,delete e.autorep_condition.endtime),this._saveAutoReply(e)},_saveAutoReply:function(e){var n=this;e.autorep_condition.begintime&&this._formatDate(e),o.updateUser(e,!0).then(function(){n.autoReplySet=e,s.remove("disable_autoreply_notify"),n.sendMessage("mail.welcome","view:refresh",null),n.sendMessage("mail.list","notify:refresh",null),n.sendMessage("mail.previewlayout","notify:refresh",null),t.notify(d.t("pref/autoresp/info_update_success")),n._toggleButtonDisabledAttr(!0)})},_handleToggleBtn:function(){var e=this.$(".disable-mask");e.toggleClass("f-dn"),e.hasClass("f-dn")?this._checkSelectDate():this._toggleButtonDisabledAttr()},_handleShowPicker:function(e,n){var i=t(n).val(),a=new Date;c(i,"YYYY-MM-DD",!0).isValid()&&(a=new Date(i)),this.$(".j-endDate").data("datepicker").disable(),this.$(".j-endDate").data("datepicker",null),this.$(".j-endDate").datepicker({autoClose:!0,isDisabled:function(e){return e.valueOf()<a}})},_checkSelectDate:function(){var e,t=this,n=t.$(".j-beginDate").val(),i=t.$(".j-select-beginHour").val(),a=t.$(".j-endDate").val(),r=t.$(".j-select-endHour").val(),s=c(n,"YYYY-MM-DD",!0).isValid(),o=c(a,"YYYY-MM-DD",!0).isValid();return s&&o?(n=c(n).add(i,"hours"),a=c(a).add(r,"hours"),e=c(),n.isAfter(a)?(t.$(".error").html(d.t("pref/autoresp/err_begintime_late_endtime")).show(),void t._toggleButtonDisabledAttr(!0,!1)):a.isBefore(e)?(t.$(".error").html(d.t("pref/autoresp/err_time_early_now")).show(),void t._toggleButtonDisabledAttr(!0,!1)):(t.$(".error").hide(),void t._toggleButtonDisabledAttr())):(n?a?t.$(".error").html(d.t("pref/autoresp/date_is_invalid")).show():t.$(".error").html(d.t("pref/autoresp/err_endtime_empty")).show():t.$(".error").html(d.t("pref/autoresp/err_begintime_empty")).show(),void t._toggleButtonDisabledAttr(!0,!1))},_toggleButtonDisabledAttr:function(e,n){var i=this;e="boolean"===t.type(e)?e:!1,n="boolean"===t.type(n)?n:!0,n?i.$(".u-btn").prop("disabled",e):i.$(".u-btn-primary").prop("disabled",e)}});i.module({name:"setting.delivery.autoreply",template:e("text!template/module/setting/delivery/autoreply/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/delivery/compose/index.tpl.html",[],function(){return'<section class="m-compose-set">\r\n  <div class="operation">\r\n    <div class="u-btns-top">\r\n      <button type="button" class="u-btn u-btn-primary" data-action="save">{{i18n "setting/op_save"}}</button>\r\n      <button type="button" class="u-btn u-btn-default" data-action="reset">{{i18n "setting/op_cancel"}}</button>\r\n    </div>\r\n  </div>\r\n  <form action="" class="j-compose-form">\r\n\r\n  </form>\r\n\r\n  {{#raw}}\r\n  <script id="composeSetTpl" type="text/x-handlebars-template">\r\n    [[#if default_sender_address]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[default_sender_address.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <select name="default_sender_address">\r\n          [[#each default_sender_address.allEmails]]\r\n          <option value="[[addr]]" [[#compare ../../default_sender_address.value \'==\' addr]]selected[[/compare]]>[[addr]]</option>\r\n          [[/each]]\r\n        </select>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#if edit_mode]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[edit_mode.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="edit_mode" value="1" [[formattedChosen edit_mode 1]]/>\r\n            [[translateI18N \'edit_mode\' 1]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="edit_mode" value="0" [[formattedChosen edit_mode 0]]/>\r\n            [[translateI18N \'edit_mode\' 0]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[translateI18N \'when_sendmail\']]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        [[#if save_sent]]\r\n        <div>\r\n          <label>\r\n            <input type="checkbox" name="save_sent" value="1" data-unchecked-value="0"  [[formattedChosen save_sent 1]]/>\r\n            [[translateI18N \'save_sent\']]\r\n          </label>\r\n        </div>\r\n        [[/if]]\r\n        [[#if smtp_save_sent]]\r\n        <div>\r\n          <label>\r\n            <input type="checkbox" name="smtp_save_sent" value="1" data-unchecked-value="0" [[formattedChosen smtp_save_sent 1]]/>\r\n            [[translateI18N \'smtp_save_sent\']]\r\n          </label>\r\n        </div>\r\n        [[/if]]\r\n        [[#if aftersend_saveaddr]]\r\n        <div>\r\n          <label>\r\n            <input type="checkbox" name="aftersend_saveaddr" value="1" data-unchecked-value="0" [[formattedChosen aftersend_saveaddr 1]]/>\r\n            [[translateI18N \'aftersend_saveaddr\']]\r\n          </label>\r\n        </div>\r\n        [[/if]]\r\n        [[#if displaysender]]\r\n        <div>\r\n          <label>\r\n            <input type="checkbox" name="displaysender"  value="0" data-unchecked-value="1" [[formattedChosen displaysender 0]]/>\r\n            [[translateI18N \'displaysender\']] : [[displayUserName]]\r\n          </label>\r\n        </div>\r\n        [[/if]]\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  {{/raw}}\r\n  </section>'}),define("module/setting/delivery/compose/index",["require","util/i18n!setting,pref/preference,pref/personal","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/dialog/confirmbox","module/common/globalService","./../../service","configurable/index","i18n","text!template/module/setting/delivery/compose/index.tpl.html"],function(e){e("util/i18n!setting,pref/preference,pref/personal");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("cui/ui/dialog/confirmbox"),s=e("module/common/globalService"),o=e("./../../service"),l=e("configurable/index"),c=e("i18n"),d={},u=n.extend({Implements:a,templateHelpers:{translateI18N:function(e,t){t=null==t?d.defaultValues[e]:t;var n=d.recommendValues[e]==t?"("+c.t("pref/preference/recommendation")+")":"";return"maxlist"==e||"display_list"==e||"replyf"==e?c.t("setting."+e+"_v_"+t)+n:"addo"==e?c.t("setting."+e+"_v"):"save_sent"==e||"smtp_save_sent"==e||"aftersend_saveaddr"==e||"displaysender"==e||"when_sendmail"==e?c.t("setting."+e+"_text"):c.t("pref/preference/"+e+"_v_"+t)+n},formattedChosen:function(e,t){var n=e.value,i="maxlist"==e.key||"replyf"==e.key;return null!=n?n==t?i?"selected":"checked":"":d.defaultValues[e.key]==t?i?"selected":"checked":""},displayUserName:function(){return s.getConfig("user.name")}},events:{"click [data-action]":"_dispatchAction"},setup:function(){this.config=l("setting.delivery",this),t.when(s.getReservedUserAttrValues(),s.getReservedUserAttrRecommendValues(),s.getReservedUserAttrKeys()).then(function(e,t,n){d.defaultValues=e,d.recommendValues=t,d.allKeys=n})},render:function(){u.superclass.render.call(this),this._initView()},_initView:function(){var e=this;e.preferModel={},o.getAttrs(d.allKeys).then(function(n){for(var i in n)if(n.hasOwnProperty(i)){var a={label:c.t("pref/preference/"+i+"_text"),key:i,value:n[i]};"default_sender_address"==i&&(a.allEmails=e.config.allEmails),e.preferModel[i]=a}e.$(".j-compose-form").html(e.compile(t("#composeSetTpl").html(),e.preferModel)),e.element.customRadioCheckbox()})},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"save":i._changeComposeSettings();break;case"reset":i._initView()}},_changeComposeSettings:function(){var e=this,n=this.$(".j-compose-form").serializeJSON({parseNumbers:!0});t.when(s.updateUser(n,!0)).then(function(i,a){t.notify(c.t("setting/msg_prefUpdateSuccess")),t.each(n,function(t,n){e.preferModel[t].value=n}),a&&a.changed&&r.alert(c.t("setting/msg_prefOtherUpdateSuccess"),function(){location.href=a.mainURL})})}});i.module({name:"setting.delivery.compose",template:e("text!template/module/setting/delivery/compose/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/delivery/forward/index.tpl.html",[],function(){return'<section class="m-forward" >\r\n\r\n  <div class="main-wrapper">\r\n     <div class="grid-col12 j-forward-set content-wrapper"></div>\r\n\r\n     <!--[if lt IE 9]>\r\n     <div class="sg-mask" />\r\n     <![endif]-->\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="forwordSetTpl">\r\n     <div class="title dotted">\r\n        <h4>[[i18n "setting/lbl_forwardsetting"]]</h4>\r\n     </div>\r\n     <form action="#" id="forward" onsubmit="return false;">\r\n        <div class="form-control">\r\n          <div class="form-item">\r\n            <label class="form-label">[[i18n "setting/lbl_forward"]] :</label>\r\n            <span class="f-ib f-vam">\r\n                <input type="checkbox" id="toggle" role="switchBtn" class="checkbox " value="1" [[#compare forwardactive \'!=\' 0 ]] checked[[/compare]]>\r\n              </span>\r\n          </div>\r\n          <div class="form-item">\r\n            <label class="form-label">[[i18n "setting/lbl_forward_condition"]] :</label>\r\n            <div class="forwardOpt1">\r\n              <label for="forwardactive_1" class="label">\r\n                <input type="radio" name="forwardactive" id="forwardactive_1" value="1" [[#compare forwardactive \'==\' 1 ]] checked[[/compare]]>[[i18n "setting/lbl_forwardAutoEnable"]]\r\n              </label>\r\n            </div>\r\n          </div>\r\n          <div class="form-item">\r\n            <div class="forwardOpt2">\r\n              <label>\r\n                <input type="checkbox" name="keeplocal" id="keeplocal" value="1" [[#compare forwardactive \'==\' \'1\']][[#compare keeplocal \'==\' 1]]checked[[/compare]][[/compare]] />\r\n                [[i18n "setting/lbl_forwardKeepLocal"]]\r\n              </label>\r\n            </div>\r\n          </div>\r\n          <div class="form-item">\r\n            <div class="forwardOpt3">\r\n              <label for="forwardactive_3">\r\n                <input type="radio" name="forwardactive" id="forwardactive_3" value="3" [[#compare forwardactive \'==\' 3 ]]checked[[/compare]] />\r\n                [[i18n "setting/lbl_forwardFullEnable"]]\r\n              </label>\r\n            </div>\r\n          </div>\r\n          <!-- -->\r\n          <div class="disable-mask [[#compare forwardactive \'!=\' 0 ]]f-dn[[/compare]]"></div>\r\n        </div>\r\n        <div class="title dotted">\r\n           <h4> [[i18n "setting/lbl_forwardlist"]]</h4>\r\n        </div>\r\n\r\n       <div class="u-list-modify">\r\n         <div class="u-input-control">\r\n           <input type="text" class="u-input j-new-rule" placeholder="[[i18n \'setting/lbl_forward_address\']]">\r\n         </div>\r\n         <button type="button" class="u-btn u-btn-primary" data-action="add">[[i18n "setting/op_add"]]</button>\r\n         <div class="u-error-alert f-dn"></div>\r\n       </div>\r\n       <!---->\r\n        <div class="list-title">\r\n            <span class="f-csp" data-action="listToggle">\r\n              <i class="iconfont iconcollapse"></i>\r\n              <span>[[i18n "setting/lbl_contact"]]</span>\r\n              <span class="opr">[[i18n "setting/lbl_op"]]</span>\r\n            </span>\r\n        </div>\r\n        <table>\r\n          [[#each forwarddes]]\r\n          <tr>\r\n            <td>[[this]]<input type="hidden" name="forwarddes[]" value="[[this]]"/></td>\r\n            <td class="last-child">\r\n              <a href="javascript:void(0);" class="link" data-action="remove" data-item-name="[[this]]" >\r\n                [[i18n "setting/op_remove"]]\r\n              </a>\r\n            </td>\r\n          </tr>\r\n          [[/each]]\r\n        </table>\r\n    </form>\r\n  </script>\r\n  {{/raw}}\r\n</section>\r\n'}),define("module/setting/delivery/forward/index",["require","i18n!setting","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/dialog/confirmbox","../../../../util/index","i18n","./../../service","module/common/globalService","../../../../configurable/index","text!template/module/setting/delivery/forward/index.tpl.html"],function(e){e("i18n!setting");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("cui/ui/dialog/confirmbox"),s=e("../../../../util/index"),o=e("i18n"),l=e("./../../service"),c=e("module/common/globalService"),d=e("../../../../configurable/index"),u=n.extend({Implements:a,events:{"click [data-action]":"_dispatchAction","change.crc #toggle":"_forwardToggle","change.crc #forwardactive_1":"_handleModeSwitch1","change.crc #forwardactive_3":"_handleModeSwitch2","change.crc #keeplocal":"_handleModeSwitch3"},setup:function(){this.config=d("setting.delivery"),this.state={forwarddes:[]}},render:function(){u.superclass.render.call(this),this._initView()},_initView:function(){var e=this;this.element.mask(),l.getAttrs("forwardactive,keeplocal,forwarddes").then(function(t){t.forwarddes&&(e.state.forwarddes=t.forwarddes.split(",")),e.state.keeplocal=t.keeplocal,e.state.forwardactive=null==t.forwardactive?0:t.forwardactive,e._generateView()}).always(function(){e.element.mask("hide")})},_generateView:function(){var e=this.compile(this.$("#forwordSetTpl").html(),this.state);this.$(".j-forward-set").html(e).customRadioCheckbox()},_dispatchAction:function(e,n){switch(t(n).data("action")){case"listToggle":this._handleToggleList(n);break;case"add":this._handleAddRules();break;case"update":this._handleUpdateOption();break;case"remove":this._handleRemoveRules(n)}},_handleToggleList:function(e){this.$("table").toggle(),t("i",e).toggleClass("iconunfold iconcollapse")},_handleAddRules:function(){var e=s.html.encode(t(".j-new-rule").val());if(!e)return void this._displayErrorMsg(o.t("setting/msg_inputEmpty"));if(!s.Email.test(e))return void this._displayErrorMsg(o.t("setting/msg_errorEmailFormat"));if(-1!==t.inArray(e,this.state.forwarddes))return void this._displayErrorMsg(s.messageFormat.format(o.t("setting/msg_itemsExistForwardList"),e));for(var n=0;n<this.config.allEmails.length;n++)if(e==this.config.allEmails[n].addr)return void this._displayErrorMsg(o.t("setting/msg_errExceptOwnMail"));this.state.forwarddes.push(e),this._handleUpdateRules()},_handleUpdateRules:function(){var e=this,n={};n.forwarddes=this.state.forwarddes.join(","),l.auth2continue(c.getLockOpValues().autoReply).then(function(){0==e.state.forwarddes.length&&(n.forwardactive=0),c.updateUser(n,!1).then(function(){t.notify.success(o.t("setting/msg_forwardRuleSaveSuccessful")),e._initView()})})},_handleUpdateOption:function(){var e=this,n=e.$("#forward").serializeJSON({checkboxUncheckedValue:"0",parseNumbers:!0});delete n.forwarddes,this.$("#toggle").prop("checked")?n.forwardactive=parseInt(this.$("input[name='forwardactive']:checked").val()):n.forwardactive=0,(n.forwardactive!=this.state.forwardactive||n.keeplocal!=this.state.keeplocal)&&c.updateUser(n,!1).then(function(){t.extend(e.state,n),n.forwardactive?t.notify.success(o.t("setting/msg_forwardEnableSuccessful")):t.notify.success(o.t("setting/msg_forwardDisableSuccessful"))})},_handleRemoveRules:function(e){var n=this,i=t(e).data("item-name");r.confirm(s.messageFormat.format(o.t("setting/msg_confirmContactDel"),s.html.encode(i)),function(){var e=t.inArray(i,n.state.forwarddes);-1!==e&&(n.state.forwarddes.splice(e,1),n._handleUpdateRules())})},_displayErrorMsg:function(e){this.$(".u-list-modify").find(".u-error-alert").html(e).end().addClass("error")},_forwardToggle:function(){var e=this,t=e.$("#toggle").prop("checked");l.auth2continue(c.getLockOpValues().autoReply).then(function(){t?(p.checkChk(e.$("#forwardactive_1"),"radio"),p.checkChk(e.$("#keeplocal"),"checkbox")):(p.unCheckChk(e.$("#forwardactive_1"),"radio"),p.unCheckChk(e.$("#forwardactive_3"),"radio"),p.unCheckChk(e.$("#keeplocal"),"checkbox")),e.$(".disable-mask").toggleClass("f-dn"),e._handleUpdateOption()})},_handleModeSwitch1:function(){p.checkAndActiveChk(this.$("#keeplocal"),"checkbox"),this._handleUpdateOption()},_handleModeSwitch2:function(){p.unCheckAndDisableChk(this.$("#keeplocal"),"checkbox"),p.unCheckChk(this.$("#forwardactive_1"),"radio"),p.checkChk(this.$("#forwardactive_3"),"radio"),this._handleUpdateOption()},_handleModeSwitch3:function(){this._handleUpdateOption()}}),p={disableClass:"rc-disabled",radioCheckedClass:"radio-checked",disableChk:function(e){e.prop("disabled",!0).next("i").addClass(this.disableClass)},activeChk:function(e){e.prop("disabled",!1).next("i").removeClass(this.disableClass)},unCheckChk:function(e,t){e.prop("checked",!1).next("i").removeClass(t+"-checked")},checkChk:function(e,t){e.prop("checked",!0).next("i").addClass(t+"-checked")},checkAndActiveChk:function(e,t){this.checkChk(e,t),this.activeChk(e)},unCheckAndDisableChk:function(e,t){this.unCheckChk(e,t),this.disableChk(e)}};i.module({name:"setting.delivery.forward",template:e("text!template/module/setting/delivery/forward/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/delivery/read/index.tpl.html",[],function(){return'<section class="m-read-set">\r\n  <div class="operation">\r\n    <div class="u-btns-top">\r\n      <button type="button" class="u-btn u-btn-primary" data-action="save">{{i18n "setting/op_save"}}</button>\r\n      <button type="button" class="u-btn u-btn-default" data-action="reset">{{i18n "setting/op_cancel"}}</button>\r\n    </div>\r\n  </div>\r\n  <form action="" class="j-read-form">\r\n\r\n  </form>\r\n\r\n  {{#raw}}\r\n  <script id="readSetTpl" type="text/x-handlebars-template">\r\n\r\n    [[#if newwindowtoreadletter]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[newwindowtoreadletter.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="newwindowtoreadletter"  value="0" [[formattedChosen newwindowtoreadletter 0]]/>\r\n            [[translateI18N \'newwindowtoreadletter\' 0]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="newwindowtoreadletter"  value="1" [[formattedChosen newwindowtoreadletter 1]]/>\r\n            [[translateI18N \'newwindowtoreadletter\' 1]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#if afterdel]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[afterdel.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="afterdel"  value="0" [[formattedChosen afterdel 0]]/>\r\n            [[translateI18N \'afterdel\' 0]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="afterdel"  value="1" [[formattedChosen afterdel 1]]/>\r\n            [[translateI18N \'afterdel\' 1]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#if op_readreceipt]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[op_readreceipt.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="op_readreceipt"  value="0" [[formattedChosen op_readreceipt 0]]/>\r\n            [[translateI18N \'op_readreceipt\' 0]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="op_readreceipt"  value="1" [[formattedChosen op_readreceipt 1]]/>\r\n            [[translateI18N \'op_readreceipt\' 1]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#if subject_refw_prefix_expand]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[i18n "setting/subject_refw_prefix_expand_text"]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="subject_refw_prefix_expand"  value="1" [[formattedChosen subject_refw_prefix_expand 1]]/>\r\n            [[[ i18n "setting/subject_refw_prefix_expand_v_1" ]]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="subject_refw_prefix_expand"  value="0" [[formattedChosen subject_refw_prefix_expand 0]]/>\r\n            [[[ i18n "setting/subject_refw_prefix_expand_v_0" ]]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n  </script>\r\n  {{/raw}}\r\n</section>';
}),define("module/setting/delivery/read/index",["require","util/i18n!setting,pref/preference,pref/personal","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/dialog/confirmbox","module/common/globalService","./../../service","i18n","text!template/module/setting/delivery/read/index.tpl.html"],function(e){e("util/i18n!setting,pref/preference,pref/personal");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("cui/ui/dialog/confirmbox"),s=e("module/common/globalService"),o=e("./../../service"),l=e("i18n"),c={},d=n.extend({Implements:a,templateHelpers:{translateI18N:function(e,t){t=null==t?c.defaultValues[e]:t;var n=c.recommendValues[e]==t?"("+l.t("pref/preference/recommendation")+")":"";return"maxlist"==e||"display_list"==e||"replyf"==e?l.t("setting."+e+"_v_"+t)+n:"addo"==e?l.t("setting."+e+"_v"):"save_sent"==e||"smtp_save_sent"==e||"aftersend_saveaddr"==e||"displaysender"==e||"when_sendmail"==e?l.t("setting."+e+"_text"):l.t("pref/preference/"+e+"_v_"+t)+n},formattedChosen:function(e,t){var n=e.value,i="maxlist"==e.key||"replyf"==e.key;return null!=n?n==t?i?"selected":"checked":"":c.defaultValues[e.key]==t?i?"selected":"checked":""}},events:{"click [data-action]":"_dispatchAction"},setup:function(){t.when(s.getReservedUserAttrValues(),s.getReservedUserAttrRecommendValues(),s.getReservedUserAttrKeys()).then(function(e,t,n){c.defaultValues=e,c.recommendValues=t,c.allKeys=n})},render:function(){d.superclass.render.call(this),this._initView()},_initView:function(){var e=this;o.getAttrs(c.allKeys).then(function(n){e.preferModel={};for(var i in n)if(n.hasOwnProperty(i)&&null!=n[i]){var a={label:l.t("pref/preference/"+i+"_text"),key:i,value:n[i]};e.preferModel[i]=a}e.$(".j-read-form").html(e.compile(t("#readSetTpl").html(),e.preferModel)),e.element.customRadioCheckbox()})},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"save":i._changeListSettings();break;case"reset":i._initView()}},_changeListSettings:function(){var e=this,n=this.$(".j-read-form").serializeJSON({parseNumbers:!0});t.when(s.updateUser(n,!0)).then(function(i,a){t.notify(l.t("setting/msg_prefUpdateSuccess")),t.each(n,function(t,n){e.preferModel[t].value=n}),a&&a.changed&&r.alert(l.t("setting/msg_prefOtherUpdateSuccess"),function(){location.href=a.mainURL})})}});i.module({name:"setting.delivery.read",template:e("text!template/module/setting/delivery/read/index.tpl.html")},d)}),define("components/requirejs-text/text!template/module/setting/delivery/reply/index.tpl.html",[],function(){return'<section class="m-reply-set">\r\n  <div class="operation">\r\n    <div class="u-btns-top">\r\n      <button type="button" class="u-btn u-btn-primary" data-action="save">{{i18n "setting/op_save"}}</button>\r\n      <button type="button" class="u-btn u-btn-default" data-action="reset">{{i18n "setting/op_cancel"}}</button>\r\n    </div>\r\n  </div>\r\n  <form action="" class="j-reply-form">\r\n\r\n  </form>\r\n\r\n  {{#raw}}\r\n  <script id="replySetTpl" type="text/x-handlebars-template">\r\n\r\n    [[#if addo]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[addo.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="checkbox" name="addo"  value="0" data-unchecked-value="1" [[formattedChosen addo 0]]/>\r\n            [[translateI18N \'addo\']]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#if replyf]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[replyf.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <select name="replyf">\r\n          <option value="0" [[formattedChosen replyf 0]]> [[translateI18N \'replyf\' 0]] </option>\r\n          <option value="1" [[formattedChosen replyf 1]]> [[translateI18N \'replyf\' 1]] </option>\r\n          <option value="2" [[formattedChosen replyf 2]]> [[translateI18N \'replyf\' 2]] </option>\r\n          <option value="3" [[formattedChosen replyf 3]]> [[translateI18N \'replyf\' 3]] </option>\r\n        </select>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#if reply_all_mode]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[reply_all_mode.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="reply_all_mode" value="0" [[formattedChosen reply_all_mode 0]]/>\r\n            [[translateI18N \'reply_all_mode\' 0]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="reply_all_mode" value="1" [[formattedChosen reply_all_mode 1]]/>\r\n            [[translateI18N \'reply_all_mode\' 1]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n  </script>\r\n\r\n  {{/raw}}\r\n</section>'}),define("module/setting/delivery/reply/index",["require","util/i18n!setting,pref/preference,pref/personal","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/dialog/confirmbox","module/common/globalService","./../../service","i18n","text!template/module/setting/delivery/reply/index.tpl.html"],function(e){e("util/i18n!setting,pref/preference,pref/personal");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("cui/ui/dialog/confirmbox"),s=e("module/common/globalService"),o=e("./../../service"),l=e("i18n"),c={},d=n.extend({Implements:a,templateHelpers:{translateI18N:function(e,t){t=null==t?c.defaultValues[e]:t;var n=c.recommendValues[e]==t?"("+l.t("pref/preference/recommendation")+")":"";return"maxlist"==e||"display_list"==e||"replyf"==e?l.t("setting."+e+"_v_"+t)+n:"addo"==e?l.t("setting."+e+"_v"):"save_sent"==e||"smtp_save_sent"==e||"aftersend_saveaddr"==e||"displaysender"==e||"when_sendmail"==e?l.t("setting."+e+"_text"):l.t("pref/preference/"+e+"_v_"+t)+n},formattedChosen:function(e,t){var n=e.value,i="maxlist"==e.key||"replyf"==e.key;return null!=n?n==t?i?"selected":"checked":"":c.defaultValues[e.key]==t?i?"selected":"checked":""}},events:{"click [data-action]":"_dispatchAction"},setup:function(){t.when(s.getReservedUserAttrValues(),s.getReservedUserAttrRecommendValues(),s.getReservedUserAttrKeys()).then(function(e,t,n){c.defaultValues=e,c.recommendValues=t,c.allKeys=n})},render:function(){d.superclass.render.call(this),this._initView()},_initView:function(){var e=this;o.getAttrs(c.allKeys).then(function(n){e.preferModel={};for(var i in n)if(n.hasOwnProperty(i)){var a={label:l.t("pref/preference/"+i+"_text"),key:i,value:n[i]};e.preferModel[i]=a}e.$(".j-reply-form").html(e.compile(t("#replySetTpl").html(),e.preferModel)),e.element.customRadioCheckbox()})},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"save":i._changeListSettings();break;case"reset":i._initView()}},_changeListSettings:function(){var e=this,n=this.$(".j-reply-form").serializeJSON({parseNumbers:!0});t.when(s.updateUser(n,!0)).then(function(i,a){t.notify(l.t("setting/msg_prefUpdateSuccess")),t.each(n,function(t,n){e.preferModel[t].value=n}),a&&a.changed&&r.alert(l.t("setting/msg_prefOtherUpdateSuccess"),function(){location.href=a.mainURL})})}});i.module({name:"setting.delivery.reply",template:e("text!template/module/setting/delivery/reply/index.tpl.html")},d)}),function(e,t){function n(e,t,n){var i=e.children(),a=!1;e.empty();for(var s=0,o=i.length;o>s;s++){var l=i.eq(s);if(e.append(l),n&&e.append(n),r(e,t)){l.remove(),a=!0;break}n&&n.detach()}return a}function i(t,n,s,o,l){var c=!1,d="a, table, thead, tbody, tfoot, tr, col, colgroup, object, embed, param, ol, ul, dl, blockquote, select, optgroup, option, textarea, script, style",u="script, .dotdotdot-keep";return t.contents().detach().each(function(){var p=this,m=e(p);if("undefined"==typeof p)return!0;if(m.is(u))t.append(m);else{if(c)return!0;t.append(m),!l||m.is(o.after)||m.find(o.after).length||t[t.is(d)?"after":"append"](l),r(s,o)&&(c=3==p.nodeType?a(m,n,s,o,l):i(m,n,s,o,l)),c||l&&l.detach()}}),n.addClass("is-truncated"),c}function a(t,n,i,a,o){var d=t[0];if(!d)return!1;var p=c(d),m=-1!==p.indexOf(" ")?" ":"",h="letter"==a.wrap?"":m,f=p.split(h),v=-1,g=-1,b=0,_=f.length-1;for(a.fallbackToLetter&&0==b&&0==_&&(h="",f=p.split(h),_=f.length-1);_>=b&&(0!=b||0!=_);){var y=Math.floor((b+_)/2);if(y==g)break;g=y,l(d,f.slice(0,g+1).join(h)+a.ellipsis),i.children().each(function(){e(this).toggle().toggle()}),r(i,a)?(_=g,a.fallbackToLetter&&0==b&&0==_&&(h="",f=f[0].split(h),v=-1,g=-1,b=0,_=f.length-1)):(v=g,b=g)}if(-1==v||1==f.length&&0==f[0].length){var w=t.parent();t.detach();var x=o&&o.closest(w).length?o.length:0;w.contents().length>x?d=u(w.contents().eq(-1-x),n):(d=u(w,n,!0),x||w.detach()),d&&(p=s(c(d),a),l(d,p),x&&o&&e(d).parent().append(o))}else p=s(f.slice(0,v+1).join(h),a),l(d,p);return!0}function r(e,t){return e.innerHeight()>t.maxHeight}function s(t,n){for(;e.inArray(t.slice(-1),n.lastCharacter.remove)>-1;)t=t.slice(0,-1);return e.inArray(t.slice(-1),n.lastCharacter.noEllipsis)<0&&(t+=n.ellipsis),t}function o(e){return{width:e.innerWidth(),height:e.innerHeight()}}function l(e,t){e.innerText?e.innerText=t:e.nodeValue?e.nodeValue=t:e.textContent&&(e.textContent=t)}function c(e){return e.innerText?e.innerText:e.nodeValue?e.nodeValue:e.textContent?e.textContent:""}function d(e){do e=e.previousSibling;while(e&&1!==e.nodeType&&3!==e.nodeType);return e}function u(t,n,i){var a,r=t&&t[0];if(r){if(!i){if(3===r.nodeType)return r;if(e.trim(t.text()))return u(t.contents().last(),n)}for(a=d(r);!a;){if(t=t.parent(),t.is(n)||!t.length)return!1;a=d(t[0])}if(a)return u(e(a),n)}return!1}function p(t,n){return t?"string"==typeof t?(t=e(t,n),t.length?t:!1):t.jquery?t:!1:!1}function m(e){for(var t=e.innerHeight(),n=["paddingTop","paddingBottom"],i=0,a=n.length;a>i;i++){var r=parseInt(e.css(n[i]),10);isNaN(r)&&(r=0),t-=r}return t}if(!e.fn.dotdotdot){e.fn.dotdotdot=function(t){if(0==this.length)return e.fn.dotdotdot.debug('No element found for "'+this.selector+'".'),this;if(this.length>1)return this.each(function(){e(this).dotdotdot(t)});var a=this,s=a.contents();a.data("dotdotdot")&&a.trigger("destroy.dot"),a.data("dotdotdot-style",a.attr("style")||""),a.css("word-wrap","break-word"),"nowrap"===a.css("white-space")&&a.css("white-space","normal"),a.bind_events=function(){return a.bind("update.dot",function(t,o){switch(a.removeClass("is-truncated"),t.preventDefault(),t.stopPropagation(),typeof l.height){case"number":l.maxHeight=l.height;break;case"function":l.maxHeight=l.height.call(a[0]);break;default:l.maxHeight=m(a)}l.maxHeight+=l.tolerance,"undefined"!=typeof o&&(("string"==typeof o||"nodeType"in o&&1===o.nodeType)&&(o=e("<div />").append(o).contents()),o instanceof e&&(s=o)),f=a.wrapInner('<div class="dotdotdot" />').children(),f.contents().detach().end().append(s.clone(!0)).find("br").replaceWith("  <br />  ").end().css({height:"auto",width:"auto",border:"none",padding:0,margin:0});var d=!1,u=!1;return c.afterElement&&(d=c.afterElement.clone(!0),d.show(),c.afterElement.detach()),r(f,l)&&(u="children"==l.wrap?n(f,l,d):i(f,a,f,l,d)),f.replaceWith(f.contents()),f=null,e.isFunction(l.callback)&&l.callback.call(a[0],u,s),c.isTruncated=u,u}).bind("isTruncated.dot",function(e,t){return e.preventDefault(),e.stopPropagation(),"function"==typeof t&&t.call(a[0],c.isTruncated),c.isTruncated}).bind("originalContent.dot",function(e,t){return e.preventDefault(),e.stopPropagation(),"function"==typeof t&&t.call(a[0],s),s}).bind("destroy.dot",function(e){e.preventDefault(),e.stopPropagation(),a.unwatch().unbind_events().contents().detach().end().append(s).attr("style",a.data("dotdotdot-style")||"").removeClass("is-truncated").data("dotdotdot",!1)}),a},a.unbind_events=function(){return a.unbind(".dot"),a},a.watch=function(){if(a.unwatch(),"window"==l.watch){var t=e(window),n=t.width(),i=t.height();t.bind("resize.dot"+c.dotId,function(){n==t.width()&&i==t.height()&&l.windowResizeFix||(n=t.width(),i=t.height(),u&&clearInterval(u),u=setTimeout(function(){a.trigger("update.dot")},100))})}else d=o(a),u=setInterval(function(){if(a.is(":visible")){var e=o(a);(d.width!=e.width||d.height!=e.height)&&(a.trigger("update.dot"),d=e)}},500);return a},a.unwatch=function(){return e(window).unbind("resize.dot"+c.dotId),u&&clearInterval(u),a};var l=e.extend(!0,{},e.fn.dotdotdot.defaults,t),c={},d={},u=null,f=null;return l.lastCharacter.remove instanceof Array||(l.lastCharacter.remove=e.fn.dotdotdot.defaultArrays.lastCharacter.remove),l.lastCharacter.noEllipsis instanceof Array||(l.lastCharacter.noEllipsis=e.fn.dotdotdot.defaultArrays.lastCharacter.noEllipsis),c.afterElement=p(l.after,a),c.isTruncated=!1,c.dotId=h++,a.data("dotdotdot",!0).bind_events().trigger("update.dot"),l.watch&&a.watch(),a},e.fn.dotdotdot.defaults={ellipsis:"... ",wrap:"word",fallbackToLetter:!0,lastCharacter:{},tolerance:0,callback:null,after:null,height:null,watch:!1,windowResizeFix:!0},e.fn.dotdotdot.defaultArrays={lastCharacter:{remove:[" ","",",",";",".","!","?"],noEllipsis:[]}},e.fn.dotdotdot.debug=function(e){};var h=1,f=e.fn.html;e.fn.html=function(n){return n!=t&&!e.isFunction(n)&&this.data("dotdotdot")?this.trigger("update",[n]):f.apply(this,arguments)};var v=e.fn.text;e.fn.text=function(n){return n!=t&&!e.isFunction(n)&&this.data("dotdotdot")?(n=e("<div />").text(n).html(),this.trigger("update",[n])):v.apply(this,arguments)}}}(jQuery),jQuery(document).ready(function(e){e(".dot-ellipsis").each(function(){var t=e(this).hasClass("dot-resize-update"),n=e(this).hasClass("dot-timer-update"),i=0,a=e(this).attr("class").split(/\s+/);e.each(a,function(e,t){var n=t.match(/^dot-height-(\d+)$/);null!==n&&(i=Number(n[1]))});var r=new Object;n&&(r.watch=!0),t&&(r.watch="window"),i>0&&(r.height=i),e(this).dotdotdot(r)})}),jQuery(window).load(function(){jQuery(".dot-ellipsis.dot-load-update").trigger("update.dot")}),define("components/jquery.dotdotdot/src/jquery.dotdotdot",function(){}),define("components/requirejs-text/text!template/module/setting/delivery/template/index.tpl.html",[],function(){return'<section class="m-mail-template">\r\n  <div class="j-mail-template m-list-tpl"></div>\r\n\r\n  <div class="j-edit-template m-edit-tpl f-dn"></div>\r\n\r\n  {{#raw}}\r\n  <script id="templateSetTpl" type="text/x-handlebars-template">\r\n    <div class="title dotted">\r\n      <h4>[[i18n \'setting/lbl_template_set\']]</h4>\r\n    </div>\r\n\r\n    <div class="tpl-container">\r\n      [[#each templates]]\r\n      <div class="tpl-item">\r\n        <h4>[[name]]</h4>\r\n        <div class="tpl-opr">\r\n          <span class="del" href="#" data-action="delTpl" data-tid="[[id]]" data-name="[[name]]"><i class="iconfont icontabclose"></i></span>\r\n          <span class="edit" href="#" data-action="editTpl" data-tid="[[id]]"><i class="iconfont iconsetupcenter"></i></span>\r\n          <span class="compose" href="#" data-action="useTpl" data-tid="[[id]]"><i class="iconfont iconcreate"></i></span>\r\n        </div>\r\n      </div>\r\n      [[/each]]\r\n\r\n      <div class="tpl-item add">\r\n        <i class="iconadd iconfont" data-action="addTpl"></i>\r\n      </div>\r\n    </div>\r\n\r\n  <!--\r\n  <div class="title dotted">\r\n     <h4>[[i18n \'setting/lbl_template_manage\']]</h4>\r\n  </div>\r\n  <div class="account-tpl-container"></div>\r\n    -->\r\n  </script>\r\n\r\n  <script id="accDefaultTplCard" type="text/x-handlebars-template">\r\n    [[#each accounts]]\r\n    <div class="account-card">\r\n      <h4>[[@key]]</h4>\r\n      <div class="card-item">\r\n        <label class="item-label">[[i18n \'setting/lbl_generalDefault\']]</label>\r\n        <span class="item-text">[[#unless generalDefault]][[i18n \'setting/lbl_templateNotSet\']][[else]] [[translateTpl generalDefault ../../map ]] [[/unless]]</span>\r\n      </div>\r\n      <div class="card-item">\r\n        <label class="item-label">[[i18n \'setting/lbl_replyDefault\']]</label>\r\n        <span class="item-text">[[#unless replyDefault]][[i18n \'setting/lbl_templateNotSet\']][[else]][[translateTpl replyDefault ../../map ]][[/unless]]</span>\r\n      </div>\r\n      <div class="card-item">\r\n        <label class="item-label">[[i18n \'setting/lbl_forwardDefault\']]</label>\r\n        <span class="item-text">[[#unless forwardDefault]][[i18n \'setting/lbl_templateNotSet\']][[else]][[translateTpl forwardDefault ../../map ]][[/unless]]</span>\r\n      </div>\r\n      <div class="acc-opr">\r\n        <span class="edit" href="#" data-action="editAcc" data-index="[[@key]]"> <i class="iconfont iconcreate"></i></span>\r\n      </div>\r\n    </div>\r\n    [[/each]]\r\n  </script>\r\n\r\n  <script id="editAccTpl" type="text/x-handlebars-template">\r\n    <form action="#" class="j-account-tpl-edit m-acc-template" onsubmit="return false">\r\n      <div class="u-form-item">\r\n        <label class="u-form-label">[[i18n \'setting/lbl_account_tpl\']]</label>\r\n        <span class="u-form-text" style="font-weight: bold; color: #333">[[account]]</span>\r\n      </div>\r\n      <div class="u-form-item">\r\n        <label class="u-form-label">[[i18n \'setting/lbl_generalDefault\']]</label>\r\n        <div class="f-ib">\r\n          <select name="generalDefault" class="u-select">\r\n            [[[selectOption templates \'generalDefault\' setting]]]\r\n          </select>\r\n        </div>\r\n      </div>\r\n      <div class="u-form-item">\r\n        <label class="u-form-label">[[i18n \'setting/lbl_replyDefault\']]</label>\r\n        <select name="replyDefault" class="u-select">\r\n          [[[selectOption templates \'replyDefault\' setting]]]\r\n        </select>\r\n      </div>\r\n      <div class="u-form-item">\r\n        <label class="u-form-label">[[i18n \'setting/lbl_forwardDefault\']]</label>\r\n        <select name="forwardDefault" class="u-select">\r\n          [[[selectOption templates \'forwardDefault\' setting]]]\r\n        </select>\r\n      </div>\r\n    </form>\r\n  </script>\r\n\r\n  <script id="displayVarTpl" type="text/x-handlebars-template">\r\n    [[#if fileName]]\r\n    <div>\r\n      <p class="title">[[i18n "setting/lbl_imported_file"]]</p>\r\n      <p>\r\n        <span>[[truncate fileName]]</span>\r\n        <a href="#" class="link f-csp f-fr f-mgl" data-action="removeSource">[[i18n "common/op_delete"]]</a>\r\n        <label class="link f-csp f-fr" for="tplVariableFile">[[i18n "setting/lbl_reimport"]]</label>\r\n      </p>\r\n      <p class="title">[[i18n "setting/lbl_imported_variable"]]</p>\r\n      <div class="u-template-vars">\r\n        [[#each variables]]\r\n        <span class="tags" title=\'[[this]]\'>[[substring this 30]]</span>\r\n        [[/each]]\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n  </script>\r\n\r\n  <script id="editMailTpl" type="text/x-handlebars-template">\r\n    <div class="u-btns-top">\r\n      <button type="button" class="u-btn u-btn-primary" data-action="saveTpl">[[i18n \'setting/op_save\']]</button>\r\n      <button type="button" class="u-btn u-btn-default" data-action="resetTpl">[[i18n \'setting/op_cancel\']]</button>\r\n    </div>\r\n\r\n    <div class="tpl-wrapper">\r\n      <div class="u-form-item tpl-name">\r\n        <label class="u-form-label">[[i18n \'setting/lbl_template_name\']] :</label>\r\n        <input type="text" class="u-input j-tpl-name" value="[[name]]">\r\n        [[#if id]] <input type="hidden" value="[[id]]" name="id" class="j-tpl-id"> [[/if]]\r\n        <div class="u-form-explain f-dn"></div>\r\n      </div>\r\n      <div class="u-form-item tpl-content">\r\n        <label class="u-form-label">[[i18n \'setting/lbl_template_content\']] :</label>\r\n        <div class="tpl-compose j-tpl-compose">\r\n          <textarea id="tpl_editor" name="template" style="width:100%; height: 100%">[[content]]</textarea>\r\n        </div>\r\n      </div>\r\n      <div class="tpl-variable">\r\n        <p class="title">[[i18n "setting/lbl_mail_template_desc"]]</p>\r\n        <ul>\r\n          <li>[[[i18n "setting/lbl_imported_desc1"]]]</li>\r\n          <li>[[i18n "setting/lbl_imported_desc2"]]</li>\r\n          <li>[[i18n "setting/lbl_imported_desc3"]]</li>\r\n        </ul>\r\n        <label for="tplVariableFile" class="u-btn u-btn-primary j-import-file" >\r\n          [[i18n "setting/lbl_import_file"]]\r\n        </label>\r\n        <div class="j-file-info"></div>\r\n        <input type="file" id="tplVariableFile" name="tplFile" style="position: fixed; right: -9999px">\r\n      </div>\r\n    </div>\r\n  </script>\r\n  {{/raw}}\r\n</section>'}),define("module/setting/delivery/template/index",["require","i18n!setting,mail","jquery.dotdotdot","jquery.caret","jquery","xss","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/dialog/confirmbox","cui/ui/select/select","../../../../component/editor/editor","../../../../configurable/index","./service","i18n","../../../../util/index","module/common/globalService","module/mail/service","text!template/module/setting/delivery/template/index.tpl.html"],function(e){function t(e){var t=n();e=e||{},h.cache.setItem("compose_tpl_map",i.extend(t,e))}function n(){return h.cache.getItem("compose_tpl_map")||{}}e("i18n!setting,mail"),e("jquery.dotdotdot"),e("jquery.caret");var i=e("jquery"),a=e("xss"),r=e("cui/core/view/view"),s=e("cui/core/view/viewmanager"),o=e("cui/util/templatable/templatable"),l=e("cui/ui/dialog/confirmbox"),c=e("cui/ui/select/select"),d=e("../../../../component/editor/editor"),u=e("../../../../configurable/index"),p=e("./service"),m=e("i18n"),h=e("../../../../util/index"),f=e("module/common/globalService"),v=e("module/mail/service"),g=r.extend({Implements:o,attrs:{templates:[],loading:!0,editor:null,backToComposeTabId:null,accounts:{},viewState:{editMode:!1,item:{}},parseInfo:{variables:[],fileName:""}},templateHelpers:{selectOption:function(e,t,n){var r=i("<select>");return i.each(e,function(e,s){i("<option>").attr({value:s.id,selected:s.id==n[t]}).text(a(s.name)).appendTo(r)}),r.html()},translateTpl:function(e,t){return t[e]&&t[e].slice(0,10)||m.t("setting/lbl_templateNotSet")},substring:function(e,t){return"string"==typeof e?e.substring(0,t):""},truncate:function(e){return h.file.truncateName(e,10)}},events:{"click [data-action]":"_dispatchAction","click .tags":"_addVariableToCompose","change #tplVariableFile":"_handleUploadSourceFile","focus .j-tpl-name":function(e){i(e.target).parent().removeClass("error")}},setup:function(){var e={};this.config=u("setting.delivery"),i.each(this.config.allEmails,function(t,n){e[n.addr]={}}),this.set("accounts",e,{silent:!0}),this._initModuleEvent()},render:function(){g.superclass.render.call(this),i.notify.loading();var e=this;i.when(p.listMailTpl(),p.getMailTplMeta()).then(function(t,n){var a=e.get("accounts"),r=f.getCurrentState();if(e.set("templates",t,{silent:!0}),n.opt&&n.opt.accounts){var s=n.opt.accounts;i.each(a,function(e){i.extend(a[e],s[e])}),e.set("accounts",a)}e._generateTplCard(t),e.set("loading",!1),i.isEmptyObject(r.param)||"create"!==r.param.type||(e.set("backToComposeTabId",r.param.id),e._handleCreateTemplate())})},_initModuleEvent:function(){var e=this;this.subscribe("dispatcher","url:changed",function(t){var n=t.message.newState;i.isEmptyObject(n.param)||"create"!=n.param.type||(e.set("backToComposeTabId",n.param.id),e._handleCreateTemplate())})},_generateTplCard:function(e){var t=this.$("#templateSetTpl").html(),n=this.compile(t,{templates:e});this.$(".j-mail-template").html(n),this.$(".tpl-item h4").dotdotdot()},_generateAccDefaultCard:function(e){var t,n=this.get("templates"),a={};i.each(n,function(e,t){a[t.id]=t.name}),t=this.compile(this.$("#accDefaultTplCard").html(),{accounts:e,map:a}),this.$(".account-tpl-container").html(t)},_dispatchAction:function(e,t){var n=i(t).data();switch(n.action){case"editTpl":this._handleEditTemplate(n.tid);break;case"delTpl":this._handleDeleteTemplate(n.tid,n.name);break;case"useTpl":this._handleComposeWithTemplate(n.tid);break;case"addTpl":this._handleCreateTemplate();break;case"saveTpl":this._handleSaveTemplate();break;case"resetTpl":this._handleResetTemplate();break;case"removeSource":this._removeSourceFile();break;case"modeSwitch":this._handleEditorModeSwitch(t);break;case"editAcc":this._handleEditAccount(n.index)}},_handleEditAccount:function(e){var t,n,a=this,r=this.get("templates"),s=this.get("accounts");t=this.compile(this.$("#editAccTpl").html(),{templates:r,account:e,setting:s[e]}),n={title:m.t("setting/lbl_defaultAccountSet"),closeTpl:'<span class="iconfont icontabclose"></span>'},l.confirm(t,function(){var t=i(".j-account-tpl-edit").serializeJSON({parseNumbers:!0}),n={opt:{accounts:{}}};s[e]=t,n.opt.accounts[e]=t,p.updateMailTplMeta(n).then(function(){i.notify.success(m.t("setting/lbl_update_account_success")),a.set("accounts",s)})},i.noop(),n),i(".j-account-tpl-edit .u-select").each(function(){var e=i(this),t={width:148,classPrefix:"u-select",autoSetWidth:!0,trigger:e,disabled:e.prop("disabled")||!1,parentNode:e.parent(),zIndex:999};new c(t).render()})},_handleSaveTemplate:function(){var e=this,t=!1,n=this.get("editor"),a=this.$(".j-tpl-id").val(),r=i.trim(this.$(".j-tpl-name").val()),s=i.extend([],this.get("templates")),o=this.get("backToComposeTabId"),c={name:r,isHtml:n.designMode,content:n.designMode?n.html():n.text(),opt:{variables:this.get("parseInfo").variables,fileName:this.get("parseInfo").fileName}},d=function(e,t){var n={error:!1};return""===e?n={error:!0,msg:m.t("setting/msg_tpl_name_empty")}:e.length>20?n={error:!0,msg:m.t("setting/msg_tpl_name_overflow")}:i.each(t,function(t,i){return i.name==e&&i.id!=a?(n={error:!0,msg:m.t("setting/msg_tpl_name_exist")},!1):void 0}),n},u=d(c.name,s);return u.error?(this.$(".tpl-name").addClass("error").find(".u-form-explain").text(u.msg),!1):""===i.trim(c.content)?l.confirm(m.t("setting/msg_tpl_content_empty")):(a&&(c.id=a,t=!0),void p.upsetMailTpl([c],t).then(function(n){if(t?(i.notify.success(m.t("setting/msg_update_template_success")),i.each(s,function(e,t){return t.id==a?(s[e]=c,!1):void 0})):(i.notify.success(m.t("setting/msg_create_template_success")),c.id=n[0],s.push(c)),e.set("viewState",{editMode:!1,item:{}},{override:!0}),e.set("parseInfo",{variables:[],fileName:""},{silent:!0}),e.set("templates",s),o){var r={module:"mail.compose",param:{id:o}};f.setCurrentState(r),e.sendMessage("dispatcher","history:add",r),e.sendMessage("component.mailTemplate","switch.template",{composeId:o}),e.set("backToComposeTabId",null)}}))},_handleResetTemplate:function(){var e=this.get("backToComposeTabId");if(this.set("viewState",{editMode:!1,item:{}},{override:!0}),e){var t={module:"mail.compose",param:{id:e}};f.setCurrentState(t),this.sendMessage("dispatcher","history:add",t),this.set("backToComposeTabId",null)}},_removeSourceFile:function(){var e=this;l.confirm(m.t("setting/msg_tpl_file_remove"),function(){e.set("parseInfo",{variables:[],fileName:""},{override:!0})})},_handleCreateTemplate:function(){this.get("viewState").editMode||(this.set("viewState",{editMode:!0,item:{}}),this._initEditor())},_initEditor:function(e){function t(){var e=n.$(".tpl-content").css("height").replace("px","");n.get("editor").resize(null,e,!0)}var n=this;e="boolean"==typeof e?e:1==this.config.editMode,n.set("editor",d.create("#tpl_editor",{noDisableItems:["switch"],items:["bold","italic","underline","fontname","fontsize","forecolor","hilitecolor","|","plug-align","plug-order","plug-indent"],designMode:e,afterCreate:function(){this.toolbar.div.show(),this.statusbar.hide(),i(this.edit.doc).mousedown(function(){i(document).trigger("hide.menu")}),this.toolbar.div.click(function(){i(document).trigger("hide.menu")}),n.$(".ke-toolbar").append(i("<div />",{text:m.t(e?"compose/lb_plaintext":"mail/compose_html"),"data-action":"modeSwitch","class":"ke-mode-toggle"})),setTimeout(function(){t()},0)}})),i(window).off("resize").on("resize",t)},_addVariableToCompose:function(e){var t="{{"+i(e.target).attr("title")+"}}",n=this.get("editor"),a=this.$(".ke-edit-textarea"),r=0,s="";n.designMode?n.insertHtml("<span>"+t+"</span>"):(a.focus(),r=a.caret(),s=n.html().replace(/\r\n/g,"\n"),n.text(s.substring(0,r)+t+s.substring(r,s.length)),this.$(".ke-edit-textarea").caret(r+t.length))},_handleUploadSourceFile:function(){var e=this,t=this.$("#tplVariableFile");p.uploadTplSourceFile(t).then(function(t){var n,i,a;"S_OK"===t.code&&(n=t["var"].attachmentId,i=t["var"].fileName,p.parseTplSource(n).then(function(t){switch(t.code){case"FA_UNSUPPORTED_FILE":case"FA_BAD_CSV_FILE":case"FA_BAD_XLS_FILE":l.alert(h.i18n.t("mail/msg_parse_bad_file"));break;case"FA_XLS_SUPPORT_NOT_INSTALLED":l.alert(h.i18n.t("mail/msg_xls_support_not_installed"));break;case"S_OK":t["var"].length>0&&(a=Object.keys(t["var"][0]),e.set("parseInfo",{fileName:i.replace(/^.*[\\\/]/,""),variables:a},{override:!0}))}}))}).always(function(){t.replaceWith(t.clone(!0))})},_handleEditTemplate:function(e){var t=i.grep(this.get("templates"),function(t){return t.id==e})[0];this.set("viewState",{editMode:!0,item:t}),this._initEditor(t.isHtml)},_handleComposeWithTemplate:function(e){var n=this,a={},r=i.grep(this.get("templates"),function(t){return t.id==e})[0];v.getComposeInfo({ctype:"normal",content:r.content,isHtml:r.isHtml}).then(function(i){n.sendMessage("dispatcher","history:add",{module:"mail.compose",param:{id:i.id}}),a[i.id]=e,t(a)})},_handleDeleteTemplate:function(e,t){var n=this,a=this.get("templates");l.confirm(m.t("setting/msg_tpl_remove_confirm",{name:t}),function(){p.deleteMailTpl({id:e}).then(function(t){"S_OK"===t.code&&(i.notify.success(m.t("setting/msg_template_delete_success")),a=i.grep(a,function(t){return t.id!=e}),0===a.length?n._onChangeTemplates(a):n.set("templates",a))})},i.noop)},_handleEditorModeSwitch:function(e){var t=this.get("editor"),n=t.designMode,a=t.html();n?t.isEmpty()?(t.clickToolbar("source"),i(e).text(m.t("mail/compose_html"))):l.confirm(m.t("common/editor_html_source"),function(){t.clickToolbar("source"),a=h.html.html2text(a),t.html(a),i(e).text(m.t("mail/compose_html"))}):(t.clickToolbar("source"),a=h.html.text2html(a),t.html(a),i(e).text(m.t("compose/lb_plaintext")))},_onChangeLoading:function(e){i.notify.loading(e?"":"hide")},_onChangeTemplates:function(e){this._generateTplCard(e),this._generateAccDefaultCard(this.get("accounts")),this.sendMessage("component.mailTemplate","list:refresh",{templates:e})},_onChangeAccounts:function(e){this._generateAccDefaultCard(e)},_onChangeViewState:function(e){e.editMode?(this.$(".j-edit-template").html(this.compile(this.$("#editMailTpl").html(),e.item)),e.item.opt&&e.item.opt.variables&&this.set("parseInfo",{variables:e.item.opt.variables,fileName:e.item.opt.fileName})):(this.get("editor")&&this.get("editor").remove(),i(window).off("resize")),this.$(".j-mail-template").toggle(),this.$(".j-edit-template").toggle()},_onChangeParseInfo:function(e){this.$(".j-import-file").toggle(""==e.fileName),this.$(".j-file-info").html(this.compile(this.$("#displayVarTpl").html(),e))}});s.module({name:"setting.delivery.template",template:e("text!template/module/setting/delivery/template/index.tpl.html")},g)}),define("components/requirejs-text/text!template/module/setting/display/index.tpl.html",[],function(){return'<section class="m-sgdisplay j-display">\r\n\r\n  <nav class="nav u-tab u-tab-highlight-down">\r\n    <ul class="j-display-nav">\r\n      <li data-trigger="display.general">\r\n        <span class="bar"></span>\r\n        <a href="javascript:void(0)">{{i18n \'setting/tab_general\'}}</a>\r\n      </li>\r\n      <li data-trigger="display.list">\r\n        <span class="bar"></span>\r\n        <a href="javascript:void(0)">{{i18n \'setting/tab_list\'}}</a>\r\n      </li>\r\n    </ul>\r\n  </nav>\r\n\r\n  <div class="content j-display-content"></div>\r\n\r\n</section>\r\n\r\n\r\n\r\n\r\n';
}),define("module/setting/display/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","util/i18n","module/common/globalService","text!template/module/setting/display/index.tpl.html"],function(e){function t(e,t){return i("<div>",{"data-panel":e.sid,"class":t+" u-scroll",style:"display:none",html:""})}function n(e,t){if(0==t.indexOf("setting.display")){var n=t.substring("setting.".length);e.tabview.find(n)&&(c.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("cui/ui/tabview/tabview"),l=e("util/i18n"),c=e("module/common/globalService"),d=a.extend({Implements:s,activeTabId:"display.general",setup:function(){var e,t=this;t.state=c.getCurrentState(),e=t.state.module.split("."),t.activeTabId=e[2]?"display."+e[2]:t.activeTabId,t.state.module="setting."+t.activeTabId,c.setCurrentState(t.state),t._setHistory(t.state)},render:function(){var e=this;d.superclass.render.call(e),e._initTabView(),e._initModuleEvent()},_initTabView:function(){var e=this,n=[{id:"display.general",title:l.t("setting.tab_general"),module:r.module("setting.display.general")},{id:"display.list",title:l.t("setting.tab_list"),module:r.module("setting.display.list")}];e.tabview=new o({element:"section.j-display",classPrefix:"j-display",activeTabId:e.activeTabId,activeTriggerClass:"z-current",onlyRenderActive:!0,generatePanelMarkup:t,tabs:n}),e.tabview.render(),e.tabview.on("render",function(t){e.activeTabId=t,e._setHistory({module:"setting."+t})}),e.tabview.on("refresh",function(t){e.activeTabId=t,e.sendMessage("dispatcher","view:refresh",{module:"setting."+t,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(t){var i=t.message.newState;n(e,i.module)})},_setHistory:function(e){var t=this,n=i.extend(!0,{},e);0==n.module.indexOf("setting.display.")&&(n.param={},t.sendMessage("dispatcher","view:render",n))}});r.module({name:"setting.display",template:e("text!template/module/setting/display/index.tpl.html")},d)}),define("components/requirejs-text/text!template/module/setting/display/general/index.tpl.html",[],function(){return'<section class="m-general">\r\n    <div class="operation">\r\n      <div class="u-btns-top">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="save">{{i18n "setting/op_save"}}</button>\r\n        <button type="button" class="u-btn u-btn-default" data-action="reset">{{i18n "setting/op_cancel"}}</button>\r\n      </div>\r\n    </div>\r\n  <form action="" class="j-general-form">\r\n\r\n  </form>\r\n\r\n  {{#raw}}\r\n  <script id="generalSetTpl" type="text/x-handlebars-template">\r\n\r\n    [[#if firstpage]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[firstpage.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="firstpage"  value="0" [[formattedChosen firstpage 0]]/>\r\n            [[translateI18N \'firstpage\' 0]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="firstpage"  value="1" [[formattedChosen firstpage 1]]/>\r\n            [[translateI18N \'firstpage\' 1]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">{{i18n "setting/face"}}</label>\r\n      </div>\r\n\r\n      <div class="u-form-value j-face-switch">\r\n        [[#each faces]]\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="other[face]" id="face_[[@key]]" value="[[@key]]" [[#compare @key "==" ../currentFace]] checked [[/compare]]/>&nbsp;[[this.name]]\r\n          </label>\r\n        </div>\r\n        [[/each]]\r\n      </div>\r\n    </div>\r\n\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">{{i18n "setting/language"}}</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <select name="other[locale]" class="j-locale-switch">\r\n          [[#each locales]]\r\n          <option value="[[@key]]" [[#compare @key "==" ../currentLocale]] selected [[/compare]]>[[this]]</option>\r\n          [[/each]]\r\n        </select>\r\n      </div>\r\n    </div>\r\n\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">{{i18n \'setting/timezone_text\'}}</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          [[[generateTimezones time_zone.value]]]\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n  </script>\r\n\r\n  {{/raw}}\r\n\r\n</section>'}),define("module/setting/display/general/index",["require","util/i18n!setting,pref/preference,pref/personal","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/dialog/confirmbox","module/common/globalService","./../../service","configurable/index","i18n","text!template/module/setting/display/general/index.tpl.html"],function(e){e("util/i18n!setting,pref/preference,pref/personal");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("cui/ui/dialog/confirmbox"),s=e("module/common/globalService"),o=e("./../../service"),l=e("configurable/index"),c=e("i18n"),d={},u=n.extend({Implements:a,templateHelpers:{translateI18N:function(e,t){t=null==t?d.defaultValues[e]:t;var n=d.recommendValues[e]==t?"("+c.t("pref/preference/recommendation")+")":"";return"maxlist"==e||"display_list"==e||"replyf"==e?c.t("setting."+e+"_v_"+t)+n:"addo"==e?c.t("setting."+e+"_v"):"save_sent"==e||"smtp_save_sent"==e||"aftersend_saveaddr"==e||"displaysender"==e||"when_sendmail"==e?c.t("setting."+e+"_text"):c.t("pref/preference/"+e+"_v_"+t)+n},formattedChosen:function(e,t){var n=e.value,i="maxlist"==e.key||"replyf"==e.key;return null!=n?n==t?i?"selected":"checked":"":d.defaultValues[e.key]==t?i?"selected":"checked":""},generateTimezones:function(e){var n=t("<select/>",{name:"time_zone:string"});return t.each(s.getConfig("setting.timezonevalues"),function(i,a){n.append(t("<option/>",{value:i,selected:i==e,text:a}))}),n.prop("outerHTML")}},events:{"click [data-action]":"_dispatchAction"},setup:function(){this.config=l("setting.display",this),t.when(s.getReservedUserAttrValues(),s.getReservedUserAttrRecommendValues(),s.getReservedUserAttrKeys()).then(function(e,t,n){d.defaultValues=e,d.recommendValues=t,d.allKeys=n})},render:function(){u.superclass.render.call(this),this._initView()},_initView:function(){var e,n,i,a,r=this;t.when(o.getFacesetting(),o.getAttrs("time_zone,firstpage")).then(function(s,o){n=r.config.face||"XT5",e=s.faces[n],e&&(i=e.skins,a=e.locales),r.facesModel={faces:s.faces,skins:i,locales:a,currentFace:n,currentLocale:r.config.locale||"zh_CN",currentSkin:r.config.skin||"blue"},r.preferModel={};for(var l in o)if(o.hasOwnProperty(l)){var d={label:c.t("pref/preference/"+l+"_text"),key:l,value:o[l]};"time_zone"===l&&(d.value=r.config.timezoneId),r.preferModel[l]=d}r.$(".j-general-form").html(r.compile(t("#generalSetTpl").html(),t.extend(r.preferModel,r.facesModel))),r.element.customRadioCheckbox()})},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"save":i._changeFaceSettings();break;case"reset":i._initView()}},_changeFaceSettings:function(){var e=this,n=this.$(".j-general-form").serializeJSON({parseNumbers:!0}),i=n.other;delete n.other,t.when(s.updateUser(n,!0),o.changeFacesetting(i)).then(function(i,a){t.notify(c.t("setting/msg_prefUpdateSuccess")),t.each(n,function(t,n){e.preferModel[t].value=n}),a&&a.changed&&r.alert(c.t("setting/msg_prefOtherUpdateSuccess"),function(){location.href=a.mainURL})})}});i.module({name:"setting.display.general",template:e("text!template/module/setting/display/general/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/display/list/index.tpl.html",[],function(){return'<section class="m-list-display">\r\n  <div class="operation">\r\n    <div class="u-btns-top">\r\n      <button type="button" class="u-btn u-btn-primary" data-action="save">{{i18n "setting/op_save"}}</button>\r\n      <button type="button" class="u-btn u-btn-default" data-action="reset">{{i18n "setting/op_cancel"}}</button>\r\n    </div>\r\n  </div>\r\n  <form action="" class="j-list-form">\r\n\r\n  </form>\r\n\r\n  {{#raw}}\r\n  <script id="listSetTpl" type="text/x-handlebars-template">\r\n\r\n    [[#if maxlist]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[i18n "setting/maxlist_text"]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <select name="maxlist">\r\n          <option value="10"  [[formattedChosen maxlist 10]]> [[translateI18N \'maxlist\' 10]] </option>\r\n          <option value="20"  [[formattedChosen maxlist 20]]> [[translateI18N \'maxlist\' 20]] </option>\r\n          <option value="50"  [[formattedChosen maxlist 50]]> [[translateI18N \'maxlist\' 50]] </option>\r\n          <option value="100" [[formattedChosen maxlist 100]]> [[translateI18N \'maxlist\' 100]] </option>\r\n        </select>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    <!-- 0= 1= 2=-->\r\n    [[#if preview_layout]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[i18n "setting/preview_layout"]]</label>\r\n      </div>\r\n      <div class="u-form-value preview_layout">\r\n        <div class="m-preview-type icon_layout_normal [[formattedChosen preview_layout 0]]" data-action="change">\r\n          <span>[[i18n \'setting/preview_layout_0\']]</span>\r\n          <input type="radio" name="preview_layout" class="radio" value="0" [[formattedChosen preview_layout 0]] >\r\n          <i class="iconfont iconchoose f-dn"></i>\r\n        </div>\r\n        [[#if enableFastPreviewLayout]]\r\n        <div class="m-preview-type icon_layout_bottom [[formattedChosen preview_layout 1]]" data-action="change">\r\n          <span>[[i18n \'setting/preview_layout_1\']]</span>\r\n          <input type="radio" name="preview_layout" class="radio" value="1" [[formattedChosen preview_layout 1]] >\r\n          <i class="iconfont iconchoose f-dn"></i>\r\n        </div>\r\n        [[/if]]\r\n        <div class="m-preview-type icon_layout_right [[formattedChosen preview_layout 2]]" data-action="change">\r\n          <span>[[i18n \'setting/preview_layout_2\']]</span>\r\n          <input type="radio" name="preview_layout" class="radio" value="2" [[formattedChosen preview_layout 2]] >\r\n          <i class="iconfont iconchoose f-dn"></i>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    <!--  0= /1= -->\r\n    [[#if display_list]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[i18n "setting/display_list"]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n          <span class="switch-box">\r\n              <input type="checkbox" name="display_list" role="switchBtn" class="checkbox j-toggle" value="1" data-unchecked-value="0" [[formattedChosen display_list 1]] >\r\n         </span>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n     <!---->\r\n    [[#if list_brief_text.enable]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[i18n "setting/list_brief_text"]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n          <span class="switch-box">\r\n              <input type="checkbox" name="list_brief_text" role="switchBtn" class="checkbox j-toggle" value="1" data-unchecked-value="0" [[formattedChosen list_brief_text 1]] >\r\n         </span>\r\n         <span class="recommend-text">[[i18n "setting/recommend_open"]]</span>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    <!---->\r\n    [[#if display_size]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[display_size.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n          <span class="switch-box">\r\n              <input type="checkbox" name="display_size" role="switchBtn" class="checkbox j-toggle" value="1" data-unchecked-value="0" [[formattedChosen display_size 1]] >\r\n         </span>\r\n         <span class="recommend-text">[[i18n "setting/recommend_close"]]</span>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n     <!---->\r\n    [[#if list_style]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[list_style.label]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="list_style"  value="1" [[formattedChosen list_style 1]]/>\r\n            [[translateI18N \'list_style\' 1]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="list_style"  value="0" [[formattedChosen list_style 0]]/>\r\n            [[translateI18N \'list_style\' 0]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#if clock_system]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[i18n "setting/clock_system"]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="clock_system"  value="1" [[formattedChosen clock_system 1]]/>\r\n            [[translateI18N \'clock_system\' 1]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="clock_system"  value="0" [[formattedChosen clock_system 0]]/>\r\n            [[translateI18N \'clock_system\' 0]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n\r\n    [[#if search_ordering_rule]]\r\n    <div class="u-form-item">\r\n      <div class="f-fl">\r\n        <label class="u-form-label">[[i18n "setting/search_ordering_rule"]]</label>\r\n      </div>\r\n      <div class="u-form-value">\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="search_ordering_rule"  value="0" [[formattedChosen search_ordering_rule 0]]/>\r\n            [[translateI18N \'search_ordering_rule\' 0]]\r\n          </label>\r\n        </div>\r\n        <div>\r\n          <label>\r\n            <input type="radio" name="search_ordering_rule"  value="1" [[formattedChosen search_ordering_rule 1]]/>\r\n            [[translateI18N \'search_ordering_rule\' 1]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    [[/if]]\r\n  </script>\r\n\r\n  {{/raw}}\r\n\r\n</section>'}),define("module/setting/display/list/index",["require","util/i18n!setting,pref/preference,pref/personal","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/dialog/confirmbox","module/common/globalService","./../../service","configurable/index","i18n","text!template/module/setting/display/list/index.tpl.html"],function(e){e("util/i18n!setting,pref/preference,pref/personal");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("cui/ui/dialog/confirmbox"),s=e("module/common/globalService"),o=e("./../../service"),l=e("configurable/index"),c=e("i18n"),d={},u=n.extend({Implements:a,templateHelpers:{translateI18N:function(e,t){t=null==t?d.defaultValues[e]:t;var n=d.recommendValues[e]==t?"("+c.t("pref/preference/recommendation")+")":"";return"maxlist"==e||"display_list"==e||"replyf"==e?c.t("setting."+e+"_v_"+t)+n:"addo"==e?c.t("setting."+e+"_v"):"save_sent"==e||"smtp_save_sent"==e||"aftersend_saveaddr"==e||"displaysender"==e||"when_sendmail"==e?c.t("setting."+e+"_text"):c.t("pref/preference/"+e+"_v_"+t)+n},formattedChosen:function(e,t){var n=e.value,i="maxlist"==e.key||"replyf"==e.key;return null!=n?n==t?i?"selected":"checked":"":d.defaultValues[e.key]==t?i?"selected":"checked":""}},events:{"click [data-action]":"_dispatchAction","change.crc .j-toggle":"_handleToggle"},setup:function(){this.config=l("setting.display",this),t.when(s.getReservedUserAttrValues(),s.getReservedUserAttrRecommendValues(),s.getReservedUserAttrKeys()).then(function(e,t,n){d.defaultValues=e,d.recommendValues=t,d.allKeys=n}),this._initModuleEvent()},_initModuleEvent:function(){var e=this;e.onMessage("view:refresh",function(){e._initView()},null)},render:function(){u.superclass.render.call(this),this._initView()},_initView:function(){var e=this;o.getAttrs(d.allKeys).then(function(n){e.preferModel={enableFastPreviewLayout:e.config.enableFastPreviewLayout};for(var i in n)if(n.hasOwnProperty(i)){var a={label:c.t("pref/preference/"+i+"_text"),key:i,value:n[i]};"list_brief_text"===i&&(a.enable=e.config.enableListBriefText),e.preferModel[i]=a}e.$(".j-list-form").html(e.compile(t("#listSetTpl").html(),e.preferModel)),e.element.customRadioCheckbox()})},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"save":i._changeListSettings();break;case"reset":i._initView();break;case"change":i._changePreviewLayout(n)}},_handleToggle:function(e){t(e.target).prop("checked",t(e.target).siblings(".u-switch-onoff").hasClass("checkbox-checked"))},_changePreviewLayout:function(e){this.$(".m-preview-type").removeClass("checked"),t(e).addClass("checked").find("[name=preview_layout]").prop("checked",!0)},_changeListSettings:function(){var e=this,n=this.$(".j-list-form").serializeJSON({parseNumbers:!0});t.when(s.updateUser(n,!0)).then(function(i,a){2==e.preferModel.preview_layout.value?e.sendMessage("mail.previewlayout","view:change",null):e.sendMessage("mail.list","view:refresh",{resetToolbar:!0}),t.each(n,function(t,n){e.preferModel[t].value=n}),a&&a.changed&&r.alert(c.t("setting/msg_prefOtherUpdateSuccess"),function(){location.href=a.mainURL}),t.notify(c.t("setting/msg_prefUpdateSuccess"))})}});i.module({name:"setting.display.list",template:e("text!template/module/setting/display/list/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/filter/index.tpl.html",[],function(){return'<section class="m-filter j-filter">\n  <nav class="nav u-tab u-tab-highlight-down">\n    <ul class="j-filter-nav">\n      <li data-trigger="filter.letter">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">{{i18n "pref/filter"}}</a>\n      </li>\n      <li data-trigger="filter.vip">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">{{i18n "setting/tab_vip"}}</a>\n      </li>\n    </ul>\n  </nav>\n\n  <div class="j-filter-content content"></div>\n</section>\n'}),define("module/setting/filter/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","../../../util/i18n","configurable/index","module/common/globalService","text!template/module/setting/filter/index.tpl.html"],function(e){function t(e,t){return i("<div>",{"data-panel":e.sid,"class":t+"  secpanel",style:"display:none",html:""})}function n(e,t){if(0==t.indexOf("setting.filter")){var n=t.substring("setting.".length);e.tabview.find(n)&&(d.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("cui/ui/tabview/tabview"),l=e("../../../util/i18n"),c=e("configurable/index"),d=e("module/common/globalService"),u=a.extend({Implements:s,activeTabId:"filter.letter",setup:function(){this.config=c("setting.filter",this),this.state=d.getCurrentState();var e=this.state.module.split(".");this.activeTabId=e[2]?"filter."+e[2]:this.activeTabId,this.state.module="setting."+this.activeTabId,d.setCurrentState(this.state),this._setHistory(this.state)},render:function(){u.superclass.render.call(this),i.notify.loading(),this._initTabView(),this._initModuleEvent()},_initTabView:function(){var e=this,n=[{id:"filter.letter",title:l.t("pref.filter"),module:r.module("setting.filter.letter")}];e.config.enablevipmessage?n.push({id:"filter.vip",title:l.t("pref.vip"),module:r.module("setting.filter.vip")}):e.$(".j-filter-nav li:last-child").remove(),e.tabview=new o({element:"section.j-filter",classPrefix:"j-filter",activeTabId:e.activeTabId,activeTriggerClass:"z-current",onlyRenderActive:!0,generatePanelMarkup:t,tabs:n}),e.tabview.render(),e.tabview.on("render",function(t){e.activeTabId=t,e._setHistory({module:"setting."+t})}),e.tabview.on("refresh",function(t){e.activeTabId=t,e.sendMessage("dispatcher","view:refresh",{module:"setting."+t,param:{}}),e.sendMessage("setting."+t,"view:refresh")}),i.notify.loading("hide")},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(t){var i=t.message.newState;n(e,i.module),("setting.filter.vip"==i.module||"setting.filter.letter"==i.module)&&e.sendMessage(i.module,"methodInvocation")}),e.subscribe("dispatcher","view:changed",function(t){var n=t.message.newState;("setting.filter.vip"==n.module||"setting.filter.letter"==n.module)&&e.sendMessage(n.module,"view:refresh")})},_setHistory:function(e){var t=this,n=i.extend(!0,{},e);0==n.module.indexOf("setting.filter.")&&(n.param={},t.sendMessage("dispatcher","view:render",n))}});r.module({name:"setting.filter",template:e("text!template/module/setting/filter/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/filter/letter/index.tpl.html",[],function(){return'<!--  -->\r\n<section class="m-letterFilter grid-row">\r\n  <div class="main-wrapper">\r\n    <div class="content-wrapper">\r\n      <!--    -->\r\n      <div class="grid-col12 mainContainer" id="mainContainer"></div>\r\n    </div>\r\n\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask" />\r\n    <![endif]-->\r\n\r\n    <!--   -->\r\n    <div class="panel u-scroll" id="editRuleTplContainer">\r\n        <div class="panel-content-wrapper edit"></div>\r\n        <div class="panel-content-wrapper filter"></div>\r\n    </div>\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <script type="text/x-handlebar-template" id="rulesTpl">\r\n    <div class="grid-row lfheader">\r\n      <div class="grid-col12">\r\n        <div class="u-btns">\r\n          <button type="button" class="u-btn u-btn-primary" data-action="createRule">[[i18n "pref/junkfilter/addfilter"]]</button>\r\n        </div>\r\n        <span class="tip f-ml20">\r\n          <label>[[statistics]]</label>\r\n          <a href="javascript:void(0)" class="[[#unless canRemoveAll]]disabled[[/unless]]" data-action="removeAllRules">[[i18n "setting/op_removeAll"]]</a>\r\n        </span>\r\n      </div>\r\n    </div>\r\n    <div class="grid-row subContainer u-scroll" id="rulesContainer">\r\n      [[#each mailRules]]\r\n      <div class="grid-row item [[#if disabled]]item-disabled[[/if]]">\r\n        <div class="ruleStatus" data-action="[[#compare name \'==\' \'##VIP\']][[^]]switchStatus[[/compare]]" data-ruleid="[[id]]">\r\n          [[#compare name \'==\' \'##VIP\']]\r\n          &nbsp;\r\n          [[^]]\r\n          <input type="checkbox" role="switchBtn" class="checkbox" [[#unless disabled]]checked[[/unless]] />\r\n          [[/compare]]\r\n        </div>\r\n        <div class="ruleDetail">\r\n          <div>\r\n            <div class="grid-row ruleName">\r\n              <div class="grid-col12">\r\n                <h4>[[#compare name \'==\' \'##VIP\']][[i18n "main/vip_message"]][[^]][[[name]]][[/compare]]</h4>\r\n              </div>\r\n            </div>\r\n            <div class="grid-row ruleContent">\r\n              <div>\r\n                <span>[[i18n "pref/junkfilter/condtion_if"]]</span>\r\n              </div>\r\n              <div class="ruleCondition">\r\n                [[#each condictions]]\r\n                <div>\r\n                  [[#if @first]]\r\n                  [[^]]\r\n                  <span>\r\n                      [[#compare ../../name \'==\' \'##VIP\']]\r\n                          [[i18n "pref/junkfilter/cond_or"]]\r\n                      [[^]]\r\n                          [[#compare ../../../operator \'==\' \'or\']]\r\n                              [[i18n "pref/junkfilter/cond_or"]]\r\n                          [[^]]\r\n                              [[i18n "pref/junkfilter/cond_and"]]\r\n                          [[/compare]]\r\n                      [[/compare]]\r\n                  </span>\r\n                  [[/if]]\r\n                  <span class="field">[[field_zh]]</span>\r\n                  <span class="operator">[[operator_zh]]</span>\r\n                    <span class="highlight">\r\n                        [[#compare ../name \'==\' \'##VIP\']]\r\n                            [[#compare operand \'==\' \'VIP\']]\r\n                                [[i18n "main/vip_contact"]]\r\n                            [[^]]\r\n                                [[operand]]\r\n                            [[/compare]]\r\n                        [[^]]\r\n                            [[operand]]\r\n                        [[/compare]]\r\n                    </span>\r\n                  [[#compare field \'==\' \'size\']]\r\n                  <span class="additions">KB</span>\r\n                  [[^]]\r\n                  <span class="additions">[[#if ignoreCase]] [[i18n "pref/junkfilter/nocase"]] [[^]] [[i18n "pref/junkfilter/case"]] [[/if]]</span>\r\n                  [[/compare]]\r\n                  [[#if forAddress]]<span class="additions">[[i18n "pref/junkfilter/forAddress"]]</span>[[/if]]\r\n                </div>\r\n                [[/each]]\r\n              </div>\r\n            </div>\r\n            <div class="grid-row ruleContent">\r\n              <div>\r\n                <span>[[i18n "pref/junkfilter/execute"]]</span>\r\n              </div>\r\n              <div class="ruleAction">\r\n                [[#each actions]]\r\n                <div>\r\n                  [[#unless disabled]]\r\n                    [[#unless @first]]<span>[[i18n "pref/junkfilter/cond_and"]]</span>[[/unless]]\r\n                    <span class="type">[[type_zh]]</span>\r\n                    [[#if target]]<span class="highlight">[[target]]</span>[[/if]]\r\n                    [[#if content]]<span class="highlight">[[content]]</span>[[/if]]\r\n                    [[#if keepLocal]]<span class="additions">[[i18n "pref/junkfilter/ac_keeplocal"]]</span>[[/if]]\r\n                    [[#compare label0 "!=" undefined]]<span class="flagged label0-[[label0]] ">[[i18n "join:mbox/flagged_option_color" 0=label0]]</span>[[/compare]]\r\n                    [[#compare ../../name \'==\' \'##VIP\']]<span class="highlight">[[i18n "pref/junkfilter/vip_message"]]</span>[[/compare]]\r\n                  [[/unless]]\r\n                </div>\r\n                [[/each]]\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class="ruleOp">\r\n          [[#if @first]]\r\n          [[^]]\r\n          <a href="javascript:void(0)" data-action="up" data-ruleid="[[id]]" title=\'[[i18n "pref/junkfilter/moveup"]]\'><i class="iconfont iconmoveup"></i></a>\r\n          [[/if]]\r\n          [[#if @last]]\r\n          [[^]]\r\n          <a href="javascript:void(0)" data-action="down" data-ruleid="[[id]]" title=\'[[i18n "pref/junkfilter/movedown"]]\'><i class="iconfont iconmovedown"></i></a>\r\n          [[/if]]\r\n          [[#compare name \'!=\' \'##VIP\']]\r\n          <a href="javascript:void(0)" data-action="deleteRule" data-ruleid="[[id]]" title=\'[[i18n "pref/junkfilter/deletefilter"]]\'>[[i18n "pref/junkfilter/deletefilter"]]</a>\r\n          [[/compare]]\r\n          <a href="javascript:void(0)" data-action="editRule" data-ruleid="[[id]]" data-rulename="[[name]]" title=\'[[i18n "pref/junkfilter/updatefilter"]]\'>[[i18n "pref/junkfilter/updatefilter"]]</a>\r\n        </div>\r\n      </div>\r\n      [[/each]]\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="editRuleTpl">\r\n          <div class="panel-item panel-item1 panel-header">\r\n            <div class="btn-group">\r\n              <button data-action="saveRule" class="u-btn u-btn-primary" type="button">[[i18n "pref/confirm"]]</button>\r\n              <button data-action="closePanel" class="u-btn u-btn-default" type="button">[[i18n "pref/cancel"]]</button>\r\n            </div>\r\n          </div>\r\n          <form name="ruleForm" action="#" class="panel-body">\r\n            <input type="hidden" name="isCreate" value="[[#if isCreate]]true[[^]]false[[/if]]"/>\r\n            <input type="hidden" name="disabled" value="[[#if disabled]][[disabled]][[^]]false[[/if]]"/>\r\n            [[#if isCreate]][[^]]\r\n            <input type="hidden" name="id" value="[[id]]"/>\r\n            [[/if]]\r\n            <div class="panel-item panel-item2">\r\n                <h4>[[i18n "pref/junkfilter/setfilter"]]</h4>\r\n            </div>\r\n            <div class="panel-item">\r\n                <div class="conditions-block">\r\n                    <div class="label">\r\n                        <span>[[i18n "setting/lbl_filtername"]]</span>\r\n                    </div>\r\n                    <div class="conditions conditions-bb">\r\n                        <div class="condition">\r\n                            <input type="text" class="u-input u-input-1" value="[[name]]" name="name" autocomplete="off"/>\r\n                            [[#unless isCreate]]<input type="hidden" value="[[name]]" name="oname"/>[[/unless]]\r\n                            [[#if isCreate]]<label class="require">[[i18n "pref/junkfilter/name_new_need"]]</label>[[/if]]\r\n                            <label class="tip-error f-dn" id="nameErrMsg"></label>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class="conditions-block">\r\n                    <div class="label">\r\n                        <span>[[i18n "setting/lbl_condition"]]</span>\r\n                    </div>\r\n                    <div class="conditions conditions-bb">\r\n                        <div class="condition">\r\n                            <select name="operator" class="u-select" data-class="u-select-fw1">\r\n                                [[#select operator]]\r\n                                <option value="and">[[i18n "setting/lbl_when_all_conditions_match"]]</option>\r\n                                <option value="or">[[i18n "setting/lbl_when_one_of_conditions_match"]]</option>\r\n                                [[/select]]\r\n                            </select>\r\n                        </div>\r\n\r\n                        <div class="condition">\r\n                            <input type="hidden" name="conditions[from][ignoreCase]" value="true"> <!--  -->\r\n                            <input type="hidden" name="conditions[from][forAddress]" value="true">\r\n                            <input type="hidden" name="conditions[from][listOfValues]" value="true">\r\n                            <div class="element label label-1">\r\n                                <input id="from" type="checkbox" name="conditions[from][isChecked]" value="true" [[#if conditions2.from]]checked[[/if]]>\r\n                                <label for="from">[[i18n "pref/junkfilter/comefrom"]]</label>\r\n                            </div>\r\n                            <div class="element">\r\n                                <select name="conditions[from][operator]" class="u-select" data-class="u-select-fw2">\r\n                                    [[#select conditions2.from.operator]]\r\n                                    <option value="contains">[[i18n "pref/junkfilter/op_text_contains"]]</option>\r\n                                    <option value="excludes">[[i18n "pref/junkfilter/op_text_excludes"]]</option>\r\n                                    <option value="=">[[i18n "setting/lbl_equal"]]</option>\r\n                                    <option value="!=">[[i18n "setting/lbl_unequal"]]</option>\r\n                                    <option value="startsWith">[[i18n "pref/junkfilter/op_text_startsWith"]]</option>\r\n                                    <option value="endsWith">[[i18n "pref/junkfilter/op_text_endsWith"]]</option>\r\n                                    [[/select]]\r\n                                </select>\r\n                            </div>\r\n                            <div class="element">\r\n                                <input type="text" class="u-input u-input-1" name="conditions[from][operand]" placeholder=\'[[i18n "setting/lbl_sampleEmail"]]\' value="[[conditions2.from.operand]]" autocomplete="off"/>\r\n                                <p class="tip">[[i18n "pref/junkfilter/tips"]]</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class="condition">\r\n                            <input type="hidden" name="conditions[recipients][ignoreCase]" value="true"> <!--  -->\r\n                            <input type="hidden" name="conditions[recipients][listOfValues]" value="true">\r\n                            <div class="element label label-1">\r\n                                <input id="recipients" type="checkbox" name="conditions[recipients][isChecked]" value="true" [[#if conditions2.recipients]]checked[[/if]]>\r\n                                <label for="recipients">[[i18n "pref/junkfilter/sendto"]]</label>\r\n                            </div>\r\n                            <div class="element">\r\n                                <select name="conditions[recipients][operator]" class="u-select" data-class="u-select-fw2">\r\n                                    [[#select conditions2.recipients.operator]]\r\n                                    <option value="contains">[[i18n "pref/junkfilter/op_text_contains"]]</option>\r\n                                    <option value="excludes">[[i18n "pref/junkfilter/op_text_excludes"]]</option>\r\n                                    <option value="=">[[i18n "setting/lbl_equal"]]</option>\r\n                                    <option value="!=">[[i18n "setting/lbl_unequal"]]</option>\r\n                                    <option value="startsWith">[[i18n "pref/junkfilter/op_text_startsWith"]]</option>\r\n                                    <option value="endsWith">[[i18n "pref/junkfilter/op_text_endsWith"]]</option>\r\n                                    [[/select]]\r\n                                </select>\r\n                            </div>\r\n                            <div class="element">\r\n                                <input type="text" class="u-input u-input-1" name="conditions[recipients][operand]" placeholder=\'[[i18n "setting/lbl_sampleEmail"]]\' value="[[conditions2.recipients.operand]]" autocomplete="off"/>\r\n                                <p class="tip">[[i18n "pref/junkfilter/tips"]]</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class="condition">\r\n                            <input type="hidden" name="conditions[subject][ignoreCase]" value="true"> <!--  -->\r\n                            <input type="hidden" name="conditions[subject][listOfValues]" value="true">\r\n                            <div class="element label label-1">\r\n                                <input id="subject" type="checkbox" name="conditions[subject][isChecked]" value="true" [[#if conditions2.subject]]checked[[/if]]>\r\n                                <label for="subject">[[i18n "pref/junkfilter/mailtitle"]]</label>\r\n                            </div>\r\n                            <div class="element">\r\n                                <select name="conditions[subject][operator]" class="u-select" data-class="u-select-fw2">\r\n                                    [[#select conditions2.subject.operator]]\r\n                                    <option value="contains">[[i18n "pref/junkfilter/op_text_contains"]]</option>\r\n                                    <option value="excludes">[[i18n "pref/junkfilter/op_text_excludes"]]</option>\r\n                                    <option value="=">[[i18n "setting/lbl_equal"]]</option>\r\n                                    <option value="!=">[[i18n "setting/lbl_unequal"]]</option>\r\n                                    <option value="startsWith">[[i18n "pref/junkfilter/op_text_startsWith"]]</option>\r\n                                    <option value="endsWith">[[i18n "pref/junkfilter/op_text_endsWith"]]</option>\r\n                                    [[/select]]\r\n                                </select>\r\n                            </div>\r\n                            <div class="element">\r\n                                <input type="text" name="conditions[subject][operand]" class="u-input u-input-1" placeholder=\'[[i18n "setting/lbl_sampleKeyword"]]\' value="[[conditions2.subject.operand]]" autocomplete="off"/>\r\n                                <p class="tip">[[i18n "setting/lbl_keywordFormatTip"]]</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class="condition">\r\n                            <div class="element label label-1">\r\n                                <input id="size" type="checkbox" name="conditions[size][isChecked]" value="true" [[#if conditions2.size]]checked[[/if]]>\r\n                                <label for="size">[[i18n "pref/junkfilter/cond_size"]]</label>\r\n                            </div>\r\n                            <div class="element">\r\n                                <select name="conditions[size][operator]" class="u-select" data-class="u-select-fw2">\r\n                                    [[#select conditions2.size.operator]]\r\n                                    <option value="<">[[i18n "pref/junkfilter/op_size_lt"]]</option>\r\n                                    <option value=">">[[i18n "pref/junkfilter/op_size_gt"]]</option>\r\n                                    [[/select]]\r\n                                </select>\r\n                            </div>\r\n                            <div class="element">\r\n                                <input type="text" name="conditions[size][operand]" class="u-input u-input-1" placeholder=\'[[i18n "setting/lbl_sampleSize"]]\' value="[[conditions2.size.operand]]" autocomplete="off"/>\r\n                            </div>\r\n                            <div class="element">\r\n                                <select name="conditions[size][unit]" class="u-select" data-class="u-select-fw2">\r\n                                    [[#select conditions2.size.unit]]\r\n                                    <option value="0">KB</option>\r\n                                    <option value="1">MB</option>\r\n                                    <option value="2">GB</option>\r\n                                    <option value="3">TB</option>\r\n                                    [[/select]]\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class="conditions-block">\r\n                    <div class="label">\r\n                        <span>[[i18n "setting/lbl_operation"]]</span>\r\n                    </div>\r\n                    <div class="conditions conditions-bb">\r\n                        <div class="condition">\r\n                            <select name="actions[reject]" class="u-select" id="executeAction" data-class="u-select-fw1">\r\n                                <option value="false">[[i18n "setting/lbl_rule"]]</option>\r\n                                <option value="true" [[#if actions2.reject]]selected[[/if]]>[[i18n "setting/lbl_reject"]]</option>\r\n                            </select>\r\n                        </div>\r\n\r\n                        <div class="condition">\r\n                            <div class="element label label-1">\r\n                                <input id="move" type="checkbox" name="actions[move][isChecked]" value="true" [[#if actions2.move]]checked[[/if]] [[#if actions2.reject]]disabled[[/if]]/>\r\n                                <label for="move">[[i18n "pref/junkfilter/transfolder"]]</label>\r\n                            </div>\r\n                            <div class="element">\r\n                                <select name="actions[move][target]" class="u-select j-action-move" data-class="u-select-fw1" [[#if actions2.reject]]disabled[[/if]]>\r\n                                [[[folderOption folders actions2.move.target false]]]\r\n                                </select>\r\n                                <button type="button" data-action="createFolder" class="u-btn u-btn-default u-btn-create">{{i18n "main/bt_createfolder"}}</button>\r\n                            </div>\r\n                        </div>\r\n                        [[#if isEnableMailFlag]]\r\n                        <div class="condition">\r\n                            <div class="element label label-1">\r\n                                <input id="flags" type="checkbox" name="actions[flags][isChecked]" value="true" [[#if actions2.flags]]checked[[/if]] [[#if actions2.reject]]disabled[[/if]] />\r\n                                <label for="flags">[[i18n "pref/junkfilter/filter_action_flagged"]]</label>\r\n                            </div>\r\n                            <div class="element">\r\n                                <select name="actions[flags][value][label0]" class="u-select j-action-flagged" data-class="u-select-fw1" id="flaggedContainer" [[#if actions2.reject]]disabled[[/if]]>\r\n                                [[[labelOption folderColorCount actions2.flags.value.label0]]]\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n                        [[/if]]\r\n\r\n                        [[#if isEnableForward]]\r\n                        <div class="condition">\r\n                            <input type="hidden" name="actions[forward][keepLocal]" value="true" /> <!--  -->\r\n                            <div class="element label label-1">\r\n                                <input id="forward" type="checkbox" name="actions[forward][isChecked]" value="true" [[#if actions2.forward]]checked[[/if]] [[#if actions2.reject]]disabled[[/if]] />\r\n                                <label for="forward">[[i18n "pref/junkfilter/transmit"]]</label>\r\n                            </div>\r\n                            <div class="element">\r\n                                <input type="text" name="actions[forward][target]" class="u-input u-input-1" value="[[actions2.forward.target]]" autocomplete="off" [[#if actions2.reject]]disabled[[/if]] />\r\n                                <label class="tip-error f-dn" id="forwardErrMsg"></label>\r\n                            </div>\r\n                        </div>\r\n                        [[/if]]\r\n\r\n                        [[#if isEnableAutoReply]]\r\n                        <div class="condition">\r\n                            <div class="element label label-1">\r\n                                <input id="reply" type="checkbox" name="actions[reply][isChecked]" value="true" [[#if actions2.reply]]checked[[/if]] [[#if actions2.reject]]disabled[[/if]] />\r\n                                <label for="reply">[[i18n "pref/junkfilter/autoresp"]]</label>\r\n                            </div>\r\n                            <div class="element">\r\n                                <input type="text" name="actions[reply][content]" class="u-input u-input-1" value="[[actions2.reply.content]]" autocomplete="off" [[#if actions2.reject]]disabled[[/if]] />\r\n                                <label class="tip-error f-dn" id="replyErrMsg"></label>\r\n                            </div>\r\n                        </div>\r\n                        [[/if]]\r\n\r\n                        <!-- COS  -->\r\n                        [[#if enableSmsNotify]]\r\n                        <div class="condition">\r\n                            <div class="element label label-1">\r\n                                <input id="sms" type="checkbox" name="actions[sms][isChecked]" value="true" [[#if actions2.sms]]checked[[/if]] [[#if actions2.reject]]disabled[[/if]] />\r\n                                <input type="hidden" name="actions[sms][target]" value="[[cellNumber]]"/>\r\n                                <label for="sms">[[i18n "setting/lbl_sms"]]</label>\r\n                            </div>\r\n                        </div>\r\n                        [[/if]]\r\n                    </div>\r\n                </div>\r\n                <div class="conditions-block">\r\n                    <div class="conditions">\r\n                        <div class="condition">\r\n                            <div class="element label label-2">\r\n                                <input id="continue" type="checkbox" name="continue" value="true" [[#if continue]]checked[[/if]] />\r\n                                <label for="continue">[[i18n "setting/lbl_filter_continue_desc"]]</label>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </form>\r\n    </script>\r\n\r\n  <script type="text/x-handlebar-template" id="filterMessageTpl">\r\n    <div class="panel-content panel-header">\r\n      <div class="panel-btn">\r\n        <div class=btn-group>\r\n          <button class="u-btn u-btn-default" data-action="backToList">[[i18n "pref/junkfilter/closefilter"]]</button>\r\n        </div>\r\n      </div>\r\n      <div class="panel-block">\r\n        <div class="panel-title">\r\n          <b>[[i18n "pref/junkfilter/setfilter"]]</b>\r\n          <a data-action="editRule" class="f-fr" data-ruleid="[[id]]">[[i18n "pref/junkfilter/updatefilter"]]</a>\r\n        </div>\r\n        <div>\r\n          <label class="lightGrey">\r\n            <span>[[i18n "pref/junkfilter/condtion_if"]]</span>\r\n            [[#each condictions]]\r\n            [[#if @first]][[^]]<span><br />&nbsp;&nbsp;&nbsp;[[#compare ../../operator \'!=\' \'or\']][[i18n "pref/junkfilter/cond_and"]] [[^]][[i18n "pref/junkfilter/cond_or"]] [[/compare]]</span>[[/if]]\r\n            <span>[[field_zh]]</span>\r\n            <span>[[operator_zh]]</span>\r\n            <span>[[operand]]</span>\r\n            [[#compare field \'==\' \'size\']]\r\n            <span>KB</span>\r\n            [[^]]\r\n            <span>[[#if ignoreCase]] [[i18n "pref/junkfilter/nocase"]] [[^]] [[i18n "pref/junkfilter/case"]] [[/if]]</span>\r\n            [[/compare]]\r\n            [[#if forAddress]]<span>[[i18n "pref/junkfilter/forAddress"]]</span>[[/if]]\r\n            [[/each]]\r\n\r\n            <span><br />[[i18n "pref/junkfilter/execute"]]</span>\r\n            [[#each actions]]\r\n            [[#if disabled]]\r\n            [[^]]\r\n            [[#if @first]][[^]]<span><br />&nbsp;&nbsp;&nbsp;[[i18n "pref/junkfilter/cond_and"]]</span>[[/if]]\r\n            <span>[[type_zh]]</span>\r\n            [[#if target]]<span>[[target]]</span>[[/if]]\r\n            [[#if content]]<span>[[content]]</span>[[/if]]\r\n            [[#if keepLocal]]<span>[[i18n "pref/junkfilter/ac_keeplocal"]]</span>[[/if]]\r\n            [[#compare ../../name \'==\' \'##VIP\']]<span>[[i18n "pref/junkfilter/vip_message"]]</span>[[/compare]]\r\n            [[/if]]\r\n            [[/each]]\r\n          </label>\r\n        </div>\r\n      </div>\r\n      <div class="panel-block">\r\n        <b class="panel-title">[[i18n "pref/junkfilter/filterResult"]]</b>\r\n        <div class="panel-message f-dn">\r\n          <span class="j-msg"></span>\r\n          <a href="javascript:void(0)" class="f-dn j-execFilter" data-action="moveFilterList">[[i18n\r\n            "setting/op_execfilter"]]</a>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class="panel-list u-scroll panel-body" id="listMessageContainer"></div>\r\n    <div class="panel-page f-dn panel-footer">\r\n      <div id="pagination" class="pagination"></div>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="messageGroupTpl">\r\n        [[#each messageGroup]]\r\n        [[#compare list.length \'!=\' \'0\']]\r\n        <div class="list-title f-csp j-listtt">\r\n            <i class="iconfont iconcollapse"></i>\r\n            <span class="j-select-group">[[name]] ([[list.length]])</span>\r\n        </div>\r\n        <div class="list-body">\r\n            <table class="u-table ">\r\n                <tbody>\r\n                [[#each list]]\r\n                <tr class="j-mail">\r\n                    <td class="from">[[formatfrom]]</td>\r\n                    <td class="subject"><span>[[subject]]</span></td>\r\n                    <td class="attach"><i class="iconfont [[#if flags.attached]] iconacc[[/if]]"></i></td>\r\n                    <td class="time">[[formatReceivedDate]]</td>\r\n                </tr>\r\n                [[/each]]\r\n                </tbody>\r\n            </table>\r\n        </div>\r\n        [[/compare]]\r\n        [[/each]]\r\n  </script>\r\n\r\n  <script type="text/x-handlebar-template" id="listMessageTpl">\r\n        <table class="u-table">\r\n            <thead>\r\n            <tr>\r\n                <th>[[i18n "pref/junkfilter/mail_from"]]</th>\r\n                <th>[[i18n "pref/junkfilter/mail_subject"]]</th>\r\n                <th><i class="iconfont icondown"></i></th>\r\n                <th>[[i18n "pref/junkfilter/mail_receivedDate"]]<i class="iconfont icondown"></i></th>\r\n            </tr>\r\n            </thead>\r\n            <tbody>\r\n            [[#each list]]\r\n            <tr>\r\n                <td><span>[[from]]</span></td>\r\n                <td><span>[[subject]]</span></td>\r\n                <td><span></span></td>\r\n                <td><span>[[receivedDate]]</span></td>\r\n            </tr>\r\n            [[/each]]\r\n            </tbody>\r\n        </table>\r\n  </script>\r\n  {{/raw}}\r\n</section>';
}),define("module/setting/filter/letter/index",["require","i18n!setting,pref,pref/junkfilter,main,mbox,error","widget/pagination/pagination","jquery","util/index","cui/core/view/view","cui/ui/select/select","./../../service","./../../../mail/service","cui/core/view/viewmanager","../../../common/globalService","../../../../component/confirmbox","cui/util/templatable/templatable","configurable/index","text!template/module/setting/filter/letter/index.tpl.html"],function(e){e("i18n!setting,pref,pref/junkfilter,main,mbox,error"),e("widget/pagination/pagination");var t=e("jquery"),n=e("util/index"),i=e("cui/core/view/view"),a=e("cui/ui/select/select"),r=e("./../../service"),s=e("./../../../mail/service"),o=e("cui/core/view/viewmanager"),l=e("../../../common/globalService"),c=e("../../../../component/confirmbox"),d=e("cui/util/templatable/templatable"),u=e("configurable/index"),p=n.i18n,m={field:{from:p.t("pref/junkfilter/cond_from"),recipients:p.t("pref/junkfilter/cond_recipients"),subject:p.t("pref/junkfilter/cond_subject"),size:p.t("pref/junkfilter/cond_size"),rcptType:""},operator:{contains:p.t("pref/junkfilter/op_text_contains"),excludes:p.t("pref/junkfilter/op_text_excludes"),"=":p.t("setting/lbl_equal"),"!=":p.t("setting/lbl_unequal"),startsWith:p.t("pref/junkfilter/op_text_startsWith"),endsWith:p.t("pref/junkfilter/op_text_endsWith"),"<":p.t("pref/junkfilter/op_size_lt"),">":p.t("pref/junkfilter/op_size_gt")}},h={type:{forward:p.t("pref/junkfilter/ac_forward"),reply:p.t("pref/junkfilter/ac_reply"),move:p.t("pref/junkfilter/ac_move"),flags:p.t("pref/junkfilter/ac_flagged"),reject:p.t("pref/junkfilter/ac_reject"),sms:p.t("pref/junkfilter/ac_sms")}},f=i.extend({Implements:d,events:{"click [data-action]":"_dispatchAction","change #executeAction":"_handleToggleInputDisabled","focus .panel .u-input":"_handleTickCheckbox","blur .panel .u-input":"_handleCancelTickCheckbox","click .panel .checkbox":"_handleSingleSelect","click div.j-listtt":"_handleToggleExpand"},setup:function(){this.config=u("setting.filter"),this._params={fid:1,totalMsgCnt:0,folders:[],targetId:0,ruleId:0,mailRules:[]}},render:function(){f.superclass.render.call(this),t.notify.loading(),this._initView(!0),this._initModuleEvent()},_dispatchAction:function(e,n){var i,a,r,s=this,o=t(n).data("action");switch(o){case"createRule":s._handleEditRule({isCreate:!0});break;case"editRule":var c=t(n).data("rulename");if("##VIP"===c){var d={module:"setting.filter.vip",param:{}};l.setCurrentState(d),s.sendMessage("dispatcher","history:add",d)}else s._handleEditRule({id:t(n).data("ruleid")});break;case"deleteRule":r=!1,s._handleDeleteRule(t(n),r);break;case"saveRule":s._handleSaveRule();break;case"up":i=t(n).data("ruleid"),a=t(n).parents(".item").prev().find("[data-ruleid]").data("ruleid"),s._handleMoveRule(i,a);break;case"down":i=t(n).data("ruleid"),a=t(n).parents(".item").next().find("[data-ruleid]").data("ruleid"),s._handleMoveRule(i,a);break;case"removeAllRules":if(t(n).hasClass("disabled"))return!1;r=!0,s._handleDeleteRule(s.$(".subContainer [data-action='deleteRule']"),r);break;case"switchStatus":s._handleSwitchStatus(n);break;case"backToList":s._switchPanel("-filter");break;case"moveFilterList":s._handleMoveFilterList();break;case"closePanel":s.$(".main-wrapper").removeClass("toggled");break;case"createFolder":s._handleCreateFolder()}},_initView:function(e){var n=this;e="boolean"===t.type(e)?e:!1,t.when(r.getMailRules(),s.getFolders(!0,!0,!0)).then(function(i,a){i=i||[],n._params.folders=a,i=n._makeUpMailRuleList(i),n._renderMailRulesList(i),n.element.customRadioCheckbox(),t.notify.loading("hide"),e&&n._extraAction()})},_makeUpMailRuleList:function(e){e=e||[];var n=this;return t.each(e,function(e,i){var a=i.condictions||[],r=i.actions||[];if(a.length){var s=[];t.each(a,function(e,t){"rcptType"!==t.field&&(t.field_zh=m.field[t.field],t.operator_zh=m.operator[t.operator],s.push(t))}),i.condictions=s}r.length&&t.each(r,function(e,t){"move"===t.type&&(t.target=n._getFolderNameById([t.target])),"flags"===t.type&&(t.label0=t.value.label0||0),t.type_zh=h.type[t.type]}),i.name=i.name.replace(/\s/g,"&nbsp;")}),e},_getFolderNameById:function(e){var n="";return t.each(this._params.folders,function(t,i){return e==i.id?(n=i.name,!1):void 0}),n},_initModuleEvent:function(){var e=this;this.onMessage("view:refresh",function(){e._initView()},null),this.onMessage("methodInvocation",function(){e._extraAction()},null)},_extraAction:function(){var e=l.getCurrentState(),t=e.param||{};switch(t.type){case"create":this._handleEditRule({isCreate:!0,mailRule:{name:n.messageFormat.format(p.t("pref/junkfilter/auto_create_ruleName"),t.emailaddr),condictions:[{field:"from",operator:"contains",operand:t.emailaddr}],"continue":!0}})}l.setCurrentState({module:e.module,param:{view:"letter"}})},_renderMailRulesList:function(e){e=e||[];var t=n.messageFormat.format(p.t("setting/lbl_statistics"),[e.length,this.config.maxRuleCount]),i=e.length>1||1===e.length&&"##VIP"!==e[0].name,a=this.compile(this.$("#rulesTpl").html(),{mailRules:e,statistics:t,canRemoveAll:i});this.$("#mainContainer").html(a),this._params.mailRules=e},_initPagination:function(e,t,n){var i=this;i.$("#pagination").pagination({total:e,limit:t,round:!0,menuAlignCenter:!0,prevText:'<span class="iconfont iconprevious"></span>',nextText:'<span class="iconfont iconnext"></span>',callback:function(e){i._handleFilterListMessage({start:e*t,ruleConditions:n})}})},_handleTickCheckbox:function(e,n){var i=t(n).parents(".condition");i.find(":checkbox").prop("checked",!0),i.find(".checkbox").addClass("checkbox-checked")},_handleCancelTickCheckbox:function(e,n){var i=t(n).parents(".condition");t(n).val()||(i.find(":checkbox").prop("checked",!1),i.find(".checkbox").removeClass("checkbox-checked"))},_handleSingleSelect:function(e,n){var i=t(n).prev("checkbox");t(n).hasClass("checkbox-checked")?i.prop("checked",!0):i.prop("checked",!1)},_handleToggleInputDisabled:function(e,n){var i=t(n).val(),a=t(n).parents(".condition").siblings(),r=a.find("select, input"),s=a.find(".checkbox");"true"===i?(r.prop("disabled",!0),s.addClass("rc-disabled").removeClass("checkbox-checked"),this.$(".j-action-move, .j-action-flagged").each(function(){this.selectInstance&&this.selectInstance.set("disabled",!0)})):(r.prop("disabled",!1),s.removeClass("rc-disabled"),this.$(".j-action-move, .j-action-flagged").each(function(){this.selectInstance&&this.selectInstance.set("disabled",!1)}))},_handleToggleExpand:function(e,n){var i=t(n).next("div.list-body");i.hasClass("fold")?i.slideDown().removeClass("fold"):i.slideUp().addClass("fold"),t(n).find("i").toggleClass("iconcollapse iconunfold")},_handleEditRule:function(e){var i=this;return e.isCreate&&i._params.mailRules.length>=this.config.maxRuleCount?(c.alert(n.i18n.t("setting/msg_beyondMaxRuleLimit")),!1):(this._switchPanel("edit"),void r.editMailRule(e).then(function(e){e=e||{},e.folders=i._params.folders,t.extend(e,{isEnableForward:i.config.isEnableForward,isEnableAutoReply:i.config.isEnableAutoReply,isEnableMailFlag:i.config.supportmailflagged,enableSmsNotify:i.config.supportSmsNotify&&e.cellNumber,folderColorCount:i.config.mailFlaggedColorCount});var n=i.compile(i.$("#editRuleTpl").html(),e);i.$(".panel .edit").html(n),i.element.customRadioCheckbox();var r={classPrefix:"u-select",maxHeight:200,autoSetWidth:!1,parentNode:i.element};i.$('[name="ruleForm"] .u-select').each(function(){var e=t(this);t.extend(r,{trigger:e,disabled:e.prop("disabled")||!1,parentNode:e.parent(),zIndex:999}),"executeAction"===e.attr("id")?new a(r).render().on("change",function(){e.trigger("change")}):this.selectInstance=new a(r).render()})}))},_handleDeleteRule:function(e,i){var a=this,s=[],o=i?n.i18n.t("setting/msg_deleteAll"):n.i18n.t("setting/msg_deleteFilterTip");return 0===e.length?!1:void c.confirm(o,function(){t.each(e,function(e,n){s.push(t(n).data("ruleid"))}),r.removeMailRules(s).then(function(){a._initView()})},t.noop)},_handleSaveRule:function(){var e=this,i=!1,a=[],s=this.$("div.main-wrapper"),o=this.$("[name='ruleForm']").serializeJSON({parseBooleans:!0})||{},l=o.isCreate;delete o.isCreate,this.$(".panel .tip-error").addClass("f-dn"),o.name?(l||!l&&o.oname!==o.name)&&t.each(e._params.mailRules,function(e,t){return t.name===o.name?(i=!0,a.push({selector:"name",errType:"DuplicateErr"}),!1):void 0}):(i=!0,a.push({selector:"name",errType:"EmptyErr"})),delete o.oname,o["continue"]=o["continue"]||!1;var d=o.conditions||{},u=[],p=!0;for(var m in d)if(d[m].isChecked&&(p=!1,d[m].operand)){if(delete d[m].isChecked,"size"==m){if(isNaN(d[m].operand))return c.alert(n.i18n.t("setting/msg_errNotInt"),t.noop(),{parentNode:s}),!1;d[m].operand=d[m].operand*Math.pow(1024,d[m].unit),delete d[m].unit}d[m].field=m,u.push(d[m])}if(p)return c.alert(n.i18n.t("setting/msg_errEmailCond"),t.noop(),{parentNode:s}),!1;if(!u.length)return c.alert(n.i18n.t("setting/msg_errEmptyInput"),t.noop(),{parentNode:s}),!1;var h=o.actions||{},f=[],v=!1;if(h.reject)f.push({type:"reject"});else{delete h.reject;var g,b,_,y,w=!0;for(g in h)if(_=h[g],_.isChecked)if(w=!1,b=_.target||_.content||_.value&&_.value.label0){switch(g){case"move":v=!0,e._params.targetId=_.target;break;case"forward":y=n.Email.parse(b),t.each(y,function(e,t){n.Email.test(t.address)||(i=!0)}),i&&a.push({selector:g,errType:"FormatErr"});break;case"flags":_.value={flagged:!0,label0:b}}delete _.isChecked,_.type=g,f.push(_)}else i=!0,a.push({selector:g,errType:"EmptyErr"});if(w||0===f.length)return c.alert(n.i18n.t("setting/msg_errFilterAct"),t.noop(),{parentNode:s}),!1}if(i)return t.each(a,function(t,i){e.$("#"+i.selector+"ErrMsg").html(n.i18n.t("setting/lbl_"+i.selector+i.errType)).removeClass("f-dn")}),!1;delete o.conditions,o.condictions=u,o.actions=f;var x=[];x.push(o),l?r.addMailRule({items:x}).then(function(i){i=i||[],v?(o.id=i[0],o.saveMsg=n.i18n.t("setting/msg_createSuccessful"),e._handleRenderListMessageTpl(o)):e._switchPanel("-edit"),e._initView(),t.notify(n.i18n.t("setting/msg_ruleAddedSuccessfully"))}):r.updateMailRule({items:x}).then(function(){v?(o.saveMsg=n.i18n.t("setting/msg_updateSuccessFul"),e._handleRenderListMessageTpl(o)):e._switchPanel("-edit"),e._initView(),t.notify(n.i18n.t("setting/msg_ruleEditedSuccessfully"))})},_handleMoveRule:function(e,t){var n=this;r.adjustMailRules({id:e,ref:t,value:0}).then(function(){n._initView()})},_handleSwitchStatus:function(e){var n=t(e).data("ruleid"),i=!t(e).find(":checkbox").prop("checked"),a=[];a.push({id:n,disabled:i}),r.updateMailRule({items:a}).then(function(){var n=t(e).parents(".item");i?n.addClass("item-disabled"):n.removeClass("item-disabled")})},_handleRenderListMessageTpl:function(e){e=this._makeUpMailRuleList([e])[0],this._params.ruleId=e.id;var t=this.compile(this.$("#filterMessageTpl").html(),e);this.$(".panel .filter").html(t),this._switchPanel("filter"),this._handleFilterListMessage({ruleConditions:"@"+e.id,resetPagination:!0})},_handleFilterListMessage:function(e){var i=this;e=t.extend({fid:i._params.fid,returnTotal:!0,limit:i.config.limitPerPage},e),s.getMailList(e).then(function(t){var a,r=t.total||0;0!==r?(a=n.messageFormat.format(n.i18n.t("setting/msg_numofmailsexecfilter"),r),i.$("a.j-execFilter, div.panel-page").removeClass("f-dn")):(a=n.i18n.t("setting/msg_nomailsexecfilter"),i.$("a.j-execFilter, div.panel-page").addClass("f-dn")),i.$("div.panel-message").removeClass("f-dn"),i.$("div.panel-message .j-msg").html(a),i._adjustOffsetHeight();var o=i.$("#listMessageContainer");if(r>0){var l=i.$("#messageGroupTpl").html();t.list=s.groupMailList(t.list);var c=i.compile(l,{messageGroup:t.list});o.html(c)}else o.html("");i._params.totalMsgCnt=r,e.resetPagination&&i._initPagination(r,e.limit,e.ruleConditions)},function(e){c.alert(n.i18n.t("error/"+e.code),function(){i._initView()},{parentNode:i.$("div.main-wrapper")})})},_handleMoveFilterList:function(){var e=this,i=e._params.targetId,a="@"+e._params.ruleId;s.updateMailAttrs("rule",{mid:[],fid:e._params.fid,rule:a}).then(function(){var r=n.messageFormat.format(n.i18n.t("setting/msg_moveMessageSuccessful"),[e._params.totalMsgCnt,e._getFolderNameById(i)]);t.notify(r),e._switchPanel("-filter"),e._handleFilterListMessage({ruleConditions:a,resetPagination:!0})})},_handleCreateFolder:function(){var e=this,i="<div class ='diaglog-item'><label class='label f-ib f-tar' style='width: 150px'>"+n.i18n.t("setting/msg_inputFolderName")+"</label> &nbsp;&nbsp;<input type='text' name='folderName' class='j-new-folderName'/> <br> <br><label class='label f-ib f-tar' style='width: 150px'>"+n.i18n.t("setting/lbl_folderPos")+":</label> &nbsp;&nbsp;<select name='pid' class='j-new-folderPid' style='max-width: 240px'> {{{folderOption folder 0 true}}} </select></div>",s=this.compile(i,{folder:this._params.folders});c.confirm(s,function(){var i=this.$(".j-new-folderName").val(),s=this.$(".j-new-folderPid").val(),o={name:i,parent:+s},l=r.isValidString(i);"valid"===l?t.when(r.createFolders([o])).then(function(r){switch(r.code){case"FA_NAME_RESERVED":t.notify.error(n.i18n.t("main/err_folder_NAME_RESERVED"));break;case"FA_NAME_EXISTS":t.notify.error(n.i18n.t("main/err_folder_NAME_EXISTS"));break;case"FA_NAME_INVALID":t.notify.error(n.i18n.t("main/err_folder_NAME_INVALID"));break;case"S_OK":t.notify.success(n.i18n.t("setting/msg_createFolderSuccess"));var s=r["var"][0],l=e.$("select.j-action-move");l.next().remove(),l.append(t("<option />",{value:s,selected:!0,text:i})),o={classPrefix:"u-select",maxHeight:200,autoSetWidth:!1,trigger:l,disabled:!1,parentNode:l.parent(),zIndex:999},new a(o).render(),e.sendMessage("mail","folder:refresh",{type:"all"}),e.sendMessage("setting.folder.folder","folder:refresh",null)}}):t.notify.error(n.i18n.t("setting/msg_err_folder_"+l))})},_switchPanel:function(e){var t=this.$(".main-wrapper");if(-1===e.indexOf("-"))if(t.hasClass("toggled")){var n=t.attr("class");n=n.replace(/switch[A-Za-z]*/,""),n+=" switch"+e,t.attr("class",n)}else t.addClass("toggled");else t.removeClass("toggled switch"+e.substr(1))},_adjustOffsetHeight:function(){this.$("div.panel div.panel-list").css("top",this.$("div.panel div.panel-content").height()+40)},templateHelpers:{select:function(e,n){var i=t("<select />").html(n.fn(this));return i.find("[value='"+e+"']").attr({selected:"selected"}),i.html()},labelOption:function(e,n){for(var i="",a=0;e>a;a++)i+=t("<option />").attr("value",a).attr("selected",n===a).text(p.t("mbox/flagged_option_color"+a))[0].outerHTML;return i},folderOption:function(e,i,a){var r=t("<select />");return a&&r.append(t("<option />").attr("value",0).text(p.t("main/fdr_root"))),t.each(e,function(e,a){r.append(t("<option />").attr("value",a.id).attr("selected",i==a.id).text(new Array(a.deepLevel).join("")+n.html.encode(a.name)))}),r.html()}}});o.module({name:"setting.filter.letter",template:e("text!template/module/setting/filter/letter/index.tpl.html")},f)}),define("components/requirejs-text/text!template/module/setting/filter/vip/index.tpl.html",[],function(){return'<!--  -->\r\n<section class="m-vip grid-row">\r\n    <div class="main-wrapper">\r\n      <div class="content-wrapper">\r\n        <!--    -->\r\n        <div class="grid-col12 mainContainer" id="mainContainer">\r\n          <div class="grid-row lfheader">\r\n            <div class="grid-col12">\r\n              <div class="u-btns">\r\n                <button type="button" class="u-btn u-btn-primary" data-action="newContact">{{i18n "setting/op_addVIPContact"}}</button>\r\n              </div>\r\n              <div class="u-btns">\r\n                <button type="button" class="u-btn u-btn-primary" data-action="newSubject">{{i18n "setting/op_addVIPSubject"}}</button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <div class="grid-row subContainer u-scroll">\r\n            <div class="grid-row tTip">\r\n              <i class="iconfont state-icon icon-mUNREAD"></i>\r\n              <span>{{i18n "setting/msg_vipTip"}}</span>\r\n            </div>\r\n            <div class="grid-row tHead">\r\n              <table class="u-table u-table-1">\r\n                <thead>\r\n                <tr>\r\n                  <th class="firstTH"><a href="javascript:void(0)" data-operation="collapse"><i class="iconfont iconcollapse"></i></a></th>\r\n                  <th class="nth2TH">{{i18n "setting/lbl_vipContact"}}</th>\r\n                  <th class="nth3TH">{{i18n "setting/lbl_vipEmail"}}</th>\r\n                  <th class="lastTH">{{i18n "setting/lbl_op"}}</th>\r\n                </tr>\r\n                </thead>\r\n              </table>\r\n            </div>\r\n            <div class="grid-row tBody">\r\n              <table class="u-table u-table-1" id="contactList">\r\n                <tbody></tbody>\r\n              </table>\r\n            </div>\r\n            <div class="grid-row tHead">\r\n              <table class="u-table">\r\n                <thead>\r\n                <tr>\r\n                  <th class="firstTH"><a href="javascript:void(0)" data-operation="collapse"><i class="iconfont iconcollapse"></i></a></th>\r\n                  <th>{{i18n "setting/lbl_vipSubject"}}</th>\r\n                  <th class="lastTH">{{i18n "setting/lbl_op"}}</th>\r\n                </tr>\r\n                </thead>\r\n              </table>\r\n            </div>\r\n            <div class="grid-row">\r\n              <form name="subjectListForm" action="#">\r\n                <table class="u-table" id="subjectList">\r\n                  <tbody></tbody>\r\n                </table>\r\n              </form>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <!--[if lt IE 9]>\r\n      <div class="sg-mask" />\r\n      <![endif]-->\r\n\r\n      <!--   -->\r\n      <div class="panel u-scroll" id="newContactOrSubjectContainer"></div>\r\n    </div>\r\n\r\n    {{#raw}}\r\n\r\n    <script type="text/x-handlebar-template" id="newContact">\r\n        <form name="contactForm" action="#" onsubmit="return false">\r\n            <div class="panel-item panel-item-1">\r\n                <div class="btn-group">\r\n                    <button data-action="saveContact" disabled class="u-btn u-btn-primary" type="button">{{i18n "setting/op_add"}}</button>\r\n                    <button data-operation="closePanel" class="u-btn u-btn-default" type="button">{{i18n "setting/op_cancel"}}</button>\r\n                </div>\r\n            </div>\r\n            <div class="panel-item panel-item-2">\r\n                <h4>{{i18n "setting/op_addVIPContact"}}</h4>\r\n            </div>\r\n            <div class="panel-item panel-item-3 u-scroll" id="selectedContactsContainer"></div>\r\n            <div class="panel-item">\r\n                <div class="conditions-block">\r\n                    <div class="label label-1">\r\n                        <span>{{i18n "setting/lbl_vipContact"}}</span>\r\n                    </div>\r\n                    <div class="conditions conditions-1">\r\n                        <div class="condition condition-2">\r\n                            <input type="text" class="u-input u-input-1" name="name" id="getMatchContacts" autocomplete="off"/>\r\n                            <span>\r\n                                <a href="javascript:void(0)" class="f-fr" data-operation="addContact">\r\n                                  <i class="iconadd iconfont"></i>\r\n                                  {{i18n "setting/op_new"}}\r\n                                </a>\r\n                            </span>\r\n                          <div class="error-tip">{{i18n "setting/msg_errorEmailFormat"}}</div>\r\n                          <div class="btn-contact">\r\n                            <a href="javascript:void(0)" data-action="addFromContact">{{i18n "setting/op_addFromContact"}}</a>\r\n                          </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </form>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="newSubject">\r\n        <form name="subjectForm" action="#" onsubmit="return false">\r\n            <div class="panel-item panel-item-1">\r\n                <div class="btn-group">\r\n                    <button data-action="saveSubject" disabled class="u-btn u-btn-primary" type="button">{{i18n "setting/op_add"}}</button>\r\n                    <button data-operation="closePanel" class="u-btn u-btn-default" type="button">{{i18n "setting/op_cancel"}}</button>\r\n                </div>\r\n            </div>\r\n            <div class="panel-item panel-item-2">\r\n                <h4>{{i18n "setting/op_addVIPSubject"}}</h4>\r\n            </div>\r\n            <div class="panel-item panel-item-3 u-scroll" id="subjectContainer"></div>\r\n            <div class="panel-item">\r\n                <div class="conditions-block">\r\n                    <div class="label">\r\n                        <span>{{i18n "setting/lbl_vipSubject"}}:</span>\r\n                    </div>\r\n                    <div class="conditions">\r\n                        <div class="">\r\n                            <input type="text" class="u-input u-input-1" name="name" id="subjectToAdd" autocomplete="off"/>\r\n                            <span>\r\n                                <a href="javascript:void(0)" class="f-fr" data-operation="addSubject">\r\n                                  <i class="iconadd iconfont"></i>\r\n                                  {{i18n "setting/op_new"}}\r\n                                </a>\r\n                            </span>\r\n                            <div class="error-tip">{{i18n "setting/msg_subjNullErr"}}</div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </form>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="addSubjectTpl">\r\n      <div class="conditions-block">\r\n        <input type="hidden" name="operand[]" value="[[[value]]]">\r\n        <div class="label">\r\n          <span class="sequence">[[i18n "setting/lbl_vipSubject"]]</span>\r\n        </div>\r\n        <div class="conditions">\r\n          <div class="condition condition-1">\r\n            <span class="vipSubject">[[[value]]]</span>\r\n            <a href="javascript:void(0)" data-operation="removeSubject">\r\n              <i class="iconremove iconfont"></i>\r\n              [[i18n "setting/op_remove"]]\r\n            </a>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="addContactTpl">\r\n      <div class="conditions-block">\r\n        <input type="hidden" value="[[id]]" data-name="[[name]]" data-addr="[[addr]]" data-isoab="[[isOab]]"/>\r\n        <div class="label label-1">\r\n          <span class="sequence">[[i18n "setting/lbl_vipContact"]]</span>\r\n        </div>\r\n        <div class="conditions conditions-1">\r\n          <div class="condition condition-1">\r\n            <span class="vipContact">[[[val]]]</span>\r\n            <a href="javascript:void(0)" data-operation="removeContact">\r\n              <i class="iconremove iconfont"></i>\r\n              [[i18n "setting/op_remove"]]\r\n            </a>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="emptyContactListTpl">\r\n        <tr>\r\n          <td colspan="4" style="text-align:left"><span>[[i18n "setting/lbl_noMoreVIPContact"]]</span></td>\r\n        </tr>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="contactListTpl">\r\n        <tr>\r\n          <td class="firstTD"></td>\r\n          <td class="nth2TD"><span>[[name]]</span></td>\r\n          <td><span>[[addr]]</span></td>\r\n          <td class="lastTD"><a href="javascript:void(0)" data-action="deleteContact" data-id="[[id]]" data-addr="[[addr]]">\r\n            [[i18n "setting/op_remove"]]\r\n          </a></td>\r\n        </tr>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="emptySubjectListTpl">\r\n      <tr>\r\n        <td colspan="3" style="text-align:left"><span>[[i18n "setting/lbl_noMoreVIPSubject"]]</span></td>\r\n      <tr>\r\n    </script>\r\n\r\n    <script type="text/x-handlebar-template" id="subjectListTpl">\r\n      <tr>\r\n        <td class="firstTD"><input type="hidden" name="operand[]" value="[[[val]]]"></td>\r\n        <td><span>[[[val]]]</span></td>\r\n        <td class="lastTD"><a href="javascript:void(0)" data-action="deleteSubject" data-subject="[[[val]]]">[[i18n "setting/op_remove"]]</a></td>\r\n      </tr>\r\n    </script>\r\n    {{/raw}}\r\n</section>'}),define("module/setting/filter/vip/index",["require","i18n!setting,main,pab","../../../../component/contactdg","../../../../component/contactac","jquery","util/index","cui/core/view/view","component/confirmbox","module/contact/service","module/setting/service","cui/core/view/viewmanager","module/common/globalService","cui/util/templatable/templatable","text!template/module/setting/filter/vip/index.tpl.html"],function(e){function t(e,t){e=e||[];for(var n=0,i=e.length,a={};!0&&n!==i;n++)if(e[n].name===t){a=e[n];break}return a}function n(e){e=e||[];for(var t,n=0,i=e.length;!0&&n!==i;n++)if("subject"===e[n].field){t=e[n].operand;break}return t?t.split(","):[]}function i(e,t){e=e||[],t=t||[];for(var n=0,i=e.length,a=!1,r=!1,s=[];!0;n++){if(n===i){r||s.push({field:"from",operator:"contains",operand:"VIP",forIAddress:!0,disabled:!1,ignoreCase:!1,flagOperatorOr:!0,forAddress:!1,listOfValues:!1}),a||0===t.length||s.push({field:"subject",operator:"contains",operand:t.join(","),listOfValues:!0,ignoreCase:!0,flagOperatorOr:!0,disable:!1});break}"subject"===e[n].field?(0!==t.length&&(e[n].operand=t.join(","),s.push(e[n])),a=!0):"from"===e[n].field&&(s.push(e[n]),r=!0)}return s}function a(e,t){return"&quot;"+s.html.encode(e)+"&quot;&nbsp;&lt;"+s.html.encode(t)+"&gt;"}e("i18n!setting,main,pab"),e("../../../../component/contactdg"),e("../../../../component/contactac");var r=e("jquery"),s=e("util/index"),o=e("cui/core/view/view"),l=e("component/confirmbox"),c=e("module/contact/service"),d=e("module/setting/service"),u=e("cui/core/view/viewmanager"),p=e("module/common/globalService"),m=e("cui/util/templatable/templatable"),h=o.extend({Implements:m,events:{"click [data-operation]":"_dispatchOperation","click [data-action]":"_dispatchAction","focus #getMatchContacts":"_checkContactEdit","focus #subjectToAdd":"_checkSubjectEdit"},_params:{rule:{},contacts:[],subjects:[],existEmail:{},existSubjects:[]},setup:function(){this.userEmail=p.getUser().primary_email},render:function(){var e=this;h.superclass.render.call(e),e._initialize(),e._initContactDialog(),e._initModuleEvent()},_dispatchOperation:function(e,t){var n,i=this,a=r(t).data("operation");switch(a){case"collapse":r(t).find("i").toggleClass("iconcollapse").toggleClass("iconunfold"),n=r(t).parents(".grid-row"),n.next(".grid-row").toggleClass("collapse");break;case"closePanel":i.trigger("updatePanelStatus",!0);break;case"addContact":i._handleAddContact(t);break;case"addSubject":i._handleAddSubject();break;case"removeContact":n=r(t).parents(".conditions-block");var s=n.find(":hidden");delete i._params.existEmail[s.data("addr")],n.remove();break;case"removeSubject":r(t).parents(".conditions-block").remove();var o=i.$("[name=subjectForm]").serializeJSON()||{};i._params.existSubjects=o.operand||[]}},_dispatchAction:function(e,t){var n=this,i=r(t).data("action");switch(i){case"newContact":n.trigger("updatePanelStatus",!1),n._params.existEmail={},n._handleNewContact(),n._initContactAC();break;case"newSubject":n.trigger("updatePanelStatus",!1),n._params.existSubjects=[],n._handleNewSubject();break;case"saveContact":n._handleSaveContact();break;case"saveSubject":n._handleSaveSubject();break;case"deleteContact":var a=r(t).data("id").toString();l.confirm(s.messageFormat.format(s.i18n.t("setting/msg_confirmContactDel"),s.html.encode(r(t).data("addr"))),function(){n._handleDeleteContact([a])});break;case"deleteSubject":l.confirm(s.messageFormat.format(s.i18n.t("setting/msg_confirmSubjectDel"),s.html.encode(r(t).data("subject"))),function(){n._handleDeleteSubject(t)})}},_initialize:function(){var e=this;r.when(d.getMailRules(),c.getAllPabContacts({returnAttrs:["EMAIL;PREF","FN","id"],groups:["VIP"]})).then(function(i,o){var l=t(i||[],"##VIP"),c=o.length,d="";if(e._params.rule=l,e._params.contacts=o,0===c)d=e.compile(e.$("#emptyContactListTpl").html(),{});else{var u=e.$("#contactListTpl").html();r.each(o,function(t,n){n.name=n.FN?n.FN:s.i18n.t("setting/msg_null"),n.addr=n["EMAIL;PREF"]?n["EMAIL;PREF"]:s.i18n.t("setting/msg_null"),n.val=a(n.name,n.addr),n.isUser=!0,n.isOab=!1,d+=e.compile(u,n)})}e.$("#contactList tbody").html(d);var p=n(l.condictions);e._params.subjects=p;var m=p.length,h="";if(0===m)h=e.compile(e.$("#emptySubjectListTpl").html(),{});else{var f=e.$("#subjectListTpl").html();r.each(p,function(t,n){h+=e.compile(f,{val:s.html.encode(n)})})}e.$("#subjectList tbody").html(h)})},_initContactDialog:function(){var e=this,t=e.$("#newContactOrSubjectContainer");t.contactdg({trigger:"a[data-action=addFromContact]",title:s.i18n.t("setting/op_addVIPContact"),selectTitle:s.i18n.t("setting/lbl_vipContact"),selectType:[{name:s.i18n.t("setting/lbl_contact"),type:"contact"}],onSelect:function(t){if(0===t.contact.length)return!1;var n=[],i=[],a=!1;if(r.each(t.contact,function(t,s){var o=!0;r.each(e._params.contacts,function(e,t){return s.addr===t.addr?(o=!1,i.push(s.addr),!1):void 0}),s.addr===e.userEmail&&(a=!0,o=!1),o&&n.push(s)}),a||0!==i.length){var o=s.i18n.t("setting/msg_addToListErr");a&&(o+=s.messageFormat.format(s.i18n.t("setting/msg_isSelfEmailErr"),e.userEmail)),0!==i.length&&(o+=s.messageFormat.format(s.i18n.t("setting/msg_duplicateEmailErr"),i.join(","))),l.alert(o,r.noop(),{onConfirm:function(){e.trigger("contactdg:afterSelect",n||[]),this.hide()}})}else e._checkContactEdit(),e.trigger("contactdg:afterSelect",n||[])},onClose:function(){}}),t.on("click","a[data-action=addFromContact]",function(){t.contactdg("show","contact",e._getContacts())})},_initModuleEvent:function(){var e=this;e.on("contactdg:afterSelect",function(t,n,i){n="boolean"===r.type(n)?n:!0,i="boolean"===r.type(i)?i:!0;var s="",o=e.$("#addContactTpl").html(),l=e.$("#selectedContactsContainer");r.each(t,function(t,n){n.isUser&&(n.val=a(n.name?n.name:"",n.addr),e._params.existEmail[n.addr]=!0,i&&(s+=e.compile(o,n)))}),n?l.html(s):l.append(s)}),e.on("updateRule",function(t,n){d.updateMailRule({items:[t]}).then(function(){n&&n()},function(i){"FA_ID_NOT_FOUND"===i&&e.trigger("addRule",t,n)})}),e.on("addRule",function(e,t){r.extend(e,{disabled:!1,name:"##VIP",actions:[{type:"flags",disabled:!1,value:{vip:!0}}]}),d.addMailRule({items:[e]}).then(function(e){d.adjustMailRules({id:e[0],value:-1}),t&&t()})}),e.on("viewRefresh",function(){e._initialize()}),e.on("updatePanelStatus",function(t){t?e.$(".main-wrapper").removeClass("toggled"):e.$(".main-wrapper").addClass("toggled")}),e.onMessage("view:refresh",function(){e.trigger("viewRefresh")})},_initContactAC:function(){var e=this,t=e.$("#getMatchContacts").contactac({uniqueContacts:!0,select:function(e,n){t.data("info",{isUser:!0,isOab:e.original.isOab,id:e.original.id,name:e.original.isOab?e.original.name:e.original.FN,addr:e.original.isOab?e.original.email:e.original["EMAIL;PREF"]})},width:400,zIndex:1e3})},_handleNewContact:function(){var e=this,t=e.$("#newContact").html();e.$("#newContactOrSubjectContainer").html(t),e.trigger("contactdg:afterSelect",e._params.contacts,!0,!1)},_handleAddContact:function(){var e=this,t=e.$("#getMatchContacts"),n=t.val(),i=s.Email.parseAddress(n),a=e._checkInput();if(!a)return!1;e._params.existEmail[i]=!0;var r=[],o=t.data("info");o&&o.addr===i?(o.name=o.name||"",r.push(o)):r.push({name:s.Email.parseTrueName(n),addr:i,isOab:!1,isUser:!0}),e.trigger("contactdg:afterSelect",r,!1),t.val("")},_handleSaveContact:function(){
var e,t=this,n=t.$("#selectedContactsContainer :hidden");if(e=0===n.length?t._checkInput():t._checkInput("ignoreEmpty"),!e)return!1;t.$("#getMatchContacts").val().length>0&&t._handleAddContact();var a=t._getGrpAddAndCreateIds(t.$("#selectedContactsContainer :hidden"));r.when(c.savePabGroup({func:"edit",gid:"VIP",uidsForPab:a.addIds.pIds.join(" "),uidsForOab:a.addIds.oIds.join(" ")}),0!==a.createIds.length?c.createPabContacts(a.createIds):r.noop()).then(function(){t.trigger("updatePanelStatus",!0),r.notify(s.i18n.t("setting/msg_addContactSuccessful")),r.isEmptyObject(t._params.rule)?(t._params.rule.condictions=i(),t.trigger("addRule",t._params.rule,function(){t.trigger("updatePanelStatus",!0),t.trigger("viewRefresh")})):t.trigger("viewRefresh")})},_handleNewSubject:function(){var e=this,t=e.$("#newSubject").html();e.$("#newContactOrSubjectContainer").html(t),e._handleMakeUpSubject(e._params.subjects,!1)},_handleAddSubject:function(){var e=this,t=e.$("#subjectToAdd"),n=s.html.encode(t.val()),i=e._handleSubjectError();return i?(e._handleMakeUpSubject([n]),void t.val("")):!1},_handleMakeUpSubject:function(e,t){var n=this;t="boolean"===r.type(t)?t:!0;var i=n.$("#subjectContainer"),a=n.$("#addSubjectTpl").html(),o="";r.each(e,function(e,i){var r=s.html.encode(i);n._params.existSubjects.push(r),t&&(o+=n.compile(a,{value:r}))}),i.append(o)},_handleSaveSubject:function(){var e=this,t=e.$("#subjectToAdd"),n=e.$("[name=subjectForm]").serializeJSON();if(t.val()){var a=e._handleSubjectError();if(!a)return!1;e._handleAddSubject(),n=e.$("[name=subjectForm]").serializeJSON()}else if(!n.operand||0===n.operand.length)return t.parent().addClass("errorSub"),!1;var o=e._params.rule;o.condictions=i(o.condictions,[].concat(e._params.subjects,n.operand)),e.trigger("updateRule",o,function(){e.trigger("updatePanelStatus",!0),e.trigger("viewRefresh"),r.notify(s.i18n.t("setting/msg_addSubjectSuccessful"))})},_handleDeleteContact:function(e){var t=this;c.getPabAttrs(e).then(function(e){e=e||[],r.each(e,function(e,n){delete t._params.existEmail[n["EMAIL;PREF"]];for(var i=n.groups,a=0,r=i.length;!0&&a!==r;a++)if("VIP"===i[a]){i.splice(a,1);break}}),c.updatePabContacts(e).then(function(){r.notify(s.i18n.t("pab/c_todel_success")),t.trigger("viewRefresh")})})},_handleDeleteSubject:function(e){r(e).parents("tr").remove();var t=this,n=t.$("[name=subjectListForm]").serializeJSON()||{},a=t._params.rule;a.condictions=i(a.condictions,n.operand),t.trigger("updateRule",a,function(){t.trigger("viewRefresh"),r.notify(s.i18n.t("setting/msg_subjectDelSuccessful"))})},_checkContactEdit:function(){this.$("[data-action=saveContact]").prop("disabled",!1)},_checkSubjectEdit:function(){this.$("[data-action=saveSubject]").prop("disabled",!1)},_checkInput:function(e){var t,n=this,i=n.$("#getMatchContacts"),a=i.val(),r=s.Email.parseAddress(a),o=!1;return i.parent().removeClass("error"),"ignoreEmpty"!==e||a?a?s.Email.test(r)?r===n.userEmail?(t=s.messageFormat.format(s.i18n.t("setting/msg_isSelfEmailErr_error"),n.userEmail),o=!0,n._handleEmailError(t,o),!1):n._params.existEmail[r]?(t=s.messageFormat.format(s.i18n.t("setting/msg_exist_error"),r),o=!0,n._handleEmailError(t,o),!1):(n._checkContactEdit(),!0):(t=s.messageFormat.format(s.i18n.t("setting/msg_errformat_error"),s.html.encode(a)),n._handleEmailError(t,o),!1):(t=s.i18n.t("setting/msg_emailNullErr"),n._handleEmailError(t,o),!1):(n._checkContactEdit(),!0)},_handleEmailError:function(e,t){var n=this,i=n.$("#getMatchContacts");i.parent().find(".error-tip").html(e),i.parent().addClass("error"),t&&i.val("")},_handleSubjectError:function(){var e=this,t=e._params.existSubjects,n=0,i=t.length,a=e.$("#subjectToAdd"),r=s.html.encode(a.val());if(a.parent().removeClass("errorSub"),!r)return a.parent().find(".error-tip").html(s.i18n.t("setting/msg_subjNullErr")),a.parent().addClass("errorSub"),!1;for(;!0&&n!==i;n++)if(t[n]===r)return a.parent().find(".error-tip").html(s.messageFormat.format(s.i18n.t("setting/msg_subjectExist_error"),r)),a.parent().addClass("errorSub"),a.val(""),!1;return!0},_getContacts:function(){var e=[];return this.$("#selectedContactsContainer :hidden").each(function(){e.push({id:r(this).val(),name:r(this).data("name"),addr:r(this).data("addr"),isOab:r(this).data("isoab"),isUser:!0})}),{contact:e}},_getGrpAddAndCreateIds:function(e){e=e||[];var t=[],n=[],i=[];return r.each(e,function(e,a){r(a).val()?r(a).data("isoab")?n.push(r(a).val()):i.push(r(a).val().toString()):t.push({FN:r(a).data("name"),"EMAIL;PREF":r(a).data("addr"),groups:["VIP"]})}),{createIds:t,addIds:{oIds:n,pIds:i}}}});u.module({name:"setting.filter.vip",template:e("text!template/module/setting/filter/vip/index.tpl.html")},h)}),define("components/requirejs-text/text!template/module/setting/folder/index.tpl.html",[],function(){return'<section class="m-sgaccount j-folder">\r\n\r\n  <nav class="nav u-tab u-tab-highlight-down">\r\n    <ul class="j-folder-nav">\r\n      <li data-trigger="folder.folder">\r\n        <span class="bar"></span>\r\n        <a href="javascript:void(0)">{{i18n \'setting/tab_folder\'}}</a>\r\n      </li>\r\n    </ul>\r\n  </nav>\r\n\r\n  <div class="content j-folder-content"></div>\r\n</section>\r\n\r\n'}),define("module/setting/folder/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","util/i18n","module/common/globalService","text!template/module/setting/folder/index.tpl.html"],function(e){function t(e,t){return i("<div>",{"data-panel":e.sid,"class":t+" u-scroll",style:"display:none",html:""})}function n(e,t){if(0==t.indexOf("setting.folder")){var n=t.substring("setting.".length);e.tabview.find(n)&&(c.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("cui/ui/tabview/tabview"),l=e("util/i18n"),c=e("module/common/globalService"),d=a.extend({Implements:s,activeTabId:"folder.folder",setup:function(){var e,t=this;t.state=c.getCurrentState(),e=t.state.module.split("."),t.activeTabId=e[2]?"folder."+e[2]:t.activeTabId,t.state.module="setting."+t.activeTabId,c.setCurrentState(t.state),t._setHistory(t.state)},render:function(){var e=this;d.superclass.render.call(e),e._initTabView(),e._initModuleEvent()},_initTabView:function(){var e=this,n=[{id:"folder.folder",title:l.t("setting.tab_personal"),module:r.module("setting.folder.folder")}];e.tabview=new o({element:"section.j-folder",classPrefix:"j-folder",activeTabId:e.activeTabId,activeTriggerClass:"z-current",onlyRenderActive:!0,generatePanelMarkup:t,tabs:n}),e.tabview.render(),e.tabview.on("render",function(t){e.activeTabId=t,e._setHistory({module:"setting."+t})}),e.tabview.on("refresh",function(t){e.activeTabId=t,e.sendMessage("dispatcher","view:refresh",{module:"setting."+t,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(t){var i=t.message.newState;n(e,i.module),"create"===i.param.panel&&e.sendMessage("setting.folder.folder","folder:create",null)})},_setHistory:function(e){var t=this,n=i.extend(!0,{},e);0===n.module.indexOf("setting.folder.")&&(n.param={},t.sendMessage("dispatcher","view:render",n))}});r.module({name:"setting.folder",template:e("text!template/module/setting/folder/index.tpl.html")},d)}),define("components/requirejs-text/text!template/module/setting/folder/folder/index.tpl.html",[],function(){return'<section class="m-userfolder">\r\n\r\n  <div class="main-wrapper">\r\n\r\n    <div class="content-wrapper">\r\n      <!---->\r\n      <section class="folder-list u-scroll">\r\n        <div class="u-btns-top">\r\n          <button type="button" class="u-btn u-btn-primary" data-action="createFolder">{{i18n "main/bt_createfolder"}}</button>\r\n          <button type="button" class="u-btn u-btn-default" data-action="importEML">{{i18n "setting/op_importMessage"}}</button>\r\n        </div>\r\n        <div class="j-folder-view"></div>\r\n        <div class="pop-folder-desc">\r\n          {{i18n "setting/msg_popFolderDeleteNotify"}}\r\n          <a data-action="deletePop" href="javascript:void(0);" class="link" > {{i18n "setting/tab_popaccount"}} </a>\r\n        </div>\r\n      </section>\r\n      <!---->\r\n      <section class="folder-usage"></section>\r\n    </div>\r\n\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask" />\r\n    <![endif]-->\r\n\r\n    <!---->\r\n    <section class="panel u-scroll create-panel"></section>\r\n    <!---->\r\n    <section class="panel u-scroll import-panel"></section>\r\n\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <!--  -->\r\n  <script type="text/x-handlebars-template" id="folderTpl">\r\n    [[#each sortedFolders]]\r\n    <table id="[[@key]]">\r\n      <thead>\r\n      <th nowrap class="f-tal">\r\n        <div class="f-csp" data-action="toggleFolder" data-target="[[@key]]" >\r\n          <i class="iconfont iconcollapse"></i>\r\n          <span>[[i18n "join:setting/lbl_" 0=@key]]</span>\r\n        </div>\r\n      </th>\r\n      <th width="150">{{i18n "main/h_newmsg"}}</th>\r\n      <th width="150">{{i18n "main/h_msgcnt"}}</th>\r\n      <th width="150">{{i18n "main/h_sizevalue"}}</th>\r\n      <th width="150">{{i18n "main/h_sizeratio"}}</th>\r\n      <th width="200" class="operation">{{i18n "main/h_operation"}}</th>\r\n      </thead>\r\n      <tbody>\r\n      [[#each this]]\r\n      <tr>\r\n        <td class="f-tal" style="padding-left:[[paddingLeft]]px">\r\n          [[#and lockedDefined auth2Locked]]\r\n          <div class="cnt f-ib"><i class="iconfont [[#if auth2unlocked]]iconunlock[[else]]iconlock[[/if]]"></i></div>\r\n          [[else]]\r\n          <div class="f-spc f-ib"></div>\r\n          [[/and]]\r\n          <a data-action="view" data-folder-id="[[id]]"> [[#if isPOP]] [[i18n "setting/lbl_POPFolder"]] [[/if]] [[name]]</a>\r\n        </td>\r\n        <td>\r\n          [[#compare unreadMessageCount \'>\' 0 ]]\r\n           <a data-action="view" data-filter="unread" data-folder-id="[[id]]" class="number">[[unreadMessageCount]]</a>\r\n          [[else]]\r\n           [[unreadMessageCount]]\r\n          [[/compare]]\r\n        </td>\r\n        <td> [[allMessageCount]]</td>\r\n        <td> [[messageSizeNormalized]]</td>\r\n        <td> [[percentage]]% </td>\r\n        <td class="operation" [[#if isPop]] data-type="pop" data-name="[[popAccount]]"[[/if]] >\r\n        [[#if isEnableCleanUp]]<a data-action="cleanup" data-folder-id="[[id]]" data-folder-name="[[name]]" >[[i18n "main/act_empty"]]</a>[[/if]]\r\n        [[#if isEnableDelete]]<a data-action="delete"  data-folder-id="[[id]]" data-folder-name="[[name]]" data-folder-msg="[[allMessageCount]]">[[i18n "main/act_delete"]]</a>[[/if]]\r\n        [[#if isEnableRename]]<a data-action="rename" data-folder-id="[[id]]" data-folder-name="[[name]]" >[[i18n "setting/op_act_rename"]]</a>[[/if]]\r\n        </td>\r\n      </tr>\r\n      [[/each]]\r\n      </tbody>\r\n    </table>\r\n    [[/each]]\r\n  </script>\r\n\r\n  <!-- -->\r\n  <script  type="text/x-handlebars-template" id="folderOverViewTpl">\r\n    <div class="folder-usage-overview">\r\n      <span class="overview-title">[[i18n "setting/lbl_folderUsage"]]:</span>\r\n      <span class="overview-item"><i class="square sys"></i>[[i18n "main/links_mboxSysFolder"]] [[sysFolder.size]]</span>\r\n      <span class="overview-item"><i class="square other"></i>[[i18n "main/links_mboxUserFolder"]] [[otherFolder.size]]</span>\r\n      <span class="overview-item"><i class="square unused"></i>[[i18n "setting/lbl_unusedSpace"]] [[unused.size]]</span>\r\n    </div>\r\n    <div class="folder-usage-capacity">\r\n      <i class="capacity-bar sys" style="width: [[sysFolder.percentage]]%"></i>\r\n      <i class="capacity-bar other" style="width: [[otherFolder.percentage]]%"></i>\r\n      <i class="capacity-bar unused" style="width: [[unused.percentage]]%"></i>\r\n    </div>\r\n  </script>\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="createFolderTpl">\r\n    <form action="#" name="createFolder" class="j-create-folder" onsubmit="return false">\r\n      <div class="u-btns-top">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="create">[[i18n "setting/op_confirm"]]</button>\r\n        <button type="reset" class="u-btn u-btn-default"  data-action="cancel">[[i18n "setting/op_cancel"]]</button>\r\n      </div>\r\n      <h4 class="sub-header">[[i18n "main/bt_createfolder"]]</h4>\r\n\r\n      <div class="u-form-item u-create-folder">\r\n        <label class="u-form-label f-mgr">[[i18n "setting/lbl_newFolderName"]]&nbsp; :</label>\r\n        <input type="text" class="u-input j-folder-name" name="name:string">\r\n        <div class="u-error-notify f-dn"></div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <label class="u-form-label f-mgr">[[i18n "setting/lbl_folderPos"]]&nbsp;:</label>\r\n        [[[folderOption folders \'parent\' limitFolderNestLevel]]]\r\n      </div>\r\n    </form>\r\n  </script>\r\n\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="importEMLTpl">\r\n    <form action="" id="uploadEMLForm">\r\n      <div class="u-btns-top">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="import">[[i18n "setting/op_confirm"]]</button>\r\n        <button type="reset" class="u-btn u-btn-default"  data-action="cancel">[[i18n "setting/op_cancel"]]</button>\r\n      </div>\r\n      <h4 class="sub-header">[[i18n "setting/lbl_importEML"]]</h4>\r\n\r\n      <div class="u-form-item">\r\n        <label class="u-form-label f-mgr f-cfn">[[i18n "setting/lbl_choseFolderName"]]:</label>\r\n        <div class="u-btn u-btn-primary fileSelector f-oh">\r\n          <label for="fileChoose">[[i18n "main/trsSelectFileBtn"]]</label>\r\n          <input type="file" id="fileChoose" name="files[]" accept="message/rfc822" multiple style="position: fixed; left: -9999px">\r\n        </div>\r\n        <div class="f-dn u-file-list " id="fileName"> </div>\r\n      </div>\r\n\r\n      <div class="u-form-item j-import-eml">\r\n        <label class="u-form-label f-mgr">[[i18n "setting/lbl_folderPos"]]&nbsp;:</label>\r\n        [[[folderOption folders \'fid\']]]\r\n      </div>\r\n    </form>\r\n\r\n  </script>\r\n\r\n  {{/raw}}\r\n\r\n</section>'}),define("module/setting/folder/folder/index",["require","i18n!setting,main,mbox","components/jquery-file-upload/js/jquery.fileupload","jquery","../../../../util/index","cui/core/view/view","cui/core/view/viewmanager","../../../../component/userauth2","cui/util/templatable/templatable","cui/util/history/hash","component/confirmbox","util/size","./../../service","./../../../mail/service","../../../common/globalService","i18n","configurable/index","text!template/module/setting/folder/folder/index.tpl.html"],function(e){function t(e,t){return(t.match(/\bswitched\S+/g)||[]).join(" ")}e("i18n!setting,main,mbox"),e("components/jquery-file-upload/js/jquery.fileupload");var n=e("jquery"),i=e("../../../../util/index"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("../../../../component/userauth2"),o=e("cui/util/templatable/templatable"),l=e("cui/util/history/hash"),c=e("component/confirmbox"),d=e("util/size"),u=e("./../../service"),p=e("./../../../mail/service"),m=e("../../../common/globalService"),h=e("i18n"),f=e("configurable/index"),v=a.extend({Implements:[o],events:{"click [data-action]":"_dispatchAction","change #fileChoose":"_updateFileList","focus .j-folder-name":"_removeErrorMsg","keyup .j-folder-name":"_handleCheckFolderName"},templateHelpers:{folderOption:function(e,t,a){var r=n("<select />",{name:t}).append(n("<option />").attr("value",0).text(i.i18n.t("main/fdr_root")));return n.each(e,function(e,t){r.append(n("<option />").attr("value",t.id).attr("disabled",a?t.deepLevel>=a:!1).text(new Array(t.deepLevel).join("")+i.html.encode(t.name)))}),r[0].outerHTML}},setup:function(){this.config=f("setting.folder"),this._param={folderData:null,flatFolders:null}},render:function(){v.superclass.render.call(this),this._initView(!0),this._initModuleEvent()},_dispatchAction:function(e,i){var a=n(i).data("action");switch(a){case"toggleFolder":this._handleToggleFolder(n(i));break;case"createFolder":this._handleSwitchToCreateFolder();break;case"importEML":this._handleSwitchToImportEML();break;case"cancel":this.$(".main-wrapper").removeClass(t);break;case"cleanup":this._handleCleanFolder(i);break;case"rename":this._handleRenameFolder(i);break;case"delete":this._handleDeleteFolder(i);break;case"create":this._handleCreateFolder();break;case"import":this._handleImportEML();break;case"view":this._handleViewFolder(i);break;case"deletePop":this._handleSwitchToPOP()}},_initView:function(e){var t=this;t.element.mask(),p.getFolders(!0,!1,!0).then(function(i){var a,r,s;t._param.folderData=t._processFolderData(i),a=t._sortAndFlatFolder(t._param.folderData),s=t.compile(t.$("#folderTpl").html(),{sortedFolders:a}),t.$(".j-folder-view").html(s),r=t._handleOverViewData(a),s=t.compile(t.$("#folderOverViewTpl").html(),r),t.$(".folder-usage").html(s),t.$("[data-action='create']").attr("disabled",t.config.folderCount>=t.config.limitFolderCount),!t.config.enableImportMessage&&t.$("[data-action='importEML']").hide(),e="boolean"===n.type(e)?e:!1,e&&"create"===m.getCurrentState().param.panel&&(m.setCurrentState({module:"setting.folder.folder",param:{}}),t.$("[data-action=createFolder]").click()),t.element.mask("hide")})},_sortAndFlatFolder:function(e){var t,i=[],a=[];return n.each(e,function(e,t){t.flags.system?a.push(t):i.push(t)}),t={sysFolder:this._flatFolders(a),otherFolder:this._flatFolders(i)},this._param.flatFolders=[].concat(t.sysFolder,t.otherFolder),t},_processFolderData:function(e,t,i){var a=this,r=this.config.limitMessageSize,s=m.getFolderLockedStatus();return n.each(e,function(e,o){n.extend(o,{parent:t,fullPath:i?i+"/"+o.id:o.id,auth2unlocked:s.isAuth,lockedDefined:s.lockedDefined,useThread:p.isExpandThreadMid(o.id),auth2Locked:a.config.secretFolder&&-1!=n.inArray(""+o.id,a.config.secretFolder),percentage:(o.stats.messageSize/r*100).toFixed(1),messageSizeNormalized:d.bytesToSize(o.stats.messageSize,2),hasChild:!!o.children}),o.deepLevel="string"===n.type(o.fullPath)?o.fullPath.split("/").length:1,o.paddingLeft=25*(o.deepLevel-1),o.unreadMessageCount=o.useThread?o.stats.unreadThreadCount:o.stats.unreadMessageCount,o.allMessageCount=o.useThread?o.stats.threadCount:o.stats.messageCount,o.isEnableCleanUp=a.config.enableFolderModify&&(o.flags.system?o.stats.messageSize>0&&o.id>3:o.stats.messageSize>0),o.isEnableRename=!o.flags.system,o.isEnableDelete=!o.hasChild&&!o.flags.system&&!o.isPop&&a.config.enableFolderModify,o.children&&a._processFolderData(o.children,o.id,o.fullPath)}),e},_flatFolders:function(e){var t=[],i=this;return e=n.extend(!0,[],e),n.each(e,function(e,n){var a;t.push(n),n.children&&(a=n.children,delete n.children,t=t.concat(i._flatFolders(a)))}),t},_handleOverViewData:function(e){var t=this,i={},a=0,r=this.config.limitMessageSize,s=t.config.messageSize;return n.each(e,function(e,t){var s,o=0;n.each(t,function(e,t){o+=t.stats.messageSize}),s=.005>o/r?.005:+(o/r).toFixed(3),a+=s,i[e]={size:d.bytesToSize(o),percentage:100*s}}),a=+a.toFixed(3),n.extend(i,{unused:{size:d.bytesToSize(r-s),percentage:100*(1-a)}}),i},_initModuleEvent:function(){var e=this;this.onMessage("folder:refresh",function(){e._initView()}),this.onMessage("folder:create",function(){e.$("[data-action=createFolder]").click()})},_handleToggleFolder:function(e){this.$("#"+e.data("target")+">tbody").toggle(),e.find("i").toggleClass("iconunfold iconcollapse")},_handleSwitchToCreateFolder:function(){var e=this.compile(this.$("#createFolderTpl").html(),{folders:this._param.flatFolders,limitFolderNestLevel:this.config.limitFolderNestLevel});this.$(".create-panel").html(e),this.$(".main-wrapper").removeClass(t).addClass("switched-create")},_updateFileList:function(e){var t=n(e.target).val().replace(/^.*[\\\/]/,""),i=this;if(e.target.files){var a=e.target.files,r="";n.each(a,function(e,t){i._checkFileSuffix(t.name)&&(r+="<p>"+t.name+"</p>")}),i.$("#fileName").html(r).show()}else this._checkFileSuffix(t)&&this.$("#fileName").html(n("<p>",{text:t})).show()},_checkFileSuffix:function(e){var t;return t=e.substring(e.lastIndexOf(".")+1).toLowerCase(),"eml"!==t?(c.alert(i.messageFormat.format(h.t("setting/msg_uploadTypeError"),e)),!1):!0},_handleSwitchToImportEML:function(){var e=this.compile(this.$("#importEMLTpl").html(),{folders:this._param.flatFolders});this.$(".import-panel").html(e),this.$(".main-wrapper").removeClass(t).addClass("switched-import")},_handleRenameFolder:function(e){var t,i=this,a=n(e).data("folder-id"),r=n(e).data("folder-name"),s="<div class='diaglog-item'><label class='label'>{{i18n 'setting/msg_inputFolderName'}}</label><input type='text' class='u-input' style='padding:2px 4px' value= {{name}} name='newFolderName'/></div>";t=this.compile(s,{name:r}),c.confirm(t,function(){var e,t=n("input[name='newFolderName']").val(),r=u.isValidString(t);return"valid"!==r?(n.notify.error(h.t("setting/msg_err_folder_"+r)),!1):void u.updateFolders([{id:a,name:t}]).then(function(t){switch(t.code){case"FA_NAME_RESERVED":case"FA_NAME_EXISTS":case"FA_NAME_INVALID":e=t.code.substring("FA_".length),n.notify.error(h.t("main/err_folder_"+e));break;case"S_OK":n.notify(h.t("setting/msg_renameFolderSuccess")),i.sendMessage("mail","folder:refresh",{type:"all"}),i.sendMessage("setting.account.auth2lock","folder:refresh"),i._initView()}})})},_handleCreateFolder:function(){var e,i=this,a=this.$(".j-create-folder").serializeJSON({parseNumbers:!0}),r=u.isValidString(a.name);"valid"===r?u.createFolders([a]).then(function(a){switch(a.code){case"FA_NAME_RESERVED":case"FA_NAME_EXISTS":case"FA_NAME_INVALID":e=a.code.substring("FA_".length),n.notify.error(h.t("main/err_folder_"+e));break;case"FA_OVERFLOW":n.notify.error(h.t("setting/msg_err_folder_FA_OVERFLOW"));break;case"S_OK":n.notify.success(h.t("setting/msg_createFolderSuccess")),i._initView(),i.sendMessage("mail","folder:refresh",{message:{ids:a["var"]}}),i.sendMessage("setting.security.auth2lock","folder:refresh"),i.$(".main-wrapper").removeClass(t)}}):this.$(".u-create-folder").addClass("error").find(".u-error-notify").html(h.t("setting/msg_err_folder_"+r))},_handleCheckFolderName:function(e){var t=u.isValidString(n(e.target).val()),i=this.$(".u-create-folder");"valid"!==t?i.addClass("error").find(".u-error-notify").html(h.t("setting/msg_err_folder_"+t)):i.removeClass("error")},_removeErrorMsg:function(){this.$(".u-create-folder").removeClass("error")},_handleImportEML:function(){var e=this.$("#uploadEMLForm").serializeJSON({parseNumbers:!0}),i=this.$("#fileChoose"),a=this;u.importEMLToFolder(e.fid,i).then(function(e){"S_OK"==e.code?(n.notify.success(h.t("setting/msg_uploadEMLSuccess")),a._initView(),a.$(".main-wrapper").removeClass(t)):n.notify.error(h.t("setting/msg_uploadEMLFailed"))})},_handleDeleteFolder:function(e){var t=this,a=n(e).parent(),r=n(e).data("folder-id"),o=n(e).data("folder-msg"),l=i.html.encode(n(e).data("folder-name")),d=m.getFolderLockedStatus().isAuth,p=-1!==n.inArray(""+r,this.config.secretFolder);if("pop"!=a.data("type")){if(p&&!d)return s.box({successCb:function(){n(e).click()}}),!1;o>0?c.confirm(i.messageFormat.format(h.t("setting/msg_comfirmEmptyAndRemoveFolder"),l),function(){u.doEmptyFolder(r).then(function(){u.deleteFolders([r]).then(function(e){"S_OK"===e.code?(n.notify.success(i.messageFormat.format(h.t("setting/msg_deleteFolderSucceess"),l)),t._initView(),t.sendMessage("mail","folder:refresh",{type:"all"}),t.sendMessage("setting.account.auth2lock","folder:refresh",null)):n.notify.error(i.messageFormat.format(h.t("setting/msg_deleteFolderFail"),l))})})}):c.confirm(i.messageFormat.format(h.t("setting/msg_comfirmRemoveFolder"),l),function(){u.deleteFolders([r]).then(function(e){"S_OK"==e.code?(n.notify.success(i.messageFormat.format(h.t("setting/msg_deleteFolderSucceess"),l)),t._initView(),t.sendMessage("mail","folder:refresh",{type:"all"}),t.sendMessage("setting.account.auth2lock","folder:refresh",null)):n.notify.error(i.messageFormat.format(h.t("setting/msg_deleteFolderFail"),l))})})}else n.notify.error(i.messageFormat.format(h.t("main/err_folder_delPopFolder"),a.data("name")))},_handleCleanFolder:function(e){var t=this,a=n(e).data("folder-id"),r=i.html.encode(n(e).data("folder-name")),o=m.getFolderLockedStatus().isAuth,l=-1!=n.inArray(""+a,this.config.secretFolder);return l&&!o?(s.box({successCb:function(){n(e).click()}}),!1):void c.confirm(i.messageFormat.format(h.t("main/confirm_clean"),r),function(){u.doEmptyFolder(a).then(function(){n.notify.success(h.t("mbox/empty_folder_succ")),t._initView()})})},_handleViewFolder:function(e){var t=n(e).data("folder-id"),i=n(e).data("filter"),a={module:this.config.previewLayout?"mail.previewlayout":"mail.list",param:{fid:t}};a.param.historyUrl=l.stringifyHash(a),this.config.previewLayout&&(a.param.layout=parseInt(this.config.previewLayout)),i&&(a.param.filterFlags={read:!1}),this.sendMessage("dispatcher","history:add",a)},_handleSwitchToPOP:function(){var e={module:"setting.advance.pop",param:{}};m.setCurrentState(e),this.sendMessage("dispatcher","history:add",e)}});r.module({name:"setting.folder.folder",template:e("text!template/module/setting/folder/folder/index.tpl.html")},v)}),define("components/requirejs-text/text!template/module/setting/security/index.tpl.html",[],function(){return'<section class="m-slsecurity j-security">\n  <nav class="nav u-tab u-tab-highlight-down">\n    <ul class="j-security-nav"></ul>\n  </nav>\n\n  <div class="j-security-content content"></div>\n\n    {{#raw}}\n    <script type="x-handlebars-template" id="securityTabTpl">\n\n      <li data-trigger="security.whitelist">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">[[i18n "pref/whitelist"]]</a>\n      </li>\n\n      <li data-trigger="security.blacklist">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">[[i18n "pref/blacklist"]]</a>\n      </li>\n\n      [[#if supportAntivirus]]\n      <li data-trigger="security.antivirus">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">[[i18n "pref/antivirus"]]</a>\n      </li>\n      [[/if]]\n\n      <li data-trigger="security.junkfilter">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">[[i18n "pref/junklevel"]]</a>\n      </li>\n\n      [[#if enableAuth2lock]]\n      <li data-trigger="security.auth2lock">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">{{i18n "setting/tab_auth2lock"}}</a>\n      </li>\n      [[/if]]\n\n      [[#if enableJunkNotify]]\n      <li data-trigger="security.junknotify">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">[[i18n "pref/junkNotify"]]</a>\n      </li>\n      [[/if]]\n\n      [[#if supportOffSiteRemindStatus]]\n      <li data-trigger="security.offsiteremind">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">[[i18n "pref/offSiteRemind"]]</a>\n      </li>\n      [[/if]]\n\n      [[#if supportSMIMEServer]]\n      <li data-trigger="security.smime">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">[[i18n "pref/smime"]]</a>\n      </li>\n      [[/if]]\n\n      [[#if supportTwoFactorAuth]]\n      <li data-trigger="security.twofactorauth">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">{{i18n "setting/tab_twofactorauth"}}</a>\n      </li>\n      [[/if]]\n\n      [[#if supportAuthorizedDevice]]\n      <li data-trigger="security.logindevices">\n        <span class="bar"></span>\n        <a href="javascript:void(0)">{{i18n "setting/tab_logindevices"}}</a>\n      </li>\n      [[/if]]\n\n  </script>\n  {{/raw}}\n</section>\n'}),define("module/setting/security/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tabview/tabview","util/i18n","module/common/globalService","configurable/index","text!template/module/setting/security/index.tpl.html"],function(e){function t(e,t){return i("<div>",{"data-panel":e.sid,"class":t+" u-scroll",style:"display:none",html:""})}function n(e,t){if(0===t.indexOf("setting.security.")){var n=t.substring("setting.".length);e.tabview.find(n)&&(c.setCurrentState({module:t}),e.tabview.switchTo(n))}}e("util/i18n!setting,pref");var i=e("jquery"),a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("cui/ui/tabview/tabview"),l=e("util/i18n"),c=e("module/common/globalService"),d=e("configurable/index"),u=a.extend({Implements:s,activeTabId:"security.junkfilter",setup:function(){this.config=d("setting.security",this),this.state=c.getCurrentState();var e=this.state.module.split(".");this.activeTabId=e[2]?"security."+e[2]:this.activeTabId,this.state.module="setting."+this.activeTabId,c.setCurrentState(this.state),this._setHistory(this.state)},render:function(){u.superclass.render.call(this),this._initTabView(),this._initModuleEvent()},_initTabView:function(){var e,n=this;e=n.compile(n.$("#securityTabTpl").html(),this.config),n.$(".j-security-nav").html(e);var i=[{id:"security.blacklist",title:l.t("pref.blacklist"),module:r.module("setting.security.blacklist")},{id:"security.whitelist",title:l.t("pref.whitelist"),module:r.module("setting.security.whitelist")},{id:"security.junkfilter",title:l.t("pref.junklevel"),module:r.module("setting.security.junkfilter")}];this.config.enableJunkNotify&&i.push({id:"security.junknotify",title:l.t("pref.junkNotify"),module:r.module("setting.security.junknotify")}),this.config.supportOffSiteRemindStatus&&i.push({id:"security.offsiteremind",title:l.t("pref.offSiteRemind"),module:r.module("setting.security.offsiteremind")}),this.config.supportAntivirus&&i.push({id:"security.antivirus",title:l.t("pref.antivirus"),module:r.module("setting.security.antivirus")}),this.config.enableAuth2lock&&i.push({id:"security.auth2lock",title:l.t("setting.tab_auth2lock"),module:r.module("setting.security.auth2lock")}),this.config.supportTwoFactorAuth&&i.push({id:"security.twofactorauth",title:l.t("setting.tab_twofactorauth"),module:r.module("setting.security.twofactorauth")}),this.config.supportAuthorizedDevice&&i.push({id:"security.logindevices",title:l.t("setting.tab_logindevices"),module:r.module("setting.security.logindevices")}),this.config.supportSMIMEServer&&i.push({id:"security.smime",title:l.t("pref.smime"),module:r.module("setting.security.smime")}),n.tabview=new o({element:"section.j-security",classPrefix:"j-security",activeTabId:n.activeTabId,activeTriggerClass:"z-current",onlyRenderActive:!0,generatePanelMarkup:t,tabs:i}),n.tabview.render(),n.tabview.on("render",function(e){n.activeTabId=e,n._setHistory({module:"setting."+e})}),n.tabview.on("refresh",function(e){n.activeTabId=e,n.sendMessage("dispatcher","view:refresh",{module:"setting."+e,param:{}})})},_initModuleEvent:function(){var e=this;e.subscribe("dispatcher","url:changed",function(t){var i=t.message.newState;n(e,i.module)})},_setHistory:function(e){var t=this,n=i.extend(!0,{},e);0===n.module.indexOf("setting.security.")&&(n.param={},t.sendMessage("dispatcher","view:render",n))}});r.module({name:"setting.security",template:e("text!template/module/setting/security/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/security/antivirus/index.tpl.html",[],function(){return'<section class="m-antivirus">\r\n\r\n  <form action="#" name="antivirus"></form>\r\n\r\n  <script type="text/x-handlebars-template" id="avInfoTpl">\r\n      {{#raw}}\r\n      <div class="u-btns-top">\r\n          <button type="button"  class="u-btn u-btn-primary" id="saveAntivirus" disabled>[[i18n "setting/op_save"]]</button>\r\n          <button type="reset" class="u-btn u-btn-default"  id="resetAntivirus" >[[i18n "setting/op_cancel"]]</button>\r\n      </div>\r\n\r\n      <div class="title dotted">\r\n          <h4>[[i18n "pref/antivirus/mothod"]]</h4>\r\n      </div>\r\n      <div class="f-pdl">\r\n          <p class="items">\r\n              <label for="active_1" class="j-av-active">\r\n                <input type="radio" id="active_1" name="active" value="true" [[#if active ]] checked [[/if]] />\r\n                [[i18n "pref/antivirus/scan"]]\r\n              </label>\r\n          </p>\r\n          <p class="items">\r\n              <label for="active_0" class="j-av-active">\r\n                <input type="radio" id="active_0" name="active" value="false" [[#unless active ]] checked [[/unless]] />\r\n                [[i18n "pref/antivirus/discard"]]\r\n              </label>\r\n          </p>\r\n      </div>\r\n      <!---->\r\n      <div class="disable-mask [[#if active]] f-dn [[/if]]"></div>\r\n\r\n      <div class="j-virus-process">\r\n          <div class="title dotted">\r\n              <h4>[[i18n "pref/antivirus/action"]]</h4>\r\n          </div>\r\n          <div class="f-pdl">\r\n              <h4 class="sub-title">[[i18n "pref/antivirus/whenkillok"]]</h4>\r\n              <div class="f-pdl">\r\n                  <p class="items">\r\n                      <label >\r\n                          <input type="radio" name="strategy[succeed]" value="clean" [[#compare strategy.succeed \'==\' \'clean\']] checked [[/compare]]> &nbsp;[[[i18n "prop:pref/antivirus/killandmark" 0="<span class=\'state-icon icon-avsCLEANED\'></span>"]]]\r\n                      </label>\r\n                  </p>\r\n                  <p class="items">\r\n                      <label>\r\n                          <input type="radio" name="strategy[succeed]" value="quarantine" [[#compare strategy.succeed \'==\' \'quarantine\']] checked[[/compare]]>&nbsp; [[i18n "prop:pref/antivirus/move" 0=virusfoldername]]\r\n                      </label>\r\n                  </p>\r\n                  <p class="items">\r\n                      <label>\r\n                          <input type="radio" name="strategy[succeed]" value="delete" [[#compare strategy.succeed \'==\' \'delete\']] checked [[/compare]]>&nbsp; [[i18n "pref/antivirus/drop"]]\r\n                      </label>\r\n                  </p>\r\n              </div>\r\n\r\n              <h4 class="sub-title">[[i18n "pref/antivirus/whenkillfail"]]</h4>\r\n              <div class="f-pdl">\r\n                  <p class="items">\r\n                      <label>\r\n                          <input type="radio" name="strategy[failed]" value="clean" [[#compare strategy.failed \'==\' \'clean\']]checked[[/compare]]> &nbsp;[[[i18n "prop:pref/antivirus/attandmark" 0="<span class=\'state-icon icon-avsINFECTED\'></span>"]]]\r\n                      </label>\r\n                  </p>\r\n                  <p class="items">\r\n                      <label>\r\n                          <input type="radio" name="strategy[failed]" value="quarantine" [[#compare strategy.failed \'==\' \'quarantine\']]checked[[/compare]]> &nbsp;[[i18n "prop:pref/antivirus/move" 0=virusfoldername]]\r\n                      </label>\r\n                  </p>\r\n                  <p class="items">\r\n                      <label>\r\n                          <input type="radio" name="strategy[failed]" value="delete" [[#compare strategy.failed \'==\' \'delete\']]checked[[/compare]]>&nbsp;[[i18n "pref/antivirus/drop"]]\r\n                      </label>\r\n                  </p>\r\n              </div>\r\n\r\n               <h4 class="sub-title">[[i18n "pref/antivirus/whennotsure"]]</h4>\r\n               <div class="f-pdl">\r\n                   <p class="items">\r\n                       <label>\r\n                           <input type="radio" name="strategy[undetermined]" value="clean" [[#compare strategy.undetermined \'==\' \'clean\']]checked[[/compare]]> &nbsp;[[[i18n "prop:pref/antivirus/marknotsure" 0="<span class=\'state-icon icon-avsUNDETERMINED\'></span>"]]]\r\n                       </label>\r\n                   </p>\r\n                  <p class="items">\r\n                    <label>\r\n                      <input type="radio" name="strategy[undetermined]" value="quarantine" [[#compare strategy.undetermined \'==\' \'quarantine\']]checked[[/compare]]>&nbsp;[[i18n "prop:pref/antivirus/move" 0=virusfoldername]]\r\n                    </label>\r\n                  </p>\r\n                  <p class="items">\r\n                    <label>\r\n                      <input type="radio" name="strategy[undetermined]" value="delete" [[#compare strategy.undetermined \'==\' \'delete\']]checked[[/compare]]>&nbsp;[[i18n "pref/antivirus/drop"]]\r\n                    </label>\r\n                  </p>\r\n               </div>\r\n          </div>\r\n\r\n          <div class="title dotted">\r\n               <h4>[[i18n "pref/antivirus/notifyme"]]</h4>\r\n          </div>\r\n          <div class="f-pdl">\r\n              <p class="items">\r\n                  <label>\r\n                    <input type="checkbox" name="notifyUser" id="notifyUser" value="true" [[#compare notifyUser \'==\' true]]checked[[/compare]]> &nbsp;[[i18n "pref/antivirus/notifyme_y"]]([[i18n "pref/antivirus/notifyme_tips"]])\r\n                  </label>\r\n              </p>\r\n          </div>\r\n\r\n          <div class="title dotted">\r\n               <h4>[[i18n "pref/antivirus/notifysender"]]</h4>\r\n          </div>\r\n          <div class="f-pdl">\r\n              <p class="items">\r\n                <label>\r\n                  <input type="checkbox" name="notifySender" id="notifySender" value="true" [[#compare notifySender \'==\' true]]checked[[/compare]]>&nbsp; [[i18n "pref/antivirus/notifysender_y"]] ([[i18n "pref/antivirus/notifysender_tips"]] )\r\n                </label>\r\n              </p>\r\n          </div>\r\n      </div>\r\n    {{/raw}}\r\n  </script>\r\n</section>\r\n';
}),define("module/setting/security/antivirus/index",["require","i18n!setting,pref/antivirus","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","module/common/globalService","./../../service","i18n","text!template/module/setting/security/antivirus/index.tpl.html"],function(e){e("i18n!setting,pref/antivirus");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("module/common/globalService"),s=e("./../../service"),o=e("i18n"),l=n.extend({Implements:a,setup:function(){this.cache={}},events:{"click label.j-av-active":"_handleAntiToggle","click #saveAntivirus":"_handleSaveAntiVirus","click #resetAntivirus":"_genernateView","click label":"_checkUserEdit"},render:function(){l.superclass.render.call(this),this._initView(!0)},_initView:function(e){e=e||!1;var n=this;e?(n.element.mask(),t.when(s.getAVInfo()).then(function(e){n.cache.antiSet=e,n.cache.antiSet.virusfoldername=r.getConfig("setting.virusfoldername"),n._genernateView(),n.element.mask("hide")})):n._genernateView()},_genernateView:function(){var e=this,t=e.compile(e.$("#avInfoTpl").html(),e.cache.antiSet);e.$("form[name='antivirus']").html(t).data("change",!1),e.cache.antiSet.active||e.$("input").not("input[name='active']").attr("disabled",!0),e.element.customRadioCheckbox()},_checkUserEdit:function(e){var n=t(e.target).parents("form");n.data("change")||(n.find("#saveAntivirus").prop("disabled",!1),n.data("change",!0))},_handleAntiToggle:function(e,n){var i=this,a=t(n);"true"==a.find("input").val()?(i.$(".j-virus-process input").attr("disabled",!1),i.$(".j-virus-process i").removeClass("rc-disabled"),i.$(".disable-mask").hide()):(i.$(".j-virus-process input").attr("disabled",!0),i.$(".j-virus-process i").addClass("rc-disabled"),i.$(".disable-mask").show())},_handleSaveAntiVirus:function(){var e=this,n=e.$("form[name='antivirus']").serializeJSON({parseBooleans:!0});s.saveAVInfo(n).then(function(){t.extend(e.cache.antiSet,n),t.notify.success(o.t("pref/antivirus/successMod"))})}});i.module({name:"setting.security.antivirus",template:e("text!template/module/setting/security/antivirus/index.tpl.html")},l)}),define("components/requirejs-text/text!template/module/setting/security/auth2lock/index.tpl.html",[],function(){return'<section class="m-auth2lock">\r\n    <div class="main-wrapper">\r\n        <div class="content-wrapper grid-col12">\r\n            <!---->\r\n            <div class="auth2lock-content"></div>\r\n        </div>\r\n\r\n        <!--[if lt IE 9]>\r\n        <div class="sg-mask" />\r\n        <![endif]-->\r\n\r\n        <!--  -->\r\n        <div class="panel u-scroll edit-panel">\r\n            <form action="#" name="changeLockPwd" method="post">\r\n                <div class="u-btns-top">\r\n                    <button type="button" data-action="changeLockPwd" class="u-btn u-btn-primary j-btn-error">{{i18n "setting/op_confirm"}}</button>\r\n                    <button type="reset"  data-action="cancel" class="u-btn u-btn-default">{{i18n "setting/op_cancel"}}</button>\r\n                </div>\r\n                <h4 class="sub-header">{{i18n "pref/personal/auth2password"}}</h4>\r\n                <div class="u-form-item">\r\n                    <div class="f-fl">\r\n                        <label class="u-form-label f-mgr">{{i18n "setting/lbl_curPassword"}}</label>\r\n                    </div>\r\n                    <div class="u-form-value">\r\n                        <input type="password" name="old_password" class="u-input f-mgr">\r\n                        <span class="notify f-dn f-mgr">{{i18n "pref/personal/FA_PASSWORD_ERR"}}</span>\r\n                        <i class="iconfont iconchoose f-dn"></i>\r\n                    </div>\r\n                </div>\r\n                <div class="u-form-item">\r\n                    <div class="f-fl">\r\n                        <label class="u-form-label f-mgr">{{i18n "setting/lbl_newPassword"}}</label>\r\n                    </div>\r\n                    <div class="u-form-value">\r\n                        <input type="password" name="password" class="u-input" value="">\r\n                    </div>\r\n                </div>\r\n                <div class="u-form-item">\r\n                    <div class="f-fl">\r\n                        <label class="u-form-label f-mgr">{{i18n "setting/lbl_confirmPassword"}}</label>\r\n                    </div>\r\n                    <div class="u-form-value">\r\n                        <input type="password" name="repass" class="u-input" value="">\r\n                        <span class="notify f-dn">{{i18n "setting/msg_authPwdNotSame"}}</span>\r\n                    </div>\r\n                </div>\r\n            </form>\r\n        </div>\r\n\r\n        <!-- -->\r\n        <div class="panel u-scroll range-panel">\r\n            <form action="#" name="lockRange" method="post">\r\n                <div class="u-btns-top">\r\n                    <button type="button" data-action="updateRange" class="u-btn u-btn-primary j-btn-error">{{i18n "setting/op_confirm"}}</button>\r\n                    <button type="reset"  data-action="cancel"   class="u-btn u-btn-default">{{i18n "setting/op_cancel"}}</button>\r\n                </div>\r\n            <h4 class="sub-header">{{i18n "setting/lbl_authLockRangeEdit"}}</h4>\r\n            <div class="u-form-item">\r\n                <div class="f-fl">\r\n                    <label class="u-form-label f-mgr">{{i18n "pref/personal/auth2password"}}&nbsp;:</label>\r\n                </div>\r\n                <div class="u-form-value">\r\n                    <input type="password" name="current_password" class="u-input f-mgr">\r\n                    <i class="iconfont iconchoose f-dn" ></i>\r\n                    <span class="notify f-dn">{{i18n "pref/personal/FA_PASSWORD_ERR"}}</span>\r\n                </div>\r\n            </div>\r\n\r\n            <div class="u-form-item">\r\n                <div class="f-fl">\r\n                    <label class="u-form-label f-mgr"><i class="u-img icon-lock-type icon-tools"></i>{{i18n "setting/lbl_authLockOperations"}}&nbsp;:</label>\r\n                </div>\r\n                <div class="u-form-value j-protect-operations"></div>\r\n            </div>\r\n\r\n            <div class="u-form-item">\r\n                <div class="f-fl">\r\n                  <label class="u-form-label f-mgr"><i class="u-img icon-lock-type icon-folder"></i>{{i18n "setting/lbl_authLockRange"}}&nbsp;:</label>\r\n                </div>\r\n                <div class="u-form-value j-folder-tree"></div>\r\n            </div>\r\n\r\n          </form>\r\n        </div>\r\n\r\n        <!---->\r\n        <div class="panel u-scroll off-panel">\r\n            <form action="#" name="closeLock" method="post">\r\n                <div class="u-btns-top">\r\n                    <button type="button" data-action="disableLock" class="u-btn u-btn-primary">{{i18n "setting/op_confirm"}}</button>\r\n                    <button type="reset"  data-action="cancel" class="u-btn u-btn-default j-lock-reset">{{i18n "setting/op_cancel"}}</button>\r\n                </div>\r\n                <h4 class="sub-header">{{i18n "pref/personal/close_lock"}}</h4>\r\n                <p class="u-lbl-disable-lock-tip">{{i18n "setting/lbl_disableLock_desc"}}</p>\r\n                <div class="u-form-item">\r\n                    <label class="u-form-label f-mgr">{{i18n "pref/personal/auth2password"}}&nbsp;:</label>\r\n                    <input type="password" class="u-input f-mgr j-disable-lock-input" name="current_password" />\r\n                    <span class="notify f-dn f-mgr">{{i18n "pref/personal/FA_PASSWORD_ERR"}}</span>\r\n                    <i class="iconfont iconchoose f-dn"></i>\r\n                </div>\r\n            </form>\r\n        </div>\r\n        <!---->\r\n        <div class="panel u-scroll on-panel">\r\n            <form action="#" name="lockEnable" method="post">\r\n            <div class="u-btns-top">\r\n              <button type="button" data-action="lockEnable" class="u-btn u-btn-primary">{{i18n "setting/op_confirm"}}</button>\r\n              <button type="reset"  data-action="cancel" class="u-btn u-btn-default j-lock-reset" >{{i18n "setting/op_cancel"}}</button>\r\n            </div>\r\n\r\n            <h4 class="sub-header">{{i18n "setting/lbl_authLock"}}</h4>\r\n            <p class="u-lock-enable-tip">{{i18n "setting/lbl_authLock_enable_tip"}}</p>\r\n            <div class="u-form-item">\r\n              <div class="f-fl">\r\n                <label class="u-form-label f-mgr">{{i18n "pref/personal/auth2password"}}&nbsp;:</label>\r\n              </div>\r\n              <div class="u-form-value">\r\n                <input type="password" name="password" class="u-input f-mgr">\r\n                <i class="iconfont iconchoose f-dn">{{i18n "pref/personal/auth2password"}}</i>\r\n              </div>\r\n            </div>\r\n\r\n            <div class="u-form-item">\r\n              <div class="f-fl">\r\n                <label class="u-form-label f-mgr">{{i18n "pref/personal/set_pwd_again"}}&nbsp;:</label>\r\n              </div>\r\n              <div class="u-form-value">\r\n                <input type="password" name="repass" class="u-input f-mgr">\r\n                <span class="notify f-dn">{{i18n "setting/msg_authPwdNotSame"}}</span>\r\n              </div>\r\n            </div>\r\n\r\n            <h4 class="sub-header">{{i18n "setting/lbl_authLockRangeEdit"}}</h4>\r\n            <div class="u-form-item">\r\n                <div class="f-fl">\r\n                    <label class="u-form-label f-mgr"><i class="u-img icon-lock-type icon-tools"></i>{{i18n "setting/lbl_authLockOperations"}}&nbsp;:</label>\r\n                </div>\r\n                <div class="u-form-value j-protect-operations">\r\n\r\n                </div>\r\n            </div>\r\n            <div class="u-form-item">\r\n              <div class="f-fl">\r\n                  <label class="u-form-label f-mgr"><i class="u-img icon-lock-type icon-folder"></i>{{i18n "setting/lbl_authLockRange"}}&nbsp;:</label>\r\n              </div>\r\n              <div class="u-form-value j-folder-tree">\r\n\r\n              </div>\r\n            </div>\r\n          </form>\r\n        </div>\r\n  </div>\r\n\r\n\r\n  {{#raw}}\r\n    <!-- -->\r\n    <script type="text/x-handlebars-template" id="opsTreeTpl" >\r\n        <ul class="f-fl tree">\r\n            [[#each lockOpInfo]]\r\n            <li>\r\n                <input type="checkbox" name="lockItem3[]" [[#if selected]] checked [[/if]] value=\'[[val]]\'/>\r\n                <div class="j-lock-item f-ib f-csp">[[lbl]]</div>\r\n            </li>\r\n            [[/each]]\r\n        </ul>\r\n    </script>\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="folderTreeTpl" >\r\n      <ul class="tree f-fl">\r\n          <!---->\r\n          <li>\r\n              <input type="checkbox" id="chkAllSyFolders" class="j-check-all"/>\r\n              <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[i18n "pref/personal/sysfolder"]]</div>\r\n          </li>\r\n          <li class="parent-node">\r\n              <ul>\r\n                  [[#each sysFolders]]\r\n                  <li>\r\n                      <input type="checkbox" name="lockItem1[]" class="j-check-sub  [[#if children]] j-check-all [[/if]]" [[#if selected]] checked [[/if]]  value=\'[[id]]\'/>\r\n                      <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[name]]</div>\r\n                  </li>\r\n                  [[#if children]]\r\n                  <ul>\r\n                      [[#each children]]\r\n                      <li>\r\n                          <input type="checkbox" name="lockItem2[]" class="j-check-sub" [[#if selected]] checked[[/if]] value=\'[[id]]\'/>\r\n                          <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[name]]</div>\r\n                      </li>\r\n                      [[/each]]\r\n                  </ul>\r\n                  [[/if]]\r\n                  [[/each]]\r\n              </ul>\r\n          </li>\r\n      <!---->\r\n      [[#if netDiskFolderInfo.ispermitnf]]\r\n      <li>\r\n          <input type="checkbox" name="lockItem1[]" value="nf:[[netDiskFolderInfo.id]]"\r\n                 [[#if netDiskFolderInfo.selected]] checked[[/if]]/>\r\n          <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[i18n "pref/personal/netfolder"]]</div>\r\n      </li>\r\n      [[/if]]\r\n\r\n      <!---->\r\n      <li>\r\n          [[#compare otherFolders.length "==" 0]]\r\n          <input type="checkbox" id="chkallUserFolders" class="j-check-all" disabled/>\r\n          <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[i18n "setting/lbl_user_folder"]][[i18n "setting/lbl_lack"]]</div>\r\n          [[else]]\r\n          <input type="checkbox" id="chkallUserFolders" class="j-check-all"/>\r\n          <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[i18n "setting/lbl_user_folder"]]</div>\r\n          [[/compare]]\r\n      </li>\r\n      <li class="parent-node">\r\n          <ul>\r\n              [[#each otherFolders]]\r\n              <li>\r\n                  <input type="checkbox" name="lockItem1[]" class="j-check-sub [[#if children]] j-check-all [[/if]]" [[#if selected]] checked [[/if]]  value=\'[[id]]\'/>\r\n                  <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[name]]</div>\r\n              </li>\r\n              [[#if children]]\r\n              <ul>\r\n                  [[#each children]]\r\n                  <li>\r\n                      <input type="checkbox" name="lockItem2[]" class="j-check-sub" [[#if selected]] checked [[/if]]  value=\'[[id]]\'/>\r\n                      <div class="j-lock-item f-ib f-csp"><i class="iconfont iconfiler"></i>[[name]]</div>\r\n                  </li>\r\n                  [[/each]]\r\n              </ul>\r\n              [[/if]]\r\n              [[/each]]\r\n          </ul>\r\n      </li>\r\n    </ul>\r\n  </script>\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="lockInfoTpl">\r\n      <p class="u-authlock-desc">{{i18n "setting/lbl_authLock_desc"}}</p>\r\n      <div class="u-form-item">\r\n          <label class="u-form-label f-mgr">{{i18n "setting/lbl_authLock"}}&nbsp;:</label>\r\n          <span class="f-ib">\r\n              <input type="checkbox" name="lock" role="switchBtn" class="checkbox j-lock-toggle" data-action="lockToggle"\r\n                      [[#if auth2LockDefined]]checked[[/if]]/>\r\n          </span>\r\n      </div>\r\n      <div class="j-lock-disable-mask lock-disable-mask"></div>\r\n\r\n      <div class="u-form-item [[#unless auth2LockDefined]]u-lock-disabled[[/unless]]">\r\n          <label class="u-form-label f-mgr">{{i18n "setting/lbl_auth2password"}}&nbsp;:</label>\r\n          [[#if auth2LockDefined]]\r\n          <a class="j-update-lockpwd" href="javascript:void(0)" data-action="editLock">{{i18n "setting/op_update_pwd"}}</a>\r\n          [[else]]\r\n          <span>{{i18n "setting/lbl_authLockPwdNotSet"}}</span>\r\n          [[/if]]\r\n      </div>\r\n      <div class="u-form-item [[#unless auth2LockDefined]]u-lock-disabled[[/unless]]">\r\n          <label class="u-form-label f-mgr">{{i18n "setting/lbl_authLockRangeTitle"}}&nbsp;:</label>\r\n          [[#if auth2LockDefined]]\r\n          <ul class="u-lockfolder-desc">\r\n              [[#compare lockOpName "!==" ""]]\r\n              <li class="u-lock-operations"><i class="u-img icon-lock-type icon-tools"></i><span>[[lockOpName]] </span></li>\r\n              [[/compare]]\r\n              <li class="u-lock-range"><i class="u-img icon-lock-type icon-folder"></i><span>[[filtedFoldersName]] </span></li>\r\n              <a href="javascript:void(0)" data-action="editRange">{{i18n "setting/op_update"}}</a>\r\n          </ul>\r\n          [[else]]\r\n          <span>{{i18n "setting/lbl_authLockRangeNull"}}</span>\r\n          [[/if]]\r\n      </div>\r\n      <div class="u-tips">\r\n          <h4>{{i18n "pref/personal/tips"}}&nbsp;:</h4>\r\n          <p>{{i18n "pref.personal/lock_tip_1"}}</p>\r\n      </div>\r\n  </script>\r\n  {{/raw}}\r\n\r\n</section>\r\n'}),define("module/setting/security/auth2lock/index",["require","util/i18n!setting,pref/personal","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","util/i18n","component/confirmbox","./../../service","module/common/globalService","text!template/module/setting/security/auth2lock/index.tpl.html"],function(e){function t(e,t){return(t.match(/\bswitched\S+/g)||[]).join(" ")}function n(e){"boolean"===$.type(e)&&d.updateConfig("user.auth2unlocked",e)}function i(){var e=d.getUser();e.def_sec_folder="",e.def_sec_op="",d.setUser(e),d.updateConfig("user.auth2lockdefined",!1),d.updateConfig("file.nfrootauth2lockdefined",!1),n(!0)}e("util/i18n!setting,pref/personal");var a=e("cui/core/view/view"),r=e("cui/core/view/viewmanager"),s=e("cui/util/templatable/templatable"),o=e("util/i18n"),l=e("component/confirmbox"),c=e("./../../service"),d=e("module/common/globalService"),u=a.extend({Implements:s,events:{"click [data-action]":"_dispatchAction","click .j-check-all+i":"_handleSelectPartAll","click .j-check-sub+i":"_handleSelectSingleFolder","click .j-lock-disable-mask":"_handleLockToggle","click .j-lock-item":"_handleCheckLockItem","keypress .j-disable-lock-input":"_handleDisableLockInputEnter","blur input[name='repass']":"_handleCheckPwd"},render:function(){var e=this;u.superclass.render.call(e),e._initView(),e._initModuleEvent()},_initView:function(e){var t,n=this,i=d.getUser();n.folderData={},n.auth2LockDefined=d.getConfig("user.auth2lockdefined"),n.element.mask(),c.getAttrs("def_sec_folder").then(function(a){var r=d.parseLockRange(decodeURIComponent(a.def_sec_folder));i.def_sec_folder=r.folder,i.def_sec_op=r.op,d.setUser(i),$.when(c.generateFolderFilterData({enableFilter:n.auth2LockDefined,filterIdList:r.folder,isSupportNF:!0})).then(function(i){n.folderData=i,$.extend(n.folderData,n._generateLockOpData(),{auth2LockDefined:n.auth2LockDefined}),t=n.compile(n.$("#lockInfoTpl").html(),n.folderData),n.$(".auth2lock-content").html(t),n.element.customRadioCheckbox(),e&&(n.sendMessage("setting.folder.folder","folder:refresh"),n.sendMessage("mail","folder:refresh",{type:"all"}))})}).always(function(){n.element.mask("hide")})},_initModuleEvent:function(){var e=this;e.onMessage("folder:refresh",function(){e._initView()})},_dispatchAction:function(e,t){var n=$(t).data("action");switch(n){case"editLock":this._handleEditLock();break;case"editRange":this._handleEditRange();break;case"cancel":this._handleCancel(t);break;case"disableLock":this._handleDisableLock(t);break;case"changeLockPwd":this._handleChangeLockPwd(t);break;case"lockEnable":this._handleLockEnable();break;case"updateRange":this._handleUpdateRange(t)}},_handleEditLock:function(){this.$(".main-wrapper").removeClass(t).addClass("switched-edit")},_handleEditRange:function(){var e=this.compile(this.$("#folderTreeTpl").html(),this.folderData),n=this.compile(this.$("#opsTreeTpl").html(),this.folderData);this.$(".j-folder-tree").html(e),this.$(".j-protect-operations").html(n),this._checkParentNode(),this.element.customRadioCheckbox(),this.$(".main-wrapper").removeClass(t).addClass("switched-range")},_handleCancel:function(e){this._resetForm(e),this.$(".main-wrapper").removeClass(t)},_handleDisableLockInputEnter:function(e){e=e||window.event,13==e.keyCode&&(e.preventDefault(),this._handleDisableLock())},_handleDisableLock:function(){var e=this,n=$(".j-disable-lock-input").get(0);this._handleVerifyPwd(n).then(function(n){var a=e.$('form[name="closeLock"]').serializeJSON();$.when(c.closeAuth2Lock(a)).then(function(){i(),e.sendMessage("mail","folder:refresh",{type:"all"}),e.sendMessage("setting.folder.folder","folder:refresh"),e._resetForm(n),e._initView(!0),e.$(".main-wrapper").removeClass(t)},function(e){"FA_PASSWORD_ERR"==e.code&&l.alert(o.t("setting/msg_easWrongPass"))})})},_handleChangeLockPwd:function(e){var n=this,i=$(e).closest("form").find('input[name="old_password"]').get(0);n._handleVerifyPwd(i).then(function(e){var i=n.$('form[name="changeLockPwd"]').serializeJSON();return i.password&&i.repass?i.password!==i.repass?l.alert(o.t("setting/msg_authPwdNotSame")):void $.when(c.changeLockPwd(i)).then(function(i){"S_OK"===i.code&&(n.$(".main-wrapper").removeClass(t),n._resetForm(e),$.notify.success(o.t("setting/msg_AuthLockPwdChangeSuccess")))},function(e){"FA_OLDPWD_ERR"===e.code&&$.notify.error(o.t("pref/personal/FA_OLDPWD_ERR"))}):l.alert(o.t("setting/msg_inputEmpty"))})},_handleVerifyPwd:function(e,t){var i=this,a=$.Deferred(),r=$(e),s=r.val();return t="boolean"===$.type(t)?t:!0,$.when(c.verifyLockPwd(s)).then(function(o){"S_OK"===o.code&&(r.parents(".u-form-item").removeClass("error").addClass("verify"),r.parents("form").find(".j-btn-error").removeAttr("disabled"),t&&$.when(c.userVerifyAuth2(s)).then(function(){n(!0),i.sendMessage("mail","folder:refresh",{type:"auth2Locked"})}),a.resolve(e))},function(e){return"FA_PASSWORD_ERR"===e.code?(r.parents(".u-form-item").removeClass("verify").addClass("error"),!1):void 0}),a.promise()},_handleLockEnable:function(){var e=this,i=e.$('form[name="lockEnable"]').serializeJSON();return i.password?i.repass?i.password!==i.repass?l.alert(o.t("setting/msg_authPwdNotSame")):i.lockItem1||i.lockItem2||i.lockItem3?(i.lockItem1&&(i.lockItem1=i.lockItem1.join(" ")),i.lockItem2&&(i.lockItem2=i.lockItem2.join(" ")),i.lockItem3&&(i.lockItem3=i.lockItem3.join(" ")),void $.when(c.changeAuth2Lock(i)).then(function(){d.updateConfig("user.auth2lockdefined",!0),n(!0),e.sendMessage("mail","folder:refresh",{type:"auth2Locked"}),$.notify.success(o.t("setting/msg_authLockRangeUpdateSuccess")),e._initView(!0),e.$(".main-wrapper").removeClass(t)})):l.alert(o.t("setting/msg_authLockRangeEmpty")):l.alert(o.t("setting/msg_easMissRepass")):l.alert(o.t("setting/msg_easMissPass"))},_handleUpdateRange:function(e){var n=this,i=$(e).closest("form").find('input[name="current_password"]').get(0);n._handleVerifyPwd(i).then(function(e){var i=n.$('form[name="lockRange"]').serializeJSON();return i.current_password&&(i.lockItem1||i.lockItem2||i.lockItem3)?(i.lockItem1&&(i.lockItem1=i.lockItem1.join(" ")),i.lockItem2&&(i.lockItem2=i.lockItem2.join(" ")),i.lockItem3&&(i.lockItem3=i.lockItem3.join(" ")),void $.when(c.changeAuth2Lock(i)).then(function(a){"S_OK"==a.code&&($.notify.success(o.t("setting/msg_authLockRangeUpdateSuccess")),d.updateConfig("file.nfrootauth2lockdefined",/nf:\d+/g.test(i.lockItem1)),n._resetForm(e),n._initView(!0),n.$(".main-wrapper").removeClass(t))},function(e){"FA_PASSWORD_ERR"==e.code&&l.alert(o.t("setting/msg_easWrongPass"))})):l.alert(o.t("setting/msg_chose_range"))})},_handleSelectPartAll:function(e,t){var n="checkbox-checked",i=$(t).parent().next();$(t).hasClass(n)?i.find("li i").addClass(n).end().find("li input").each(function(){this.checked=!0}):i.find("li i").removeClass(n).end().find("li input").each(function(){this.checked=!1})},_handleSelectSingleFolder:function(e,t){var n=$(t).parents(".parent-node"),i=n.find(".checkbox").length,a=n.find(".checkbox-checked").length;i==a?n.prev().find(".checkbox").addClass("checkbox-checked"):n.prev().find(".checkbox").removeClass("checkbox-checked")},_handleLockToggle:function(){var e=this.folderData.auth2LockDefined,n=this.compile(this.$("#folderTreeTpl").html(),this.folderData),i=this.compile(this.$("#opsTreeTpl").html(),this.folderData);e?this.$(".main-wrapper").removeClass(t).addClass("switched-off"):(this.$(".on-panel .j-folder-tree").html(n),this.$(".on-panel .j-protect-operations").html(i),this.$('form[name="lockEnable"]')[0].reset(),this.element.customRadioCheckbox(),this.$(".main-wrapper").removeClass(t).addClass("switched-on"))},_handleCheckPwd:function(e,t){var n=$(t).parents("form"),i=$(t).val(),a=n.find('input[name="password"]').val();i!==a?$(t).parents(".u-form-item").addClass("error"):$(t).parents(".u-form-item").removeClass("error")},_handleCheckLockItem:function(e){$(e.target||e.srcElement).siblings(".checkbox").click()},_resetForm:function(e){var t=$(e).parents("form");t[0].reset(),t.find(".u-form-item").each(function(e,t){$(t).removeClass("error verify")})},_generateLockOpData:function(){var e=d.getUser().def_sec_op,t="",n=[];e.length>0&&($.each(e,function(e,n){t+=o.t("setting/lbl_authLockOp"+n)+","}),t=t.substring(0,t.length-1));for(var i=0,a=3;a>i;i++)n[i]={val:i+1,lbl:o.t("setting/lbl_authLockOp"+(i+1))},~$.inArray(n[i].val.toString(),e)?n[i].selected=!0:n[i].selected=!1;return{lockOpName:t,lockOpInfo:n}},_checkParentNode:function(){var e=this;e.$(".parent-node:visible").each(function(e,t){var n=$(t).find("input:checked").length,i=$(t).find("input").length;i&&n==i&&$(t).prev().find("input").prop("checked",!0)})}});r.module({name:"setting.security.auth2lock",template:e("text!template/module/setting/security/auth2lock/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/security/blacklist/index.tpl.html",[],function(){return'<section class="m-whitelist grid-row">\r\n  <div class="main-wrapper">\r\n    <div class="content-wrapper">\r\n      <!---->\r\n      <div class="grid-col12 j-blacklist-info u-scroll"></div>\r\n    </div>\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask" />\r\n    <![endif]-->\r\n  </div>\r\n  {{#raw}}\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="blacklistTpl">\r\n    <div class="u-list-desc">[[i18n "setting/lbl_refuselist_desc"]]</div>\r\n\r\n    <div class="u-list-modify">\r\n      <div class="u-input-control">\r\n        <input type="text" class="u-input j-new-rule" placeholder="[[i18n \'setting/lbl_addfilteritem\']]">\r\n      </div>\r\n      <div class="u-btns-top f-ib">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="save">[[i18n "setting/op_add"]]</button>\r\n        <button type="button" class="u-btn u-btn-default [[#unless refuselist.length]]disabled[[/unless]]" data-action="removeAll">\r\n          [[i18n "setting/lbl_emptyrefuselist"]]\r\n        </button>\r\n      </div>\r\n      <div class="u-explain">[[i18n "setting/lbl_filterexample"]]</div>\r\n      <div class="u-error-alert f-dn"></div>\r\n    </div>\r\n\r\n    <div class="list-title f-csp" data-action="tableToggle">\r\n      <i class="iconfont iconcollapse"></i>\r\n      <span >{{i18n "setting/lbl_contact"}}</span>\r\n      <span class="opr">{{i18n "setting/lbl_op"}}</span>\r\n    </div>\r\n\r\n    <table>\r\n      <tbody>\r\n      [[#each refuselist]]\r\n      <tr>\r\n        <td>[[key]]</td>\r\n        <td><a href="javascript:void(0);" data-action="remove" data-name="[[key]]" >[[i18n "setting/op_remove"]]</a></td>\r\n      </tr>\r\n      [[/each]]\r\n\r\n      [[#unless refuselist.length]]\r\n      <tr class="gray">\r\n        <td>[[i18n "setting/msg_blacklist_empty"]]</td>\r\n        <td></td>\r\n      </tr>\r\n      [[/unless]]\r\n      </tbody>\r\n    </table>\r\n  </script>\r\n  {{/raw}}\r\n</section>\r\n\r\n'}),define("module/setting/security/blacklist/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","module/common/globalService","./../../service","../../../../util/index","i18n","configurable/index","text!template/module/setting/security/blacklist/index.tpl.html"],function(e){e("util/i18n!setting,pref");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("component/confirmbox"),s=e("module/common/globalService"),o=e("./../../service"),l=e("../../../../util/index"),c=e("i18n"),d=e("configurable/index"),u=n.extend({Implements:a,setup:function(){this.state=s.getCurrentState(),this.config=d("setting.security"),this._params={refuselist:[],safelist:[],userEmails:this.config.allEmails}},render:function(){u.superclass.render.call(this),this._initView(),this._initModuleMessage()},events:{"click [data-action]":"_dispatchAction"},_initView:function(){var e,n=this;this.element.mask(),this._clearAllCache(),o.getAttrs("safelist,refuselist").then(function(i){var a=[];i.refuselist&&t.each(i.refuselist.split(/\s?,\s?/),function(e,t){a.push({key:t}),n._params.refuselist.push(t)}),i.safelist&&t.each(i.safelist.split(/\s?,\s?/),function(e,t){n._params.safelist.push(t)}),e=n.compile(n.$("#blacklistTpl").html(),{refuselist:a}),n.$(".j-blacklist-info").html(e),n.element.mask("hide")})},_initModuleMessage:function(){var e=this;e.onMessage("list:reload",function(){e._initView()},null)},_dispatchAction:function(e,n){var i=t(n).data("action");switch(i){case"tableToggle":this._handleToggleTable(t(n));break;case"save":this._handleSaveRules();break;case"remove":this._handleRemoveSingleRule(t(n));break;case"removeAll":this._handleRemoveAllRules()}},_handleToggleTable:function(e){this.$("table").toggle(),e.find("i").toggleClass("iconunfold iconcollapse")},_handleSaveRules:function(){var e,n=this;this.$(".u-list-modify").removeClass("error");var i=this.$(".j-new-rule").val(),a=/^@\w+([-.]\w+)*\.\w+([-.]\w+)*/;if(i=i.trim().replace(/\n/g," ").replace(/ +/g,","),!i)return void this._displayErrorMsg(c.t("setting/msg_inputEmpty"));if(!l.Email.test(i)){if(!a.test(i))return void this._displayErrorMsg(c.t("setting/msg_errorEmailFormat"));i="*"+i}for(var r=0;r<this._params.userEmails;r++)if(i==this._params.userEmails[r].addr)return void this._displayErrorMsg(c.t("setting/msg_errExceptOwnMail"));return-1!==t.inArray(i,this._params.refuselist)||-1!==t.inArray(i,this._params.newlist)?void this._displayErrorMsg(l.messageFormat.format(c.t("setting/msg_errMailExistInCurrentList"),i)):-1!==t.inArray(i,this._params.safelist)?void this._displayErrorMsg(l.messageFormat.format(c.t("setting/msg_errMailExistInWhiteList"),i)):(this._params.refuselist.push(i),e=this._params.refuselist.join(","),void s.updateUser({refuselist:e}).then(function(){t.notify.success(c.t("setting/msg_rulesSaveSucccess")),n._initView()}))},_handleRemoveSingleRule:function(e){var n,i=e.data("name"),a=this;r.confirm(l.messageFormat.format(c.t("setting/msg_confirmRemoveListItem"),l.html.encode(i)),function(){a._params.refuselist=t.grep(a._params.refuselist,function(e){return e!==i}),n=a._params.refuselist.join(","),s.updateUser({refuselist:n}).then(function(){a._initView(),t.notify(c.t("setting/msg_rulesRemoveSuccess"))})})},_handleRemoveAllRules:function(){var e=this;r.confirm(c.t("setting/msg_confirmRemoveAllListItem"),function(){s.updateUser({refuselist:""}).then(function(){e._initView(),t.notify(c.t("setting/msg_rulesRemoveSuccess"))})})},_displayErrorMsg:function(e){this.$(".u-list-modify").find(".u-error-alert").html(e).end().addClass("error")},_clearAllCache:function(){this._params.newlist=[],this._params.refuselist=[],this._params.safelist=[]}});i.module({name:"setting.security.blacklist",template:e("text!template/module/setting/security/blacklist/index.tpl.html")},u)}),define("components/requirejs-text/text!template/module/setting/security/junkfilter/index.tpl.html",[],function(){return'<section class="m-junkfilter">\r\n\r\n  <div class="j-filter-set"></div>\r\n\r\n  <script type="text/x-handlebars-template" id="junkFilterTpl">\r\n    {{#raw}}\r\n    <form action="" name="junkfilter">\r\n\r\n    <div class="u-btns-top">\r\n      <button type="button" class="u-btn u-btn-primary" data-action="save" disabled>[[i18n "setting/op_save"]]</button>\r\n      <button type="reset"  class="u-btn u-btn-default"  data-action="cancel">[[i18n "setting/op_cancel"]]</button>\r\n    </div>\r\n\r\n    <div class="title dotted">\r\n      <h4>[[i18n "setting/lbl_junkFilter"]]</h4>\r\n    </div>\r\n\r\n    <div class="wrapper">\r\n      <div class="item-block">\r\n        <label for="junkfilter_0">\r\n          <input type="radio"  name="junkfilter" id="junkfilter_0" value="0" data-action="disable" [[#compare junkfilter \'==\' "0"]]checked[[/compare]] /> &nbsp;[[i18n "pref/junkfilter/method0_1"]]\r\n        </label>\r\n        <span>[[i18n "pref/junkfilter/method0"]]</span>\r\n      </div>\r\n\r\n      <div class="item-block">\r\n        <label for="junkfilter_1">\r\n          <input type="radio"  name="junkfilter" id="junkfilter_1" value="1" data-action="disable" [[#compare junkfilter \'==\' "1"]]checked[[/compare]]/>&nbsp;[[i18n "pref/junkfilter/method1_1"]]\r\n        </label>\r\n        <span>[[[i18n "pref/junkfilter/method1"]]]</span>\r\n      </div>\r\n\r\n      <div class="item-block">\r\n        <label for="junkfilter_2">\r\n          <input type="radio" name="junkfilter" id="junkfilter_2" value="2" data-action="enable" [[#compare junkfilter \'==\' "2"]]checked[[/compare]] />&nbsp;[[i18n "pref/junkfilter/method2_1"]]\r\n        </label>\r\n        <span class="f-ib">[[i18n "pref/junkfilter/method2"]]</span>\r\n        <span class="item-notice">[[i18n "pref/junkfilter/notice"]]</span>\r\n      </div>\r\n      <div class="sub-choice">\r\n        <p>\r\n          <label for="rejectjunk_1">\r\n            <input type="radio" name="rejectjunk" id="rejectjunk_1" value="1"  [[#compare rejectjunk \'==\' "1"]]checked[[/compare]]/> &nbsp;[[[i18n "pref/junkfilter/move"]]]\r\n          </label>\r\n        </p>\r\n        <p>\r\n          <label for="rejectjunk_0">\r\n            <input type="radio" name="rejectjunk" id="rejectjunk_0" value="0"  [[#compare rejectjunk \'==\' "0"]]checked[[/compare]]/> &nbsp;[[i18n "pref/junkfilter/reject"]]\r\n          </label>\r\n        </p>\r\n      </div>\r\n    </div>\r\n\r\n    </form>\r\n    {{/raw}}\r\n\r\n  </script>\r\n</section>\r\n';
}),define("module/setting/security/junkfilter/index",["require","i18n!setting,pref/junkfilter","jquery","./../../service","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","util/i18n","text!template/module/setting/security/junkfilter/index.tpl.html"],function(e){e("i18n!setting,pref/junkfilter");var t=e("jquery"),n=e("./../../service"),i=e("cui/core/view/view"),a=e("cui/core/view/viewmanager"),r=e("cui/util/templatable/templatable"),s=e("util/i18n"),o=i.extend({Implements:r,setup:function(){this.cache={}},render:function(){o.superclass.render.call(this),this._initView()},events:{"click [data-action]":"_dispatchAction","click label":"_checkUserEdit"},_initView:function(){var e=this;n.getJunkFilterInfo().then(function(t){e.cache.filterSet=t,e._generateView()})},_dispatchAction:function(e,n){var i=t(n).data("action");switch(i){case"enable":l.activeChk(this.$("input[name='rejectjunk']"));break;case"save":this._handleSaveFilterSet();break;case"cancel":this._generateView();break;case"disable":l.unCheckAndDisableChk(this.$("input[name='rejectjunk']"))}},_checkUserEdit:function(e){var n,i=t(e.target);return"I"==i.prop("tagName")&&i.hasClass("rc-disabled")||i.find("i").hasClass("rc-disabled")?!1:(n=i.parents("form"),void(n.data("change")||(n.find("button[data-action]").prop("disabled",!1),n.data("change",!0))))},_generateView:function(){var e=this.$("#junkFilterTpl").html(),t=this.compile(e,this.cache.filterSet);this.$(".j-filter-set").html(t),"2"!=this.cache.filterSet.junkfilter?l.unCheckAndDisableChk(this.$("input[name='rejectjunk']")):l.activeChk(this.$("input[name='rejectjunk']")),this.element.customRadioCheckbox()},_handleSaveFilterSet:function(){var e=this.$("form[name='junkfilter']").serializeJSON(),i=this;n.setJunkFilterInfo(e).then(function(){t.extend(i.cache.filterSet,e),t.notify.success(s.t("setting/msg_junkFilterSetSuccess"))})}}),l={radioDisableClass:"rc-disabled",radioCheckedClass:"radio-checked",disableChk:function(e){e.prop("disabled",!0).next("i").addClass(this.radioDisableClass)},activeChk:function(e){e.prop("disabled",!1).next("i").removeClass(this.radioDisableClass)},unCheckChk:function(e){e.prop("checked",!1).next("i").removeClass(this.radioCheckedClass)},checkChk:function(e){e.prop("checked",!0).next("i").addClass(this.radioCheckedClass)},checkAndActiveChk:function(e){this.checkChk(e),this.activeChk(e)},unCheckAndDisableChk:function(e){this.unCheckChk(e),this.disableChk(e)}};a.module({name:"setting.security.junkfilter",template:e("text!template/module/setting/security/junkfilter/index.tpl.html")},o)}),define("module/setting/security/junknotify/service",["require","jquery","../../../../util/index","module/common/globalService"],function(e){function t(){var e=i.Deferred();return a.xhr.simpleCall({query:{func:"user:getATNotifyOption",sid:r.getSid()}},function(t){e.resolve(t)},function(){e.reject()}),e.promise()}function n(e){var t=i.Deferred();return a.xhr.simpleCall({query:{func:"user:setATNotifyOption",sid:r.getSid()},data:{notifyInterval:e}},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}var i=e("jquery"),a=e("../../../../util/index"),r=e("module/common/globalService");return{getJunkNotifyInfo:t,setJunkNotifyInfo:n}}),define("components/requirejs-text/text!template/module/setting/security/junknotify/index.tpl.html",[],function(){return'<section class="m-junknotify">\r\n\r\n    <div class="j-notify-set"></div>\r\n\r\n    <script type="text/x-handlebars-template" id="junkNotifyTpl">\r\n        {{#raw}}\r\n        <form action="" name="junknotify">\r\n\r\n            <div class="u-btns-top">\r\n                <button type="button" class="u-btn u-btn-primary" data-action="save" disabled>[[i18n "setting/op_save"]]</button>\r\n                <button type="reset" class="u-btn u-btn-default"  data-action="cancel">[[i18n "setting/op_cancel"]]</button>\r\n            </div>\r\n\r\n            <div class="title dotted">\r\n                <h4>[[i18n "setting/lbl_junkNotify"]]</h4>\r\n            </div>\r\n            <div class="wrapper">\r\n                [[#each notifyIntervals]]\r\n                <div class="grid-row">\r\n                    <div class="grid-col2">\r\n                        <label for="junknotify_[[this]]">\r\n                            <input type="radio"  name="notifyInterval" id="junknotify_[[this]]" value="[[this]]"  [[#compare @root.userNotifyInterval \'==\' this]]checked[[/compare]]/>\r\n                            [[#compare this \'!=\' 0]]\r\n                            &nbsp;[[formatResource "pref/junkfilter/anti_junk_inform_interval_{0}" this]]\r\n                            [[/compare]]\r\n\r\n                            [[#compare this \'==\' 0]]\r\n                            &nbsp;[[i18n "pref/junkfilter/anti_junk_not_inform"]]\r\n                            [[/compare]]\r\n                        </label>\r\n                    </div>\r\n                    <div class="grid-col10">\r\n                        [[#compare this \'!=\' 0]]\r\n                        <span>[[formatResource "pref/junkfilter/anti_junk_inform_interval_{0}_{1}" this "desc"]]</span>\r\n                        [[#compare this \'==\' 7]]\r\n                            <span class="recommend">[\r\n                                [[i18n "pref/junkfilter/anti_junk_inform_recommend"]]\r\n                                ]</span>\r\n                        [[/compare]]\r\n                        [[/compare]]\r\n                    </div>\r\n                </div>\r\n                [[/each]]\r\n\r\n            </div>\r\n\r\n        </form>\r\n        {{/raw}}\r\n\r\n    </script>\r\n</section>'}),define("module/setting/security/junknotify/index",["require","util/i18n!setting,pref/junkfilter","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","util/i18n","./service","text!template/module/setting/security/junknotify/index.tpl.html"],function(e){e("util/i18n!setting,pref/junkfilter");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("util/i18n"),s=e("./service"),o=n.extend({Implements:a,templateHelpers:{formatResource:function(){var e=arguments[0]||"";if(e.length>0)for(var t=1;t<arguments.length-1;t++)e=e.replace(new RegExp("\\{"+(t-1)+"\\}"),arguments[t]);return r.t(e)}},setup:function(){var e=this;e.showData={notifyIntervals:[3,7,14,0]},e.cache={}},render:function(){o.superclass.render.call(this),this._initView()},events:{"click [data-action]":"_dispatchAction","click label":"_checkUserEdit"},_initView:function(){var e=this;s.getJunkNotifyInfo().then(function(t){var n=e.showData;n.userNotifyInterval=t.junkNotify>0?+t.notifyInterval:0,e.cache.data=n,e._generateView()})},_dispatchAction:function(e,n){var i=this,a=t(n).data("action");switch(a){case"cancel":i._generateView();break;case"save":var o=i.$("form[name='junknotify']").serializeJSON({parseNumbers:!0});t.when(s.setJunkNotifyInfo(o.notifyInterval)).then(function(){var e=i.showData;e.userNotifyInterval=o.notifyInterval,i.cache.data=e,t.notify(r.t("setting/msg_junkNotifySetSuccess"))})}},_checkUserEdit:function(e){var n=t(e.target).parents("form");n.data("change")||(n.find("button[data-action]").prop("disabled",!1),n.data("change",!0))},_generateView:function(){var e=this,t=e.compile(e.$("#junkNotifyTpl").html(),e.cache.data);e.$(".j-notify-set").html(t),e.element.customRadioCheckbox()}});i.module({name:"setting.security.junknotify",template:e("text!template/module/setting/security/junknotify/index.tpl.html")},o)}),function(){define("module/setting/security/logindevices/store",["require","exports","module"],function(e,t,n){var i={AUTHORIZED:"authorized",RECENT:"recent"},a={wp:["bg-windows","iconwindows"],windows:["bg-windows","iconwindowsos"],macosx:["bg-apple","iconmacos"],ios:["bg-apple","iconapple"],yunos:["bg-yunos","iconyunos"],android:["bg-android","iconanroid"],chromeos:["bg-chromeos","iconchromeos"],linux:["bg-linux","iconlinuxos"],windowsce:["bg-windows","iconwindowsce"],symbian:["bg-symbian","iconsymbian"],blackberry:["bg-blackberry","iconblackberry"]},r=function(e){var t,n={bgClass:"bg-default",iconClass:"iconunknownapp"};return"string"==typeof e&&e.length?(e=e.toLowerCase(),t=a[e],null==t?n:(t[0]&&(n.bgClass=t[0]),t[1]&&(n.iconClass=t[1]),n)):n};n.exports={getDeviceOSUIInfo:r,devicesType:i}})}(),define("components/requirejs-text/text!template/module/setting/security/logindevices/index.tpl.html",[],function(){return'<div class="m-setting-logindevices">\r\n  <div class="main-wrapper j-main">\r\n\r\n  </div>\r\n\r\n  {{#raw}}\r\n\r\n  <!--  -->\r\n  <script type="text/x-handlebars-template" id="disableTpl">\r\n    <p>{{ i18n "setting/msg_loginDevices_disable" }}</p>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="mainTpl">\r\n    [[#if config.showAuthorized]]\r\n    <div class="list-wrap authorized-list-wrap j-authorized-list-wrap">\r\n      <div class="title dotted">\r\n        <h4>\r\n          [[ i18n "setting/lbl_logindevices_authorized_title" ]]\r\n          <small>[[ i18n "setting/lbl_logindevices_authorized_desc" ]]</small>\r\n        </h4>\r\n      </div>\r\n      <div class="list j-authorized-list f-cf"></div>\r\n    </div>\r\n    [[/if]]\r\n    <div class="list-wrap recent-list-wrap j-recent-list-wrap">\r\n      <div class="title dotted">\r\n        <h4>\r\n          [[ i18n "setting/lbl_logindevices_recent_title" ]]\r\n          <small>[[ i18n "setting/lbl_logindevices_recent_desc" date=config.devicePreservePeriod ]]</small>\r\n        </h4>\r\n      </div>\r\n      <div class="list j-recent-list f-cf"></div>\r\n    </div>\r\n  </script>\r\n\r\n  <!--  -->\r\n  <script type="text/x-handlebars-template" id="DeviceListEmptyTpl">\r\n    <div class="device-card">\r\n      <div class="device-card-header">\r\n        <p>\r\n          [[ title ]]\r\n        </p>\r\n      </div>\r\n      <div class="device-card-body f-cf">\r\n        <div class="device-card-body-icon bg-default">\r\n          <i class="iconfont iconinfo"></i>\r\n        </div>\r\n        <div class="device-card-body-content">\r\n          <p>\r\n            [[ content ]]\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!--  -->\r\n  <script type="text/x-handlebars-template" id="deviceItemTpl">\r\n  <li class="device-card j-device-card" data-type="[[deviceType]]" data-id="[[deviceInfo.id]]">\r\n    <div class="device-card-header">\r\n      <p>\r\n        [[deviceInfo.model]]\r\n        [[#if isCurrentDevice]]\r\n        <small>[[ i18n "setting/lbl_logindevices_device_current" ]]</small>\r\n        [[else]]\r\n        <small>[[[FormatLastTime deviceInfo.lastTime]]]</small>\r\n        [[/if]]\r\n      </p>\r\n      [[#if isBindDevice ]]\r\n      <p class="f-fr small">\r\n        [[[ i18n "setting/lbl_logindevices_device_authority" ]]]\r\n      </p>\r\n      [[/if]]\r\n      [[#each actions ]]\r\n      <a href="javascript:void(0);" class="action j-device-action [[#if authDisabled]]disabled j-auth-disabled-tip[[/if]]" data-action="[[this.type]]">&#91[[this.desc]]&#93</a>\r\n      [[/each]]\r\n    </div>\r\n    <div class="device-card-body f-cf">\r\n      <div class="device-card-body-icon [[osUIInfo.bgClass]]">\r\n        <i class="iconfont [[osUIInfo.iconClass]]"></i>\r\n      </div>\r\n      <div class="device-card-body-content">\r\n        <p>\r\n          <span class="label">[[ i18n "setting/lbl_logindevices_device_os" ]]</span> [[deviceInfo.os]]\r\n        </p>\r\n        <p>\r\n          [[#if isWebmail]]\r\n          <span class="label">[[ i18n "setting/lbl_logindevices_device_browser" ]]</span>\r\n          [[else]]\r\n          <span class="label">[[ i18n "setting/lbl_logindevices_device_name" ]]</span>\r\n          [[/if]]\r\n          [[deviceInfo.friendlyName]]\r\n        </p>\r\n        <p>\r\n          <span class="label">[[ i18n "setting/lbl_logindevices_device_app" ]]</span> [[deviceInfo.deviceType]]\r\n        </p>\r\n      </div>\r\n    </div>\r\n  </li>\r\n  </script>\r\n\r\n  {{/raw}}\r\n</div>'}),function(){define("module/setting/security/logindevices/index",["require","exports","module","i18n!setting,common","jquery","i18n","moment","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","cui/ui/tip/tip","module/common/globalService","configurable/index","./service","./store","../twofactorauth/service","../twofactorauth/store","text!template/module/setting/security/logindevices/index.tpl.html"],function(e,t,n){function i(e){var t,n="";return e=parseInt(e),isNaN(e)?n:(t=v.formatMilliSecondMap(e,!1),t.days>0?n=r.t("common/dateunit_day",{count:t.days}):t.hours>0?n=r.t("common/dateunit_hour",{count:t.hours}):t.minutes>0?n=r.t("common/dateunit_minute",{count:t.minutes}):t.seconds>0&&(n=r.t("common/dateunit_second",{count:t.seconds})),n)}e("i18n!setting,common");var a=e("jquery"),r=e("i18n"),s=e("moment"),o=e("cui/core/view/view"),l=e("cui/core/view/viewmanager"),c=e("cui/util/templatable/templatable"),d=e("cui/ui/tip/tip"),u=e("module/common/globalService"),p=e("configurable/index"),m=e("./service"),h=e("./store"),f=e("../twofactorauth/service"),v=e("../twofactorauth/store"),g={DELETE:"delete",AUTH:"toauth",UNAUTH:"unauth"},b=h.devicesType,_=function(e){a.isPlainObject(e)?e=[e]:a.isArray(e)||(e=[]),this.devices=e,a.each(this.devices,a.proxy(function(e,t){this._formatDevice(t)},this)),this._sortByLastTime()};_.prototype={constructor:_,_formatDevice:function(e){e.lastTime?s.isMoment(e.lastTime)||(e.lastTime=s(e.lastTime)):e.lastTime=null},_sortByLastTime:function(){this.devices.sort(function(e,t){var n,i;return n=null==e.lastTime?-1:e.lastTime.valueOf(),i=null==t.lastTime?-1:t.lastTime.valueOf(),n>i?-1:n===i?0:i>n?1:void 0})},destroy:function(){this.devices=[]},deleteById:function(e){for(var t=-1,n=0;n<this.devices.length;n++)if(this.devices[n].id==e){t=n;break}return 0>t?{}:this.devices.splice(n,1)},updateById:function(e){var t,n=-1;if(!e||!e.id)return{};for(var i=0;i<this.devices.length;i++)if(t=this.devices[i],t.id==e.id){n=i,this.devices[i]=a.extend(t,e,!0);break}return n>=0?t:{}},addById:function(e){var t;return e&&e.id?(t=this.getById(e.id),this._formatDevice(e),a.isEmptyObject(t)?(this.devices.push(e),t=e):a.extend(t,e,!0),this._sortByLastTime(),t):{}},getById:function(e){for(var t,n=-1,i=0;i<this.devices.length;i++)if(t=this.devices[i],t.id==e){n=i;break}return 0>n?{}:t}};var y=o.extend({Implements:c,twoFactorAuthState:null,devicesSet:{authorized:null,recent:null},config:null,twoFactorAuthConfig:null,$authorizedListWrap:null,$authorizedList:null,$recentListWrap:null,$recentList:null,deviceTemplate:null,events:{"click .j-device-action":"_handleDeviceActionClick","mouseenter .j-auth-disabled-tip":"_showDeviceActionDisabledTip"},setup:function(){this.state=u.getCurrentState(),delete this.state.param.view,this.config=p("setting.security",this)},render:function(){return y.superclass.render.call(this),this.config.supportAuthorizedDevice?(this.deviceTemplate=this.$("#deviceItemTpl").html(),this._doRender(),void this._initModuleEvent()):(this._renderForbidden(),!1)},destroy:function(){y.superclass.destroy.call(this)},_renderForbidden:function(){var e=this.$("#disableTpl").html();this.$(".j-main").empty().html(this.compile(e))},_doRender:function(){this.twoFactorAuthConfig=f.getAuthConfig(),this._initStore(this._renderDevicesSet)},_initStore:function(e){var t=this;e=a.isFunction(e)?e:a.noop,this._cleanDevicesSet(),a.when(f.queryAuthInfo()).done(function(e){t.twoFactorAuthState=e}).fail(function(){t.twoFactorAuthState={type:v.authOptions.DISABLED}}).always(function(){a.when(m.listDevices()).then(function(n){t.devicesSet={recent:t._formatDevicesToSet(n.recent),authorized:t._formatDevicesToSet(n.authorized)},e.call(t)})})},_initModuleEvent:function(){var e=this;this.unsubscribe("setting.security.twofactorauth","authStatusChange").subscribe("setting.security.twofactorauth","authStatusChange",function(){e._initStore(e._updateDeviceListTpl)})},_handleDeviceActionClick:function(e){e.preventDefault();var t=a(e.currentTarget),n=t.closest(".j-device-card").eq(0),i=t.attr("data-action"),r=n.attr("data-id");if(!r)return!1;if(t.hasClass("disabled"))return!1;switch(i){case g.DELETE:this._handleDeviceDelete(r);break;case g.AUTH:this._handleDeviceToAuth(r);break;case g.UNAUTH:this._handleDeviceToUnAuth(r)}return!1},_showDeviceActionDisabledTip:function(e){e.preventDefault();var t=a(e.currentTarget);new d({zIndex:999,trigger:t,content:r.t("setting/msg_loginDevices_action_disabled_unauth"),inViewport:!0,arrowPosition:11}).after("hide",function(){this.destroy()}).show()},_renderDevicesSet:function(){var e=this.$("#mainTpl").html(),t=u.getConfig("setting.devicepreserveperiod")||2592e6;t=i(t);var n={showAuthorized:!this.twoFactorAuthConfig.isForbidden,devicePreservePeriod:t};this.$(".j-main").empty().html(this.compile(e,{config:n})),this.$authorizedListWrap=this.$(".j-authorized-list-wrap"),this.$authorizedList=this.$(".j-authorized-list"),this.$recentListWrap=this.$(".j-recent-list-wrap"),this.$recentList=this.$(".j-recent-list"),this._updateDeviceListTpl()},_cleanDevicesSet:function(){this.devicesSet.authorized&&(this.devicesSet.authorized.destroy(),this.devicesSet.authorized=null),this.devicesSet.recent&&(this.devicesSet.recent.destroy(),this.devicesSet.recent=null)},_compileDeviceListTpl:function(e,t){var n,i=this,s=[];return null!=t&&t.devices.length?(s.push("<ul>"),a.each(t.devices,function(t,n){s.push(i._compileDeviceTpl(e,t,n))}),s.push("</ul>"),s.join("")):n=this.compile(this.$("#DeviceListEmptyTpl").html(),{title:r.t("setting/msg_loginDevices_empty_recent_title"),content:r.t("setting/msg_loginDevices_empty")})},_updateAuthorizedDeviceListTpl:function(){if(this.twoFactorAuthConfig.isForbidden)return!1;var e,t=this.devicesSet.authorized;return null!=t&&t.devices.length?void this.$authorizedList.html(this._compileDeviceListTpl(b.AUTHORIZED,this.devicesSet.authorized)):(e=this.compile(this.$("#DeviceListEmptyTpl").html(),{title:r.t("setting/msg_loginDevices_empty_authorized_title"),content:this.twoFactorAuthState.type===v.authOptions.DISABLED?r.t("setting/msg_loginDevices_empty_authorized_disabled_content"):r.t("setting/msg_loginDevices_empty_authorized_content")}),void this.$authorizedList.html(e))},_updateRecentDeviceListTpl:function(){this.$recentList.html(this._compileDeviceListTpl(b.RECENT,this.devicesSet.recent))},_updateDeviceListTpl:function(){this._updateAuthorizedDeviceListTpl(),this._updateRecentDeviceListTpl()},_compileDeviceTpl:function(e,t,n){var i,a,s,o,l=this.deviceTemplate,c=this.twoFactorAuthState,d=null,p=[],m=u.getSid(),f="na",_="Webmail"===n.deviceType;return null==l||""===l?"":(c.type===v.authOptions.OTP&&null!=c.deviceInfo&&(d=c.deviceInfo.uuid),i=n.UUID||n.uuid,a=d&&d===i,s=n.lastSid===m,a||(e===b.RECENT&&p.push({type:g.DELETE,desc:r.t("setting/lbl_logindevices_device_action_delete")}),this.twoFactorAuthState.type===v.authOptions.DISABLED||n.authorized||p.push({type:g.AUTH,desc:r.t("setting/lbl_logindevices_device_action_auth")}),n.authorized&&p.push({type:g.UNAUTH,desc:r.t("setting/lbl_logindevices_device_action_unauth"),authDisabled:this.twoFactorAuthState.type===v.authOptions.DISABLED})),n.model&&n.model!==f||(n.model=r.t("setting/lbl_logindevices_device_model_unknown")),n.os&&n.os!==f||(n.os=r.t("setting/lbl_logindevices_device_model_unknown")),n.friendlyName&&n.friendlyName!==f||(n.friendlyName=_?r.t("setting/lbl_logindevices_device_browser_unknown"):r.t("setting/lbl_logindevices_device_name_unknown")),o=h.getDeviceOSUIInfo(n.os),this.compile(l,{deviceInfo:n,deviceType:e,actions:p,isBindDevice:a,isCurrentDevice:s,isWebmail:_,osUIInfo:o}))},_handleDeviceDelete:function(e){var t=this;a.when(m.deleteDevices({ids:e})).then(function(){t.devicesSet.authorized.deleteById(e),t.devicesSet.recent.deleteById(e),t._updateDeviceListTpl()},function(e){console.log(e.toString())})},_handleDeviceToAuth:function(e){var t=this;a.when(m.authDevice({deviceId:parseInt(e,10),auth:!0})).then(function(){var n=t.devicesSet.recent.updateById({id:e,authorized:!0});t.devicesSet.authorized.addById(n),t._updateDeviceListTpl()},function(e){console.log(e.toString())})},_handleDeviceToUnAuth:function(e){var t=this;a.when(m.authDevice({deviceId:parseInt(e,10),auth:!1})).then(function(){t.devicesSet.recent.updateById({id:e,authorized:!1}),t.devicesSet.authorized.deleteById(e),t._updateDeviceListTpl()},function(e){console.log(e.toString())})},_formatDevicesToSet:function(e){var t;return t=null==e?new _:new _(e)},templateHelpers:{FormatLastTime:function(e){if(!e)return"";var t=s().valueOf()-e.valueOf(),n=r.t("setting/lbl_logindevices_device_lasttime_suffix"),a=i(t);return a?a+n:""}}});l.module({name:"setting.security.logindevices",template:e("text!template/module/setting/security/logindevices/index.tpl.html")},y),n.exports=y})}(),define("module/setting/security/offsiteremind/service",["require","jquery","../../../../util/index","module/common/globalService"],function(e){function t(){var e=i.Deferred();return a.xhr.simpleCall({query:{func:"user:getOffSiteRemindStatus",sid:r.getSid()}},function(t){e.resolve(t)},function(){e.reject()}),e.promise()}function n(e){var t=i.Deferred();return a.xhr.simpleCall({query:{func:"user:setOffSiteRemindStatus",sid:r.getSid(),status:e}},function(e){t.resolve(e)},function(){t.reject()}),t.promise()}var i=e("jquery"),a=e("../../../../util/index"),r=e("module/common/globalService");return{getOffSiteRemindStatus:t,setOffSiteRemindStatus:n}}),define("components/requirejs-text/text!template/module/setting/security/offsiteremind/index.tpl.html",[],function(){return'<section class="m-off-site-remind">\r\n\r\n    <div class="u-btns-top">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="save">{{i18n "setting/op_save"}}</button>\r\n        <button type="reset" class="u-btn u-btn-default"  data-action="cancel">{{i18n "setting/op_cancel"}}</button>\r\n    </div>\r\n    <div class="title dotted">\r\n        <h4>{{i18n "pref/offSiteRemind_desc"}}</h4>\r\n    </div>\r\n    <form class="j-remind-from remind-from" action=""></form>\r\n    <script type="text/x-handlebars-template" id="offSiteRemindTpl">\r\n        {{#raw}}\r\n            <div class="remind-item">\r\n                <input type="radio" name="status" value="1" id="remindStatus_1" [[#compare this.off_site_remind_status \'==\' 1]]checked[[/compare]]/>\r\n                <label for="remindStatus_1">[[i18n "setting/on"]]</label>\r\n                <span class="remind-info">[[i18n "setting/on_desc"]] <span class="recommend">[ [[i18n "setting/recommend"]] ]</span></span>\r\n            </div>\r\n\r\n            <div class="remind-item">\r\n                <input type="radio" name="status" value="0" id="remindStatus_0" [[#compare this.off_site_remind_status \'==\' 0]]checked[[/compare]]/>\r\n                <label for="remindStatus_0">[[i18n "setting/off"]]</label>\r\n                <span class="remind-info">[[i18n "setting/off_desc"]]</span>\r\n            </div>\r\n\r\n        {{/raw}}\r\n    </script>\r\n</section>'}),define("module/setting/security/offsiteremind/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","util/index","./service","text!template/module/setting/security/offsiteremind/index.tpl.html"],function(e){e("util/i18n!setting,pref");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("util/index"),s=e("./service"),o=n.extend({Implements:a,setup:function(){var e=this;e.data={}},render:function(){o.superclass.render.call(this),this._initView()},events:{"click [data-action]":"_handleOffSiteRemindStatus"},_initView:function(){var e=this;s.getOffSiteRemindStatus().then(function(t){e.data=t,e._renderView()},function(){t.notify.error(r.i18n.t("setting/noStatus"))})},_handleOffSiteRemindStatus:function(e,n){var i=this,a=i.$(n).data("action"),o=i.$(".j-remind-from").serializeJSON({parseNumbers:!0});"save"===a?s.setOffSiteRemindStatus(o.status).then(function(e){console.log(e),t.notify.success(r.i18n.t("setting/success"))},function(){t.notify.error(r.i18n.t("setting/fail"))}):"cancel"===a&&i._renderView()},_renderView:function(){var e=this,t=e.data;e.$(".j-remind-from").html(e.compile(e.$("#offSiteRemindTpl").html(),t)),e.element.customRadioCheckbox()}});i.module({name:"setting.security.offsiteremind",template:e("text!template/module/setting/security/offsiteremind/index.tpl.html")},o)}),define("module/setting/security/smime/service",["require","jquery","../../../../util/index","module/common/globalService"],function(e){function t(e){var t=i.Deferred();return e=e||{},a.xhr.simpleCall({query:{func:"user:authenticateSmimeKeyPass",sid:r.getSid()},data:e},function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()}function n(e){var t=i.Deferred();return e=e||{},e.password=e.password?e.password:"",a.xhr.simpleCall({query:{func:"user:setSmimeKeyAttrs",sid:r.getSid()},data:e},function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()}var i=e("jquery"),a=e("../../../../util/index"),r=e("module/common/globalService");return{authenticateSmimeKeyPass:t,setSmimeKeyPass:n}}),define("components/requirejs-text/text!template/module/setting/security/smime/index.tpl.html",[],function(){return'<section class="m-smime">\r\n  <div class="main-wrapper">\r\n    <div class="content-wrapper">\r\n      <form class="smime" name="smime" onsubmit="return false;">\r\n\r\n        <div class="u-btns-top">\r\n          <button type="button" class="u-btn u-btn-primary"  data-action="save">{{i18n "setting/op_save"}}</button>\r\n          <button type="reset" class="u-btn u-btn-default" data-action="cancel_fix">{{i18n "setting/op_cancel"}}</button>\r\n        </div>\r\n\r\n        <div class="title dotted">\r\n          <h4>{{i18n "pref/msg_smime_pwd_set"}}</h4>\r\n        </div>\r\n\r\n        <div class="u-form-item">\r\n\r\n          <div class="u-pdl">\r\n            <div class="f-fl">\r\n              <label class="u-form-label">{{i18n "pref/msg_smime_pwd"}}</label>\r\n            </div>\r\n            <div class="u-form-value" id="switchSmime">\r\n\r\n            </div>\r\n          </div>\r\n\r\n          <div class="u-pdl">\r\n            <div class="f-fl">\r\n              <label class="u-form-label">{{i18n "pref/msg_smime_tips"}}</label>\r\n            </div>\r\n            <div class="u-form-value">\r\n              <p>{{i18n "pref/msg_smime_tips_1"}}</p>\r\n              <p>\r\n                {{i18n "pref/msg_smime_tips_2"}}\r\n              </p>\r\n              <p>\r\n                {{i18n "pref/msg_smime_tips_3"}}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </form>\r\n    </div>\r\n    <div class="panel u-scroll edit-panel u-smime-pass-edit">\r\n      <div class="j-pwd-edit"></div>\r\n    </div>\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <script type="text/x-handlebars-template" id="switchSmimeTpl">\r\n    <label>\r\n      <input type="radio" data-action="start"  name="enableKeyPass" value= "true" [[#if switchSmime]]checked[[/if]] />\r\n      {{i18n "pref/smime_start"}}\r\n    </label>\r\n    <a href="javascript:void(0)" data-action="editPwd" class="editSmimePwd" [[#unless switchSmime]]data-click="false_click"[[/unless]]>{{i18n "pref/msg_smime_fix"}}</a>\r\n    <div class="u-stop-smime">\r\n      <label>\r\n        <input type="radio" data-action="stop" name="enableKeyPass" [[#unless switchSmime]]checked[[/unless]]  value= "false" />\r\n        {{i18n "pref/smime_stop"}}\r\n        <input class="u-input" name="password" [[#if switchSmime]]disabled[[/if]] type="password"/>\r\n      </label>\r\n    </div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="passEditTpl">\r\n    <form action="#" method="post" name="changePwd" class="u-form" onsubmit="return false;">\r\n      <div class="u-btns-top">\r\n        <button type="button" data-action="changePwd" disabled="" class="u-btn u-btn-primary">{{i18n "setting/op_save"}}</button>\r\n        <button type="reset" class="u-btn u-btn-default " data-action="cancel">{{i18n "setting/op_cancel"}}</button>\r\n      </div>\r\n      <h4>{{i18n "pref/smime_pwd_fix"}}</h4>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">{{i18n "pref/old_smime_pwd"}}</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input class="u-input" type="password" name="oldPassword" />\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">{{i18n "pref/new_smime_pwd"}}</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input class="u-input" name="newPassword" type="password" />\r\n          <span class="strengthHint">{{i18n "pref/smime_newl_pwd_limit"}}</span>\r\n        </div>\r\n      </div>\r\n\r\n      <div class="u-form-item">\r\n        <div class="f-fl">\r\n          <label class="u-form-label">{{i18n "pref/re_new_smime_pwd"}}</label>\r\n        </div>\r\n        <div class="u-form-value">\r\n          <input class="u-input" name="rePassword" type="password" />\r\n          <span class="notify f-dn">{{i18n "pref/smime_mustsame"}}</span>\r\n        </div>\r\n      </div>\r\n\r\n    </form>\r\n  </script>\r\n  {{/raw}}\r\n</section>'}),define("module/setting/security/smime/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","./service","i18n","configurable/index","text!template/module/setting/security/smime/index.tpl.html"],function(e){e("util/i18n!setting,pref");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("component/confirmbox"),s=e("./service"),o=e("i18n"),l=e("configurable/index"),c=n.extend({Implements:a,setup:function(){c.superclass.setup.call(this),this.config=l("setting.security",this),this.switchSmime=this.config.opensmimekeypass},render:function(){c.superclass.render.call(this),this._initView()},events:{"click [data-action]":"_dispatchAction",'blur input[name="newPassword"]':"_checkInputValue1",'blur input[name="rePassword"]':"_checkInputValue2","click form input":"_checkUserEdit"},_initView:function(){var e=this.$("#switchSmimeTpl").html(),t=this.compile(e,{switchSmime:this.config.opensmimekeypass});this.$("#switchSmime").html(t),this.element.customRadioCheckbox()},_togglePanel:function(){this.$(".main-wrapper").toggleClass("toggled")},_handleChangePwd:function(){var e=this,n=e.$("form[name='changePwd']").serializeJSON(),i={password:n.oldPassword,enableKeyPass:!0,smimeKeyPass:n.newPassword};return e.$("input[name=newPassword]").parent().hasClass("error-less")||e.$("input[name=rePassword]").parent().hasClass("error")?!1:n.oldPassword?n.newPassword?void(n.newPassword===n.rePassword&&(delete n.rePassword,s.setSmimeKeyPass(i).then(function(){return n.newPassword===n.oldPassword?r.alert(o.t("pref/smime_mustDifferentPass")):(t.notify(o.t("pref/smime_successMod")),e.$(".main-wrapper").removeClass("switched-edit"),void e.element.customRadioCheckbox())},function(t){e.$(".j-pwd-edit").find(".u-input").val(""),"FA_INVALID_PARAMETER"===t.responseJSON.code&&r.alert(o.t("pref/smime_pwd_err")),"FA_UNAUTHORIZED"===t.responseJSON.code&&r.alert(o.t("pref/smime_pwd_err"))}))):r.alert(o.t("pref/smime_new_pwd_empty")):r.alert(o.t("pref/smime_please_input_pwd"))},_handleSwitchPwd:function(){var e=this,n=e.$("form[name=smime]").serializeJSON();if("true"===n.enableKeyPass){if(e.switchSmime)return t.notify(o.t("pref/smime_had_start")),!1}else{if(!e.switchSmime)return t.notify(o.t("pref/smime_had_stop")),!1;if(0===n.password.length)return r.alert(o.t("pref/smime_pwd_empty")),!1}s.setSmimeKeyPass(n).then(function(){
"true"===n.enableKeyPass?(t.notify(o.t("pref/smime_suc_start")),e.$("[data-action=editPwd]").attr("data-click",""),e.switchSmime=!0,location.reload()):(t.notify(o.t("pref/smime_suc_stop")),e.$("form[name=smime]").find(".u-input").val(""),e.$("[data-action=editPwd]").attr("data-click","false_click"),e.switchSmime=!1,location.reload())},function(e){"FA_INVALID_PARAMETER"===e.responseJSON.code&&r.alert(o.t("pref/smime_pwd_empty")),"FA_UNAUTHORIZED"===e.responseJSON.code&&r.alert(o.t("pref/smime_pwd_err"))})},_handleCancel:function(){this.switchSmime?this.$("[data-action=start]").trigger("click"):(this.$("[data-action=stop]").trigger("click"),this.$("[data-action=start]").attr("checked",!1))},_handleStart:function(){this.$("form[name='smime']").find(".u-input").val("").attr("disabled",!0)},_handleStop:function(){this.$("form[name='smime']").find(".u-input").attr("disabled",!1)},_checkUserEdit:function(){this.editFlag||(this.$("button[data-action = changePwd]").prop("disabled",!1),this.editFlag=!0),this.saveFlag||(this.$("button[data-action = save]").prop("disabled",!1),this.saveFlag=!0)},_checkInputValue1:function(e,n){t(n).val().length<6?t(n).parent().addClass("error-less"):t(n).parent().removeClass("error-less")},_checkInputValue2:function(e,n){var i=t(n).val(),a=this.$("input[name='newPassword']").val();i!==a?t(n).parent().addClass("error"):t(n).parent().removeClass("error")},_dispatchAction:function(e,n){var i,a=this,r=t(n).data("action");switch(r){case"editPwd":if(!a.switchSmime)return;i=a.compile(a.$("#passEditTpl").html(),{}),a.$(".j-pwd-edit").html(i),a.editFlag=!1,a.$(".main-wrapper").addClass("switched-edit");break;case"cancel":a.$(".main-wrapper").removeClass("switched-edit"),a.editFlag=!1;break;case"start":a._handleStart();break;case"stop":a._handleStop();break;case"changePwd":a._handleChangePwd();break;case"save":a._handleSwitchPwd();break;case"cancel_fix":a._handleCancel()}}});i.module({name:"setting.security.smime",template:e("text!template/module/setting/security/smime/index.tpl.html")},c)});var QRCode;!function(){function e(e){this.mode=c.MODE_8BIT_BYTE,this.data=e,this.parsedData=[];for(var t=0,n=this.data.length;n>t;t++){var i=[],a=this.data.charCodeAt(t);a>65536?(i[0]=240|(1835008&a)>>>18,i[1]=128|(258048&a)>>>12,i[2]=128|(4032&a)>>>6,i[3]=128|63&a):a>2048?(i[0]=224|(61440&a)>>>12,i[1]=128|(4032&a)>>>6,i[2]=128|63&a):a>128?(i[0]=192|(1984&a)>>>6,i[1]=128|63&a):i[0]=a,this.parsedData.push(i)}this.parsedData=Array.prototype.concat.apply([],this.parsedData),this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function t(e,t){this.typeNumber=e,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function n(e,t){if(void 0==e.length)throw new Error(e.length+"/"+t);for(var n=0;n<e.length&&0==e[n];)n++;this.num=new Array(e.length-n+t);for(var i=0;i<e.length-n;i++)this.num[i]=e[i+n]}function i(e,t){this.totalCount=e,this.dataCount=t}function a(){this.buffer=[],this.length=0}function r(){return"undefined"!=typeof CanvasRenderingContext2D}function s(){var e=!1,t=navigator.userAgent;if(/android/i.test(t)){e=!0;var n=t.toString().match(/android ([0-9]\.[0-9])/i);n&&n[1]&&(e=parseFloat(n[1]))}return e}function o(e,t){for(var n=1,i=l(e),a=0,r=f.length;r>=a;a++){var s=0;switch(t){case d.L:s=f[a][0];break;case d.M:s=f[a][1];break;case d.Q:s=f[a][2];break;case d.H:s=f[a][3]}if(s>=i)break;n++}if(n>f.length)throw new Error("Too long data");return n}function l(e){var t=encodeURI(e).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");return t.length+(t.length!=e?3:0)}e.prototype={getLength:function(e){return this.parsedData.length},write:function(e){for(var t=0,n=this.parsedData.length;n>t;t++)e.put(this.parsedData[t],8)}},t.prototype={addData:function(t){var n=new e(t);this.dataList.push(n),this.dataCache=null},isDark:function(e,t){if(0>e||this.moduleCount<=e||0>t||this.moduleCount<=t)throw new Error(e+","+t);return this.modules[e][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(e,n){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var i=0;i<this.moduleCount;i++){this.modules[i]=new Array(this.moduleCount);for(var a=0;a<this.moduleCount;a++)this.modules[i][a]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(e,n),this.typeNumber>=7&&this.setupTypeNumber(e),null==this.dataCache&&(this.dataCache=t.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,n)},setupPositionProbePattern:function(e,t){for(var n=-1;7>=n;n++)if(!(-1>=e+n||this.moduleCount<=e+n))for(var i=-1;7>=i;i++)-1>=t+i||this.moduleCount<=t+i||(n>=0&&6>=n&&(0==i||6==i)||i>=0&&6>=i&&(0==n||6==n)||n>=2&&4>=n&&i>=2&&4>=i?this.modules[e+n][t+i]=!0:this.modules[e+n][t+i]=!1)},getBestMaskPattern:function(){for(var e=0,t=0,n=0;8>n;n++){this.makeImpl(!0,n);var i=p.getLostPoint(this);(0==n||e>i)&&(e=i,t=n)}return t},createMovieClip:function(e,t,n){var i=e.createEmptyMovieClip(t,n),a=1;this.make();for(var r=0;r<this.modules.length;r++)for(var s=r*a,o=0;o<this.modules[r].length;o++){var l=o*a,c=this.modules[r][o];c&&(i.beginFill(0,100),i.moveTo(l,s),i.lineTo(l+a,s),i.lineTo(l+a,s+a),i.lineTo(l,s+a),i.endFill())}return i},setupTimingPattern:function(){for(var e=8;e<this.moduleCount-8;e++)null==this.modules[e][6]&&(this.modules[e][6]=e%2==0);for(var t=8;t<this.moduleCount-8;t++)null==this.modules[6][t]&&(this.modules[6][t]=t%2==0)},setupPositionAdjustPattern:function(){for(var e=p.getPatternPosition(this.typeNumber),t=0;t<e.length;t++)for(var n=0;n<e.length;n++){var i=e[t],a=e[n];if(null==this.modules[i][a])for(var r=-2;2>=r;r++)for(var s=-2;2>=s;s++)-2==r||2==r||-2==s||2==s||0==r&&0==s?this.modules[i+r][a+s]=!0:this.modules[i+r][a+s]=!1}},setupTypeNumber:function(e){for(var t=p.getBCHTypeNumber(this.typeNumber),n=0;18>n;n++){var i=!e&&1==(t>>n&1);this.modules[Math.floor(n/3)][n%3+this.moduleCount-8-3]=i}for(var n=0;18>n;n++){var i=!e&&1==(t>>n&1);this.modules[n%3+this.moduleCount-8-3][Math.floor(n/3)]=i}},setupTypeInfo:function(e,t){for(var n=this.errorCorrectLevel<<3|t,i=p.getBCHTypeInfo(n),a=0;15>a;a++){var r=!e&&1==(i>>a&1);6>a?this.modules[a][8]=r:8>a?this.modules[a+1][8]=r:this.modules[this.moduleCount-15+a][8]=r}for(var a=0;15>a;a++){var r=!e&&1==(i>>a&1);8>a?this.modules[8][this.moduleCount-a-1]=r:9>a?this.modules[8][15-a-1+1]=r:this.modules[8][15-a-1]=r}this.modules[this.moduleCount-8][8]=!e},mapData:function(e,t){for(var n=-1,i=this.moduleCount-1,a=7,r=0,s=this.moduleCount-1;s>0;s-=2)for(6==s&&s--;;){for(var o=0;2>o;o++)if(null==this.modules[i][s-o]){var l=!1;r<e.length&&(l=1==(e[r]>>>a&1));var c=p.getMask(t,i,s-o);c&&(l=!l),this.modules[i][s-o]=l,a--,-1==a&&(r++,a=7)}if(i+=n,0>i||this.moduleCount<=i){i-=n,n=-n;break}}}},t.PAD0=236,t.PAD1=17,t.createData=function(e,n,r){for(var s=i.getRSBlocks(e,n),o=new a,l=0;l<r.length;l++){var c=r[l];o.put(c.mode,4),o.put(c.getLength(),p.getLengthInBits(c.mode,e)),c.write(o)}for(var d=0,l=0;l<s.length;l++)d+=s[l].dataCount;if(o.getLengthInBits()>8*d)throw new Error("code length overflow. ("+o.getLengthInBits()+">"+8*d+")");for(o.getLengthInBits()+4<=8*d&&o.put(0,4);o.getLengthInBits()%8!=0;)o.putBit(!1);for(;;){if(o.getLengthInBits()>=8*d)break;if(o.put(t.PAD0,8),o.getLengthInBits()>=8*d)break;o.put(t.PAD1,8)}return t.createBytes(o,s)},t.createBytes=function(e,t){for(var i=0,a=0,r=0,s=new Array(t.length),o=new Array(t.length),l=0;l<t.length;l++){var c=t[l].dataCount,d=t[l].totalCount-c;a=Math.max(a,c),r=Math.max(r,d),s[l]=new Array(c);for(var u=0;u<s[l].length;u++)s[l][u]=255&e.buffer[u+i];i+=c;var m=p.getErrorCorrectPolynomial(d),h=new n(s[l],m.getLength()-1),f=h.mod(m);o[l]=new Array(m.getLength()-1);for(var u=0;u<o[l].length;u++){var v=u+f.getLength()-o[l].length;o[l][u]=v>=0?f.get(v):0}}for(var g=0,u=0;u<t.length;u++)g+=t[u].totalCount;for(var b=new Array(g),_=0,u=0;a>u;u++)for(var l=0;l<t.length;l++)u<s[l].length&&(b[_++]=s[l][u]);for(var u=0;r>u;u++)for(var l=0;l<t.length;l++)u<o[l].length&&(b[_++]=o[l][u]);return b};for(var c={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},d={L:1,M:0,Q:3,H:2},u={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7},p={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(e){for(var t=e<<10;p.getBCHDigit(t)-p.getBCHDigit(p.G15)>=0;)t^=p.G15<<p.getBCHDigit(t)-p.getBCHDigit(p.G15);return(e<<10|t)^p.G15_MASK},getBCHTypeNumber:function(e){for(var t=e<<12;p.getBCHDigit(t)-p.getBCHDigit(p.G18)>=0;)t^=p.G18<<p.getBCHDigit(t)-p.getBCHDigit(p.G18);return e<<12|t},getBCHDigit:function(e){for(var t=0;0!=e;)t++,e>>>=1;return t},getPatternPosition:function(e){return p.PATTERN_POSITION_TABLE[e-1]},getMask:function(e,t,n){switch(e){case u.PATTERN000:return(t+n)%2==0;case u.PATTERN001:return t%2==0;case u.PATTERN010:return n%3==0;case u.PATTERN011:return(t+n)%3==0;case u.PATTERN100:return(Math.floor(t/2)+Math.floor(n/3))%2==0;case u.PATTERN101:return t*n%2+t*n%3==0;case u.PATTERN110:return(t*n%2+t*n%3)%2==0;case u.PATTERN111:return(t*n%3+(t+n)%2)%2==0;default:throw new Error("bad maskPattern:"+e)}},getErrorCorrectPolynomial:function(e){for(var t=new n([1],0),i=0;e>i;i++)t=t.multiply(new n([1,m.gexp(i)],0));return t},getLengthInBits:function(e,t){if(t>=1&&10>t)switch(e){case c.MODE_NUMBER:return 10;case c.MODE_ALPHA_NUM:return 9;case c.MODE_8BIT_BYTE:return 8;case c.MODE_KANJI:return 8;default:throw new Error("mode:"+e)}else if(27>t)switch(e){case c.MODE_NUMBER:return 12;case c.MODE_ALPHA_NUM:return 11;case c.MODE_8BIT_BYTE:return 16;case c.MODE_KANJI:return 10;default:throw new Error("mode:"+e)}else{if(!(41>t))throw new Error("type:"+t);switch(e){case c.MODE_NUMBER:return 14;case c.MODE_ALPHA_NUM:return 13;case c.MODE_8BIT_BYTE:return 16;case c.MODE_KANJI:return 12;default:throw new Error("mode:"+e)}}},getLostPoint:function(e){for(var t=e.getModuleCount(),n=0,i=0;t>i;i++)for(var a=0;t>a;a++){for(var r=0,s=e.isDark(i,a),o=-1;1>=o;o++)if(!(0>i+o||i+o>=t))for(var l=-1;1>=l;l++)0>a+l||a+l>=t||(0!=o||0!=l)&&s==e.isDark(i+o,a+l)&&r++;r>5&&(n+=3+r-5)}for(var i=0;t-1>i;i++)for(var a=0;t-1>a;a++){var c=0;e.isDark(i,a)&&c++,e.isDark(i+1,a)&&c++,e.isDark(i,a+1)&&c++,e.isDark(i+1,a+1)&&c++,(0==c||4==c)&&(n+=3)}for(var i=0;t>i;i++)for(var a=0;t-6>a;a++)e.isDark(i,a)&&!e.isDark(i,a+1)&&e.isDark(i,a+2)&&e.isDark(i,a+3)&&e.isDark(i,a+4)&&!e.isDark(i,a+5)&&e.isDark(i,a+6)&&(n+=40);for(var a=0;t>a;a++)for(var i=0;t-6>i;i++)e.isDark(i,a)&&!e.isDark(i+1,a)&&e.isDark(i+2,a)&&e.isDark(i+3,a)&&e.isDark(i+4,a)&&!e.isDark(i+5,a)&&e.isDark(i+6,a)&&(n+=40);for(var d=0,a=0;t>a;a++)for(var i=0;t>i;i++)e.isDark(i,a)&&d++;var u=Math.abs(100*d/t/t-50)/5;return n+=10*u}},m={glog:function(e){if(1>e)throw new Error("glog("+e+")");return m.LOG_TABLE[e]},gexp:function(e){for(;0>e;)e+=255;for(;e>=256;)e-=255;return m.EXP_TABLE[e]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)},h=0;8>h;h++)m.EXP_TABLE[h]=1<<h;for(var h=8;256>h;h++)m.EXP_TABLE[h]=m.EXP_TABLE[h-4]^m.EXP_TABLE[h-5]^m.EXP_TABLE[h-6]^m.EXP_TABLE[h-8];for(var h=0;255>h;h++)m.LOG_TABLE[m.EXP_TABLE[h]]=h;n.prototype={get:function(e){return this.num[e]},getLength:function(){return this.num.length},multiply:function(e){for(var t=new Array(this.getLength()+e.getLength()-1),i=0;i<this.getLength();i++)for(var a=0;a<e.getLength();a++)t[i+a]^=m.gexp(m.glog(this.get(i))+m.glog(e.get(a)));return new n(t,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;for(var t=m.glog(this.get(0))-m.glog(e.get(0)),i=new Array(this.getLength()),a=0;a<this.getLength();a++)i[a]=this.get(a);for(var a=0;a<e.getLength();a++)i[a]^=m.gexp(m.glog(e.get(a))+t);return new n(i,0).mod(e)}},i.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],i.getRSBlocks=function(e,t){var n=i.getRsBlockTable(e,t);if(void 0==n)throw new Error("bad rs block @ typeNumber:"+e+"/errorCorrectLevel:"+t);for(var a=n.length/3,r=[],s=0;a>s;s++)for(var o=n[3*s+0],l=n[3*s+1],c=n[3*s+2],d=0;o>d;d++)r.push(new i(l,c));return r},i.getRsBlockTable=function(e,t){switch(t){case d.L:return i.RS_BLOCK_TABLE[4*(e-1)+0];case d.M:return i.RS_BLOCK_TABLE[4*(e-1)+1];case d.Q:return i.RS_BLOCK_TABLE[4*(e-1)+2];case d.H:return i.RS_BLOCK_TABLE[4*(e-1)+3];default:return}},a.prototype={get:function(e){var t=Math.floor(e/8);return 1==(this.buffer[t]>>>7-e%8&1)},put:function(e,t){for(var n=0;t>n;n++)this.putBit(1==(e>>>t-n-1&1))},getLengthInBits:function(){return this.length},putBit:function(e){var t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),e&&(this.buffer[t]|=128>>>this.length%8),this.length++}};var f=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]],v=function(){var e=function(e,t){this._el=e,this._htOption=t};return e.prototype.draw=function(e){function t(e,t){var n=document.createElementNS("http://www.w3.org/2000/svg",e);for(var i in t)t.hasOwnProperty(i)&&n.setAttribute(i,t[i]);return n}var n=this._htOption,i=this._el,a=e.getModuleCount();Math.floor(n.width/a),Math.floor(n.height/a);this.clear();var r=t("svg",{viewBox:"0 0 "+String(a)+" "+String(a),width:"100%",height:"100%",fill:n.colorLight});r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),i.appendChild(r),r.appendChild(t("rect",{fill:n.colorLight,width:"100%",height:"100%"})),r.appendChild(t("rect",{fill:n.colorDark,width:"1",height:"1",id:"template"}));for(var s=0;a>s;s++)for(var o=0;a>o;o++)if(e.isDark(s,o)){var l=t("use",{x:String(o),y:String(s)});l.setAttributeNS("http://www.w3.org/1999/xlink","href","#template"),r.appendChild(l)}},e.prototype.clear=function(){for(;this._el.hasChildNodes();)this._el.removeChild(this._el.lastChild)},e}(),g="svg"===document.documentElement.tagName.toLowerCase(),b=g?v:r()?function(){function e(){this._elImage.src=this._elCanvas.toDataURL("image/png"),this._elImage.style.display="block",this._elCanvas.style.display="none"}function t(e,t){var n=this;if(n._fFail=t,n._fSuccess=e,null===n._bSupportDataURI){var i=document.createElement("img"),a=function(){n._bSupportDataURI=!1,n._fFail&&n._fFail.call(n)},r=function(){n._bSupportDataURI=!0,n._fSuccess&&n._fSuccess.call(n)};return i.onabort=a,i.onerror=a,i.onload=r,void(i.src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==")}n._bSupportDataURI===!0&&n._fSuccess?n._fSuccess.call(n):n._bSupportDataURI===!1&&n._fFail&&n._fFail.call(n)}if(this._android&&this._android<=2.1){var n=1/window.devicePixelRatio,i=CanvasRenderingContext2D.prototype.drawImage;CanvasRenderingContext2D.prototype.drawImage=function(e,t,a,r,s,o,l,c,d){if("nodeName"in e&&/img/i.test(e.nodeName))for(var u=arguments.length-1;u>=1;u--)arguments[u]=arguments[u]*n;else"undefined"==typeof c&&(arguments[1]*=n,arguments[2]*=n,arguments[3]*=n,arguments[4]*=n);i.apply(this,arguments)}}var a=function(e,t){this._bIsPainted=!1,this._android=s(),this._htOption=t,this._elCanvas=document.createElement("canvas"),this._elCanvas.width=t.width,this._elCanvas.height=t.height,e.appendChild(this._elCanvas),this._el=e,this._oContext=this._elCanvas.getContext("2d"),this._bIsPainted=!1,this._elImage=document.createElement("img"),this._elImage.alt="Scan me!",this._elImage.style.display="none",this._el.appendChild(this._elImage),this._bSupportDataURI=null};return a.prototype.draw=function(e){var t=this._elImage,n=this._oContext,i=this._htOption,a=e.getModuleCount(),r=i.width/a,s=i.height/a,o=Math.round(r),l=Math.round(s);t.style.display="none",this.clear();for(var c=0;a>c;c++)for(var d=0;a>d;d++){var u=e.isDark(c,d),p=d*r,m=c*s;n.strokeStyle=u?i.colorDark:i.colorLight,n.lineWidth=1,n.fillStyle=u?i.colorDark:i.colorLight,n.fillRect(p,m,r,s),n.strokeRect(Math.floor(p)+.5,Math.floor(m)+.5,o,l),n.strokeRect(Math.ceil(p)-.5,Math.ceil(m)-.5,o,l)}this._bIsPainted=!0},a.prototype.makeImage=function(){this._bIsPainted&&t.call(this,e)},a.prototype.isPainted=function(){return this._bIsPainted},a.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),this._bIsPainted=!1},a.prototype.round=function(e){return e?Math.floor(1e3*e)/1e3:e},a}():function(){var e=function(e,t){this._el=e,this._htOption=t};return e.prototype.draw=function(e){for(var t=this._htOption,n=this._el,i=e.getModuleCount(),a=Math.floor(t.width/i),r=Math.floor(t.height/i),s=['<table style="border:0;border-collapse:collapse;">'],o=0;i>o;o++){s.push("<tr>");for(var l=0;i>l;l++)s.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:'+a+"px;height:"+r+"px;background-color:"+(e.isDark(o,l)?t.colorDark:t.colorLight)+';"></td>');s.push("</tr>")}s.push("</table>"),n.innerHTML=s.join("");var c=n.childNodes[0],d=(t.width-c.offsetWidth)/2,u=(t.height-c.offsetHeight)/2;d>0&&u>0&&(c.style.margin=u+"px "+d+"px")},e.prototype.clear=function(){this._el.innerHTML=""},e}();QRCode=function(e,t){if(this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:d.H},"string"==typeof t&&(t={text:t}),t)for(var n in t)this._htOption[n]=t[n];"string"==typeof e&&(e=document.getElementById(e)),this._htOption.useSVG&&(b=v),this._android=s(),this._el=e,this._oQRCode=null,this._oDrawing=new b(this._el,this._htOption),this._htOption.text&&this.makeCode(this._htOption.text)},QRCode.prototype.makeCode=function(e){this._oQRCode=new t(o(e,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(e),this._oQRCode.make(),this._el.title=e,this._oDrawing.draw(this._oQRCode),this.makeImage()},QRCode.prototype.makeImage=function(){"function"==typeof this._oDrawing.makeImage&&(!this._android||this._android>=3)&&this._oDrawing.makeImage()},QRCode.prototype.clear=function(){this._oDrawing.clear()},QRCode.CorrectLevel=d}(),define("qrcode",function(e){return function(){var t;return t||e.QRCode}}(this)),function(){define("module/setting/security/twofactorauth/altPwdService",["require","exports","module","jquery","../../../../util/index","module/common/globalService"],function(e,t,n){function i(e,t){return{module:"module.setting.security.logindevices.altPwdService",msg:e,meta:t}}function a(){var e=o.Deferred();return l.xhr.simpleCall({query:{func:"user:listAppPwds",sid:c.getSid()}},function(t){e.resolve(t)},function(t,n,a){e.reject(i("list alternative passwords failed",a))}),e.promise()}function r(e){var t,n,a=o.Deferred();if(!o.isPlainObject(e))return a.reject(i("invalid params object type required!",e));if(t=e.ids,o.isArray(t))for(var r=0;r<t.length;++r){if(n=parseInt(t[r],10),isNaN(n))return a.reject(i("invalid params: ids shall be int type of array"),e);t[r]=n}else{if(t=parseInt(t,10),isNaN(t))return a.reject(i("invalid params: ids shall be int type of array"),e);e.ids=[t]}return l.xhr.simpleCall({query:{func:"user:deleteAppPwds",sid:c.getSid()},data:e},function(e){a.resolve(e)},function(e,t,n){a.reject(i("delete alternative password failed",n))}),a.promise()}function s(e){var t=o.Deferred();return o.isPlainObject(e)?(l.xhr.simpleCall({query:{func:"user:addAppPwd",sid:c.getSid()},data:e},function(e){t.resolve(e)},function(e,n,a){t.reject(i("add alternative password failed",a))}),t.promise()):t.reject(i("invalid params object type required!",e))}var o=e("jquery"),l=e("../../../../util/index"),c=e("module/common/globalService");n.exports={listAltPwdList:a,deleteAltPwd:r,addAltPwd:s}})}(),define("components/requirejs-text/text!template/module/setting/security/twofactorauth/altpwd.tpl.html",[],function(){return'<div class="m-setting-twofactorauth-altpwd">\r\n  <div class="title dotted">\r\n    <h4>\r\n      {{ i18n "setting/msg_altpwd_title" }}\r\n    </h4>\r\n  </div>\r\n  <div class="sub-module-main j-main">\r\n\r\n  </div>\r\n\r\n  {{#raw}}\r\n\r\n  <!--  -->\r\n  <script type="text/x-handlebars-template" id="disableTpl">\r\n    <p>{{ i18n "setting/msg_altpwd_disable" }}</p>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="mainTpl">\r\n    <ul class="altpwd-list f-cf j-pwd-list">\r\n      <li class="altpwd-item add-item j-add-item j-item-action" data-action="add">\r\n        <i class="iconfont iconadd"></i>\r\n      </li>\r\n    </ul>\r\n  </script>\r\n\r\n  <!--  item  -->\r\n  <script type="text/x-handlebars-template" id="itemTpl">\r\n    <li class="altpwd-item _panel _panel-xs j-altpwd-item" data-pwdId="[[id]]">\r\n      <div class="_panel-body">\r\n        <p class="pwd-info-name f-ellipsis">[[i18n "setting/lbl_altpwd_name"]][[name]]</p>\r\n        <p class="pwd-info-last">[[i18n "setting/lbl_altpwd_last_date"]][[access]]</p>\r\n      </div>\r\n      <div class="_panel-footer">\r\n        <span class="pwd-info-create">[[i18n "setting/lbl_altpwd_create_time"]][[create]]</span>\r\n        <div class="f-fr">\r\n          <a href="javascript:void(0);" class="item-action j-item-action" data-action="remove">&#91;[[ i18n "setting/op_remove"]]&#93;</a>\r\n        </div>\r\n      </div>\r\n    </li>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="generateInputTpl">\r\n    <div>\r\n      <label><strong>[[i18n "setting/lbl_altpwd_name"]]</strong></label>\r\n      <input type="text" class="u-input j-input-name" value="" maxlength="20" placeholder="[[i18n \'setting/lbl_altpwd_name_placeholder\']]" />\r\n    </div>\r\n    <div class="j-error generate-error f-dn"></div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="generateSuccessTpl">\r\n    <p class="pwd-head module-desc">\r\n      <i class="dot"></i>\r\n      <span class="text">[[i18n "setting/lbl_altpwd_password_info_title" name=name]]</span>\r\n    </p>\r\n    <div class="pwd-value">\r\n      <input type="text" class="u-input" value="[[ SubPwd pwd 1 ]]" readonly>\r\n      <span></span>\r\n      <input type="text" class="u-input" value="[[ SubPwd pwd 2 ]]" readonly>\r\n      <span></span>\r\n      <input type="text" class="u-input" value="[[ SubPwd pwd 3 ]]" readonly>\r\n      <span></span>\r\n      <input type="text" class="u-input" value="[[ SubPwd pwd 4 ]]" readonly>\r\n      <button class="u-btn u-btn-default j-copy-pwd copy-pwd" data-clipboard-text="[[pwd]]" data-clipboard-action="copy">\r\n        [[i18n "setting/lbl_altpwd_password_copy_title"]]\r\n      </button>\r\n    </div>\r\n    <p class="pwd-instruction">[[[i18n "setting/lbl_altpwd_password_desc"]]]</p>\r\n  </script>\r\n\r\n  {{/raw}}\r\n</div>'}),function(){define("module/setting/security/twofactorauth/altpwd",["require","exports","module","i18n!setting,common","jquery","i18n","moment","cui/core/view/view","cui/util/templatable/templatable","configurable/index","./altPwdService","component/confirmbox","cui/ui/tip/tip","widget/clipboard/clipboard","text!template/module/setting/security/twofactorauth/altpwd.tpl.html"],function(e,t,n){function i(e,t){this.pwds=this.format(e),this.updateCb=a.isFunction(t)?t:a.noop}e("i18n!setting,common");var a=e("jquery"),r=e("i18n"),s=e("moment"),o=e("cui/core/view/view"),l=e("cui/util/templatable/templatable"),c=e("configurable/index"),d=e("./altPwdService"),u=e("component/confirmbox"),p=e("cui/ui/tip/tip"),m=e("widget/clipboard/clipboard");i.prototype.format=function(e){for(var t,n=0;n<e.length;++n)t=e[n],t.id=parseInt(t.id,10),t.access=t.access?s(t.access).format("YYYY-MM-DD"):r.t("setting/lbl_altpwd_last_date_null"),t.create=t.create?s(t.create).format("YYYY-MM-DD HH:mm"):r.t("setting/lbl_altpwd_last_date_null");return e},i.prototype.add=function(e){var t=this.pwds;if(!a.isPlainObject(e)||!e.id)return!1;e.id=parseInt(e.id,10);for(var n=0;n<t.length;++n)if(t[n].id===e.id)return!1;this.pwds.push(this.format([e])[0]),this.updateCb("add",e)},i.prototype.remove=function(e){var t=this.pwds;if(null==e)return!1;for(var n=0;n<t.length&&t[n].id!=e;++n);n<t.length&&(t.splice(n,1),this.updateCb("remove",e))},i.prototype.clean=function(){this.pwds.length>0&&(this.pwds=[],this.updateCb("clean"))};var h=o.extend({Implements:l,pwdSet:null,supportAltPwd:!1,config:{sizeMax:6},attrs:{name:"setting.security.twofactorauth.altpwd",authType:null,template:e("text!template/module/setting/security/twofactorauth/altpwd.tpl.html")},events:{"click .j-item-action":"_handlePwdActionClick"},setup:function(){h.superclass.setup.call(this),a.extend(this.config,c("setting.security",this)),this.render()},render:function(){h.superclass.render.call(this),this.supportAltPwd=this.config.supportAlternativePassword,this._doRender(),this._initModuleEvent()},destroy:function(){this.pwdSet.clean(),h.superclass.destroy.call(this)},_initModuleEvent:function(){var e=this;this.unsubscribe("setting.security.twofactorauth","authStatusChange").subscribe("setting.security.twofactorauth","authStatusChange",function(t){e.set("authType",t.message),e._doRender()})},_initStore:function(e){var t=this;e=a.isFunction(e)?e:a.noop,d.listAltPwdList().then(function(n){t.pwdSet=new i(n,a.proxy(t._pwdSetUpdateObserver,t)),e.call(t)},function(e){console.log(e.msg)})},_doRender:function(){null==this.get("authType")?(this._toggleElement(!0),this._cleanPwdList()):this.supportAltPwd?(this._toggleElement(),this._initStore(this._renderPwdSet)):(this._toggleElement(),this._renderForbidden())},_renderForbidden:function(){var e=this.$("#disableTpl").html();this.$(".j-main").empty().html(this.compile(e))},_renderPwdSet:function(){var e,t=this,n=this.$("#mainTpl").html(),i=[];this.$(".j-main").empty().html(this.compile(n)),e=this.$(".j-pwd-list"),a.each(this.pwdSet.pwds,function(e,n){i.push(t._compilePwdItemTpl(n))}),i=i.join(""),e.prepend(i),this._updateAddItemBtn()},_toggleElement:function(e){e="boolean"==typeof e?e:!1,e?this.element.addClass("f-dn"):this.element.removeClass("f-dn")},_compilePwdItemTpl:function(e){var t=this.$("#itemTpl").html();return this.compile(t,e)},_cleanPwdList:function(){function e(){t.pwdSet&&t.pwdSet.clean()}for(var t=this,n=[],i=0,r=this.pwdSet&&this.pwdSet.pwds||[];i<r.length;++i)n.push(parseInt(r[i].id,10));return n.length?void d.deleteAltPwd({ids:n}).then(function(){e()},function(e){a.notify.error(e.msg)}):e()},_handlePwdActionClick:function(e){e.preventDefault();var t=a(e.currentTarget).attr("data-action");switch(t){case"add":this._handleAddPwd(e);break;case"remove":this._handleRemovePwd(e)}},_handleAddPwd:function(e){function t(){function t(e){null!=t.timeoutId&&clearTimeout(t.timeoutId),m.html(e).removeClass(c),t.timeoutId=setTimeout(function(){m.html("").addClass(c)},5e3)}i.element.addClass("m-setting-twofactorauth-altpwd-addbox f-cf"),i.set("subClass","adding"),s=i.$("[data-role=message]");var u=s.find(".j-input-name"),p=i.$("[data-role=confirm]"),m=s.find(".j-error");u.on("keyup",function(){var e=a(this);e.val().length?p.removeClass(l):p.addClass(l)}),p.addClass(l),i.off("confirm").on("confirm",function(){e.preventDefault();var i,a;return p.hasClass(l)?!1:(i=u.val(),i.length?(a={name:i,logintype:"default",desc:""},void d.addAltPwd(a).then(function(e){a.id=e.id,a.pwd=e.pwd,a.create=new Date,o.pwdSet.add(a),n(a)},function(e){t(e.msg)})):t(r.t("setting/lbl_altpwd_generate_name_empty")))})}function n(e){function t(e){e===!0?a=new p({zIndex:999,trigger:n,content:r.t("setting/lbl_altpwd_password_copy_tip"),inViewport:!0,arrowPosition:1}).after("hide",function(){this.set("content",r.t("setting/lbl_altpwd_password_copy_tip"))}):(a.set("content",e),a._setAlign())}var n,a,s;i.set("subClass","done").set("width",500).set("message",o.compile(o.$("#generateSuccessTpl").html(),e)).set("cancelTpl",!1).set("confirmTpl",r.t("setting/lbl_altpwd_done")).off("confirm").on("confirm",function(){i.hide()}).after("hide",function(){s&&s.destroy()}),n=i.$(".j-copy-pwd"),t(!0),s=new m(n[0]).on("success",function(){
t(r.t("setting/lbl_altpwd_password_copy_success"))}).on("error",function(){t(r.t("setting/lbl_altpwd_password_copy_fail"))})}var i,s,o=this,l="disabled",c="f-dn";return a(e.currentTarget).hasClass("disabled")?!1:(i=new u({width:378,title:r.t("setting/lbl_altpwd_generate_title"),message:this.compile(this.$("#generateInputTpl").html(),{}),confirmTpl:r.t("setting/lbl_altpwd_generate")}),void i.after("show",t).show().after("hide",function(){this.destroy()}))},_handleRemovePwd:function(e){e.preventDefault();var t=this,n=a(e.target).closest(".j-altpwd-item"),i=n.attr("data-pwdId");u.confirm(r.t("setting/lbl_altpwd_delete_confirm_info"),function(){d.deleteAltPwd({ids:i}).then(function(){a.notify.success(r.t("setting/lbl_altpwd_delete_success")),t.pwdSet.remove(i)},function(){a.notify.error(r.t("setting/lbl_altpwd_delete_fail"))})},!1)},_insertPwdItemDom:function(e){var t=this.$(".j-pwd-list"),n=this._compilePwdItemTpl(e);t.prepend(n)},_removePwdItemDom:function(e){var t,n=this.$(".j-pwd-list").find(".j-altpwd-item"),i=0;return null==e?!1:(a.isArray(e)||(e=[e]),t=e.length,void n.each(function(){var n=a(this);return i>=t?!1:void a.each(e,function(e,t){return n.attr("data-pwdId")==t?(n.remove(),++i,!1):void 0})}))},_updateAddItemBtn:function(){var e,t=this.$(".j-add-item");this.pwdSet&&this.pwdSet.pwds.length>=this.config.sizeMax?(t.addClass("disabled"),e=new p({trigger:t,content:r.t("setting/msg_altpwd_generate_oversize"),inViewport:!0,arrowPosition:11}),t.data("disabledTip",e)):(e=t.data("disabledTip"),e&&(e.destroy&&e.destroy(),t.data("disabledTip",null)),t.removeClass("disabled"))},_pwdSetUpdateObserver:function(e,t){if("string"!=typeof e)return!1;switch(e){case"add":this._insertPwdItemDom(t);break;case"remove":this._removePwdItemDom(t);break;case"clean":this.$(".j-pwd-list").find(".j-altpwd-item").remove()}this._updateAddItemBtn()},templateHelpers:{SubPwd:function(e,t){return e.substr(4*(t-1),4)}}});n.exports=h})}(),define("components/requirejs-text/text!template/module/setting/security/twofactorauth/index.tpl.html",[],function(){return'<div class="m-setting-twofactorauth">\r\n  <div class="main-wrapper">\r\n    <div class="sub-module-wrap j-auth-wrap">\r\n      <div class="title dotted">\r\n        <h4>\r\n          {{ i18n "setting/msg_twoFactorAuth_title" }}\r\n        </h4>\r\n      </div>\r\n      <div class="sub-module-main j-auth-main">\r\n      </div>\r\n    </div>\r\n    <div class="sub-module-wrap j-altpwd-wrap"></div>\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="disableTpl">\r\n  <p>{{ i18n "setting/msg_twoFactorAuth_disable" }}</p>\r\n  </script>\r\n\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="addBindTpl">\r\n    <div class="add-progress j-add-progress">\r\n      <div class="add-step j-add-step active" data-step="1">\r\n        <div class="mark round-bg r30">1</div>\r\n        <div class="text">{{ i18n \'setting/lbl_twofactorauth_add_step1\' }}</div>\r\n      </div>\r\n      <div class="add-to"></div>\r\n      <div class="add-step j-add-step" data-step="2">\r\n        <div class="mark round-bg r30">2</div>\r\n        <div class="text">{{ i18n \'setting/lbl_twofactorauth_add_step2\' }}</div>\r\n      </div>\r\n    </div>\r\n    <div class="add-wrap j-add-wrap"></div>\r\n  </script>\r\n\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="authOptionsTpl">\r\n    <div class="_panel _panel-lg">\r\n      <ul class="_panel-body add-options j-options-wrap">\r\n        [[#each this]]\r\n        <li class="add-option j-option [[#if this.enable]]active[[else]]disable[[/if]]" data-type="[[this.type]]">\r\n          <span class="check-icon round-bg r20">\r\n            <i class="iconfont iconchoose"></i>\r\n          </span>\r\n          <div class="content">\r\n            <span class="icon round-bg r80 [[this.ui.bgClass]]">\r\n              <i class="iconfont [[this.ui.iconClass]]"></i>\r\n            </span>\r\n            <span class="text">[[ this.name ]]</span>\r\n          </div>\r\n        </li>\r\n        [[/each]]\r\n      </ul>\r\n      <div class="_panel-footer">\r\n        <button class="u-btn u-btn-primary f-fr j-confirm" data-role="confirm">{{ i18n \'setting/op_next\' }}</button>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="mgrBindWrapTpl">\r\n    <div class="mgr-wrap j-mgr-wrap"></div>\r\n  </script>\r\n\r\n  <script type="text/x-handlebars-template" id="bindTimeLeftWrapTpl">\r\n    <div class="time-left-wrap j-time-left-wrap">\r\n      <p>\r\n        {{ i18n "setting/lbl_twofactorauth_edit_time_left" }}\r\n        <span class="j-countdown"></span>\r\n      </p>\r\n    </div>\r\n  </script>\r\n\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="dynamicBindStateTpl">\r\n    <div class="bind-state-wrap j-bind-state-wrap">\r\n      <div class="_panel">\r\n        <div class="_panel-heading">\r\n          [[name]]\r\n          <div class="bind-action f-fr">\r\n            <a href="javascript:void(0);" class="j-edit">&#91;[[ i18n "setting/op_update"]]&#93;</a>\r\n            <a href="javascript:void(0);" class="j-delete">&#91;[[ i18n "common/op_delete"]]&#93;</a>\r\n          </div>\r\n        </div>\r\n        <div class="_panel-body f-cf f-pr">\r\n          <div class="bind-icon icon round-bg r80 [[ui.bgClass]]">\r\n            <i class="iconfont [[ui.iconClass]]"></i>\r\n          </div>\r\n          <div class="bind-content">\r\n            <p>\r\n              <span class="name">[[ i18n "setting/lbl_AuthId" ]]</span>\r\n              <span class="value" title="[[ authkeyid ]]">[[ authkeyid ]]</span>\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="dynamicEditTpl">\r\n    <div class="edit-wrap dynamic-edit-wrap j-edit-wrap">\r\n      <div class="_panel">\r\n        <div class="_panel-body">\r\n          <div class="u-form">\r\n            <div class="u-form-item">\r\n              <label class="u-form-label">{{ i18n "setting/lbl_emailAddress" }}</label>\r\n              <span class="u-form-text address-text">[[ email ]]</span>\r\n            </div>\r\n            <div class="u-form-item">\r\n              <label class="u-form-label">{{ i18n "setting/lbl_AuthIdInput" }}</label>\r\n              <input type="text" class="u-input j-input-id" value="[[ authkeyid ]]">\r\n            </div>\r\n            <div class="u-form-item">\r\n              <label class="u-form-label">{{ i18n "setting/lbl_Authkeypwd" }}</label>\r\n              <input type="text" class="u-input j-input-pwd" maxlength="[[ codeLimit ]]">\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class="_panel-footer">\r\n          <div class="u-dialog-btns">\r\n            <button class="u-btn u-btn-primary j-confirm">{{ i18n \'common/confirm\' }}</button>\r\n            <button class="u-btn u-btn-default j-cancel">{{ i18n \'common/cancel\' }}</button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="smsBindStateTpl">\r\n    <div class="bind-state-wrap j-bind-state-wrap">\r\n      <div class="_panel">\r\n        <div class="_panel-heading">\r\n          [[name]]\r\n          <div class="bind-action f-fr">\r\n            <a href="javascript:void(0);" class="j-edit">&#91;[[ i18n "setting/op_update"]]&#93;</a>\r\n            <a href="javascript:void(0);" class="j-delete">&#91;[[ i18n "common/op_delete"]]&#93;</a>\r\n          </div>\r\n        </div>\r\n        <div class="_panel-body f-cf f-pr">\r\n          <div class="bind-icon icon round-bg r80 [[ui.bgClass]]">\r\n            <i class="iconfont [[ui.iconClass]]"></i>\r\n          </div>\r\n          <div class="bind-content">\r\n            <p>\r\n              <span class="name">[[ i18n "setting/lbl_twofactorauth_sms_edit_mobile" ]]</span>\r\n              <span class="value" title="[[cellNumber]]">[[ cellNumber ]]</span>\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="smsUnBindEditTpl">\r\n    <div class="edit-wrap sms-edit-wrap unbind-edit j-edit-wrap">\r\n      <div class="_panel _panel-lg">\r\n        <div class="_panel-body">\r\n          [[#if config.enableCellphoneBinding ]]\r\n          <div class="u-form">\r\n            <div class="u-form-item">\r\n              <label class="u-form-label">{{ i18n "setting/lbl_twofactorauth_sms_edit_mobile" }}</label>\r\n              <input type="text" class="u-input j-input-mobile" maxlength="[[ model.cellLength ]]" value="[[ model.cellNumber ]]">\r\n            </div>\r\n            <div class="u-form-item">\r\n              <label class="u-form-label">{{ i18n "setting/lbl_twofactorauth_sms_edit_code" }}</label>\r\n              <input type="text" class="u-input j-input-code" maxlength="[[model.codeLimit]]">\r\n              <button class="u-btn u-btn-default btn-send-code j-send">\r\n                <span class="j-send-text">{{ i18n "setting/lbl_twofactorauth_sms_send" }}</span>\r\n                <span class="j-send-again-left"></span>\r\n              </button>\r\n            </div>\r\n          </div>\r\n          [[else]]\r\n          [[i18n "pref/mobile/contactAdmin"]]\r\n          [[/if]]\r\n        </div>\r\n        <div class="_panel-footer">\r\n          <div class="u-dialog-btns">\r\n            [[#if config.enableCellphoneBinding ]]\r\n            <button class="u-btn u-btn-primary j-confirm disabled">{{ i18n \'common/confirm\' }}</button>\r\n            [[/if]]\r\n            <button class="u-btn u-btn-default j-cancel">{{ i18n \'common/cancel\' }}</button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!-- -->\r\n  <script type="text/x-handlebars-template" id="smsBindEditTpl">\r\n    <div class="edit-wrap sms-edit-wrap bind-edit j-edit-wrap">\r\n      <div class="_panel _panel-lg">\r\n        <div class="_panel-body bind-state-wrap f-cf">\r\n          <div class="bind-icon icon round-bg r80 [[ model.ui.bgClass ]]">\r\n            <i class="iconfont [[ model.ui.iconClass ]]"></i>\r\n          </div>\r\n          <div class="bind-content">\r\n            <p>\r\n              <span class="name">[[ i18n "setting/lbl_twofactorauth_sms_edit_confirm"]]</span>\r\n              <span class="value">[[model.cellNumber]]</span>\r\n              [[#if config.enableCellphoneBinding ]]\r\n              <a href="javascript:void(0);" class="j-edit" data-action="edit">&#91;[[ i18n "setting/op_update" ]]&#93;</a>\r\n              [[/if]]\r\n            </p>\r\n          </div>\r\n        </div>\r\n        <div class="_panel-footer">\r\n          <div class="u-dialog-btns">\r\n            <button class="u-btn u-btn-primary j-confirm">{{ i18n \'common/confirm\' }}</button>\r\n            <button class="u-btn u-btn-default j-cancel">{{ i18n \'common/cancel\' }}</button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!--Coremail APP -->\r\n  <script type="text/x-handlebars-template" id="otpBindStateTpl">\r\n    <div class="bind-state-wrap j-bind-state-wrap">\r\n      <div class="_panel">\r\n        <div class="_panel-heading">\r\n          [[name]]\r\n          <div class="bind-action f-fr">\r\n            <!--<a href="javascript:void(0);" class="j-edit">&#91;[[ i18n "setting/op_update"]]&#93;</a>-->\r\n            <a href="javascript:void(0);" class="j-delete">&#91;[[ i18n "common/op_delete"]]&#93;</a>\r\n          </div>\r\n        </div>\r\n        <div class="_panel-body f-cf f-pr">\r\n          <div class="bind-icon icon round-bg r80 [[ui.bgClass]]">\r\n            <i class="iconfont [[ui.iconClass]]"></i>\r\n          </div>\r\n          <div class="bind-content">\r\n            <p>\r\n              <span class="name">[[ i18n "setting/lbl_twofactorauth_otp_edit_confirm_device"]]</span>\r\n              <span class="value" title="[[deviceInfo.model]]">[[deviceInfo.model]]</span>\r\n              <br/>\r\n              <span class="name">[[ i18n "setting/lbl_twofactorauth_otp_edit_confirm_app"]]</span>\r\n              <span class="value" title="[[deviceInfo.apptype]]">[[deviceInfo.apptype]]</span>\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  <!--Coremail App -->\r\n  <script type="text/x-handlebars-template" id="otpEditTpl">\r\n    <div class="edit-wrap otp-edit-wrap j-edit-wrap">\r\n      <div class="_panel">\r\n        <div class="_panel-body">\r\n            <div class="auth-qrcode j-qrcode"></div>\r\n            <p style="line-height: 30px;">{{{ i18n "setting/lbl_twofactorauth_otp_edit_desc" }}}</p>\r\n            <p class="use-code">\r\n              <input type="text" class="u-input j-code-input" maxlength="6" />\r\n            </p>\r\n        </div>\r\n        <div class="_panel-footer">\r\n          <div class="u-dialog-btns">\r\n            <button class="u-btn u-btn-primary j-confirm">{{ i18n \'common/confirm\' }}</button>\r\n            <button class="u-btn u-btn-default j-cancel">{{ i18n \'common/cancel\' }}</button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </script>\r\n\r\n  {{/raw}}\r\n\r\n</div>'}),function(){define("module/setting/security/twofactorauth/index",["require","exports","module","i18n!setting,common,pref/mobile","jquery","qrcode","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","i18n","util/html","module/common/globalService","../../service","./store","./service","./verify","./altpwd","component/wsStore","text!template/module/setting/security/twofactorauth/index.tpl.html"],function(e,t,n){e("i18n!setting,common,pref/mobile");var i=e("jquery"),a=e("qrcode"),r=e("cui/core/view/view"),s=e("cui/core/view/viewmanager"),o=e("cui/util/templatable/templatable"),l=e("component/confirmbox"),c=e("i18n"),d=e("util/html"),u=e("module/common/globalService"),p=e("../../service"),m=e("./store"),h=e("./service"),f=e("./verify"),v=e("./altpwd"),g=e("component/wsStore"),b={FORBIDDEN:1,DISABLED:2,BIND:3},_=f.verifyTypes,y=m.validateNumeric,w=m.formatMilliSecondMap,x=m.countdownTick,C=m.matchErrorMsg,k=function(e){return"string"==typeof e&&e.length?!0:(i.notify.error(c.t("setting/lbl_twofactorauth_invalid_param")),!1)},S=r.extend({Implements:o,models:{},authState:null,authType:null,bindTimeout:3e5,attrs:{},altPwdView:null,setup:function(){this.state=u.getCurrentState(),delete this.state.param.view},render:function(){S.superclass.render.call(this),this.options=m.authOptions,this.models=i.extend(!0,{},m.authModels),i.when(h.initAuthData()).then(i.proxy(function(e){var t=e.state,n=e.config,a=e.permits;return this.models.SMS.enable=a.sms,this.models.DYNAMIC.enable=a.dynamic,this.models.OTP.enable=a.otp,this.config=n,null==t?(this.authState=b.FORBIDDEN,this.authType=null):t.type===this.options.DISABLED?(this.authState=b.DISABLED,this.authType=null):(this.authState=b.BIND,this.authType=t.type,i.extend(!0,this.models[this.authType],t),this.models[this.authType].cache=t),this.altPwdView=new v({parentNode:this.$(".j-altpwd-wrap"),authType:this.authType}),this.authState===b.FORBIDDEN?this._renderForbidden():this.authState===b.DISABLED?this._initBindAdd(this.element.find(".j-auth-main")):this.authState===b.BIND?this._initBindMgr(this.element.find(".j-auth-main")):void 0},this))},destroy:function(){this.altPwdView&&this.altPwdView.destroy(),S.superclass.destroy.call(this)},_publishAuthStatusChange:function(){this.publish("authStatusChange",this.authType)},_renderForbidden:function(){var e=this.element.find("#disableTpl").html();this.element.find(".j-auth-main").html(e)},_initBindMgr:function(){var e,t=this.element.find("#mgrBindWrapTpl").html(),n=this.element.find(".j-auth-main");switch(n.empty().append(t),e=n.find(".j-mgr-wrap"),this.authType){case this.options.SMS:this._initSMSBindState(e);break;case this.options.OTP:this._initOtpBindState(e);break;case this.options.DYNAMIC:this._initDynamicBindState(e)}},_initBindAdd:function(){var e,t,n=this,a=this.element.find("#addBindTpl").html(),r=function(e,n,i){var a=t.find('.j-add-step[data-step="'+e+'"]').eq(0);i?a.addClass("active"):a.removeClass("active"),n?a.addClass("completed").find(".mark").html('<i class="iconfont iconchoose"></i>'):a.removeClass("completed").find(".mark").html(e+"")},s=function(t){switch(r(1,!0,!1),r(2,!1,!0),t){case n.options.SMS:null!=n.models.SMS.cellNumber&&n.models.SMS.cellNumber.length?n._initSMSEdit(e,{next:l,cancel:o}):i.when(p.getSMSAttrs()).then(function(t){n.models.SMS.cellNumber=t.cellNumber,n._initSMSEdit(e,{next:l,cancel:o})},function(){console.log("can not fetch sms attrs."),n._initSMSEdit(e,{next:l,cancel:o})});break;case n.options.DYNAMIC:n._initDynamicEdit(e,{next:l,cancel:o});break;case n.options.OTP:n._initOtpEdit(e,{next:l,cancel:o});break;default:i.notify.error(c.t("setting/lbl_twofactorauth_add_step1_invalid"))}},o=function(){n.authState=b.DISABLED,n.authType=null,r(1,!1,!0),r(2,!1,!1),n._initOptionsSelect(e,s)},l=function(){n._publishAuthStatusChange(),n._initBindMgr()},d=this.element.find(".j-auth-main");d.empty().append(this.compile(a)),t=d.find(".j-add-progress"),e=d.find(".j-add-wrap"),this._initOptionsSelect(e,s)},_initOptionsSelect:function(e,t){var n,a=this.element.find("#authOptionsTpl").html();t=i.isFunction(t)?t:i.noop,e.empty().html(this.compile(a,this.models)),n=e.find(".j-options-wrap"),n.off("click",".j-option").on("click",".j-option",function(e){var t=i(e.currentTarget);return t.hasClass("disable")?!1:void(t.hasClass("selected")?t.removeClass("selected"):(n.find(".selected").removeClass("selected"),t.addClass("selected")))}),e.off("click",".j-confirm").on("click",".j-confirm",function(){var e,a=n.find(".selected");return a.length?(e=a.eq(0).attr("data-type"),void t(e)):(i.notify.error(c.t("setting/lbl_twofactorauth_add_step1_blank")),!1)})},_initPreDeleteConfirm:function(e){e=i.isFunction(e)?e:i.noop,l.confirm(c.t("setting/lbl_twofactorauth_unbind_confirm"),function(){setTimeout(e,10)},!1,{title:c.t("setting/lbl_twofactorauth_unbind_title")})},_initDynamicBindState:function(e){var t,n=this,i=this.element.find("#dynamicBindStateTpl").html();e.empty().html(this.compile(i,this.models.DYNAMIC)),t=e.find(".j-bind-state-wrap"),t.off("click",".j-edit").on("click",".j-edit",function(){var t=function(){n._initBindMgr()},i=function(){n._initDynamicBindState(e)},a=function(a){n._initDynamicEdit(e,{tempSid:a,next:t,cancel:i})};n._initDynamicVerify(_.VERIFY,a)}),t.off("click",".j-delete").on("click",".j-delete",function(){n._initPreDeleteConfirm(function(){var e=function(){n.models.DYNAMIC.reset(),n.authState=b.DISABLED,n.authType=null,n._initBindAdd(),n._publishAuthStatusChange()};n._initDynamicVerify(_.UNBIND,e)})})},_initDynamicEdit:function(e,t){var n,a,r=this,s=this.element.find("#dynamicEditTpl").eq(0).html(),o=this.models.DYNAMIC,u=!1,m=function(){u=!0};if(null==e)return!1;t=i.isPlainObject(t)?t:{};var h=i.isFunction(t.next)?t.next:i.noop,f=i.isFunction(t.cancel)?t.cancel:i.noop;e.empty().html(this.compile(s,o)),n=e.find(".j-edit-wrap"),a=this._initBindTimeCountdown(n,m),e.off("click",".j-confirm").on("click",".j-confirm",function(){var e,t,s,m=n.find(".j-input-id");return u?void l.alert(c.t("setting/lbl_twofactorauth_edit_time_exceed")):(e=d.encode(i.trim(m.val())),e.length?(t=n.find(".j-input-pwd"),s=i.trim(t.val()),s.length?void p.bindAuthKey({authkeyid:e,authkeypwd:s}).then(function(t){"S_OK"===t.code?(r.authState=b.BIND,r.authType=r.options.DYNAMIC,o.authkeyid=e,a&&a(),h()):i.notify.error(t["var"].desc)}):(i.notify.error(c.t("setting/msg_authkeyNull")),!1)):(i.notify.error(c.t("setting/msg_authidNull")),!1))}),e.off("click",".j-cancel").on("click",".j-cancel",function(){a&&a(),f()})},_initDynamicVerify:function(e,t,n){return f.initVerifyWithModel({model:this.models.DYNAMIC,next:t,cancel:n,verifyType:e}),!1},_initSMSBindState:function(e){var t,n=this,a=this.element.find("#smsBindStateTpl").html(),r=this.models.SMS;e.empty().html(this.compile(a,r)),t=e.find(".j-bind-state-wrap"),t.off("click",".j-edit").on("click",".j-edit",function(){var t=function(){n._initBindMgr()},i=function(){n._initSMSBindState(e)};n._initSMSVerify(_.VERIFY,function(a){return k(a)?void n._initSMSUnbindEdit(e,{tempSid:a,next:t,cancel:i}):!1})}),t.off("click",".j-delete").on("click",".j-delete",function(){n._initPreDeleteConfirm(function(){var e=function(){i.notify.success(c.t("setting/lbl_twofactorauth_unbind_success")),n.authState=b.DISABLED,n.authType=null,n._initBindAdd(),n._publishAuthStatusChange()};n._initSMSVerify(_.UNBIND,e)})})},_initSMSVerify:function(e,t,n){return f.initVerifyWithModel({model:this.models.SMS,next:t,cancel:n,verifyType:e}),!1},_initSMSEdit:function(e,t){this.models.SMS.cellNumber&&this.models.SMS.cellNumber.length?this._initSMSBindEdit(e,t):this._initSMSUnbindEdit(e,t)},_initSMSUnbindEdit:function(e,t){var n,a,r,s=this,o=this.element.find("#smsUnBindEditTpl").eq(0).html(),d=this.models.SMS,u=!0,m=!1,f=function(){m=!0};if(null==e||!i.isPlainObject(t))return!1;var v=null==t.tempSid?"":t.tempSid,g=i.isFunction(t.next)?t.next:i.noop,_=i.isFunction(t.cancel)?t.cancel:i.noop;e.empty().html(this.compile(o,{model:d,config:this.config})),a=e.find(".j-edit-wrap"),r=this._initBindTimeCountdown(a,f),a.off("click",".j-send").on("click",".j-send",function(t){var r,s,o,p=i(t.currentTarget);return p.hasClass("disabled")?!1:m?void l.alert(c.t("setting/lbl_twofactorauth_edit_time_exceed")):(r=p.find(".j-send-text"),s=p.find(".j-send-again-left"),o=i.trim(a.find(".j-input-mobile").val()),y(o)?(r.html(c.t("setting/lbl_twofactorauth_sms_sendagain")),void i.when(h.prepareUpdateAuth({tempSid:v||"",newType:d.type,cellNumber:o})).then(function(t){var i=Date.parse(new Date)+d.sendAgainTimeout,a=function(e){s.html(["(",e.seconds,"s",")"].join(""))},r=function(){p.removeClass("disabled"),s.html("")};return u&&(e.find(".j-confirm").removeClass("disabled"),u=!1),v=t.tempSid,k(v)?(p.addClass("disabled"),void(n=x(i,a,r))):!1},function(e){s.html(""),p.removeClass("disabled"),null!=e.code?i.notify.error(C(e.code,{model:d})):i.notify.error(c.t("setting/lbl_twofactorauth_sms_send_error"))})):(i.notify.error(c.t("setting/lbl_twofactorauth_sms_send_mobile_invalid")),!1))}),e.off("click",".j-confirm").on("click",".j-confirm",function(){if(m)return void l.alert(c.t("setting/lbl_twofactorauth_edit_time_exceed"));var e=i.trim(a.find(".j-input-mobile").val()),t=i.trim(a.find(".j-input-code").val());if(d.caseSensitive||(t=t.toUpperCase()),!y(e))return i.notify.error(c.t("setting/lbl_twofactorauth_sms_send_mobile_invalid")),!1;if(t.length!==d.codeLimit)return i.notify.error(c.t("setting/lbl_twofactorauth_sms_verify_code_invalid")),!1;var o=function(){return k(v)?void i.when(h.updateAuth({tempSid:v,verifyCode:t})).then(function(){i.notify(c.t("setting/msg_bindPhoneSuccessfully")),n&&n(),s.authState=b.BIND,s.authType=s.options.SMS,d.cellNumber=e,r&&r(),g()},function(e){null!=e.code?i.notify.error(C(e.code,{model:d})):i.notify.error(c.t("setting/lbl_twofactorauth_sms_bind_error"))}):!1};e===d.cellNumber?o():p.isCellnumberBinded(e).then(function(e){1==e.isBinded?i.notify.error(c.t("setting/lbl_phoneAlreadyBound")):o()})}),e.off("click",".j-cancel").on("click",".j-cancel",function(){n&&n(),r&&r(),_()})},_initSMSBindEdit:function(e,t){var n,a,r=this,s=this.element.find("#smsBindEditTpl").eq(0).html(),o=this.models.SMS,d=!1,u=function(){d=!0},p=null==t.tempSid?"":t.tempSid,m=i.isFunction(t.next)?t.next:i.noop,h=i.isFunction(t.cancel)?t.cancel:i.noop;e.empty().html(this.compile(s,{model:o,config:this.config})),n=e.find(".j-edit-wrap"),a=this._initBindTimeCountdown(n,u),e.off("click",".j-confirm").on("click",".j-confirm",function(){if(d)return void l.alert(c.t("setting/lbl_twofactorauth_edit_time_exceed"));var e=function(){r.authState=b.BIND,r.authType=r.options.SMS,a&&a(),m()};f.initVerifyWithModel({model:o,next:e,verifyType:f.verifyTypes.UPDATE,tempSid:p})}),e.off("click",".j-cancel").on("click",".j-cancel",function(){a&&a(),h()}),n.off("click",".j-edit").on("click",".j-edit",function(){return d?void l.alert(c.t("setting/lbl_twofactorauth_edit_time_exceed")):void(null==r.authType?f.validateMobile({cellNumber:o.cellNumber,next:function(){r._initSMSUnbindEdit(e,t)}}):r._initSMSUnbindEdit(e,t))})},_initOtpBindState:function(e){var t,n=this,i=this.element.find("#otpBindStateTpl").html(),a=this.models.OTP;a.deviceInfo=null==a.deviceInfo?{}:a.deviceInfo,a.deviceInfo.model=a.deviceInfo.model||c.t("setting/lbl_twofactorauth_otp_other_device"),a.deviceInfo.apptype=a.deviceInfo.apptype||c.t("setting/lbl_twofactorauth_otp_other_device"),a.deviceInfo.platform=a.deviceInfo.platform||c.t("setting/lbl_twofactorauth_otp_other_device"),e.empty().html(n.compile(i,a)),t=e.find(".j-bind-state-wrap"),t.off("click",".j-edit").on("click",".j-edit",function(){var t=function(){n._initBindMgr()},i=function(){n._initBindAdd()},a=function(){n.models.OTP.reset(),n.authState=b.DISABLED,n.authType=null,n._initOtpEdit(e,{next:t,cancel:i})};n._initOtpVerify(_.UNBIND,a)}),t.off("click",".j-delete").on("click",".j-delete",function(){n._initPreDeleteConfirm(function(){var e=function(){n.models.OTP.reset(),n.authState=b.DISABLED,n.authType=null,n._initBindAdd(),n._publishAuthStatusChange()};n._initOtpVerify(_.UNBIND,e)})})},_initOtpEdit:function(e,t){var n,r,s,o,d=this,u=this.element.find("#otpEditTpl").eq(0).html(),p=this.models.OTP,f=!1,v=function(){f=!0},_=null==t.tempSid?"":t.tempSid,w=i.isFunction(t.next)?t.next:i.noop,x=i.isFunction(t.cancel)?t.cancel:i.noop,S=function(e){var t=e.payload;p.deviceInfo=null==p.deviceInfo?{}:p.deviceInfo,p.deviceInfo.model=t.model||c.t("setting/lbl_twofactorauth_otp_other_device"),p.deviceInfo.apptype=t.apptype||c.t("setting/lbl_twofactorauth_otp_other_device"),p.deviceInfo.platform=t.platform||c.t("setting/lbl_twofactorauth_otp_other_device"),j()},T=function(){i.notify.success(c.t("setting/lbl_twofactorauth_otp_code_verify_success")),d.authState=b.BIND,d.authType=d.options.OTP,null!=o&&o(),s&&s(),w()},j=function(){h.queryValidateStage({tempSid:_,trans:m.authTrans.UPDATE_AUTH}).then(function(e){var t=e.stage;t===m.transStages.UPDATED||t===m.transStages.FINAL?T():I()},function(e){null!=e.code?i.notify.error(C(e.code,{model:p})):console.log("twofactorauth","can not query trans stage",e.toString())})},I=function(e){e=null==e?"":e,i.when(h.updateAuth({tempSid:_,verifyCode:e})).then(function(){T()},function(e){null!=e.code?i.notify.error(C(e.code,{model:p})):(i.notify.error(c.t("setting/lbl_twofactorauth_otp_push_verify_error")),console.log("twofactorauth","can not prepare otp update auth",e.toString()))})};e.empty().html(this.compile(u,p)),n=e.find(".j-edit-wrap"),r=n.find(".j-qrcode").eq(0),h.prepareUpdateAuth({tempSid:_||"",newType:p.type}).then(function(e){var t=e.url,i=e.secret_hash,l=g.topicList.OTP_BIND_DEVICE;return _=e.tempSid,k(_)?(new a(r[0],{text:t,width:146,height:146,colorDark:"#000000",colorLight:"#ffffff",correctLevel:a.CorrectLevel.H}),r.attr("title",""),l=l.replace("$key$",i),o=g.subscribe(l,S),void(s=d._initBindTimeCountdown(n,v))):!1},function(e){null!=e.code?i.notify.error(C(e.code,{model:p})):console.log("twofactorauth","can not prepare otp update auth",e.toString())}),e.off("click",".j-confirm").on("click",".j-confirm",function(e){var t=i(e.currentTarget);if(t.hasClass("disabled"))return!1;if(f)return void l.alert(c.t("setting/lbl_twofactorauth_edit_time_exceed"));var a=i.trim(n.find(".j-code-input").val());return a.length&&y(a)?k(_)?void I(a):!1:i.notify.error(c.t("setting/lbl_twofactorauth_otp_code_verify_error"))}),e.off("click",".j-cancel").on("click",".j-cancel",function(){null!=o&&o(),s&&s(),x()})},_initOtpVerify:function(e,t,n){return f.initVerifyWithModel({model:this.models.OTP,next:t,cancel:n,verifyType:e}),!1},_initBindTimeCountdown:function(e,t){var n,a,r,s=this.element.find("#bindTimeLeftWrapTpl").html(),o=w(this.bindTimeout),l=Date.parse(new Date)+this.bindTimeout,c=function(e){a.html([e.minutes,":",e.seconds].join(""))},d=function(){a.html("00:00"),t()},u=function(){r&&r(),n.remove()};return n=i(s),e.prepend(n),a=n.find(".j-countdown"),a.html([o.minutes,":",o.seconds].join("")),t=i.isFunction(t)?t:i.noop,r=x(l,c,d),u}});s.module({name:"setting.security.twofactorauth",template:e("text!template/module/setting/security/twofactorauth/index.tpl.html")},S),n.exports=S})}(),define("components/requirejs-text/text!template/module/setting/security/whitelist/index.tpl.html",[],function(){return'<section class="m-whitelist grid-row">\r\n  <div class="main-wrapper">\r\n    <div class="content-wrapper">\r\n      <!---->\r\n      <div class="grid-col12 j-whitelist-info u-scroll"></div>\r\n    </div>\r\n    <!--[if lt IE 9]>\r\n    <div class="sg-mask"></div>\r\n    <![endif]-->\r\n  </div>\r\n\r\n  {{#raw}}\r\n  <!---->\r\n  <script type="text/x-handlebars-template" id="whitelistTpl">\r\n    <div class="u-list-desc">[[i18n "setting/lbl_safalist_desc"]]</div>\r\n    <div class="u-list-modify">\r\n      <div class="u-input-control">\r\n        <input type="text" class="u-input j-new-rule" placeholder="[[i18n \'setting/lbl_addfilteritem\']]">\r\n      </div>\r\n      <div class="u-btns-top f-ib">\r\n        <button type="button" class="u-btn u-btn-primary" data-action="save">[[i18n "setting/op_add"]]</button>\r\n        <button type="button" class="u-btn u-btn-default [[#unless safelist.length]]disabled[[/unless]]" data-action="removeAll">[[i18n "setting/lbl_emptysafelist"]]</button>\r\n      </div>\r\n      <div class="u-explain">[[i18n "setting/lbl_filterexample"]]</div>\r\n      <div class="u-error-alert f-dn"></div>\r\n    </div>\r\n\r\n    <div class="list-title f-csp" data-action="tableToggle">\r\n      <i class="iconfont iconcollapse"></i>\r\n      <span>[[i18n "setting/lbl_contact"]]</span>\r\n      <span class="opr">[[i18n "setting/lbl_op"]]</span>\r\n    </div>\r\n\r\n    <table>\r\n      <tbody>\r\n      [[#each safelist]]\r\n      <tr>\r\n        <td>[[key]]</td>\r\n        <td><a href="javascript:void(0);" data-action="remove" data-name="[[key]]" >[[i18n "setting/op_remove"]]</a></td>\r\n      </tr>\r\n      [[/each]]\r\n\r\n      [[#unless safelist.length]]\r\n      <tr class="gray">\r\n        <td>[[i18n "setting/msg_whitelist_empty"]]</td>\r\n        <td></td>\r\n      </tr>\r\n\r\n      [[/unless]]\r\n      </tbody>\r\n    </table>\r\n  </script>\r\n  {{/raw}}\r\n</section>\r\n\r\n'}),define("module/setting/security/whitelist/index",["require","util/i18n!setting,pref","jquery","cui/core/view/view","cui/core/view/viewmanager","cui/util/templatable/templatable","component/confirmbox","module/common/globalService","./../../service","../../../../util/index","i18n","configurable/index","text!template/module/setting/security/whitelist/index.tpl.html"],function(e){e("util/i18n!setting,pref");var t=e("jquery"),n=e("cui/core/view/view"),i=e("cui/core/view/viewmanager"),a=e("cui/util/templatable/templatable"),r=e("component/confirmbox"),s=e("module/common/globalService"),o=e("./../../service"),l=e("../../../../util/index"),c=e("i18n"),d=e("configurable/index"),u=n.extend({Implements:a,setup:function(){this.state=s.getCurrentState(),this.config=d("setting.security"),this._params={refuselist:[],safelist:[],userEmails:this.config.allEmails}},render:function(){u.superclass.render.call(this),this._initView(),this._initModuleMessage()},events:{"click [data-action]":"_dispatchAction"},_initView:function(){var e,n=this;this.element.mask(),this._clearAllCache(),o.getAttrs("safelist,refuselist").then(function(i){var a=[];i.refuselist&&t.each(i.refuselist.split(/\s?,\s?/),function(e,t){
n._params.refuselist.push(t)}),i.safelist&&t.each(i.safelist.split(/\s?,\s?/),function(e,t){a.push({key:t}),n._params.safelist.push(t)}),e=n.compile(n.$("#whitelistTpl").html(),{safelist:a}),n.$(".j-whitelist-info").html(e),n.element.mask("hide")})},_initModuleMessage:function(){var e=this;e.onMessage("list:reload",function(){e._initView()},null)},_dispatchAction:function(e,n){var i=t(n).data("action");switch(i){case"tableToggle":this._handleToggleTable(t(n));break;case"save":this._handleSaveRules();break;case"remove":this._handleRemoveSingleRule(t(n));break;case"removeAll":this._handleRemoveAllRules()}},_handleToggleTable:function(e){this.$("table").toggle(),e.find("i").toggleClass("iconunfold iconcollapse")},_handleSaveRules:function(){var e,n=this;this.$(".u-list-modify").removeClass("error");var i=this.$(".j-new-rule").val(),a=/^@\w+([-.]\w+)*\.\w+([-.]\w+)*/;if(i=i.trim().replace(/\n/g," ").replace(/ +/g,","),!i)return void this._displayErrorMsg(c.t("setting/msg_inputEmpty"));if(!l.Email.test(i)){if(!a.test(i))return void this._displayErrorMsg(c.t("setting/msg_errorEmailFormat"));i="*"+i}for(var r=0;r<this._params.userEmails;r++)if(i===this._params.userEmails[r].addr)return void this._displayErrorMsg(c.t("setting/msg_errExceptOwnMail"));return-1!==t.inArray(i,this._params.safelist)||-1!==t.inArray(i,this._params.newlist)?void this._displayErrorMsg(l.messageFormat.format(c.t("setting/msg_errMailExistInCurrentList"),i)):-1!==t.inArray(i,this._params.refuselist)?void this._displayErrorMsg(l.messageFormat.format(c.t("setting/msg_errMailExistInBlackList"),i)):(this.$(".j-new-rule").val(""),this._params.safelist.push(i),e=this._params.safelist.join(","),void s.updateUser({safelist:e}).then(function(){t.notify.success(c.t("setting/msg_rulesSaveSucccess")),n.$(".j-newItems").empty(),n._initView()}))},_handleRemoveSingleRule:function(e){var n,i=e.data("name"),a=this;r.confirm(l.messageFormat.format(c.t("setting/msg_confirmRemoveListItem"),l.html.encode(i)),function(){a._params.safelist=t.grep(a._params.safelist,function(e){return e!==i}),n=a._params.safelist.join(","),s.updateUser({safelist:n}).then(function(){a._initView(),t.notify(c.t("setting/msg_rulesRemoveSuccess"))})})},_handleRemoveAllRules:function(){var e=this;r.confirm(c.t("setting/msg_confirmRemoveAllListItem"),function(){s.updateUser({safelist:""}).then(function(){e._initView(),t.notify(c.t("setting/msg_rulesRemoveSuccess"))})})},_displayErrorMsg:function(e){this.$(".u-list-modify").find(".u-error-alert").html(e).end().addClass("error")},_clearAllCache:function(){this._params.newlist=[],this._params.refuselist=[],this._params.safelist=[]}});i.module({name:"setting.security.whitelist",template:e("text!template/module/setting/security/whitelist/index.tpl.html")},u)});
//# sourceMappingURL=m2.js.map